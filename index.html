<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v7.2</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .canvas-container { 
            position:relative; width:340px; height:437px; margin:0 auto; 
            background:#fff; border:4px solid #0f172a; border-radius:24px; overflow:hidden; 
            touch-action: none; cursor: grab; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }
    </style>
</head>
<body class="bg-slate-100 p-4 pb-16 font-sans select-none overflow-x-hidden">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;
const SUITS = [...Array(10)].map((_, i) => `${i < 5 ? 'male/m' : 'female/f'}${i % 5 + 1}.png`);

function App() {
    const canvasRef = useRef(null);
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [slots, setSlots] = useState([]);
    const [target, setTarget] = useState("PHOTO");
    const [p, setP] = useState({ x: 0, y: -20, s: 0.8, f: 1 });
    const [sp, setSp] = useState({ x: 0, y: 80, s: 1.0 });
    const [cfg, setCfg] = useState({ bright: 100, guide: 0.8, name: "MyID" });

    // ç¹ªåœ–é‚è¼¯ï¼šå®Œå…¨åŒæ­¥èˆ‡ç´”æ·¨å°å‡º
    const draw = useCallback(() => {
        const ctx = canvasRef.current.getContext("2d");
        ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, 350, 450);
        
        // ç•«äººåƒ
        if (image) {
            ctx.save(); ctx.filter = `brightness(${cfg.bright}%)`;
            ctx.translate(175 + p.x, 225 + p.y); ctx.scale(p.s * p.f, p.s);
            ctx.drawImage(image, -image.width/2, -image.height/2); ctx.restore();
        }
        // ç•«è¡£æœ
        if (suitImg) {
            ctx.save(); ctx.translate(175 + sp.x, 225 + sp.y); ctx.scale(sp.s, sp.s);
            ctx.drawImage(suitImg, -suitImg.width/2, -suitImg.height/2); ctx.restore();
        }
        // ç•«å°å¼•ç·š (v7.0 åŒæ­¥æ©Ÿåˆ¶)
        if (cfg.guide > 0) {
            ctx.save(); ctx.globalAlpha = cfg.guide; ctx.setLineDash([5, 5]); ctx.lineWidth = 2;
            ctx.strokeStyle = "#10b981"; ctx.beginPath(); ctx.ellipse(175, 203, 108, 160, 0, 0, 7); ctx.stroke();
            ctx.strokeStyle = "#f59e0b"; ctx.beginPath(); ctx.ellipse(175, 203, 122, 180, 0, 0, 7); ctx.stroke();
            ctx.restore();
        }
    }, [image, suitImg, p, sp, cfg]);

    useEffect(() => { requestAnimationFrame(draw); }, [draw]);

    // è§¸æ§é‚è¼¯ï¼šæ”¯æ´å…©æŒ‡ç¸®æ”¾ ( factor ä¿®æ­£ç‰ˆ )
    const last = useRef({ pos: { x: 0, y: 0 }, dist: 0 });
    const handlePointer = (e, type) => {
        if (type === 'start') {
            const isTouch = e.touches?.length > 0;
            last.current.pos = { x: (isTouch ? e.touches[0] : e).clientX, y: (isTouch ? e.touches[0] : e).clientY };
            if (e.touches?.length === 2) last.current.dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        } else if (type === 'move' && last.current.pos) {
            const isTouch = e.touches?.length > 0;
            const cur = (isTouch ? e.touches[0] : e);
            if (e.touches?.length === 2) {
                const d = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                const factor = d / last.current.dist;
                const setter = target === "PHOTO" ? setP : setSp;
                setter(v => ({ ...v, s: v.s * factor }));
                last.current.dist = d;
            } else {
                const dx = cur.clientX - last.current.pos.x, dy = cur.clientY - last.current.pos.y;
                const setter = target === "PHOTO" ? setP : setSp;
                setter(v => ({ ...v, x: v.x + dx, y: v.y + dy }));
                last.current.pos = { x: cur.clientX, y: cur.clientY };
            }
        } else if (type === 'end') { last.current.pos = null; }
    };

    // å­˜å…¥æ§½ä½ï¼šç¢ºä¿ä¸å«å°å¼•ç·š
    const saveToSlot = () => {
        const temp = document.createElement("canvas"); temp.width = 350; temp.height = 450;
        const tctx = temp.getContext("2d"); tctx.fillStyle = "#fff"; tctx.fillRect(0, 0, 350, 450);
        if (image) {
            tctx.save(); tctx.filter = `brightness(${cfg.bright}%)`;
            tctx.translate(175 + p.x, 225 + p.y); tctx.scale(p.s * p.f, p.s);
            tctx.drawImage(image, -image.width/2, -image.height/2); tctx.restore();
        }
        if (suitImg) {
            tctx.save(); tctx.translate(175 + sp.x, 225 + sp.y); tctx.scale(sp.s, sp.s);
            tctx.drawImage(suitImg, -suitImg.width/2, -suitImg.height/2); tctx.restore();
        }
        setSlots([{ data: temp.toDataURL("image/png"), config: { image, suitImg, p, sp, cfg } }, ...slots].slice(0, 10));
    };

    // å°å‡ºç‰ˆï¼šå®Œæ•´åŠŸèƒ½è£å¡«
    const exportDoc = async (type, mode) => {
        if (!slots.length) return alert("æ§½ä½æ˜¯ç©ºçš„ï¼");
        const isA4 = type === 'A4';
        const W = isA4 ? 2480 : 1800, H = isA4 ? 3508 : 1200;
        const pc = document.createElement("canvas"); [pc.width, pc.height] = [W, H];
        const ctx = pc.getContext("2d"); ctx.fillStyle = "white"; ctx.fillRect(0, 0, W, H);

        const imgs = await Promise.all(slots.map(s => new Promise(res => {
            const i = new Image(); i.onload = () => res(i); i.src = s.data;
        })));

        const put = (img, x, y, sw, sh) => {
            ctx.drawImage(img, x, y, sw, sh);
            ctx.strokeStyle = "#f0f0f0"; ctx.lineWidth = 1; ctx.strokeRect(x, y, sw, sh);
        };

        if (isA4) {
            const startY = 200;
            if (mode === '2IN') {
                const sX = (2480 - (413*4 + 60*3)) / 2;
                for(let i=0; i<20; i++) put(imgs[i%imgs.length], sX+(i%4)*473, startY+Math.floor(i/4)*591, 413, 531);
            } else if (mode === '1IN') {
                const sX = (2480 - (295*6 + 50*5)) / 2;
                for(let i=0; i<42; i++) put(imgs[i%imgs.length], sX+(i%6)*345, startY+Math.floor(i/6)*463, 295, 413);
            } else { // MIX
                const sX2 = (2480 - (413*4 + 60*3)) / 2, sX1 = (2480 - (295*6 + 50*5)) / 2;
                for(let i=0; i<12; i++) put(imgs[i%imgs.length], sX2+(i%4)*473, startY+Math.floor(i/4)*591, 413, 531);
                for(let i=0; i<18; i++) put(imgs[i%imgs.length], sX1+(i%6)*345, 2100+Math.floor(i/6)*463, 295, 413);
            }
        } else { // 4x6
            if (mode === 'MIX') {
                for(let i=0; i<4; i++) put(imgs[i%imgs.length], 100+i*405, 80, 413, 531);
                for(let i=0; i<5; i++) put(imgs[i%imgs.length], 100+i*325, 660, 295, 413);
            } else if (mode === '2IN') {
                for(let i=0; i<8; i++) put(imgs[i%imgs.length], 90+(i%4)*410, 70+Math.floor(i/4)*540, 413, 531);
            } else {
                for(let i=0; i<10; i++) put(imgs[i%imgs.length], 150+(i%5)*310, 160+Math.floor(i/5)*460, 295, 413);
            }
        }

        const dateStr = new Date().toISOString().slice(2,10).replace(/-/g,'');
        const a = document.createElement("a"); a.href = pc.toDataURL("image/png");
        a.download = `${dateStr}_${cfg.name}_${type}_${mode}.png`; a.click();
    };

    return (
        <div className="max-w-md mx-auto space-y-4">
            <header className="flex justify-between items-center p-4 bg-white/80 backdrop-blur rounded-2xl shadow-sm sticky top-0 z-[200]">
                <h1 className="text-xl font-black italic">EzID <span className="text-blue-600 font-black">v7.2 FINAL</span></h1>
                <button onClick={()=>setP(v=>({...v, f: v.f*-1}))} className="px-4 py-1.5 bg-slate-900 text-white rounded-xl text-xs font-bold active:scale-90 transition">é¡åƒç¿»è½‰</button>
            </header>

            <div className="canvas-container"
                 onTouchStart={e=>handlePointer(e,'start')} onTouchMove={e=>handlePointer(e,'move')} onTouchEnd={()=>handlePointer(null,'end')}
                 onMouseDown={e=>handlePointer(e,'start')} onMouseMove={e=>handlePointer(e,'move')} onMouseUp={()=>handlePointer(null,'end')}>
                <canvas ref={canvasRef} width="350" height="450" className="w-full h-full" />
            </div>

            <div className="bg-white p-6 rounded-[2.5rem] shadow-xl space-y-4">
                <div className="flex bg-slate-100 p-1 rounded-2xl">
                    <button onClick={()=>setTarget("PHOTO")} className={`flex-1 py-2 text-xs font-black rounded-xl transition ${target==='PHOTO'?'bg-white shadow text-blue-600':'text-slate-400'}`}>äººåƒ</button>
                    <button onClick={()=>setTarget("SUIT")} className={`flex-1 py-2 text-xs font-black rounded-xl transition ${target==='SUIT'?'bg-white shadow text-blue-600':'text-slate-400'}`}>è¡£æœ</button>
                </div>
                <div className="space-y-3">
                    <div className="flex items-center gap-3 text-[10px] font-bold text-slate-400">
                        <span className="w-12">ç¸®æ”¾æ¯”ä¾‹</span>
                        <input type="range" min="0.1" max="2.5" step="0.01" value={target === "PHOTO" ? p.s : sp.s} onChange={e=>target==="PHOTO"?setP({...p,s:+e.target.value}):setSp({...sp,s:+e.target.value})} className="flex-1 accent-blue-600 h-1" />
                    </div>
                    <div className="flex items-center gap-3 text-[10px] font-bold text-slate-400">
                        <span className="w-12">å°å¼•é€æ˜</span>
                        <input type="range" min="0" max="1" step="0.1" value={cfg.guide} onChange={e=>setCfg({...cfg,guide:+e.target.value})} className="flex-1 accent-emerald-500 h-1" />
                    </div>
                    <div className="flex items-center gap-3 text-[10px] font-bold text-slate-400">
                        <span className="w-12">è‡ªå®šæª”å</span>
                        <input type="text" value={cfg.name} onChange={e=>setCfg({...cfg,name:e.target.value})} className="flex-1 bg-slate-50 rounded px-2 text-slate-800" />
                    </div>
                </div>
            </div>

            <div className="flex gap-2 overflow-x-auto no-scrollbar px-2 bg-white/50 p-2 rounded-2xl">
                {SUITS.map(s => (
                    <img key={s} src={`clothes/${s}`} onClick={()=>{const i=new Image(); i.src=`clothes/${s}`; i.onload=()=>{setSuitImg(i); setTarget("SUIT")}} } className="w-12 h-12 p-1 border rounded-xl bg-white shadow-sm flex-shrink-0 active:scale-90 transition" />
                ))}
            </div>

            <div className="grid grid-cols-2 gap-4 px-2">
                <label className="bg-slate-900 text-white py-4 rounded-3xl text-center text-sm font-black cursor-pointer shadow-lg active:scale-95 transition">ğŸ“¸ ä¸Šå‚³ç…§ç‰‡ <input type="file" hidden onChange={e=>{const f=e.target.files[0]; if(f){const i=new Image(); i.src=URL.createObjectURL(f); i.onload=()=>{setImage(i); setP({x:0,y:-20,s:(350/i.width)*0.8,f:1}); setTarget("PHOTO")}} }} /></label>
                <button onClick={saveToSlot} className="bg-blue-600 text-white py-4 rounded-3xl text-sm font-black shadow-lg active:scale-95 transition">ğŸ“¥ å­˜å…¥æ§½ä½</button>
            </div>

            <div className="bg-slate-200/50 p-5 rounded-[2.5rem] flex gap-3 overflow-x-auto no-scrollbar min-h-[140px] mx-2 shadow-inner relative">
                {slots.length === 0 && <span className="absolute inset-0 flex items-center justify-center text-slate-400 text-xs font-bold">æš«å­˜æ§½ç©ºç©ºçš„</span>}
                {slots.map((s, i) => (
                    <div key={i} className="relative w-24 h-32 bg-white rounded-xl overflow-hidden shadow-md flex-shrink-0 border-2 border-white group">
                        <img src={s.data} className="w-full h-full object-cover" />
                        <div className="absolute top-0 right-0 bg-red-500 text-white w-6 h-6 flex items-center justify-center text-xs font-bold z-10" onClick={()=>setSlots(slots.filter((_,idx)=>idx!==i))}>âœ•</div>
                        <div className="absolute inset-x-0 bottom-0 bg-slate-900/80 text-white text-[10px] text-center py-1 cursor-pointer" onClick={()=>{const c=s.config; setImage(c.image); setSuitImg(c.suitImg); setP({...c.p}); setSp({...c.sp}); setCfg(c.cfg);}}>è¼‰å…¥ç·¨è¼¯</div>
                    </div>
                ))}
            </div>

            <div className="px-2 space-y-6 pb-24">
                <div className="bg-white p-5 rounded-[2.5rem] border border-blue-100 shadow-xl space-y-3">
                    <h3 className="text-xs font-black text-blue-600 tracking-widest">ğŸ“„ A4 PAPER (å®Œå…¨ç½®ä¸­)</h3>
                    <div className="grid grid-cols-3 gap-2">
                        <button onClick={()=>exportDoc('A4','MIX')} className="bg-blue-600 text-white py-3 rounded-xl text-[10px] font-bold">æ··æ’</button>
                        <button onClick={()=>exportDoc('A4','2IN')} className="bg-slate-700 text-white py-3 rounded-xl text-[10px] font-bold">2å‹</button>
                        <button onClick={()=>exportDoc('A4','1IN')} className="bg-slate-700 text-white py-3 rounded-xl text-[10px] font-bold">1å‹</button>
                    </div>
                </div>
                <div className="bg-white p-5 rounded-[2.5rem] border border-emerald-100 shadow-xl space-y-3">
                    <h3 className="text-xs font-black text-emerald-600 tracking-widest">ğŸª IBON 4x6 æ²–å°</h3>
                    <div className="grid grid-cols-3 gap-2">
                        <button onClick={()=>exportDoc('46','MIX')} className="bg-emerald-600 text-white py-3 rounded-xl text-[10px] font-bold">æ··æ’</button>
                        <button onClick={()=>exportDoc('46','2IN')} className="bg-slate-700 text-white py-3 rounded-xl text-[10px] font-bold">2å‹</button>
                        <button onClick={()=>exportDoc('46','1IN')} className="bg-slate-700 text-white py-3 rounded-xl text-[10px] font-bold">1å‹</button>
                    </div>
                </div>
            </div>
        </div>
    );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
