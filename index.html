<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzID å°ç£è­‰ä»¶ç…§ Pro</title>

    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@imgly/background-removal@1.5.3/dist/bundle.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { background-color: #f1f5f9; }
        .canvas-container { position: relative; width: 100%; max-width: 350px; margin: 0 auto; }
        canvas { width: 100%; height: auto; border-radius: 1rem; background: #fff; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const SPECS = {
            TWO_INCH: { id: 'TWO_INCH', label: '2 å‹ (8å¼µ)', mmW: 35, mmH: 45, max: 8, cols: 4, rows: 2 },
            ONE_INCH: { id: 'ONE_INCH', label: '1 å‹ (10å¼µ)', mmW: 28, mmH: 35, max: 10, cols: 5, rows: 2 }
        };

        const BACKGROUNDS = [
            { id: 'w', hex: '#FFFFFF', label: 'ç™½' },
            { id: 'b', hex: '#E6F3FF', label: 'è—' },
            { id: 'g', hex: '#F5F5F5', label: 'ç°' }
        ];

        const EzIDApp = () => {
            const [image, setImage] = useState(null);
            const [bgRemoved, setBgRemoved] = useState(null);
            const [isRemoving, setIsRemoving] = useState(false);
            const [currentSpec, setCurrentSpec] = useState(SPECS.TWO_INCH);
            const [photoList, setPhotoList] = useState([]);
            const [bgColor, setBgColor] = useState('#FFFFFF');
            
            // äººåƒåº§æ¨™
            const [pX, setPX] = useState(0);
            const [pY, setPY] = useState(0);
            const [pScale, setPScale] = useState(0.5);

            // è¡£æœåº§æ¨™
            const [suit, setSuit] = useState(null);
            const [sX, setSX] = useState(175);
            const [sY, setSY] = useState(250);
            const [sScale, setSScale] = useState(0.6);

            const mainCanvasRef = useRef(null);
            const exportCanvasRef = useRef(null);

            // ã€æ ¸å¿ƒä¿®å¾©ã€‘åŒæ­¥ç¹ªè£½ç•«å¸ƒ
            useEffect(() => {
                const canvas = mainCanvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                
                // 1. èƒŒæ™¯
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, 350, 450);

                // 2. äººåƒ (å„ªå…ˆä½¿ç”¨å»èƒŒåœ–)
                const img = bgRemoved || image;
                if (img) {
                    ctx.save();
                    ctx.translate(175 + pX, 225 + pY);
                    ctx.scale(pScale, pScale);
                    ctx.drawImage(img, -img.width/2, -img.height/2);
                    ctx.restore();
                }

                // 3. è¡£æœ (ç¢ºä¿åœ–ç‰‡è¼‰å…¥å¾Œç¹ªè£½)
                if (suit) {
                    const imgS = new Image();
                    imgS.src = suit;
                    imgS.onload = () => {
                        ctx.save();
                        ctx.translate(sX, sY);
                        ctx.scale(sScale * 2.2, sScale * 2.2);
                        ctx.drawImage(imgS, -imgS.width/2, -imgS.height/2);
                        ctx.restore();
                    };
                }
            }, [image, bgRemoved, pX, pY, pScale, suit, sX, sY, sScale, bgColor]);

            const handleUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (f) => {
                    const img = new Image();
                    img.onload = () => { setImage(img); setBgRemoved(null); };
                    img.src = f.target.result;
                };
                reader.readAsDataURL(file);
            };

            const runRemoveBg = async () => {
                if (!image) return;
                setIsRemoving(true);
                try {
                    // ä¿®æ­£å¥—ä»¶æŠ“å–é‚è¼¯
                    const lib = window.imglyBackgroundRemoval || (window.imgly && window.imgly.backgroundRemoval);
                    if (!lib) throw new Error("å»èƒŒæ¨¡çµ„è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·š");

                    const blob = await lib.removeBackground(image.src, {
                        publicPath: "https://unpkg.com/@imgly/background-removal-data@1.5.3/dist/"
                    });
                    const img = new Image();
                    img.onload = () => { setBgRemoved(img); setIsRemoving(false); };
                    img.src = URL.createObjectURL(blob);
                } catch (e) {
                    alert(e.message);
                    setIsRemoving(false);
                }
            };

            const addToQueue = () => {
                setPhotoList(prev => [...prev, mainCanvasRef.current.toDataURL('image/png')]);
                setImage(null); setBgRemoved(null); setSuit(null);
            };

            const downloadPrint = () => {
                const canvas = exportCanvasRef.current;
                const ctx = canvas.getContext('2d');
                // 4x6 å‹ @ 300dpi = 1800x1200 px (æ©«æ”¾)
                canvas.width = 1800; canvas.height = 1200;
                ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, 1800, 1200);

                const photoW = (currentSpec.mmW * 300) / 25.4;
                const photoH = (currentSpec.mmH * 300) / 25.4;

                photoList.slice(0, currentSpec.max).forEach((src, i) => {
                    const img = new Image();
                    img.onload = () => {
                        const col = i % currentSpec.cols;
                        const row = Math.floor(i / currentSpec.cols);
                        const x = col * (1800 / currentSpec.cols) + (1800 / currentSpec.cols - photoW) / 2;
                        const y = row * (1200 / currentSpec.rows) + (1200 / currentSpec.rows - photoH) / 2;
                        ctx.drawImage(img, x, y, photoW, photoH);
                        if (i === Math.min(photoList.length, currentSpec.max) - 1) {
                            const a = document.createElement('a');
                            a.download = 'EzID_Print.jpg';
                            a.href = canvas.toDataURL('image/jpeg', 0.9);
                            a.click();
                        }
                    };
                    img.src = src;
                });
            };

            return (
                <div className="max-w-xl mx-auto p-4 sm:p-8">
                    <h1 className="text-3xl font-black text-center text-blue-900 mb-8 tracking-tighter">EzID TAIWAN</h1>
                    
                    {/* è¦æ ¼èˆ‡é è¦½ */}
                    <div className="flex gap-2 mb-4 overflow-x-auto">
                        {Object.values(SPECS).map(s => (
                            <button key={s.id} onClick={() => setCurrentSpec(s)} className={`px-4 py-2 rounded-full text-sm font-bold transition ${currentSpec.id === s.id ? 'bg-blue-600 text-white' : 'bg-white text-blue-600 border'}`}>{s.label}</button>
                        ))}
                    </div>

                    <div className="flex gap-2 mb-6 bg-white p-3 rounded-2xl shadow-inner min-h-[80px] border-2 border-dashed border-slate-200">
                        {photoList.map((p, i) => <img key={i} src={p} className="h-16 rounded shadow-sm" />)}
                    </div>

                    {!image ? (
                        <label className="block bg-white border-4 border-dashed border-blue-100 rounded-[2.5rem] p-20 text-center cursor-pointer hover:bg-blue-50 transition">
                            <input type="file" className="hidden" onChange={handleUpload} accept="image/*" />
                            <div className="text-6xl mb-4">ğŸ“¸</div>
                            <p className="text-blue-400 font-bold">é»æ“Šä¸Šå‚³åŸå§‹å¤§é ­ç…§</p>
                        </label>
                    ) : (
                        <div className="bg-white p-6 rounded-[2.5rem] shadow-2xl space-y-6">
                            <div className="canvas-container">
                                <canvas ref={mainCanvasRef} width={350} height={450} />
                                {isRemoving && <div className="absolute inset-0 bg-white/80 rounded-[1rem] flex items-center justify-center font-black text-blue-600">AI å»èƒŒä¸­...</div>}
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={runRemoveBg} className="bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition">âœ¨ æ™ºèƒ½å»èƒŒ</button>
                                <button onClick={addToQueue} className="bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition">âœ… åŠ å…¥æ’ç‰ˆ</button>
                            </div>

                            <div className="bg-slate-50 p-5 rounded-[1.5rem] space-y-5">
                                <div className="flex justify-between items-center">
                                    <span className="text-sm font-bold text-slate-400">èƒŒæ™¯é¡è‰²</span>
                                    <div className="flex gap-2">
                                        {BACKGROUNDS.map(b => (
                                            <button key={b.id} onClick={() => setBgColor(b.hex)} className={`w-8 h-8 rounded-full border-2 ${bgColor === b.hex ? 'border-blue-600' : 'border-white'}`} style={{backgroundColor: b.hex}} title={b.label} />
                                        ))}
                                    </div>
                                </div>

                                <div className="space-y-3">
                                    <p className="text-sm font-bold text-slate-400 border-b pb-1">ğŸ‘” æ­£è£èª¿æ•´</p>
                                    <div className="grid grid-cols-3 gap-2">
                                        <button onClick={() => setSY(s => s-3)} className="bg-white border py-3 rounded-xl font-bold active:bg-blue-600 active:text-white transition-colors">â†‘ ä¸Šç§»</button>
                                        <button onClick={() => setSY(s => s+3)} className="bg-white border py-3 rounded-xl font-bold active:bg-blue-600 active:text-white transition-colors">â†“ ä¸‹ç§»</button>
                                        <button onClick={() => setSScale(s => s+0.02)} className="bg-white border py-3 rounded-xl font-bold">ï¼‹ æ”¾å¤§</button>
                                        <button onClick={() => setSX(s => s-3)} className="bg-white border py-3 rounded-xl font-bold active:bg-blue-600 active:text-white transition-colors">â† å·¦ç§»</button>
                                        <button onClick={() => setSX(s => s+3)} className="bg-white border py-3 rounded-xl font-bold active:bg-blue-600 active:text-white transition-colors">â†’ å³ç§»</button>
                                        <button onClick={() => setSScale(s => s-0.02)} className="bg-white border py-3 rounded-xl font-bold">ï¼ ç¸®å°</button>
                                    </div>
                                    <div className="flex gap-2 overflow-x-auto py-2">
                                        <button onClick={() => setSuit(null)} className="flex-shrink-0 w-14 h-14 border-2 border-dashed border-slate-300 rounded-xl text-[10px] text-slate-400 font-bold">ç„¡å¥—ç”¨</button>
                                        {[1, 2, 3, 4, 5].map(i => (
                                            <img key={i} src={`./suit-m${i}.png`} onClick={() => setSuit(`./suit-m${i}.png`)} className={`w-14 h-14 border-2 rounded-xl p-1 bg-white cursor-pointer ${suit === `./suit-m${i}.png` ? 'border-blue-600 shadow-md' : 'border-transparent'}`} />
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {photoList.length > 0 && !image && (
                        <button onClick={downloadPrint} className="w-full mt-8 bg-green-600 text-white py-5 rounded-[2rem] font-black text-xl shadow-xl hover:bg-green-700 transition active:scale-95">ğŸ’¾ ä¸‹è¼‰ 4x6 å‹åˆ—å°æ‹¼æ¿</button>
                    )}
                    
                    <canvas ref={exportCanvasRef} className="hidden" />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EzIDApp />);
    </script>
</body>
</html>
