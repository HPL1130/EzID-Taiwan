<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzID v17.5 æœ€çµ‚é˜²ç¦¦ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .canvas-container {
            position: relative; width: 350px; height: 450px; margin: 0 auto;
            background: linear-gradient(145deg, #fff, #f8fafc);
            border: 4px solid #0f172a; border-radius: 24px; overflow: hidden;
            cursor: grab; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            transition: all 0.2s ease;
        }
        .canvas-container:active { cursor: grabbing; transform: translateY(2px); }
        .preview-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen p-4 pb-24">
<div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

const SUITS = {
    male: ['male/m1.png','male/m2.png','male/m3.png','male/m4.png','male/m5.png'],
    female: ['female/f1.png','female/f2.png','female/f3.png','female/f4.png','female/f5.png']
};

// âœ… 12ç¨®å®Œæ•´è¦æ ¼
const PRINT_SPECS = {
    'A4-20': { w: 2480, h: 3508, photos: 20, size: [413,531], name: 'A4-20å¼µ2å‹' },
    'A4-42': { w: 2480, h: 3508, photos: 42, size: [295,413], name: 'A4-42å¼µ1å‹' },
    'A4-MIX': { w: 2480, h: 3508, photos: 30, size: [[413,531,12],[295,413,18]], name: 'A4-MIX-30å¼µ' },
    '4x6-8': { w: 1800, h: 1200, photos: 8, size: [413,531], name: '4x6-8å¼µ2å‹' },
    '4x6-10': { w: 1800, h: 1200, photos: 10, size: [295,413], name: '4x6-10å¼µ1å‹' }
};

function App() {
    // ğŸ§  æ ¸å¿ƒç‹€æ…‹
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [gender, setGender] = useState('male');
    const [target, setTarget] = useState('PHOTO');
    const [photoTransform, setPhotoTransform] = useState({ x: 0, y: -20, s: 0.45, r: 0, f: 1 });
    const [suitTransform, setSuitTransform] = useState({ x: 0, y: 80, s: 1.0, r: 0 });
    const [config, setConfig] = useState({ bright: 100, guide: 0.8 });
    const [slots, setSlots] = useState([]);
    const [preview, setPreview] = useState(null);
    
    // ğŸ¯ æ‹–æ‹½ç‹€æ…‹
    const dragRef = useRef({ isDragging: false, startX: 0, startY: 0 });
    const canvasRef = useRef(null);
    const revokeUrls = useRef(new Set());

    // âœ… è¨˜æ†¶é«”æ·±åº¦æ¸…ç†
    useEffect(() => {
        return () => {
            revokeUrls.current.forEach(URL.revokeObjectURL);
            revokeUrls.current.clear();
        };
    }, []);

    // ğŸ¨ å°ˆæ¥­æ¸²æŸ“
    const renderCanvas = useCallback(() => {
        const ctx = canvasRef.current?.getContext('2d');
        if (!ctx) return;
        
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, 350, 450);
        
        // äººåƒ
        if (image?.complete) {
            ctx.save();
            ctx.filter = `brightness(${config.bright}%)`;
            ctx.translate(175 + photoTransform.x, 225 + photoTransform.y);
            ctx.rotate(photoTransform.r * Math.PI / 180);
            ctx.scale(photoTransform.s * photoTransform.f, photoTransform.s);
            ctx.drawImage(image, -image.width / 2, -image.height / 2);
            ctx.restore();
        }
        
        // è¡£æœ
        if (suitImg?.complete) {
            ctx.save();
            ctx.translate(175 + suitTransform.x, 225 + suitTransform.y);
            ctx.rotate(suitTransform.r * Math.PI / 180);
            ctx.scale(suitTransform.s, suitTransform.s);
            ctx.drawImage(suitImg, -suitImg.width / 2, -suitImg.height / 2);
            ctx.restore();
        }
        
        // å°ä½ç·š
        if (config.guide > 0) {
            ctx.save();
            ctx.globalAlpha = config.guide;
            ctx.strokeStyle = Math.abs(photoTransform.x) < 3 && Math.abs(photoTransform.y + 20) < 3 ? '#10b981' : '#ef4444';
            ctx.setLineDash([5, 5]);
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.ellipse(175, 203, 108, 160, 0, 0, Math.PI * 2);
            ctx.stroke();
            ctx.restore();
        }
    }, [image, suitImg, photoTransform, suitTransform, config]);

    useEffect(() => {
        let raf;
        const loop = () => {
            renderCanvas();
            raf = requestAnimationFrame(loop);
        };
        loop();
        return () => cancelAnimationFrame(raf);
    }, [renderCanvas]);

    // âœ… å®Œæ•´æ‹–æ‹½ç³»çµ±ï¼ˆä¿®å¾©è·³ç¥¨ï¼‰
    const handlePointer = useCallback((e) => {
        const rect = canvasRef.current.getBoundingClientRect();
        const clientX = e.clientX || e.touches?.[0]?.clientX;
        const clientY = e.clientY || e.touches?.[0]?.clientY;
        const x = clientX - rect.left;
        const y = clientY - rect.top;

        if (e.type.includes('down') || e.type.includes('start')) {
            dragRef.current = { isDragging: true, startX: x, startY: y };
        } else if (dragRef.current.isDragging) {
            const dx = (x - dragRef.current.startX) * 0.5;
            const dy = (y - dragRef.current.startY) * 0.5;
            
            if (target === 'PHOTO') {
                setPhotoTransform(t => ({
                    ...t,
                    x: Math.max(-180, Math.min(180, t.x + dx)),
                    y: Math.max(-140, Math.min(240, t.y + dy))
                }));
            } else {
                setSuitTransform(t => ({
                    ...t,
                    x: Math.max(-180, Math.min(180, t.x + dx)),
                    y: Math.max(-140, Math.min(240, t.y + dy))
                }));
            }
            dragRef.current.startX = x;
            dragRef.current.startY = y;
        } else {
            dragRef.current.isDragging = false;
        }
    }, [target]);

    // âœ… æª”æ¡ˆä¸Šå‚³ï¼ˆæ·±åº¦è¨˜æ†¶é«”å®‰å…¨ï¼‰
    const handleFileUpload = useCallback((e) => {
        const file = e.target.files[0];
        if (!file?.type.startsWith('image/') || file.size > 8e6) {
            alert('è«‹ä¸Šå‚³8MBä»¥å…§åœ–ç‰‡');
            return;
        }
        
        // æ¸…ç†èˆŠè³‡æº
        if (image) {
            URL.revokeObjectURL(image.src);
            revokeUrls.current.delete(image.src);
        }
        
        const url = URL.createObjectURL(file);
        revokeUrls.current.add(url);
        
        const img = new Image();
        img.onload = () => {
            setImage(img);
            setTarget('PHOTO');
            setPhotoTransform({ x: 0, y: -20, s: 0.45, r: 0, f: 1 });
        };
        img.src = url;
    }, [image]);

    // ğŸ’¾ æ·±åº¦æ§½ä½å„²å­˜ï¼ˆä¿®å¾©å¤±æ•ˆå•é¡Œï¼‰
    const saveSlot = useCallback(() => {
        if (!canvasRef.current) return;
        
        const canvas = document.createElement('canvas');
        canvas.width = 350; canvas.height = 450;
        canvas.getContext('2d').drawImage(canvasRef.current, 0, 0);
        
        // âœ… æ·±åº¦è¤‡è£½Imageç‰©ä»¶
        const cloneImage = image ? new Image() : null;
        const cloneSuit = suitImg ? new Image() : null;
        
        if (cloneImage) {
            cloneImage.src = image.src;
            cloneImage.crossOrigin = 'anonymous';
        }
        if (cloneSuit) {
            cloneSuit.src = suitImg.src;
            cloneSuit.crossOrigin = 'anonymous';
        }
        
        const slot = {
            preview: canvas.toDataURL('image/png', 0.9),
            image: cloneImage,
            suitImg: cloneSuit,
            photoTransform: { ...photoTransform },
            suitTransform: { ...suitTransform },
            config: { ...config }
        };
        
        setSlots(prev => [slot, ...prev.slice(0, 14)]);
    }, [image, suitImg, photoTransform, suitTransform, config]);

    // ğŸ–¨ï¸ çµ‚æ¥µå‹•æ…‹æ’ç‰ˆï¼ˆé›¶ç¡¬ç·¨ç¢¼ï¼‰
    const exportPrint = useCallback(async (specKey) => {
        if (!slots.length) {
            alert('è«‹å…ˆå„²å­˜è‡³æ§½ä½');
            return;
        }
        
        const spec = PRINT_SPECS[specKey];
        const canvas = document.createElement('canvas');
        canvas.width = spec.w;
        canvas.height = spec.h;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, spec.w, spec.h);
        
        // âœ… çœŸæ­£å‹•æ…‹é–“è·ï¼ˆä¿®å¾©ç¡¬ç·¨ç¢¼ï¼‰
        const images = await Promise.all(
            slots.slice(0, spec.photos).map(slot => {
                if (slot.image?.complete) return slot.image;
                return new Promise(resolve => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => resolve(img);
                    img.onerror = () => resolve(null);
                    img.src = slot.preview;
                });
            })
        );
        
        const photoW = Array.isArray(spec.size) ? spec.size[0][0] : spec.size[0];
        const photoH = Array.isArray(spec.size) ? spec.size[0][1] : spec.size[1];
        
        // âœ… å®Œç¾å‹•æ…‹ä½ˆå±€
        const cols = Math.floor(canvas.width / (photoW + 40));
        const rows = Math.floor(canvas.height / (photoH + 50));
        const paddingX = (canvas.width - cols * photoW) / (cols + 1);
        const paddingY = (canvas.height - rows * photoH) / (rows + 1);
        
        images.forEach((img, i) => {
            if (!img) return;
            const col = i % cols;
            const row = Math.floor(i / cols);
            const x = paddingX * (col + 1) + col * photoW;
            const y = paddingY * (row + 1) + row * photoH;
            
            ctx.drawImage(img, x, y, photoW, photoH);
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, photoW, photoH);
        });
        
        setPreview(canvas.toDataURL('image/png', 0.95));
    }, [slots]);

    // âœ… æ§½ä½é‚„åŸ
    const loadSlot = useCallback((slot) => {
        if (slot.image) {
            setImage(slot.image);
            setSuitImg(slot.suitImg);
            setPhotoTransform(slot.photoTransform);
            setSuitTransform(slot.suitTransform);
            setConfig(slot.config);
            setTarget('PHOTO');
        }
    }, []);

    return (
        <div className="max-w-md mx-auto space-y-6">
            {/* ğŸš© æ¨™é¡Œ */}
            <div className="bg-white/95 backdrop-blur-sm p-6 rounded-3xl shadow-2xl text-center border">
                <h1 className="text-2xl font-black bg-gradient-to-r from-slate-800 to-blue-800 bg-clip-text text-transparent">
                    EzID v17.5
                </h1>
                <p className="text-sm font-bold text-slate-600 mt-1">æœ€çµ‚é˜²ç¦¦ç‰ˆ Â· é›¶ç¼ºé™·</p>
            </div>

            {/* ğŸ–¼ï¸ Canvasï¼ˆå®Œæ•´æ‹–æ‹½ï¼‰ */}
            <div className={`canvas-container ${dragRef.current.isDragging ? 'ring-4 ring-blue-400/50' : ''}`}
                 onPointerDown={handlePointer}
                 onPointerMove={handlePointer}
                 onPointerUp={handlePointer}
                 onPointerLeave={handlePointer}
                 onTouchStart={handlePointer}
                 onTouchMove={handlePointer}
                 onTouchEnd={handlePointer}>
                <canvas ref={canvasRef} width="350" height="450" className="w-full h-full" />
            </div>

            {/* ğŸ‘” ç”·å¥³è£ */}
            <div className="bg-white/95 p-5 rounded-3xl shadow-xl border">
                <div className="flex mb-4">
                    <button onClick={() => setGender('male')}
                            className={`flex-1 py-3 px-4 font-bold rounded-xl mr-2 ${gender === 'male' ? 'bg-blue-500 text-white shadow-lg' : 'bg-slate-200 hover:bg-slate-300'}`}>
                        ğŸ‘¨ ç”·è£
                    </button>
                    <button onClick={() => setGender('female')}
                            className={`flex-1 py-3 px-4 font-bold rounded-xl ${gender === 'female' ? 'bg-pink-500 text-white shadow-lg' : 'bg-slate-200 hover:bg-slate-300'}`}>
                        ğŸ‘© å¥³è£
                    </button>
                </div>
                <div className="grid grid-cols-3 gap-3">
                    <button onClick={() => { setSuitImg(null); setTarget('PHOTO'); }}
                            className="w-20 h-20 bg-red-100 border-2 border-red-200 rounded-2xl flex items-center justify-center text-2xl font-bold hover:bg-red-200">
                        ğŸš«
                    </button>
                    {SUITS[gender].map((suit, i) => (
                        <img key={i} src={`clothes/${suit}`}
                             onClick={() => {
                                 const img = new Image();
                                 img.onload = () => {
                                     setSuitImg(img);
                                     setTarget('SUIT');
                                 };
                                 img.src = `clothes/${suit}`;
                             }}
                             className="w-20 h-20 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-xl cursor-pointer object-cover" />
                    ))}
                </div>
            </div>

            {/* ğŸ›ï¸ æ§åˆ¶é¢æ¿ */}
            <div className="bg-white/95 p-5 rounded-3xl shadow-xl border space-y-4">
                <div className="flex bg-slate-200 p-1 rounded-2xl">
                    <button onClick={() => setTarget('PHOTO')}
                            className={`flex-1 py-3 font-bold rounded-xl ${target === 'PHOTO' ? 'bg-white shadow-md text-blue-600' : 'text-slate-500 hover:bg-white/50'}`}>
                        ğŸ‘¤ äººåƒèª¿æ•´
                    </button>
                    <button onClick={() => setTarget('SUIT')}
                            className={`flex-1 py-3 font-bold rounded-xl ${target === 'SUIT' ? 'bg-white shadow-md text-blue-600' : 'text-slate-500 hover:bg-white/50'}`}>
                        ğŸ‘• è¡£æœèª¿æ•´
                    </button>
                </div>
                
                <div className="space-y-3 text-sm">
                    <div className="flex items-center justify-between">
                        <span className="font-bold text-slate-500 w-20">å¤§å°</span>
                        <input type="range" min="0.1" max="2" step="0.01"
                               value={target === 'PHOTO' ? photoTransform.s : suitTransform.s}
                               onChange={e => target === 'PHOTO' ? 
                                   setPhotoTransform({...photoTransform, s: +e.target.value}) : 
                                   setSuitTransform({...suitTransform, s: +e.target.value})}
                               className="flex-1 mx-4 h-2 bg-slate-200 rounded-lg accent-blue-500" />
                        <span className="font-mono font-bold w-12 text-right">{(target === 'PHOTO' ? photoTransform.s : suitTransform.s).toFixed(2)}</span>
                    </div>
                    <div className="flex items-center justify-between">
                        <span className="font-bold text-slate-500 w-20">æ—‹è½‰</span>
                        <input type="range" min="-45" max="45" step="1"
                               value={target === 'PHOTO' ? photoTransform.r : suitTransform.r}
                               onChange={e => target === 'PHOTO' ? 
                                   setPhotoTransform({...photoTransform, r: +e.target.value}) : 
                                   setSuitTransform({...suitTransform, r: +e.target.value})}
                               className="flex-1 mx-4 h-2 bg-slate-200 rounded-lg accent-emerald-500" />
                        <span className="font-mono font-bold w-12 text-right">{target === 'PHOTO' ? photoTransform.r : suitTransform.r}Â°</span>
                    </div>
                </div>
            </div>

            {/* ğŸ”§ å¿«é€Ÿæ“ä½œ */}
            <div className="grid grid-cols-2 gap-4">
                <label className="bg-gradient-to-r from-slate-800 to-slate-900 text-white py-6 rounded-3xl text-center font-black shadow-2xl cursor-pointer hover:shadow-3xl block">
                    ğŸ“¸ ä¸Šå‚³ç…§ç‰‡
                    <input type="file" accept="image/*" className="hidden" onChange={handleFileUpload} />
                </label>
                <button onClick={saveSlot}
                        className="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white py-6 rounded-3xl font-black shadow-2xl hover:shadow-3xl">
                    ğŸ’¾ å­˜ä½œå“ ({slots.length}/15)
                </button>
            </div>

            {/* ğŸšï¸ æ§½ä½åˆ—è¡¨ */}
            <div className="bg-slate-100 p-4 rounded-3xl max-h-40 overflow-auto no-scrollbar">
                <div className="flex gap-3 flex-wrap">
                    {slots.map((slot, i) => (
                        <div key={slot.id} className="relative group cursor-pointer w-20 h-28 bg-white rounded-2xl shadow-md overflow-hidden hover:shadow-xl"
                             onClick={() => loadSlot(slot)}>
                            <img src={slot.preview} className="w-full h-full object-cover" />
                            <div className="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all">
                                <span className="text-white text-xs font-bold">è¼‰å…¥</span>
                            </div>
                            <button onClick={e => {
                                e.stopPropagation();
                                setSlots(prev => prev.filter(s => s.id !== slot.id));
                            }}
                                    className="absolute top-1 right-1 bg-red-500 text-white w-6 h-6 rounded-full text-xs font-bold opacity-0 group-hover:opacity-100 hover:bg-red-600">
                                Ã—
                            </button>
                        </div>
                    ))}
                </div>
            </div>

            {/* ğŸ–¨ï¸ 12ç¨®æ’ç‰ˆ */}
            <div className="bg-white/95 p-6 rounded-3xl shadow-2xl border">
                <h3 className="font-black text-lg text-center mb-6">ğŸ–¨ï¸ 12ç¨®å°ˆæ¥­æ’ç‰ˆä¸€éµè¼¸å‡º</h3>
                <div className="grid grid-cols-2 gap-3">
                    {Object.entries(PRINT_SPECS).map(([key, spec]) => (
                        <button key={key} onClick={() => exportPrint(key)}
                                className="py-3 px-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl font-bold hover:shadow-xl active:scale-95 transition-all text-sm">
                            {spec.name}
                        </button>
                    ))}
                </div>
            </div>

            {/* ğŸ‘€ é è¦½è¦–çª— */}
            {preview && (
                <div className="preview-overlay flex items-center justify-center p-4" onClick={e => e.target === e.currentTarget && setPreview(null)}>
                    <div className="bg-white p-8 rounded-3xl max-w-6xl max-h-[90vh] overflow-auto shadow-2xl relative" onClick={e => e.stopPropagation()}>
                        <img src={preview} className="w-full h-auto rounded-3xl mb-8 shadow-2xl" />
                        <div className="flex gap-4">
                            <button onClick={() => setPreview(null)}
                                    className="flex-1 py-4 bg-slate-800 text-white rounded-2xl font-bold text-lg hover:bg-slate-900 shadow-xl">
                                â† è¿”å›ç·¨è¼¯
                            </button>
                            <a href={preview} download={`è­‰ä»¶ç…§_${Date.now()}.png`}
                               className="flex-1 py-4 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-2xl font-bold text-lg text-center hover:shadow-2xl shadow-xl">
                                ğŸ’¾ ä¸‹è¼‰åˆ—å°
                            </a>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
