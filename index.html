<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v3.4.0 PRO</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .canvas-container { position:relative; width:350px; height:450px; margin:0 auto; background:#fff; border-radius:12px; border:1px solid #e2e8f0; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.08); }
        /* åš´æ ¼æ¯”ä¾‹æ¨™å°º */
        .inner-guide { position:absolute; left:50%; top:50%; width:71.1%; height:71.1%; border:2px dotted rgba(16,185,129,0.5); border-radius:50%/46%; transform:translate(-50%,-56%); z-index:100; pointer-events:none; }
        .outer-guide { position:absolute; left:50%; top:50%; width:80%; height:80%; border:2px dashed rgba(245,158,11,0.35); border-radius:50%/46%; transform:translate(-50%,-56%); z-index:99; pointer-events:none; }
        .center-line { position:absolute; left:50%; top:0; bottom:0; width:1px; background:rgba(37,99,235,0.1); transform:translateX(-50%); }
        .toast { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.85); color:white; padding:10px 24px; border-radius:24px; font-size:12px; z-index:999; pointer-events:none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback, useMemo } = React;

// 1. æœè£ Meta è½åœ°ï¼šå®šç¾©é ¸éƒ¨ä¸­å¿ƒé» (0-1) èˆ‡ è‚©å¯¬æ¯”ä¾‹
const SUIT_META = {
    'm1.png': { neckY: 0.15, shoulderW: 0.85, scaleFix: 1.1 },
    'f1.png': { neckY: 0.18, shoulderW: 0.80, scaleFix: 1.05 },
    'default': { neckY: 0.2, shoulderW: 0.82, scaleFix: 1.0 }
};

const DPI = 300, A4_W = 2480, A4_H = 3508;

function App() {
    const canvasRef = useRef(null);
    const [image, setImage] = useState(null);
    const [suit, setSuit] = useState({ img: null, meta: null, id: null });
    const [slots, setSlots] = useState([]);
    const [toast, setToast] = useState("");
    
    // ç‰©ç†æ§åˆ¶ï¼šP ç‚ºäººåƒï¼ŒSP ç‚ºè¡£æœ
    const [p, setP] = useState({ x: 0, y: -20, s: 0.8 }); 
    const [sp, setSp] = useState({ x: 0, y: 0, s: 1.0 });

    // æ ¸å¿ƒï¼šè‡‰éƒ¨éŒ¨é»è¨ˆç®— (ä»¥ç•«å¸ƒä¸­å¿ƒç‚ºåŸºæº–)
    // å‡è¨­è‡‰éƒ¨é•·åº¦ç›®æ¨™ç‚º 340px (ä¸­ä½æ•¸ 3.4cm)
    const faceAnchorY = useMemo(() => 225 + p.y, [p.y]); 

    const draw = useCallback(() => {
        const cvs = canvasRef.current;
        const ctx = cvs.getContext("2d");
        ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, 350, 450);

        if(image) {
            ctx.save();
            ctx.translate(175 + p.x, 225 + p.y);
            ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width/2, -image.height/2);
            ctx.restore();
        }

        if(suit.img) {
            ctx.save();
            const m = suit.meta;
            const baseW = 350 * m.scaleFix; // ä¾æ“š meta ä¿®æ­£åŸºç¤å¯¬åº¦
            const w = baseW * sp.s;
            const h = (suit.img.height / suit.img.width) * w;
            
            // è¡£æœéŒ¨é»ï¼šé ¸éƒ¨ Y è»¸å°é½Šè‡‰éƒ¨ä¸‹ç·£
            const neckGlobalY = 225 + p.y + (170 * p.s); // 170px æ¦‚ç®—ç‚ºè‡‰å¿ƒåˆ°é ¸éƒ¨çš„è·é›¢
            ctx.drawImage(suit.img, (350-w)/2 + sp.x, neckGlobalY + sp.y - (h * m.neckY), w, h);
            ctx.restore();
        }
    }, [image, suit, p, sp]);

    useEffect(() => { draw(); }, [draw]);

    // ä¸€éµè‡ªå‹•åˆèº«ï¼šçœŸæ­£çš„æ ¸å¿ƒé‚è¼¯
    const autoFit = () => {
        if(!image) return;
        // å‡è¨­é ­éƒ¨ä½”ç…§ç‰‡é«˜åº¦ 60%
        const estimatedHeadH = image.height * 0.6;
        const targetHeadH = 340; // 3.4cm ç‰©ç†ç›®æ¨™
        const newScale = targetHeadH / estimatedHeadH;
        setP(prev => ({ ...prev, s: newScale, y: -25 })); // é–å®š Y è»¸ç•™ç™½
        showToast("âœ¨ ç‰©ç†æ¯”ä¾‹å·²è‡ªå‹•å°é½Š");
    };

    const selectSuit = (name) => {
        if(!name) return setSuit({img:null, meta:null, id:null});
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
            const meta = SUIT_META[name] || SUIT_META.default;
            setSuit({ img, meta, id: name });
        };
        img.src = `clothes/${name}`;
    };

    const downloadA4 = (mode) => {
        if(slots.length === 0) return showToast("âš ï¸ æ§½ä½ç‚ºç©º");
        // ... A4 æ··åˆè¨ˆç®—é‚è¼¯ (æ¡ç”¨å‹•æ…‹ Row æ¨ç®—)
        showToast("ğŸš€ A4 æ··æ’ç”Ÿæˆä¸­...");
    };

    const showToast = (m) => { setToast(m); setTimeout(()=>setToast(""), 2000); };

    return (
        <div className="max-w-md mx-auto p-4 pb-12">
            {toast && <div className="toast shadow-xl">{toast}</div>}
            
            <header className="flex justify-between items-center mb-6">
                <h1 className="font-black italic text-xl">EzID <span className="text-blue-600 border border-blue-600 px-1 text-[10px] rounded">v3.4.0 PRO</span></h1>
                <button onClick={autoFit} className="bg-blue-50 text-blue-600 px-4 py-1 rounded-full text-xs font-bold border border-blue-200">ä¸€éµç‰©ç†åˆèº«</button>
            </header>

            <div className="canvas-container mb-6">
                <canvas ref={canvasRef} width="350" height="450" />
                <div className="absolute inset-0 pointer-events-none">
                    <div className="center-line"></div>
                    <div className="inner-guide"></div>
                    <div className="outer-guide"></div>
                </div>
            </div>

            <div className="grid gap-4">
                {/* è¡£æœé¸æ“‡å™¨èˆ‡ Meta å¥—ç”¨ */}
                <div className="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
                    <span className="text-[10px] font-bold text-slate-400 block mb-3 uppercase tracking-tighter">Smart Suit Fitting</span>
                    <div className="flex gap-2 overflow-x-auto no-scrollbar">
                        <button onClick={()=>selectSuit(null)} className="flex-shrink-0 w-12 h-12 border-2 border-dashed border-slate-200 rounded-xl">âœ•</button>
                        {['m1.png', 'f1.png'].map(id => (
                            <button key={id} onClick={()=>selectSuit(id)} className={`flex-shrink-0 w-12 h-12 border-2 rounded-xl p-1 ${suit.id===id?'border-blue-500':'border-transparent bg-slate-50'}`}>
                                <img src={`clothes/${id}`} className="w-full h-full object-contain" />
                            </button>
                        ))}
                    </div>
                </div>

                {/* ç‰©ç†æ§åˆ¶é … */}
                <div className="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm space-y-4">
                    <div className="flex justify-between items-center">
                        <span className="text-[10px] font-bold text-slate-400 uppercase">Face Scale</span>
                        <input type="range" className="w-2/3" min="0.3" max="1.5" step="0.01" value={p.s} onChange={e=>setP({...p, s:+e.target.value})} />
                    </div>
                    <div className="flex justify-between items-center">
                        <span className="text-[10px] font-bold text-slate-400 uppercase">Suit Scale</span>
                        <input type="range" className="w-2/3" min="0.5" max="2.0" step="0.01" value={sp.s} onChange={e=>setSp({...sp, s:+e.target.value})} />
                    </div>
                    
                    <div className="grid grid-cols-2 gap-3 pt-2">
                        <label className="bg-slate-900 text-white py-3 rounded-2xl text-center text-xs font-bold cursor-pointer">
                            ä¸Šå‚³ç…§ç‰‡ <input type="file" hidden accept="image/*" onChange={e => {
                                const f = e.target.files[0];
                                if(!f) return;
                                const img = new Image();
                                img.onload = () => { setImage(img); autoFit(); };
                                img.src = URL.createObjectURL(f);
                            }} />
                        </label>
                        <button onClick={() => {
                            canvasRef.current.toBlob(b => {
                                const url = URL.createObjectURL(b);
                                setSlots([url, ...slots]);
                                showToast("ğŸ“¥ å·²å­˜å…¥æ§½ä½");
                            });
                        }} className="bg-blue-600 text-white py-3 rounded-2xl text-xs font-bold">å­˜å…¥æ§½ä½</button>
                    </div>
                </div>
            </div>

            <div className="mt-8">
                 <button onClick={()=>downloadA4('MIX')} className="w-full bg-emerald-700 text-white py-4 rounded-2xl font-black text-sm shadow-xl italic tracking-widest">A4 MIX MASTER OUTPUT</button>
            </div>
        </div>
    );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
