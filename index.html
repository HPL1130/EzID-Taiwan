<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.47.8</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face { font-family: 'NotoSansTC'; src: local('Microsoft JhengHei'); font-weight: 700; }
        body { font-family: 'NotoSansTC', sans-serif; background: #1e293b; color: #f8fafc; margin: 0; display: flex; justify-content: center; overflow-x: hidden; }
        #root { width: 100%; max-width: 500px; min-height: 100vh; }
        .editor-stage { position: relative; width: 100%; aspect-ratio: 350/450; background: #ffffff; border-radius: 16px; overflow: hidden; touch-action: none; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .guide-circle { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 65%; border: 2px dashed rgba(59, 130, 246, 0.4); border-radius: 50%; pointer-events: none; z-index: 10; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type="range"] { accent-color: #3b82f6; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        /* ============================================================
           1Ô∏è‚É£ Ê†∏ÂøÉÊï∏ÊìöÂ•ëÁ¥Ñ (Core Contract) - Âö¥Ê†º 12 Á®ÆÁâàÈù¢
           ============================================================ */
        const SPECS = {
            'A4-20':   { id: 'A4-20',   w: 2480, h: 3508, grid: [5, 4], size: [413, 531], name: 'A4 2Âêã(20)' },
            'A4-42':   { id: 'A4-42',   w: 2480, h: 3508, grid: [7, 6], size: [295, 413], name: 'A4 1Âêã(42)' },
            'A4-ID':   { id: 'A4-ID',   w: 2480, h: 3508, grid: [4, 4], size: [450, 600], name: 'A4 Ë≠∑ÁÖß(16)' },
            'A4-BIG':  { id: 'A4-BIG',  w: 2480, h: 3508, grid: [4, 3], size: [531, 708], name: 'A4 Â§ßÈ†≠(12)' },
            'A4-B':    { id: 'A4-B',    w: 2480, h: 3508, grid: [6, 5], size: [354, 472], name: 'A4 BÁâà(30)' },
            'NAME':    { id: 'NAME',    w: 2480, h: 3508, grid: [6, 4], size: [295, 413], name: 'Â∑•Áâå(24)' },
            '4x6-8':   { id: '4x6-8',   w: 1800, h: 1200, grid: [2, 4], size: [413, 531], name: '4x6 2Âêã(8)' },
            '4x6-10':  { id: '4x6-10',  w: 1800, h: 1200, grid: [2, 5], size: [295, 413], name: '4x6 1Âêã(10)' },
            '4x6-12':  { id: '4x6-12',  w: 1800, h: 1200, grid: [3, 4], size: [295, 413], name: '4x6 1Âêã(12)' },
            '4x6-BIG': { id: '4x6-BIG', w: 1800, h: 1200, grid: [2, 3], size: [531, 708], name: '4x6 Â§ßÈ†≠(6)' },
            'A4-MIX':  { 
                id: 'A4-MIX', w: 2480, h: 3508, name: 'A4 Á∂úÂêà',
                sections: [
                    { x: 0, y: 0,    w: 2480, h: 1754, grid: [3, 4], size: [413, 531], count: 12 },
                    { x: 0, y: 1754, w: 2480, h: 1754, grid: [3, 6], size: [295, 413], count: 18 }
                ]
            },
            '4x6-MIX': { 
                id: '4x6-MIX', w: 1800, h: 1200, name: '4x6 Á∂úÂêà',
                sections: [
                    { x: 0,   y: 0, w: 900, h: 1200, grid: [2, 2], size: [450, 600], count: 4 },
                    { x: 900, y: 0, w: 900, h: 1200, grid: [2, 2], size: [413, 531], count: 4 }
                ]
            }
        };

        /* ============================================================
           2Ô∏è‚É£ Áπ™ÂúñÊ†∏ÂøÉÂ∞ÅË£ù (Renderer) - ÂÆåÊï¥ÂØ¶‰Ωú
           ============================================================ */
        const Renderer = {
            // Ë®àÁÆó‰ΩàÂ±ÄÔºöËôïÁêÜÊôÆÈÄöËàá MIX ÂàÜÂçÄÈÇèËºØ
            calculateLayout: (spec) => {
                const getGrid = (w, h, grid, size, ox, oy) => {
                    const [rows, cols] = grid, [pw, ph] = size;
                    // Ë®àÁÆóÈñìÈöôÔºàMarginÔºâ‰ΩøÁÖßÁâáÂùáÂãªÂàÜ‰Ωà
                    const mx = (w - cols * pw) / (cols + 1), my = (h - rows * ph) / (rows + 1);
                    const coords = [];
                    for (let r = 0; r < rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            coords.push({
                                x: ox + mx + c * (pw + mx),
                                y: oy + my + r * (ph + my),
                                w: pw, h: ph
                            });
                        }
                    }
                    return coords;
                };

                if (spec.sections) {
                    return spec.sections.flatMap(s => getGrid(s.w, s.h, s.grid, s.size, s.x, s.y).slice(0, s.count));
                }
                return getGrid(spec.w, spec.h, spec.grid, spec.size, 0, 0);
            },

            // Áπ™Ë£ΩÂúñÂ±§ÔºöËôïÁêÜÁ∏ÆÊîæ„ÄÅÊóãËΩâ„ÄÅÈè°ÂÉè
            drawLayer: (ctx, img, transform, rect, baseWidth = 350) => {
                if (!img) return;
                const ratio = rect.w / baseWidth; // Ê†πÊìöËº∏Âá∫ÁõÆÊ®ôÂØ¨Â∫¶Ë®àÁÆóÊØî‰æã
                const { x, y, s, r, f } = transform;
                
                ctx.save();
                // ÁßªÂãïËá≥ÁõÆÊ®ôÊ†ºÂ≠ê‰∏≠ÂøÉÔºå‰∏¶Âä†‰∏äÁ∑®ËºØ‰ΩçÁßª
                ctx.translate(rect.x + rect.w / 2 + x * ratio, rect.y + rect.h / 2 + y * ratio);
                ctx.rotate((r * Math.PI) / 180);
                // ÊáâÁî®Á∏ÆÊîæËàáÈè°ÂÉè (f Âè™Êúâ 1 Êàñ -1)
                ctx.scale(s * ratio * (f || 1), s * ratio);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);
                ctx.restore();
            }
        };

        /* ============================================================
           3Ô∏è‚É£ React ‰∏ªÁ®ãÂºè (App) - ÂÆåÊï¥ UI Ëàá ÈÇèËºØ
           ============================================================ */
        function App() {
            const [params, setParams] = useState({
                photo: { x: 0, y: 0, s: 0.5, r: 0, f: 1 },
                suit: { x: 0, y: 80, s: 0.8, r: 0, f: 1 }
            });
            const [assets, setAssets] = useState({ img: null, suit: null });
            const [history, setHistory] = useState([]);
            const [ui, setUi] = useState({ target: 'photo', activeSpec: 'A4-20', loading: false, results: null });

            const canvasRef = useRef(null);
            const dragRef = useRef({ isDragging: false, lastX: 0, lastY: 0 });

            // Âç≥ÊôÇÈ†êË¶ΩÔºöÊØè‰∏ÄÂΩ±Ê†ºÂêåÊ≠•Êõ¥Êñ∞ Canvas
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = "#fff";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const previewRect = { x: 0, y: 0, w: 350, h: 450 };
                Renderer.drawLayer(ctx, assets.img, params.photo, previewRect);
                Renderer.drawLayer(ctx, assets.suit, params.suit, previewRect);
            }, [assets, params]);

            // Â∞éÂá∫ÂäüËÉΩÂØ¶‰Ωú
            const runExport = async (all = false) => {
                if (!assets.img) return;
                setUi(p => ({ ...p, loading: true }));
                
                const targetSpecs = all ? Object.keys(SPECS) : [ui.activeSpec];
                const dataPool = history.length > 0 ? history : [{ assets, params }];
                const outputs = [];

                for (const specId of targetSpecs) {
                    const spec = SPECS[specId];
                    const outCanvas = document.createElement('canvas');
                    outCanvas.width = spec.w; outCanvas.height = spec.h;
                    const outCtx = outCanvas.getContext('2d');
                    
                    // ËÉåÊôØÂ°´ÁôΩ
                    outCtx.fillStyle = "white";
                    outCtx.fillRect(0, 0, spec.w, spec.h);

                    const layout = Renderer.calculateLayout(spec);
                    layout.forEach((rect, i) => {
                        const item = dataPool[i % dataPool.length];
                        Renderer.drawLayer(outCtx, item.assets.img, item.params.photo, rect);
                        Renderer.drawLayer(outCtx, item.assets.suit, item.params.suit, rect);
                    });

                    outputs.push({ id: specId, name: spec.name, url: outCanvas.toDataURL('image/jpeg', 0.9) });
                    // Áü≠Êö´Âª∂ÈÅ≤ÈÅøÂÖç UI ÂáçÁµê
                    await new Promise(r => setTimeout(r, 30));
                }

                setUi(p => ({ ...p, results: outputs, loading: false }));
            };

            return (
                <div className="w-full flex flex-col p-6 gap-6 pb-12">
                    <header className="flex justify-between items-end">
                        <div className="flex flex-col">
                            <h1 className="text-3xl font-black italic text-blue-500 tracking-tighter leading-none">EzID</h1>
                            <span className="text-[10px] text-slate-500 font-mono font-bold">VER 20.47.8</span>
                        </div>
                        <div className="px-3 py-1 bg-blue-500/10 border border-blue-500/20 rounded-full text-[10px] text-blue-400 font-black">NO BACKGROUND REMOVAL</div>
                    </header>

                    {/* Á∑®ËºØÂô®Áï´Â∏É */}
                    <div className="editor-stage"
                         onPointerDown={e => {
                             dragRef.current = { isDragging: true, lastX: e.clientX, lastY: e.clientY };
                             e.target.setPointerCapture(e.pointerId);
                         }}
                         onPointerMove={e => {
                             if (!dragRef.current.isDragging) return;
                             const dx = (e.clientX - dragRef.current.lastX) / params[ui.target].s;
                             const dy = (e.clientY - dragRef.current.lastY) / params[ui.target].s;
                             setParams(p => ({
                                 ...p,
                                 [ui.target]: { ...p[ui.target], x: p[ui.target].x + dx, y: p[ui.target].y + dy }
                             }));
                             dragRef.current.lastX = e.clientX;
                             dragRef.current.lastY = e.clientY;
                         }}
                         onPointerUp={e => {
                             dragRef.current.isDragging = false;
                             e.target.releasePointerCapture(e.pointerId);
                         }}>
                        <canvas ref={canvasRef} width="350" height="450" className="w-full h-full" />
                        <div className="guide-circle"></div>
                        {ui.loading && (
                            <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
                                <div className="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                                <span className="text-xs font-black text-blue-500 uppercase tracking-widest">Generating</span>
                            </div>
                        )}
                    </div>

                    {/* Â±§Á¥öÈÅ∏Êìá */}
                    <div className="grid grid-cols-2 gap-3">
                        {['photo', 'suit'].map(t => (
                            <button key={t} onClick={() => setUi(p => ({ ...p, target: t }))}
                                className={`py-4 rounded-2xl text-xs font-black transition-all ${ui.target === t ? 'bg-blue-600 text-white shadow-lg' : 'bg-slate-800 text-slate-500 hover:text-slate-300'}`}>
                                {t === 'photo' ? 'EDIT PHOTO' : 'EDIT SUIT'}
                            </button>
                        ))}
                    </div>

                    {/* Ë™øÊï¥ÊªëÊ°øËàáÊåâÈàï */}
                    <div className="bg-slate-800/50 p-6 rounded-3xl border border-white/5 space-y-6">
                        <div className="flex items-center gap-4">
                            <span className="text-[10px] font-black text-slate-500 w-10">ZOOM</span>
                            <input type="range" className="flex-1 h-1.5 bg-slate-700 rounded-lg appearance-none" 
                                   min="0.01" max="3" step="0.01" value={params[ui.target].s}
                                   onChange={e => setParams(p => ({ ...p, [ui.target]: { ...p[ui.target], s: parseFloat(e.target.value) } }))} />
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <button onClick={() => setParams(p => ({ ...p, [ui.target]: { ...p[ui.target], r: p[ui.target].r + 90 } }))} className="py-3 bg-slate-700 rounded-xl text-[10px] font-black active:scale-95 transition-all">ROTATE 90¬∞</button>
                            <button onClick={() => setParams(p => ({ ...p, [ui.target]: { ...p[ui.target], f: p[ui.target].f * -1 } }))} className="py-3 bg-slate-700 rounded-xl text-[10px] font-black active:scale-95 transition-all">FLIP HORIZONTAL</button>
                        </div>
                    </div>

                    {/* Ë¶èÊ†ºÊ©´ÂêëÂàóË°® */}
                    <div className="flex gap-2 overflow-x-auto no-scrollbar py-2">
                        {Object.keys(SPECS).map(id => (
                            <button key={id} onClick={() => setUi(p => ({ ...p, activeSpec: id }))}
                                className={`py-2 px-4 rounded-lg text-[10px] font-black whitespace-nowrap border transition-all ${ui.activeSpec === id ? 'border-blue-500 text-blue-400 bg-blue-500/10' : 'border-transparent bg-slate-800 text-slate-500 hover:bg-slate-700'}`}>
                                {SPECS[id].name}
                            </button>
                        ))}
                    </div>

                    {/* Â∫ïÈÉ®ÂäüËÉΩÈàï */}
                    <div className="flex flex-col gap-3">
                        <div className="flex gap-3">
                            <label className="flex-1 py-4 bg-slate-700 rounded-2xl text-center text-[11px] font-black cursor-pointer hover:bg-slate-600 transition-all shadow-md">
                                üì∏ LOAD IMAGE
                                <input type="file" hidden onChange={e => {
                                    const f = e.target.files[0];
                                    if (f) {
                                        const i = new Image();
                                        i.onload = () => setAssets(p => ({ ...p, img: i }));
                                        i.src = URL.createObjectURL(f);
                                    }
                                }} />
                            </label>
                            <button onClick={() => {
                                if (assets.img) setHistory(p => [...p, JSON.parse(JSON.stringify({ assets, params }))]);
                            }} className="flex-1 py-4 bg-slate-700 rounded-2xl text-[11px] font-black hover:bg-slate-600 transition-all shadow-md">
                                üíæ SNAPSHOT ({history.length})
                            </button>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={() => runExport(false)} className="flex-[2] py-5 bg-blue-600 rounded-2xl text-[11px] font-black shadow-lg shadow-blue-500/20 active:scale-95 transition-all">EXPORT ACTIVE</button>
                            <button onClick={() => runExport(true)} className="flex-1 py-5 bg-emerald-600 rounded-2xl text-[11px] font-black shadow-lg shadow-emerald-500/20 active:scale-95 transition-all">üî• BATCH ALL</button>
                        </div>
                    </div>

                    {/* Â∞éÂá∫ÁµêÊûú Modal */}
                    {ui.results && (
                        <div className="fixed inset-0 bg-slate-950/98 z-[100] overflow-y-auto p-6 backdrop-blur-lg">
                            <div className="max-w-sm mx-auto flex flex-col gap-10 py-10">
                                <h2 className="text-3xl font-black text-center text-blue-500 italic tracking-widest">READY</h2>
                                {ui.results.map((res, i) => (
                                    <div key={i} className="bg-slate-900 p-6 rounded-3xl border border-white/5 space-y-4 shadow-2xl">
                                        <div className="flex justify-between items-center">
                                            <span className="text-[10px] font-mono text-slate-500">{res.id}</span>
                                            <span className="text-[10px] font-black text-blue-500">{res.name}</span>
                                        </div>
                                        <img src={res.url} className="w-full rounded-2xl border border-white/10" />
                                        <a href={res.url} download={`${res.id}.jpg`} className="block w-full py-4 bg-blue-600 text-white rounded-2xl text-center text-xs font-black shadow-lg active:scale-95 transition-all">DOWNLOAD JPEG</a>
                                    </div>
                                ))}
                                <button onClick={() => setUi(p => ({ ...p, results: null }))} className="w-full py-5 bg-white text-black rounded-full font-black text-sm active:scale-95 transition-all shadow-xl">BACK TO EDITOR</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
