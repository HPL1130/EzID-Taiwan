<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>EzID v20.47.2</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face { font-family: 'NotoSansTC'; src: local('Microsoft JhengHei'); font-weight: 700; }
        body { font-family: 'NotoSansTC', sans-serif; background: #020617; color: #f8fafc; margin: 0; overflow-x: hidden; }
        .editor-stage { position: relative; width: 100%; aspect-ratio: 350/450; background: #fff; border-radius: 24px; overflow: hidden; box-shadow: 0 0 0 4px #1e293b; touch-action: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        /* ============================================================
           1ï¸âƒ£ æ ¸å¿ƒæ•¸æ“šå€ (CORE SPECS) - 12 ç¨®è¦æ ¼åŠ MIX å®šç¾©
           ============================================================ */
        const SPECS = {
            'A4-20':   { id: 'A4-20',   w: 2480, h: 3508, grid: [5, 4], size: [413, 531], name: 'A4 2å‹(20)' },
            'A4-42':   { id: 'A4-42',   w: 2480, h: 3508, grid: [7, 6], size: [295, 413], name: 'A4 1å‹(42)' },
            'A4-ID':   { id: 'A4-ID',   w: 2480, h: 3508, grid: [4, 4], size: [450, 600], name: 'A4 è­·ç…§(16)' },
            'A4-BIG':  { id: 'A4-BIG',  w: 2480, h: 3508, grid: [4, 3], size: [531, 708], name: 'A4 å¤§é ­(12)' },
            'A4-B':    { id: 'A4-B',    w: 2480, h: 3508, grid: [6, 5], size: [354, 472], name: 'A4 Bç‰ˆ(30)' },
            'NAME':    { id: 'NAME',    w: 2480, h: 3508, grid: [6, 4], size: [295, 413], name: 'å·¥ç‰Œ(24)' },
            '4x6-8':   { id: '4x6-8',   w: 1800, h: 1200, grid: [2, 4], size: [413, 531], name: '4x6 2å‹(8)' },
            '4x6-10':  { id: '4x6-10',  w: 1800, h: 1200, grid: [2, 5], size: [295, 413], name: '4x6 1å‹(10)' },
            '4x6-12':  { id: '4x6-12',  w: 1800, h: 1200, grid: [3, 4], size: [295, 413], name: '4x6 1å‹(12)' },
            '4x6-BIG': { id: '4x6-BIG', w: 1800, h: 1200, grid: [2, 3], size: [531, 708], name: '4x6 å¤§é ­(6)' },
            'A4-MIX':  { 
                id: 'A4-MIX', w: 2480, h: 3508, name: 'A4 ç¶œåˆ',
                sections: [
                    { x: 0, y: 0,    w: 2480, h: 1754, grid: [3, 4], size: [413, 531], count: 12 },
                    { x: 0, y: 1754, w: 2480, h: 1754, grid: [3, 6], size: [295, 413], count: 18 }
                ]
            },
            '4x6-MIX': { 
                id: '4x6-MIX', w: 1800, h: 1200, name: '4x6 ç¶œåˆ',
                sections: [
                    { x: 0,   y: 0, w: 900, h: 1200, grid: [2, 2], size: [450, 600], count: 4 },
                    { x: 900, y: 0, w: 900, h: 1200, grid: [2, 2], size: [413, 531], count: 4 }
                ]
            }
        };

        /* ============================================================
           2ï¸âƒ£ ç¹ªåœ–å¼•æ“å€ (RENDER ENGINE) - ç²¾ç¢ºåº§æ¨™é‹ç®—
           ============================================================ */
        const Engine = {
            getLayout: (spec) => {
                const build = (w, h, grid, size, ox, oy) => {
                    const [rs, cs] = grid, [pw, ph] = size;
                    const mx = (w - cs * pw) / (cs + 1), my = (h - rs * ph) / (rs + 1);
                    return Array.from({length: rs * cs}, (_, i) => ({
                        x: ox + mx + (i % cs) * (pw + mx), y: oy + my + Math.floor(i / cs) * (ph + my), w: pw, h: ph
                    }));
                };
                if (spec.sections) return spec.sections.flatMap(s => build(s.w, s.h, s.grid, s.size, s.x, s.y).slice(0, s.count));
                return build(spec.w, spec.h, spec.grid, spec.size, 0, 0);
            },
            drawItem: (ctx, data, rect) => {
                if (!data?.img) return;
                const ratio = rect.w / 350;
                ctx.save();
                ctx.beginPath(); ctx.rect(rect.x, rect.y, rect.w, rect.h); ctx.clip();
                const drawLayer = (t, img) => {
                    if (!img) return;
                    ctx.save();
                    ctx.translate(rect.x + rect.w/2 + t.x * ratio, rect.y + rect.h/2 + t.y * ratio);
                    ctx.rotate(t.r * Math.PI / 180);
                    ctx.scale(t.s * ratio * (t.f || 1), t.s * ratio);
                    ctx.drawImage(img, -img.width/2, -img.height/2);
                    ctx.restore();
                };
                drawLayer(data.photoT, data.img);
                if (data.suit) drawLayer(data.suitT, data.suit);
                ctx.restore();
                ctx.strokeStyle = "rgba(0,0,0,0.1)"; ctx.strokeRect(rect.x, rect.y, rect.w, rect.h);
            }
        };

        /* ============================================================
           3ï¸âƒ£ ä¸»ç¨‹å¼èˆ‡ UI åˆ†å€ (MAIN APP)
           ============================================================ */
        function App() {
            const [state, setState] = useState({
                img: null, suit: null,
                photoT: { x: 0, y: 0, s: 0.5, r: 0, f: 1 },
                suitT: { x: 0, y: 50, s: 1, r: 0, f: 1 },
                target: 'PHOTO',
                assets: [],
                activeSpec: 'A4-20',
                progress: 0,
                results: null
            });

            const cvsRef = useRef(null);
            const drag = useRef({ active: false, x: 0, y: 0 });

            useEffect(() => {
                const ctx = cvsRef.current?.getContext('2d');
                if (ctx) {
                    ctx.fillStyle = "#fff"; ctx.fillRect(0,0,350,450);
                    Engine.drawItem(ctx, state, {x:0, y:0, w:350, h:450});
                }
            }, [state]);

            const handleExport = async (all = false) => {
                if (!state.img) return;
                setState(p => ({ ...p, progress: 1 }));
                const targets = all ? Object.keys(SPECS) : [state.activeSpec];
                const pool = state.assets.length > 0 ? state.assets : [state];
                
                setTimeout(() => {
                    const outputs = targets.map(id => {
                        const spec = SPECS[id];
                        const canvas = document.createElement('canvas');
                        canvas.width = spec.w; canvas.height = spec.h;
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = "white"; ctx.fillRect(0,0,spec.w,spec.h);
                        Engine.getLayout(spec).forEach((pos, i) => Engine.drawItem(ctx, pool[i % pool.length], pos));
                        return { name: id, url: canvas.toDataURL('image/jpeg', 0.9) };
                    });
                    setState(p => ({ ...p, results: outputs, progress: 0 }));
                }, 100);
            };

            return (
                <div className="max-w-md mx-auto p-4 flex flex-col gap-5 select-none pb-10">
                    <header className="flex justify-between items-center py-2 border-b border-white/10">
                        <h1 className="text-xl font-black italic text-blue-500">EzID <span className="text-white text-xs not-italic">v20.47.2</span></h1>
                        <span className="text-[10px] opacity-40 font-mono">MANUAL CONTROL</span>
                    </header>

                    <div className="editor-stage"
                         onPointerDown={e => { drag.current = { active: true, x: e.clientX, y: e.clientY }; e.target.setPointerCapture(e.pointerId); }}
                         onPointerMove={e => {
                             if(!drag.current.active) return;
                             const k = state.target === 'PHOTO' ? 'photoT' : 'suitT';
                             const dx = (e.clientX - drag.current.x) / state[k].s;
                             const dy = (e.clientY - drag.current.y) / state[k].s;
                             setState(p => ({ ...p, [k]: { ...p[k], x: p[k].x + dx, y: p[k].y + dy } }));
                             drag.current.x = e.clientX; drag.current.y = e.clientY;
                         }}
                         onPointerUp={e => { drag.current.active = false; e.target.releasePointerCapture(e.pointerId); }}>
                        <canvas ref={cvsRef} width="350" height="450" className="w-full h-full" />
                    </div>

                    <div className="flex gap-2 p-1 bg-slate-900 rounded-2xl">
                        {['PHOTO', 'SUIT'].map(t => (
                            <button key={t} onClick={()=>setState(p=>({...p, target:t}))}
                                className={`flex-1 py-3 rounded-xl text-[11px] font-bold ${state.target===t?'bg-blue-600 text-white':'text-slate-500'}`}>
                                {t === 'PHOTO' ? 'ç…§ç‰‡å±¤' : 'æ­£è£å±¤'}
                            </button>
                        ))}
                    </div>

                    <div className="bg-slate-900/50 p-4 rounded-3xl border border-white/5 space-y-4">
                        <input type="range" className="w-full" min="0.1" max="1.5" step="0.01" 
                               value={state[state.target==='PHOTO'?'photoT':'suitT'].s} 
                               onChange={e => {
                                   const k = state.target==='PHOTO'?'photoT':'suitT';
                                   setState(p => ({ ...p, [k]: { ...p[k], s: parseFloat(e.target.value) } }));
                               }} />
                        <div className="flex gap-2">
                            <button onClick={() => {
                                const k = state.target==='PHOTO'?'photoT':'suitT';
                                setState(p => ({ ...p, [k]: { ...p[k], r: p[k].r + 90 } }));
                            }} className="flex-1 py-3 bg-slate-800 rounded-xl text-[10px] font-bold">æ—‹è½‰è§’åº¦</button>
                            <button onClick={() => {
                                const k = state.target==='PHOTO'?'photoT':'suitT';
                                setState(p => ({ ...p, [k]: { ...p[k], f: p[k].f * -1 } }));
                            }} className="flex-1 py-3 bg-slate-800 rounded-xl text-[10px] font-bold">æ°´å¹³é¡åƒ</button>
                        </div>
                    </div>

                    <div className="grid grid-cols-3 gap-2">
                        {Object.keys(SPECS).map(id => (
                            <button key={id} onClick={()=>setState(p=>({...p, activeSpec:id}))}
                                className={`py-2 text-[9px] font-bold rounded-lg border ${state.activeSpec===id?'border-blue-500 text-blue-400 bg-blue-500/10':'border-transparent bg-slate-900 text-slate-600'}`}>
                                {SPECS[id].name}
                            </button>
                        ))}
                    </div>

                    <div className="flex flex-col gap-3">
                        <div className="flex gap-3">
                            <label className="flex-1 py-4 bg-slate-800 rounded-2xl text-center text-[11px] font-bold cursor-pointer">ğŸ“¸ è¼‰å…¥ç…§ç‰‡<input type="file" hidden onChange={e=>{
                                const f=e.target.files[0]; if(f){const i=new Image(); i.onload=()=>setState(p=>({...p, img:i})); i.src=URL.createObjectURL(f);}
                            }} /></label>
                            <button onClick={() => {
                                if(!state.img) return;
                                setState(p => ({ ...p, assets: [...p.assets, {...state, id: Date.now()}] }));
                            }} className="flex-1 py-4 bg-slate-800 rounded-2xl text-[11px] font-bold">ğŸ’¾ æš«å­˜å¿«ç…§</button>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>handleExport(false)} className="flex-[2] py-4 bg-blue-600 rounded-2xl text-[11px] font-bold shadow-lg">å°å‡ºç•¶å‰</button>
                            <button onClick={()=>handleExport(true)} className="flex-1 py-4 bg-emerald-600 rounded-2xl text-[11px] font-bold shadow-lg">ğŸ”¥ æ‰¹æ¬¡</button>
                        </div>
                    </div>

                    {state.results && (
                        <div className="fixed inset-0 bg-slate-950 z-50 overflow-y-auto p-6">
                            <div className="max-w-sm mx-auto space-y-6">
                                <h2 className="text-xl font-black text-center">ç”Ÿç”¢å ±å‘Š</h2>
                                {state.results.map((res, i) => (
                                    <div key={i} className="bg-slate-900 p-4 rounded-3xl border border-white/5 space-y-3">
                                        <p className="text-[10px] font-mono text-blue-500">{res.name}.jpg</p>
                                        <img src={res.url} className="w-full rounded-xl" />
                                        <a href={res.url} download={`${res.name}.jpg`} className="block w-full py-3 bg-blue-600 rounded-xl text-center text-xs font-bold">ä¸‹è¼‰</a>
                                    </div>
                                ))}
                                <button onClick={()=>setState(p=>({...p, results:null}))} className="w-full py-4 bg-white text-black rounded-full font-black">è¿”å›</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
</body>
</html>
