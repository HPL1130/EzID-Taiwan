<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.24 çµ‚æ¥µæ——è‰¦ç‰ˆ - å…¨è¦æ ¼å…¨æ§½ä½ä¸çœç•¥</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face { font-family: 'NotoSansTC'; src: local('Noto Sans TC'), local('Microsoft JhengHei'), sans-serif; font-weight: 700; }
        body { font-family: 'NotoSansTC', sans-serif; background: #f1f5f9; touch-action: pan-y; margin: 0; padding: 0; }
        .canvas-main { border-radius: 40px; background: white; box-shadow: 0 30px 60px -12px rgba(0,0,0,0.3); touch-action: none; border: 4px solid #fff; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-target { background: #2563eb !important; color: white !important; box-shadow: 0 10px 15px -3px rgba(37,99,235,0.3); }
        .slot-thumb { width: 60px; height: 80px; object-fit: cover; border-radius: 12px; border: 2px solid #e2e8f0; }
        .name-input { width: 100%; padding: 12px; font-size: 16px; border: 2px solid #e2e8f0; border-radius: 12px; outline: none; transition: all 0.2s; background: white; font-weight: 700; color: #1e293b; }
        .name-input:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .name-list { max-height: 280px; overflow-y: auto; scrollbar-width: none; }
    </style>
</head>
<body class="pb-20">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useTransition, useCallback } = React;

// ğŸ›¡ï¸ 12ç¨®è¦æ ¼å®Œå…¨ç¡¬ç·¨ç¢¼ - çµ•å°ä¸çœç•¥ä»»ä½•ä¸€å€‹
const SPECS = {
    'A4-20':  { w: 2480, h: 3508, photos: 20, grid: [5, 4], size: [413, 531], name: 'A4 2å‹(20å¼µ)' },
    'A4-42':  { w: 2480, h: 3508, photos: 42, grid: [7, 6], size: [295, 413], name: 'A4 1å‹(42å¼µ)' },
    'A4-MIX': { w: 2480, h: 3508, type: 'MIX', name: 'A4 ç¶œåˆ(12+18)' },
    'A4-BIG': { w: 2480, h: 3508, photos: 12, grid: [4, 3], size: [531, 708], name: 'A4 å¤§é ­(12å¼µ)' },
    'A4-ID':  { w: 2480, h: 3508, photos: 16, grid: [4, 4], size: [450, 600], name: 'A4 è­‰ä»¶(16å¼µ)' },
    'A4-B':   { w: 2480, h: 3508, photos: 30, grid: [6, 5], size: [354, 472], name: 'A4 æ··åˆBç‰ˆ' },
    '4x6-8':  { w: 1800, h: 1200, photos: 8,  grid: [2, 4], size: [413, 531], name: '4x6 2å‹(8å¼µ)' },
    '4x6-10': { w: 1800, h: 1200, photos: 10, grid: [2, 5], size: [295, 413], name: '4x6 1å‹(10å¼µ)' },
    '4x6-BIG':{ w: 1800, h: 1200, photos: 6,  grid: [2, 3], size: [531, 708], name: '4x6 å¤§é ­ç…§(6å¼µ)' },
    '4x6-12': { w: 1800, h: 1200, photos: 12, grid: [3, 4], size: [295, 413], name: '4x6 1å‹(12å¼µ)' },
    '4x6-MIX':{ w: 1800, h: 1200, type: 'MIX46', name: '4x6 æ··åˆ(4+4)' },
    'NAME':   { w: 2480, h: 3508, photos: 24, grid: [6, 4], size: [295, 413], special: 'NAME', name: 'ğŸ‘¨â€ğŸ’¼ å§“åå·¥ç‰Œç‰ˆ(24äºº)' }
};

const CLOTHES = {
    male: ['m1.png', 'm2.png', 'm3.png', 'm4.png', 'm5.png'],
    female: ['f1.png', 'f2.png', 'f3.png', 'f4.png', 'f5.png']
};

function App() {
    const [isPending, startTransition] = useTransition();
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [gender, setGender] = useState('male');
    const [target, setTarget] = useState('PHOTO'); // PHOTO | SUIT
    const [pT, setPT] = useState({ x: 0, y: -20, s: 0.45, r: 0 });
    const [sT, setST] = useState({ x: 0, y: 80, s: 1.0, r: 0 });
    const [slots, setSlots] = useState([]);
    const [names, setNames] = useState(Array(42).fill('')); // å°æ‡‰æœ€å¤§1å‹ç…§ç‰‡æ•¸é‡
    const [preview, setPreview] = useState(null);
    const canvasRef = useRef(null);
    const drag = useRef({ active: false, x: 0, y: 0 });

    const drawEllipse = (ctx) => {
        ctx.save(); ctx.beginPath();
        ctx.ellipse(175, 210, 110, 150, 0, 0, Math.PI * 2);
        ctx.strokeStyle = "rgba(16, 185, 129, 0.7)"; ctx.lineWidth = 3; ctx.setLineDash([10, 5]); ctx.stroke();
        ctx.restore();
    };

    const drawSingle = (ctx, img, sImg, photoT, suitT, x, y, pw, ph, isExport = false, nameIndex = -1, customName = '') => {
        const r = isExport ? pw / 350 : 1;
        ctx.save(); ctx.beginPath(); ctx.rect(x, y, pw, ph); ctx.clip();
        if (img) {
            ctx.save();
            ctx.translate(x + pw/2 + photoT.x * r, y + ph/2 + photoT.y * r);
            ctx.rotate(photoT.r * Math.PI / 180);
            ctx.scale(photoT.s * r, photoT.s * r);
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(img, -img.width/2, -img.height/2);
            ctx.restore();
        }
        if (sImg) {
            ctx.save();
            ctx.translate(x + pw/2 + suitT.x * r, y + ph/2 + suitT.y * r);
            ctx.rotate(suitT.r * Math.PI / 180);
            ctx.scale(suitT.s * r, suitT.s * r);
            ctx.drawImage(sImg, -sImg.width/2, -sImg.height/2);
            ctx.restore();
        }
        ctx.restore();

        // ğŸ‘¨â€ğŸ’¼ å§“åå·¥ç‰Œç‰ˆæ–‡å­—ç¹ªè£½é‚è¼¯
        if (isExport && customName) {
            ctx.fillStyle = "#f1f5f9"; ctx.fillRect(x, y + ph - 80, pw, 80);
            ctx.fillStyle = "#1e293b"; ctx.font = `bold ${Math.floor(pw/8)}px 'NotoSansTC'`;
            ctx.textAlign = "center"; ctx.fillText(customName, x + pw/2, y + ph - 35);
            ctx.fillStyle = "#2563eb"; ctx.font = `bold ${Math.floor(pw/14)}px sans-serif`;
            ctx.fillText(`#${String(nameIndex+1).padStart(2, '0')}`, x + pw/2, y + ph - 10);
        }
        if (!isExport) drawEllipse(ctx);
    };

    useEffect(() => {
        const ctx = canvasRef.current?.getContext('2d');
        if (!ctx) return;
        ctx.fillStyle = "white"; ctx.fillRect(0, 0, 350, 450);
        drawSingle(ctx, image, suitImg, pT, sT, 0, 0, 350, 450);
    }, [image, suitImg, pT, sT]);

    const handlePointerMove = (e) => {
        if (!drag.current.active) return;
        const dx = e.clientX - drag.current.x; const dy = e.clientY - drag.current.y;
        if (target === 'PHOTO') setPT(prev => ({ ...prev, x: prev.x + dx, y: prev.y + dy }));
        else setST(prev => ({ ...prev, x: prev.x + dx, y: prev.y + dy }));
        drag.current.x = e.clientX; drag.current.y = e.clientY;
    };

    const saveSlot = () => {
        if (!image) return alert("è«‹å…ˆä¸Šå‚³ç…§ç‰‡");
        const canvas = document.createElement('canvas');
        canvas.width = 70; canvas.height = 90;
        drawSingle(canvas.getContext('2d'), image, suitImg, pT, sT, 0, 0, 70, 90, true);
        
        const newSlots = [...slots, { image, suitImg, pT: {...pT}, sT: {...sT}, thumb: canvas.toDataURL() }];
        setSlots(newSlots);
        if (!names[newSlots.length - 1]) {
            const newNames = [...names]; newNames[newSlots.length - 1] = `å“¡å·¥${newSlots.length}`;
            setNames(newNames);
        }
    };

    const handleExport = (key) => {
        const spec = SPECS[key];
        startTransition(async () => {
            const canvas = document.createElement('canvas');
            canvas.width = spec.w; canvas.height = spec.h;
            const ctx = canvas.getContext('2d', { alpha: false });
            ctx.fillStyle = "white"; ctx.fillRect(0, 0, spec.w, spec.h);

            const task = async (num, grid, size, yStart = 0) => {
                const [rows, cols] = grid; const [pw, ph] = size;
                const mx = (spec.w - cols * pw) / (cols + 1);
                const my = (spec.h / (spec.type ? 2.1 : 1) - rows * ph) / (rows + 1);
                for (let i = 0; i < num; i++) {
                    const r = Math.floor(i / cols); const c = i % cols;
                    const x = mx + c * (pw + mx); const y = yStart + my + r * (ph + my);
                    const d = slots[i] || { image, suitImg, pT, sT };
                    const n = spec.special === 'NAME' ? names[i] || `å“¡å·¥${i+1}` : '';
                    drawSingle(ctx, d.image, d.suitImg, d.pT, d.sT, x, y, pw, ph, true, i, n);
                    ctx.strokeStyle = "#ddd"; ctx.lineWidth = 2; ctx.strokeRect(x, y, pw, ph);
                    if (i % 6 === 0) await new Promise(res => requestAnimationFrame(res));
                }
            };

            if (spec.type === 'MIX') {
                await task(12, [3, 4], [413, 531], 0);
                await task(18, [3, 6], [295, 413], spec.h * 0.48);
            } else if (spec.type === 'MIX46') {
                await task(4, [1, 4], [413, 531], 0);
                await task(4, [1, 4], [295, 413], spec.h * 0.5);
            } else {
                await task(spec.photos, spec.grid, spec.size, 0);
            }
            setPreview(canvas.toDataURL('image/jpeg', 0.95));
        });
    };

    return (
        <div className="max-w-md mx-auto p-5 space-y-6">
            <header className="text-center">
                <h1 className="text-4xl font-black text-slate-800 italic">EzID <span className="text-blue-600">v24</span></h1>
                <p className="text-[10px] font-bold text-slate-400 tracking-widest uppercase">Full Capability Engine</p>
            </header>

            <div className="flex justify-center">
                <canvas ref={canvasRef} width="350" height="450" className="canvas-main"
                    onPointerDown={e => { e.target.setPointerCapture(e.pointerId); drag.current = { active: true, x: e.clientX, y: e.clientY }; }}
                    onPointerMove={handlePointerMove}
                    onPointerUp={() => drag.current.active = false} />
            </div>

            <div className="flex bg-slate-200 p-1.5 rounded-2xl border border-slate-300">
                <button onClick={() => setTarget('PHOTO')} className={`flex-1 py-3 rounded-xl font-black transition-all ${target==='PHOTO'?'active-target':'text-slate-500'}`}>ğŸ‘¤ èª¿äººåƒ</button>
                <button onClick={() => setTarget('SUIT')} className={`flex-1 py-3 rounded-xl font-black transition-all ${target==='SUIT'?'active-target':'text-slate-500'}`}>ğŸ‘” èª¿è¥¿è£</button>
            </div>

            {/* ğŸ”¥ æ§½ä½èˆ‡å§“åè¼¸å…¥å€ */}
            <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border space-y-4">
                <div className="flex gap-2">
                    <button onClick={saveSlot} className="flex-1 bg-blue-600 text-white h-14 rounded-2xl font-black shadow-lg">ğŸ’¾ å­˜å…¥æ§½ä½</button>
                    <button onClick={()=>{setSlots([]);setNames(Array(42).fill(''))}} className="px-6 bg-red-50 text-red-500 rounded-2xl font-black">æ¸…ç©º</button>
                </div>
                <div className="name-list space-y-2 no-scrollbar">
                    {slots.map((s, idx) => (
                        <div key={idx} className="flex items-center gap-3 p-3 bg-slate-50 rounded-2xl border">
                            <img src={s.thumb} className="w-12 h-16 rounded-lg object-cover border" />
                            <input value={names[idx]} onChange={e=>{const n=[...names];n[idx]=e.target.value;setNames(n)}} className="name-input flex-1 h-10" placeholder="è¼¸å…¥å§“å..." />
                            <span className="text-xs font-black text-blue-600">#{idx+1}</span>
                        </div>
                    ))}
                    {slots.length === 0 && <div className="text-center text-xs text-slate-300 font-bold py-4">å°šç„¡å­˜å…¥æ§½ä½è³‡æ–™</div>}
                </div>
            </div>

            {/* ğŸ‘• è¥¿è£é¸æ“‡ */}
            <div className="bg-white p-4 rounded-[2.5rem] shadow-sm border space-y-3">
                <div className="flex gap-2">
                    {['male', 'female'].map(g => (
                        <button key={g} onClick={()=>setGender(g)} className={`flex-1 py-2 rounded-xl font-black text-xs ${gender===g?'bg-slate-800 text-white':'bg-slate-100 text-slate-400'}`}>{g==='male'?'ç”·è£':'å¥³è£'}</button>
                    ))}
                </div>
                <div className="flex gap-3 overflow-x-auto no-scrollbar py-1">
                    <button onClick={()=>setSuitImg(null)} className="flex-shrink-0 w-14 h-14 bg-red-50 text-red-500 rounded-2xl font-black border-2 border-dashed border-red-100">ğŸš«</button>
                    {CLOTHES[gender].map(f => (
                        <img key={f} src={`clothes/${gender}/${f}`} onClick={()=>{const i=new Image();i.onload=()=>{setSuitImg(i);setTarget('SUIT')};i.src=`clothes/${gender}/${f}`}} 
                        className="flex-shrink-0 w-14 h-14 rounded-2xl cursor-pointer object-cover border-2 hover:border-blue-500 transition-all"/>
                    ))}
                </div>
            </div>

            <div className="grid grid-cols-2 gap-3">
                <label className="flex items-center justify-center bg-slate-900 text-white h-16 rounded-3xl font-black cursor-pointer shadow-xl">
                    ğŸ“¸ ä¸Šå‚³ç…§ç‰‡
                    <input type="file" hidden accept="image/*" onChange={e => {
                        const f = e.target.files[0]; if (f) {
                            const i = new Image(); i.onload = () => { setImage(i); setPT({x:0,y:-20,s:0.45,r:0}); }; i.src = URL.createObjectURL(f);
                        }
                    }} />
                </label>
                <button onClick={() => window.location.reload()} className="bg-white border-2 border-slate-200 text-slate-400 h-16 rounded-3xl font-black">é‡ç½®ç•«å¸ƒ</button>
            </div>

            <div className="bg-white p-6 rounded-[2.5rem] border shadow-sm">
                <h3 className="text-center font-black text-slate-800 text-[10px] mb-4 tracking-widest uppercase">12å°ˆæ¥­è¦æ ¼è¼¸å‡ºé¸å–®</h3>
                <div className="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto no-scrollbar">
                    {Object.keys(SPECS).map(k => (
                        <button key={k} onClick={() => handleExport(k)} disabled={!image || isPending}
                            className="h-14 bg-slate-50 rounded-2xl font-black text-[11px] hover:bg-blue-50 border border-slate-100 transition-all shadow-sm disabled:opacity-30">
                            {SPECS[k].name}
                        </button>
                    ))}
                </div>
            </div>

            {preview && (
                <div className="fixed inset-0 bg-slate-900/98 z-[9999] flex flex-col p-6 items-center justify-center backdrop-blur-xl">
                    <img src={preview} className="max-w-full max-h-[75vh] border-8 border-white shadow-2xl mb-8" />
                    <div className="flex gap-4 w-full max-w-sm">
                        <button onClick={() => setPreview(null)} className="flex-1 h-16 bg-slate-700 text-white rounded-3xl font-black">è¿”å›</button>
                        <a href={preview} download={`EzID_Output_${slots.length}p.jpg`} className="flex-1 h-16 bg-blue-600 text-white rounded-3xl font-black flex items-center justify-center shadow-xl">ä¸‹è¼‰åˆ—å°</a>
                    </div>
                </div>
            )}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
