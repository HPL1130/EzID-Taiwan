<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v2.7.1</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .canvas-container { position:relative; width:350px; height:450px; margin:0 auto; background:#fff; border-radius:32px; border:8px solid #fff; box-shadow:0 20px 40px rgba(0,0,0,.1); overflow:hidden; }
        .inner-guide { border:2px dotted rgba(16,185,129,0.7); position:absolute; border-radius:50%/46%; transform:translateY(-6%); z-index: 100; }
        .outer-guide { border:2px dashed rgba(245,158,11,0.5); position:absolute; border-radius:50%/46%; transform:translateY(-6%); z-index: 99; }
        .center-line { position:absolute; left:50%; top:0; bottom:0; width:1.5px; background:rgba(59,130,246,0.3); pointer-events:none; z-index: 90; }
        .suit-btn { width:56px; height:56px; flex-shrink:0; border:2px solid #f1f5f9; border-radius:14px; background:#fff; display:flex; align-items:center; justify-content:center; }
        .suit-btn.active { border-color:#2563eb; background:#eff6ff; }
        input[type=range] { width:100%; accent-color:#2563eb; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

function App() {
    const canvasRef = useRef(null);
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [activeSuit, setActiveSuit] = useState(null);
    const [slots, setSlots] = useState([]);
    const [p, setP] = useState({ x: 0, y: -20, s: 0.75 });
    const [sp, setSp] = useState({ x: 0, y: 0, s: 1.0 });

    const CLOTHES = {
        male: Array.from({length:5}, (_,i)=> `clothes/male/m${i+1}.png`),
        female: Array.from({length:5}, (_,i)=> `clothes/female/f${i+1}.png`)
    };

    const draw = useCallback(() => {
        const ctx = canvasRef.current.getContext("2d");
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, 350, 450);
        if(image){
            ctx.save(); ctx.translate(175 + p.x, 225 + p.y); ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width/2, -image.height/2); ctx.restore();
        }
        if(suitImg){
            ctx.save();
            const w = 350 * sp.s; const h = (suitImg.height / suitImg.width) * w;
            ctx.drawImage(suitImg, (350 - w)/2 + sp.x, 450 - h + 15 + sp.y, w, h);
            ctx.restore();
        }
    }, [image, suitImg, p, sp]);

    useEffect(() => { draw(); }, [draw]);

    const saveToSlot = () => {
        if(!image) return alert("è«‹å…ˆä¸Šå‚³ç…§ç‰‡");
        setSlots([canvasRef.current.toDataURL("image/jpeg", 0.95), ...slots].slice(0, 8));
    };

    // âœ‚ï¸ ibon å°ˆç”¨è£åˆ‡æ¡†ç¹ªè£½
    const drawIbonCell = (ctx, img, x, y, w, h) => {
        ctx.drawImage(img, x, y, w, h);
        // é»‘è‰²å¤–æ¡†è£åˆ‡ç·š (1px)
        ctx.strokeStyle = "#000000";
        ctx.lineWidth = 1;
        ctx.strokeRect(x, y, w, h);
        // åå­—ç°è‰²è¼”åŠ©ç·š (0.5px)
        ctx.strokeStyle = "#9ca3af";
        ctx.lineWidth = 0.5;
        ctx.beginPath();
        ctx.moveTo(x + w / 2, y); ctx.lineTo(x + w / 2, y + h);
        ctx.moveTo(x, y + h / 2); ctx.lineTo(x + w, y + h / 2);
        ctx.stroke();
    };

    // ğŸª ibon A4 å°ˆç”¨ä¸‹è¼‰å‡½å¼ (æ–°å¢)
    async function downloadA4IbonMixed(){
        if(slots.length===0){alert("æ§½ä½ç‚ºç©º");return}
        const A4_W=2480, A4_H=3508;
        const SAFE=100; // ibon å®‰å…¨ç•™ç™½ 10mm
        const GAP=40;
        const SIZE_2={w:413,h:531};
        const SIZE_1={w:295,h:413};

        const pc=document.createElement("canvas");
        pc.width=A4_W; pc.height=A4_H;
        const ctx=pc.getContext("2d");
        ctx.fillStyle="#ffffff";
        ctx.fillRect(0,0,A4_W,A4_H);

        // å®‰å…¨æ¡†ç¹ªè£½ (æ·¡ç°è‰²æç¤º)
        ctx.strokeStyle="#e5e7eb";
        ctx.lineWidth=2;
        ctx.strokeRect(SAFE,SAFE,A4_W-SAFE*2,A4_H-SAFE*2);

        const imgs=await Promise.all(slots.map(src=>new Promise(r=>{
            const i=new Image(); i.onload=()=>r(i); i.src=src;
        })));

        let idx=0;
        let y=SAFE+GAP;

        // ===== 2 å‹å€å„ªå…ˆ =====
        const cols2=Math.floor((A4_W-SAFE*2)/(SIZE_2.w+GAP));
        const rows2=Math.floor((A4_H*0.55)/(SIZE_2.h+GAP));

        for(let r=0;r<rows2;r++){
            let x=SAFE+GAP;
            for(let c=0;c<cols2;c++){
                drawIbonCell(ctx,imgs[idx%imgs.length],x,y,SIZE_2.w,SIZE_2.h);
                idx++; x+=SIZE_2.w+GAP;
            }
            y+=SIZE_2.h+GAP;
        }

        // åˆ†éš”ç·š
        ctx.setLineDash([8,8]);
        ctx.strokeStyle="#9ca3af";
        ctx.beginPath();
        ctx.moveTo(SAFE,y-20); ctx.lineTo(A4_W-SAFE,y-20);
        ctx.stroke();
        ctx.setLineDash([]);

        // ===== 1 å‹å€è£œæ»¿ =====
        const cols1=Math.floor((A4_W-SAFE*2)/(SIZE_1.w+GAP));
        const rows1=Math.floor((A4_H-y-SAFE)/(SIZE_1.h+GAP));

        for(let r=0;r<rows1;r++){
            let x=SAFE+GAP;
            for(let c=0;c<cols1;c++){
                drawIbonCell(ctx,imgs[idx%imgs.length],x,y,SIZE_1.w,SIZE_1.h);
                idx++; x+=SIZE_1.w+GAP;
            }
            y+=SIZE_1.h+GAP;
        }

        const a=document.createElement("a");
        a.href=pc.toDataURL("image/png");
        a.download="EzID_ibON_A4_1+2inch.png";
        a.click();
    }

    // èˆŠæœ‰çš„ä¸‹è¼‰å‡½å¼ (ç¶­æŒä¸è®Š)
    const downloadSheet = async (type) => {
        if(!slots.length) return alert("æ§½ä½ç‚ºç©º");
        const pc = document.createElement("canvas");
        pc.width=1800; pc.height=1200;
        const ctx = pc.getContext("2d");
        ctx.fillStyle="white"; ctx.fillRect(0,0,1800,1200);
        const imgs = await Promise.all(slots.map(s => new Promise(r => { const i=new Image(); i.onload=()=>r(i); i.src=s; })));
        for(let i=0; i<4; i++) ctx.drawImage(imgs[i%imgs.length], 80+i*428, 80, 413, 531);
        for(let i=0; i<5; i++) ctx.drawImage(imgs[i%imgs.length], 80+i*341, 650, 331, 449);
        const a = document.createElement("a");
        a.href=pc.toDataURL("image/png");
        a.download=`EzID_4x6_${new Date().getTime()}.png`;
        a.click();
    };

    return (
        <div className="max-w-md mx-auto p-4">
            <header className="flex justify-between items-center mb-4 px-2">
                <h1 className="font-black text-slate-800 italic">EzID Taiwan <span className="text-[10px] text-blue-500 not-italic">v2.7.1</span></h1>
                <div className="text-[9px] font-bold text-slate-400 uppercase">ibon A4 å°ˆç”¨ä½ˆå±€</div>
            </header>

            <div className="canvas-container mb-6">
                <canvas ref={canvasRef} width="350" height="450" />
                <div className="center-line"></div>
                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div className="inner-guide" style={{width:'71%', height:'71%'}}></div>
                    <div className="outer-guide" style={{width:'80%', height:'80%'}}></div>
                </div>
            </div>

            <section className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                <div className="mb-4 text-[10px] font-bold text-slate-400 uppercase">ğŸ‘” æ•¸ä½æ›è£</div>
                <div className="flex flex-col gap-2 mb-4 overflow-hidden">
                    <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                        <button onClick={()=>{setSuitImg(null);setActiveSuit(null)}} className="suit-btn text-red-500 font-bold">âœ•</button>
                        {CLOTHES.male.map(s => <button key={s} onClick={()=>{const img=new Image();img.onload=()=>setSuitImg(img);img.src=s;setActiveSuit(s)}} className={`suit-btn ${activeSuit===s?'active':''}`}><img src={s} className="w-4/5"/></button>)}
                    </div>
                    <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                        <button onClick={()=>{setSuitImg(null);setActiveSuit(null)}} className="suit-btn text-red-500 font-bold">âœ•</button>
                        {CLOTHES.female.map(s => <button key={s} onClick={()=>{const img=new Image();img.onload=()=>setSuitImg(img);img.src=s;setActiveSuit(s)}} className={`suit-btn ${activeSuit===s?'active':''}`}><img src={s} className="w-4/5"/></button>)}
                    </div>
                </div>

                <div className="space-y-3 pt-2">
                    <div className="flex justify-between text-[10px] font-bold text-slate-400 mb-1 uppercase">ç…§ç‰‡ç¸®æ”¾ <span>{Math.round(p.s*100)}%</span></div>
                    <input type="range" min="0.3" max="1.5" step="0.01" value={p.s} onChange={e=>setP({...p, s:+e.target.value})} />
                    <div className="grid grid-cols-2 gap-4">
                        <input type="range" min="-150" max="150" value={p.y} onChange={e=>setP({...p, y:+e.target.value})} />
                        <input type="range" min="-100" max="100" value={p.x} onChange={e=>setP({...p, x:+e.target.value})} />
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-3 mt-6">
                    <label className="bg-slate-800 text-white py-3 rounded-xl text-center font-bold text-xs cursor-pointer shadow-sm">ğŸ“¸ ä¸Šå‚³ç…§ç‰‡<input type="file" hidden accept="image/*" onChange={e=>{const f=e.target.files[0]; if(f){const img=new Image(); img.onload=()=>setImage(img); img.src=URL.createObjectURL(f);}}}/></label>
                    <button onClick={saveToSlot} className="bg-blue-600 text-white py-3 rounded-xl font-bold text-xs shadow-sm">ğŸ“¥ å­˜å…¥æ§½ä½</button>
                </div>
            </section>

            <div className="mt-6 px-1">
                <div className="flex justify-between text-[10px] font-bold text-slate-400 mb-2 uppercase">æ’ç‰ˆæ§½ä½ ({slots.length}/8) <button onClick={()=>setSlots([])} className="text-red-400">æ¸…ç©º</button></div>
                <div className="flex gap-2 overflow-x-auto no-scrollbar">
                    {slots.map((s,i)=><img key={i} src={s} className="w-16 h-20 rounded-lg border-2 border-white shadow-sm flex-shrink-0" onClick={()=>setSlots(slots.filter((_,idx)=>idx!==i))}/>)}
                </div>
            </div>

            <div className="mt-6 flex flex-col gap-2">
                <button onClick={downloadA4IbonMixed} className="w-full bg-emerald-700 text-white py-4 rounded-2xl font-black text-sm active:scale-[0.98] transition-transform shadow-lg shadow-emerald-100">
                    ğŸª ibon A4ï½œ1 å‹ + 2 å‹ æ··æ’ï¼ˆå®‰å…¨é‚Šç•Œï¼‰
                </button>
                <div className="grid grid-cols-2 gap-2">
                    <button onClick={()=>downloadSheet('4x6')} className="bg-slate-900 text-white py-3 rounded-xl font-bold text-xs opacity-80">4x6 å‹æ²–å°</button>
                    <button onClick={()=>downloadSheet('A4')} className="bg-slate-200 text-slate-600 py-3 rounded-xl font-bold text-xs">ä¸€èˆ¬ A4 æ··æ’</button>
                </div>
            </div>
        </div>
    );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
