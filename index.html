<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzID Pro - ibon 4x6 å°ˆç”¨æ’ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.5.3/dist/bundle.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .control-panel { max-height: 85vh; overflow-y: auto; }
        canvas { background-color: white; border: 1px solid #e2e8f0; border-radius: 12px; }
        /* æ©¢åœ“å°é ­æ¡† */
        .guide-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -55%);
            width: 190px; height: 250px;
            border: 3px dashed rgba(255, 0, 0, 0.4);
            border-radius: 50% / 50%;
            pointer-events: none;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // 4x6 å‹ (102x152mm) @ 300dpi = 1200x1800 åƒç´ 
        const SPECS = {
            TWO_INCH: { id: 'TWO_INCH', label: '2å‹(8å¼µ)', w: 413, h: 531, cols: 2, rows: 4 },
            ONE_INCH: { id: 'ONE_INCH', label: '1å‹(10å¼µ)', w: 331, h: 449, cols: 2, rows: 5 },
            MIXED: { id: 'MIXED', label: 'æ··åˆ(ibonå°ˆç”¨)', isMixed: true }
        };

        const EzIDApp = () => {
            const [image, setImage] = useState(null);
            const [bgRemoved, setBgRemoved] = useState(null);
            const [isRemoving, setIsRemoving] = useState(false);
            const [isCameraActive, setIsCameraActive] = useState(false);
            const [currentSpec, setCurrentSpec] = useState(SPECS.TWO_INCH);
            
            const [p, setP] = useState({ x: 0, y: 0, s: 0.55 });
            const [suit, setSuit] = useState({ id: null, x: 175, y: 350, s: 0.7 });
            
            const canvasRef = useRef(null);
            const videoRef = useRef(null);
            const suitImg = useRef(new Image());

            // é è¦½ç¹ªåœ–
            useEffect(() => {
                const draw = () => {
                    const canvas = canvasRef.current;
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, 350, 450);
                    ctx.fillStyle = "#FFFFFF";
                    ctx.fillRect(0, 0, 350, 450);

                    const activeImg = bgRemoved || image;
                    if (activeImg) {
                        ctx.save();
                        ctx.translate(175 + parseInt(p.x), 225 + parseInt(p.y));
                        ctx.scale(p.s, p.s);
                        ctx.drawImage(activeImg, -activeImg.width/2, -activeImg.height/2);
                        ctx.restore();
                    }

                    if (suit.id) {
                        suitImg.current.src = `./suit-${suit.id}.png`;
                        if (suitImg.current.complete) {
                            ctx.save();
                            ctx.translate(parseInt(suit.x), parseInt(suit.y));
                            ctx.scale(suit.s * 2.2, suit.s * 2.2);
                            ctx.drawImage(suitImg.current, -suitImg.current.width/2, -suitImg.current.height/2);
                            ctx.restore();
                        } else { suitImg.current.onload = draw; }
                    }
                };
                draw();
            }, [image, bgRemoved, p, suit]);

            // å»èƒŒåŠŸèƒ½ (ä¿®æ­£ Undefined éŒ¯èª¤)
            const runRemoveBg = async () => {
                if (!image) return;
                setIsRemoving(true);
                try {
                    const imgly = window.imglyBackgroundRemoval;
                    const blob = await imgly.removeBackground(image.src);
                    const img = new Image();
                    img.onload = () => { setBgRemoved(img); setIsRemoving(false); };
                    img.src = URL.createObjectURL(blob);
                } catch (e) {
                    alert("å»èƒŒå¤±æ•—ï¼Œè«‹ç¢ºä¿ä½¿ç”¨ Live Server");
                    setIsRemoving(false);
                }
            };

            // ibon 4x6 æ’ç‰ˆä¸‹è¼‰
            const downloadIbon4x6 = () => {
                const printCanvas = document.createElement('canvas');
                const ctx = printCanvas.getContext('2d');
                
                // 4x6 å‹æ¨™æº– (1200 x 1800 åƒç´ )
                printCanvas.width = 1200; 
                printCanvas.height = 1800;
                ctx.fillStyle = "white";
                ctx.fillRect(0, 0, 1200, 1800);

                const singlePhoto = canvasRef.current;
                
                if (currentSpec.isMixed) {
                    // æ··åˆæ’ç‰ˆ: 4å¼µ2å‹ + 4å¼µ1å‹
                    for(let i=0; i<4; i++) ctx.drawImage(singlePhoto, 0,0,350,450, 150 + (i%2)*450, 100 + Math.floor(i/2)*580, 413, 531);
                    for(let i=0; i<4; i++) ctx.drawImage(singlePhoto, 0,0,350,450, 200 + (i%2)*400, 1300 + Math.floor(i/2)*200, 331, 449);
                } else {
                    const { w, h, cols, rows } = currentSpec;
                    const startX = (1200 - (w * cols + 50 * (cols-1))) / 2;
                    const startY = (1800 - (h * rows + 40 * (rows-1))) / 2;
                    for (let r = 0; r < rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            ctx.drawImage(singlePhoto, 0, 0, 350, 450, startX + c*(w+50), startY + r*(h+40), w, h);
                        }
                    }
                }

                const link = document.createElement('a');
                link.download = `EzID_ibon_4x6.png`;
                link.href = printCanvas.toDataURL('image/png', 1.0);
                link.click();
            };

            return (
                <div className="flex flex-col lg:flex-row h-screen overflow-hidden p-4 gap-4">
                    {/* å·¦å´é è¦½ */}
                    <div className="w-full lg:w-[400px] flex flex-col gap-4 bg-white p-4 rounded-3xl shadow-xl shrink-0">
                        <h1 className="font-black text-blue-800 text-xl italic px-2">EzID Taiwan</h1>
                        <div className="relative">
                            <canvas ref={canvasRef} width={350} height={450} className="w-full h-auto mx-auto" />
                            {image && !isCameraActive && <div className="guide-overlay"></div>}
                            {isRemoving && <div className="absolute inset-0 bg-white/60 flex items-center justify-center font-bold text-blue-600 animate-pulse">AI å»èƒŒä¸­...</div>}
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                            <button onClick={runRemoveBg} className="bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700">ä¸€éµå»èƒŒ</button>
                            <button onClick={downloadIbon4x6} className="bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700">ä¸‹è¼‰ 4x6 æ’ç‰ˆ</button>
                        </div>
                    </div>

                    {/* å³å´æ§åˆ¶å€ */}
                    <div className="flex-1 bg-white p-6 rounded-3xl shadow-xl control-panel border border-slate-300">
                        {!image && !isCameraActive ? (
                            <div className="h-full flex flex-col items-center justify-center border-4 border-dashed border-slate-100 rounded-3xl gap-4">
                                <button onClick={() => setIsCameraActive(true)} className="bg-blue-600 text-white px-8 py-4 rounded-xl font-bold">é–‹å•Ÿç›¸æ©Ÿæ‹ç…§</button>
                                <input type="file" onChange={(e) => {
                                    const reader = new FileReader();
                                    reader.onload = (f) => { const img = new Image(); img.onload = () => setImage(img); img.src = f.target.result; };
                                    reader.readAsDataURL(e.target.files[0]);
                                }} />
                            </div>
                        ) : isCameraActive ? (
                            <div className="relative h-64 bg-black rounded-2xl overflow-hidden mb-4">
                                <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover" />
                                <div className="guide-overlay"></div>
                                <button onClick={() => {
                                    const tempCanvas = document.createElement('canvas');
                                    tempCanvas.width = videoRef.current.videoWidth; tempCanvas.height = videoRef.current.videoHeight;
                                    tempCanvas.getContext('2d').drawImage(videoRef.current, 0, 0);
                                    const img = new Image(); img.onload = () => { setImage(img); setIsCameraActive(false); };
                                    img.src = tempCanvas.toDataURL();
                                }} className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-red-600 w-12 h-12 rounded-full border-2 border-white shadow-lg"></button>
                            </div>
                        ) : (
                            <div className="space-y-6 pb-10">
                                <div className="flex justify-between items-center">
                                    <span className="text-sm font-bold text-slate-500 italic uppercase">4x6 ibon Layout</span>
                                    <div className="flex gap-2">
                                        {Object.values(SPECS).map(s => (
                                            <button key={s.id} onClick={() => setCurrentSpec(s)} className={`px-4 py-2 text-xs rounded-full border ${currentSpec.id === s.id ? 'bg-slate-800 text-white' : 'text-slate-400 font-bold'}`}>{s.label}</button>
                                        ))}
                                    </div>
                                </div>
                                
                                <section className="p-4 bg-slate-50 rounded-2xl space-y-4">
                                    <p className="text-xs font-bold text-indigo-500 uppercase font-mono">ğŸ‘¤ äººåƒä½ç§»</p>
                                    <input type="range" min="0.1" max="1.5" step="0.01" value={p.s} onChange={e => setP({...p, s: e.target.value})} />
                                    <div className="grid grid-cols-2 gap-2">
                                        <input type="range" min="-200" max="200" value={p.x} onChange={e => setP({...p, x: e.target.value})} />
                                        <input type="range" min="-200" max="200" value={p.y} onChange={e => setP({...p, y: e.target.value})} />
                                    </div>
                                </section>

                                <section className="p-4 bg-blue-50 rounded-2xl border border-blue-100 space-y-4">
                                    <p className="text-xs font-bold text-blue-500 uppercase font-mono">ğŸ‘” è¡£æœä½ç§»</p>
                                    <input type="range" min="0.1" max="1.5" step="0.01" value={suit.s} onChange={e => setSuit({...suit, s: e.target.value})} />
                                    <div className="grid grid-cols-2 gap-2">
                                        <input type="range" min="0" max="350" value={suit.x} onChange={e => setSuit({...suit, x: e.target.value})} />
                                        <input type="range" min="0" max="800" value={suit.y} onChange={e => setSuit({...suit, y: e.target.value})} />
                                    </div>
                                    <div className="flex gap-2 py-2 overflow-x-auto">
                                        {[1,2,3,4,5].map(i => <img key={i} src={`./suit-m${i}.png`} onClick={()=>setSuit({...suit, id:`m${i}`})} className="w-10 h-10 border bg-white cursor-pointer hover:border-blue-500 rounded" onError={(e)=>e.target.style.display='none'} />)}
                                    </div>
                                </section>
                                <button onClick={() => {setImage(null); setBgRemoved(null);}} className="w-full bg-slate-200 py-3 rounded-xl font-bold text-slate-600">é‡æ‹æˆ–ä¸Šå‚³ç…§ç‰‡</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
    </script>
</body>
</html>
