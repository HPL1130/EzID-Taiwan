<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzID Taiwan Pro - Final Fix</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@imgly/background-removal@1.5.3/dist/bundle.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input[type="range"] { height: 6px; -webkit-appearance: none; background: #e2e8f0; border-radius: 5px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #4f46e5; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo } = React;

        const SPECS = {
            TWO_INCH: { id: 'TWO_INCH', label: '2å‹(8å¼µ)', mmW: 35, mmH: 45, max: 8, cols: 4, rows: 2 },
            ONE_INCH: { id: 'ONE_INCH', label: '1å‹(10å¼µ)', mmW: 28, mmH: 35, max: 10, cols: 5, rows: 2 },
            MIXED: { id: 'MIXED', label: 'æ··åˆ(2å‹*4 + 1å‹*5)', isMixed: true, max: 9 }
        };

        const EzIDApp = () => {
            const [image, setImage] = useState(null);
            const [bgRemoved, setBgRemoved] = useState(null);
            const [isRemoving, setIsRemoving] = useState(false);
            const [currentSpec, setCurrentSpec] = useState(SPECS.TWO_INCH);
            const [photoList, setPhotoList] = useState([]);
            
            // Slider ç‹€æ…‹
            const [pX, setPX] = useState(0);
            const [pY, setPY] = useState(0);
            const [pS, setPS] = useState(0.5);
            const [suitId, setSuitId] = useState(null);
            const [sX, setSX] = useState(175);
            const [sY, setSY] = useState(250);
            const [sS, setSS] = useState(0.6);

            const canvasRef = useRef(null);
            const suitImgRef = useRef(new Image()); // é è¼‰å…¥è¡£æœåœ–ç‰‡ç”¨

            // ã€è¡£æœå‹•èµ·ä¾†çš„é—œéµã€‘ç•¶ suitId æ”¹è®Šæ™‚ï¼Œå…ˆé è¼‰å…¥åœ–ç‰‡
            useEffect(() => {
                if (suitId) {
                    suitImgRef.current.src = `./suit-${suitId}.png`;
                    suitImgRef.current.onload = () => draw(); // è¼‰å…¥å®Œç•«ä¸€æ¬¡
                } else {
                    draw();
                }
            }, [suitId]);

            // ç¹ªåœ–å‡½æ•¸
            const draw = () => {
                const canvas = canvasRef.current;
                if (!canvas || (!image && !bgRemoved)) return;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(0, 0, 350, 450);

                const activeImg = bgRemoved || image;
                if (activeImg) {
                    ctx.save();
                    ctx.translate(175 + parseInt(pX), 225 + parseInt(pY));
                    ctx.scale(pS, pS);
                    ctx.drawImage(activeImg, -activeImg.width/2, -activeImg.height/2);
                    ctx.restore();
                }

                if (suitId && suitImgRef.current.complete) {
                    ctx.save();
                    ctx.translate(parseInt(sX), parseInt(sY));
                    ctx.scale(sS * 2.2, sS * 2.2);
                    ctx.drawImage(suitImgRef.current, -suitImgRef.current.width/2, -suitImgRef.current.height/2);
                    ctx.restore();
                }
            };

            // æ¯ç•¶ Slider è®Šå‹•å°±é‡ç•«
            useEffect(() => { draw(); }, [pX, pY, pS, sX, sY, sS, image, bgRemoved]);

            const runRemoveBg = async () => {
                if (!image) return;
                setIsRemoving(true);
                try {
                    const lib = window.imglyBackgroundRemoval;
                    const blob = await lib.removeBackground(image.src, {
                        publicPath: "https://unpkg.com/@imgly/background-removal-data@1.5.3/dist/"
                    });
                    const img = new Image();
                    img.onload = () => { setBgRemoved(img); setIsRemoving(false); };
                    img.src = URL.createObjectURL(blob);
                } catch (e) {
                    alert("å»èƒŒæ¨¡çµ„è¼‰å…¥è¶…æ™‚ã€‚è«‹ç¢ºèª coi-serviceworker.js æª”æ¡ˆå­˜åœ¨ä¸”å·²ä¸Šå‚³ã€‚");
                    setIsRemoving(false);
                }
            };

            return (
                <div className="max-w-6xl mx-auto p-4 md:p-10 flex flex-col lg:flex-row gap-8">
                    {/* å·¦å´ï¼šé è¦½èˆ‡æ‹¼æ¿ */}
                    <div className="lg:w-[380px] space-y-4">
                        <div className="bg-white p-4 rounded-[2rem] shadow-xl border-4 border-white">
                            <canvas ref={canvasRef} width={350} height={450} className="w-full rounded-2xl shadow-inner" />
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <button onClick={runRemoveBg} className="bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition text-sm">
                                {isRemoving ? "è™•ç†ä¸­..." : "âœ¨ ä¸€éµå»èƒŒ"}
                            </button>
                            <button onClick={() => setPhotoList([...photoList, canvasRef.current.toDataURL()])} className="bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition text-sm">
                                âœ… åŠ å…¥æ’ç‰ˆ
                            </button>
                        </div>
                        <div className="bg-white p-4 rounded-2xl min-h-[100px] flex gap-2 overflow-x-auto shadow-inner border border-slate-100">
                            {photoList.map((p, i) => (
                                <div key={i} className="relative flex-shrink-0">
                                    <img src={p} className="h-20 border rounded shadow-sm bg-white" />
                                    <button onClick={() => setPhotoList(photoList.filter((_, idx) => idx !== i))} className="absolute -top-2 -right-2 bg-red-500 text-white w-5 h-5 rounded-full text-[10px]">âœ•</button>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* å³å´ï¼šæ‹‰æ¡¿æ§åˆ¶å€ */}
                    <div className="flex-1 bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 space-y-8">
                        <div className="flex justify-between items-center border-b pb-4">
                            <h2 className="text-xl font-black text-slate-800">æ§åˆ¶é¢æ¿</h2>
                            <div className="flex gap-2">
                                {Object.values(SPECS).map(s => (
                                    <button key={s.id} onClick={() => setCurrentSpec(s)} className={`px-3 py-1 rounded-full text-[10px] font-bold border transition ${currentSpec.id === s.id ? 'bg-slate-800 text-white' : 'text-slate-400'}`}>{s.label}</button>
                                ))}
                            </div>
                        </div>

                        {!image ? (
                            <div className="py-20 text-center border-4 border-dashed border-slate-50 rounded-[2rem]">
                                <input type="file" onChange={(e) => {
                                    const file = e.target.files[0];
                                    const reader = new FileReader();
                                    reader.onload = (f) => {
                                        const img = new Image();
                                        img.onload = () => setImage(img);
                                        img.src = f.target.result;
                                    };
                                    reader.readAsDataURL(file);
                                }} id="fileIn" className="hidden" />
                                <label htmlFor="fileIn" className="cursor-pointer">
                                    <div className="text-5xl mb-4">ğŸ“¸</div>
                                    <p className="font-bold text-slate-400">è«‹å…ˆé»æ“Šä¸Šå‚³åŸå§‹å¤§é ­ç…§</p>
                                </label>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                {/* äººåƒæ§åˆ¶ */}
                                <section>
                                    <h3 className="text-xs font-black text-indigo-500 mb-4 tracking-widest uppercase">ğŸ‘¤ äººåƒä½ç§»èˆ‡ç¸®æ”¾</h3>
                                    <div className="space-y-4">
                                        <div><label className="text-[10px] text-slate-400 font-bold">å¤§å°: {pS}</label><input type="range" min="0.1" max="1.5" step="0.01" value={pS} onChange={e => setPS(e.target.value)} className="w-full" /></div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="text-[10px] text-slate-400 font-bold">æ°´å¹³: {pX}</label><input type="range" min="-200" max="200" value={pX} onChange={e => setPX(e.target.value)} className="w-full" /></div>
                                            <div><label className="text-[10px] text-slate-400 font-bold">å‚ç›´: {pY}</label><input type="range" min="-200" max="200" value={pY} onChange={e => setPY(e.target.value)} className="w-full" /></div>
                                        </div>
                                    </div>
                                </section>

                                {/* è¡£æœæ§åˆ¶ */}
                                <section>
                                    <h3 className="text-xs font-black text-blue-500 mb-4 tracking-widest uppercase">ğŸ‘” è¡£æœä½ç½®èª¿æ•´</h3>
                                    <div className="space-y-4">
                                        <div><label className="text-[10px] text-slate-400 font-bold">è¡£æœå¤§å°: {sS}</label><input type="range" min="0.1" max="1.5" step="0.01" value={sS} onChange={e => setSS(e.target.value)} className="w-full" /></div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="text-[10px] text-slate-400 font-bold">è¡£æœæ°´å¹³: {sX}</label><input type="range" min="0" max="350" value={sX} onChange={e => setSX(e.target.value)} className="w-full" /></div>
                                            <div><label className="text-[10px] text-slate-400 font-bold">è¡£æœå‚ç›´: {sY}</label><input type="range" min="0" max="450" value={sY} onChange={e => setSY(e.target.value)} className="w-full" /></div>
                                        </div>
                                        <div className="flex gap-2 overflow-x-auto py-2">
                                            <button onClick={() => setSuitId(null)} className="w-14 h-14 border-2 border-dashed rounded-xl flex-shrink-0 text-[10px] text-gray-300">ç„¡è¡£æœ</button>
                                            {[1,2,3,4,5].map(i => (
                                                <img key={i} src={`./suit-m${i}.png`} onClick={() => setSuitId(`m${i}`)} className={`w-14 h-14 border-2 rounded-xl p-1 bg-slate-50 cursor-pointer ${suitId === `m${i}` ? 'border-indigo-600 ring-2 ring-indigo-50' : 'border-transparent'}`} />
                                            ))}
                                        </div>
                                    </div>
                                </section>

                                <button onClick={() => {setImage(null); setBgRemoved(null); setPhotoList([]);}} className="w-full text-slate-300 text-[10px] hover:underline uppercase font-bold tracking-widest">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
    </script>
</body>
</html>
