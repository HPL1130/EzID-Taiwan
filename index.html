<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzID Taiwan - ibon 4x6 ä¿®æ­£ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .control-panel { max-height: 85vh; overflow-y: auto; }
        canvas { background-color: white; border: 1px solid #e2e8f0; border-radius: 8px; }
        .guide-overlay {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -55%);
            width: 190px; height: 250px;
            border: 3px dashed rgba(255, 0, 0, 0.4);
            border-radius: 50% / 50%;
            pointer-events: none; z-index: 10;
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // 4x6 å‹æ©«å¼ç•«å¸ƒ (1800x1200 px)
        const SPECS = {
            TWO_INCH: { id: 'TWO_INCH', label: '2å‹(8å¼µ)', w: 413, h: 531, cols: 4, rows: 2 },
            ONE_INCH: { id: 'ONE_INCH', label: '1å‹(10å¼µ)', w: 331, h: 449, cols: 5, rows: 2 },
            MIXED: { id: 'MIXED', label: 'æ··åˆ(4å¤§5å°)', isMixed: true }
        };

        const EzIDApp = () => {
            const [image, setImage] = useState(null);
            const [currentSpec, setCurrentSpec] = useState(SPECS.TWO_INCH);
            const [p, setP] = useState({ x: 0, y: 0, s: 0.6 });
            const [suit, setSuit] = useState({ id: null, x: 175, y: 340, s: 0.7 });
            
            const canvasRef = useRef(null);
            const suitImg = useRef(new Image());

            // å¯¦æ™‚ç¹ªè£½å–®å¼µé è¦½
            useEffect(() => {
                const draw = () => {
                    const canvas = canvasRef.current;
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, 350, 450);
                    ctx.fillStyle = "#FFFFFF";
                    ctx.fillRect(0, 0, 350, 450);

                    if (image) {
                        ctx.save();
                        ctx.translate(175 + parseInt(p.x), 225 + parseInt(p.y));
                        ctx.scale(p.s, p.s);
                        ctx.drawImage(image, -image.width/2, -image.height/2);
                        ctx.restore();
                    }

                    if (suit.id) {
                        suitImg.current.src = `./suit-${suit.id}.png`; 
                        if (suitImg.current.complete) {
                            ctx.save();
                            ctx.translate(parseInt(suit.x), parseInt(suit.y));
                            ctx.scale(suit.s * 2.2, suit.s * 2.2);
                            ctx.drawImage(suitImg.current, -suitImg.current.width/2, -suitImg.current.height/2);
                            ctx.restore();
                        } else {
                            suitImg.current.onload = draw;
                        }
                    }
                };
                draw();
            }, [image, p, suit]);

            // ä¸‹è¼‰ ibon 4x6 æ©«å¼æ’ç‰ˆ
            const downloadIbon = () => {
                const pc = document.createElement('canvas');
                const ctx = pc.getContext('2d');
                pc.width = 1800; pc.height = 1200;
                ctx.fillStyle = "white";
                ctx.fillRect(0, 0, 1800, 1200);

                const single = canvasRef.current;
                
                if (currentSpec.isMixed) {
                    // æ··åˆæ’ç‰ˆ: 4å¼µ2å‹ (413x531) + 5å¼µ1å‹ (331x449)
                    // ç¬¬ä¸€æ’ï¼š4å¼µ2å‹
                    for(let i=0; i<4; i++) {
                        const x = 80 + i * 425;
                        const y = 80;
                        ctx.drawImage(single, 0, 0, 350, 450, x, y, 413, 531);
                        ctx.strokeStyle = "#eee"; ctx.strokeRect(x, y, 413, 531);
                    }
                    // ç¬¬äºŒæ’ï¼š5å¼µ1å‹
                    for(let i=0; i<5; i++) {
                        const x = 80 + i * 340;
                        const y = 660;
                        ctx.drawImage(single, 0, 0, 350, 450, x, y, 331, 449);
                        ctx.strokeStyle = "#eee"; ctx.strokeRect(x, y, 331, 449);
                    }
                } else {
                    const { w, h, cols, rows } = currentSpec;
                    const gapX = 30, gapY = 50;
                    const startX = (1800 - (cols * w + (cols - 1) * gapX)) / 2;
                    const startY = (1200 - (rows * h + (rows - 1) * gapY)) / 2;
                    for (let r = 0; r < rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            const x = startX + c * (w + gapX);
                            const y = startY + r * (h + gapY);
                            ctx.drawImage(single, 0, 0, 350, 450, x, y, w, h);
                            ctx.strokeStyle = "#eee"; ctx.strokeRect(x, y, w, h);
                        }
                    }
                }
                const link = document.createElement('a');
                link.download = `EzID_ibon_4x6.png`;
                link.href = pc.toDataURL('image/png');
                link.click();
            };

            return (
                <div className="flex flex-col lg:flex-row h-screen p-4 gap-4 overflow-hidden">
                    {/* å·¦å´ï¼šé è¦½èˆ‡ä¸‹è¼‰ */}
                    <div className="w-full lg:w-[380px] flex flex-col gap-4 bg-white p-4 rounded-3xl shadow-lg shrink-0">
                        <div className="relative">
                            <canvas ref={canvasRef} width={350} height={450} className="w-full h-auto mx-auto" />
                            {image && <div className="guide-overlay"></div>}
                        </div>
                        <button onClick={downloadIbon} className="bg-blue-700 text-white py-4 rounded-2xl font-black text-lg shadow-lg hover:bg-blue-800 transition">ä¸‹è¼‰ 4x6 æ©«å¼æ’ç‰ˆåœ–</button>
                    </div>

                    {/* å³å´ï¼šæ§åˆ¶é¢æ¿ */}
                    <div className="flex-1 bg-white p-6 rounded-3xl shadow-lg control-panel border border-slate-200">
                        <div className="space-y-6">
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-2">æ’ç‰ˆè¦æ ¼</label>
                                <div className="flex gap-2">
                                    {Object.values(SPECS).map(s => (
                                        <button key={s.id} onClick={() => setCurrentSpec(s)} className={`px-4 py-2 rounded-xl border font-bold text-sm transition ${currentSpec.id === s.id ? 'bg-slate-800 text-white border-slate-800' : 'text-slate-500 bg-white'}`}>{s.label}</button>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-2">ä¸Šå‚³ç…§ç‰‡</label>
                                <input type="file" onChange={(e) => {
                                    const reader = new FileReader();
                                    reader.onload = (f) => { const img = new Image(); img.onload = () => setImage(img); img.src = f.target.result; };
                                    reader.readAsDataURL(e.target.files[0]);
                                }} className="text-sm" />
                            </div>

                            <div className="p-4 bg-slate-50 rounded-2xl space-y-4">
                                <p className="text-xs font-bold text-slate-500 uppercase italic">ğŸ‘¤ äººåƒä½ç½®èª¿æ•´</p>
                                <input type="range" min="0.1" max="1.5" step="0.01" value={p.s} onChange={e => setP({...p, s: e.target.value})} />
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="flex flex-col gap-1"><span className="text-[10px] text-slate-400">å·¦å³</span><input type="range" min="-200" max="200" value={p.x} onChange={e => setP({...p, x: e.target.value})} /></div>
                                    <div className="flex flex-col gap-1"><span className="text-[10px] text-slate-400">ä¸Šä¸‹</span><input type="range" min="-200" max="200" value={p.y} onChange={e => setP({...p, y: e.target.value})} /></div>
                                </div>
                            </div>

                            <div className="p-4 bg-indigo-50 rounded-2xl space-y-4 border border-indigo-100">
                                <p className="text-xs font-bold text-indigo-500 uppercase italic">ğŸ‘” è¡£æœé¸æ“‡èˆ‡ä½ç½®</p>
                                <div className="flex gap-2 overflow-x-auto pb-2">
                                    {['m1','m2','m3','m4','m5'].map(id => (
                                        <img key={id} src={`./suit-${id}.png`} onClick={() => setSuit({...suit, id})} className={`w-14 h-14 border-2 rounded-lg bg-white cursor-pointer transition ${suit.id === id ? 'border-indigo-600 scale-105 shadow-md' : 'border-white'}`} 
                                        onError={(e) => { e.target.style.display='none'; }} />
                                    ))}
                                    <button onClick={() => setSuit({...suit, id: null})} className="px-3 border-2 border-dashed rounded-lg text-[10px] text-slate-400">æ¸…é™¤è¡£æœ</button>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="flex flex-col gap-1"><span className="text-[10px] text-indigo-400">è¡£æœç¸®æ”¾</span><input type="range" min="0.3" max="1.5" step="0.01" value={suit.s} onChange={e => setSuit({...suit, s: e.target.value})} /></div>
                                    <div className="flex flex-col gap-1"><span className="text-[10px] text-indigo-400">è¡£æœä¸Šä¸‹</span><input type="range" min="100" max="500" value={suit.y} onChange={e => setSuit({...suit, y: e.target.value})} /></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
    </script>
</body>
</html>
