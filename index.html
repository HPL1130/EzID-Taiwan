<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.17 çµ‚æ¥µè·¯å¾‘ä¿®æ­£ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face { font-family: 'NotoSansTC'; src: local('Noto Sans TC'), local('Microsoft JhengHei'), sans-serif; font-weight: 700; }
        body { font-family: 'NotoSansTC', sans-serif; background: #f0f2f5; }
        .canvas-main { border-radius: 40px; background: white; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.4); touch-action: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback, useTransition } = React;

const SPECS = {
    'A4-20': { w: 2480, h: 3508, photos: 20, grid: [5, 4], size: [413, 531], name: 'A4 - 2å‹ (20å¼µ)' },
    'A4-42': { w: 2480, h: 3508, photos: 42, grid: [7, 6], size: [295, 413], name: 'A4 - 1å‹ (42å¼µ)' },
    '4x6-8':  { w: 1800, h: 1200, photos: 8,  grid: [2, 4], size: [413, 531], name: '4x6 - 2å‹ (8å¼µ)' },
    '4x6-10': { w: 1800, h: 1200, photos: 10, grid: [2, 5], size: [295, 413], name: '4x6 - 1å‹ (10å¼µ)' }
};

// âœ… æ­£ç¢ºçš„æœ¬åœ°è·¯å¾‘é…ç½®
const CLOTHES_LIST = {
    male: ['m1.png', 'm2.png', 'm3.png', 'm4.png', 'm5.png'],
    female: ['f1.png', 'f2.png', 'f3.png', 'f4.png', 'f5.png']
};

function App() {
    const [isPending, startTransition] = useTransition();
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [gender, setGender] = useState('male'); // è¡£æœæ€§åˆ¥åˆ‡æ›
    const [target, setTarget] = useState('PHOTO'); 
    
    const [pT, setPT] = useState({ x: 0, y: -20, s: 0.45, r: 0 }); 
    const [sT, setST] = useState({ x: 0, y: 80, s: 1.0, r: 0 }); 
    
    const [preview, setPreview] = useState(null);
    const canvasRef = useRef(null);
    const drag = useRef({ active: false, x: 0, y: 0 });

    // âœ… äººç‰©åœˆæ©¢åœ“å°å¼•
    const drawPersonCircle = (ctx) => {
        ctx.save();
        ctx.beginPath();
        ctx.ellipse(175, 210, 110, 150, 0, 0, Math.PI * 2);
        ctx.strokeStyle = "rgba(16, 185, 129, 0.6)"; 
        ctx.lineWidth = 3;
        ctx.setLineDash([10, 5]);
        ctx.stroke();
        ctx.restore();
    };

    const drawContent = (ctx, isExport = false, scale = 1, xOff = 0, yOff = 0, pw = 350, ph = 450) => {
        ctx.save();
        ctx.beginPath(); ctx.rect(xOff, yOff, pw, ph); ctx.clip();
        if (image) {
            ctx.save();
            ctx.translate(xOff + pw/2 + pT.x * scale, yOff + ph/2 + pT.y * scale);
            ctx.rotate(pT.r * Math.PI / 180);
            ctx.scale(pT.s * scale, pT.s * scale);
            ctx.drawImage(image, -image.width/2, -image.height/2);
            ctx.restore();
        }
        if (suitImg) {
            ctx.save();
            ctx.translate(xOff + pw/2 + sT.x * scale, yOff + ph/2 + sT.y * scale);
            ctx.rotate(sT.r * Math.PI / 180);
            ctx.scale(sT.s * scale, sT.s * scale);
            ctx.drawImage(suitImg, -suitImg.width/2, -suitImg.height/2);
            ctx.restore();
        }
        ctx.restore();
        if (!isExport) drawPersonCircle(ctx);
    };

    useEffect(() => {
        const ctx = canvasRef.current?.getContext('2d');
        if (!ctx) return;
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, 350, 450);
        drawContent(ctx);
    }, [image, suitImg, pT, sT, target]);

    const handleMove = (e) => {
        if (!drag.current.active) return;
        const dx = (e.clientX - drag.current.x);
        const dy = (e.clientY - drag.current.y);
        if (target === 'PHOTO') setPT(prev => ({ ...prev, x: prev.x + dx, y: prev.y + dy }));
        else setST(prev => ({ ...prev, x: prev.x + dx, y: prev.y + dy }));
        drag.current.x = e.clientX; drag.current.y = e.clientY;
    };

    const handleExport = (key) => {
        const spec = SPECS[key];
        startTransition(async () => {
            const canvas = document.createElement('canvas');
            canvas.width = spec.w; canvas.height = spec.h;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "white"; ctx.fillRect(0, 0, spec.w, spec.h);
            const [rows, cols] = spec.grid;
            const [pw, ph] = spec.size;
            const mx = (spec.w - cols * pw) / (cols + 1);
            const my = (spec.h - rows * ph) / (rows + 1);
            for (let i = 0; i < spec.photos; i++) {
                const r = Math.floor(i / cols); const c = i % cols;
                drawContent(ctx, true, pw/350, mx + c*(pw+mx), my + r*(ph+my), pw, ph);
                ctx.strokeStyle = "#eee"; ctx.strokeRect(mx + c*(pw+mx), my + r*(ph+my), pw, ph);
            }
            setPreview(canvas.toDataURL('image/jpeg', 0.92));
        });
    };

    return (
        <div className="max-w-md mx-auto p-4 space-y-4">
            <header className="text-center py-4">
                <h1 className="text-3xl font-black text-slate-800">EzID <span className="text-blue-600">v20.17</span></h1>
                <p className="text-xs text-slate-500 font-bold tracking-widest uppercase">Suit Path Fixed</p>
            </header>

            <div className="flex justify-center">
                <canvas ref={canvasRef} width="350" height="450" className="canvas-main"
                    onPointerDown={e => { e.target.setPointerCapture(e.pointerId); drag.current = { active: true, x: e.clientX, y: e.clientY }; }}
                    onPointerMove={handleMove}
                    onPointerUp={() => drag.current.active = false} />
            </div>

            <div className="flex bg-white p-1 rounded-2xl shadow-sm border">
                <button onClick={() => setTarget('PHOTO')} className={`flex-1 py-3 rounded-xl font-bold transition-all ${target==='PHOTO'?'bg-blue-600 text-white shadow-lg':'text-slate-400'}`}>ğŸ‘¤ èª¿äººç‰©</button>
                <button onClick={() => setTarget('SUIT')} className={`flex-1 py-3 rounded-xl font-bold transition-all ${target==='SUIT'?'bg-emerald-600 text-white shadow-lg':'text-slate-400'}`}>ğŸ‘” èª¿è¥¿è£</button>
            </div>

            {/* âœ… è¡£æœé¸æ“‡å™¨èˆ‡æ­£ç¢ºè·¯å¾‘ */}
            <div className="bg-white p-4 rounded-3xl shadow-sm border space-y-4">
                <div className="flex gap-2">
                    <button onClick={()=>setGender('male')} className={`flex-1 py-2 rounded-xl font-bold ${gender==='male'?'bg-slate-800 text-white':'bg-slate-100'}`}>ç”·è£</button>
                    <button onClick={()=>setGender('female')} className={`flex-1 py-2 rounded-xl font-bold ${gender==='female'?'bg-slate-800 text-white':'bg-slate-100'}`}>å¥³è£</button>
                </div>
                <div className="flex gap-3 overflow-x-auto no-scrollbar py-2">
                    <button onClick={()=>setSuitImg(null)} className="flex-shrink-0 w-16 h-16 bg-red-50 text-red-500 rounded-2xl font-black border-2 border-dashed border-red-200">ç§»é™¤</button>
                    {CLOTHES_LIST[gender].map((file) => (
                        <img key={file} 
                             src={`clothes/${gender}/${file}`} 
                             onClick={()=>{
                                const img = new Image();
                                img.onload = () => { setSuitImg(img); setTarget('SUIT'); };
                                img.src = `clothes/${gender}/${file}`; // âœ… ä¿®æ­£å¾Œçš„è·¯å¾‘
                             }} 
                             className="flex-shrink-0 w-16 h-16 rounded-2xl border-2 hover:border-blue-500 cursor-pointer object-cover bg-slate-50"/>
                    ))}
                </div>
            </div>

            <div className="bg-white p-6 rounded-3xl shadow-sm border space-y-4">
                <div className="flex justify-between text-sm font-bold">
                    <span>{target==='PHOTO'?'äººåƒ':'è¥¿è£'} ç¸®æ”¾</span>
                    <span className="text-blue-600">{(target==='PHOTO'?pT.s:sT.s).toFixed(2)}x</span>
                </div>
                <input type="range" min="0.1" max="1.5" step="0.01" value={target==='PHOTO'?pT.s:sT.s}
                    onChange={e => {
                        const val = parseFloat(e.target.value);
                        if(target==='PHOTO') setPT(p => ({...p, s: val}));
                        else setST(p => ({...p, s: val}));
                    }} className="w-full h-2 bg-slate-100 rounded-lg accent-blue-600 appearance-none" />
            </div>

            <div className="grid grid-cols-2 gap-4">
                <label className="flex items-center justify-center bg-slate-900 text-white h-16 rounded-2xl font-bold cursor-pointer shadow-xl">
                    ğŸ“¸ ä¸Šå‚³ç…§ç‰‡
                    <input type="file" hidden accept="image/*" onChange={e => {
                        const file = e.target.files[0];
                        if (file) {
                            const img = new Image();
                            img.onload = () => setImage(img);
                            img.src = URL.createObjectURL(file);
                        }
                    }} />
                </label>
                <button onClick={() => setPreview(null)} className="bg-white border-2 border-slate-200 text-slate-600 h-16 rounded-2xl font-bold">é‡è¨­</button>
            </div>

            <div className="bg-white p-6 rounded-3xl shadow-sm border space-y-3">
                <div className="grid grid-cols-2 gap-2">
                    {Object.keys(SPECS).map(k => (
                        <button key={k} onClick={() => handleExport(k)} disabled={!image || isPending}
                            className="h-14 bg-slate-50 rounded-xl font-bold text-xs hover:bg-blue-50 border border-slate-100">
                            {SPECS[k].name}
                        </button>
                    ))}
                </div>
            </div>

            {preview && (
                <div className="fixed inset-0 bg-black/95 z-[9999] flex flex-col p-6 items-center justify-center">
                    <img src={preview} className="max-w-full max-h-[70vh] border-8 border-white shadow-2xl mb-8" />
                    <div className="flex gap-4 w-full max-w-sm">
                        <button onClick={() => setPreview(null)} className="flex-1 h-14 bg-slate-700 text-white rounded-xl font-bold">è¿”å›</button>
                        <a href={preview} download="EzID_Print.jpg" className="flex-1 h-14 bg-blue-600 text-white rounded-xl font-bold flex items-center justify-center shadow-lg">ä¸‹è¼‰ä¸‹è¼‰</a>
                    </div>
                </div>
            )}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
