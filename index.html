<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v1.3.2</title>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 正確的去背模組 -->
    <script type="module">
        import { backgroundRemoval } from "https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.4.5/+esm";
        window.imglyRemoveBg = backgroundRemoval;
    </script>

    <style>
        body { background-color: #f1f5f9; color: #0f172a; font-family: system-ui, sans-serif; }
        canvas { background: white; border-radius: 12px; border: 1px solid #94a3b8; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .guide-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -55%); width: 55%; height: 55%; border: 2px dashed rgba(239, 68, 68, 0.5); border-radius: 50%; pointer-events: none; }
        .app-card { background: #ffffff; border-radius: 20px; border: 1px solid #cbd5e1; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .gray-line { border-top: 1.5px solid #94a3b8; margin: 24px 0; width: 100%; }
    </style>
</head>
<body class="p-3 md:p-8 no-scrollbar">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

const EzIDApp = () => {
    const [image, setImage] = useState(null);
    const [isCam, setIsCam] = useState(false);
    const [mode, setMode] = useState('MIXED');
    const [p, setP] = useState({ x: 0, y: 0, s: 0.6 });
    const [suit, setSuit] = useState({ id: null, x: 175, y: 340, s: 0.3 });
    const [isProcessing, setIsProcessing] = useState(false);
    const [progress, setProgress] = useState(0);

    const canvasRef = useRef(null);
    const videoRef = useRef(null);
    const suitImg = useRef(new Image());

    const getClothesPath = (id) => {
        const url = window.location.href.split('?')[0];
        const baseUrl = url.endsWith('/') ? url : url.substring(0, url.lastIndexOf('/') + 1);
        return `${baseUrl}clothes/suit-${id}.png`;
    };

    const draw = useCallback(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = "white"; ctx.fillRect(0, 0, 350, 450);
        if (image) {
            ctx.save(); ctx.translate(175 + parseInt(p.x), 225 + parseInt(p.y));
            ctx.scale(p.s, p.s); ctx.drawImage(image, -image.width/2, -image.height/2); ctx.restore();
        }
        if (suit.id) {
            const src = getClothesPath(suit.id);
            if (suitImg.current.src !== src) { suitImg.current.src = src; suitImg.current.onload = draw; }
            if (suitImg.current.complete) {
                ctx.save(); ctx.translate(parseInt(suit.x), parseInt(suit.y));
                ctx.scale(suit.s * 1.5, suit.s * 1.5); ctx.drawImage(suitImg.current, -suitImg.current.width/2, -suitImg.current.height/2); ctx.restore();
            }
        }
    }, [image, p, suit]);

    useEffect(() => { draw(); }, [draw]);

    /* 唯一修正的地方 */
    const removeBG = async () => {
        if (!image) return alert("請先選照片");
        if (!window.imglyRemoveBg) {
            alert("去背引擎尚未載入，請稍後 1~2 秒再按一次");
            return;
        }
        setIsProcessing(true);
        try {
            const blob = await window.imglyRemoveBg(image.src, {
                progress: (p) => setProgress(Math.round(p * 100))
            });
            const url = URL.createObjectURL(blob);
            const newImg = new Image();
            newImg.onload = () => { setImage(newImg); setIsProcessing(false); setProgress(0); };
            newImg.src = url;
        } catch (e) {
            alert("AI 處理失敗，請重新載入網頁");
            setIsProcessing(false);
        }
    };

    const download = () => {
        const pc = document.createElement('canvas'); const ctx = pc.getContext('2d');
        pc.width = 1800; pc.height = 1200; ctx.fillStyle = "white"; ctx.fillRect(0, 0, 1800, 1200);
        const l = {
            MIXED: () => {
                for(let i=0; i<4; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 80+i*425, 80, 413, 531);
                for(let i=0; i<5; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 80+i*340, 650, 331, 449);
            },
            TWO: () => { for(let i=0; i<8; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 100+(i%4)*410, 80+(Math.floor(i/4)*540), 413, 531); },
            ONE: () => { for(let i=0; i<10; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 80+(i%5)*340, 100+(Math.floor(i/5)*460), 331, 449); }
        };
        l[mode]();
        const a = document.createElement('a'); a.download = `ezid_v132_${mode}.png`; a.href = pc.toDataURL(); a.click();
    };

    return (
        [REMAINDER UI 同你版本，完全不動]
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
</script>
</body>
</html>
