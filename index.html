<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.13 è¶…å•†åˆ—å°ç‹</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .canvas-shadow { box-shadow: 0 20px 50px -12px rgba(0,0,0,0.3); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @font-face {
            font-family: 'NotoSansTC';
            src: local('Noto Sans TC'), local('Microsoft JhengHei'), system-ui, sans-serif;
            font-weight: 700;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-emerald-50 to-blue-50 min-h-screen pb-20">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback, useTransition } = React;

// âœ… v20.13 å°ç£è­‰ç…§12ç¨®å…¨è¦æ ¼ï¼ˆè¶…å•†åˆ—å°å„ªåŒ–ï¼‰
const PRINT_SPECS = {
    'A4-20': { w: 2480, h: 3508, photos: 20, grid: [5, 4], size: [413, 531], name: 'A4-2å‹(20å¼µ)' },
    'A4-42': { w: 2480, h: 3508, photos: 42, grid: [7, 6], size: [295, 413], name: 'A4-1å‹(42å¼µ)' },
    'A4-MIX': { w: 2480, h: 3508, type: 'MIX', name: 'A4-MIX(12+18å¼µ)' },
    'A4-BIG': { w: 2480, h: 3508, photos: 8, grid: [2, 4], size: [500, 650], name: 'A4-å¤§é ­è²¼(8å¼µ)' },
    '4x6-8':  { w: 1800, h: 1200, photos: 8,  grid: [2, 4], size: [413, 531], name: '4x6-2å‹(8å¼µ)' },
    '4x6-10': { w: 1800, h: 1200, photos: 10, grid: [2, 5], size: [295, 413], name: '4x6-1å‹(10å¼µ)' },
    '4x6-MIX': { w: 1800, h: 1200, type: 'MIX', name: '4x6-MIX(4+5å¼µ)' },
    '4x6-MINI': { w: 1800, h: 1200, photos: 16, grid: [4, 4], size: [220, 300], name: '4x6-è¿·ä½ (16å¼µ)' },
    'LOGO': { w: 2480, h: 3508, photos: 16, grid: [4, 4], size: [413, 531], special: 'LOGO', name: 'ä¼æ¥­LOGOç‰ˆ' },
    'NAME': { w: 2480, h: 3508, photos: 24, grid: [6, 4], size: [295, 413], special: 'NAME', name: 'å§“åå·¥ç‰Œç‰ˆ' },
    '3x4': { w: 1240, h: 1754, photos: 12, grid: [3, 4], size: [413, 531], name: '3x4ç›¸ç°¿ç‰ˆ' },
    'CUSTOM': { w: 2480, h: 3508, photos: 20, grid: [5, 4], size: [413, 531], name: 'å®¢è£½è‡ªå‹•ç‰ˆ' }
};

// âœ… å°ç£è­‰ç…§å°ºå¯¸é€ŸæŸ¥è¡¨
const SIZE_GUIDE = {
    '2å‹': '35Ã—45mm (è­·ç…§/èº«åˆ†è­‰)',
    '1å‹': '25Ã—35mm (è­‰ç…§/å­¸ç”Ÿè­‰)',
    'å¤§é ­': '50Ã—65mm (è¦ªå­/å¯µç‰©ç…§)',
    'è¿·ä½ ': '22Ã—30mm (å¤§é‡åˆ—å°)'
};

function App() {
    const [isPending, startTransition] = useTransition();
    const [image, setImage] = useState(null);
    const [transform, setTransform] = useState({ x: 0, y: -20, s: 0.45, r: 0 });
    const [slots, setSlots] = useState([]);
    const [progress, setProgress] = useState(0);
    const [preview, setPreview] = useState(null);
    
    const canvasRef = useRef(null);
    const dragRef = useRef({ active: false, x: 0, y: 0 });

    // âœ… v20.13 è¶…å•†åˆ—å°å°ˆç”¨é«˜æ¸…å¼•æ“
    const drawHighResItem = (ctx, img, slotState, x, y, pw, ph) => {
        ctx.save();
        const { x: tx, y: ty, s, r } = slotState;
        const ratio = pw / 350; 
        
        ctx.translate(x + pw / 2, y + ph / 2);
        ctx.rotate(r * Math.PI / 180);
        ctx.scale(s * ratio, s * ratio);
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, -img.width / 2 + (tx / s), -img.height / 2 + (ty / s));
        ctx.restore();
    };

    // âœ… v20.13 è¶…å•†åˆ—å°æœ€çµ‚ç‰ˆç”Ÿç”¢å¼•æ“
    const handleExport = (specKey) => {
        if (!image) return alert("ğŸ“¸ è«‹å…ˆä¸Šå‚³ç…§ç‰‡");
        const spec = PRINT_SPECS[specKey];
        
        startTransition(async () => {
            const canvas = document.createElement('canvas');
            canvas.width = spec.w; canvas.height = spec.h;
            const ctx = canvas.getContext('2d', { alpha: false });
            ctx.imageSmoothingQuality = 'high';
            ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, spec.w, spec.h);

            if (spec.type === 'MIX') {
                // A4-MIXï¼šä¸ŠåŠ2å‹12å¼µ + ä¸‹åŠ1å‹18å¼µ
                const mix2inch = { size: [413, 531], photos: 12, grid: [3, 4] };
                const mix1inch = { size: [295, 413], photos: 18, grid: [3, 6] };
                
                const [r2, c2] = mix2inch.grid; const [pw2, ph2] = mix2inch.size;
                const mx2 = (spec.w - c2 * pw2) / (c2 + 1); const my2 = (spec.h * 0.4 - r2 * ph2) / (r2 + 1);
                for (let i = 0; i < 12; i++) {
                    const row = Math.floor(i / c2); const col = i % c2;
                    const x = mx2 + col * (pw2 + mx2); const y = my2 + row * (ph2 + my2);
                    const state = slots[i]?.state || transform;
                    drawHighResItem(ctx, image, state, x, y, pw2, ph2);
                    ctx.strokeStyle = "#e2e8f0"; ctx.lineWidth = 2; ctx.strokeRect(x, y, pw2, ph2);
                }
                
                const [r1, c1] = mix1inch.grid; const [pw1, ph1] = mix1inch.size;
                const mx1 = (spec.w - c1 * pw1) / (c1 + 1); const my1 = (spec.h * 0.6 - r1 * ph1) / (r1 + 1);
                for (let i = 0; i < 18; i++) {
                    const row = Math.floor(i / c1); const col = i % c1;
                    const x = mx1 + col * (pw1 + mx1); const y = spec.h * 0.45 + my1 + row * (ph1 + my1);
                    const state = slots[12 + i]?.state || transform;
                    drawHighResItem(ctx, image, state, x, y, pw1, ph1);
                    ctx.strokeStyle = "#e2e8f0"; ctx.lineWidth = 2; ctx.strokeRect(x, y, pw1, ph1);
                }
            } else if (spec.special === 'LOGO') {
                // âœ… LOGOç‰ˆï¼š16å¼µç…§ç‰‡ + ç½®ä¸­LOGO
                const [rows, cols] = spec.grid; const [pw, ph] = spec.size;
                const marginX = (spec.w - cols * pw) / (cols + 1);
                const marginY = (spec.h * 0.7 - rows * ph) / (rows + 1);
                
                for (let i = 0; i < 16; i++) {
                    const row = Math.floor(i / cols); const col = i % cols;
                    const x = marginX + col * (pw + marginX);
                    const y = marginY + row * (ph + marginY) + 100;
                    const state = slots[i]?.state || transform;
                    drawHighResItem(ctx, image, state, x, y, pw, ph);
                    ctx.strokeStyle = "#e2e8f0"; ctx.lineWidth = 2; ctx.strokeRect(x, y, pw, ph);
                }
                
                // ç½®ä¸­LOGOå€åŸŸ
                const logoW = spec.w * 0.45; const logoH = spec.h * 0.08;
                const logoX = (spec.w - logoW) / 2; const logoY = 60;
                ctx.fillStyle = "#f8fafc"; ctx.fillRect(logoX, logoY, logoW, logoH);
                ctx.fillStyle = "#1e293b"; 
                ctx.font = `bold 140px NotoSansTC, "Microsoft JhengHei", sans-serif`;
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText('å…¬å¸LOGO', spec.w / 2, logoY + logoH / 2);
            } else if (spec.special === 'NAME') {
                // âœ… å§“åå·¥ç‰Œç‰ˆï¼š24å¼µ + å§“åæ¢ï¼ˆè·¨å¹³å°å­—é«”ï¼‰
                const [rows, cols] = spec.grid; const [pw, ph] = spec.size;
                const marginX = (spec.w - cols * pw) / (cols + 1);
                const marginY = (spec.h - rows * ph) / (rows + 1);
                
                for (let i = 0; i < 24; i++) {
                    const row = Math.floor(i / rows); const col = i % cols;
                    const x = marginX + col * (pw + marginX);
                    const y = marginY + row * (ph + marginY);
                    const state = slots[i]?.state || transform;
                    drawHighResItem(ctx, image, state, x, y, pw, ph);
                    
                    // âœ… ä¿®æ­£ï¼šè·¨å¹³å°ä¸€è‡´å­—é«”
                    ctx.fillStyle = "#f1f5f9"; ctx.fillRect(x, y + ph + 8, pw, 38);
                    ctx.fillStyle = "#1e293b"; 
                    ctx.font = `bold 28px NotoSansTC, "Microsoft JhengHei", Arial, sans-serif`;
                    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText(`å“¡å·¥${i+1}`, x + pw / 2, y + ph + 27);
                    
                    ctx.strokeStyle = "#e2e8f0"; ctx.lineWidth = 2; 
                    ctx.strokeRect(x, y, pw, ph + 46);
                }
            } else {
                // æ¨™æº–è¦æ ¼
                const [rows, cols] = spec.grid || [4, 5];
                const [pw, ph] = spec.size;
                const marginX = (spec.w - cols * pw) / (cols + 1);
                const marginY = (spec.h - rows * ph) / (rows + 1);
                
                const maxPhotos = Math.min(spec.photos || 20, slots.length || 1);
                for (let i = 0; i < maxPhotos; i++) {
                    const row = Math.floor(i / cols); const col = i % cols;
                    const x = marginX + col * (pw + marginX);
                    const y = marginY + row * (ph + marginY);
                    const state = slots[i]?.state || transform;
                    drawHighResItem(ctx, image, state, x, y, pw, ph);
                    ctx.strokeStyle = "#e2e8f0"; ctx.lineWidth = 2; ctx.strokeRect(x, y, pw, ph);
                    
                    setProgress(Math.round(((i + 1) / maxPhotos) * 100));
                    await new Promise(r => requestAnimationFrame(r));
                }
            }
            
            // âœ… è¶…å•†åˆ—å°é—œéµä¿®æ­£ï¼šJPEG 3-5MB
            setPreview(canvas.toDataURL('image/jpeg', 0.92));
            setProgress(0);
        });
    };

    // ğŸ¨ å³æ™‚é è¦½
    useEffect(() => {
        const ctx = canvasRef.current?.getContext('2d');
        if (!ctx || !image) return;
        ctx.clearRect(0, 0, 350, 450);
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, 350, 450);
        
        ctx.save();
        ctx.translate(175 + transform.x, 225 + transform.y);
        ctx.rotate(transform.r * Math.PI / 180);
        ctx.scale(transform.s, transform.s);
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(image, -image.width / 2, -image.height / 2);
        ctx.restore();
    }, [image, transform]);

    return (
        <div className="max-w-md mx-auto p-6 space-y-6">
            {/* ğŸš© è¶…å•†éœ¸ä¸»æ¨™é¡Œ */}
            <div className="text-center pt-4">
                <h1 className="text-4xl font-black bg-gradient-to-r from-emerald-700 via-blue-700 to-indigo-700 bg-clip-text text-transparent tracking-tight">
                    EzID v20.13
                </h1>
                <p className="text-emerald-700 font-bold mt-2">è¶…å•†åˆ—å°ç‹ â€¢ 3-5MBå®Œç¾å°ºå¯¸</p>
            </div>

            {/* ğŸ–¼ï¸ å°ˆæ¥­ç·¨è¼¯å€ */}
            <div className="relative flex justify-center">
                <canvas 
                    ref={canvasRef} width="350" height="450" 
                    className="canvas-shadow rounded-3xl bg-white border-4 border-slate-100 shadow-2xl"
                    onPointerDown={e => {
                        e.target.setPointerCapture(e.pointerId);
                        dragRef.current = { active: true, x: e.clientX, y: e.clientY };
                    }}
                    onPointerMove={e => {
                        if (!dragRef.current.active) return;
                        const dx = (e.clientX - dragRef.current.x) * 0.8;
                        const dy = (e.clientY - dragRef.current.y) * 0.8;
                        setTransform(t => ({ 
                            ...t, 
                            x: Math.max(-175, Math.min(175, t.x + dx)), 
                            y: Math.max(-125, Math.min(225, t.y + dy))
                        }));
                        dragRef.current.x = e.clientX;
                        dragRef.current.y = e.clientY;
                    }}
                    onPointerUp={() => dragRef.current.active = false}
                />
            </div>

            {/* âš™ï¸ ç²¾æº–æ§åˆ¶ */}
            <section className="bg-white/95 backdrop-blur-sm rounded-3xl p-6 shadow-xl border border-slate-100">
                <div className="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <div className="font-bold text-slate-700 mb-2 flex items-center">
                            ğŸ” ç¸®æ”¾ <span className="ml-2 text-emerald-600 font-black">{transform.s.toFixed(2)}x</span>
                        </div>
                        <input type="range" min="0.2" max="1.2" step="0.01" value={transform.s} 
                            onChange={e => setTransform(t => ({ ...t, s: parseFloat(e.target.value) }))}
                            className="w-full h-2 bg-slate-200 rounded-xl accent-emerald-600" />
                    </div>
                    <div>
                        <div className="font-bold text-slate-700 mb-2 flex items-center">
                            â†» æ—‹è½‰ <span className="ml-2 text-indigo-600 font-black">{transform.r}Â°</span>
                        </div>
                        <input type="range" min="-30" max="30" step="1" value={transform.r} 
                            onChange={e => setTransform(t => ({ ...t, r: parseInt(e.target.value) }))}
                            className="w-full h-2 bg-slate-200 rounded-xl accent-indigo-600" />
                    </div>
                </div>
            </section>

            {/* ğŸ›ï¸ æ ¸å¿ƒæ“ä½œ */}
            <div className="grid grid-cols-2 gap-4">
                <label className="group bg-gradient-to-br from-slate-800 to-slate-900 text-white h-20 rounded-3xl font-black shadow-2xl cursor-pointer hover:from-slate-900 hover:shadow-3xl transition-all flex items-center justify-center">
                    ğŸ“¸ ä¸Šå‚³é«˜æ¸…åŸåœ–
                    <input type="file" hidden accept="image/*" onChange={e => {
                        const file = e.target.files[0];
                        if (file && file.size < 20e6) {
                            const url = URL.createObjectURL(file);
                            const img = new Image();
                            img.onload = () => { 
                                setImage(img); 
                                URL.revokeObjectURL(url); 
                                setSlots([]);
                                setTransform({ x: 0, y: -20, s: 0.45, r: 0 });
                            };
                            img.src = url;
                        } else {
                            alert('âš ï¸ è«‹é¸æ“‡20MBä»¥å…§ç…§ç‰‡');
                        }
                    }} />
                    <div className="absolute inset-0 bg-white/10 rounded-3xl scale-0 group-hover:scale-100 transition-transform origin-center" />
                </label>
                <button onClick={() => {
                    setSlots([{ state: { ...transform } }, ...slots.slice(0, 41)]);
                    // éŸ³æ•ˆåé¥‹
                    navigator.vibrate?.(50);
                }} disabled={!image} className="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white h-20 rounded-3xl font-black shadow-2xl hover:shadow-3xl disabled:opacity-50 disabled:cursor-not-allowed transition-all flex items-center justify-center group">
                    ğŸ’¾ å„²å­˜ä½ç½® ({slots.length}/42)
                    <span className="ml-1 text-xs opacity-75">(é»æ“Šé‚„åŸ)</span>
                </button>
            </div>

            {/* ğŸ–¨ï¸ 12ç¨®è¶…å•†è¦æ ¼ï¼ˆæœ€çµ‚ç‰ˆï¼‰ */}
            <section className="bg-white/95 backdrop-blur-sm rounded-3xl p-6 shadow-xl border border-slate-100">
                <div className="flex items-center justify-between mb-6">
                    <h3 className="text-xl font-black text-slate-800">ğŸ–¨ï¸ å°ç£è­‰ç…§å…¨è¦æ ¼</h3>
                    <span className="text-xs text-emerald-600 font-bold bg-emerald-100 px-2 py-1 rounded-full">300dpi</span>
                </div>
                
                {isPending && (
                    <div className="mb-6 p-4 bg-emerald-50 border border-emerald-200 rounded-2xl">
                        <div className="flex justify-between items-center mb-2">
                            <span className="font-bold text-emerald-800">âš¡ è¶…å•†åˆ—å°å¼•æ“</span>
                            <span className="font-black text-2xl text-emerald-600">{progress}%</span>
                        </div>
                        <div className="w-full bg-slate-200 h-4 rounded-xl overflow-hidden shadow-inner">
                            <div className="bg-gradient-to-r from-emerald-500 to-emerald-600 h-full shadow-lg transition-all" 
                                 style={{ width: `${progress}%` }} />
                        </div>
                    </div>
                )}

                <div className="grid grid-cols-2 gap-3 max-h-96 overflow-y-auto no-scrollbar pb-2">
                    {Object.entries(PRINT_SPECS).map(([key, spec]) => (
                        <button key={key} disabled={isPending || !image}
                                onClick={() => handleExport(key)}
                                className="group h-20 p-3 bg-gradient-to-b from-slate-50 to-blue-50 border-2 border-slate-200/50 rounded-2xl hover:from-emerald-50 hover:to-emerald-100 hover:border-emerald-300 hover:shadow-xl font-bold text-slate-800 text-sm shadow-sm hover:scale-[1.02] transition-all disabled:opacity-40 disabled:cursor-not-allowed flex flex-col items-center justify-center relative overflow-hidden">
                            <span>{spec.name}</span>
                            <span className="text-xs text-slate-500 mt-1">{spec.w}Ã—{spec.h}px</span>
                            <div className="absolute inset-0 bg-gradient-to-r from-emerald-400/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" />
                        </button>
                    ))}
                </div>
            </section>

            {/* ğŸ“± å°ç£è­‰ç…§é€ŸæŸ¥è¡¨ */}
            <div className="bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-200 rounded-3xl p-4 shadow-lg">
                <h4 className="font-black text-yellow-800 mb-3 text-center">ğŸ“ å°ç£è­‰ç…§å°ºå¯¸é€ŸæŸ¥</h4>
                <div className="grid grid-cols-2 gap-2 text-xs">
                    <div><span className="font-bold">2å‹ï¼š</span>35Ã—45mm è­·ç…§/èº«åˆ†è­‰</div>
                    <div><span className="font-bold">1å‹ï¼š</span>25Ã—35mm å­¸ç”Ÿè­‰/è­‰ç…§</div>
                    <div><span className="font-bold">å¤§é ­ï¼š</span>50Ã—65mm è¦ªå­ç…§</div>
                    <div><span className="font-bold">è¿·ä½ ï¼š</span>22Ã—30mm å¤§é‡åˆ—å°</div>
                </div>
            </div>

            {/* ğŸ‘ï¸ è¶…å•†åˆ—å°é è¦½ */}
            {preview && (
                <div className="fixed inset-0 bg-slate-900/98 z-[10000] flex flex-col p-6" onClick={e => e.target === e.currentTarget && setPreview(null)}>
                    <div className="flex-1 flex items-center justify-center overflow-auto p-4">
                        <img src={preview} className="max-w-full max-h-full shadow-2xl rounded-3xl border-8 border-white" />
                    </div>
                    <div className="mt-8 flex gap-4 bg-white/95 backdrop-blur-sm p-4 rounded-3xl border">
                        <button onClick={() => setPreview(null)} 
                                className="flex-1 h-16 bg-slate-700 hover:bg-slate-800 text-white rounded-2xl font-bold shadow-xl transition-all flex items-center justify-center">
                            â† ç¹¼çºŒèª¿æ•´
                        </button>
                        <a href={preview} download={`è­‰ä»¶ç…§_${Date.now()}.jpg`} 
                           className="flex-1 h-16 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white rounded-2xl font-bold shadow-2xl flex items-center justify-center">
                            ğŸ’¾ ä¸‹è¼‰åˆ—å° (3-5MB)
                        </a>
                    </div>
                </div>
            )}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
