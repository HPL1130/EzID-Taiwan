<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v16.12 - 12ç¨®å…¨è¦æ ¼ä¼æ¥­ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .canvas-container { 
            position: relative; width: 340px; height: 437px; margin: 10px auto; 
            background: #fff; border: 4px solid #0f172a; border-radius: 24px; overflow: hidden; 
            touch-action: none; cursor: grab; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            transition: all 0.2s ease;
        }
        .canvas-container:active { cursor: grabbing; transform: translateY(1px); }
        .preview-overlay { 
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 1000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; 
        }
        .print-btn { @apply px-3 py-2 rounded-xl font-bold text-xs transition-all; }
        .print-btn-a4 { @apply bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:shadow-lg; }
        .print-btn-4x6 { @apply bg-gradient-to-r from-emerald-500 to-emerald-600 text-white hover:shadow-lg; }
        .print-btn-special { @apply bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:shadow-lg; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen pb-24 font-sans">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

const SUITS = {
    male: ['male/m1.png','male/m2.png','male/m3.png','male/m4.png','male/m5.png'],
    female: ['female/f1.png','female/f2.png','female/f3.png','female/f4.png','female/f5.png']
};

// âœ… 12ç¨®æ’ç‰ˆè¦æ ¼ç²¾ç¢ºé…ç½®
const PRINT_SPECS = {
    // A4è¦æ ¼ (2480x3508px)
    'A4-20': { w: 2480, h: 3508, layout: [[413,531,205,300,520,600],[4,5]], name: 'A4-20å¼µ2å‹' },
    'A4-42': { w: 2480, h: 3508, layout: [[295,413,215,250,350,480],[7,6]], name: 'A4-42å¼µ1å‹' },
    'A4-MIX': { w: 2480, h: 3508, layout: 'mix', name: 'A4-MIX-30å¼µ' },
    'A4-BIG': { w: 2480, h: 3508, layout: [[500,650,180,280,560,680],[2,4]], name: 'A4-8å¼µå¤§é ­' },
    
    // 4x6è¦æ ¼ (1800x1200px)
    '4x6-8': { w: 1800, h: 1200, layout: [[413,531,90,70,410,540],[2,4]], name: '4x6-8å¼µ2å‹' },
    '4x6-10': { w: 1800, h: 1200, layout: [[295,413,150,160,310,460],[2,5]], name: '4x6-10å¼µ1å‹' },
    '4x6-MIX': { w: 1800, h: 1200, layout: 'mix', name: '4x6-MIX-9å¼µ' },
    '4x6-MINI': { w: 1800, h: 1200, layout: [[220,300,120,100,320,380],[4,4]], name: '4x6-16å¼µè¿·ä½ ' },
    
    // å•†æ¥­ç‰¹æ®Šè¦æ ¼
    'LOGO': { w: 2480, h: 3508, layout: [[413,531,205,350,520,600],[4,4]], name: 'ä¼æ¥­LOGOç‰ˆ' },
    'NAME': { w: 2480, h: 3508, layout: [[295,413,215,300,350,480],[6,4]], name: 'å§“åå·¥ç‰Œç‰ˆ' },
    '3x4': { w: 1240, h: 1754, layout: [[413,531,100,150,520,600],[3,4]], name: '3x4ç›¸ç°¿ç‰ˆ' },
    'CUSTOM': { w: 2480, h: 3508, layout: 'custom', name: 'å®¢è£½Nå¼µç‰ˆ' }
};

function App() {
    const canvasRef = useRef(null);
    const dragPos = useRef({ x: 0, y: 0, isDown: false });
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [gender, setGender] = useState('male');
    const [target, setTarget] = useState("PHOTO");
    const [p, setP] = useState({ x: 0, y: -20, s: 0.45, r: 0, f: 1 });
    const [sp, setSp] = useState({ x: 0, y: 80, s: 1.0, r: 0 });
    const [cfg, setCfg] = useState({ bright: 100, guide: 0.8, name: "EzID", logo: null });
    const [slots, setSlots] = useState([]);
    const [preImg, setPreImg] = useState(null);

    // ğŸ¨ Canvasæ¸²æŸ“å¼•æ“
    const draw = useCallback(() => {
        const ctx = canvasRef.current?.getContext("2d");
        if (!ctx) return;
        
        ctx.fillStyle = "#fff"; 
        ctx.fillRect(0, 0, 350, 450);
        
        if (image?.complete) {
            ctx.save(); 
            ctx.filter = `brightness(${cfg.bright}%)`;
            ctx.translate(175 + p.x, 225 + p.y); 
            ctx.rotate(p.r * Math.PI / 180);
            ctx.scale(p.s * p.f, p.s); 
            ctx.drawImage(image, -image.width/2, -image.height/2); 
            ctx.restore();
        }
        
        if (suitImg?.complete) {
            ctx.save(); 
            ctx.translate(175 + sp.x, 225 + sp.y); 
            ctx.rotate(sp.r * Math.PI / 180);
            ctx.scale(sp.s, sp.s); 
            ctx.drawImage(suitImg, -suitImg.width/2, -suitImg.height/2); 
            ctx.restore();
        }
        
        if (cfg.guide > 0) {
            ctx.save(); 
            ctx.globalAlpha = cfg.guide; 
            ctx.setLineDash([5, 5]); 
            ctx.lineWidth = 2;
            const isCentered = (Math.abs(p.x) < 5 && Math.abs(p.y+20) < 5);
            ctx.strokeStyle = isCentered ? "#10b981" : "#ef4444"; 
            ctx.beginPath(); 
            ctx.ellipse(175, 203, 108, 160, 0, 0, Math.PI * 2); 
            ctx.stroke(); 
            ctx.restore();
        }
    }, [image, suitImg, p, sp, cfg]);

    useEffect(() => {
        let frame = requestAnimationFrame(function loop(){ draw(); frame = requestAnimationFrame(loop); });
        return () => cancelAnimationFrame(frame);
    }, [draw]);

    // ğŸ–±ï¸ æ‹–æ›³æ§åˆ¶
    const handlePointer = (e, type) => {
        if (type === 'start') {
            dragPos.current = { x: e.clientX, y: e.clientY, isDown: true };
        } else if (type === 'move' && dragPos.current.isDown) {
            const dx = (e.clientX - dragPos.current.x) * 0.8;
            const dy = (e.clientY - dragPos.current.y) * 0.8;
            if (target === "PHOTO") {
                setP(v => ({ 
                    x: Math.max(-180, Math.min(180, v.x + dx)), 
                    y: Math.max(-140, Math.min(240, v.y + dy)), 
                    s: v.s, r: v.r, f: v.f 
                }));
            } else {
                setSp(v => ({ 
                    x: Math.max(-180, Math.min(180, v.x + dx)), 
                    y: Math.max(-140, Math.min(240, v.y + dy)), 
                    s: v.s, r: v.r 
                }));
            }
            dragPos.current = { x: e.clientX, y: e.clientY, isDown: true };
        } else if (type === 'end') { 
            dragPos.current.isDown = false; 
        }
    };

    // ğŸ’¾ å®Œæ•´æ§½ä½å„²å­˜
    const saveToSlot = () => {
        const temp = document.createElement("canvas"); 
        temp.width = 350; 
        temp.height = 450;
        const tctx = temp.getContext("2d"); 
        tctx.drawImage(canvasRef.current, 0, 0);
        const newSlot = {
            snap: temp.toDataURL("image/png"),
            data: { image, suitImg, p: {...p}, sp: {...sp}, cfg: {...cfg} }
        };
        setSlots([newSlot, ...slots].slice(0, 15));
    };

    // ğŸ–¨ï¸ 12ç¨®æ’ç‰ˆå¼•æ“
    const exportPrint = async (key) => {
        if (!slots.length) return alert("è«‹å…ˆå­˜å…¥æ§½ä½");
        
        const spec = PRINT_SPECS[key];
        const canvas = document.createElement("canvas"); 
        canvas.width = spec.w; 
        canvas.height = spec.h;
        const ctx = canvas.getContext("2d"); 
        ctx.fillStyle = "white"; 
        ctx.fillRect(0, 0, spec.w, spec.h);
        
        const imgs = await Promise.all(
            slots.slice(0, 50).map(s => 
                new Promise(res => {
                    const i = new Image(); 
                    i.onload = () => res(i); 
                    i.src = s.snap;
                })
            )
        );

        const putImg = (img, x, y, w, h) => {
            ctx.drawImage(img, x, y, w, h);
            ctx.strokeStyle = "#e0e0e0"; 
            ctx.lineWidth = 2; 
            ctx.strokeRect(x, y, w, h);
        };

        // âœ… 12ç¨®ç²¾ç¢ºæ’ç‰ˆé‚è¼¯
        if (key === 'A4-20') {
            for(let i = 0; i < 20; i++) {
                const x = 205 + (i % 4) * 520;
                const y = 300 + Math.floor(i / 4) * 600;
                putImg(imgs[i % imgs.length], x, y, 413, 531);
            }
        } else if (key === 'A4-42') {
            for(let i = 0; i < 42; i++) {
                const x = 215 + (i % 6) * 350;
                const y = 250 + Math.floor(i / 6) * 480;
                putImg(imgs[i % imgs.length], x, y, 295, 413);
            }
        } else if (key === 'A4-MIX') {
            // ä¸ŠåŠ12å¼µ2å‹
            for(let i = 0; i < 12; i++) {
                const x = 205 + (i % 4) * 520;
                const y = 300 + Math.floor(i / 4) * 600;
                putImg(imgs[i % imgs.length], x, y, 413, 531);
            }
            // ä¸‹åŠ18å¼µ1å‹
            for(let i = 0; i < 18; i++) {
                const x = 215 + (i % 6) * 350;
                const y = 2200 + Math.floor(i / 6) * 480;
                putImg(imgs[i % imgs.length], x, y, 295, 413);
            }
        } else if (key === 'A4-BIG') {
            for(let i = 0; i < 8; i++) {
                const x = 180 + (i % 4) * 560;
                const y = 280 + Math.floor(i / 2) * 680;
                putImg(imgs[i % imgs.length], x, y, 500, 650);
            }
        } else if (key === '4x6-8') {
            for(let i = 0; i < 8; i++) {
                const x = 90 + (i % 4) * 410;
                const y = 70 + Math.floor(i / 4) * 540;
                putImg(imgs[i % imgs.length], x, y, 413, 531);
            }
        } else if (key === '4x6-10') {
            for(let i = 0; i < 10; i++) {
                const x = 150 + (i % 5) * 310;
                const y = 160 + Math.floor(i / 5) * 460;
                putImg(imgs[i % imgs.length], x, y, 295, 413);
            }
        } else if (key === '4x6-MIX') {
            for(let i = 0; i < 4; i++) putImg(imgs[i], 90 + i * 410, 80, 413, 531);
            for(let i = 0; i < 5; i++) putImg(imgs[i], 90 + i * 325, 660, 295, 413);
        } else if (key === '4x6-MINI') {
            for(let i = 0; i < 16; i++) {
                const x = 120 + (i % 4) * 320;
                const y = 100 + Math.floor(i / 4) * 380;
                putImg(imgs[i % imgs.length], x, y, 220, 300);
            }
        } else if (key === 'LOGO') {
            // 16å¼µ2å‹ + LOGOç©ºé–“
            for(let i = 0; i < 16; i++) {
                const x = 205 + (i % 4) * 520;
                const y = 350 + Math.floor(i / 4) * 600;
                putImg(imgs[i % imgs.length], x, y, 413, 531);
            }
            // LOGOå€åŸŸ
            ctx.fillStyle = '#f3f4f6';
            ctx.fillRect(900, 50, 680, 200);
            ctx.fillStyle = '#1f2937';
            ctx.font = 'bold 120px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('å…¬å¸LOGO', 1240, 160);
        } else if (key === 'NAME') {
            for(let i = 0; i < 24; i++) {
                const x = 215 + (i % 6) * 350;
                const y = 300 + Math.floor(i / 4) * 480;
                putImg(imgs[i % imgs.length], x, y, 295, 413);
                // å§“åæ¢
                ctx.fillStyle = '#e5e7eb';
                ctx.fillRect(x, y + 420, 295, 40);
                ctx.fillStyle = '#000';
                ctx.font = 'bold 24px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(`å§“å${i+1}`, x + 147, y + 448);
            }
        } else if (key === '3x4') {
            for(let i = 0; i < 12; i++) {
                const x = 100 + (i % 4) * 520;
                const y = 150 + Math.floor(i / 3) * 600;
                putImg(imgs[i % imgs.length], x, y, 413, 531);
            }
        }

        setPreImg(canvas.toDataURL("image/png"));
    };

    return (
        <div className="max-w-md mx-auto p-4 space-y-4">
            {/* ğŸš© æ¨™é¡Œå€ */}
            <div className="bg-white/90 backdrop-blur-sm p-5 rounded-3xl shadow-xl border text-center">
                <h1 className="text-2xl font-black bg-gradient-to-r from-slate-800 to-blue-800 bg-clip-text text-transparent mb-1">
                    EzID v16.12
                </h1>
                <p className="text-sm text-slate-600 font-bold">12ç¨®å…¨è¦æ ¼ä¼æ¥­ç‰ˆ</p>
            </div>

            {/* ğŸ–¼ï¸ Canvas */}
            <div className="canvas-container" 
                 onPointerDown={e=>handlePointer(e,'start')} 
                 onPointerMove={e=>handlePointer(e,'move')} 
                 onPointerUp={e=>handlePointer(e,'end')}>
                <canvas ref={canvasRef} width="350" height="450" className="w-full h-full" />
            </div>

            {/* ğŸ‘” ç”·å¥³è£é¸æ“‡ */}
            <div className="bg-white/90 backdrop-blur-sm p-4 rounded-3xl shadow-xl border">
                <div className="flex mb-4">
                    <button onClick={()=>setGender('male')} 
                            className={`flex-1 py-3 px-4 font-bold rounded-2xl mr-2 ${gender==='male'?'bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg':'bg-slate-200 hover:bg-slate-300'}`}>
                        ğŸ‘¨ ç”·è£
                    </button>
                    <button onClick={()=>setGender('female')} 
                            className={`flex-1 py-3 px-4 font-bold rounded-2xl ${gender==='female'?'bg-gradient-to-r from-pink-500 to-pink-600 text-white shadow-lg':'bg-slate-200 hover:bg-slate-300'}`}>
                        ğŸ‘© å¥³è£
                    </button>
                </div>
                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                    <button onClick={()=>{setSuitImg(null); setTarget("PHOTO")}} 
                            className="w-16 h-16 bg-red-50 border-2 border-dashed border-red-300 rounded-2xl flex items-center justify-center hover:bg-red-100">
                        ğŸš«
                    </button>
                    {SUITS[gender].map((s, idx) => (
                        <img key={idx} src={`clothes/${s}`} 
                             onClick={()=>{
                                const i = new Image(); 
                                i.src = `clothes/${s}`; 
                                i.onload = () => { setSuitImg(i); setTarget("SUIT"); }
                             }} 
                             className="w-16 h-16 rounded-2xl border-2 border-slate-200 hover:border-blue-400 hover:shadow-md cursor-pointer" />
                    ))}
                </div>
            </div>

            {/* ğŸ›ï¸ æ§åˆ¶é¢æ¿ */}
            <div className="bg-white/90 backdrop-blur-sm p-5 rounded-3xl shadow-xl border">
                <div className="flex bg-slate-200 p-1 rounded-2xl mb-4">
                    <button onClick={()=>setTarget("PHOTO")} 
                            className={`flex-1 py-3 text-sm font-bold rounded-xl ${target==='PHOTO'?'bg-white shadow-md text-blue-600':'text-slate-500 hover:bg-white/50'}`}>
                        ğŸ‘¤ äººåƒ
                    </button>
                    <button onClick={()=>setTarget("SUIT")} 
                            className={`flex-1 py-3 text-sm font-bold rounded-xl ${target==='SUIT'?'bg-white shadow-md text-blue-600':'text-slate-500 hover:bg-white/50'}`}>
                        ğŸ‘• è¡£æœ
                    </button>
                </div>
                <div className="space-y-3 text-xs">
                    <div className="flex items-center gap-3">
                        <span className="w-12 font-bold text-slate-500">SIZE</span>
                        <input type="range" min="0.1" max="2" step="0.01" 
                               value={target==="PHOTO"?p.s:sp.s} 
                               onChange={e=>target==="PHOTO"?setP({...p,s:+e.target.value}):setSp({...sp,s:+e.target.value})} 
                               className="flex-1 h-2 bg-slate-200 rounded-lg accent-blue-500" />
                        <span className="w-12 text-right font-mono font-bold">{(target==="PHOTO"?p.s:sp.s).toFixed(2)}</span>
                    </div>
                    <div className="flex items-center gap-3">
                        <span className="w-12 font-bold text-slate-500">ROTATE</span>
                        <input type="range" min="-45" max="45" step="1" 
                               value={target==="PHOTO"?p.r:sp.r} 
                               onChange={e=>target==="PHOTO"?setP({...p,r:+e.target.value}):setSp({...sp,r:+e.target.value})} 
                               className="flex-1 h-2 bg-slate-200 rounded-lg accent-emerald-500" />
                        <span className="w-12 text-right font-mono font-bold">{target==="PHOTO"?p.r:sp.r}Â°</span>
                    </div>
                </div>
            </div>

            {/* ğŸ“¸ å¿«é€Ÿæ“ä½œ */}
            <div className="grid grid-cols-2 gap-4">
                <label className="bg-gradient-to-r from-slate-800 to-slate-900 text-white py-5 rounded-3xl text-center font-black shadow-xl hover:shadow-2xl cursor-pointer block">
                    ğŸ“¸ ä¸Šå‚³ç…§ç‰‡
                    <input type="file" accept="image/*" hidden 
                           onChange={e=>{
                               const f = e.target.files[0]; 
                               if(f) {
                                   const i = new Image(); 
                                   i.src = URL.createObjectURL(f); 
                                   i.onload = () => { setImage(i); setTarget("PHOTO"); }
                               }
                           }} />
                </label>
                <button onClick={saveToSlot} 
                        className="bg-gradient-to-r from-blue-600 to-blue-700 text-white py-5 rounded-3xl font-black shadow-xl hover:shadow-2xl">
                    ğŸ“¥ å­˜æ§½ä½ ({slots.length}/15)
                </button>
            </div>

            {/* ğŸšï¸ æ§½ä½é è¦½ */}
            <div className="bg-slate-100 p-4 rounded-3xl flex gap-3 overflow-x-auto no-scrollbar min-h-[120px]">
                {slots.map((s, i) => (
                    <div key={i} className="relative w-20 h-28 bg-white rounded-2xl shadow-md flex-shrink-0 overflow-hidden hover:shadow-xl group cursor-pointer" 
                         onClick={()=>{
                             const d = s.data; 
                             setImage(d.image); 
                             setSuitImg(d.suitImg); 
                             setP(d.p); 
                             setSp(d.sp); 
                             setCfg(d.cfg);
                         }}>
                        <img src={s.snap} className="w-full h-full object-cover" />
                        <button onClick={e=>{
                            e.stopPropagation();
                            setSlots(slots.filter((_,idx)=>idx!==i));
                        }} className="absolute top-1 right-1 bg-red-500 text-white w-6 h-6 rounded-full text-xs font-bold hover:bg-red-600">Ã—</button>
                    </div>
                ))}
            </div>

            {/* ğŸ–¨ï¸ 12ç¨®æ’ç‰ˆä¸€éµé¸æ“‡ */}
            <div className="bg-white/90 backdrop-blur-sm p-6 rounded-3xl shadow-xl border space-y-3">
                <div className="text-center font-black text-lg mb-4">ğŸ–¨ï¸ 12ç¨®å°ˆæ¥­æ’ç‰ˆ</div>
                
                {/* A4è¦æ ¼ 4ç¨® */}
                <div className="grid grid-cols-2 gap-2 mb-3">
                    <button onClick={()=>exportPrint('A4-20')} className="print-btn print-btn-a4 col-span-2">ğŸ“„ A4-20å¼µ2å‹</button>
                    <button onClick={()=>exportPrint('A4-42')} className="print-btn print-btn-a4">ğŸ“„ A4-42å¼µ1å‹</button>
                    <button onClick={()=>exportPrint('A4-MIX')} className="print-btn print-btn-a4">ğŸ“„ A4-MIX-30å¼µ</button>
                    <button onClick={()=>exportPrint('A4-BIG')} className="print-btn print-btn-a4 col-span-2">ğŸ“„ A4-8å¼µå¤§é ­è²¼</button>
                </div>
                
                {/* 4x6è¦æ ¼ 4ç¨® */}
                <div className="grid grid-cols-2 gap-2 mb-3">
                    <button onClick={()=>exportPrint('4x6-8')} className="print-btn print-btn-4x6 col-span-2">ğŸ“„ 4x6-8å¼µ2å‹</button>
                    <button onClick={()=>exportPrint('4x6-10')} className="print-btn print-btn-4x6">ğŸ“„ 4x6-10å¼µ1å‹</button>
                    <button onClick={()=>exportPrint('4x6-MIX')} className="print-btn print-btn-4x6">ğŸ“„ 4x6-MIX-9å¼µ</button>
                    <button onClick={()=>exportPrint('4x6-MINI')} className="print-btn print-btn-4x6 col-span-2">ğŸ“„ 4x6-16å¼µè¿·ä½ </button>
                </div>
                
                {/* å•†æ¥­è¦æ ¼ 4ç¨® */}
                <div className="grid grid-cols-2 gap-2">
                    <button onClick={()=>exportPrint('LOGO')} className="print-btn print-btn-special col-span-2">ğŸ¢ ä¼æ¥­LOGOç‰ˆ</button>
                    <button onClick={()=>exportPrint('NAME')} className="print-btn print-btn-special col-span-2">ğŸ·ï¸ å§“åå·¥ç‰Œç‰ˆ</button>
                    <button onClick={()=>exportPrint('3x4')} className="print-btn print-btn-special col-span-2">ğŸ“– 3x4ç›¸ç°¿ç‰ˆ</button>
                    <button onClick={()=>exportPrint('CUSTOM')} className="print-btn print-btn-special col-span-2">âš™ï¸ å®¢è£½Nå¼µç‰ˆ</button>
                </div>
            </div>

            {/* ğŸ‘€ é è¦½è¦–çª— */}
            {preImg && (
                <div className="preview-overlay" onClick={e=>e.target===e.currentTarget&&setPreImg(null)}>
                    <div className="bg-white p-6 rounded-3xl max-w-[95vw] max-h-[80vh] overflow-auto shadow-2xl" onClick={e=>e.stopPropagation()}>
                        <img src={preImg} className="w-full h-auto rounded-2xl mb-6" />
                        <div className="flex gap-4">
                            <button onClick={()=>setPreImg(null)} className="flex-1 py-3 bg-slate-700 hover:bg-slate-800 text-white rounded-2xl font-bold">è¿”å›</button>
                            <a href={preImg} download={`${cfg.name}_${Date.now()}.png`} className="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-bold text-center">ğŸ’¾ ä¸‹è¼‰åˆ—å°</a>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
