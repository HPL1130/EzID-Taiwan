<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v3.3.4 PRO</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display:none; }
        
        /* ç•«å¸ƒå®¹å™¨ï¼š3.5cm x 4.5cm æ¯”ä¾‹ */
        .canvas-container { 
            position:relative; 
            width:350px; 
            height:450px; 
            margin:0 auto; 
            background:#fff; 
            border-radius:12px; 
            border:1px solid #e2e8f0; 
            overflow:hidden; 
            box-shadow:0 10px 30px rgba(0,0,0,0.08);
        }

        /* å…§åœˆ (3.2cm è‡‰é•·ä¸‹é™)ï¼šé•·åº¦ 320px */
        .inner-guide { 
            border: 2px dotted rgba(16,185,129,0.5); 
            position: absolute; 
            border-radius: 50% / 45%; 
            width: 200px;   /* èª¿çª„å¯¬åº¦ï¼Œé¿å…ä½”æ»¿ç‰ˆé¢ */
            height: 320px; 
            left: 50%;
            top: 50px;      /* é ç•™ç´„ 5mm é ­é ‚ç©ºé–“ */
            transform: translateX(-50%);
            z-index: 100; 
            pointer-events: none; 
        }

        /* å¤–åœˆ (3.6cm è‡‰é•·ä¸Šé™)ï¼šé•·åº¦ 360px */
        .outer-guide { 
            border: 2px dashed rgba(245,158,11,0.35); 
            position: absolute; 
            border-radius: 50% / 45%; 
            width: 230px; 
            height: 360px; 
            left: 50%;
            top: 30px;      /* é ç•™ç´„ 3mm é ­é ‚ç©ºé–“ */
            transform: translateX(-50%);
            z-index: 99; 
            pointer-events: none; 
        }

        /* ä¸­è»¸å‚ç›´è¼”åŠ©ç·š */
        .center-line {
            position: absolute;
            left: 50%;
            top: 0; bottom: 0;
            width: 1px;
            background: rgba(37, 99, 235, 0.1);
            transform: translateX(-50%);
            z-index: 98;
        }

        .toast { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.85); color:white; padding:10px 24px; border-radius:24px; font-size:12px; z-index:999; backdrop-filter:blur(4px); pointer-events:none; }
        input[type=range] { width:100%; accent-color:#2563eb; height:6px; background:transparent; appearance:none; cursor: pointer; position: relative; z-index: 10; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

const CLOTHES = [
    ...Array(5).fill(0).map((_, i) => `clothes/male/m${i+1}.png`),
    ...Array(5).fill(0).map((_, i) => `clothes/female/f${i+1}.png`)
];

const DPI = 300, A4_W = 2480, A4_H = 3508;

const CONTROL_RANGES = {
    photo: { s: {min:0.3, max:1.5, step:0.01}, y: {min:-200, max:200}, x: {min:-150, max:150} },
    suit:  { s: {min:0.5, max:4.0, step:0.01}, y: {min:-400, max:400}, x: {min:-250, max:250} }
};

function App() {
    const canvasRef = useRef(null);
    const toastTimer = useRef(null);
    const dirtyRef = useRef(true);
    const scheduledRef = useRef(false);

    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [activeSuit, setActiveSuit] = useState(null);
    const [slots, setSlots] = useState([]); 
    const [toast, setToast] = useState("");
    const [cutMode, setCutMode] = useState("FRAME_L"); 
    
    const [p, setP] = useState({ x: 0, y: -20, s: 0.75 });
    const [sp, setSp] = useState({ x: 0, y: 0, s: 1.0 });

    const draw = useCallback(() => {
        const cvs = canvasRef.current;
        if (!cvs) return;
        const ctx = cvs.getContext("2d");
        if (!ctx) return;
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, 350, 450);
        if(image){
            ctx.save(); ctx.translate(175 + p.x, 225 + p.y); ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width/2, -image.height/2); ctx.restore();
        }
        if(suitImg){
            ctx.save();
            const w = 350 * sp.s; const h = (suitImg.height / suitImg.width) * w;
            ctx.drawImage(suitImg, (350 - w)/2 + sp.x, 450 - h + 15 + sp.y, w, h);
            ctx.restore();
        }
    }, [image, suitImg, p, sp]);

    const scheduleDraw = useCallback(() => {
        if (scheduledRef.current) return;
        scheduledRef.current = true;
        requestAnimationFrame(() => {
            scheduledRef.current = false;
            if (dirtyRef.current) { dirtyRef.current = false; draw(); }
        });
    }, [draw]);

    const markDirty = useCallback(() => { dirtyRef.current = true; scheduleDraw(); }, [scheduleDraw]);
    useEffect(() => { markDirty(); return () => { if (toastTimer.current) clearTimeout(toastTimer.current); }; }, [markDirty]);

    const showToast = (msg) => {
        if (toastTimer.current) clearTimeout(toastTimer.current);
        setToast(msg);
        toastTimer.current = setTimeout(() => setToast(""), 2000); 
    };

    const selectSuit = (url) => {
        if(!url) { setSuitImg(null); setActiveSuit(null); markDirty(); return; }
        const img = new Image(); img.crossOrigin = "anonymous";
        img.onload = () => { setSuitImg(img); setActiveSuit(url); markDirty(); };
        img.onerror = () => showToast("âŒ æœè£è¼‰å…¥å¤±æ•—");
        img.src = url;
    };

    const saveToSlot = () => {
        if(!image) return showToast("âš ï¸ è«‹å…ˆä¸Šå‚³ç…§ç‰‡");
        canvasRef.current.toBlob((blob) => {
            if (!blob) return showToast("âŒ å­˜å…¥å¤±æ•—");
            const url = URL.createObjectURL(blob);
            setSlots(prev => {
                const next = [url, ...prev];
                if (next.length > 10) URL.revokeObjectURL(next.pop());
                return next;
            });
            showToast("âœ… å·²å­˜å…¥æ§½ä½");
        }, "image/png");
    };

    const downloadA4 = async (mode) => {
        if(!slots.length) return showToast("âš ï¸ æ§½ä½ç‚ºç©º");
        try {
            const pc = document.createElement("canvas");
            pc.width = A4_W; pc.height = A4_H;
            const ctx = pc.getContext("2d");
            ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, A4_W, A4_H);

            const imgs = await Promise.all(slots.map(s => new Promise((res, rej) => {
                const i = new Image(); i.crossOrigin = "anonymous";
                i.onload = () => res(i); i.onerror = rej; i.src = s;
            })));

            const SAFE = Math.round(12 * DPI / 25.4);
            let imgIdx = 0;
            const renderBlock = (sw, sh, gap, startY, rows, cols) => {
                const startX = (A4_W - (cols * sw + (cols - 1) * gap)) / 2;
                for (let r = 0; r < rows; r++) {
                    const cy = startY + r * (sh + gap);
                    if (cy + sh > A4_H - SAFE) break;
                    for (let c = 0; c < cols; c++) {
                        ctx.drawImage(imgs[imgIdx % imgs.length], startX + c*(sw+gap), cy, sw, sh);
                        ctx.strokeStyle = "#000"; ctx.lineWidth = 1; ctx.strokeRect(startX + c*(sw+gap), cy, sw, sh);
                        imgIdx++;
                    }
                }
                return startY + rows * (sh + gap);
            };

            if (mode === 'ALL_2') renderBlock(413, 531, 35, SAFE, 5, 5);
            else if (mode === 'ALL_1') renderBlock(295, 413, 25, SAFE, 7, 7);
            else if (mode === 'MIX') {
                const nextY = renderBlock(413, 531, 35, SAFE, 2, 5);
                renderBlock(295, 413, 25, nextY, 4, 7);
            }

            pc.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url; a.download = `EzID_${mode}.png`; a.click();
                setTimeout(() => URL.revokeObjectURL(url), 1000);
            }, "image/png");
        } catch(e) { showToast("âŒ ä¸‹è¼‰å¤±æ•—"); }
    };

    return (
        <div className="max-w-md mx-auto p-4 pb-12">
            {toast && <div className="toast shadow-2xl">{toast}</div>}
            
            <header className="flex justify-between items-center mb-6 px-2">
                <h1 className="font-black text-slate-800 italic text-xl">EzID <span className="text-blue-600 text-[10px] not-italic border border-blue-600 px-1 rounded">v3.3.4 PRO</span></h1>
                <select value={cutMode} onChange={e=>setCutMode(e.target.value)} className="text-[10px] font-bold border rounded-lg px-2 py-1 bg-white shadow-sm outline-none">
                    <option value="FRAME_L">æ¨™æº–è£åˆ‡ç·š</option>
                    <option value="LIGHT">æ·ºè‰²è¼”åŠ©ç·š</option>
                </select>
            </header>

            <div className="canvas-container mb-6">
                <canvas ref={canvasRef} width="350" height="450" />
                <div className="absolute inset-0 pointer-events-none">
                    <div className="center-line"></div>
                    <div className="inner-guide"></div>
                    <div className="outer-guide"></div>
                </div>
            </div>

            <section className="space-y-4">
                <div className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                    <span className="text-[10px] font-bold text-slate-400 tracking-widest uppercase mb-4 block">ğŸ‘” æœè£ç´ æ</span>
                    <div className="flex gap-2 overflow-x-auto no-scrollbar mb-6">
                        <button onClick={()=>selectSuit(null)} className="flex-shrink-0 w-12 h-12 border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center text-slate-300">âœ•</button>
                        {CLOTHES.map(s => (
                            <button key={s} onClick={()=>selectSuit(s)} className={`flex-shrink-0 w-12 h-12 border-2 rounded-xl p-1 transition-all ${activeSuit===s?'border-blue-500 bg-blue-50':'border-transparent bg-slate-50'}`}>
                                <img src={s} alt="suit" className="w-full h-full object-contain"/>
                            </button>
                        ))}
                    </div>
                    {suitImg && (
                        <div className="space-y-5">
                            <RangeSlider label="å°ºå¯¸" val={sp.s} config={CONTROL_RANGES.suit.s} onChange={v=>{setSp(s=>({...s, s:v}));markDirty()}} unit="%" mul={100} />
                            <RangeSlider label="å‚ç›´ä½ç½®" val={sp.y} config={CONTROL_RANGES.suit.y} onChange={v=>{setSp(s=>({...s, y:v}));markDirty()}} />
                            <RangeSlider label="æ°´å¹³ä½ç½®" val={sp.x} config={CONTROL_RANGES.suit.x} onChange={v=>{setSp(s=>({...s, x:v}));markDirty()}} />
                        </div>
                    )}
                </div>

                <div className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                    <span className="text-[10px] font-bold text-slate-400 tracking-widest uppercase mb-4 block">ğŸ‘¤ ç…§ç‰‡èª¿æ•´</span>
                    <div className="space-y-5">
                        <RangeSlider label="ç¸®æ”¾" val={p.s} config={CONTROL_RANGES.photo.s} onChange={v=>{setP(s=>({...s, s:v}));markDirty()}} unit="%" mul={100} />
                        <div className="grid grid-cols-2 gap-4">
                            <RangeSlider label="ä¸Šä¸‹" val={p.y} config={CONTROL_RANGES.photo.y} onChange={v=>{setP(s=>({...s, y:v}));markDirty()}} />
                            <RangeSlider label="å·¦å³" val={p.x} config={CONTROL_RANGES.photo.x} onChange={v=>{setP(s=>({...s, x:v}));markDirty()}} />
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3 mt-6">
                        <label className="bg-slate-800 text-white py-4 rounded-2xl text-center font-bold text-xs cursor-pointer active:scale-95 transition-all">
                            ğŸ“¸ ä¸Šå‚³ç…§ç‰‡
                            <input type="file" hidden accept="image/*" onChange={e=>{
                                const f=e.target.files[0]; if(!f) return;
                                const url=URL.createObjectURL(f); const img=new Image();
                                img.onload=()=>{ setImage(img); URL.revokeObjectURL(url); markDirty(); showToast("âœ… ç…§ç‰‡å·²è¼‰å…¥"); e.target.value=''; }; 
                                img.src=url;
                            }}/>
                        </label>
                        <button onClick={saveToSlot} className="bg-blue-600 text-white py-4 rounded-2xl font-bold text-xs active:scale-95 shadow-lg">ğŸ“¥ å­˜å…¥æ§½ä½</button>
                    </div>
                </div>
            </section>

            <div className="mt-8">
                <div className="flex justify-between items-center mb-4 px-2">
                    <span className="text-[10px] font-bold text-slate-400 uppercase font-mono">Storage Slots ({slots.length}/10)</span>
                    <button onClick={()=>{slots.forEach(u=>URL.revokeObjectURL(u));setSlots([]);showToast("ğŸ”„ å·²æ¸…ç©º");}} className="text-[9px] text-red-500 font-bold px-3 py-1 rounded-full bg-red-50">CLEAR</button>
                </div>
                <div className="flex gap-3 overflow-x-auto no-scrollbar px-2">
                    {slots.map((url, i)=>(
                        <div key={url} className="relative flex-shrink-0">
                            <img src={url} alt="slot" className="w-16 h-20 rounded-xl border-2 border-white shadow-md object-cover active:scale-90 transition-transform" />
                            <button onClick={()=>{URL.revokeObjectURL(slots[i]); setSlots(prev=>prev.filter((_,idx)=>idx!==i));}} className="absolute -top-2 -right-2 bg-white text-red-500 w-6 h-6 rounded-full text-[10px] flex items-center justify-center border shadow-md font-bold">âœ•</button>
                        </div>
                    ))}
                </div>
            </div>

            <div className="mt-10">
                <button onClick={()=>downloadA4('MIX')} className="w-full bg-emerald-700 text-white py-4 rounded-2xl font-black text-sm shadow-xl active:scale-[0.98]">ğŸª ibon A4ï½œæ··æ’ä¸‹è¼‰</button>
            </div>
        </div>
    );
}

function RangeSlider({ label, val, config, onChange, unit="", mul=1 }) {
    const { min, max } = config;
    const percentage = ((val - min) / (max - min)) * 100;
    return (
        <div className="space-y-1.5 relative">
            <div className="flex justify-between">
                <span className="text-[9px] font-bold text-slate-400 uppercase">{label}</span>
                <span className="text-[10px] font-mono text-blue-600 font-bold">{Math.round(val * mul)}{unit}</span>
            </div>
            <div className="relative flex items-center h-6">
                <div className="absolute w-full h-1.5 bg-slate-100 rounded-full overflow-hidden">
                    <div className="h-full bg-blue-500 rounded-full transition-all duration-75" style={{ width: `${percentage}%` }} />
                </div>
                <input type="range" {...config} value={val} onInput={e=>onChange(+e.target.value)} />
            </div>
        </div>
    );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
