<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzID Taiwan Pro - Slider ç‰ˆ</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.5.3/dist/bundle.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const EzIDApp = () => {
            const [image, setImage] = useState(null);
            const [bgRemoved, setBgRemoved] = useState(null);
            const [isRemoving, setIsRemoving] = useState(false);
            const [photoList, setPhotoList] = useState([]);
            
            // --- ç‹€æ…‹ç®¡ç† (å…¨éƒ¨ä½¿ç”¨ Slider é€£å‹•) ---
            const [pX, setPX] = useState(0);    // äººåƒæ°´å¹³
            const [pY, setPY] = useState(0);    // äººåƒå‚ç›´
            const [pS, setPS] = useState(0.5);  // äººåƒå¤§å°
            
            const [suitId, setSuitId] = useState(null);
            const [sX, setSX] = useState(175);  // è¡£æœæ°´å¹³ (ä¸­é» 175)
            const [sY, setSY] = useState(250);  // è¡£æœå‚ç›´
            const [sS, setSS] = useState(0.6);  // è¡£æœå¤§å°

            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);

            // æ ¸å¿ƒç¹ªåœ–å¼•æ“ï¼šåªè¦ä»»ä½• Slider æ•¸å€¼è®Šå‹•ï¼Œç•«å¸ƒç«‹å³æ›´æ–°
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas || (!image && !bgRemoved)) return;
                const ctx = canvas.getContext('2d');
                
                // 1. åº•è‰²
                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(0, 0, 350, 450);

                // 2. ç•«äººåƒ
                const activeImg = bgRemoved || image;
                if (activeImg) {
                    ctx.save();
                    ctx.translate(175 + parseInt(pX), 225 + parseInt(pY));
                    ctx.scale(pS, pS);
                    ctx.drawImage(activeImg, -activeImg.width/2, -activeImg.height/2);
                    ctx.restore();
                }

                // 3. ç•«è¡£æœ
                if (suitId) {
                    const imgS = new Image();
                    imgS.src = `./suit-${suitId}.png`;
                    imgS.onload = () => {
                        ctx.save();
                        ctx.translate(parseInt(sX), parseInt(sY));
                        ctx.scale(sS * 2.2, sS * 2.2);
                        ctx.drawImage(imgS, -imgS.width/2, -imgS.height/2);
                        ctx.restore();
                    };
                }
            }, [image, bgRemoved, pX, pY, pS, suitId, sX, sY, sS]);

            const handleUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (f) => {
                    const img = new Image();
                    img.onload = () => { setImage(img); setBgRemoved(null); };
                    img.src = f.target.result;
                };
                reader.readAsDataURL(file);
            };

            const runRemoveBg = async () => {
                if (!image) return;
                setIsRemoving(true);
                try {
                    // ä¿®å¾©ï¼šæ­£ç¢ºèª¿ç”¨å…¨åŸŸè®Šæ•¸
                    const lib = window.imglyBackgroundRemoval;
                    const blob = await lib.removeBackground(image.src, {
                        publicPath: "https://cdn.jsdelivr.net/npm/@imgly/background-removal-data@1.5.3/dist/"
                    });
                    const img = new Image();
                    img.onload = () => { setBgRemoved(img); setIsRemoving(false); };
                    img.src = URL.createObjectURL(blob);
                } catch (e) {
                    alert("å»èƒŒæ¨¡çµ„è¼‰å…¥è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ coi-serviceworker.js æ˜¯å¦æ­£ç¢ºé‹è¡Œ");
                    setIsRemoving(false);
                }
            };

            const SliderControl = ({ label, value, min, max, step, onChange }) => (
                <div className="flex flex-col gap-1 mb-3">
                    <div className="flex justify-between text-[10px] font-bold text-gray-500 uppercase">
                        <span>{label}</span>
                        <span>{value}</span>
                    </div>
                    <input 
                        type="range" min={min} max={max} step={step} value={value} 
                        onChange={(e) => onChange(e.target.value)}
                        className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                    />
                </div>
            );

            return (
                <div className="max-w-5xl mx-auto p-4 md:p-10 flex flex-col lg:flex-row gap-8">
                    {/* å·¦å´é è¦½ */}
                    <div className="lg:w-[400px] space-y-4">
                        <div className="bg-white p-4 rounded-[2rem] shadow-2xl border-4 border-white">
                            <canvas ref={canvasRef} width={350} height={450} className="w-full rounded-xl shadow-inner" />
                            {isRemoving && <div className="text-center mt-2 text-indigo-600 font-bold animate-pulse text-sm">AI è™•ç†ä¸­...</div>}
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <button onClick={runRemoveBg} className="bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition">âœ¨ ä¸€éµå»èƒŒ</button>
                            <button onClick={() => setPhotoList([...photoList, canvasRef.current.toDataURL()])} className="bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition">âœ… åŠ å…¥æ’ç‰ˆ</button>
                        </div>
                        <div className="flex gap-2 overflow-x-auto py-2 bg-white/50 rounded-xl px-2">
                            {photoList.map((p, i) => <img key={i} src={p} className="h-20 border rounded shadow-sm bg-white" />)}
                        </div>
                    </div>

                    {/* å³å´æ‹‰æ¡¿æ§åˆ¶å€ */}
                    <div className="flex-1 bg-white p-8 rounded-[2rem] shadow-xl border border-gray-100">
                        {!image ? (
                            <div className="h-full flex flex-col items-center justify-center border-4 border-dashed border-gray-100 rounded-[2rem] p-10">
                                <input type="file" onChange={handleUpload} className="hidden" id="fileIn" />
                                <label htmlFor="fileIn" className="cursor-pointer text-center">
                                    <div className="text-6xl mb-4">ğŸ“¤</div>
                                    <p className="text-gray-400 font-bold">è«‹å…ˆä¸Šå‚³åŸå§‹ç…§ç‰‡</p>
                                </label>
                            </div>
                        ) : (
                            <div className="space-y-8">
                                <section>
                                    <h3 className="text-sm font-black text-indigo-900 mb-4 border-l-4 border-indigo-600 pl-2">äººåƒä½ç½®èª¿æ•´ (Slider)</h3>
                                    <SliderControl label="äººåƒå¤§å° (Scale)" value={pS} min="0.1" max="1.5" step="0.01" onChange={setPS} />
                                    <SliderControl label="æ°´å¹³ä½ç§» (X)" value={pX} min="-200" max="200" step="1" onChange={setPX} />
                                    <SliderControl label="å‚ç›´ä½ç§» (Y)" value={pY} min="-200" max="200" step="1" onChange={setPY} />
                                </section>

                                <section>
                                    <h3 className="text-sm font-black text-blue-900 mb-4 border-l-4 border-blue-600 pl-2">è¡£æœä½ç½®èª¿æ•´ (Slider)</h3>
                                    <SliderControl label="è¡£æœå¤§å° (Scale)" value={sS} min="0.1" max="1.5" step="0.01" onChange={setSS} />
                                    <SliderControl label="æ°´å¹³ä½ç½® (X)" value={sX} min="0" max="350" step="1" onChange={setSX} />
                                    <SliderControl label="å‚ç›´ä½ç½® (Y)" value={sY} min="0" max="450" step="1" onChange={setSY} />
                                    
                                    <div className="flex gap-2 overflow-x-auto py-4">
                                        <button onClick={() => setSuitId(null)} className="w-14 h-14 border-2 border-dashed rounded-xl flex-shrink-0 text-[10px] text-gray-400 font-bold">ç§»é™¤è¡£æœ</button>
                                        {[1, 2, 3, 4, 5].map(i => (
                                            <img key={i} src={`./suit-m${i}.png`} onClick={() => setSuitId(`m${i}`)} className={`w-14 h-14 border-2 rounded-xl p-1 bg-gray-50 cursor-pointer transition ${suitId === `m${i}` ? 'border-indigo-600 ring-4 ring-indigo-50' : 'border-transparent'}`} />
                                        ))}
                                    </div>
                                </section>

                                <button onClick={() => setImage(null)} className="w-full text-gray-400 text-xs py-2 hover:underline">é‡æ–°ä¸Šå‚³ç…§ç‰‡</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
    </script>
</body>
</html>
