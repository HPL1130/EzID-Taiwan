<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v6.0</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .canvas-container { 
            position:relative; width:340px; height:437px; margin:0 auto; 
            background:#fff; border:4px solid #0f172a; border-radius:24px; overflow:hidden; 
            touch-action: none; cursor: grab; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }
        .inner-guide { position:absolute; left:50%; top:45%; width:62%; height:71.1%; border:2px dotted #10b981; border-radius:50%/44%; transform:translate(-50%,-50%); z-index:100; pointer-events:none; }
        .outer-guide { position:absolute; left:50%; top:45%; width:70%; height:80%; border:2px dashed #f59e0b; border-radius:50%/44%; transform:translate(-50%,-50%); z-index:99; pointer-events:none; }
        .slot-item { position: relative; flex-shrink: 0; width: 110px; height: 140px; border: 3px solid #fff; border-radius: 14px; overflow: hidden; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .slot-ctrl { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.95); display: flex; justify-content: space-around; padding: 10px 0; }
        .slot-btn { color: white; font-size: 18px; cursor: pointer; }
    </style>
</head>
<body class="bg-slate-100 p-4 pb-16 font-sans select-none">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback, useMemo } = React;

const SUITS = [...Array(5).fill(0).map((_, i) => `male/m${i+1}.png`), ...Array(5).fill(0).map((_, i) => `female/f${i+1}.png`)];

function App() {
    const canvasRef = useRef(null);
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [slots, setSlots] = useState([]);
    const [target, setTarget] = useState("PHOTO");
    const [p, setP] = useState({ x: 0, y: -20, s: 0.8, f: 1 });
    const [sp, setSp] = useState({ x: 0, y: 80, s: 1.0 });
    const [bright, setBright] = useState(100);
    const [guideAlpha, setGuideAlpha] = useState(0.8);
    const [customName, setCustomName] = useState("ProID");
    const [imageUrl, setImageUrl] = useState(null);

    const isDragging = useRef(false);
    const lastPos = useRef({ x: 0, y: 0 });
    const lastDist = useRef(0); // ç”¨æ–¼ Pinch Zoom

    const draw = useCallback(() => {
        const ctx = canvasRef.current.getContext("2d");
        ctx.clearRect(0, 0, 350, 450);
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, 350, 450);
        if (image) {
            ctx.save(); ctx.filter = `brightness(${bright}%)`;
            ctx.translate(175 + p.x, 225 + p.y); ctx.scale(p.s * p.f, p.s);
            ctx.drawImage(image, -image.width/2, -image.height/2); ctx.restore();
        }
        if (suitImg) {
            ctx.save(); const w = suitImg.width * sp.s; const h = suitImg.height * sp.s;
            ctx.drawImage(suitImg, 175 - w/2 + sp.x, 225 - h/2 + sp.y, w, h); ctx.restore();
        }
    }, [image, suitImg, p, sp, bright]);

    useEffect(() => {
        const tid = requestAnimationFrame(draw);
        return () => cancelAnimationFrame(tid);
    }, [draw]);

    const handleUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (imageUrl) URL.revokeObjectURL(imageUrl);
        const url = URL.createObjectURL(file);
        setImageUrl(url);
        const img = new Image();
        img.onload = () => {
            const ratio = (350 * 0.8) / img.width;
            setImage(img); setP({ x: 0, y: -20, s: ratio, f: 1 }); setTarget("PHOTO");
        };
        img.src = url;
    };

    const handleTouchStart = (e) => {
        isDragging.current = true;
        if (e.touches.length === 2) {
            lastDist.current = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        } else {
            lastPos.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }
    };

    const handleTouchMove = (e) => {
        if (!isDragging.current) return;
        if (e.touches.length === 2) {
            const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            const delta = (dist - lastDist.current) * 0.005;
            if (target === "PHOTO") setP(v => ({ ...v, s: Math.max(0.05, v.s + delta) }));
            else setSp(v => ({ ...v, s: Math.max(0.05, v.s + delta) }));
            lastDist.current = dist;
        } else {
            const dx = (e.touches[0].clientX - lastPos.current.x) * 1.2;
            const dy = (e.touches[0].clientY - lastPos.current.y) * 1.2;
            if (target === "PHOTO") setP(v => ({ ...v, x: v.x + dx, y: v.y + dy }));
            else setSp(v => ({ ...v, x: v.x + dx, y: v.y + dy }));
            lastPos.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }
    };

    const exportDoc = async (type, mode) => {
        if (!slots.length) return alert("æ§½ä½ç‚ºç©º");
        const is46 = type === '46';
        const W = is46 ? 1800 : 2480, H = is46 ? 1200 : 3508; 
        const pc = document.createElement("canvas"); pc.width = W; pc.height = H;
        const ctx = pc.getContext("2d"); ctx.fillStyle = "white"; ctx.fillRect(0, 0, W, H);

        const imgs = await Promise.all(slots.map(s => new Promise(res => {
            const i = new Image(); i.onload = () => res(i); i.src = s.data;
        })));

        const put = (img, x, y, sw, sh) => {
            ctx.drawImage(img, x, y, sw, sh);
            ctx.strokeStyle = "#f3f4f6"; ctx.lineWidth = 1; ctx.strokeRect(x, y, sw, sh);
        };

        if (is46) {
            if (mode === 'MIX') {
                for(let i=0; i<4; i++) put(imgs[i%imgs.length], 100+i*405, 80, 413, 531);
                for(let i=0; i<5; i++) put(imgs[i%imgs.length], 100+i*325, 660, 295, 413);
            } else if (mode === '2IN') {
                for(let i=0; i<8; i++) put(imgs[i%imgs.length], 90+(i%4)*410, 70+Math.floor(i/4)*540, 413, 531);
            } else {
                for(let i=0; i<10; i++) put(imgs[i%imgs.length], 150+(i%5)*310, 160+Math.floor(i/5)*460, 295, 413);
            }
        } else {
            const startY = 200;
            if (mode === '2IN') {
                const startX = (2480 - (413*4 + 60*3)) / 2;
                for(let i=0; i<20; i++) put(imgs[i%imgs.length], startX+(i%4)*(413+60), startY+Math.floor(i/4)*(531+60), 413, 531);
            } else if (mode === '1IN') {
                const startX = (2480 - (295*6 + 50*5)) / 2;
                for(let i=0; i<42; i++) put(imgs[i%imgs.length], startX+(i%6)*(295+50), startY+Math.floor(i/6)*(413+50), 295, 413);
            } else { 
                const startX2 = (2480 - (413*4 + 60*3)) / 2;
                const startX1 = (2480 - (295*6 + 50*5)) / 2;
                for(let i=0; i<12; i++) put(imgs[i%imgs.length], startX2+(i%4)*(413+60), startY+Math.floor(i/4)*(531+60), 413, 531);
                for(let i=0; i<18; i++) put(imgs[i%imgs.length], startX1+(i%6)*(295+50), 2100+Math.floor(i/6)*(413+50), 295, 413);
            }
        }
        const dateStr = new Date().toISOString().slice(2,10).replace(/-/g,'');
        const fileName = `${dateStr}_${customName}_${type}_${mode}.png`;
        const a = document.createElement("a"); a.href = pc.toDataURL("image/png", 1.0); a.download = fileName; a.click();
    };

    return (
        <div className="max-w-md mx-auto space-y-4">
            <header className="flex justify-between items-center px-2 py-3 bg-white/50 backdrop-blur-md rounded-2xl sticky top-0 z-[200]">
                <h1 className="text-2xl font-black italic text-slate-900 tracking-tighter">EzID <span className="text-blue-600">v6.0</span></h1>
                <div className="flex gap-2">
                    <button onClick={()=>setP(v=>({...v, f: v.f*-1}))} className="px-4 py-1.5 bg-white border border-slate-200 rounded-xl text-xs font-bold shadow-sm active:bg-blue-50 transition-colors">â†” ç¿»è½‰</button>
                    <div className="flex items-center gap-2 bg-white border border-slate-200 px-3 rounded-xl shadow-sm">
                        <span className="text-[10px] font-bold text-slate-400">â˜€ï¸</span>
                        <input type="range" min="60" max="140" value={bright} onChange={(e)=>setBright(e.target.value)} className="w-16 h-1 accent-blue-600" />
                    </div>
                </div>
            </header>

            <div className="canvas-container" onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={()=>isDragging.current=false} onMouseDown={(e)=>{isDragging.current=true; lastPos.current={x:e.clientX, y:e.clientY}}} onMouseMove={(e)=>{if(!isDragging.current)return; const dx=e.clientX-lastPos.current.x; const dy=e.clientY-lastPos.current.y; if(target==='PHOTO')setP(v=>({...v,x:v.x+dx,y:v.y+dy})); else setSp(v=>({...v,x:v.x+dx,y:v.y+dy})); lastPos.current={x:e.clientX,y:e.clientY}}} onMouseUp={()=>isDragging.current=false}>
                <canvas ref={canvasRef} width="350" height="450" />
                <div className="inner-guide" style={{opacity: guideAlpha}}></div>
                <div className="outer-guide" style={{opacity: guideAlpha}}></div>
            </div>

            <div className="bg-white p-5 rounded-[2.5rem] border border-slate-200 shadow-xl space-y-4">
                <div className="flex justify-between items-center text-[10px] font-black text-slate-400 uppercase tracking-widest">
                    <span>å°å¼•ç·šæ¿ƒåº¦</span>
                    <input type="range" min="0" max="1" step="0.1" value={guideAlpha} onChange={(e)=>setGuideAlpha(e.target.value)} className="w-24 h-1 accent-emerald-500" />
                </div>
                <div className="flex justify-between items-center">
                    <div className="flex flex-col">
                        <span className="text-[10px] font-bold text-slate-400">è‡ªå®šç¾©æª”å</span>
                        <input type="text" value={customName} onChange={(e)=>setCustomName(e.target.value)} className="text-slate-800 font-bold focus:text-blue-600 outline-none w-24" />
                    </div>
                    <div className="flex bg-slate-100 p-1 rounded-2xl gap-1">
                        <button onClick={()=>setTarget("PHOTO")} className={`px-5 py-2 text-xs font-black rounded-xl transition-all ${target==='PHOTO'?'bg-white shadow-md text-blue-600':'text-slate-400'}`}>äººåƒ</button>
                        <button onClick={()=>setTarget("SUIT")} className={`px-5 py-2 text-xs font-black rounded-xl transition-all ${target==='SUIT'?'bg-white shadow-md text-blue-600':'text-slate-400'}`}>è¡£æœ</button>
                    </div>
                </div>
                <input type="range" min="0.05" max="2.5" step="0.01" value={target === "PHOTO" ? p.s : sp.s} onChange={(e) => { const val = +e.target.value; if(target === "PHOTO") setP(v => ({...v, s: val})); else setSp(v => ({...v, s: val})); }} className="w-full accent-blue-600" />
            </div>

            <div className="flex gap-3 overflow-x-auto no-scrollbar bg-white p-3 rounded-2xl border border-slate-200">
                <button onClick={()=>setSuitImg(null)} className="flex-shrink-0 w-12 h-12 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center text-slate-300">âœ•</button>
                {SUITS.map(id => (
                    <button key={id} onClick={()=>{const img=new Image(); img.onload=()=>{setSuitImg(img); setTarget("SUIT")}; img.src=`clothes/${id}`}} className="flex-shrink-0 w-12 h-12 border border-slate-100 rounded-xl overflow-hidden active:scale-90 transition-transform shadow-sm bg-white"><img src={`clothes/${id}`} className="w-full h-full object-contain" /></button>
                ))}
            </div>

            <div className="grid grid-cols-2 gap-4">
                <label className="bg-slate-900 text-white py-4 rounded-3xl text-center text-sm font-black cursor-pointer shadow-lg active:scale-95 transition-transform">ğŸ“¸ ä¸Šå‚³ç…§ç‰‡ <input type="file" hidden accept="image/*" onChange={handleUpload} /></label>
                <button onClick={() => setSlots(prev => [{ data: canvasRef.current.toDataURL("image/png", 1.0), config: { image, suitImg, p, sp, bright } }, ...prev].slice(0, 10))} className="bg-blue-600 text-white py-4 rounded-3xl text-sm font-black shadow-lg active:scale-95 transition-transform">ğŸ“¥ å­˜å…¥æ§½ä½</button>
            </div>

            <div className="bg-slate-200/50 p-5 rounded-[2.5rem] space-y-3">
                <div className="flex justify-between items-center px-1 font-black text-slate-500 text-[10px] tracking-tighter">
                    <span>æš«å­˜ç…§ç‰‡ ({slots.length}/10)</span>
                    <button onClick={() => { if(window.confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) setSlots([]) }} className="text-red-500 uppercase">Clear All</button>
                </div>
                <div className="flex gap-4 overflow-x-auto no-scrollbar py-2">
                    {slots.map((s, idx) => (
                        <div key={idx} className="slot-item border-none shadow-2xl">
                            <div className="absolute top-2 right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold z-30" onClick={() => { if(window.confirm("åˆªé™¤é€™å¼µï¼Ÿ")) setSlots(v => v.filter((_,i)=>i!==idx)) }}>Ã—</div>
                            <img src={s.data} className="w-full h-full object-cover" />
                            <div className="slot-ctrl">
                                <span className="slot-btn" onClick={() => { const ns=[...slots]; if(idx>0) [ns[idx],ns[idx-1]]=[ns[idx-1],ns[idx]]; setSlots(ns); }}>â—€</span>
                                <span className="slot-btn text-yellow-400" onClick={() => { if(window.confirm("è¼‰å…¥æ­¤ç…§ç‰‡ï¼Ÿ")) { const sc=s.config; setImage(sc.image); setSuitImg(sc.suitImg); setP({...sc.p}); setSp({...sc.sp}); setBright(sc.bright); } }}>âœ</span>
                                <span className="slot-btn" onClick={() => { const ns=[...slots]; if(idx<slots.length-1) [ns[idx],ns[idx+1]]=[ns[idx+1],ns[idx]]; setSlots(ns); }}>â–¶</span>
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            <div className="grid grid-cols-1 gap-4 pb-20">
                <div className="p-6 bg-white rounded-[2.5rem] border border-emerald-100 shadow-xl space-y-4">
                    <h3 className="text-xs font-black text-emerald-600 flex items-center gap-2">ğŸŸ¢ ibon 4x6 å°ˆæ¥­æ²–å°</h3>
                    <div className="flex gap-2">
                        <button onClick={()=>exportDoc('46','MIX')} className="flex-1 bg-emerald-600 text-white py-4 rounded-2xl text-[10px] font-black">æ··æ’ 9å¼µ</button>
                        <button onClick={()=>exportDoc('46','2IN')} className="flex-1 bg-slate-800 text-white py-4 rounded-2xl text-[10px] font-black">2å‹ 8å¼µ</button>
                        <button onClick={()=>exportDoc('46','1IN')} className="flex-1 bg-slate-800 text-white py-4 rounded-2xl text-[10px] font-black">1å‹ 10å¼µ</button>
                    </div>
                </div>
                <div className="p-6 bg-white rounded-[2.5rem] border border-blue-100 shadow-xl space-y-4">
                    <h3 className="text-xs font-black text-blue-600 flex items-center gap-2">ğŸ”µ A4 Paper å®Œç¾ç½®ä¸­</h3>
                    <div className="flex gap-2">
                        <button onClick={()=>exportDoc('A4','MIX')} className="flex-1 bg-blue-600 text-white py-4 rounded-2xl text-[10px] font-black">æ··æ’ 30å¼µ</button>
                        <button onClick={()=>exportDoc('A4','2IN')} className="flex-1 bg-slate-600 text-white py-4 rounded-2xl text-[10px] font-black">2å‹ 20å¼µ</button>
                        <button onClick={()=>exportDoc('A4','1IN')} className="flex-1 bg-slate-600 text-white py-4 rounded-2xl text-[10px] font-black">1å‹ 42å¼µ</button>
                    </div>
                </div>
            </div>
        </div>
    );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
