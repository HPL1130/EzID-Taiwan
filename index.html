<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.47.34 - Core Restored</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background: #020617; color: #f8fafc; margin: 0; }
        #root { width: 100%; max-width: 500px; margin: 0 auto; min-height: 100vh; padding: 15px; }
        .zone-box { background: rgba(30, 41, 59, 0.4); border-radius: 24px; border: 1px solid rgba(255,255,255,0.05); padding: 16px; margin-bottom: 12px; }
        .zone-tag { font-size: 10px; font-weight: 900; color: #3b82f6; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .stage-box { position: relative; width: 100%; aspect-ratio: 350/450; background: #fff; border-radius: 16px; overflow: hidden; touch-action: none; }
        .guide-circle { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 65%; border: 2px dashed rgba(59, 130, 246, 0.4); border-radius: 50%; pointer-events: none; z-index: 10; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useMemo } = React;

// =======================================================
// [Zone 1: Spec Contract - è¦æ ¼å¥‘ç´„å€]
// =======================================================
const SPECS = {
    '4x6-8':   { id: '4x6-8',   w: 1800, h: 1200, grid: [2, 4], size: [413, 531], name: '2å‹(8)', cat: '4x6' },
    '4x6-10':  { id: '4x6-10',  w: 1800, h: 1200, grid: [2, 5], size: [295, 413], name: '1å‹(10)', cat: '4x6' },
    '4x6-12':  { id: '4x6-12',  w: 1800, h: 1200, grid: [3, 4], size: [295, 413], name: '1å‹(12)', cat: '4x6' },
    '4x6-BIG': { id: '4x6-BIG', w: 1800, h: 1200, grid: [2, 3], size: [531, 708], name: 'å¤§é ­(6)', cat: '4x6' },
    '4x6-MIX': { id: '4x6-MIX', w: 1800, h: 1200, name: 'ç¶œåˆ(8)', cat: '4x6', sections: [{ x: 0, grid: [2, 2], size: [450, 600], count: 4, w: 900, h: 1200 }, { x: 900, grid: [2, 2], size: [413, 531], count: 4, w: 900, h: 1200 }] },
    'A4-20':   { id: 'A4-20',   w: 2480, h: 3508, grid: [5, 4], size: [413, 531], name: '2å‹(20)', cat: 'A4' },
    'A4-42':   { id: 'A4-42',   w: 2480, h: 3508, grid: [7, 6], size: [295, 413], name: '1å‹(42)', cat: 'A4' },
    'A4-ID':   { id: 'A4-ID',   w: 2480, h: 3508, grid: [4, 4], size: [450, 600], name: 'è­·ç…§(16)', cat: 'A4' },
    'A4-BIG':  { id: 'A4-BIG',  w: 2480, h: 3508, grid: [4, 3], size: [531, 708], name: 'å¤§é ­(12)', cat: 'A4' },
    'A4-B':    { id: 'A4-B',    w: 2480, h: 3508, grid: [6, 5], size: [354, 472], name: 'Bç‰ˆ(30)', cat: 'A4' },
    'NAME':    { id: 'NAME',    w: 2480, h: 3508, grid: [6, 4], size: [295, 413], name: 'å·¥ç‰Œ(24)', cat: 'A4' },
    'A4-MIX':  { id: 'A4-MIX',  w: 2480, h: 3508, name: 'ç¶œåˆ(30)', cat: 'A4', sections: [{ y: 0, grid: [3, 4], size: [413, 531], count: 12, w: 2480, h: 1754 }, { y: 1754, grid: [3, 6], size: [295, 413], count: 18, w: 2480, h: 1754 }] }
};

const SUITS = {
    female: Array.from({length: 5}, (_, i) => `https://raw.githubusercontent.com/HPL1130/EzID-Taiwan/main/clothes/female/f${i+1}.png`),
    male: Array.from({length: 5}, (_, i) => `https://raw.githubusercontent.com/HPL1130/EzID-Taiwan/main/clothes/male/m${i+1}.png`)
};

function App() {
    const cvsRef = useRef(null);
    const drag = useRef({ active: false, x: 0, y: 0 });

    // =======================================================
    // [Zone 2: Data State - æ•¸æ“šä¸­å¿ƒ]
    // =======================================================
    const [assets, setAssets] = useState({ img: null, suit: null });
    const [params, setParams] = useState({ 
        photo: { x: 0, y: 0, s: 0.5, r: 0, f: 1 }, 
        suit: { x: 0, y: 80, s: 0.8, r: 0, f: 1 } 
    });
    const [history, setHistory] = useState([]);
    const [ui, setUi] = useState({ target: 'photo', spec: '4x6-8', gender: 'female', results: null });

    // =======================================================
    // [Zone 3: Canvas Engine - ç¹ªåœ–å¼•æ“]
    // =======================================================
    const drawLayer = (ctx, img, p, rect, baseW=350) => {
        if(!img) return;
        const r = rect.w / baseW;
        ctx.save();
        ctx.beginPath(); ctx.rect(rect.x, rect.y, rect.w, rect.h); ctx.clip();
        ctx.translate(rect.x + rect.w/2 + p.x*r, rect.y + rect.h/2 + p.y*r);
        ctx.rotate(p.r * Math.PI / 180);
        ctx.scale(p.s * r * (p.f || 1), p.s * r);
        ctx.drawImage(img, -img.width/2, -img.height/2);
        ctx.restore();
    };

    useEffect(() => {
        const tick = () => {
            if(!cvsRef.current) return;
            const ctx = cvsRef.current.getContext('2d');
            ctx.fillStyle = "white"; ctx.fillRect(0, 0, 350, 450);
            drawLayer(ctx, assets.img, params.photo, {x:0, y:0, w:350, h:450});
            drawLayer(ctx, assets.suit, params.suit, {x:0, y:0, w:350, h:450});
            requestAnimationFrame(tick);
        };
        const id = requestAnimationFrame(tick); return () => cancelAnimationFrame(id);
    }, [assets, params]);

    // =======================================================
    // [Zone 4: Photo & Cache - è¼‰å…¥/æš«å­˜å€]
    // =======================================================
    const onPhotoIn = (e) => {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const i = new Image(); i.onload = () => {
                const newAssets = { ...assets, img: i }; // âš ï¸ ä¿®æ­£ï¼šä¿ç•™ç¾æœ‰è¡£æœ
                setAssets(newAssets);
                setTimeout(() => {
                    const snap = cvsRef.current.toDataURL('image/jpeg', 0.2);
                    setHistory(h => [{ thumb: snap, assets: newAssets, params, id: Date.now() }, ...h].slice(0, 10));
                }, 200);
            }; i.src = ev.target.result;
        }; reader.readAsDataURL(file);
    };

    // =======================================================
    // [Zone 5: Suit & Alignment - è¡£æœ/èª¿æ•´å€]
    // =======================================================
    const onSuitSelect = (url) => {
        const i = new Image(); i.crossOrigin = "anonymous";
        i.onload = () => setAssets(prev => ({ ...prev, suit: i })); // âš ï¸ ä¿®æ­£ï¼šä¿ç•™ç¾æœ‰äººåƒ
        i.src = url;
    };

    // =======================================================
    // [Zone 6: Output System - è¼¸å‡ºå€]
    // =======================================================
    const handleExport = async (all) => {
        if(!assets.img) return alert("è«‹å…ˆè¼‰å…¥äººç‰©");
        const list = all ? Object.keys(SPECS) : [ui.spec];
        const res = [];
        for(let id of list) {
            const s = SPECS[id];
            const c = document.createElement('canvas'); c.width = s.w; c.height = s.h;
            const ctx = c.getContext('2d'); ctx.fillStyle = "white"; ctx.fillRect(0,0,s.w,s.h);
            const layout = s.sections ? s.sections.flatMap(sec => {
                const arr = [];
                const gx = ((sec.w||s.w)-sec.grid[1]*sec.size[0])/(sec.grid[1]+1);
                const gy = ((sec.h||s.h)-sec.grid[0]*sec.size[1])/(sec.grid[0]+1);
                for(let r=0; r<sec.grid[0]; r++) for(let c=0; c<sec.grid[1]; c++) if(arr.length<sec.count) arr.push({x:(sec.x||0)+gx+c*(sec.size[0]+gx), y:(sec.y||0)+gy+r*(sec.size[1]+gy), w:sec.size[0], h:sec.size[1]});
                return arr;
            }) : (() => {
                const arr = [];
                const gx = (s.w-s.grid[1]*s.size[0])/(s.grid[1]+1), gy = (s.h-s.grid[0]*s.size[1])/(s.grid[0]+1);
                for(let r=0; r<s.grid[0]; r++) for(let c=0; c<s.grid[1]; c++) arr.push({x:gx+c*(s.size[0]+gx), y:gy+r*(s.size[1]+gy), w:s.size[0], h:s.size[1]});
                return arr;
            })();
            layout.forEach(rect => { drawLayer(ctx, assets.img, params.photo, rect); drawLayer(ctx, assets.suit, params.suit, rect); });
            res.push({ url: c.toDataURL('image/jpeg', 0.8), name: s.name, id });
        }
        setUi(u => ({...u, results: res}));
    };

    return (
        <div className="flex flex-col gap-3">
            <header className="flex justify-between items-center px-1">
                <h1 className="text-2xl font-black italic text-blue-500">EzID</h1>
                <span className="text-[10px] font-bold text-slate-500 bg-slate-800 px-2 py-1 rounded">V20.47.34</span>
            </header>

            {/* é è¦½èˆ‡å°é½Šå€ */}
            <div className="stage-box shadow-2xl"
                onPointerDown={e => { drag.current = { active: true, x: e.clientX, y: e.clientY }; e.target.setPointerCapture(e.pointerId); }}
                onPointerMove={e => {
                    if(!drag.current.active) return;
                    const dx = (e.clientX - drag.current.x)/params[ui.target].s;
                    const dy = (e.clientY - drag.current.y)/params[ui.target].s;
                    setParams(p => ({...p, [ui.target]: {...p[ui.target], x: p[ui.target].x+dx, y: p[ui.target].y+dy}}));
                    drag.current.x = e.clientX; drag.current.y = e.clientY;
                }}
                onPointerUp={() => drag.current.active = false}>
                <canvas ref={cvsRef} width="350" height="450" className="w-full h-full" />
                <div className="guide-circle"></div>
            </div>

            {/* è¼‰å…¥èˆ‡æš«å­˜å€ */}
            <div className="zone-box">
                <div className="zone-tag">ğŸ“¸ è¼‰å…¥èˆ‡äººåƒæš«å­˜</div>
                <label className="block w-full py-3 bg-white text-black text-center rounded-xl font-black text-xs cursor-pointer active:scale-95 transition-all">é¸æ“‡æ–°äººç‰©ç…§ç‰‡<input type="file" hidden accept="image/*" onChange={onPhotoIn}/></label>
                {history.length > 0 && (
                    <div className="flex gap-2 mt-3 overflow-x-auto no-scrollbar">
                        {history.map(h => (
                            <img key={h.id} src={h.thumb} onClick={() => { setAssets(h.assets); setParams(h.params); }} className={`w-12 h-12 rounded-lg border-2 flex-shrink-0 object-cover ${assets.img === h.assets.img ? 'border-blue-500' : 'border-slate-800'}`} />
                        ))}
                    </div>
                )}
            </div>

            {/* è¡£æœé¸å–å€ */}
            <div className="zone-box">
                <div className="zone-tag">ğŸ‘• è¡£æœé¸å–</div>
                <div className="flex gap-1 mb-2">
                    {['female', 'male'].map(g => (
                        <button key={g} onClick={() => setUi(u => ({...u, gender: g}))} className={`flex-1 py-1 rounded-md text-[9px] font-black uppercase ${ui.gender === g ? 'bg-blue-600' : 'bg-slate-800 text-slate-500'}`}>{g}</button>
                    ))}
                </div>
                <div className="flex gap-2 overflow-x-auto no-scrollbar">
                    <button onClick={() => setAssets(a => ({...a, suit: null}))} className="w-10 h-10 bg-red-900/20 text-red-500 rounded-lg flex-shrink-0 text-[10px] font-bold">ç§»é™¤</button>
                    {SUITS[ui.gender].map(url => (
                        <img key={url} src={url} onClick={() => onSuitSelect(url)} className="w-10 h-10 bg-white rounded-lg p-1 flex-shrink-0 active:ring-2 ring-blue-500 border border-slate-700" />
                    ))}
                </div>
            </div>

            {/* ç§»å‹•èª¿æ•´å€ */}
            <div className="zone-box">
                <div className="zone-tag">ğŸ•¹ï¸ ç§»å‹•èª¿æ•´ (åˆ‡æ›ç›®æ¨™)</div>
                <div className="flex gap-2 mb-3">
                    {['photo', 'suit'].map(t => (
                        <button key={t} onClick={() => setUi(u => ({...u, target: t}))} className={`flex-1 py-3 rounded-xl text-[10px] font-black uppercase ${ui.target === t ? 'bg-blue-600' : 'bg-slate-800 text-slate-500'}`}>{t==='photo'?'èª¿æ•´äººç‰©':'èª¿æ•´è¡£æœ'}</button>
                    ))}
                </div>
                <input type="range" min="0.1" max="2" step="0.01" value={params[ui.target].s} onChange={e => setParams(p => ({...p, [ui.target]: {...p[ui.target], s: parseFloat(e.target.value)}}))} className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none accent-blue-500 mb-3" />
                <div className="grid grid-cols-2 gap-2">
                    <button onClick={() => setParams(p => ({...p, [ui.target]: {...p[ui.target], r: p[ui.target].r+90}}))} className="py-2 bg-slate-800 rounded-lg text-[10px] font-bold">æ—‹è½‰ 90Â°</button>
                    <button onClick={() => setParams(p => ({...p, [ui.target]: {...p[ui.target], f: p[ui.target].f*-1}}))} className="py-2 bg-slate-800 rounded-lg text-[10px] font-bold">æ°´å¹³é¡åƒ</button>
                </div>
            </div>

            {/* ç‰ˆé¢èˆ‡è¼¸å‡ºå€ */}
            <div className="zone-box">
                <div className="zone-tag">ğŸ“ ç‰ˆé¢è¦æ ¼èˆ‡è¼¸å‡º</div>
                <div className="flex flex-wrap gap-1 mb-3">
                    {Object.values(SPECS).map(s => (
                        <button key={s.id} onClick={() => setUi(u => ({...u, spec: s.id}))} className={`px-2 py-2 rounded-lg text-[9px] font-bold flex-1 min-w-[70px] ${ui.spec === s.id ? 'bg-blue-600' : 'bg-slate-800 text-slate-500'}`}>{s.name}</button>
                    ))}
                </div>
                <div className="grid grid-cols-2 gap-2">
                    <button onClick={() => handleExport(false)} className="py-5 bg-blue-600 rounded-2xl font-black text-xs">å°å‡ºç›®å‰ç‰ˆé¢</button>
                    <button onClick={() => handleExport(true)} className="py-5 bg-orange-600 rounded-2xl font-black text-xs">12 ç¨®å…¨å‡º</button>
                </div>
            </div>

            {/* è‡ªæª¢å€ */}
            <div className="text-[9px] font-black text-slate-700 flex justify-between px-2 uppercase tracking-tighter">
                <span>Specs: 12 Check OK</span>
                <span>Mix Sections: Active</span>
                <span>Auto Cache: Running</span>
            </div>

            {/* çµæœå±•ç¤º Overlay */}
            {ui.results && (
                <div className="fixed inset-0 bg-slate-950 z-[999] overflow-y-auto p-4 flex flex-col items-center">
                    <div className="w-full max-w-sm space-y-4 pb-20">
                        <p className="text-center text-blue-500 font-black">BATCH EXPORT READY</p>
                        {ui.results.map((r, i) => (
                            <div key={i} className="bg-slate-900 p-4 rounded-3xl space-y-3">
                                <p className="text-[10px] text-slate-500 font-black">{r.name}</p>
                                <img src={r.url} className="w-full rounded-xl" />
                                <a href={r.url} download={`EzID_${r.id}.jpg`} className="block w-full py-4 bg-blue-600 rounded-2xl text-center font-black text-xs uppercase">Save to device</a>
                            </div>
                        ))}
                    </div>
                    <button onClick={() => setUi(u => ({...u, results: null}))} className="fixed bottom-6 w-48 py-4 bg-white text-black rounded-full font-black">BACK TO EDIT</button>
                </div>
            )}
        </div>
    );
}
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
