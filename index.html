<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.14 å®Œå…¨é«” | å°ç£è­‰ç…§æ——è‰¦</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face { font-family: 'NotoSansTC'; src: local('Noto Sans TC'), local('Microsoft JhengHei'), system-ui; font-weight: 700; }
        body { font-family: 'NotoSansTC', sans-serif; }
        .canvas-shadow { box-shadow: 0 30px 60px -12px rgba(0,0,0,0.3); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-ring { ring: 4px; ring-color: #3b82f6; ring-offset: 2px; }
    </style>
</head>
<body class="bg-[#f8fafc] min-h-screen pb-20">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback, useTransition } = React;

const PRINT_SPECS = {
    'A4-20': { w: 2480, h: 3508, photos: 20, grid: [5, 4], size: [413, 531], name: 'A4-2å‹(20å¼µ)' },
    'A4-42': { w: 2480, h: 3508, photos: 42, grid: [7, 6], size: [295, 413], name: 'A4-1å‹(42å¼µ)' },
    'A4-MIX': { w: 2480, h: 3508, type: 'MIX', name: 'A4-ç¶œåˆç‰ˆ(30å¼µ)' },
    '4x6-8':  { w: 1800, h: 1200, photos: 8,  grid: [2, 4], size: [413, 531], name: '4x6-2å‹(8å¼µ)' },
    '4x6-10': { w: 1800, h: 1200, photos: 10, grid: [2, 5], size: [295, 413], name: '4x6-1å‹(10å¼µ)' },
    'NAME': { w: 2480, h: 3508, photos: 24, grid: [6, 4], size: [295, 413], special: 'NAME', name: 'å§“åå·¥ç‰Œç‰ˆ' }
};

const SUITS = {
    male: [1,2,3,4,5],
    female: [1,2,3,4,5]
};

function App() {
    const [isPending, startTransition] = useTransition();
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [gender, setGender] = useState('male');
    const [target, setTarget] = useState('PHOTO'); // PHOTO or SUIT
    
    // ğŸ‘¤ äººç‰©èˆ‡è¥¿è£ç¨ç«‹è®Šæ›çŸ©é™£
    const [photoT, setPhotoT] = useState({ x: 0, y: -20, s: 0.45, r: 0 });
    const [suitT, setSuitT] = useState({ x: 0, y: 80, s: 1.0, r: 0 });
    
    const [slots, setSlots] = useState([]);
    const [progress, setProgress] = useState(0);
    const [preview, setPreview] = useState(null);
    
    const canvasRef = useRef(null);
    const dragRef = useRef({ active: false, x: 0, y: 0 });

    // âœ… ç¹ªè£½å–®å¼µé‚è¼¯ (ç”¨æ–¼é è¦½èˆ‡å°å‡º)
    const drawSingle = (ctx, img, sImg, pT, sT, x, y, pw, ph, isExport = false) => {
        const ratio = isExport ? pw / 350 : 1;
        ctx.save();
        ctx.beginPath(); ctx.rect(x, y, pw, ph); ctx.clip();

        // 1. ç•«äººåƒ
        if (img) {
            ctx.save();
            ctx.translate(x + pw/2 + pT.x * ratio, y + ph/2 + pT.y * ratio);
            ctx.rotate(pT.r * Math.PI / 180);
            ctx.scale(pT.s * ratio, pT.s * ratio);
            ctx.drawImage(img, -img.width/2, -img.height/2);
            ctx.restore();
        }
        // 2. ç•«è¥¿è£
        if (sImg) {
            ctx.save();
            ctx.translate(x + pw/2 + sT.x * ratio, y + ph/2 + sT.y * ratio);
            ctx.rotate(sT.r * Math.PI / 180);
            ctx.scale(sT.s * ratio, sT.s * ratio);
            ctx.drawImage(sImg, -sImg.width/2, -sImg.height/2);
            ctx.restore();
        }
        ctx.restore();
    };

    // ğŸ¨ å¯¦æ™‚æ¸²æŸ“
    useEffect(() => {
        const ctx = canvasRef.current?.getContext('2d');
        if (!ctx) return;
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, 350, 450);
        drawSingle(ctx, image, suitImg, photoT, suitT, 0, 0, 350, 450);
        
        // å°å¼•ç·š
        ctx.strokeStyle = "rgba(16, 185, 129, 0.5)"; ctx.lineWidth = 2; ctx.setLineDash([5, 5]);
        ctx.strokeRect(50, 50, 250, 350); ctx.setLineDash([]);
    }, [image, suitImg, photoT, suitT]);

    // ğŸ–±ï¸ äº¤äº’é‚è¼¯
    const handlePointerDown = (e) => {
        e.target.setPointerCapture(e.pointerId);
        dragRef.current = { active: true, x: e.clientX, y: e.clientY };
    };

    const handlePointerMove = (e) => {
        if (!dragRef.current.active) return;
        const dx = (e.clientX - dragRef.current.x) * 0.8;
        const dy = (e.clientY - dragRef.current.y) * 0.8;

        if (target === 'PHOTO') setPhotoT(t => ({ ...t, x: t.x + dx, y: t.y + dy }));
        else setSuitT(t => ({ ...t, x: t.x + dx, y: t.y + dy }));
        
        dragRef.current.x = e.clientX;
        dragRef.current.y = e.clientY;
    };

    // ğŸ–¨ï¸ é«˜æ¸…ç”Ÿç”¢å¼•æ“
    const handleExport = (specKey) => {
        if (!image) return alert("è«‹å…ˆä¸Šå‚³ç…§ç‰‡");
        const spec = PRINT_SPECS[specKey];
        startTransition(async () => {
            const canvas = document.createElement('canvas');
            canvas.width = spec.w; canvas.height = spec.h;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, spec.w, spec.h);

            const drawLoop = async (photos, grid, size, offsetH = 0) => {
                const [rows, cols] = grid; const [pw, ph] = size;
                const mx = (spec.w - cols * pw) / (cols + 1);
                const my = (spec.h - rows * ph) / (rows + 1);
                for (let i = 0; i < photos; i++) {
                    const r = Math.floor(i / cols); const c = i % cols;
                    const x = mx + c * (pw + mx); const y = offsetH + my + r * (ph + my);
                    const state = slots[i]?.state || { photoT, suitT };
                    drawSingle(ctx, image, suitImg, state.photoT, state.suitT, x, y, pw, ph, true);
                    ctx.strokeStyle = "#ddd"; ctx.lineWidth = 2; ctx.strokeRect(x, y, pw, ph);
                    if (spec.special === 'NAME') {
                        ctx.fillStyle = "#f1f5f9"; ctx.fillRect(x, y+ph+5, pw, 35);
                        ctx.fillStyle = "#000"; ctx.font = "bold 24px NotoSansTC"; ctx.textAlign="center";
                        ctx.fillText(`å“¡å·¥ ${i+1}`, x+pw/2, y+ph+30);
                    }
                    setProgress(Math.round(((i+1)/photos)*100));
                    await new Promise(r => requestAnimationFrame(r));
                }
            };

            if (spec.type === 'MIX') {
                await drawLoop(12, [3, 4], [413, 531]); // ä¸ŠåŠ2å‹
                await drawLoop(18, [3, 6], [295, 413], spec.h * 0.45); // ä¸‹åŠ1å‹
            } else {
                await drawLoop(spec.photos, spec.grid, spec.size);
            }

            setPreview(canvas.toDataURL('image/jpeg', 0.92));
            setProgress(0);
        });
    };

    return (
        <div className="max-w-md mx-auto p-4 space-y-6">
            <div className="text-center pt-4">
                <h1 className="text-3xl font-black text-slate-900">EzID <span className="text-blue-600">v20.14</span></h1>
                <p className="text-slate-500 font-bold text-sm">å®Œå…¨é«”æ——è‰¦ç‰ˆ â€¢ ç¨ç«‹åœ–å±¤èª¿æ•´</p>
            </div>

            {/* ç•«å¸ƒ */}
            <div className="flex justify-center">
                <canvas ref={canvasRef} width="350" height="450" 
                    className="canvas-shadow rounded-[2.5rem] bg-white touch-none border-8 border-white"
                    onPointerDown={handlePointerDown} onPointerMove={handlePointerMove}
                    onPointerUp={() => dragRef.current.active = false} />
            </div>

            {/* æ§åˆ¶åˆ‡æ› */}
            <div className="flex bg-slate-200 p-1 rounded-2xl shadow-inner">
                <button onClick={()=>setTarget('PHOTO')} className={`flex-1 py-3 rounded-xl font-black transition-all ${target==='PHOTO'?'bg-white text-blue-600 shadow-md scale-105':'text-slate-500'}`}>ğŸ‘¤ èª¿æ•´äººç‰©</button>
                <button onClick={()=>setTarget('SUIT')} className={`flex-1 py-3 rounded-xl font-black transition-all ${target==='SUIT'?'bg-white text-blue-600 shadow-md scale-105':'text-slate-500'}`}>ğŸ‘” èª¿æ•´è¥¿è£</button>
            </div>

            {/* åƒæ•¸å¾®èª¿ */}
            <div className="bg-white rounded-3xl p-6 shadow-sm border space-y-4">
                <div className="flex justify-between items-center font-bold text-slate-700">
                    <span>ğŸ” {target==='PHOTO'?'äººç‰©':'è¥¿è£'}ç¸®æ”¾</span>
                    <span className="text-blue-600">{(target==='PHOTO'?photoT.s:suitT.s).toFixed(2)}x</span>
                </div>
                <input type="range" min="0.1" max="1.5" step="0.01" 
                    value={target==='PHOTO'?photoT.s:suitT.s}
                    onChange={e => {
                        const val = parseFloat(e.target.value);
                        if(target==='PHOTO') setPhotoT(t=>({...t, s: val}));
                        else setSuitT(t=>({...t, s: val}));
                    }} className="w-full h-2 bg-slate-100 rounded-lg accent-blue-600" />
            </div>

            {/* ğŸ‘” è¥¿è£é¸æ“‡å™¨ */}
            <div className="bg-white rounded-3xl p-6 shadow-sm border space-y-4">
                <div className="flex gap-2 mb-2">
                    <button onClick={()=>setGender('male')} className={`flex-1 py-2 rounded-xl font-bold ${gender==='male'?'bg-slate-800 text-white':'bg-slate-100'}`}>ç”·å£«è¥¿è£</button>
                    <button onClick={()=>setGender('female')} className={`flex-1 py-2 rounded-xl font-bold ${gender==='female'?'bg-slate-800 text-white':'bg-slate-100'}`}>å¥³å£«è¥¿è£</button>
                </div>
                <div className="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                    <button onClick={()=>setSuitImg(null)} className="flex-shrink-0 w-16 h-16 bg-red-50 text-red-500 rounded-2xl font-black border-2 border-dashed border-red-200">ç§»é™¤</button>
                    {SUITS[gender].map(num => (
                        <div key={num} onClick={()=>{
                            const img = new Image();
                            img.onload = () => { setSuitImg(img); setTarget('SUIT'); };
                            img.src = `https://ezid-assets.pages.dev/clothes/${gender}/${num}.png`; // å‡è¨­è³‡ç”¢è·¯å¾‘
                        }} className="flex-shrink-0 w-16 h-16 bg-slate-50 rounded-2xl border-2 hover:border-blue-500 cursor-pointer flex items-center justify-center font-bold text-xs text-slate-400">
                            å¥—è£{num}
                        </div>
                    ))}
                </div>
            </div>

            {/* ä¸Šå‚³èˆ‡å„²å­˜ */}
            <div className="grid grid-cols-2 gap-4">
                <label className="flex items-center justify-center bg-slate-900 text-white h-20 rounded-[2rem] font-black cursor-pointer shadow-xl hover:bg-black transition-all">
                    ğŸ“¸ ä¸Šå‚³ç…§ç‰‡
                    <input type="file" hidden accept="image/*" onChange={e => {
                        const file = e.target.files[0];
                        if (file) {
                            const url = URL.createObjectURL(file);
                            const img = new Image();
                            img.onload = () => { setImage(img); URL.revokeObjectURL(url); setPhotoT({x:0,y:-20,s:0.45,r:0}); };
                            img.src = url;
                        }
                    }} />
                </label>
                <button onClick={() => setSlots([{state:{photoT, suitT}}, ...slots.slice(0, 41)])}
                    disabled={!image} className="bg-blue-600 text-white h-20 rounded-[2rem] font-black shadow-xl disabled:opacity-50">
                    ğŸ’¾ å„²å­˜ä½ ({slots.length})
                </button>
            </div>

            {/* è¦æ ¼è¼¸å‡º */}
            <div className="bg-white rounded-3xl p-6 shadow-sm border">
                <h3 className="font-black text-slate-800 mb-4">ğŸ–¨ï¸ å°ˆæ¥­åˆ—å°è¼¸å‡º (JPEG 300dpi)</h3>
                {isPending && <div className="mb-4 h-2 bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-blue-600 transition-all" style={{width:`${progress}%`}}/></div>}
                <div className="grid grid-cols-2 gap-2">
                    {Object.entries(PRINT_SPECS).map(([key, spec]) => (
                        <button key={key} onClick={()=>handleExport(key)} disabled={!image || isPending}
                            className="h-14 bg-slate-50 border border-slate-200 rounded-2xl font-bold text-slate-700 text-xs hover:bg-blue-50 transition-all">
                            {spec.name}
                        </button>
                    ))}
                </div>
            </div>

            {/* é«˜æ¸…é è¦½ */}
            {preview && (
                <div className="fixed inset-0 bg-black/95 z-[9999] flex flex-col p-6 overflow-hidden">
                    <div className="flex-1 flex items-center justify-center overflow-auto py-10">
                        <img src={preview} className="max-w-full max-h-full border-[12px] border-white shadow-2xl" />
                    </div>
                    <div className="flex gap-4">
                        <button onClick={()=>setPreview(null)} className="flex-1 h-16 bg-slate-700 text-white rounded-2xl font-black">è¿”å›</button>
                        <a href={preview} download={`EzID_Print.jpg`} className="flex-1 h-16 bg-emerald-600 text-white rounded-2xl font-black flex items-center justify-center">ä¸‹è¼‰ JPG</a>
                    </div>
                </div>
            )}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
