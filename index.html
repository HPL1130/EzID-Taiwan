<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.47.32 - Code Modularized</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background: #020617; color: #f8fafc; margin: 0; }
        #root { width: 100%; max-width: 500px; margin: 0 auto; min-height: 100vh; padding: 20px; }
        .stage-box { position: relative; width: 100%; aspect-ratio: 350/450; background: #fff; border-radius: 20px; overflow: hidden; touch-action: none; }
        .guide-circle { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 65%; border: 2px dashed rgba(59, 130, 246, 0.4); border-radius: 50%; pointer-events: none; z-index: 10; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useMemo } = React;

// =======================================================
// [Zone 1: ç‰ˆé¢è¦æ ¼å€ (Spec Contract)]
// =======================================================
const SPECS = {
    '4x6-8':   { id: '4x6-8',   w: 1800, h: 1200, grid: [2, 4], size: [413, 531], name: '2å‹(8)', cat: '4x6' },
    '4x6-10':  { id: '4x6-10',  w: 1800, h: 1200, grid: [2, 5], size: [295, 413], name: '1å‹(10)', cat: '4x6' },
    '4x6-12':  { id: '4x6-12',  w: 1800, h: 1200, grid: [3, 4], size: [295, 413], name: '1å‹(12)', cat: '4x6' },
    '4x6-BIG': { id: '4x6-BIG', w: 1800, h: 1200, grid: [2, 3], size: [531, 708], name: 'å¤§é ­(6)', cat: '4x6' },
    '4x6-MIX': { id: '4x6-MIX', w: 1800, h: 1200, name: 'ç¶œåˆ(8)', cat: '4x6', sections: [{ x: 0, grid: [2, 2], size: [450, 600], count: 4, w: 900, h: 1200 }, { x: 900, grid: [2, 2], size: [413, 531], count: 4, w: 900, h: 1200 }] },
    'A4-20':   { id: 'A4-20',   w: 2480, h: 3508, grid: [5, 4], size: [413, 531], name: '2å‹(20)', cat: 'A4' },
    'A4-42':   { id: 'A4-42',   w: 2480, h: 3508, grid: [7, 6], size: [295, 413], name: '1å‹(42)', cat: 'A4' },
    'A4-ID':   { id: 'A4-ID',   w: 2480, h: 3508, grid: [4, 4], size: [450, 600], name: 'è­·ç…§(16)', cat: 'A4' },
    'A4-BIG':  { id: 'A4-BIG',  w: 2480, h: 3508, grid: [4, 3], size: [531, 708], name: 'å¤§é ­(12)', cat: 'A4' },
    'A4-B':    { id: 'A4-B',    w: 2480, h: 3508, grid: [6, 5], size: [354, 472], name: 'Bç‰ˆ(30)', cat: 'A4' },
    'NAME':    { id: 'NAME',    w: 2480, h: 3508, grid: [6, 4], size: [295, 413], name: 'å·¥ç‰Œ(24)', cat: 'A4' },
    'A4-MIX':  { id: 'A4-MIX',  w: 2480, h: 3508, name: 'ç¶œåˆ(30)', cat: 'A4', sections: [{ y: 0, grid: [3, 4], size: [413, 531], count: 12, w: 2480, h: 1754 }, { y: 1754, grid: [3, 6], size: [295, 413], count: 18, w: 2480, h: 1754 }] }
};

// =======================================================
// [Zone 2: è¼‰å…¥èˆ‡æš«å­˜å€ (Asset & Cache)]
// =======================================================
const SUITS = {
    female: Array.from({length: 5}, (_, i) => `https://raw.githubusercontent.com/HPL1130/EzID-Taiwan/main/clothes/female/f${i+1}.png`),
    male: Array.from({length: 5}, (_, i) => `https://raw.githubusercontent.com/HPL1130/EzID-Taiwan/main/clothes/male/m${i+1}.png`)
};

function App() {
    const cvsRef = useRef(null);
    const [assets, setAssets] = useState({ img: null, suit: null });
    const [history, setHistory] = useState([]); // æš«å­˜å€

    // =======================================================
    // [Zone 3: ç§»å‹•æ§åˆ¶åƒæ•¸ (Move & Control)]
    // =======================================================
    const [params, setParams] = useState({ 
        photo: { x: 0, y: 0, s: 0.5, r: 0, f: 1 }, 
        suit: { x: 0, y: 80, s: 0.8, r: 0, f: 1 } 
    });
    const [ui, setUi] = useState({ target: 'photo', spec: '4x6-8', gender: 'female', results: null });
    const drag = useRef({ active: false, x: 0, y: 0 });

    const handlePhotoLoad = (e) => {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const i = new Image(); i.onload = () => {
                setAssets(prev => ({...prev, img: i}));
                // è‡ªå‹•ç”¢ç”Ÿæš«å­˜
                setTimeout(() => {
                    setHistory(prev => [{ thumb: cvsRef.current.toDataURL('image/jpeg', 0.2), assets: { img: i, suit: assets.suit }, params }, ...prev].slice(0,10));
                }, 200);
            };
            i.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };

    // =======================================================
    // [Zone 4: æ¸²æŸ“æ ¸å¿ƒ (Render Core)]
    // =======================================================
    const drawObject = (ctx, img, p, rect, baseW = 350) => {
        if (!img) return;
        const r = rect.w / baseW;
        ctx.save();
        ctx.beginPath(); ctx.rect(rect.x, rect.y, rect.w, rect.h); ctx.clip();
        ctx.translate(rect.x + rect.w/2 + p.x * r, rect.y + rect.h/2 + p.y * r);
        ctx.rotate(p.r * Math.PI / 180);
        ctx.scale(p.s * r * (p.f || 1), p.s * r);
        ctx.drawImage(img, -img.width/2, -img.height/2);
        ctx.restore();
    };

    useEffect(() => {
        const tick = () => {
            if(!cvsRef.current) return;
            const ctx = cvsRef.current.getContext('2d');
            ctx.fillStyle = "white"; ctx.fillRect(0,0,350,450);
            drawObject(ctx, assets.img, params.photo, {x:0, y:0, w:350, h:450});
            drawObject(ctx, assets.suit, params.suit, {x:0, y:0, w:350, h:450});
            requestAnimationFrame(tick);
        };
        const id = requestAnimationFrame(tick);
        return () => cancelAnimationFrame(id);
    }, [assets, params]);

    // =======================================================
    // [Zone 5: è¼¸å‡ºå¼•æ“ (Export Engine - MIX Support)]
    // =======================================================
    const handleExport = async (batchAll = false) => {
        if(!assets.img) return alert("æœªåµæ¸¬åˆ°äººåƒç…§ç‰‡");
        const list = batchAll ? Object.keys(SPECS) : [ui.spec];
        const outputs = [];

        for(let id of list) {
            const s = SPECS[id];
            const canvas = document.createElement('canvas'); canvas.width = s.w; canvas.height = s.h;
            const ctx = canvas.getContext('2d'); ctx.fillStyle = "white"; ctx.fillRect(0,0,s.w,s.h);

            // MIX é‚è¼¯åˆ†å€æ¸²æŸ“
            const layout = s.sections ? s.sections.flatMap(sec => {
                const slots = [];
                const gapX = ((sec.w || s.w) - sec.grid[1] * sec.size[0]) / (sec.grid[1] + 1);
                const gapY = ((sec.h || s.h) - sec.grid[0] * sec.size[1]) / (sec.grid[0] + 1);
                for(let r=0; r<sec.grid[0]; r++) for(let c=0; c<sec.grid[1]; c++) {
                    if(slots.length < sec.count) slots.push({ x: (sec.x || 0) + gapX + c * (sec.size[0] + gapX), y: (sec.y || 0) + gapY + r * (sec.size[1] + gapY), w: sec.size[0], h: sec.size[1] });
                }
                return slots;
            }) : (() => {
                const slots = [];
                const gapX = (s.w - s.grid[1] * s.size[0]) / (s.grid[1] + 1);
                const gapY = (s.h - s.grid[0] * s.size[1]) / (s.grid[0] + 1);
                for(let r=0; r<s.grid[0]; r++) for(let c=0; c<s.grid[1]; c++) slots.push({ x: gapX + c * (s.size[0] + gapX), y: gapY + r * (s.size[1] + gapY), w: s.size[0], h: s.size[1] });
                return slots;
            })();

            layout.forEach(rect => {
                drawObject(ctx, assets.img, params.photo, rect);
                drawObject(ctx, assets.suit, params.suit, rect);
            });
            outputs.push({ url: canvas.toDataURL('image/jpeg', 0.9), name: s.name, id });
        }
        setUi(prev => ({...prev, results: outputs}));
    };

    // =======================================================
    // [Zone 6: è‡ªæª¢èˆ‡ UI ç›£æ§ (Self-Check UI)]
    // =======================================================
    const checkState = useMemo(() => ({
        specsOk: Object.keys(SPECS).length === 12,
        mixOk: !!(SPECS['A4-MIX'].sections && SPECS['4x6-MIX'].sections),
        imgOk: !!assets.img
    }), [assets.img]);

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <h1 className="text-3xl font-black text-blue-500 italic">EzID</h1>
                <div className="bg-slate-800 px-3 py-1 rounded-full flex items-center gap-2">
                    <div className={`w-2 h-2 rounded-full ${checkState.specsOk ? 'bg-emerald-500' : 'bg-red-500'}`}></div>
                    <span className="text-[10px] font-bold">CONTRACT STATUS</span>
                </div>
            </div>

            {/* ç·¨è¼¯æ ¸å¿ƒæ¨¡çµ„ */}
            <div className="stage-box"
                onPointerDown={e => { drag.current = { active: true, x: e.clientX, y: e.clientY }; e.target.setPointerCapture(e.pointerId); }}
                onPointerMove={e => {
                    if(!drag.current.active) return;
                    const dx = (e.clientX - drag.current.x)/params[ui.target].s;
                    const dy = (e.clientY - drag.current.y)/params[ui.target].s;
                    setParams(p => ({...p, [ui.target]: {...p[ui.target], x: p[ui.target].x+dx, y: p[ui.target].y+dy}}));
                    drag.current.x = e.clientX; drag.current.y = e.clientY;
                }}
                onPointerUp={() => drag.current.active = false}>
                <canvas ref={cvsRef} width="350" height="450" className="w-full h-full" />
                <div className="guide-circle"></div>
            </div>

            {/* æ“æ§æ¨¡çµ„ */}
            <div className="grid grid-cols-2 gap-3">
                {['photo', 'suit'].map(t => (
                    <button key={t} onClick={() => setUi(u => ({...u, target: t}))} className={`py-4 rounded-2xl font-black text-xs ${ui.target === t ? 'bg-blue-600' : 'bg-slate-800 text-slate-500'}`}>{t==='photo'?'èª¿æ•´äººç‰©':'èª¿æ•´è¡£æœ'}</button>
                ))}
            </div>

            {/* è¡£æœæ¨¡çµ„ */}
            <div className="bg-slate-900/50 p-4 rounded-3xl space-y-3">
                <div className="flex gap-2 mb-2">
                    {['female', 'male'].map(g => (
                        <button key={g} onClick={() => setUi(u => ({...u, gender: g}))} className={`flex-1 py-2 rounded-lg text-[10px] font-black uppercase ${ui.gender === g ? 'bg-blue-600' : 'bg-slate-800'}`}>{g}</button>
                    ))}
                </div>
                <div className="flex gap-2 overflow-x-auto no-scrollbar">
                    <button onClick={() => setAssets(a => ({...a, suit: null}))} className="w-12 h-12 bg-red-900/20 border border-red-500/30 text-red-500 rounded-lg flex-shrink-0 text-[10px]">ç§»é™¤</button>
                    {SUITS[ui.gender].map(url => (
                        <img key={url} src={url} onClick={() => {
                            const i = new Image(); i.crossOrigin="anonymous"; i.onload = () => setAssets(a => ({...a, suit: i})); i.src = url;
                        }} className="w-12 h-12 bg-white rounded-lg p-1 flex-shrink-0 active:scale-90 transition-transform cursor-pointer" />
                    ))}
                </div>
            </div>

            {/* æš«å­˜å€é¡¯ç¤º */}
            {history.length > 0 && (
                <div className="flex gap-3 overflow-x-auto no-scrollbar py-2">
                    {history.map(h => (
                        <div key={h.id} onClick={() => { setAssets(h.assets); setParams(h.params); }} className={`w-14 h-18 rounded-lg border-2 flex-shrink-0 overflow-hidden ${assets.img === h.assets.img ? 'border-blue-500' : 'border-slate-800'}`}>
                            <img src={h.thumb} className="w-full h-full object-cover" />
                        </div>
                    ))}
                </div>
            )}

            {/* ç‰ˆé¢é¸æ“‡å€ */}
            <div className="flex flex-wrap gap-2">
                {Object.values(SPECS).map(s => (
                    <button key={s.id} onClick={() => setUi(u => ({...u, spec: s.id}))} className={`px-3 py-3 rounded-xl text-[10px] font-bold flex-1 min-w-[85px] ${ui.spec === s.id ? 'bg-blue-600' : 'bg-slate-800'}`}>{s.name}</button>
                ))}
            </div>

            {/* è¼¸å‡ºæŒ‰éˆ•å€ */}
            <div className="flex flex-col gap-3 pb-10">
                <label className="w-full py-5 bg-white text-black rounded-3xl text-center text-sm font-black cursor-pointer shadow-xl">ğŸ“¸ è¼‰å…¥æ–°ç…§ç‰‡<input type="file" hidden accept="image/*" onChange={handlePhotoLoad}/></label>
                <div className="grid grid-cols-2 gap-3">
                    <button onClick={() => handleExport(false)} className="py-6 bg-blue-600 rounded-3xl font-black">å°å‡ºç›®å‰</button>
                    <button onClick={() => handleExport(true)} className="py-6 bg-orange-600 rounded-3xl font-black">12 ç¨®å…¨å‡º</button>
                </div>
            </div>

            {/* è¼¸å‡ºçµæœ (Overlay) */}
            {ui.results && (
                <div className="fixed inset-0 bg-slate-950 z-[999] overflow-y-auto p-6">
                    <div className="max-w-sm mx-auto space-y-6 text-center">
                        <p className="text-blue-500 font-black">EXPORT HUB</p>
                        {ui.results.map((r, i) => (
                            <div key={i} className="bg-slate-900 p-4 rounded-3xl space-y-3">
                                <p className="text-[10px] text-slate-400 font-bold">{r.name}</p>
                                <img src={r.url} className="w-full rounded-xl" />
                                <a href={r.url} download={`EzID_${r.id}.jpg`} className="block w-full py-3 bg-blue-600 rounded-xl font-black text-xs">å„²å­˜è‡³ç›¸ç°¿</a>
                            </div>
                        ))}
                        <button onClick={() => setUi(u => ({...u, results: null}))} className="fixed bottom-6 left-1/2 -translate-x-1/2 w-64 py-5 bg-white text-black rounded-full font-black">é—œé–‰é è¦½</button>
                    </div>
                </div>
            )}
        </div>
    );
}
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
