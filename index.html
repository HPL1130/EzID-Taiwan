<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzID Pro - ibon 4x6 æœ€çµ‚ä¿®æ­£</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.5.3/dist/bundle.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .control-panel { max-height: 85vh; overflow-y: auto; }
        canvas { background-color: white; border: 1px solid #e2e8f0; border-radius: 12px; }
        .guide-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -55%);
            width: 190px; height: 250px;
            border: 3px dashed rgba(255, 0, 0, 0.4);
            border-radius: 50% / 50%;
            pointer-events: none;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const SPECS = {
            TWO_INCH: { id: 'TWO_INCH', label: '2å‹(8å¼µ)', w: 413, h: 531, cols: 4, rows: 2 },
            ONE_INCH: { id: 'ONE_INCH', label: '1å‹(10å¼µ)', w: 331, h: 449, cols: 5, rows: 2 }
        };

        const EzIDApp = () => {
            const [image, setImage] = useState(null);
            const [bgRemoved, setBgRemoved] = useState(null);
            const [isRemoving, setIsRemoving] = useState(false);
            const [isCameraActive, setIsCameraActive] = useState(false);
            const [currentSpec, setCurrentSpec] = useState(SPECS.TWO_INCH);
            
            const [p, setP] = useState({ x: 0, y: 0, s: 0.55 });
            const [suit, setSuit] = useState({ id: null, x: 175, y: 350, s: 0.7 });
            
            const canvasRef = useRef(null);
            const suitImg = useRef(new Image());

            useEffect(() => {
                const draw = () => {
                    const canvas = canvasRef.current;
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, 350, 450);
                    ctx.fillStyle = "#FFFFFF";
                    ctx.fillRect(0, 0, 350, 450);

                    const activeImg = bgRemoved || image;
                    if (activeImg) {
                        ctx.save();
                        ctx.translate(175 + parseInt(p.x), 225 + parseInt(p.y));
                        ctx.scale(p.s, p.s);
                        ctx.drawImage(activeImg, -activeImg.width/2, -activeImg.height/2);
                        ctx.restore();
                    }

                    if (suit.id) {
                        suitImg.current.src = `./suit-${suit.id}.png`;
                        if (suitImg.current.complete) {
                            ctx.save();
                            ctx.translate(parseInt(suit.x), parseInt(suit.y));
                            ctx.scale(suit.s * 2.2, suit.s * 2.2);
                            ctx.drawImage(suitImg.current, -suitImg.current.width/2, -suitImg.current.height/2);
                            ctx.restore();
                        } else { suitImg.current.onload = draw; }
                    }
                };
                draw();
            }, [image, bgRemoved, p, suit]);

            // å»èƒŒæ ¸å¿ƒä¿®æ­£
            const runRemoveBg = async () => {
                if (!image) return;
                setIsRemoving(true);
                try {
                    // GitHub Pages ç’°å¢ƒä¸‹å˜—è©¦å¼·åˆ¶è¼‰å…¥é…ç½®
                    const config = {
                        publicPath: "https://cdn.jsdelivr.net/npm/@imgly/background-removal-data@1.5.3/dist/",
                        device: "cpu" // å¼·åˆ¶ä½¿ç”¨ CPU æ¨¡å¼é¿å… WebGL/WASM å ±éŒ¯
                    };
                    const blob = await imglyBackgroundRemoval.removeBackground(image.src, config);
                    const img = new Image();
                    img.onload = () => { setBgRemoved(img); setIsRemoving(false); };
                    img.src = URL.createObjectURL(blob);
                } catch (e) {
                    console.error(e);
                    alert("å»èƒŒå¤±æ•—ï¼GitHub Pages ç’°å¢ƒé™åˆ¶è¼ƒå¤šï¼Œè‹¥ç„¡æ³•å»èƒŒï¼Œå»ºè­°å°‡æª”æ¡ˆä¸‹è¼‰å¾Œï¼Œåœ¨é›»è…¦æœ¬åœ°ç«¯(VS Code Live Server)åŸ·è¡Œï¼Œæˆ–ä½¿ç”¨ HTTPS ç’°å¢ƒã€‚");
                    setIsRemoving(false);
                }
            };

            // æ©«å¼ä¸‹è¼‰ï¼šèª¿æ•´é‚Šè·èˆ‡å®‰å…¨å€
            const downloadFinal = () => {
                const pc = document.createElement('canvas');
                const ctx = pc.getContext('2d');
                pc.width = 1800; pc.height = 1200;
                ctx.fillStyle = "white";
                ctx.fillRect(0, 0, 1800, 1200);

                const { w, h, cols, rows } = currentSpec;
                
                // è¨ˆç®—ç¸½å¯¬é«˜ï¼Œä¸¦ç•™å‡ºå››å‘¨è‡³å°‘ 80px çš„å®‰å…¨é‚Šç•Œ (ibon å°ˆç”¨)
                const totalW = cols * w + (cols - 1) * 20;
                const totalH = rows * h + (rows - 1) * 30;
                const startX = (1800 - totalW) / 2;
                const startY = (1200 - totalH) / 2;

                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        const x = startX + c * (w + 20);
                        const y = startY + r * (h + 30);
                        
                        // ç•«ç…§ç‰‡
                        ctx.drawImage(canvasRef.current, 0, 0, 350, 450, x, y, w, h);
                        
                        // ç•«æ·¡æ·¡çš„è£åˆ‡ç·š
                        ctx.strokeStyle = "#dddddd";
                        ctx.lineWidth = 1;
                        ctx.strokeRect(x, y, w, h);
                    }
                }

                const link = document.createElement('a');
                link.download = `EzID_ibon_Ready.png`;
                link.href = pc.toDataURL('image/png');
                link.click();
            };

            return (
                <div className="flex flex-col lg:flex-row h-screen overflow-hidden p-4 gap-4">
                    <div className="w-full lg:w-[400px] flex flex-col gap-4 bg-white p-4 rounded-3xl shadow-xl shrink-0">
                        <div className="relative">
                            <canvas ref={canvasRef} width={350} height={450} className="w-full h-auto mx-auto" />
                            {image && <div className="guide-overlay"></div>}
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                            <button onClick={runRemoveBg} className="bg-indigo-600 text-white py-3 rounded-xl font-bold">{isRemoving ? 'è™•ç†ä¸­...' : 'ä¸€éµå»èƒŒ'}</button>
                            <button onClick={downloadFinal} className="bg-emerald-600 text-white py-3 rounded-xl font-bold">ä¸‹è¼‰ 4x6 æ’ç‰ˆ</button>
                        </div>
                    </div>

                    <div className="flex-1 bg-white p-6 rounded-3xl shadow-xl control-panel border border-slate-300">
                        <div className="space-y-6">
                            <div className="flex justify-between items-center">
                                <span className="font-bold text-slate-400">å°ºå¯¸é¸æ“‡</span>
                                <div className="flex gap-2">
                                    {Object.values(SPECS).map(s => (
                                        <button key={s.id} onClick={() => setCurrentSpec(s)} className={`px-4 py-1 rounded-full border ${currentSpec.id === s.id ? 'bg-slate-800 text-white' : 'text-slate-400'}`}>{s.label}</button>
                                    ))}
                                </div>
                            </div>
                            
                            <input type="file" onChange={(e) => {
                                const reader = new FileReader();
                                reader.onload = (f) => { const img = new Image(); img.onload = () => setImage(img); img.src = f.target.result; };
                                reader.readAsDataURL(e.target.files[0]);
                            }} className="w-full text-sm border p-2 rounded-lg" />

                            <div className="bg-slate-50 p-4 rounded-xl space-y-4">
                                <p className="text-xs font-bold text-indigo-500">ğŸ‘¤ äººåƒä½ç§»</p>
                                <input type="range" min="0.1" max="1.5" step="0.01" value={p.s} onChange={e => setP({...p, s: e.target.value})} />
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="range" min="-200" max="200" value={p.x} onChange={e => setP({...p, x: e.target.value})} />
                                    <input type="range" min="-200" max="200" value={p.y} onChange={e => setP({...p, y: e.target.value})} />
                                </div>
                            </div>

                            <div className="bg-blue-50 p-4 rounded-xl space-y-4">
                                <p className="text-xs font-bold text-blue-500">ğŸ‘” è¡£æœä½ç§»</p>
                                <input type="range" min="0.1" max="1.5" step="0.01" value={suit.s} onChange={e => setSuit({...suit, s: e.target.value})} />
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="range" min="0" max="350" value={suit.x} onChange={e => setSuit({...suit, x: e.target.value})} />
                                    <input type="range" min="0" max="800" value={suit.y} onChange={e => setSuit({...suit, y: e.target.value})} />
                                </div>
                                <div className="flex gap-2">
                                    {[1,2,3,4,5].map(i => <img key={i} src={`./suit-m${i}.png`} onClick={()=>setSuit({...suit, id:`m${i}`})} className="w-10 h-10 border bg-white cursor-pointer" />)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
    </script>
</body>
</html>
