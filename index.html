<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>EzID Taiwan - 衣服控制完全恢復版</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        canvas { background: white; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .guide-overlay {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -55%);
            width: 190px; height: 250px;
            border: 3px dashed rgba(255, 0, 0, 0.4);
            border-radius: 50%;
            pointer-events: none; z-index: 10;
        }
        .control-panel { max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body class="bg-slate-100 p-4">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const EzIDApp = () => {
            const [image, setImage] = useState(null);
            const [isCam, setIsCam] = useState(false);
            const [mode, setMode] = useState('MIXED');
            
            // 人像控制
            const [p, setP] = useState({ x: 0, y: 0, s: 0.6 });
            // 衣服控制：恢復原始縮放比例與起始座標
            const [suit, setSuit] = useState({ id: null, x: 175, y: 340, s: 0.3 }); 
            
            const canvasRef = useRef(null);
            const videoRef = useRef(null);
            const suitImg = useRef(new Image());

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = "white";
                ctx.fillRect(0, 0, 350, 450);

                if (image) {
                    ctx.save();
                    ctx.translate(175 + parseInt(p.x), 225 + parseInt(p.y));
                    ctx.scale(p.s, p.s);
                    ctx.drawImage(image, -image.width/2, -image.height/2);
                    ctx.restore();
                }

                if (suit.id) {
                    suitImg.current.src = `./suit-${suit.id}.png`;
                    if (suitImg.current.complete) {
                        ctx.save();
                        ctx.translate(parseInt(suit.x), parseInt(suit.y));
                        // 關鍵修正：恢復正確的繪圖倍率
                        ctx.scale(suit.s * 1.5, suit.s * 1.5); 
                        ctx.drawImage(suitImg.current, -suitImg.current.width/2, -suitImg.current.height/2);
                        ctx.restore();
                    } else {
                        suitImg.current.onload = () => { setSuit(s => ({...s})); };
                    }
                }
            }, [image, p, suit]);

            const startCam = async () => {
                setIsCam(true);
                try {
                    const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                    videoRef.current.srcObject = s;
                } catch (e) { alert("無法開啟相機"); setIsCam(false); }
            };

            const snap = () => {
                const tc = document.createElement('canvas');
                tc.width = videoRef.current.videoWidth;
                tc.height = videoRef.current.videoHeight;
                const tctx = tc.getContext('2d');
                tctx.translate(tc.width, 0); tctx.scale(-1, 1);
                tctx.drawImage(videoRef.current, 0, 0);
                const img = new Image();
                img.onload = () => { setImage(img); setIsCam(false); };
                img.src = tc.toDataURL();
                videoRef.current.srcObject.getTracks().forEach(t => t.stop());
            };

            const download = () => {
                const pc = document.createElement('canvas');
                const ctx = pc.getContext('2d');
                pc.width = 1800; pc.height = 1200;
                ctx.fillStyle = "white"; ctx.fillRect(0, 0, 1800, 1200);

                if (mode === 'MIXED') {
                    for(let i=0; i<4; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 80+i*425, 80, 413, 531);
                    for(let i=0; i<5; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 80+i*340, 650, 331, 449);
                } else if (mode === 'TWO') {
                    for(let i=0; i<8; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 100+(i%4)*410, 80+(Math.floor(i/4)*540), 413, 531);
                } else {
                    for(let i=0; i<10; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 80+(i%5)*340, 100+(Math.floor(i/5)*460), 331, 449);
                }
                const a = document.createElement('a');
                a.download = "ibon_print.png"; a.href = pc.toDataURL(); a.click();
            };

            return (
                <div className="max-w-6xl mx-auto flex flex-col md:flex-row gap-8">
                    <div className="w-[350px] shrink-0">
                        <div className="relative mb-6">
                            {isCam ? (
                                <video ref={videoRef} autoPlay className="w-[350px] h-[450px] object-cover rounded-xl shadow-2xl scale-x-[-1]" />
                            ) : (
                                <canvas ref={canvasRef} width={350} height={450} />
                            )}
                            <div className="guide-overlay"></div>
                        </div>
                        <div className="space-y-3">
                            {isCam ? (
                                <button onClick={snap} className="w-full bg-red-600 text-white py-4 rounded-2xl font-black">按下拍照</button>
                            ) : (
                                <React.Fragment>
                                    <button onClick={download} className="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black">下載 4x6 橫式圖</button>
                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={startCam} className="bg-blue-600 text-white py-3 rounded-xl font-bold">啟動相機</button>
                                        <label className="bg-slate-300 py-3 rounded-xl font-bold text-center cursor-pointer shadow">
                                            上傳照片 <input type="file" className="hidden" onChange={e => {
                                                const r = new FileReader(); r.onload=f=>{const i=new Image(); i.onload=()=>setImage(i); i.src=f.target.result;};
                                                r.readAsDataURL(e.target.files[0]);
                                            }} />
                                        </label>
                                    </div>
                                </React.Fragment>
                            )}
                        </div>
                    </div>

                    <div className="flex-1 bg-white p-8 rounded-3xl shadow-xl control-panel space-y-8 border border-slate-200">
                        <div>
                            <p className="text-xs font-black text-slate-400 uppercase mb-4 tracking-wider">排版模式</p>
                            <div className="flex gap-3">
                                {[['MIXED','混合(4大5小)'],['TWO','全2吋'],['ONE','全1吋']].map(([k,v]) => (
                                    <button key={k} onClick={()=>setMode(k)} className={`px-6 py-3 rounded-xl font-bold ${mode===k?'bg-slate-800 text-white':'bg-slate-100 text-slate-500'}`}>{v}</button>
                                ))}
                            </div>
                        </div>

                        <div className="space-y-6 border-t pt-6">
                            <p className="text-xs font-black text-blue-600 uppercase tracking-wider">人像微調</p>
                            <div className="space-y-4">
                                <div className="flex items-center gap-4 text-sm font-bold"><span className="w-12">縮放</span><input type="range" min="0.1" max="1.5" step="0.01" value={p.s} onChange={e=>setP({...p, s:e.target.value})} className="flex-1" /></div>
                                <div className="grid grid-cols-2 gap-8 text-sm font-bold">
                                    <div className="flex items-center gap-4"><span>左右</span><input type="range" min="-200" max="200" value={p.x} onChange={e=>setP({...p, x:e.target.value})} className="flex-1" /></div>
                                    <div className="flex items-center gap-4"><span>上下</span><input type="range" min="-200" max="200" value={p.y} onChange={e=>setP({...p, y:e.target.value})} className="flex-1" /></div>
                                </div>
                            </div>
                        </div>

                        <div className="space-y-6 border-t pt-6">
                            <p className="text-xs font-black text-indigo-600 uppercase tracking-wider">衣服控制</p>
                            <div className="flex gap-3 overflow-x-auto pb-4">
                                {['m1','m2','m3','m4','m5'].map(n => (
                                    <img key={n} src={`./suit-${n}.png`} onClick={()=>setSuit({...suit, id:n})} className={`w-16 h-16 border-2 rounded-xl p-1 cursor-pointer ${suit.id===n?'border-indigo-600 bg-indigo-50':'border-slate-100'}`} />
                                ))}
                                <button onClick={()=>setSuit({...suit, id:null})} className="px-4 border-2 border-dashed rounded-xl text-xs font-bold text-slate-400">清除</button>
                            </div>
                            <div className="space-y-4">
                                {/* 縮放範圍調整為 0.1 ~ 1.0 確保不會過大 */}
                                <div className="flex items-center gap-4 text-sm font-bold"><span className="w-12">大小</span><input type="range" min="0.1" max="1.0" step="0.01" value={suit.s} onChange={e=>setSuit({...suit, s:e.target.value})} className="flex-1" /></div>
                                <div className="grid grid-cols-2 gap-8 text-sm font-bold">
                                    <div className="flex items-center gap-4"><span>左右</span><input type="range" min="0" max="350" value={suit.x} onChange={e=>setSuit({...suit, x:e.target.value})} className="flex-1" /></div>
                                    <div className="flex items-center gap-4"><span>上下</span><input type="range" min="100" max="500" value={suit.y} onChange={e=>setSuit({...suit, y:e.target.value})} className="flex-1" /></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
    </script>
</body>
</html>
