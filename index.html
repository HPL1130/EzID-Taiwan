<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v2.5.0 - Guided Edition</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f1f5f9; touch-action: pan-y; scroll-behavior: smooth; overflow-x: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .sticky-canvas { position: sticky; top: 10px; z-index: 50; transition: transform 0.4s ease; transform-origin: top center; }
        @media (max-width: 768px) { .is-scrolled .sticky-canvas { transform: scale(0.6) translateY(-10px); } }
        .canvas-container { position: relative; touch-action: none !important; background: #e2e8f0; border-radius: 36px; overflow: hidden; border: 8px solid #fff; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); }
        canvas { width: 100%; height: auto; display: block; pointer-events: none; }
        .id-guide { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -55%); width: 62%; height: 62%; border-radius: 50%; border: 2px dashed; pointer-events: none; z-index: 100; transition: 0.3s; }
        .slot-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 15px 4px; scrollbar-width: none; align-items: flex-start; }
        .slot-thumb { width: 75px; height: 95px; border-radius: 12px; border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow: hidden; flex-shrink: 0; position: relative; }
        .safe-badge { font-size: 10px; padding: 2px 10px; border-radius: 999px; font-weight: 800; }
        .disclaimer { font-size: 9px; color: #94a3b8; line-height: 1.4; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        const GUIDED_PRESETS = {
            household: { name: 'æˆ¶æ”¿è­‰ä»¶', min: 65, max: 85, tip: 'å»ºè­° 65-85%' },
            passport:  { name: 'è­·ç…§è¦ç¯„', min: 70, max: 80, tip: 'å»ºè­° 70-80%' },
            resume:    { name: 'å±¥æ­·å•†å‹™', min: 60, max: 75, tip: 'å»ºè­° 60-75%' }
        };

        const EzIDApp = () => {
            const [mode, setMode] = useState('guided'); // 'guided' æˆ– 'studio'
            const [preset, setPreset] = useState('passport');
            const [image, setImage] = useState(null);
            const [isCam, setIsCam] = useState(false);
            const [p, setP] = useState({ x: 0, y: -20, s: 0.75 });
            const [suit, setSuit] = useState({ gender: 'male', id: null, x: 175, y: 340, s: 0.35 });
            const [slots, setSlots] = useState([]);
            const [bgColor, setBgColor] = useState('#ffffff');
            const [livePreview, setLivePreview] = useState(null);

            const canvasRef = useRef(null);
            const videoRef = useRef(null);
            const suitImg = useRef(new Image());
            const currentPreset = GUIDED_PRESETS[preset];

            // æ ¸å¿ƒè¨ˆç®—ï¼šé ­éƒ¨æ¯”ä¾‹ï¼ˆåŸºæ–¼ scale ä¼°ç®—ï¼‰
            const headRatio = Math.round(p.s * 100);
            
            // åˆè¦ç‹€æ…‹åˆ¤æ–·
            const getStatus = () => {
                if (headRatio >= currentPreset.min && headRatio <= currentPreset.max) return 'ok';
                if (headRatio >= currentPreset.min - 5 && headRatio <= currentPreset.max + 5) return 'warn';
                return 'bad';
            };
            const status = getStatus();

            useEffect(() => {
                const tid = setTimeout(() => {
                    if(canvasRef.current) setLivePreview(canvasRef.current.toDataURL('image/jpeg', 0.6));
                }, 300);
                return () => clearTimeout(tid);
            }, [image, p, suit, bgColor]);

            const draw = useCallback(() => {
                const ctx = canvasRef.current?.getContext('2d'); if (!ctx) return;
                ctx.fillStyle = bgColor; ctx.fillRect(0, 0, 350, 450);
                if (image) {
                    ctx.save(); ctx.translate(175 + p.x, 225 + p.y); ctx.scale(p.s, p.s);
                    ctx.drawImage(image, -image.width/2, -image.height/2); ctx.restore();
                }
                if (suit.id) {
                    suitImg.current.src = `clothes/${suit.gender}/${suit.id}.png`;
                    if (suitImg.current.complete) {
                        ctx.save(); ctx.translate(suit.x, suit.y); ctx.scale(suit.s * 1.5, suit.s * 1.5);
                        ctx.drawImage(suitImg.current, -suitImg.current.width/2, -suitImg.current.height/2); ctx.restore();
                    }
                }
            }, [image, p, suit, bgColor]);

            useEffect(() => {
                let raf; const loop = () => { draw(); raf = requestAnimationFrame(loop); };
                loop(); return () => cancelAnimationFrame(raf);
            }, [draw]);

            return (
                <div className="max-w-6xl mx-auto flex flex-col lg:grid lg:grid-cols-[400px_1fr] gap-8">
                    {/* å·¦å´ï¼šç•«å¸ƒèˆ‡å³æ™‚è³‡è¨Š */}
                    <div className="sticky-canvas">
                        <div className="flex justify-between items-center mb-4 px-2">
                            <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">EzID Taiwan v2.5.0</span>
                            <button onClick={() => {
                                setMode(mode === 'guided' ? 'studio' : 'guided');
                                if (mode === 'studio') setBgColor('#ffffff');
                            }} className={`px-4 py-1.5 text-[10px] font-black rounded-full transition-all ${mode==='guided'?'bg-blue-600 text-white shadow-lg shadow-blue-200':'bg-slate-900 text-white'}`}>
                                {mode === 'guided' ? 'ğŸ§­ å»ºè­°æ¨¡å¼' : 'ğŸ¨ å°ˆæ¥­ç·¨è¼¯æ¨¡å¼'}
                            </button>
                        </div>
                        
                        <div className="canvas-container w-full max-w-[350px] mx-auto aspect-[35/45]">
                            <canvas ref={canvasRef} width={350} height={450} />
                            {mode === 'guided' && (
                                <div className={`id-guide ${
                                    status === 'ok' ? 'border-emerald-500 opacity-60' : 
                                    status === 'warn' ? 'border-yellow-400 opacity-80' : 'border-red-500 opacity-100'
                                }`}></div>
                            )}
                            {isCam && <video ref={videoRef} autoPlay playsInline className="absolute inset-0 w-full h-full object-cover z-20 scale-x-[-1]" />}
                        </div>

                        {/* å³æ™‚è³‡è¨Šæ¿ */}
                        <div className="mt-4 bg-white p-4 rounded-3xl border border-slate-100 shadow-sm flex flex-col items-center">
                            <div className="flex items-center gap-4 mb-2">
                                <div className="text-center">
                                    <p className="text-[10px] text-slate-400 font-bold uppercase">é ­éƒ¨æ¯”ä¾‹</p>
                                    <p className={`text-xl font-black ${status==='ok'?'text-emerald-600':status==='warn'?'text-yellow-600':'text-red-600'}`}>{headRatio}%</p>
                                </div>
                                <div className="h-8 w-[1px] bg-slate-100"></div>
                                <div className="text-left">
                                    <span className={`safe-badge ${status==='ok'?'bg-emerald-100 text-emerald-700':status==='warn'?'bg-yellow-100 text-yellow-700':'bg-red-100 text-red-700'}`}>
                                        {status==='ok' && 'ç¬¦åˆå»ºè­°'}
                                        {status==='warn' && 'åé›¢å»ºè­°'}
                                        {status==='bad' && 'è¶…å‡ºç¯„åœ'}
                                    </span>
                                    <p className="text-[10px] text-slate-400 mt-1">{mode === 'guided' ? currentPreset.tip : 'è‡ªç”±ç·¨è¼¯ä¸­'}</p>
                                </div>
                            </div>
                            <p className="disclaimer px-4 text-center">æç¤ºåƒ…ä¾›å°ä½åƒè€ƒï¼Œä¸ä¿è­‰é€šéå¯©æ ¸ã€‚è«‹è‡ªè¡Œç¢ºèªç…§ç‰‡ç¬¦åˆæ©Ÿé—œè¦å®šã€‚</p>
                        </div>
                    </div>

                    {/* å³å´ï¼šæ§åˆ¶é¢æ¿ */}
                    <div className="space-y-6">
                        {/* 1. æ¨¡å¼å°ˆå±¬åŠŸèƒ½ */}
                        {mode === 'guided' ? (
                            <div className="bg-white p-6 rounded-[32px] shadow-sm border border-slate-100">
                                <h3 className="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">ğŸ§­ å»ºè­°é¡å‹ï¼ˆä¸å¼·åˆ¶é–å®šï¼‰</h3>
                                <div className="flex gap-2">
                                    {Object.entries(GUIDED_PRESETS).map(([k, v]) => (
                                        <button key={k} onClick={() => setPreset(k)}
                                            className={`flex-1 py-3 rounded-2xl text-xs font-bold transition-all ${preset===k?'bg-blue-600 text-white shadow-md':'bg-slate-100 text-slate-500'}`}>
                                            {v.name}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="bg-white p-6 rounded-[32px] shadow-sm border border-slate-100 animate-in fade-in duration-300">
                                <h3 className="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">ğŸ¨ å°ˆæ¥­ç·¨è¼¯å·¥å…·</h3>
                                <div className="flex p-1 bg-slate-100 rounded-xl mb-4">
                                    <button onClick={() => setSuit({ ...suit, gender: 'male' })} className={`flex-1 py-1.5 text-xs font-bold rounded-lg ${suit.gender === 'male' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'}`}>ç”·ä»•æœè£</button>
                                    <button onClick={() => setSuit({ ...suit, gender: 'female' })} className={`flex-1 py-1.5 text-xs font-bold rounded-lg ${suit.gender === 'female' ? 'bg-white shadow-sm text-pink-600' : 'text-slate-400'}`}>å¥³ä»•æœè£</button>
                                </div>
                                <div className="grid grid-cols-5 gap-2 mb-4">
                                    {['m1','m2','m3','m4','m5'].map(n => {
                                        const id = suit.gender === 'male' ? n : n.replace('m', 'f');
                                        return <div key={id} onClick={() => setSuit({ ...suit, id })} className={`p-1 rounded-lg border-2 cursor-pointer transition-all ${suit.id === id ? 'border-blue-500 bg-blue-50' : 'border-slate-50'}`}><img src={`clothes/${suit.gender}/${id}.png`} className="w-full h-8 object-contain" /></div>
                                    })}
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className="text-[10px] font-black text-slate-400 uppercase">èƒŒæ™¯è‰²</span>
                                    <input type="color" value={bgColor} onChange={e => setBgColor(e.target.value)} className="w-8 h-8 rounded-full border-none cursor-pointer" />
                                </div>
                            </div>
                        )}

                        {/* 2. æ’ç‰ˆç®¡ç†æ§½ */}
                        <div className="bg-white p-6 rounded-[32px] shadow-sm border border-slate-100">
                            <h3 className="text-[10px] font-black text-slate-400 uppercase mb-3">æ’ç‰ˆç®¡ç†</h3>
                            <div className="slot-scroll">
                                <div className="preview-slot border-2 border-dashed border-slate-200 w-[75px] h-[95px] rounded-xl flex items-center justify-center bg-slate-50">
                                    {livePreview ? <img src={livePreview} className="w-full h-full object-cover opacity-40 rounded-xl" /> : <span className="text-[10px] text-slate-300 italic">LIVE</span>}
                                </div>
                                {slots.map((s, i) => (
                                    <div key={i} className="slot-thumb group">
                                        <img src={s} className="w-full h-full object-cover" />
                                        <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                            <button onClick={()=>setSlots(slots.filter((_,idx)=>idx!==i))} className="text-white text-[10px] font-bold">ç§»é™¤</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* 3. äººåƒèª¿æ•´ */}
                        <div className="bg-white p-6 md:p-8 rounded-[40px] shadow-sm border border-slate-100">
                            <div className="grid grid-cols-2 gap-3 mb-8">
                                <button onClick={async () => {
                                    try {
                                        if (isCam) {
                                            const c = document.createElement('canvas'); c.width = videoRef.current.videoWidth; c.height = videoRef.current.videoHeight;
                                            const ctx = c.getContext('2d'); ctx.translate(c.width,0); ctx.scale(-1,1); ctx.drawImage(videoRef.current,0,0);
                                            const s = new Image(); s.onload = () => setImage(s); s.src = c.toDataURL();
                                            setIsCam(false); videoRef.current.srcObject.getTracks().forEach(t => t.stop());
                                        } else { setIsCam(true); const m = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }); videoRef.current.srcObject = m; }
                                    } catch(e) { alert('ç›¸æ©Ÿä¸å¯ç”¨'); setIsCam(false); }
                                }} className="bg-slate-900 text-white py-4 rounded-2xl font-bold active:scale-95 transition-all">ğŸ“¸ ç›¸æ©Ÿæ‹ç…§</button>
                                <label className="bg-white border-2 border-slate-900 py-4 rounded-2xl font-bold text-center cursor-pointer active:scale-95 transition-all">ğŸ“ ä¸Šå‚³ç…§ç‰‡<input type="file" className="hidden" onChange={e => { const f = e.target.files[0]; if (f) { const t = new Image(); t.onload = () => setImage(t); t.src = URL.createObjectURL(f); } }} /></label>
                            </div>

                            <div className="space-y-6 pt-6 border-t border-slate-100">
                                <div>
                                    <div className="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-3"><span>äººåƒç¸®æ”¾</span><span>{headRatio}%</span></div>
                                    <input type="range" min="0.2" max="2.0" step="0.01" value={p.s} onChange={e => setP({ ...p, s: parseFloat(e.target.value) })} className="w-full h-2 bg-slate-100 rounded-lg appearance-none accent-blue-600 cursor-pointer" />
                                </div>
                                <div>
                                    <div className="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-3"><span>ä¸Šä¸‹ä½ç§»</span><span>{p.y} px</span></div>
                                    <input type="range" min="-200" max="200" value={p.y} onChange={e => setP({ ...p, y: parseInt(e.target.value) })} className="w-full h-2 bg-slate-100 rounded-lg appearance-none accent-blue-600 cursor-pointer" />
                                </div>
                                <button onClick={() => {
                                    if(canvasRef.current) setSlots([...slots, canvasRef.current.toDataURL('image/jpeg', 0.9)]);
                                }} className="w-full bg-blue-600 text-white py-4 rounded-[24px] font-black shadow-xl active:scale-[0.98] transition-all">ğŸ“¥ å­˜å…¥æ’ç‰ˆæ§½</button>
                            </div>
                        </div>

                        {/* 4. ä¸‹è¼‰èˆ‡å…è²¬ */}
                        <div className="bg-slate-900 p-8 rounded-[40px] text-white shadow-2xl">
                            <button onClick={() => {
                                if(slots.length === 0) return alert('è«‹å…ˆå­˜å…¥ç…§ç‰‡');
                                const pc = document.createElement('canvas'); pc.width = 1800; pc.height = 1200;
                                const ctx = pc.getContext('2d'); ctx.fillStyle = "white"; ctx.fillRect(0,0,1800,1200);
                                const drawFinal = async () => {
                                    const imgs = await Promise.all(slots.map(src => new Promise(res => {const img = new Image(); img.onload=()=>res(img); img.src=src;})));
                                    ctx.strokeStyle = "#000000"; ctx.lineWidth = 1;
                                    for(let i=0; i<4; i++){ const x=80+i*428, y=80; ctx.drawImage(imgs[i%imgs.length],x,y,413,531); ctx.strokeRect(x,y,413,531); }
                                    for(let i=0; i<5; i++){ const x=80+i*341, y=650; ctx.drawImage(imgs[i%imgs.length],x,y,331,449); ctx.strokeRect(x,y,331,449); }
                                    const a = document.createElement('a'); a.download = `EzID_Export.png`; a.href = pc.toDataURL(); a.click();
                                };
                                drawFinal();
                            }} className="w-full bg-white text-slate-900 py-4 rounded-[20px] font-black hover:bg-slate-100 transition-all">ğŸ’¾ ä¸‹è¼‰ 4x6 å‹æ‹¼ç‰ˆç…§ç‰‡</button>
                            <p className="disclaimer mt-4 text-center opacity-60">â€» æœ¬ç…§ç‰‡ç”±ä½¿ç”¨è€…è‡ªè¡Œèª¿æ•´ï¼Œæ˜¯å¦ç¬¦åˆå„æ©Ÿé—œè¦ç¯„è«‹è‡ªè¡Œç¢ºèªã€‚<br/>Adjustments are made by the user. Compliance is the user's responsibility.</p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
    </script>
</body>
</html>
