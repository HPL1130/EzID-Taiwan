<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v2.4.0 - Safe+ æ™ºæ…§åˆè¦ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f1f5f9; touch-action: pan-y; scroll-behavior: smooth; overflow-x: hidden; }
        .sticky-canvas { position: sticky; top: 10px; z-index: 50; transition: transform 0.4s ease; transform-origin: top center; }
        @media (max-width: 768px) { .is-scrolled .sticky-canvas { transform: scale(0.6) translateY(-10px); } }
        .canvas-container { position: relative; touch-action: none !important; background: #e2e8f0; border-radius: 36px; overflow: hidden; border: 8px solid #fff; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); }
        canvas { width: 100%; height: auto; display: block; pointer-events: none; }
        .id-guide { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -55%); width: 62%; height: 62%; border: 2px dashed rgba(239, 68, 68, 0.4); border-radius: 50%; pointer-events: none; z-index: 100; }
        .slot-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 15px 4px; scrollbar-width: none; align-items: flex-start; }
        .preview-slot { width: 75px; height: 95px; border-radius: 12px; border: 2px dashed #cbd5e1; position: relative; background: #f8fafc; flex-shrink: 0; }
        .slot-thumb { width: 75px; height: 95px; border-radius: 12px; border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow: hidden; flex-shrink: 0; position: relative; }
        .slot-controls { display: flex; width: 100%; justify-content: space-between; padding: 4px; background: rgba(15, 23, 42, 0.9); position: absolute; bottom: 0; left: 0; transition: 0.2s; opacity: 0; }
        .slot-thumb:hover .slot-controls { opacity: 1; }
        @media (hover: none) { .slot-controls { opacity: 1; } }
        .safe-badge { font-size: 10px; padding: 2px 10px; border-radius: 999px; font-weight: 800; transition: 0.3s; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        const SAFE_PRESETS = {
            household: { name: 'æˆ¶æ”¿', min: 0.65, max: 0.85, y: -30, desc: 'é ­éƒ¨ä½”æ¯”å¤§' },
            passport:  { name: 'è­·ç…§', min: 0.70, max: 0.90, y: -20, desc: 'æ¨™æº–è¦ç¯„' },
            resume:    { name: 'å±¥æ­·', min: 0.55, max: 0.95, y: -10, desc: 'è¼ƒå¯¬é¬†' }
        };

        const EzIDApp = () => {
            const [mode, setMode] = useState('id'); 
            const [preset, setPreset] = useState('passport');
            const [image, setImage] = useState(null);
            const [isCam, setIsCam] = useState(false);
            const [bgColor, setBgColor] = useState('#ffffff');
            const [p, setP] = useState({ x: 0, y: -20, s: 0.75 });
            const [suit, setSuit] = useState({ gender: 'male', id: null, x: 175, y: 340, s: 0.35 });
            const [slots, setSlots] = useState([]);
            const [scrolled, setScrolled] = useState(false);
            const [livePreview, setLivePreview] = useState(null);

            const canvasRef = useRef(null);
            const videoRef = useRef(null);
            const suitImg = useRef(new Image());
            const safe = SAFE_PRESETS[preset];

            // === SAFE+ æ™ºæ…§å›å½ˆé‚è¼¯ ===
            useEffect(() => {
                if (mode !== 'id') return;
                const tid = setTimeout(() => {
                    if (p.s < safe.min) setP(v => ({ ...v, s: safe.min }));
                    if (p.s > safe.max) setP(v => ({ ...v, s: safe.max }));
                }, 400);
                return () => clearTimeout(tid);
            }, [p.s, preset, mode]);

            // === ç¹ªè£½é‚è¼¯ ===
            const draw = useCallback(() => {
                const ctx = canvasRef.current?.getContext('2d'); if (!ctx) return;
                ctx.fillStyle = bgColor; ctx.fillRect(0, 0, 350, 450);
                if (image) {
                    ctx.save(); ctx.translate(175 + p.x, 225 + p.y); ctx.scale(p.s, p.s);
                    ctx.drawImage(image, -image.width/2, -image.height/2); ctx.restore();
                }
                if (suit.id) {
                    suitImg.current.src = `clothes/${suit.gender}/${suit.id}.png`;
                    if (suitImg.current.complete) {
                        ctx.save(); ctx.translate(suit.x, suit.y); ctx.scale(suit.s * 1.5, suit.s * 1.5);
                        ctx.drawImage(suitImg.current, -suitImg.current.width/2, -suitImg.current.height/2); ctx.restore();
                    }
                }
            }, [image, p, suit, bgColor]);

            useEffect(() => {
                let raf; const loop = () => { draw(); raf = requestAnimationFrame(loop); };
                loop(); return () => cancelAnimationFrame(raf);
            }, [draw]);

            // === åˆè¦è¨ºæ–· ===
            let status = 'ok';
            if (p.s < safe.min || p.s > safe.max) status = 'bad';
            else if (p.s < safe.min + 0.05 || p.s > safe.max - 0.05) status = 'warn';

            return (
                <div className="max-w-6xl mx-auto flex flex-col lg:grid lg:grid-cols-[400px_1fr] gap-8">
                    {/* å·¦å´ï¼šé è¦½å€ */}
                    <div className="sticky-canvas">
                        <div className="flex justify-between items-center mb-3 px-2">
                            <span className="text-[10px] font-black text-slate-400 uppercase">Ver 2.4.0 Safe+</span>
                            <button onClick={() => setMode(mode==='id'?'studio':'id')} 
                                className={`px-4 py-1 text-xs font-black rounded-full shadow-sm transition-all ${mode==='id'?'bg-emerald-600 text-white':'bg-slate-900 text-white'}`}>
                                {mode==='id'?'ğŸ›¡ï¸ å®‰å…¨æ¨¡å¼':'ğŸ¨ Studio'}
                            </button>
                        </div>
                        <div className="canvas-container w-full max-w-[350px] mx-auto aspect-[35/45]">
                            <canvas ref={canvasRef} width={350} height={450} />
                            <div className="id-guide"></div>
                            {isCam && <video ref={videoRef} autoPlay playsInline className="absolute inset-0 w-full h-full object-cover z-20 scale-x-[-1]" />}
                        </div>
                        {/* Safe+ è¨ºæ–·å¾½ç«  */}
                        <div className="mt-4 flex justify-center">
                            <span className={`safe-badge ${
                                status==='ok'?'bg-emerald-100 text-emerald-700':
                                status==='warn'?'bg-yellow-100 text-yellow-700':
                                'bg-red-100 text-red-700'
                            }`}>
                                {status==='ok' && `âœ“ ç¬¦åˆ${safe.name}æ¯”ä¾‹`}
                                {status==='warn' && `! æ¥è¿‘${safe.name}é™åˆ¶`}
                                {status==='bad' && `âœ• ä¸ç¬¦${safe.name}è¦ç¯„`}
                            </span>
                        </div>
                    </div>

                    {/* å³å´ï¼šæ§åˆ¶å€ */}
                    <div className="space-y-6">
                        {/* 1. é è¨­é›†åˆ‡æ› (åƒ…å®‰å…¨æ¨¡å¼) */}
                        {mode === 'id' && (
                            <div className="bg-white p-6 rounded-[32px] shadow-sm border border-slate-100">
                                <h3 className="text-[10px] font-black text-slate-400 uppercase mb-3">è­‰ä»¶é¡å‹è¦ç¯„</h3>
                                <div className="flex gap-2">
                                    {Object.entries(SAFE_PRESETS).map(([k, v]) => (
                                        <button key={k} onClick={() => {setPreset(k); setP(prev=>({...prev, y: v.y, s: (v.min+v.max)/2}))}}
                                            className={`flex-1 py-3 rounded-2xl text-xs font-bold transition-all ${preset===k?'bg-slate-900 text-white':'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                                            {v.name}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* 2. æ’ç‰ˆç®¡ç†æ§½ */}
                        <div className="bg-white p-6 rounded-[32px] shadow-sm border border-slate-100">
                            <h3 className="text-[10px] font-black text-slate-400 uppercase mb-3">æ’ç‰ˆç®¡ç†</h3>
                            <div className="slot-scroll">
                                <div className="preview-slot"><span className="absolute top-1 left-1 bg-red-500 text-[8px] text-white px-1 rounded animate-pulse">LIVE</span>{livePreview && <img src={livePreview} className="w-full h-full object-cover opacity-50" />}</div>
                                {slots.map((s, i) => (
                                    <div key={i} className="slot-thumb group">
                                        <img src={s} className="w-full h-full object-cover" />
                                        <div className="slot-controls">
                                            <button onClick={()=>setSlots(slots.filter((_,idx)=>idx!==i))} className="text-red-400 text-xs font-bold px-2">âœ• ç§»é™¤</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* 3. æ ¸å¿ƒå·¥å…·å€ */}
                        <div className="bg-white p-6 md:p-8 rounded-[40px] shadow-sm border">
                            <div className="grid grid-cols-2 gap-3 mb-6">
                                <button onClick={async () => {
                                    try {
                                        if (isCam) {
                                            const c = document.createElement('canvas'); c.width = videoRef.current.videoWidth; c.height = videoRef.current.videoHeight;
                                            const ctx = c.getContext('2d'); ctx.translate(c.width,0); ctx.scale(-1,1); ctx.drawImage(videoRef.current,0,0);
                                            const s = new Image(); s.onload = () => setImage(s); s.src = c.toDataURL();
                                            setIsCam(false); videoRef.current.srcObject.getTracks().forEach(t => t.stop());
                                        } else { setIsCam(true); const m = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }); videoRef.current.srcObject = m; }
                                    } catch(e) { alert('ç›¸æ©Ÿæœªå•Ÿç”¨'); setIsCam(false); }
                                }} className="bg-slate-900 text-white py-3 rounded-2xl font-bold">ğŸ“¸ ç›¸æ©Ÿ</button>
                                <label className="bg-white border-2 border-slate-900 py-3 rounded-2xl font-bold text-center cursor-pointer">ğŸ“ ä¸Šå‚³<input type="file" className="hidden" onChange={e => { const f = e.target.files[0]; if (f) { const t = new Image(); t.onload = () => setImage(t); t.src = URL.createObjectURL(f); } }} /></label>
                            </div>

                            <div className="space-y-6 pt-6 border-t border-slate-100">
                                {mode === 'studio' && (
                                    <div className="animate-in fade-in slide-in-from-top-2 duration-300 mb-6">
                                        <div className="flex p-1 bg-slate-100 rounded-xl mb-4">
                                            <button onClick={() => setSuit({ ...suit, gender: 'male' })} className={`flex-1 py-1 text-xs font-bold rounded-lg ${suit.gender === 'male' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'}`}>ç”·ä»•æœè£</button>
                                            <button onClick={() => setSuit({ ...suit, gender: 'female' })} className={`flex-1 py-1 text-xs font-bold rounded-lg ${suit.gender === 'female' ? 'bg-white shadow-sm text-pink-600' : 'text-slate-400'}`}>å¥³ä»•æœè£</button>
                                        </div>
                                        <div className="grid grid-cols-5 gap-2">
                                            {['m1','m2','m3','m4','m5'].map(n => {
                                                const id = suit.gender === 'male' ? n : n.replace('m', 'f');
                                                return <div key={id} onClick={() => setSuit({ ...suit, id })} className={`p-1 rounded-lg border-2 cursor-pointer ${suit.id === id ? 'border-blue-500 bg-blue-50' : 'border-slate-50'}`}><img src={`clothes/${suit.gender}/${id}.png`} className="w-full h-8 object-contain" /></div>
                                            })}
                                        </div>
                                    </div>
                                )}
                                
                                <div className="space-y-4">
                                    <div>
                                        <div className="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-2"><span>äººåƒç¸®æ”¾</span><span>{(p.s*100).toFixed(0)}%</span></div>
                                        <input type="range" min="0.2" max="2.0" step="0.01" value={p.s} onChange={e => setP({ ...p, s: parseFloat(e.target.value) })} className="w-full h-2 bg-slate-100 rounded-lg appearance-none accent-blue-600" />
                                    </div>
                                    <div>
                                        <div className="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-2"><span>äººåƒé«˜ä½</span><span>{p.y} px</span></div>
                                        <input type="range" min="-200" max="200" value={p.y} onChange={e => setP({ ...p, y: parseInt(e.target.value) })} className="w-full h-2 bg-slate-100 rounded-lg appearance-none accent-blue-600" />
                                    </div>
                                </div>
                                <button onClick={() => {
                                    if(canvasRef.current) setSlots([...slots, canvasRef.current.toDataURL('image/jpeg', 0.9)]);
                                }} className="w-full bg-blue-600 text-white py-4 rounded-[24px] font-black shadow-xl hover:bg-blue-700 transition-colors">ğŸ“¥ å­˜å…¥æ’ç‰ˆæ§½</button>
                            </div>
                        </div>

                        {/* 4. ä¸‹è¼‰å€ */}
                        <div className="bg-slate-900 p-8 rounded-[40px] text-white shadow-2xl">
                            <button onClick={() => {
                                if(slots.length === 0) return alert('è«‹å…ˆå­˜å…¥ç…§ç‰‡');
                                const pc = document.createElement('canvas'); pc.width = 1800; pc.height = 1200;
                                const ctx = pc.getContext('2d'); ctx.fillStyle = "white"; ctx.fillRect(0,0,1800,1200);
                                const drawFinal = async () => {
                                    const imgs = await Promise.all(slots.map(src => new Promise(res => {const img = new Image(); img.onload=()=>res(img); img.src=src;})));
                                    ctx.strokeStyle = "#000000"; ctx.lineWidth = 2;
                                    for(let i=0; i<4; i++){ const x=80+i*428, y=80; ctx.drawImage(imgs[i%imgs.length],x,y,413,531); ctx.strokeRect(x,y,413,531); }
                                    for(let i=0; i<5; i++){ const x=80+i*341, y=650; ctx.drawImage(imgs[i%imgs.length],x,y,331,449); ctx.strokeRect(x,y,331,449); }
                                    const a = document.createElement('a'); a.download = `EzID_${new Date().getTime()}.png`; a.href = pc.toDataURL(); a.click();
                                };
                                drawFinal();
                            }} className="w-full bg-white text-slate-900 py-4 rounded-[20px] font-black hover:bg-slate-100 transition-all">ğŸ’¾ ä¸‹è¼‰ 4x6 æ‹¼ç‰ˆç…§ç‰‡</button>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
    </script>
</body>
</html>
