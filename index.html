<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.37 æ¬Šè²¬å®šç¨¿å°ˆæ¥­ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face { font-family: 'NotoSansTC'; src: local('Noto Sans TC'), local('Microsoft JhengHei'), sans-serif; font-weight: 700; }
        body { font-family: 'NotoSansTC', sans-serif; background: #f8fafc; color: #1e293b; }
        .canvas-box { position: relative; width: 350px; height: 450px; margin: 0 auto; border-radius: 12px; overflow: hidden; background: white; box-shadow: inset 0 0 0 1px #e2e8f0; touch-action: none; }
        .slot-card { border-left: 4px solid #cbd5e1; transition: all 0.2s; }
        .slot-card.final { border-left-color: #22c55e; background: #f0fdf4; }
        .slot-card.editing { border-left-color: #ef4444; background: #fef2f2; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="py-6 px-4 pb-20">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useTransition } = React;

/* ============================================================
   MODULE 1: SPECS (æä¾›æ¥­å‹™æ ¡æº–åŸºæº–)
   ============================================================ */
const SPECS = {
    'A4-20':  { id: 'A4-20', w: 2480, h: 3508, photos: 20, grid: [5, 4], size: [413, 531], name: 'A4 2å‹æ¨™æº–' },
    'A4-ID':  { id: 'A4-ID', w: 2480, h: 3508, photos: 16, grid: [4, 4], size: [450, 600], name: 'A4 è­·ç…§è­‰ä»¶' },
    '4x6-8':  { id: '4x6-8', w: 1800, h: 1200, photos: 8,  grid: [2, 4], size: [413, 531], name: '4x6 2å‹ (ibon)' },
    'NAME':   { id: 'NAME', w: 2480, h: 3508, photos: 24, grid: [6, 4], size: [295, 413], special: 'NAME', name: 'å§“åå·¥ç‰Œ' }
};

/* ============================================================
   MODULE 2: ATOMIC RENDERER (ç´”ç²¹ç¹ªåœ–ï¼Œä¸å•ä¸–äº‹)
   ============================================================ */
const AtomicRenderer = {
    layer: (ctx, img, st, ratio, cx, cy) => {
        if (!img) return;
        ctx.save();
        ctx.translate(cx + st.x * ratio, cy + st.y * ratio);
        ctx.rotate(st.r * Math.PI / 180);
        ctx.scale(st.s * ratio * st.f, st.s * ratio);
        ctx.drawImage(img, -img.width / 2, -img.height / 2);
        ctx.restore();
    }
};

/* ============================================================
   MODULE 3: MAIN APP (ç¾åœ¨ Slot æ˜¯è³‡ç”¢ä¸»é«”)
   ============================================================ */
function App() {
    const [isPending, startTransition] = useTransition();
    
    // Editor State
    const [img, setImg] = useState(null);
    const [suit, setSuit] = useState(null);
    const [p, setP] = useState({ x: 0, y: -20, s: 0.45, r: 0, f: 1 });
    const [s, setS] = useState({ x: 0, y: 80, s: 1.0, r: 0, f: 1 });
    const [activeSpec, setActiveSpec] = useState('A4-20');
    
    // Asset Management
    const [slots, setSlots] = useState([]);
    const [editingId, setEditingId] = useState(null); // è¿½è¹¤æ­£åœ¨ Recall çš„ Slot
    const [preview, setPreview] = useState(null);
    
    const canvasRef = useRef(null);
    const drag = useRef({ active: false, x: 0, y: 0 });

    // ğŸŸ¢ å¯¦æ™‚é è¦½ç¹ªè£½
    useEffect(() => {
        const ctx = canvasRef.current?.getContext('2d');
        if (!ctx) return;
        ctx.fillStyle = "white"; ctx.fillRect(0, 0, 350, 450);
        AtomicRenderer.layer(ctx, img, p, 1, 175, 225);
        AtomicRenderer.layer(ctx, suit, s, 1, 175, 225);
    }, [img, suit, p, s]);

    // ğŸŸ¢ è³‡ç”¢æ“ä½œï¼šå®šç¨¿èˆ‡æ›´æ–°
    const commitAsset = (isUpdate = false) => {
        if (!img) return;
        const thumb = document.createElement('canvas'); thumb.width = 100; thumb.height = 130;
        const ctx = thumb.getContext('2d'); ctx.fillStyle="white"; ctx.fillRect(0,0,100,130);
        const ratio = 100/350;
        AtomicRenderer.layer(ctx, img, p, ratio, 50, 65);
        AtomicRenderer.layer(ctx, suit, s, ratio, 50, 65);

        const assetData = {
            id: isUpdate ? editingId : Date.now(),
            name: isUpdate ? slots.find(x=>x.id===editingId).name : `æœªå‘½åäººå“¡`,
            img, suit, p: {...p}, s: {...s},
            refSpec: activeSpec, // ğŸš€ è¨˜éŒ„æ ¡æº–è¦æ ¼
            updatedAt: new Date().toLocaleTimeString(),
            isFinal: true,
            thumb: thumb.toDataURL()
        };

        if (isUpdate) {
            setSlots(slots.map(x => x.id === editingId ? assetData : x));
            setEditingId(null);
        } else {
            setSlots([...slots, assetData]);
        }
    };

    const recall = (as) => {
        setEditingId(as.id); // ğŸš€ é€²å…¥ç·¨è¼¯æ¨¡å¼
        setImg(as.img); setSuit(as.suit); setP(as.p); setS(as.s); setActiveSpec(as.refSpec);
    };

    // ğŸŸ¢ è¼¸å‡ºå¼•æ“ï¼šåŠ å…¥è¦æ ¼é¢¨éšªæª¢æŸ¥
    const handleExport = (key) => {
        startTransition(async () => {
            const spec = SPECS[key];
            const canvas = document.createElement('canvas'); canvas.width = spec.w; canvas.height = spec.h;
            const ctx = canvas.getContext('2d'); ctx.fillStyle="white"; ctx.fillRect(0,0,spec.w,spec.h);

            const fill = (num, grid, size) => {
                const [pw, ph] = size;
                const mx = (spec.w - grid[1]*pw)/(grid[1]+1), my = (spec.h - grid[0]*ph)/(grid[0]+1);
                for (let i=0; i<num; i++) {
                    const r = Math.floor(i/grid[1]), c = i%grid[1];
                    const target = slots[i] || { img, suit, p, s };
                    const ratio = pw/350;
                    const x = mx+c*(pw+mx), y = my+r*(ph+my);
                    ctx.save(); ctx.beginPath(); ctx.rect(x,y,pw,ph); ctx.clip();
                    AtomicRenderer.layer(ctx, target.img, target.p, ratio, x+pw/2, y+ph/2);
                    AtomicRenderer.layer(ctx, target.suit, target.s, ratio, x+pw/2, y+ph/2);
                    ctx.restore();
                    ctx.strokeStyle="#ddd"; ctx.strokeRect(x,y,pw,ph);
                }
            };
            fill(spec.photos, spec.grid, spec.size);
            setPreview(canvas.toDataURL('image/jpeg', 0.9));
        });
    };

    return (
        <div className="max-w-md mx-auto space-y-4">
            <header className="px-2 pt-2 flex justify-between items-end">
                <div>
                    <h1 className="text-xl font-black text-slate-900 tracking-tighter italic">EzID <span className="text-blue-600">v20.37</span></h1>
                    <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Asset Integrity Control</p>
                </div>
                {editingId && <span className="text-[10px] font-bold text-red-500 bg-red-50 px-2 py-1 rounded animate-pulse">ç·¨è¼¯æ¨¡å¼: å°šæœªå­˜æª”</span>}
            </header>

            <div className="canvas-box">
                <canvas ref={canvasRef} width="350" height="450" 
                    onPointerDown={e => { e.target.setPointerCapture(e.pointerId); drag.current = { active: true, x: e.clientX, y: e.clientY }; }}
                    onPointerMove={e => {
                        if(!drag.current.active) return;
                        const f = 1/(target==='PHOTO'?p.s:s.s);
                        const dx = (e.clientX-drag.current.x)*f, dy = (e.clientY-drag.current.y)*f;
                        const up = target==='PHOTO'?setP:setS; up(v=>({...v, x:v.x+dx, y:v.y+dy}));
                        drag.current.x=e.clientX; drag.current.y=e.clientY;
                    }}
                    onPointerUp={()=>drag.current.active=false} />
            </div>

            {/* ğŸš€ æ ¡æº–è¦æ ¼èƒŒæ›¸ */}
            <div className="bg-white p-3 rounded-xl border border-slate-200">
                <p className="text-[9px] font-black text-slate-400 mb-2 uppercase">ç•¶å‰æ ¡æº–åŸºæº–è¦æ ¼</p>
                <div className="flex gap-2 overflow-x-auto no-scrollbar">
                    {Object.values(SPECS).map(s => (
                        <button key={s.id} onClick={()=>setActiveSpec(s.id)} className={`flex-shrink-0 px-3 py-1.5 rounded-lg text-[10px] font-bold border ${activeSpec===s.id?'bg-slate-900 text-white border-slate-900 shadow-md':'bg-white text-slate-400 border-slate-100'}`}>
                            {s.name}
                        </button>
                    ))}
                </div>
            </div>

            {/* ğŸš€ å…·å‚™æ¬Šè²¬æ„Ÿçš„è³‡ç”¢ç®¡ç† */}
            <div className="bg-white p-4 rounded-2xl border border-slate-200 space-y-4 shadow-sm">
                <div className="flex justify-between items-center">
                    <h2 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">è³‡ç”¢åå–®èˆ‡å®šç¨¿ç‹€æ…‹</h2>
                    {editingId ? (
                        <button onClick={()=>commitAsset(true)} className="bg-red-500 text-white text-[10px] font-black px-4 py-2 rounded-lg shadow-lg">æ›´æ–°è³‡ç”¢ (å®šç¨¿)</button>
                    ) : (
                        <button onClick={()=>commitAsset(false)} className="bg-blue-600 text-white text-[10px] font-black px-4 py-2 rounded-lg shadow-lg shadow-blue-100">æ–°å¢å®šç¨¿è³‡ç”¢</button>
                    )}
                </div>

                <div className="space-y-2 max-h-60 overflow-y-auto pr-1">
                    {slots.map(as => (
                        <div key={as.id} className={`slot-card p-3 rounded-lg flex items-center gap-3 border shadow-sm ${editingId===as.id?'editing':'final'}`}>
                            <div className="relative">
                                <img src={as.thumb} className="w-10 h-12 rounded object-cover border bg-white" />
                                <span className="absolute -top-1 -left-1 bg-green-500 text-white text-[7px] px-1 rounded-sm font-bold">VER 1.0</span>
                            </div>
                            <div className="flex-1 min-w-0">
                                <input value={as.name} onChange={e=>{const n=[...slots]; n.find(x=>x.id===as.id).name=e.target.value; setSlots(n);}} className="w-full bg-transparent font-bold text-xs mb-1 outline-none focus:text-blue-600" />
                                <div className="flex flex-wrap gap-x-3 gap-y-1 text-[8px] font-black text-slate-400 uppercase italic">
                                    <span className="text-slate-600">ğŸ“ åŸºéš: {as.refSpec}</span>
                                    <span>ğŸ‘”: {as.suit ? 'ON' : 'OFF'}</span>
                                    <span>T: {as.updatedAt}</span>
                                </div>
                            </div>
                            <div className="flex gap-1">
                                <button onClick={()=>recall(as)} className="bg-white border text-[10px] font-bold px-2 py-1 rounded shadow-sm hover:bg-slate-50">RECALL</button>
                                <button onClick={()=>setSlots(slots.filter(x=>x.id!==as.id))} className="text-slate-300 px-1 text-xs">âœ•</button>
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            {/* ğŸš€ è¼¸å‡ºå€ï¼šèª å¯¦é¢å°ä½¿ç”¨è€… */}
            <div className="bg-slate-900 p-5 rounded-3xl text-white space-y-4">
                <div className="flex items-center gap-2">
                    <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                    <h3 className="text-[10px] font-black uppercase tracking-widest text-slate-400">æ‰¹æ¬¡è¼¸å‡ºå¼•æ“ (300DPI)</h3>
                </div>
                <div className="grid grid-cols-2 gap-2">
                    {Object.keys(SPECS).map(k => (
                        <button key={k} onClick={()=>handleExport(k)} className="h-10 bg-white/5 border border-white/10 rounded-xl text-[10px] font-bold hover:bg-white/10 transition-colors">
                            {SPECS[k].name}
                        </button>
                    ))}
                </div>
                <p className="text-[8px] text-slate-500 text-center italic">æ³¨æ„ï¼šè‹¥ Slot æ ¡æº–åŸºæº–èˆ‡è¼¸å‡ºè¦æ ¼ä¸åŒï¼Œç³»çµ±å°‡è‡ªå‹•é€²è¡Œæœ€ä½³é©é…æ›ç®—ã€‚</p>
            </div>

            {preview && (
                <div className="fixed inset-0 bg-slate-950/98 z-[9999] flex flex-col items-center justify-center p-8 backdrop-blur-md">
                    <img src={preview} className="max-w-full max-h-[75vh] border-2 border-white/10 shadow-2xl rounded-sm mb-8" />
                    <div className="flex gap-4 w-full max-w-sm">
                        <button onClick={()=>setPreview(null)} className="flex-1 h-14 bg-white/10 text-white rounded-2xl font-bold">è¿”å›æ ¸å°</button>
                        <a href={preview} download="EzID_Export.jpg" className="flex-1 h-14 bg-blue-600 text-white rounded-2xl font-black flex items-center justify-center shadow-lg">ğŸ’¾ ç¢ºèªç„¡èª¤ï¼Œä¸‹è¼‰</a>
                    </div>
                </div>
            )}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
