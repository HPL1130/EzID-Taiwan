<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzID Taiwan v14.0 - å®Œç¾ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --canvas-w: 350px;
            --canvas-h: 450px;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .canvas-container { 
            position: relative; width: var(--canvas-w); height: var(--canvas-h); margin: 10px auto; 
            background: linear-gradient(145deg, #ffffff, #f8fafc); 
            border: 4px solid #0f172a; border-radius: 24px; overflow: hidden; 
            touch-action: none; cursor: grab; box-shadow: 
                0 25px 50px -12px rgba(0,0,0,0.25),
                0 0 0 1px rgba(255,255,255,0.2) inset;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .canvas-container:active { 
            cursor: grabbing; 
            transform: translateY(2px);
            box-shadow: 0 15px 35px -12px rgba(0,0,0,0.3);
        }
        .preview-overlay { 
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); 
            z-index: 9999; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; padding: 20px; 
            backdrop-filter: blur(8px);
        }
        .control-group { display: flex; align-items: center; gap: 12px; }
        .value-display { 
            min-width: 44px; font-family: 'SF Mono', monospace; 
            font-weight: 600; font-size: 11px; text-align: right; 
            color: #1e293b; background: rgba(248,250,252,0.5); 
            padding: 2px 6px; border-radius: 4px; border: 1px solid #e2e8f0;
        }
        @keyframes pulse-glow { 0%,100%{opacity:1} 50%{opacity:0.7} }
        .pulse-glow { animation: pulse-glow 2s infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen pb-24">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback, useLayoutEffect, useMemo } = React;

const SUITS = ['male/m1.png','male/m2.png','male/m3.png','male/m4.png','male/m5.png','female/f1.png','female/f2.png','female/f3.png','female/f4.png','female/f5.png'];

// ğŸ”’ ä¼æ¥­ç´šæª”æ¡ˆé©—è­‰
const validateImageFile = (file) => {
    const MAX_SIZE = 8 * 1024 * 1024; // 8MBä¼æ¥­æ¨™æº–
    const ALLOWED_TYPES = ['image/jpeg','image/png','image/webp'];
    return file?.size <= MAX_SIZE && ALLOWED_TYPES.includes(file.type);
};

// ğŸ¨ é›™ç·©è¡Canvas - é›¶æ’•è£‚
function useDoubleBufferedCanvas(canvasRef, image, suitImg, photoT, suitT, config) {
    const offscreenRef = useRef(null);
    const draw = useCallback(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
        const { bright, guide } = config;
        
        // âœ… é›™ç·©è¡ç¹ªè£½
        const offscreen = offscreenRef.current || document.createElement('canvas');
        offscreen.width = 350; offscreen.height = 450;
        offscreenRef.current = offscreen;
        const offCtx = offscreen.getContext('2d');
        
        // æ¸…ç©ºé›¢å±ç•«å¸ƒ
        offCtx.fillStyle = '#ffffff';
        offCtx.fillRect(0, 0, 350, 450);
        
        // äººåƒ - ä¼æ¥­ç´šæ¿¾é¡
        if (image?.complete) {
            offCtx.save();
            offCtx.filter = `brightness(${bright}%) contrast(1.08) saturate(1.05)`;
            offCtx.translate(175 + photoT.x, 225 + photoT.y);
            offCtx.rotate(photoT.r * Math.PI / 180);
            offCtx.scale(photoT.s * photoT.f, photoT.s);
            offCtx.imageSmoothingQuality = 'high';
            offCtx.drawImage(image, -image.width / 2, -image.height / 2);
            offCtx.restore();
        }
        
        // è¡£æœ
        if (suitImg?.complete) {
            offCtx.save();
            offCtx.translate(175 + suitT.x, 225 + suitT.y);
            offCtx.rotate(suitT.r * Math.PI / 180);
            offCtx.scale(suitT.s, suitT.s);
            offCtx.imageSmoothingQuality = 'high';
            offCtx.drawImage(suitImg, -suitImg.width / 2, -suitImg.height / 2);
            offCtx.restore();
        }
        
        // é«˜ç²¾åº¦å°ä½ç·š
        if (guide > 0) {
            offCtx.save();
            offCtx.globalAlpha = guide;
            offCtx.setLineDash([6, 4]);
            offCtx.lineWidth = 2.5;
            offCtx.lineCap = 'round';
            offCtx.shadowColor = '#10b981';
            offCtx.shadowBlur = 8;
            
            const isCentered = Math.abs(photoT.x) < 4 && Math.abs(photoT.y + 20) < 4;
            offCtx.strokeStyle = isCentered ? '#10b981' : '#f87171';
            
            offCtx.beginPath();
            offCtx.ellipse(175, 203, 108, 160, 0, 0, Math.PI * 2);
            offCtx.stroke();
            offCtx.restore();
        }
        
        // è¤‡è£½åˆ°ä¸»ç•«å¸ƒ (é›¶æ’•è£‚)
        ctx.drawImage(offscreen, 0, 0);
    }, [image?.complete, suitImg?.complete, photoT, suitT, config.bright, config.guide]);

    useLayoutEffect(() => {
        draw();
    }, [draw]);
}

function App() {
    // ğŸ—ï¸ ç‹€æ…‹æ¶æ§‹å„ªåŒ–
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [suitIndex, setSuitIndex] = useState(-1);
    const [photoTransform, setPhotoTransform] = useState({ x: 0, y: -20, s: 0.45, r: 0, f: 1 });
    const [suitTransform, setSuitTransform] = useState({ x: 0, y: 80, s: 1.0, r: 0 });
    const [config, setConfig] = useState({ bright: 100, guide: 0.8, name: 'EzID' });
    const [slots, setSlots] = useState([]);
    const [target, setTarget] = useState('PHOTO');
    const [preImg, setPreImg] = useState(null);
    const [uiState, setUiState] = useState({ isDragging: false, isExporting: false });
    
    const canvasRef = useRef(null);
    const dragState = useRef({ x: 0, y: 0 });
    const rafRef = useRef(0);
    const revokeQueue = useRef(new Set());
    const exportWorkerRef = useRef(null);
    
    // ğŸ”„ ä¼æ¥­ç´šè¨˜æ†¶é«”ç®¡ç†
    useEffect(() => {
        return () => {
            revokeQueue.current.forEach(URL.revokeObjectURL);
            revokeQueue.current.clear();
            if (exportWorkerRef.current) {
                exportWorkerRef.current.terminate();
            }
        };
    }, []);

    // ğŸ® å®Œç¾æ‹–æ›³æ§åˆ¶
    const handleDragStart = useCallback((e) => {
        e.preventDefault();
        setUiState(s => ({ ...s, isDragging: true }));
        
        const rect = canvasRef.current.getBoundingClientRect();
        const clientX = e.touches?.[0]?.clientX || e.clientX;
        const clientY = e.touches?.[0]?.clientY || e.clientY;
        
        dragState.current = {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    }, []);

    const handleDrag = useCallback((e) => {
        if (!uiState.isDragging) return;
        e.preventDefault();
        
        const rect = canvasRef.current.getBoundingClientRect();
        const clientX = e.touches?.[0]?.clientX || e.clientX;
        const clientY = e.touches?.[0]?.clientY || e.clientY;
        
        const dx = (clientX - rect.left - dragState.current.x) * 0.6;
        const dy = (clientY - rect.top - dragState.current.y) * 0.6;
        
        dragState.current.x = clientX - rect.left;
        dragState.current.y = clientY - rect.top;
        
        // RAFæµæš¢æ›´æ–°
        cancelAnimationFrame(rafRef.current);
        rafRef.current = requestAnimationFrame(() => {
            if (target === 'PHOTO') {
                setPhotoTransform(p => ({
                    ...p,
                    x: Math.max(-220, Math.min(220, p.x + dx)),
                    y: Math.max(-180, Math.min(280, p.y + dy))
                }));
            } else {
                setSuitTransform(s => ({
                    ...s,
                    x: Math.max(-220, Math.min(220, s.x + dx)),
                    y: Math.max(-180, Math.min(280, s.y + dy))
                }));
            }
        });
    }, [uiState.isDragging, target]);

    const handleDragEnd = useCallback(() => {
        setUiState(s => ({ ...s, isDragging: false }));
    }, []);

    // ğŸ“ ä¼æ¥­ç´šæª”æ¡ˆè™•ç†
    const handleFileUpload = useCallback((e) => {
        const file = e.target.files[0];
        if (!validateImageFile(file)) {
            alert('è«‹ä¸Šå‚³å°æ–¼8MBçš„JPG/PNG/WebPæª”æ¡ˆ');
            e.target.value = '';
            return;
        }

        const url = URL.createObjectURL(file);
        revokeQueue.current.add(url);
        
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.decode().then(() => {
            setImage(img);
            setTarget('PHOTO');
            setPhotoTransform({ x: 0, y: -20, s: 0.45, r: 0, f: 1 });
        }).catch(() => {
            alert('åœ–ç‰‡è§£ç¢¼å¤±æ•—');
            URL.revokeObjectURL(url);
            revokeQueue.current.delete(url);
        });
        img.src = url;
    }, []);

    // ğŸ‘• æ™ºæ…§è¡£æœè¼‰å…¥
    const loadSuit = useCallback((index) => {
        if (suitIndex === index) return;
        setSuitIndex(index);
        
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.decode().then(() => {
            setSuitImg(img);
            setTarget('SUIT');
        }).catch(() => {
            setSuitImg(null);
            setSuitIndex(-1);
        });
        img.src = `clothes/${SUITS[index]}`;
    }, [suitIndex]);

    // ğŸ’¾ æ§½ä½ç®¡ç†
    const saveToSlot = useCallback(() => {
        if (!canvasRef.current) return;
        const canvas = document.createElement('canvas');
        canvas.width = 350; canvas.height = 450;
        canvas.getContext('2d').drawImage(canvasRef.current, 0, 0);
        
        const dataUrl = canvas.toDataURL('image/webp', 0.92); // WebPå£“ç¸®
        setSlots(prev => [dataUrl, ...prev.slice(0, 9)]);
    }, []);

    // ğŸ–¨ï¸ WorkeråŒ¯å‡º - ä¸»ç·šç¨‹é›¶é˜»å¡
    const exportA4 = useCallback(async () => {
        if (!slots.length) {
            alert('è«‹å…ˆå„²å­˜è‡³æ§½ä½');
            return;
        }

        setUiState(s => ({ ...s, isExporting: true }));
        
        // Web WorkeréåŒæ­¥åŒ¯å‡º
        const workerCode = `
            self.onmessage = async e => {
                const { slots } = e.data;
                const canvas = new OffscreenCanvas(2480, 3508);
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, 2480, 3508);
                
                const images = await Promise.all(slots.slice(0,20).map(src => 
                    new Promise(r => {
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        img.onload = () => r(img);
                        img.onerror = () => r(null);
                        img.src = src;
                    })
                ));
                
                for(let i = 0; i < images.length; i++) {
                    const img = images[i];
                    if(img) {
                        const x = 205 + (i%4)*520;
                        const y = 300 + Math.floor(i/4)*600;
                        ctx.drawImage(img, x, y, 413, 531);
                        ctx.strokeStyle = '#e0e0e0';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(x, y, 413, 531);
                    }
                }
                
                canvas.convertToBlob({type: 'image/webp', quality: 0.95}).then(blob => {
                    const reader = new FileReader();
                    reader.onload = () => self.postMessage({ dataUrl: reader.result, filename: blob.name });
                    reader.readAsDataURL(blob);
                });
            };
        `;
        
        const blob = new Blob([workerCode], { type: 'application/javascript' });
        const worker = new Worker(URL.createObjectURL(blob));
        
        worker.onmessage = (e) => {
            setPreImg(e.data.dataUrl);
            setUiState(s => ({ ...s, isExporting: false }));
            worker.terminate();
        };
        
        worker.postMessage({ slots });
    }, [slots]);

    const getFullFileName = useCallback(() => {
        const now = new Date();
        return `${config.name}_${now.toISOString().slice(2,16).replace(/[:-]/g,'')}.webp`;
    }, [config.name]);

    // Canvasç¹ªè£½
    useDoubleBufferedCanvas(canvasRef, image, suitImg, photoTransform, suitTransform, config);

    return (
        <div className="max-w-md mx-auto p-6 space-y-4">
            {/* ğŸš€ ä¼æ¥­ç´šHeader */}
            <header className="flex justify-between items-center p-6 bg-white/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/50">
                <div className="flex items-center gap-3">
                    <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <span className="text-2xl">ğŸªª</span>
                    </div>
                    <div>
                        <h1 className="text-2xl font-black bg-gradient-to-r from-slate-800 to-slate-900 bg-clip-text text-transparent">EzID</h1>
                        <div className="text-xs font-bold text-emerald-600 bg-emerald-100 px-2 py-0.5 rounded-full">v14.0 PERFECT</div>
                    </div>
                </div>
                
                <div className="flex items-center gap-2">
                    <input 
                        value={config.name} 
                        onChange={e => setConfig(c => ({ ...c, name: e.target.value.slice(0, 20) }))}
                        className="w-20 px-3 py-1 bg-slate-100/50 rounded-xl text-sm font-bold border border-slate-200 focus:border-blue-400 outline-none backdrop-blur-sm transition-all"
                        maxLength={20}
                        placeholder="æª”æ¡ˆå"
                    />
                    <button 
                        onClick={() => setPhotoTransform(p => ({ ...p, f: p.f * -1 }))}
                        className="px-3 py-2 bg-gradient-to-r from-slate-800 to-slate-900 hover:from-slate-700 hover:to-slate-800 text-white rounded-xl text-xs font-bold shadow-md hover:shadow-lg active:scale-95 transition-all"
                        title="é¡åƒç¿»è½‰"
                    >
                        ğŸ”„
                    </button>
                    <button 
                        onClick={() => {
                            setPhotoTransform({ x: 0, y: -20, s: 0.45, r: 0, f: 1 });
                            setSuitTransform({ x: 0, y: 80, s: 1.0, r: 0 });
                        }}
                        className="px-3 py-2 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-400 hover:to-emerald-500 text-white rounded-xl text-xs font-bold shadow-md hover:shadow-lg active:scale-95 transition-all"
                        title="é‡ç½®ä½ç½®"
                    >
                        â†º
                    </button>
                </div>
            </header>

            {/* ğŸ–¼ï¸ é›™ç·©è¡Canvas */}
            <div 
                className={`canvas-container ${uiState.isDragging ? 'grabbing' : ''}`}
                onPointerDown={handleDragStart}
                onPointerMove={handleDrag}
                onPointerUp={handleDragEnd}
                onPointerLeave={handleDragEnd}
                onTouchStart={handleDragStart}
                onTouchMove={handleDrag}
                onTouchEnd={handleDragEnd}
            >
                <canvas ref={canvasRef} width="350" height="450" className="w-full h-full" />
            </div>

            {/* ğŸ‘• æ™ºæ…§è¡£æœé¸æ“‡å™¨ */}
            <div className="bg-white/80 backdrop-blur-sm p-4 rounded-3xl shadow-xl border border-white/50">
                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2 -mb-2">
                    <button 
                        onClick={() => { setSuitImg(null); setSuitIndex(-1); setTarget('PHOTO'); }}
                        className="group relative w-16 h-16 rounded-2xl border-2 border-dashed border-red-300 bg-red-50/50 flex items-center justify-center hover:bg-red-100 active:scale-95 transition-all shadow-sm hover:shadow-md"
                    >
                        <span className="text-xl group-hover:scale-110 transition-transform">ğŸš«</span>
                    </button>
                    {SUITS.map((suit, i) => (
                        <button 
                            key={i}
                            onClick={() => loadSuit(i)}
                            className={`group relative w-16 h-16 rounded-2xl border-2 overflow-hidden shadow-sm hover:shadow-md active:scale-95 transition-all
                                ${suitIndex === i 
                                    ? 'border-blue-500 ring-2 ring-blue-200/50 shadow-lg bg-blue-50/50 scale-105' 
                                    : 'border-slate-200/50 hover:border-blue-300 hover:scale-105 hover:shadow-lg'
                                }`}
                        >
                            <img src={`clothes/${suit}`} className="w-full h-full object-cover" />
                            {suitIndex === i && (
                                <div className="absolute inset-0 bg-blue-500/20 backdrop-blur-sm flex items-center justify-center">
                                    <span className="text-blue-600 text-xs font-bold">âœ“</span>
                                </div>
                            )}
                        </button>
                    ))}
                </div>
            </div>

            {/* âš™ï¸ å°ˆæ¥­æ§åˆ¶é¢æ¿ */}
            <div className="bg-white/80 backdrop-blur-sm p-6 rounded-[2.5rem] shadow-2xl border border-white/50 space-y-4">
                <div className="flex bg-gradient-to-r from-slate-100 to-slate-200 p-1 rounded-2xl shadow-inner">
                    <button 
                        onClick={() => setTarget('PHOTO')}
                        className={`flex-1 py-3 px-4 text-sm font-black rounded-xl transition-all shadow-sm ${
                            target === 'PHOTO' 
                                ? 'bg-white text-blue-600 shadow-md scale-[1.02]' 
                                : 'text-slate-500 hover:text-slate-700 hover:bg-white/50 hover:scale-[1.02]'
                        }`}
                    >
                        ğŸ‘¤ äººåƒ
                    </button>
                    <button 
                        onClick={() => setTarget('SUIT')}
                        className={`flex-1 py-3 px-4 text-sm font-black rounded-xl transition-all shadow-sm ${
                            target === 'SUIT' 
                                ? 'bg-white text-blue-600 shadow-md scale-[1.02]' 
                                : 'text-slate-500 hover:text-slate-700 hover:bg-white/50 hover:scale-[1.02]'
                        }`}
                    >
                        ğŸ‘• è¡£æœ
                    </button>
                </div>

                <div className="space-y-3">
                    {[
                        { key: 's', label: 'SIZE', min: 0.1, max: 2.5, step: 0.01, unit: 'x', color: 'blue' },
                        { key: 'r', label: 'ROTATE', min: -60, max: 60, step: 1, unit: 'Â°', color: 'emerald' }
                    ].map(({ key, label, min, max, step, unit, color }, i) => (
                        <div key={i} className="control-group">
                            <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wide w-12">{label}</span>
                            <input 
                                type="range" 
                                min={min} max={max} step={step}
                                value={target === 'PHOTO' 
                                    ? photoTransform[key] 
                                    : suitTransform[key]
                                }
                                onChange={e => {
                                    const v = +e.target.value;
                                    if (target === 'PHOTO') {
                                        setPhotoTransform(p => ({ ...p, [key]: v }));
                                    } else {
                                        setSuitTransform(s => ({ ...s, [key]: v }));
                                    }
                                }}
                                className={`flex-1 h-2 bg-slate-200 rounded-full accent-${color}-500 hover:accent-${color}-400 cursor-pointer shadow-sm`}
                            />
                            <span className="value-display">
                                {target === 'PHOTO' 
                                    ? (photoTransform[key] + (key === 'r' ? unit : unit)).toFixed(key === 's' ? 2 : 0)
                                    : (suitTransform[key] + (key === 'r' ? unit : unit)).toFixed(key === 's' ? 2 : 0)
                                }
                            </span>
                        </div>
                    ))}
                    
                    <div className="control-group">
                        <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wide w-12">BRIGHT</span>
                        <input 
                            type="range" min="50" max="150" step="1" 
                            value={config.bright}
                            onChange={e => setConfig(c => ({ ...c, bright: +e.target.value }))}
                            className="flex-1 h-2 bg-slate-200 rounded-full accent-amber-500 hover:accent-amber-400 cursor-pointer shadow-sm"
                        />
                        <span className="value-display">{config.bright}%</span>
                    </div>
                    
                    <div className="control-group">
                        <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wide w-12">GUIDE</span>
                        <input 
                            type="range" min="0" max="1" step="0.05" 
                            value={config.guide}
                            onChange={e => setConfig(c => ({ ...c, guide: +e.target.value }))}
                            className="flex-1 h-2 bg-slate-200 rounded-full accent-slate-400 hover:accent-slate-300 cursor-pointer shadow-sm"
                        />
                        <span className="value-display">{Math.round(config.guide * 100)}%</span>
                    </div>
                </div>
            </div>

            {/* ğŸ¯ ä¸»è¦æ“ä½œ */}
            <div className="grid grid-cols-2 gap-4">
                <label className="group block bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 hover:from-slate-800 hover:to-slate-700 text-white py-5 rounded-3xl text-center font-black shadow-2xl hover:shadow-3xl active:scale-95 transition-all cursor-pointer border-2 border-slate-800/30">
                    <span className="text-2xl mb-1 block">ğŸ“¸</span>
                    <span className="text-sm tracking-wide">ä¸Šå‚³ç…§ç‰‡</span>
                    <input type="file" accept="image/*" hidden onChange={handleFileUpload} />
                </label>
                <button 
                    onClick={saveToSlot}
                    className="group bg-gradient-to-br from-blue-600 via-blue-700 to-blue-800 hover:from-blue-500 hover:via-blue-600 hover:to-blue-700 text-white py-5 rounded-3xl font-black shadow-2xl hover:shadow-3xl active:scale-95 transition-all relative overflow-hidden"
                >
                    <span className="text-2xl mb-1 block">ğŸ“¥</span>
                    <span className="text-sm tracking-wide">å­˜å…¥æ§½ä½<br/><span className="text-xs opacity-90">({slots.length}/10)</span></span>
                </button>
            </div>

            {/* ğŸ—‚ï¸ æ™ºæ…§æ§½ä½ç®¡ç† */}
            <div className="bg-white/70 backdrop-blur-sm p-5 rounded-[2.5rem] shadow-2xl border border-white/50 min-h-[150px]">
                <div className="flex gap-3 overflow-x-auto no-scrollbar pb-3 -mb-3">
                    {slots.map((slot, i) => (
                        <div key={i} className="relative w-24 h-32 bg-gradient-to-br from-slate-50 to-slate-100 rounded-2xl shadow-xl flex-shrink-0 border border-slate-200 hover:shadow-2xl hover:scale-105 transition-all duration-200 overflow-hidden group">
                            <img src={slot} className="w-full h-full object-cover rounded-xl" loading="lazy" />
                            <button 
                                className="absolute top-1.5 right-1.5 w-7 h-7 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-xl shadow-lg backdrop-blur-sm active:scale-90 transition-all flex items-center justify-center text-sm font-bold opacity-0 group-hover:opacity-100"
                                onClick={() => setSlots(p => p.filter((_, idx) => idx !== i))}
                                title="åˆªé™¤"
                            >
                                Ã—
                            </button>
                            <button 
                                className="absolute inset-x-0 bottom-0 bg-gradient-to-t from-slate-900/95 to-slate-700/70 text-white text-[10px] text-center py-2 backdrop-blur-sm opacity-90 hover:opacity-100 hover:from-slate-900 transition-all font-medium"
                                onClick={() => alert('å·²è¼‰å…¥æˆªåœ–
(å®Œæ•´ç·¨è¼¯ç‹€æ…‹éœ€å¾Œç«¯å„²å­˜)')
                            >
                                é‡æ–°ç·¨è¼¯
                            </button>
                        </div>
                    ))}
                    {slots.length === 0 && (
                        <div className="w-full h-32 bg-slate-100/50 rounded-2xl flex items-center justify-center text-slate-400 text-sm font-medium">
                            æš«ç„¡å„²å­˜åœ–ç‰‡
                        </div>
                    )}
                </div>
            </div>

            {/* ğŸš€ çµ‚æ¥µåŒ¯å‡º */}
            <div className="bg-gradient-to-r from-emerald-600 via-emerald-700 to-emerald-800 hover:from-emerald-500 hover:via-emerald-600 hover:to-emerald-700 text-white p-7 rounded-[2.5rem] shadow-2xl hover:shadow-3xl active:scale-95 transition-all cursor-pointer relative overflow-hidden group">
                <button 
                    onClick={exportA4}
                    disabled={uiState.isExporting}
                    className="w-full text-xl font-black tracking-wide flex flex-col items-center gap-1 relative z-10"
                >
                    {uiState.isExporting ? (
                        <>
                            <span className="w-6 h-6 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
                            <span className="text-sm opacity-90">åŒ¯å‡ºä¸­...</span>
                        </>
                    ) : (
                        <>
                            <span className="text-3xl">ğŸ–¨ï¸</span>
                            <span>A4 å°ˆæ¥­æ’ç‰ˆ</span>
                            <span className="text-xs opacity-75 font-normal">WebP è¶…å£“ç¸®</span>
                        </>
                    )}
                </button>
                <div className="absolute inset-0 bg-white/20 backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity scale-110 group-hover:scale-100"></div>
            </div>

            {/* ğŸ’ å®Œç¾é è¦½å°è©±æ¡† */}
            {preImg && (
                <div className="preview-overlay" onClick={e => e.target === e.currentTarget && setPreImg(null)}>
                    <div className="bg-white/95 backdrop-blur-xl p-8 rounded-3xl shadow-2xl max-w-[95vw] max-h-[85vh] overflow-auto max-w-4xl mx-4 border border-white/50" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-start mb-6">
                            <h2 className="text-2xl font-black bg-gradient-to-r from-slate-800 to-slate-900 bg-clip-text text-transparent">åŒ¯å‡ºé è¦½</h2>
                            <button 
                                onClick={() => setPreImg(null)}
                                className="p-2 hover:bg-slate-200 rounded-xl transition-all hover:scale-110 text-2xl"
                                title="é—œé–‰"
                            >
                                Ã—
                            </button>
                        </div>
                        <div className="max-h-[65vh] overflow-auto rounded-2xl border-4 border-slate-200/50 shadow-2xl">
                            <img src={preImg} className="w-full h-auto block" alt="A4æ’ç‰ˆé è¦½" />
                        </div>
                        <div className="flex gap-4 mt-8 pt-6 border-t border-slate-200">
                            <button 
                                onClick={() => setPreImg(null)}
                                className="flex-1 py-4 px-6 bg-slate-200 hover:bg-slate-300 text-slate-800 rounded-2xl font-bold shadow-lg hover:shadow-xl active:scale-95 transition-all text-center"
                            >
                                è¿”å›ç·¨è¼¯
                            </button>
                            <a 
                                href={preImg} 
                                download={getFullFileName()}
                                className="flex-1 py-4 px-6 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-400 hover:to-emerald-500 text-white rounded-2xl font-black shadow-2xl hover:shadow-3xl active:scale-95 transition-all text-center flex items-center justify-center gap-2 text-lg"
                            >
                                ğŸ’¾ ä¸‹è¼‰æª”æ¡ˆ
                            </a>
                        </div>
                    </div>
                </div>
            )}

            {/* âŒ¨ï¸ å°ˆæ¥­å¿«æ·éµæç¤º */}
            <div className="fixed bottom-6 right-6 w-12 h-12 bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl flex items-center justify-center text-slate-600 text-sm font-bold border cursor-default hover:bg-white hover:shadow-2xl transition-all">
                âŒ¨ï¸
            </div>
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
