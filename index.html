<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>證件照換裝系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@imgly/background-removal@1.5.3/dist/index.js"></script>

    <style>
        /* 橢圓定位框的自定義樣式 */
        .head-guide {
            width: 200px;
            height: 260px;
            border: 3px dashed rgba(255, 255, 255, 0.8);
            border-radius: 50% / 50%;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); /* 黑色半透明遮罩 */
            position: relative;
        }
        .head-guide::after {
            content: '請將頭部對準此圓框';
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            white-space: nowrap;
            font-size: 14px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        function App() {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const [capturedImage, setCapturedImage] = useState(null);
            const [isRemovingBg, setIsRemovingBg] = useState(false);
            const [selectedSuit, setSelectedSuit] = useState(null);
            
            // 衣服清單 - 確保檔案就在 HTML 旁邊
            const suits = [
                { id: 'm1', url: './suit-m1.png', label: '西裝 1' },
                { id: 'm2', url: './suit-m2.png', label: '西裝 2' },
                { id: 'm3', url: './suit-m3.png', label: '西裝 3' },
                { id: 'm4', url: './suit-m4.png', label: '西裝 4' },
                { id: 'm5', url: './suit-m5.png', label: '西裝 5' }
            ];

            // 啟動相機
            useEffect(() => {
                async function startCamera() {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                        if (videoRef.current) videoRef.current.srcObject = stream;
                    } catch (err) {
                        alert("無法開啟相機，請檢查權限或連線。");
                    }
                }
                startCamera();
            }, []);

            // 拍照並去背
            const takePhoto = async () => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/png');
                
                // 開始去背
                setIsRemovingBg(true);
                try {
                    // 使用 imgly 去背
                    const blob = await imglyConfig.removeBackground(imageData);
                    const noBgUrl = URL.createObjectURL(blob);
                    setCapturedImage(noBgUrl);
                } catch (error) {
                    console.error("去背失敗:", error);
                    alert("去背失敗，請確認是否在伺服器環境(Live Server)下執行。");
                    setCapturedImage(imageData); // 失敗則顯示原圖
                } finally {
                    setIsRemovingBg(false);
                }
            };

            return (
                <div className="flex flex-col items-center p-4">
                    <h1 className="text-2xl font-bold mb-4">智能證件照系統</h1>

                    <div className="relative bg-black rounded-lg overflow-hidden w-[320px] h-[440px] shadow-xl">
                        {!capturedImage ? (
                            <>
                                {/* 相機預覽 */}
                                <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover" />
                                
                                {/* 定位橢圓框 */}
                                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <div className="head-guide"></div>
                                </div>

                                <button 
                                    onClick={takePhoto}
                                    className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-2 rounded-full font-bold"
                                >
                                    {isRemovingBg ? "處理中..." : "拍照去背"}
                                </button>
                            </>
                        ) : (
                            <div className="relative w-full h-full bg-blue-500">
                                {/* 去背後的照片 */}
                                <img src={capturedImage} className="absolute inset-0 w-full h-full object-contain z-10" />
                                
                                {/* 疊加的衣服 */}
                                {selectedSuit && (
                                    <img 
                                        src={selectedSuit} 
                                        className="absolute bottom-0 left-0 w-full z-20 pointer-events-none"
                                        style={{ transform: 'scale(1.1) translateY(10%)' }}
                                    />
                                )}
                                
                                <button 
                                    onClick={() => {setCapturedImage(null); setSelectedSuit(null);}}
                                    className="absolute top-2 right-2 bg-gray-800/50 text-white p-2 rounded z-30"
                                >
                                    重新拍照
                                </button>
                            </div>
                        )}
                    </div>

                    {/* 衣服選擇區 */}
                    <div className="mt-6 w-full max-w-md">
                        <p className="font-bold mb-2 text-center">選擇衣服類型：</p>
                        <div className="flex gap-2 overflow-x-auto p-2 bg-white rounded-lg shadow">
                            {suits.map(suit => (
                                <div key={suit.id} className="flex-shrink-0 flex flex-col items-center">
                                    <img 
                                        src={suit.url}
                                        alt={suit.label}
                                        className={`w-16 h-16 object-contain border-2 rounded p-1 cursor-pointer ${selectedSuit === suit.url ? 'border-blue-500 bg-blue-50' : 'border-transparent'}`}
                                        onClick={() => setSelectedSuit(suit.url)}
                                        onError={(e) => { e.target.src = "https://via.placeholder.com/60?text=無圖"; }}
                                    />
                                    <span className="text-xs mt-1">{suit.label}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    <canvas ref={canvasRef} className="hidden"></canvas>
                    
                    {isRemovingBg && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-lg text-center">
                                <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mx-auto mb-4"></div>
                                <p>正在進行 AI 去背，請稍候...</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
