<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.47.24</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face { font-family: 'NotoSansTC'; src: local('Microsoft JhengHei'); font-weight: 700; }
        body { font-family: 'NotoSansTC', sans-serif; background: #020617; color: #f8fafc; margin: 0; }
        #root { width: 100%; max-width: 500px; margin: 0 auto; min-height: 100vh; padding-bottom: 50px; }
        .editor-stage { position: relative; width: 100%; aspect-ratio: 350/450; background: #fff; border-radius: 32px; overflow: hidden; touch-action: none; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.8); }
        .guide-circle { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 65%; border: 2px dashed rgba(59, 130, 246, 0.4); border-radius: 50%; pointer-events: none; z-index: 10; }
        .suit-thumb { flex: 0 0 70px; height: 70px; border-radius: 16px; border: 2px solid #1e293b; background: #fff; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .suit-thumb.active { border-color: #3b82f6; transform: scale(1.1); box-shadow: 0 0 20px rgba(59,130,246,0.4); }
        .fatal-screen { position: fixed; inset: 0; background: #450a0a; color: #fecaca; z-index: 9999; display: flex; flex-direction: column; items: center; justify-content: center; padding: 40px; text-align: center; }
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

/* [å€å¡Š 1: æ ¸å¿ƒå¥‘ç´„] âš ï¸ ç¦æ­¢ä¿®æ”¹æ•¸é‡èˆ‡ MIX çµæ§‹ */
const SPECS = {
    '4x6-8':   { id: '4x6-8',   w: 1800, h: 1200, grid: [2, 4], size: [413, 531], name: '2å‹(8)', cat: '4x6' },
    '4x6-10':  { id: '4x6-10',  w: 1800, h: 1200, grid: [2, 5], size: [295, 413], name: '1å‹(10)', cat: '4x6' },
    '4x6-12':  { id: '4x6-12',  w: 1800, h: 1200, grid: [3, 4], size: [295, 413], name: '1å‹(12)', cat: '4x6' },
    '4x6-BIG': { id: '4x6-BIG', w: 1800, h: 1200, grid: [2, 3], size: [531, 708], name: 'å¤§é ­(6)', cat: '4x6' },
    '4x6-MIX': { 
        id: '4x6-MIX', w: 1800, h: 1200, name: 'ç¶œåˆ(8)', cat: '4x6',
        sections: [{ x: 0, grid: [2, 2], size: [450, 600], count: 4, w: 900, h: 1200 }, { x: 900, grid: [2, 2], size: [413, 531], count: 4, w: 900, h: 1200 }]
    },
    'A4-20':   { id: 'A4-20',   w: 2480, h: 3508, grid: [5, 4], size: [413, 531], name: '2å‹(20)', cat: 'A4' },
    'A4-42':   { id: 'A4-42',   w: 2480, h: 3508, grid: [7, 6], size: [295, 413], name: '1å‹(42)', cat: 'A4' },
    'A4-ID':   { id: 'A4-ID',   w: 2480, h: 3508, grid: [4, 4], size: [450, 600], name: 'è­·ç…§(16)', cat: 'A4' },
    'A4-BIG':  { id: 'A4-BIG',  w: 2480, h: 3508, grid: [4, 3], size: [531, 708], name: 'å¤§é ­(12)', cat: 'A4' },
    'A4-B':    { id: 'A4-B',    w: 2480, h: 3508, grid: [6, 5], size: [354, 472], name: 'Bç‰ˆ(30)', cat: 'A4' },
    'NAME':    { id: 'NAME',    w: 2480, h: 3508, grid: [6, 4], size: [295, 413], name: 'å·¥ç‰Œ(24)', cat: 'A4' },
    'A4-MIX':  { 
        id: 'A4-MIX', w: 2480, h: 3508, name: 'ç¶œåˆ(30)', cat: 'A4',
        sections: [{ y: 0, grid: [3, 4], size: [413, 531], count: 12, w: 2480, h: 1754 }, { y: 1754, grid: [3, 6], size: [295, 413], count: 18, w: 2480, h: 1754 }]
    }
};

const SUIT_LIST = {
    female: Array.from({length: 5}, (_, i) => `https://raw.githubusercontent.com/HPL1130/EzID-Taiwan/main/clothes/female/f${i+1}.png`),
    male: Array.from({length: 5}, (_, i) => `https://raw.githubusercontent.com/HPL1130/EzID-Taiwan/main/clothes/male/m${i+1}.png`)
};

const Renderer = {
    calculateLayout: (spec) => {
        const getGrid = (w, h, grid, size, ox = 0, oy = 0, limit = Infinity) => {
            const [rows, cols] = grid, [pw, ph] = size;
            const gapX = (w - (cols * pw)) / (cols + 1);
            const gapY = (h - (rows * ph)) / (rows + 1);
            const slots = [];
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    if (slots.length >= limit) break;
                    slots.push({ x: ox + gapX + c * (pw + gapX), y: oy + gapY + r * (ph + gapY), w: pw, h: ph });
                }
            }
            return slots;
        };
        return spec.sections ? spec.sections.flatMap(s => getGrid(s.w || spec.w, s.h || spec.h, s.grid, s.size, s.x || 0, s.y || 0, s.count)) : getGrid(spec.w, spec.h, spec.grid, spec.size);
    },
    drawLayer: (ctx, img, t, rect, baseW = 350) => {
        if (!img) return;
        const r = rect.w / baseW;
        ctx.save();
        ctx.beginPath(); ctx.rect(rect.x, rect.y, rect.w, rect.h); ctx.clip();
        ctx.translate(rect.x + rect.w/2 + t.x * r, rect.y + rect.h/2 + t.y * r);
        ctx.rotate(t.r * Math.PI / 180);
        ctx.scale(t.s * r * (t.f || 1), t.s * r);
        ctx.drawImage(img, -img.width/2, -img.height/2);
        ctx.restore();
    }
};

function App() {
    const canvasRef = useRef(null);
    const [params, setParams] = useState({ photo: { x: 0, y: 0, s: 0.5, r: 0, f: 1 }, suit: { x: 0, y: 80, s: 0.8, r: 0, f: 1 } });
    const [assets, setAssets] = useState({ img: null, suit: null });
    const [ui, setUi] = useState({ target: 'photo', activeSpec: '4x6-8', gender: 'female', activeSuitUrl: null, loading: false, progress: 0, results: null });
    const [fatal, setFatal] = useState(null);
    const dragRef = useRef({ active: false, x: 0, y: 0 });

    /* ğŸ›¡ï¸ ç¡¬æ€§è‡ªæª¢ï¼šä»»ä½• FAIL ç›´æ¥é–æ­» */
    useEffect(() => {
        const keys = Object.keys(SPECS);
        if (keys.length !== 12) setFatal(`æ•¸é‡éŒ¯èª¤: æ‡‰ç‚º 12, å¯¦ç‚º ${keys.length}`);
        if (!SPECS['A4-MIX'].sections || !SPECS['4x6-MIX'].sections) setFatal("å¥‘ç´„å¤±æ•ˆ: MIX çµæ§‹è¢«ææ¯€");
    }, []);

    const renderStage = useCallback(() => {
        if (!canvasRef.current || fatal) return;
        const ctx = canvasRef.current.getContext('2d', { alpha: false });
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, 350, 450);
        if (assets.img) Renderer.drawLayer(ctx, assets.img, params.photo, { x: 0, y: 0, w: 350, h: 450 });
        if (assets.suit) Renderer.drawLayer(ctx, assets.suit, params.suit, { x: 0, y: 0, w: 350, h: 450 });
    }, [assets, params, fatal]);

    useEffect(() => {
        const frame = requestAnimationFrame(renderStage);
        return () => cancelAnimationFrame(frame);
    }, [renderStage]);

    /* ğŸ“¸ ä¿®å¾©ï¼šç©©å®šè¼‰å…¥èˆ‡æš«å­˜ä¿ç•™ */
    const handlePhoto = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const img = new Image();
            img.onload = () => {
                setAssets(prev => ({ ...prev, img }));
                // æ³¨æ„ï¼šé€™è£¡ä¸é‡ç½® paramsï¼Œä¿ç•™ä½¿ç”¨è€…ä¹‹å‰çš„èª¿æ•´ä½ç½® (æš«å­˜)
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };

    const handleSuit = (url) => {
        if (!url) return setAssets(a => ({ ...a, suit: null })), setUi(u => ({ ...u, activeSuitUrl: null }));
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
            setAssets(a => ({ ...a, suit: img }));
            setUi(u => ({ ...u, activeSuitUrl: url }));
        };
        img.src = url;
    };

    const runExport = async (all = false) => {
        if (!assets.img) return alert("è«‹å…ˆè¼‰å…¥ç…§ç‰‡");
        setUi(u => ({ ...u, loading: true, progress: 0 }));
        const list = all ? Object.keys(SPECS) : [ui.activeSpec];
        const res = [];
        for (let i = 0; i < list.length; i++) {
            const spec = SPECS[list[i]];
            const cvs = document.createElement('canvas');
            cvs.width = spec.w; cvs.height = spec.h;
            const ctx = cvs.getContext('2d', { alpha: false });
            ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, spec.w, spec.h);
            Renderer.calculateLayout(spec).forEach(rect => {
                Renderer.drawLayer(ctx, assets.img, params.photo, rect);
                Renderer.drawLayer(ctx, assets.suit, params.suit, rect);
            });
            res.push({ ...spec, url: cvs.toDataURL('image/jpeg', 0.8) });
            cvs.width = 1; cvs.height = 1; // è³‡æºå›æ”¶
            setUi(u => ({ ...u, progress: Math.round(((i + 1) / list.length) * 100) }));
            await new Promise(r => setTimeout(r, 40));
        }
        setUi(u => ({ ...u, results: res, loading: false }));
    };

    if (fatal) return <div className="fatal-screen"><h1>SYSTEM HALTED</h1><p>{fatal}</p></div>;

    return (
        <div className="flex flex-col p-6 gap-6">
            <header className="flex justify-between items-center">
                <h1 className="text-3xl font-black italic text-blue-500 tracking-tighter">EzID</h1>
                <div className="text-right"><span className="text-[10px] font-bold text-slate-500">v20.47.24</span><div className="text-[9px] text-emerald-500 font-black">ACTIVE CACHE ON</div></div>
            </header>

            <div className="editor-stage"
                onPointerDown={e => { dragRef.current = { active: true, x: e.clientX, y: e.clientY }; e.target.setPointerCapture(e.pointerId); }}
                onPointerMove={e => {
                    if (!dragRef.current.active) return;
                    const dx = (e.clientX - dragRef.current.x) / params[ui.target].s;
                    const dy = (e.clientY - dragRef.current.y) / params[ui.target].s;
                    setParams(p => ({ ...p, [ui.target]: { ...p[ui.target], x: p[ui.target].x + dx, y: p[ui.target].y + dy } }));
                    dragRef.current.x = e.clientX; dragRef.current.y = e.clientY;
                }}
                onPointerUp={() => dragRef.current.active = false}>
                <canvas ref={canvasRef} width="350" height="450" className="w-full h-full" />
                <div className="guide-circle"></div>
                {ui.loading && <div className="absolute inset-0 bg-slate-950/90 flex items-center justify-center font-black text-blue-500 animate-pulse">EXPORTING {ui.progress}%</div>}
            </div>

            {/* è¡£æœé¸æ“‡å€ */}
            <div className="bg-slate-900/50 p-4 rounded-3xl space-y-3">
                <div className="flex gap-2">
                    {['female', 'male'].map(g => (
                        <button key={g} onClick={() => setUi(u => ({ ...u, gender: g }))} className={`flex-1 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest ${ui.gender === g ? 'bg-blue-600 text-white shadow-lg' : 'bg-slate-800 text-slate-500'}`}>{g}</button>
                    ))}
                </div>
                <div className="flex gap-3 overflow-x-auto no-scrollbar py-2">
                    <div onClick={() => handleSuit(null)} className="suit-thumb flex-shrink-0 bg-red-500/10 border-red-500/40 text-red-500 font-black">âœ•</div>
                    {SUIT_LIST[ui.gender].map(url => (
                        <div key={url} onClick={() => handleSuit(url)} className={`suit-thumb flex-shrink-0 ${ui.activeSuitUrl === url ? 'active' : ''}`}><img src={url} className="w-full h-full object-contain p-1" /></div>
                    ))}
                </div>
            </div>

            {/* æ§åˆ¶å€ */}
            <div className="grid grid-cols-2 gap-3">
                {['photo', 'suit'].map(t => (
                    <button key={t} onClick={() => setUi(u => ({ ...u, target: t }))} className={`py-4 rounded-2xl font-black text-sm transition-all ${ui.target === t ? 'bg-blue-600 ring-4 ring-blue-600/20' : 'bg-slate-800 text-slate-500'}`}>{t === 'photo' ? 'èª¿æ•´ç…§ç‰‡' : 'èª¿æ•´è¡£æœ'}</button>
                ))}
            </div>

            <div className="bg-slate-900/80 p-6 rounded-3xl space-y-4 shadow-inner">
                <input type="range" min="0.1" max="2.5" step="0.01" value={params[ui.target].s} onChange={e => setParams(p => ({ ...p, [ui.target]: { ...p[ui.target], s: parseFloat(e.target.value) } }))} className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500" />
                <div className="grid grid-cols-2 gap-3">
                    <button onClick={() => setParams(p => ({ ...p, [ui.target]: { ...p[ui.target], r: p[ui.target].r + 90 } }))} className="py-3 bg-slate-800 rounded-xl text-xs font-bold active:scale-95 transition-transform">æ—‹è½‰ 90Â°</button>
                    <button onClick={() => setParams(p => ({ ...p, [ui.target]: { ...p[ui.target], f: p[ui.target].f * -1 } }))} className="py-3 bg-slate-800 rounded-xl text-xs font-bold active:scale-95 transition-transform">æ°´å¹³é¡åƒ</button>
                </div>
            </div>

            {/* ç‰ˆé¢ */}
            <div className="space-y-4">
                {['4x6', 'A4'].map(cat => (
                    <div key={cat} className="space-y-2">
                        <p className="text-[10px] font-black text-slate-600 px-1 tracking-tighter uppercase">{cat} PRINT SIZE</p>
                        <div className="flex flex-wrap gap-2">
                            {Object.values(SPECS).filter(s => s.cat === cat).map(s => (
                                <button key={s.id} onClick={() => setUi(u => ({ ...u, activeSpec: s.id }))} className={`px-3 py-3 rounded-xl text-[10px] font-bold flex-1 min-w-[85px] border border-white/5 ${ui.activeSpec === s.id ? 'bg-blue-600' : 'bg-slate-800 text-slate-400'}`}>{s.name}</button>
                            ))}
                        </div>
                    </div>
                ))}
            </div>

            {/* å‹•ä½œ */}
            <div className="flex flex-col gap-3 pt-4">
                <label className="w-full py-5 bg-slate-200 text-slate-950 rounded-3xl text-center text-sm font-black cursor-pointer shadow-xl hover:bg-white transition-colors">ğŸ“¸ é¸å–ç…§ç‰‡ (ä¿ç•™ç•¶å‰ä½ç½®)<input type="file" hidden accept="image/*" onChange={handlePhoto}/></label>
                <div className="grid grid-cols-2 gap-3">
                    <button onClick={() => runExport(false)} className="py-6 bg-blue-600 rounded-3xl font-black shadow-lg">å–®å¼µå°å‡º</button>
                    <button onClick={() => runExport(true)} className="py-6 bg-orange-600 rounded-3xl font-black shadow-lg">å…¨è¦æ ¼(12)å°å‡º</button>
                </div>
            </div>

            {/* çµæœ */}
            {ui.results && (
                <div className="fixed inset-0 bg-slate-950 z-[999] overflow-y-auto p-6 animate-in fade-in duration-300">
                    <div className="max-w-sm mx-auto space-y-8 pb-20">
                        {['4x6', 'A4'].map(cat => (
                            <div key={cat} className="space-y-6">
                                <div className="sticky top-0 bg-slate-950/80 backdrop-blur-md py-2 z-10 text-center text-[10px] font-black text-slate-500 uppercase tracking-widest">{cat} OUTPUT</div>
                                {ui.results.filter(r => r.cat === cat).map((res, i) => (
                                    <div key={i} className="bg-slate-900 p-4 rounded-3xl border border-white/5 space-y-4 shadow-2xl transition-transform active:scale-[0.98]">
                                        <div className="flex justify-between items-center px-1"><p className="text-[11px] font-black text-blue-400">{res.name}</p><span className="text-[9px] text-slate-600">{res.w} x {res.h}</span></div>
                                        <img src={res.url} className="w-full rounded-2xl border border-white/5 shadow-inner" loading="lazy" />
                                        <a href={res.url} download={`EzID_${res.id}.jpg`} className="block w-full py-4 bg-blue-600 rounded-2xl text-center font-black text-xs shadow-lg active:bg-blue-700">ä¸‹è¼‰æ­¤å¼µ</a>
                                    </div>
                                ))}
                            </div>
                        ))}
                        <button onClick={() => setUi(u => ({ ...u, results: null }))} className="fixed bottom-6 left-1/2 -translate-x-1/2 w-64 py-5 bg-white text-black rounded-full font-black shadow-2xl active:scale-95 transition-all">é—œé–‰é è¦½</button>
                    </div>
                </div>
            )}
        </div>
    );
}
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
