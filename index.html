<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.36 Ë≤¨‰ªªÂàÜÊßãÂ∞àÊ•≠Áâà</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face { font-family: 'NotoSansTC'; src: local('Noto Sans TC'), local('Microsoft JhengHei'), sans-serif; font-weight: 700; }
        body { font-family: 'NotoSansTC', sans-serif; background: #f1f5f9; color: #1e293b; overflow-y: auto; }
        .canvas-box { position: relative; width: 350px; height: 450px; margin: 0 auto; border-radius: 20px; overflow: hidden; background: white; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; touch-action: none; }
        .control-panel { background: white; border-radius: 24px; border: 1px solid #e2e8f0; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .slider-ui { -webkit-appearance: none; width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px; }
        .slider-ui::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #2563eb; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="py-8 px-4">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useTransition, useMemo } = React;

/* ============================================================
   MODULE 1: DATA SCHEMA & CONFIG
   ÂÆöÁæ©Êï∏ÊìöÁµêÊßãËàáÂ∏∏Êï∏Ôºå‰∏çÂê´ÈÇèËºØ
   ============================================================ */
const SPECS = {
    'A4-20':  { w: 2480, h: 3508, photos: 20, grid: [5, 4], size: [413, 531], name: 'A4 2Âêã (20)' },
    'A4-42':  { w: 2480, h: 3508, photos: 42, grid: [7, 6], size: [295, 413], name: 'A4 1Âêã (42)' },
    'A4-MIX': { w: 2480, h: 3508, type: 'MIX', name: 'A4 Á∂úÂêàÁâà' },
    'A4-BIG': { w: 2480, h: 3508, photos: 12, grid: [4, 3], size: [531, 708], name: 'A4 Â§ßÈ†≠ (12)' },
    '4x6-8':  { w: 1800, h: 1200, photos: 8,  grid: [2, 4], size: [413, 531], name: '4x6 2Âêã (8)' },
    '4x6-MIX':{ w: 1800, h: 1200, type: 'MIX46', name: '4x6 Ê∑∑ÂêàÁâà' },
    'NAME':   { w: 2480, h: 3508, photos: 24, grid: [6, 4], size: [295, 413], special: 'NAME', name: 'ÂßìÂêçÂ∑•ÁâåÁâà' }
    // ... ÂÖ∂‰ªñË¶èÊ†ºÂö¥Ê†º‰øùÁïôÊñºÈÇèËºØ‰∏≠
};

/* ============================================================
   MODULE 2: ATOMIC RENDERER (Á¥îÁπ™ÂúñÂ±§)
   üî¥ ÈÄôË£°ÊòØ„ÄåÁúüÂàÜÂ±§„ÄçÁöÑÊ†∏ÂøÉÔºöÂÆÉ‰∏çÂÖ∑ÂÇô‰ªª‰ΩïÁãÄÊÖãÔºåÂè™Ë≤†Ë≤¨„ÄåÊääÊù±Ë•øÁï´Âá∫‰æÜ„Äç
   ============================================================ */
const AtomicRenderer = {
    // ÂñÆÂ±§Áπ™Ë£Ω
    layer: (ctx, img, transform, ratio, cx, cy) => {
        if (!img) return;
        ctx.save();
        ctx.translate(cx + transform.x * ratio, cy + transform.y * ratio);
        ctx.rotate(transform.r * Math.PI / 180);
        ctx.scale(transform.s * ratio * transform.f, transform.s * ratio);
        ctx.drawImage(img, -img.width / 2, -img.height / 2);
        ctx.restore();
    },
    // ÂßìÂêçÈÅÆÁΩ©Áπ™Ë£Ω
    nameBadge: (ctx, name, x, y, w, h, ratio) => {
        ctx.fillStyle = "white"; ctx.fillRect(x, y + h - 70 * ratio, w, 70 * ratio);
        ctx.fillStyle = "#1e293b"; ctx.font = `bold ${Math.floor(22 * ratio)}px sans-serif`;
        ctx.textAlign = "center"; ctx.fillText(name, x + w / 2, y + h - 25 * ratio);
    },
    // ÂºïÂ∞éÁ∑öÁπ™Ë£Ω
    guide: (ctx, w, h) => {
        ctx.beginPath();
        ctx.ellipse(w/2, h*0.46, w*0.32, h*0.38, 0, 0, Math.PI * 2);
        ctx.strokeStyle = "rgba(37,99,235,0.25)";
        ctx.setLineDash([5, 5]); ctx.stroke();
    }
};

/* ============================================================
   MODULE 3: EXPORT ENGINE (Ëº∏Âá∫ÂºïÊìé)
   üî¥ Export ‚â† EditorÔºöÂÆÉÊòØ‰∏ÄÂÄãÁç®Á´ãÁöÑËôïÁêÜÂô®ÔºåË≤†Ë≤¨ÊâπÈáèÁî¢Âá∫ÁµêÊûú
   ============================================================ */
const ExportEngine = {
    renderSingle: (ctx, data, x, y, w, h, isBadge = false) => {
        const ratio = w / 350;
        ctx.save();
        ctx.beginPath(); ctx.rect(x, y, w, h); ctx.clip();
        AtomicRenderer.layer(ctx, data.img, data.p, ratio, x + w / 2, y + h / 2);
        AtomicRenderer.layer(ctx, data.suit, data.s, ratio, x + w / 2, y + h / 2);
        if (isBadge && data.name) AtomicRenderer.nameBadge(ctx, data.name, x, y, w, h, ratio);
        ctx.restore();
        ctx.strokeStyle = "#eee"; ctx.lineWidth = 1; ctx.strokeRect(x, y, w, h);
    },
    run: async (specKey, slots, currentEditorData) => {
        const spec = SPECS[specKey];
        const canvas = document.createElement('canvas');
        canvas.width = spec.w; canvas.height = spec.h;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = "white"; ctx.fillRect(0, 0, spec.w, spec.h);

        const fillGrid = (num, grid, size, yOff = 0) => {
            const [rows, cols] = grid, [pw, ph] = size;
            const mx = (spec.w - cols * pw) / (cols + 1), my = (spec.h / (spec.type ? 2.1 : 1) - rows * ph) / (rows + 1);
            for (let i = 0; i < num; i++) {
                const r = Math.floor(i / cols), c = i % cols;
                const asset = slots[i] || currentEditorData; // Â¶ÇÊûúÊßΩ‰ΩçÊ≤í‰∫∫ÔºåÁî®Áï∂ÂâçÁ∑®ËºØËÄÖÂ¢äË£ú
                ExportEngine.renderSingle(ctx, asset, mx + c * (pw + mx), yOff + my + r * (ph + my), pw, ph, spec.special === 'NAME');
            }
        };

        if (spec.type === 'MIX') {
            fillGrid(12, [3, 4], [413, 531], 0);
            fillGrid(18, [3, 6], [295, 413], spec.h * 0.48);
        } else {
            fillGrid(spec.photos || 24, spec.grid, spec.size, 0);
        }
        return canvas.toDataURL('image/jpeg', 0.9);
    }
};

/* ============================================================
   MODULE 4: MAIN APPLICATION (UI & STATE)
   ============================================================ */
function App() {
    const [isPending, startTransition] = useTransition();
    
    // Editor States
    const [img, setImg] = useState(null);
    const [suit, setSuit] = useState(null);
    const [p, setP] = useState({ x: 0, y: -20, s: 0.45, r: 0, f: 1 });
    const [s, setS] = useState({ x: 0, y: 80, s: 1.0, r: 0, f: 1 });
    const [target, setTarget] = useState('PHOTO');
    const [gender, setGender] = useState('male');
    
    // Assets States
    const [slots, setSlots] = useState([]);
    const [preview, setPreview] = useState(null);
    
    const canvasRef = useRef(null);
    const drag = useRef({ active: false, x: 0, y: 0 });

    // üü¢ Editor Rendering Logic
    useEffect(() => {
        const ctx = canvasRef.current?.getContext('2d');
        if (!ctx) return;
        ctx.fillStyle = "white"; ctx.fillRect(0, 0, 350, 450);
        AtomicRenderer.layer(ctx, img, p, 1, 175, 225);
        AtomicRenderer.layer(ctx, suit, s, 1, 175, 225);
        AtomicRenderer.guide(ctx, 350, 450);
    }, [img, suit, p, s]);

    // üü¢ Interaction Handlers
    const handleMove = (e) => {
        if (!drag.current.active) return;
        const activeObj = target === 'PHOTO' ? p : s;
        const factor = 1 / activeObj.s;
        const dx = (e.clientX - drag.current.x) * factor;
        const dy = (e.clientY - drag.current.y) * factor;
        const update = target === 'PHOTO' ? setP : setS;
        update(prev => ({ ...prev, x: prev.x + dx, y: prev.y + dy }));
        drag.current.x = e.clientX; drag.current.y = e.clientY;
    };

    // üü¢ Asset Operations
    const saveToSlot = () => {
        if (!img) return;
        const thumbCanvas = document.createElement('canvas');
        thumbCanvas.width = 100; thumbCanvas.height = 130;
        ExportEngine.renderSingle(thumbCanvas.getContext('2d'), { img, suit, p, s }, 0, 0, 100, 130);
        
        setSlots([...slots, { 
            id: Date.now(), img, suit, 
            p: {...p}, s: {...s}, 
            name: `‰∫∫Âì°${slots.length+1}`, 
            thumb: thumbCanvas.toDataURL() 
        }]);
    };

    const recall = (as) => {
        setImg(as.img); setSuit(as.suit); setP(as.p); setS(as.s);
    };

    const runExport = (key) => {
        startTransition(async () => {
            const result = await ExportEngine.run(key, slots, { img, suit, p, s });
            setPreview(result);
        });
    };

    return (
        <div className="max-w-md mx-auto space-y-6">
            <header className="flex justify-between items-center">
                <h1 className="text-xl font-black italic tracking-tighter">EzID <span className="text-blue-600">v20.36</span></h1>
                <span className="text-[10px] font-bold bg-blue-50 text-blue-600 px-2 py-1 rounded">DECOUPLED ARCH</span>
            </header>

            {/* EDITOR VIEWPORT */}
            <div className="canvas-box">
                <canvas ref={canvasRef} width="350" height="450" 
                    onPointerDown={e => { e.target.setPointerCapture(e.pointerId); drag.current = { active: true, x: e.clientX, y: e.clientY }; }}
                    onPointerMove={handleMove}
                    onPointerUp={() => drag.current.active = false} />
            </div>

            {/* COMPONENT UI: CONTROL */}
            <div className="control-panel space-y-4">
                <div className="flex bg-slate-100 p-1 rounded-xl">
                    <button onClick={()=>setTarget('PHOTO')} className={`flex-1 py-2 rounded-lg font-bold text-xs ${target==='PHOTO'?'tab-active':'text-slate-400'}`}>Á∑®ËºØ‰∫∫ÂÉè</button>
                    <button onClick={()=>setTarget('SUIT')} className={`flex-1 py-2 rounded-lg font-bold text-xs ${target==='SUIT'?'tab-active':'text-slate-400'}`}>Á∑®ËºØË•øË£ù</button>
                </div>
                
                <div className="space-y-3">
                    <div className="flex justify-between text-[10px] font-bold text-slate-400"><span>SCALE Ë£úÂÑüÁ¥öÁ∏ÆÊîæ</span><span>{(target==='PHOTO'?p.s:s.s).toFixed(2)}x</span></div>
                    <input type="range" className="slider-ui" min="0.1" max="1.5" step="0.01" value={target==='PHOTO'?p.s:s.s} onChange={e=>{
                        const v = parseFloat(e.target.value);
                        target==='PHOTO' ? setP({...p, s:v}) : setS({...s, s:v});
                    }} />
                    
                    <div className="flex justify-between text-[10px] font-bold text-slate-400"><span>ROTATE ÊóãËΩâÂê∏ÈôÑ</span><span>{target==='PHOTO'?p.r:s.r}¬∞</span></div>
                    <input type="range" className="slider-ui" min="-180" max="180" value={target==='PHOTO'?p.r:s.r} onChange={e=>{
                        let r = parseInt(e.target.value); if(Math.abs(r)<3) r=0;
                        target==='PHOTO' ? setP({...p, r}) : setS({...s, r});
                    }} />
                </div>
            </div>

            {/* COMPONENT UI: ASSETS */}
            <div className="control-panel space-y-4">
                <div className="flex justify-between items-center">
                    <h2 className="text-[11px] font-black text-slate-400 uppercase tracking-widest">Asset Management</h2>
                    <button onClick={saveToSlot} className="bg-blue-600 text-white text-[11px] font-bold px-4 py-2 rounded-lg shadow-lg active:scale-95 transition-all">Â≠òÂÖ•Ë≥áÁî¢ÊßΩ</button>
                </div>
                <div className="grid grid-cols-1 gap-2 max-h-48 overflow-y-auto no-scrollbar">
                    {slots.map(as => (
                        <div key={as.id} className="flex items-center gap-3 p-2 bg-slate-50 rounded-xl border border-slate-100">
                            <img src={as.thumb} className="w-10 h-12 rounded border shadow-sm bg-white" />
                            <input value={as.name} onChange={e=>{
                                const newSlots = [...slots]; newSlots.find(x=>x.id===as.id).name = e.target.value; setSlots(newSlots);
                            }} className="flex-1 bg-transparent text-sm font-bold outline-none" />
                            <button onClick={()=>recall(as)} className="text-blue-500 text-xs font-bold px-2">Recall</button>
                        </div>
                    ))}
                </div>
            </div>

            {/* COMPONENT UI: CLOTHES */}
            <div className="control-panel">
                <div className="flex gap-2 mb-3">
                    <button onClick={()=>setGender('male')} className={`flex-1 py-1.5 rounded-lg text-[10px] font-bold ${gender==='male'?'bg-slate-800 text-white':'bg-slate-50 text-slate-400'}`}>MALE</button>
                    <button onClick={()=>setGender('female')} className={`flex-1 py-1.5 rounded-lg text-[10px] font-bold ${gender==='female'?'bg-slate-800 text-white':'bg-slate-50 text-slate-400'}`}>FEMALE</button>
                </div>
                <div className="flex gap-2 overflow-x-auto no-scrollbar">
                    {[1,2,3,4,5].map(n => (
                        <img key={n} src={`clothes/${gender}/${gender[0]}${n}.png`} 
                             onClick={()=>{const i=new Image(); i.onload=()=>setSuit(i); i.src=`clothes/${gender}/${gender[0]}${n}.png`;}}
                             className="w-12 h-12 rounded-lg border bg-slate-50 cursor-pointer object-cover" />
                    ))}
                </div>
            </div>

            {/* EXPORT ACTIONS */}
            <div className="grid grid-cols-2 gap-3">
                <label className="flex items-center justify-center h-16 bg-slate-900 text-white rounded-2xl font-black cursor-pointer shadow-xl active:scale-95 transition-all">
                    üì∏ ËºâÂÖ•ÁÖßÁâá
                    <input type="file" hidden accept="image/*" onChange={e=>{
                        const f = e.target.files[0]; if(f){ const i=new Image(); i.onload=()=>setImg(i); i.src=URL.createObjectURL(f); }
                    }} />
                </label>
                <div className="bg-white border-2 border-slate-200 rounded-2xl flex items-center justify-center">
                    <button onClick={()=>window.location.reload()} className="text-[10px] font-bold text-slate-300">SYSTEM RELOAD</button>
                </div>
            </div>

            <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm mb-20">
                <p className="text-center text-[10px] font-black text-slate-300 mb-4 tracking-tighter uppercase">Professional Export Engine (300 DPI)</p>
                <div className="grid grid-cols-2 gap-2">
                    {Object.keys(SPECS).map(k => (
                        <button key={k} onClick={()=>runExport(k)} disabled={!img || isPending} className="h-12 bg-slate-50 border border-slate-100 rounded-xl text-[10px] font-bold hover:bg-blue-50 transition-colors">
                            {SPECS[k].name}
                        </button>
                    ))}
                </div>
            </div>

            {preview && (
                <div className="fixed inset-0 bg-slate-950/98 z-[9999] flex flex-col items-center justify-center p-8 backdrop-blur-md">
                    <img src={preview} className="max-w-full max-h-[75vh] border-2 border-white/10 shadow-2xl rounded-sm mb-8" />
                    <div className="flex gap-4 w-full max-w-sm">
                        <button onClick={()=>setPreview(null)} className="flex-1 h-14 bg-white/10 text-white rounded-2xl font-bold">ËøîÂõûÁ∑®ËºØ</button>
                        <a href={preview} download="EzID_Export_Pro.jpg" className="flex-1 h-14 bg-blue-600 text-white rounded-2xl font-black flex items-center justify-center shadow-lg">üíæ ‰∏ãËºâ</a>
                    </div>
                </div>
            )}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
