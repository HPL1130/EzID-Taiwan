<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EzID Taiwan v2.6 Anchor</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body { margin:0; background:#f8fafc; }
.canvas-container {
  position: relative; width:350px; height:450px;
  margin:auto; background:#fff; border-radius:28px;
  box-shadow:0 20px 40px rgba(0,0,0,.15);
}
canvas { width:350px; height:450px; }
.toast {
  position:fixed; top:20px; left:50%; transform:translateX(-50%);
  background:#0f172a; color:#fff; padding:10px 22px;
  border-radius:999px; font-size:13px; font-weight:bold;
  opacity:0; transition:.3s; z-index:2000;
}
</style>
</head>
<body>

<div id="root"></div>
<div id="toast" class="toast"></div>

<script type="text/babel">
const {useState,useRef,useEffect,useCallback} = React;

const CLOTHES = [
  { id:"m1", src:"clothes/male/m1.png", meta:{ anchorNeckY:0.18, scaleBase:1.05 }},
  { id:"m2", src:"clothes/male/m2.png", meta:{ anchorNeckY:0.20, scaleBase:1.1 }},
  { id:"f1", src:"clothes/female/f1.png", meta:{ anchorNeckY:0.17, scaleBase:1.0 }},
];

function App(){
  const canvasRef = useRef(null);
  const [photo,setPhoto] = useState(null);
  const [cloth,setCloth] = useState(null);
  const [clothMeta,setClothMeta] = useState(null);
  const [p,setP] = useState({x:0,y:-20,s:0.75});
  const [clothScale,setClothScale] = useState(1.0);

  const toast = msg=>{
    const t=document.getElementById("toast");
    t.textContent=msg; t.style.opacity=1;
    setTimeout(()=>t.style.opacity=0,1800);
  };

  const draw = useCallback(()=>{
    const c=canvasRef.current;
    const ctx=c.getContext("2d");
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,350,450);

    if(photo){
      ctx.save();
      ctx.translate(175+p.x,225+p.y);
      ctx.scale(p.s,p.s);
      ctx.drawImage(photo,-photo.width/2,-photo.height/2);
      ctx.restore();
    }

    if(photo && cloth){
      const headPx = photo.width * p.s * 0.55;
      const baseScale = clothMeta?.scaleBase || 1.0;
      const width = headPx * clothScale * baseScale;
      const height = width * (cloth.height/cloth.width);

      const headNeckY = 225 + p.y + photo.height*p.s*0.15;
      const clothNeckOffset = height * (clothMeta?.anchorNeckY || 0.18);
      const y = headNeckY - clothNeckOffset;

      ctx.drawImage(cloth,(350-width)/2,y,width,height);
    }
  },[photo,cloth,p,clothScale,clothMeta]);

  useEffect(draw,[draw]);

  return (
    <div className="p-4 max-w-md mx-auto">
      <h1 className="font-black text-xl mb-2">EzID Taiwan v2.6</h1>

      <div className="canvas-container mb-4">
        <canvas ref={canvasRef} width="350" height="450"/>
      </div>

      <div className="bg-white rounded-xl p-4 shadow space-y-3">
        <input type="file" accept="image/*" onChange={e=>{
          const f=e.target.files[0];
          if(!f)return;
          const img=new Image();
          img.onload=()=>{ setPhoto(img); toast("照片載入完成"); };
          img.src=URL.createObjectURL(f);
        }}/>

        <div className="flex gap-2">
          {CLOTHES.map(c=>(
            <button key={c.id} onClick={()=>{
              const img=new Image();
              img.onload=()=>{
                setCloth(img);
                setClothMeta(c.meta);
                toast("已套用服裝");
              };
              img.src=c.src;
            }} className="border px-2 py-1 rounded text-xs">{c.id}</button>
          ))}
        </div>

        <label className="text-xs font-bold">衣服大小</label>
        <input type="range" min="0.6" max="2.2" step="0.01"
          value={clothScale}
          onChange={e=>setClothScale(+e.target.value)} />
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
