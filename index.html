<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v3.7.5 - STABLE</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .canvas-container { 
            position:relative; width:350px; height:450px; margin:0 auto; 
            background:#f8fafc; border:2px solid #e2e8f0; border-radius:16px; overflow:hidden; 
            touch-action: none; cursor: grab;
        }
        .inner-guide { position:absolute; left:50%; top:45%; width:62%; height:71.1%; border:2px dotted #10b981; border-radius:50%/44%; transform:translate(-50%,-50%); z-index:100; pointer-events:none; }
        .outer-guide { position:absolute; left:50%; top:45%; width:70%; height:80%; border:2px dashed #f59e0b; border-radius:50%/44%; transform:translate(-50%,-50%); z-index:99; pointer-events:none; }
        .mode-label { position:absolute; top:12px; left:12px; background:white; padding:2px 8px; border-radius:6px; font-size:10px; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.1); z-index:10; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

const M_SUITS = Array(5).fill(0).map((_, i) => ({ id: `male/m${i+1}.png`, neckY: 0.12, sW: 0.88 }));
const F_SUITS = Array(5).fill(0).map((_, i) => ({ id: `female/f${i+1}.png`, neckY: 0.16, sW: 0.82 }));

function App() {
    const canvasRef = useRef(null);
    const [image, setImage] = useState(null);
    const [suit, setSuit] = useState({ img: null, meta: null });
    const [slots, setSlots] = useState([]);
    const [target, setTarget] = useState("PHOTO");
    
    // Â∫ßÊ®ôÁãÄÊÖãÔºöx, y ÊòØÁõ∏Â∞çÊñº‰∏≠ÂøÉÈªûÁöÑÂÅèÁßª
    const [p, setP] = useState({ x: 0, y: 0, s: 0.5 }); // ÂàùÂßãÂåñÊØî‰æãÂ∞è‰∏ÄÈªûÔºåÁ¢∫‰øùÁúãÂæóÂà∞
    const [sp, setSp] = useState({ x: 0, y: 0, s: 1.0 });

    const isDragging = useRef(false);
    const lastPos = useRef({ x: 0, y: 0 });

    const draw = useCallback(() => {
        const cvs = canvasRef.current;
        if (!cvs) return;
        const ctx = cvs.getContext("2d");
        
        // 1. Ê∏ÖÈô§Áï´Â∏É‰∏¶Â°´ÊªøÁôΩËâ≤
        ctx.clearRect(0, 0, 350, 450);
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, 350, 450);

        // 2. Áπ™Ë£Ω‰∫∫ÂÉè (ÂÖàÁï´)
        if (image) {
            ctx.save();
            // Ê†∏ÂøÉ‰øÆÊ≠£ÔºöÁßªÂãïÂà∞Áï´Â∏É‰∏≠ÂøÉÈªû (175, 225) ÂÜçÂ•óÁî®ÂÅèÁßª
            ctx.translate(175 + p.x, 225 + p.y);
            ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width / 2, -image.height / 2);
            ctx.restore();
        }

        // 3. Áπ™Ë£ΩË°£Êúç (ÂæåÁï´)
        if (suit.img) {
            ctx.save();
            const m = suit.meta;
            const w = suit.img.width * sp.s;
            const h = suit.img.height * sp.s;
            // Áâ©ÁêÜÈÄ£ÂãïÔºöË°£ÊúçË∑üÈö®‰∫∫ÂÉèÁöÑ p.x Ëàá p.y
            // 305 ÊòØÈ†êË®≠ËÑñÂ≠êÈ´òÂ∫¶ÔºåÊâ£Èô§È†òÂè£Ê∑±Â∫¶ m.neckY
            const drawX = (350 - w) / 2 + sp.x + p.x;
            const drawY = 305 + p.y - (h * m.neckY) + sp.y;
            ctx.drawImage(suit.img, drawX, drawY, w, h);
            ctx.restore();
        }
    }, [image, suit, p, sp]);

    useEffect(() => { draw(); }, [draw]);

    // ÊâãÂã¢ËôïÁêÜ (‰øÆÊ≠£ dx/dy Ë®àÁÆó)
    const handleStart = (e) => {
        if (!image && target === "PHOTO") return;
        isDragging.current = true;
        const pos = e.touches ? e.touches[0] : e;
        lastPos.current = { x: pos.clientX, y: pos.clientY };
    };

    const handleMove = (e) => {
        if (!isDragging.current) return;
        const pos = e.touches ? e.touches[0] : e;
        const dx = pos.clientX - lastPos.current.x;
        const dy = pos.clientY - lastPos.current.y;

        if (target === "PHOTO") {
            setP(v => ({ ...v, x: v.x + dx, y: v.y + dy }));
        } else {
            setSp(v => ({ ...v, x: v.x + dx, y: v.y + dy }));
        }
        lastPos.current = { x: pos.clientX, y: pos.clientY };
    };

    const handleWheel = (e) => {
        const delta = e.deltaY * -0.0005;
        if (target === "PHOTO") setP(v => ({ ...v, s: Math.max(0.1, v.s + delta) }));
        else setSp(v => ({ ...v, s: Math.max(0.1, v.s + delta) }));
    };

    const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                setImage(img);
                // ÈáçÁΩÆ‰ΩçÁΩÆÂà∞‰∏≠ÂøÉÔºå‰∏¶Ê†πÊìöÂúñÁâáÂ§ßÂ∞èÂàùÂßãÂåñÁ∏ÆÊîæ
                const initScale = 300 / Math.max(img.width, img.height);
                setP({ x: 0, y: -20, s: initScale });
                setTarget("PHOTO");
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };

    // Ëº∏Âá∫ÂäüËÉΩ (4x6/A4)
    const exportImage = async (spec, mode) => {
        if (!slots.length) return alert("Ë´ãÂÖàÂ≠òÂÖ•ÊßΩ‰Ωç");
        const W = spec === 'P46' ? 1200 : 2480;
        const H = spec === 'P46' ? 1800 : 3508;
        const canvas = document.createElement("canvas");
        canvas.width = W; canvas.height = H;
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "white"; ctx.fillRect(0, 0, W, H);

        const loadedImgs = await Promise.all(slots.map(src => new Promise(res => {
            const i = new Image(); i.onload = () => res(i); i.src = src;
        })));

        const gap = 30, sw = 413, sh = 531; // 2ÂêãÁÇ∫‰æã
        let curY = 60;
        loadedImgs.forEach((img, i) => {
            const x = 60 + (i % 2) * (sw + gap);
            const y = curY + Math.floor(i / 2) * (sh + gap);
            ctx.drawImage(img, x, y, sw, sh);
            ctx.strokeStyle = "#ccc"; ctx.strokeRect(x, y, sw, sh);
        });

        const link = document.createElement("a");
        link.href = canvas.toDataURL("image/png");
        link.download = `EzID_${spec}_${mode}.png`;
        link.click();
    };

    return (
        <div className="max-w-md mx-auto p-4 select-none">
            <header className="flex justify-between items-center mb-4">
                <h1 className="font-black italic text-xl">EzID <span className="text-blue-600">3.7.5</span></h1>
                <div className="flex bg-slate-200 p-1 rounded-xl">
                    <button onClick={()=>setTarget("PHOTO")} className={`px-4 py-1 text-xs font-bold rounded-lg ${target==='PHOTO'?'bg-white shadow text-blue-600':'text-slate-500'}`}>‰∫∫ÂÉè</button>
                    <button onClick={()=>setTarget("SUIT")} className={`px-4 py-1 text-xs font-bold rounded-lg ${target==='SUIT'?'bg-white shadow text-blue-600':'text-slate-500'}`}>Ë°£Êúç</button>
                </div>
            </header>

            <div className="canvas-container shadow-lg mb-4"
                 onMouseDown={handleStart} onMouseMove={handleMove} onMouseUp={()=>isDragging.current=false}
                 onMouseLeave={()=>isDragging.current=false} onWheel={handleWheel}
                 onTouchStart={handleStart} onTouchMove={handleMove} onTouchEnd={()=>isDragging.current=false}>
                <div className="mode-label">{target} MODE</div>
                <canvas ref={canvasRef} width="350" height="450" />
                <div className="inner-guide"></div>
                <div className="outer-guide"></div>
            </div>

            <div className="bg-white p-3 rounded-2xl shadow-sm border border-slate-100 mb-4 overflow-hidden">
                <div className="flex gap-2 overflow-x-auto no-scrollbar">
                    <button onClick={()=>setSuit({img:null, meta:null})} className="flex-shrink-0 w-12 h-12 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl">‚úï</button>
                    {[...M_SUITS, ...F_SUITS].map(s => (
                        <button key={s.id} onClick={()=>{
                            const img = new Image();
                            img.onload = () => { setSuit({ img, meta: s }); setTarget("SUIT"); };
                            img.src = `clothes/${s.id}`;
                        }} className={`flex-shrink-0 w-12 h-12 border-2 rounded-xl overflow-hidden ${suit.meta?.id===s.id?'border-blue-500':'border-transparent'}`}>
                            <img src={`clothes/${s.id}`} className="w-full h-full object-contain" />
                        </button>
                    ))}
                </div>
            </div>

            <div className="grid grid-cols-2 gap-3 mb-6">
                <label className="bg-slate-900 text-white py-4 rounded-2xl text-center text-sm font-bold cursor-pointer active:scale-95 transition-transform">
                    üì∏ ‰∏äÂÇ≥ÁÖßÁâá
                    <input type="file" hidden accept="image/*" onChange={handleFileUpload} />
                </label>
                <button onClick={() => setSlots([canvasRef.current.toDataURL(), ...slots].slice(0,10))}
                        className="bg-blue-600 text-white py-4 rounded-2xl text-sm font-bold active:scale-95 transition-transform">
                    üì• Â≠òÂÖ•ÊßΩ‰Ωç ({slots.length})
                </button>
            </div>

            <div className="grid grid-cols-2 gap-2">
                <button onClick={()=>exportImage('P46','MIX')} className="bg-emerald-600 text-white py-3 rounded-xl text-xs font-bold">4x6 Ê∑∑Êéí‰∏ãËºâ</button>
                <button onClick={()=>exportImage('A4','MIX')} className="bg-slate-700 text-white py-3 rounded-xl text-xs font-bold">A4 Ê∑∑Êéí‰∏ãËºâ</button>
            </div>
        </div>
    );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
