<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v3.3.2 PRO</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .canvas-container { position:relative; width:350px; height:450px; margin:0 auto; background:#fff; border-radius:32px; border:8px solid #fff; box-shadow:0 20px 40px rgba(0,0,0,.1); overflow:hidden; }
        .inner-guide { border:2px dotted rgba(16,185,129,0.7); position:absolute; border-radius:50%/46%; transform:translateY(-6%); z-index: 100; pointer-events:none; }
        .outer-guide { border:2px dashed rgba(245,158,11,0.5); position:absolute; border-radius:50%/46%; transform:translateY(-6%); z-index: 99; pointer-events:none; }
        .toast { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.85); color:white; padding:10px 24px; border-radius:24px; font-size:12px; z-index:999; backdrop-filter:blur(4px); pointer-events:none; }
        input[type=range] { width:100%; accent-color:#2563eb; height:6px; background:transparent; appearance:none; cursor: pointer; position: relative; z-index: 10; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

const CLOTHES = [
    ...Array(5).fill(0).map((_, i) => `clothes/male/m${i+1}.png`),
    ...Array(5).fill(0).map((_, i) => `clothes/female/f${i+1}.png`)
];

const DPI = 300, A4_W = 2480, A4_H = 3508;
const mmToPx = (mm) => Math.round(mm * DPI / 25.4);
const SAFE = mmToPx(12);

const CONTROL_RANGES = {
    photo: { s: {min:0.3, max:1.5, step:0.01}, y: {min:-150, max:150}, x: {min:-150, max:150} },
    suit:  { s: {min:0.5, max:4.0, step:0.01}, y: {min:-400, max:400}, x: {min:-250, max:250} }
};

function App() {
    const canvasRef = useRef(null);
    const toastTimer = useRef(null);
    const dirtyRef = useRef(true);
    const scheduledRef = useRef(false);
    const fileInputRef = useRef(null);

    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [activeSuit, setActiveSuit] = useState(null);
    const [slots, setSlots] = useState([]); 
    const [toast, setToast] = useState("");
    const [cutMode, setCutMode] = useState("FRAME_L"); 
    
    const [p, setP] = useState({ x: 0, y: -20, s: 0.75 });
    const [sp, setSp] = useState({ x: 0, y: 0, s: 1.0 });

    // --- ä¿®å¾© 3: æ”¹é€² RAF æ•ˆèƒ½ï¼Œåƒ…åœ¨ dirty æ™‚é‡ç¹ª ---
    const draw = useCallback(() => {
        const cvs = canvasRef.current;
        if (!cvs) return;
        const ctx = cvs.getContext("2d");
        if (!ctx) return; // ä¿®å¾© 4: Guard clause

        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, 350, 450);

        if(image){
            ctx.save(); ctx.translate(175 + p.x, 225 + p.y); ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width/2, -image.height/2); ctx.restore();
        }
        if(suitImg){
            ctx.save();
            const w = 350 * sp.s; const h = (suitImg.height / suitImg.width) * w;
            ctx.drawImage(suitImg, (350 - w)/2 + sp.x, 450 - h + 15 + sp.y, w, h);
            ctx.restore();
        }
    }, [image, suitImg, p, sp]);

    const scheduleDraw = useCallback(() => {
        if (scheduledRef.current) return;
        scheduledRef.current = true;
        requestAnimationFrame(() => {
            scheduledRef.current = false;
            if (dirtyRef.current) {
                dirtyRef.current = false;
                draw();
            }
        });
    }, [draw]);

    const markDirty = useCallback(() => {
        dirtyRef.current = true;
        scheduleDraw();
    }, [scheduleDraw]);

    useEffect(() => {
        markDirty();
        // ä¿®å¾© 10: æ¸…ç† Timer
        return () => { if (toastTimer.current) clearTimeout(toastTimer.current); };
    }, [markDirty]);

    const showToast = (msg) => {
        if (toastTimer.current) clearTimeout(toastTimer.current);
        setToast(msg);
        toastTimer.current = setTimeout(() => setToast(""), 2000); 
    };

    // --- ä¿®å¾© 1: Canvas æ±¡æŸ“é˜²å‘† ---
    const selectSuit = (url) => {
        if(!url) { setSuitImg(null); setActiveSuit(null); markDirty(); return; }
        const img = new Image();
        // è¨»ï¼šè‹¥è¡£æœåœ–èˆ‡ HTML åŒæºå‰‡å¯ç§»é™¤ anonymous ä»¥æ¸›å°‘ CORS å¤±æ•—æ©Ÿç‡
        img.crossOrigin = "anonymous"; 
        img.onload = () => { setSuitImg(img); setActiveSuit(url); markDirty(); };
        img.onerror = () => showToast("âŒ æœè£è¼‰å…¥å¤±æ•— (CORS é˜»æ“‹)");
        img.src = url;
    };

    const saveToSlot = () => {
        if(!image) return showToast("âš ï¸ è«‹å…ˆä¸Šå‚³ç…§ç‰‡");
        const cvs = canvasRef.current;
        cvs.toBlob((blob) => {
            if (!blob) return showToast("âŒ å­˜å…¥å¤±æ•—ï¼šCanvas è¢«æ±¡æŸ“æˆ–ç•°å¸¸"); // ä¿®å¾© 1A: é˜²å‘†
            const url = URL.createObjectURL(blob);
            setSlots(prev => {
                const next = [url, ...prev];
                if (next.length > 10) URL.revokeObjectURL(next.pop());
                return next;
            });
            showToast("âœ… å·²å­˜å…¥æ§½ä½");
        }, "image/png");
    };

    const clearSlots = () => {
        slots.forEach(url => URL.revokeObjectURL(url));
        setSlots([]);
        showToast("ğŸ”„ å·²æ¸…ç©ºæ§½ä½");
    };

    // --- ä¿®å¾© 2 & 25: A4 ä¸‹è¼‰å„ªåŒ– (æ”¹ç”¨ Blob æµç¨‹) ---
    const downloadA4 = async (mode) => {
        if(!slots.length) return showToast("âš ï¸ æ§½ä½ç‚ºç©º");
        try {
            const pc = document.createElement("canvas");
            pc.width = A4_W; pc.height = A4_H;
            const ctx = pc.getContext("2d");
            ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, A4_W, A4_H);

            const imgs = await Promise.all(slots.map(s => new Promise((res, rej) => {
                const i = new Image(); 
                i.crossOrigin = "anonymous"; // ä¿®å¾© 7: ä¿æŒç¿’æ…£
                i.onload = () => res(i); i.onerror = () => rej(new Error("è¼‰å…¥å¤±æ•—")); i.src = s;
            })));

            let imgIdx = 0;
            const renderBlock = (sw, sh, gap, startY, rows, cols) => {
                if (cols < 1 || rows < 1) return startY; // ä¿®å¾© 8: é˜²å‘†
                const rowWidth = cols * sw + (cols - 1) * gap;
                const startX = (A4_W - rowWidth) / 2;
                for (let r = 0; r < rows; r++) {
                    const cy = startY + r * (sh + gap);
                    if (cy + sh > A4_H - SAFE) break;
                    for (let c = 0; c < cols; c++) {
                        drawPhotoWithLMark(ctx, imgs[imgIdx % imgs.length], startX + c*(sw+gap), cy, sw, sh);
                        imgIdx++;
                    }
                }
                return startY + rows * (sh + gap);
            };

            const getCols = (sw, gap) => Math.max(1, Math.floor((A4_W - SAFE * 2 + gap) / (sw + gap))); // ä¿®å¾© 8

            if (mode === 'ALL_2') {
                const sw=413, sh=531, g=35;
                renderBlock(sw, sh, g, SAFE, Math.floor((A4_H-SAFE*2+g)/(sh+g)), getCols(sw, g));
            } else if (mode === 'ALL_1') {
                const sw=295, sh=413, g=25;
                renderBlock(sw, sh, g, SAFE, Math.floor((A4_H-SAFE*2+g)/(sh+g)), getCols(sw, g));
            } else if (mode === 'MIX') {
                const S2={w:413,h:531,g:35}, S1={w:295,h:413,g:25}, c2=getCols(S2.w,S2.g), c1=getCols(S1.w,S1.g);
                const maxR2 = Math.floor((A4_H-SAFE*2+S2.g)/(S2.h+S2.g));
                let best = { r2: 0, r1: 0, total: -1 };
                for(let r=0; r<=maxR2; r++){
                    const nextY = SAFE + r*(S2.h+S2.g);
                    const r1 = Math.floor((A4_H-nextY-SAFE+S1.g)/(S1.h+S1.g));
                    if(r*c2+r1*c1 > best.total) best = {r2:r, r1};
                }
                renderBlock(S1.w,S1.h,S1.g, renderBlock(S2.w,S2.h,S2.g, SAFE, best.r2, c2), best.r1, c1);
            }

            // ä¿®æ”¹ç‚º toBlob ä¸‹è¼‰ï¼Œé‡‹æ”¾è¨˜æ†¶é«”å£“åŠ›
            pc.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url; a.download = `EzID_${mode}_${Date.now()}.png`; a.click();
                setTimeout(() => URL.revokeObjectURL(url), 1000); // å»¶å¾Œé‡‹æ”¾
                showToast(`âœ… ä¸‹è¼‰æˆåŠŸ (${mode})`);
            }, "image/png");
        } catch(e) { 
            showToast(`âŒ ç™¼ç”ŸéŒ¯èª¤: ${e.message}`);
        }
    };

    const drawPhotoWithLMark = (ctx, img, x, y, w, h) => {
        ctx.drawImage(img, x, y, w, h);
        ctx.save();
        ctx.strokeStyle = cutMode === "LIGHT" ? "#E2E8F0" : "#000";
        ctx.lineWidth = 1;
        if (cutMode !== "L_ONLY") ctx.strokeRect(x, y, w, h);
        if (cutMode !== "FRAME" && cutMode !== "LIGHT") {
            const L = 20; ctx.beginPath();
            ctx.moveTo(x+L, y); ctx.lineTo(x, y); ctx.lineTo(x, y+L);
            ctx.moveTo(x+w-L, y); ctx.lineTo(x+w, y); ctx.lineTo(x+w, y+L);
            ctx.moveTo(x+L, y+h); ctx.lineTo(x, y+h); ctx.lineTo(x, y+h-L);
            ctx.moveTo(x+w-L, y+h); ctx.lineTo(x+w, y+h); ctx.lineTo(x+w, y+h-L);
            ctx.stroke();
        }
        ctx.restore();
    };

    return (
        <div className="max-w-md mx-auto p-4 pb-12">
            {toast && <div className="toast shadow-2xl">{toast}</div>}
            
            <header className="flex justify-between items-center mb-6 px-2">
                <h1 className="font-black text-slate-800 italic text-xl">EzID <span className="text-blue-600 text-[10px] not-italic border border-blue-600 px-1 rounded">v3.3.2 PRO</span></h1>
                <select value={cutMode} onChange={e=>setCutMode(e.target.value)} className="text-[10px] font-bold border rounded-lg px-2 py-1 bg-white outline-none shadow-sm">
                    <option value="FRAME_L">è£åˆ‡ï¼šé»‘æ¡† + Læ¨™</option>
                    <option value="L_ONLY">è£åˆ‡ï¼šåƒ… Læ¨™</option>
                    <option value="FRAME">è£åˆ‡ï¼šåƒ…é»‘æ¡†</option>
                    <option value="LIGHT">è£åˆ‡ï¼šæ·ºè‰²åƒè€ƒç·š</option>
                </select>
            </header>

            <div className="canvas-container mb-6 shadow-2xl shadow-blue-100">
                <canvas ref={canvasRef} width="350" height="450" />
                <div className="inner-guide" style={{width:'71%', height:'71%'}}></div>
                <div className="outer-guide" style={{width:'80%', height:'80%'}}></div>
            </div>

            <section className="space-y-4">
                <div className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                    <div className="flex justify-between mb-4 items-center">
                        <span className="text-[10px] font-bold text-slate-400 tracking-widest uppercase">ğŸ‘” Suit Control</span>
                        <div className="flex gap-2">
                            <button className="text-[10px] font-bold text-slate-500 bg-slate-50 px-2 py-1 rounded-lg border active:bg-slate-100" onClick={()=>{setSp({x:0,y:0,s:1});markDirty()}}>RESET</button>
                        </div>
                    </div>
                    <div className="flex gap-2 overflow-x-auto no-scrollbar mb-6">
                        {CLOTHES.map(s => (
                            <button key={s} onClick={()=>selectSuit(s)} className={`flex-shrink-0 w-12 h-12 border-2 rounded-xl p-1 transition-all ${activeSuit===s?'border-blue-500 bg-blue-50':'border-transparent bg-slate-50'}`}>
                                <img src={s} alt="suit preview" className="w-full h-full object-contain"/>
                            </button>
                        ))}
                    </div>
                    {suitImg && (
                        <div className="space-y-5">
                            <RangeSlider label="SCALE" val={sp.s} config={CONTROL_RANGES.suit.s} onChange={v=>{setSp(s=>({...s, s:v}));markDirty()}} unit="%" mul={100} />
                            <RangeSlider label="Y-POS" val={sp.y} config={CONTROL_RANGES.suit.y} onChange={v=>{setSp(s=>({...s, y:v}));markDirty()}} />
                            <RangeSlider label="X-POS" val={sp.x} config={CONTROL_RANGES.suit.x} onChange={v=>{setSp(s=>({...s, x:v}));markDirty()}} />
                        </div>
                    )}
                </div>

                <div className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                    <span className="text-[10px] font-bold text-slate-400 tracking-widest uppercase mb-4 block">ğŸ‘¤ Photo Control</span>
                    <div className="space-y-5">
                        <RangeSlider label="SCALE" val={p.s} config={CONTROL_RANGES.photo.s} onChange={v=>{setP(s=>({...s, s:v}));markDirty()}} unit="%" mul={100} />
                        <div className="grid grid-cols-2 gap-4">
                            <RangeSlider label="Y-POS" val={p.y} config={CONTROL_RANGES.photo.y} onChange={v=>{setP(s=>({...s, y:v}));markDirty()}} />
                            <RangeSlider label="X-POS" val={p.x} config={CONTROL_RANGES.photo.x} onChange={v=>{setP(s=>({...s, x:v}));markDirty()}} />
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3 mt-6">
                        <label className="bg-slate-800 text-white py-4 rounded-2xl text-center font-bold text-xs cursor-pointer active:scale-95 shadow-lg">
                            ğŸ“¸ ä¸Šå‚³ç…§ç‰‡
                            <input type="file" ref={fileInputRef} hidden accept="image/*" onChange={e=>{
                                const f=e.target.files[0]; if(!f) return;
                                const url=URL.createObjectURL(f); const img=new Image();
                                img.onload=()=>{
                                    setImage(img); URL.revokeObjectURL(url); markDirty(); showToast("âœ… ç…§ç‰‡å·²è¼‰å…¥");
                                    e.target.value = ''; // ä¿®å¾© 5: æ¸…ç©º value ä»¥åˆ©å†æ¬¡é¸æ“‡åŒåœ–
                                }; 
                                img.onerror=()=>{ showToast("âŒ ç…§ç‰‡æ ¼å¼éŒ¯èª¤"); e.target.value = ''; };
                                img.src=url;
                            }}/>
                        </label>
                        <button onClick={saveToSlot} className="bg-blue-600 text-white py-4 rounded-2xl font-bold text-xs active:scale-95 shadow-lg">ğŸ“¥ å­˜å…¥æ§½ä½</button>
                    </div>
                </div>
            </section>

            <div className="mt-8">
                <div className="flex justify-between items-center mb-4">
                    <span className="text-[10px] font-bold text-slate-400 uppercase font-mono px-2">Storage Slots ({slots.length}/10)</span>
                    <button onClick={clearSlots} className="text-[9px] text-red-500 font-bold px-3 py-1 rounded-full bg-red-50 active:bg-red-100">CLEAR ALL</button>
                </div>
                <div className="flex gap-3 overflow-x-auto no-scrollbar px-2">
                    {slots.map((url, i)=>(
                        <div key={url} className="relative flex-shrink-0">
                            <img src={url} alt="slot preview" className="w-16 h-20 rounded-xl border-2 border-white shadow-md object-cover active:scale-90 transition-transform" />
                            <button onClick={()=>{URL.revokeObjectURL(slots[i]); setSlots(prev=>prev.filter((_,idx)=>idx!==i));}} aria-label="ç§»é™¤ç…§ç‰‡" className="absolute -top-2 -right-2 bg-white text-red-500 w-6 h-6 rounded-full text-[10px] flex items-center justify-center border shadow-md font-bold">âœ•</button>
                        </div>
                    ))}
                </div>
            </div>

            <div className="mt-10 space-y-3">
                <button onClick={()=>downloadA4('MIX')} className="w-full bg-emerald-700 text-white py-4 rounded-2xl font-black text-sm shadow-xl active:scale-[0.98]">ğŸª ibon A4ï½œæ··æ’è§£ç®—å™¨</button>
                <div className="grid grid-cols-2 gap-3">
                    <button onClick={()=>downloadA4('ALL_2')} className="bg-indigo-600 text-white py-3.5 rounded-2xl font-bold text-xs shadow-md active:scale-[0.98]">ğŸª å…¨ 2 å‹</button>
                    <button onClick={()=>downloadA4('ALL_1')} className="bg-indigo-600 text-white py-3.5 rounded-2xl font-bold text-xs shadow-md active:scale-[0.98]">å…¨ 1 å‹</button>
                </div>
            </div>
        </div>
    );
}

function RangeSlider({ label, val, config, onChange, unit="", mul=1 }) {
    const { min, max } = config;
    const percentage = ((val - min) / (max - min)) * 100;
    return (
        <div className="space-y-1.5 relative">
            <div className="flex justify-between">
                <span className="text-[9px] font-bold text-slate-400 uppercase">{label}</span>
                <span className="text-[10px] font-mono text-blue-600 font-bold">{Math.round(val * mul)}{unit}</span>
            </div>
            <div className="relative flex items-center h-6">
                <div className="absolute w-full h-1.5 bg-slate-100 rounded-full overflow-hidden">
                    <div className="h-full bg-blue-500 rounded-full transition-all duration-75" style={{ width: `${percentage}%` }} />
                </div>
                {/* ä¿®å¾© 6: æ»‘æ¡¿æ‰‹æ„Ÿï¼Œæš«æ™‚ç§»é™¤ startTransition å›æ­¸åŒæ­¥æ›´æ–° */}
                <input type="range" {...config} value={val} onInput={e=>onChange(+e.target.value)} />
            </div>
        </div>
    );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
