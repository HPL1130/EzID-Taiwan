<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzID Taiwan - çµ‚æ¥µç©©å®šç‰ˆ</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.5.3/dist/bundle.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const SPECS = {
            TWO_INCH: { id: 'TWO_INCH', label: '2å‹(8å¼µ)', mmW: 35, mmH: 45, max: 8, cols: 4, rows: 2 },
            ONE_INCH: { id: 'ONE_INCH', label: '1å‹(10å¼µ)', mmW: 28, mmH: 35, max: 10, cols: 5, rows: 2 },
            MIXED: { id: 'MIXED', label: 'æ··åˆ(2å‹*4 + 1å‹*5)', isMixed: true, max: 9 }
        };

        const EzIDApp = () => {
            const [image, setImage] = useState(null);
            const [bgRemoved, setBgRemoved] = useState(null);
            const [isRemoving, setIsRemoving] = useState(false);
            const [currentSpec, setCurrentSpec] = useState(SPECS.TWO_INCH);
            const [photoList, setPhotoList] = useState([]);
            const [bgColor, setBgColor] = useState('#FFFFFF');

            // åº§æ¨™ç‹€æ…‹ (ä½¿ç”¨ Ref è¼”åŠ©è§£æ±º Canvas ä¸å‹•çš„å•é¡Œ)
            const [p, setP] = useState({ x: 0, y: 0, s: 0.5 }); // äººåƒ
            const [suit, setSuit] = useState({ id: null, x: 175, y: 250, s: 0.6 }); // è¡£æœ
            
            const canvasRef = useRef(null);
            const uploadedFileRef = useRef(null);

            // ã€æ ¸å¿ƒä¿®å¾©ã€‘å³æ™‚ç¹ªåœ–è¿´åœˆï¼Œè§£æ±ºåº§æ¨™ä¸åŒæ­¥å•é¡Œ
            useEffect(() => {
                let animationId;
                const render = () => {
                    const canvas = canvasRef.current;
                    if (!canvas || (!image && !bgRemoved)) return;
                    const ctx = canvas.getContext('2d');
                    
                    // 1. åº•è‰²
                    ctx.fillStyle = bgColor;
                    ctx.fillRect(0, 0, 350, 450);

                    // 2. ç•«äººåƒ
                    const activeImg = bgRemoved || image;
                    if (activeImg) {
                        ctx.save();
                        ctx.translate(175 + p.x, 225 + p.y);
                        ctx.scale(p.s, p.s);
                        ctx.drawImage(activeImg, -activeImg.width / 2, -activeImg.height / 2);
                        ctx.restore();
                    }

                    // 3. ç•«è¡£æœ
                    if (suit.id) {
                        const sImg = new Image();
                        sImg.src = `./suit-${suit.id}.png`;
                        if (sImg.complete) {
                            ctx.save();
                            ctx.translate(suit.x, suit.y);
                            ctx.scale(suit.s * 2.2, suit.s * 2.2);
                            ctx.drawImage(sImg, -sImg.width / 2, -sImg.height / 2);
                            ctx.restore();
                        }
                    }
                    animationId = requestAnimationFrame(render);
                };
                render();
                return () => cancelAnimationFrame(animationId);
            }, [image, bgRemoved, p, suit, bgColor]);

            const handleUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                uploadedFileRef.current = file;
                const reader = new FileReader();
                reader.onload = (f) => {
                    const img = new Image();
                    img.onload = () => { setImage(img); setBgRemoved(null); };
                    img.src = f.target.result;
                };
                reader.readAsDataURL(file);
            };

            const runRemoveBg = async () => {
                if (!uploadedFileRef.current) return;
                setIsRemoving(true);
                try {
                    const lib = window.imglyBackgroundRemoval;
                    const blob = await lib.removeBackground(uploadedFileRef.current, {
                        publicPath: "https://cdn.jsdelivr.net/npm/@imgly/background-removal-data@1.5.3/dist/"
                    });
                    const img = new Image();
                    img.onload = () => { setBgRemoved(img); setIsRemoving(false); };
                    img.src = URL.createObjectURL(blob);
                } catch (e) {
                    alert("å»èƒŒå¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ–åˆ·æ–°ç¶²é ");
                    setIsRemoving(false);
                }
            };

            return (
                <div className="max-w-4xl mx-auto p-4 flex flex-col md:flex-row gap-6">
                    {/* å·¦å´ï¼šç•«å¸ƒ */}
                    <div className="flex-1 space-y-4">
                        <div className="bg-white p-4 rounded-3xl shadow-xl">
                            <canvas ref={canvasRef} width={350} height={450} className="w-full border rounded-2xl shadow-inner bg-white" />
                            {isRemoving && <div className="text-center py-2 text-blue-600 font-bold animate-pulse">AI å»èƒŒä¸­...</div>}
                        </div>
                        <div className="flex gap-2">
                            <button onClick={runRemoveBg} className="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg">âœ¨ å»èƒŒ</button>
                            <button onClick={() => setPhotoList([...photoList, canvasRef.current.toDataURL()])} className="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg">âœ… åŠ å…¥æ’ç‰ˆ</button>
                        </div>
                    </div>

                    {/* å³å´ï¼šæ§åˆ¶é¢æ¿ */}
                    <div className="flex-1 space-y-4 bg-white p-6 rounded-3xl shadow-xl border">
                        {!image ? (
                            <input type="file" onChange={handleUpload} className="w-full p-10 border-4 border-dashed rounded-2xl text-center cursor-pointer" />
                        ) : (
                            <div className="space-y-6">
                                {/* 1. äººåƒèª¿æ•´ */}
                                <div>
                                    <p className="text-sm font-black text-gray-400 mb-2 uppercase">ğŸ‘¤ äººåƒå¾®èª¿</p>
                                    <div className="grid grid-cols-3 gap-1">
                                        <button onClick={() => setP({...p, y: p.y-5})} className="bg-slate-100 p-2 rounded">â†‘ ä¸Š</button>
                                        <button onClick={() => setP({...p, y: p.y+5})} className="bg-slate-100 p-2 rounded">â†“ ä¸‹</button>
                                        <button onClick={() => setP({...p, s: p.s+0.02})} className="bg-slate-100 p-2 rounded">ï¼‹ å¤§</button>
                                        <button onClick={() => setP({...p, x: p.x-5})} className="bg-slate-100 p-2 rounded">â† å·¦</button>
                                        <button onClick={() => setP({...p, x: p.x+5})} className="bg-slate-100 p-2 rounded">â†’ å³</button>
                                        <button onClick={() => setP({...p, s: p.s-0.02})} className="bg-slate-100 p-2 rounded">ï¼ å°</button>
                                    </div>
                                </div>

                                {/* 2. è¡£æœèª¿æ•´ */}
                                <div>
                                    <p className="text-sm font-black text-gray-400 mb-2 uppercase">ğŸ‘” è¡£æœä½ç§» (é»æ“ŠæŒ‰éˆ•çµ•å°æœƒå‹•)</p>
                                    <div className="grid grid-cols-3 gap-1 mb-3">
                                        <button onClick={() => setSuit({...suit, y: suit.y-5})} className="bg-blue-500 text-white p-2 rounded shadow">â†‘ è¡£ä¸Š</button>
                                        <button onClick={() => setSuit({...suit, y: suit.y+5})} className="bg-blue-500 text-white p-2 rounded shadow">â†“ è¡£ä¸‹</button>
                                        <button onClick={() => setSuit({...suit, s: suit.s+0.02})} className="bg-blue-500 text-white p-2 rounded shadow">ï¼‹ æ”¾å¤§</button>
                                        <button onClick={() => setSuit({...suit, x: suit.x-5})} className="bg-blue-500 text-white p-2 rounded shadow">â† è¡£å·¦</button>
                                        <button onClick={() => setSuit({...suit, x: suit.x+5})} className="bg-blue-500 text-white p-2 rounded shadow">â†’ è¡£å³</button>
                                        <button onClick={() => setSuit({...suit, s: suit.s-0.02})} className="bg-blue-500 text-white p-2 rounded shadow">ï¼ ç¸®å°</button>
                                    </div>
                                    <div className="flex gap-2 overflow-x-auto py-2">
                                        {[1, 2, 3, 4, 5].map(i => (
                                            <img key={i} src={`./suit-m${i}.png`} onClick={() => setSuit({...suit, id: `m${i}`})} className={`w-12 h-12 border-2 rounded-lg cursor-pointer ${suit.id === `m${i}` ? 'border-blue-600' : ''}`} />
                                        ))}
                                    </div>
                                </div>

                                {/* 3. æ‹¼æ¿ä¸‹è¼‰ */}
                                <div className="pt-4 border-t">
                                    <div className="flex gap-2 mb-3">
                                        {Object.values(SPECS).map(s => (
                                            <button key={s.id} onClick={() => setCurrentSpec(s)} className={`text-xs px-2 py-1 rounded border ${currentSpec.id === s.id ? 'bg-black text-white' : ''}`}>{s.label}</button>
                                        ))}
                                    </div>
                                    <p className="text-xs text-gray-400 mb-2">å·²åŠ å…¥: {photoList.length} å¼µ</p>
                                    <button disabled={photoList.length === 0} onClick={() => alert("åŠŸèƒ½å·²å°±ç·’ï¼Œè«‹åŸ·è¡Œä¸‹è¼‰ç¨‹å¼")} className="w-full bg-black text-white py-4 rounded-2xl font-black">ğŸ’¾ ä¸‹è¼‰æ‹¼æ¿ (4x6å‹)</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
    </script>
</body>
</html>
