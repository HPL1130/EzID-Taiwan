<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v3.5.5 ibon-Ready</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .canvas-container { position:relative; width:350px; height:450px; margin:0 auto; background:#fff; border:1px solid #e2e8f0; overflow:hidden; }
        
        /* æ¯”ä¾‹ä¿®æ­£ï¼šæ›´çª„çš„é•·æ©¢åœ“ï¼Œä½ç½®ä¸Šç§»ï¼Œç¬¦åˆå…§æ”¿éƒ¨é ­é ‚ç•™ç™½æ„Ÿ */
        .inner-guide { 
            position:absolute; left:50%; top:45%; /* é‡å¿ƒä¸Šç§» */
            width:62%; height:71.1%; 
            border:2px dotted #10b981; border-radius:50% / 44%; 
            transform:translate(-50%,-50%); z-index:100; pointer-events:none; 
        }
        .outer-guide { 
            position:absolute; left:50%; top:45%; 
            width:70%; height:80%; 
            border:2px dashed #f59e0b; border-radius:50% / 44%; 
            transform:translate(-50%,-50%); z-index:99; pointer-events:none; 
        }
        .center-line { position:absolute; left:50%; top:0; bottom:0; width:1px; background:rgba(37,99,235,0.1); transform:translateX(-50%); }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

// ä¿®æ­£è·¯å¾‘èˆ‡ Meta
const M_SUITS = Array(5).fill(0).map((_, i) => ({ id: `male/m${i+1}.png`, neckY: 0.12, sW: 0.88 }));
const F_SUITS = Array(5).fill(0).map((_, i) => ({ id: `female/f${i+1}.png`, neckY: 0.16, sW: 0.82 }));

// è¼¸å‡ºè¦æ ¼å®šç¾©
const SPECS = {
    A4: { w: 2480, h: 3508, name: 'A4' },
    P46: { w: 1200, h: 1800, name: '4x6' } // 300DPI ä¸‹ 4x6 å‹
};

function App() {
    const canvasRef = useRef(null);
    const [image, setImage] = useState(null);
    const [suit, setSuit] = useState({ img: null, meta: null });
    const [slots, setSlots] = useState([]);
    const [p, setP] = useState({ x: 0, y: -30, s: 0.8 }); // åˆå§‹ä½ç½®ä¸Šç§»
    const [sp, setSp] = useState({ x: 0, y: 0, s: 1.0 });

    const draw = useCallback(() => {
        const ctx = canvasRef.current.getContext("2d");
        ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, 350, 450);
        if(image) {
            ctx.save(); ctx.translate(175 + p.x, 225 + p.y); ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width/2, -image.height/2); ctx.restore();
        }
        if(suit.img) {
            ctx.save();
            const w = suit.img.width * sp.s; const h = suit.img.height * sp.s;
            // ç‰©ç†éŒ¨é»ä¿®æ­£ï¼šè¡£æœå°é½Šäººè‡‰åº•éƒ¨
            ctx.drawImage(suit.img, (350 - w)/2 + sp.x, 305 - (h * suit.meta.neckY) + sp.y, w, h);
            ctx.restore();
        }
    }, [image, suit, p, sp]);

    useEffect(() => { draw(); }, [draw]);

    const selectSuit = (meta) => {
        if(!meta) return setSuit({img:null, meta:null});
        const img = new Image();
        img.onload = () => {
            setSuit({ img, meta });
            setSp(prev => ({ ...prev, s: (189 * 1.6) / (img.width * meta.sW) }));
        };
        img.src = `clothes/${meta.id}`;
    };

    const exportImage = async (specKey, mode) => {
        if(!slots.length) return alert("è«‹å…ˆå­˜å…¥æ§½ä½");
        const spec = SPECS[specKey];
        const pc = document.createElement("canvas");
        pc.width = spec.w; pc.height = spec.h;
        const ctx = pc.getContext("2d");
        ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, spec.w, spec.h);

        const imgs = await Promise.all(slots.map(s => new Promise(res => {
            const i = new Image(); i.onload = () => res(i); i.src = s;
        })));

        const SAFE = Math.round(spec.w * 0.05);
        let curY = SAFE, idx = 0;

        const renderRow = (sw, sh, gap, count) => {
            const cols = Math.floor((spec.w - 2 * SAFE + gap) / (sw + gap));
            const startX = (spec.w - (cols * sw + (cols - 1) * gap)) / 2;
            for(let i=0; i<count; i++){
                const r = Math.floor(i/cols), c = i%cols;
                ctx.drawImage(imgs[idx % imgs.length], startX + c*(sw+gap), curY + r*(sh+gap), sw, sh);
                ctx.strokeStyle = "#ccc"; ctx.strokeRect(startX + c*(sw+gap), curY + r*(sh+gap), sw, sh);
                idx++;
            }
            curY += (Math.ceil(count/cols) * (sh + gap));
        };

        if(mode === 'MIX') { renderRow(413, 531, 30, specKey==='P46'?2:8); renderRow(295, 413, 20, specKey==='P46'?4:12); }
        else if(mode === 'ALL2') { renderRow(413, 531, 30, specKey==='P46'?8:20); }
        else if(mode === 'ALL1') { renderRow(295, 413, 20, specKey==='P46'?12:35); }

        const a = document.createElement("a");
        a.href = pc.toDataURL("image/png"); a.download = `EzID_${spec.name}_${mode}.png`; a.click();
    };

    return (
        <div className="max-w-md mx-auto p-4">
            <h1 className="font-black italic text-xl mb-4">EzID v3.5.5 <span className="text-xs bg-black text-white px-2 py-1 rounded">FIXED</span></h1>
            
            <div className="canvas-container mb-4 shadow-xl rounded-lg">
                <canvas ref={canvasRef} width="350" height="450" />
                <div className="absolute inset-0 pointer-events-none">
                    <div className="inner-guide"></div>
                    <div className="outer-guide"></div>
                    <div className="center-line"></div>
                </div>
            </div>

            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-4">
                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                    <button onClick={()=>selectSuit(null)} className="flex-shrink-0 w-12 h-12 border-2 border-dashed rounded-xl">âœ•</button>
                    {[...M_SUITS, ...F_SUITS].map(s => (
                        <button key={s.id} onClick={()=>selectSuit(s)} className="flex-shrink-0 w-12 h-12 border rounded-xl overflow-hidden bg-slate-50">
                            <img src={`clothes/${s.id}`} className="w-full h-full object-contain" />
                        </button>
                    ))}
                </div>
                <input type="range" className="w-full my-4" min="0.5" max="2" step="0.01" value={sp.s} onChange={e=>setSp({...sp, s:+e.target.value})} />
            </div>

            <div className="grid grid-cols-2 gap-2 mb-6">
                <label className="bg-slate-800 text-white py-3 rounded-xl text-center text-xs font-bold cursor-pointer">
                    ğŸ“¸ ä¸Šå‚³ç…§ç‰‡ <input type="file" hidden accept="image/*" onChange={e => {
                        const img = new Image(); img.onload = () => setImage(img); img.src = URL.createObjectURL(e.target.files[0]);
                    }} />
                </label>
                <button onClick={() => {
                    setSlots(prev => [canvasRef.current.toDataURL(), ...prev.slice(0,9)]);
                }} className="bg-blue-600 text-white py-3 rounded-xl text-xs font-bold">ğŸ“¥ å­˜å…¥æ§½ä½ ({slots.length})</button>
            </div>

            <div className="space-y-4">
                <div>
                    <span className="text-[10px] font-bold text-slate-400 block mb-2 uppercase">ğŸª ibon 4x6 ç›¸ç‰‡ç´™ (æ¨è–¦)</span>
                    <div className="grid grid-cols-3 gap-2">
                        <button onClick={()=>exportImage('P46','MIX')} className="bg-emerald-600 text-white py-2 rounded-lg text-[10px] font-bold">4x6 æ··æ’</button>
                        <button onClick={()=>exportImage('P46','ALL2')} className="bg-slate-700 text-white py-2 rounded-lg text-[10px] font-bold">4x6 å…¨éƒ¨2å‹</button>
                        <button onClick={()=>exportImage('P46','ALL1')} className="bg-slate-700 text-white py-2 rounded-lg text-[10px] font-bold">4x6 å…¨éƒ¨1å‹</button>
                    </div>
                </div>
                <div>
                    <span className="text-[10px] font-bold text-slate-400 block mb-2 uppercase">ğŸ“„ å®¶ç”¨ A4 æ™®é€šç´™</span>
                    <div className="grid grid-cols-3 gap-2">
                        <button onClick={()=>exportImage('A4','MIX')} className="bg-slate-400 text-white py-2 rounded-lg text-[10px] font-bold">A4 æ··æ’</button>
                        <button onClick={()=>exportImage('A4','ALL2')} className="bg-slate-400 text-white py-2 rounded-lg text-[10px] font-bold">A4 å…¨éƒ¨2å‹</button>
                        <button onClick={()=>exportImage('A4','ALL1')} className="bg-slate-400 text-white py-2 rounded-lg text-[10px] font-bold">A4 å…¨éƒ¨1å‹</button>
                    </div>
                </div>
            </div>
        </div>
    );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
