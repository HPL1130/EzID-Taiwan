<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v2.8.0</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .canvas-container { position:relative; width:350px; height:450px; margin:0 auto; background:#fff; border-radius:32px; border:8px solid #fff; box-shadow:0 20px 40px rgba(0,0,0,.1); overflow:hidden; }
        .inner-guide { border:2px dotted rgba(16,185,129,0.7); position:absolute; border-radius:50%/46%; transform:translateY(-6%); z-index: 100; }
        .outer-guide { border:2px dashed rgba(245,158,11,0.5); position:absolute; border-radius:50%/46%; transform:translateY(-6%); z-index: 99; }
        .center-line { position:absolute; left:50%; top:0; bottom:0; width:1.5px; background:rgba(59,130,246,0.3); pointer-events:none; z-index: 90; }
        .suit-btn { width:52px; height:52px; flex-shrink:0; border:2px solid #f1f5f9; border-radius:12px; background:#fff; display:flex; align-items:center; justify-content:center; position:relative; }
        .suit-btn.active { border-color:#2563eb; background:#eff6ff; }
        .toast { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:8px 20px; border-radius:20px; font-size:12px; z-index:999; animation:fadeInOut 2s ease-in-out forwards; }
        @keyframes fadeInOut { 0% { opacity:0; } 15% { opacity:1; } 85% { opacity:1; } 100% { opacity:0; } }
        input[type=range] { width:100%; accent-color:#2563eb; cursor:pointer; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

function App() {
    const canvasRef = useRef(null);
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [activeSuit, setActiveSuit] = useState(null);
    const [slots, setSlots] = useState([]);
    const [toast, setToast] = useState("");
    
    // p: ç…§ç‰‡, sp: è¡£æœ
    const [p, setP] = useState({ x: 0, y: -20, s: 0.75 });
    const [sp, setSp] = useState({ x: 0, y: 0, s: 1.0 });

    const CLOTHES = {
        male: Array.from({length:5}, (_,i)=> `clothes/male/m${i+1}.png`),
        female: Array.from({length:5}, (_,i)=> `clothes/female/f${i+1}.png`)
    };

    const showToast = (msg) => { setToast(msg); setTimeout(()=>setToast(""), 2000); };

    const draw = useCallback(() => {
        const ctx = canvasRef.current.getContext("2d");
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, 350, 450);
        if(image){
            ctx.save(); ctx.translate(175 + p.x, 225 + p.y); ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width/2, -image.height/2); ctx.restore();
        }
        if(suitImg){
            ctx.save();
            const w = 350 * sp.s; const h = (suitImg.height / suitImg.width) * w;
            ctx.drawImage(suitImg, (350 - w)/2 + sp.x, 450 - h + 15 + sp.y, w, h);
            ctx.restore();
        }
    }, [image, suitImg, p, sp]);

    useEffect(() => { 
        const frameId = requestAnimationFrame(draw);
        return () => cancelAnimationFrame(frameId);
    }, [draw]);

    const handleUpload = (e) => {
        const f = e.target.files[0];
        if(!f) return;
        const url = URL.createObjectURL(f);
        const img = new Image();
        img.onload = () => {
            setImage(img);
            URL.revokeObjectURL(url); // ä¿®æ­£ 3: è¨˜æ†¶é«”æ´©æ¼
            showToast("ç…§ç‰‡è¼‰å…¥æˆåŠŸ");
        };
        img.src = url;
    };

    const selectSuit = (url) => {
        if(!url) { setSuitImg(null); setActiveSuit(null); return; }
        const img = new Image();
        img.onload = () => {
            setSuitImg(img);
            setActiveSuit(url); // ä¿®æ­£ 1: ç¢ºä¿åœ–ç‰‡è¼‰å…¥å¾Œæ‰åˆ‡æ› Active ç‹€æ…‹
        };
        img.src = url;
    };

    const saveToSlot = () => {
        if(!image) return alert("è«‹å…ˆä¸Šå‚³ç…§ç‰‡");
        setSlots(prev => [canvasRef.current.toDataURL("image/jpeg", 0.9), ...prev].slice(0, 10));
        showToast("å·²å­˜å…¥æ§½ä½");
    };

    // âœ‚ï¸ å°ˆæ¥­è£åˆ‡è¼”åŠ© (Lå‹è§’æ¨™ç³»çµ±)
    const drawLMark = (ctx, x, y, w, h) => {
        ctx.strokeStyle = "#000000"; ctx.lineWidth = 1;
        ctx.strokeRect(x, y, w, h); // åŸºç¤é»‘æ¡†
        
        // å››è§’ L æ¨™ (å¼·åŒ–æ˜“å‰ªåº¦)
        const L = 20;
        ctx.beginPath();
        // å·¦ä¸Š
        ctx.moveTo(x-L, y); ctx.lineTo(x, y); ctx.lineTo(x, y-L);
        // å³ä¸Š
        ctx.moveTo(x+w+L, y); ctx.lineTo(x+w, y); ctx.lineTo(x+w, y-L);
        // å·¦ä¸‹
        ctx.moveTo(x-L, y+h); ctx.lineTo(x, y+h); ctx.lineTo(x, y+h+L);
        // å³ä¸‹
        ctx.moveTo(x+w+L, y+h); ctx.lineTo(x+w, y+h); ctx.lineTo(x+w, y+h+L);
        ctx.stroke();
    };

    const downloadA4 = async (mode) => {
        if(!slots.length) return alert("æ§½ä½ç‚ºç©º");
        const A4_W = 2480, A4_H = 3508, SAFE = 120;
        const pc = document.createElement("canvas");
        pc.width = A4_W; pc.height = A4_H;
        const ctx = pc.getContext("2d");
        ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, A4_W, A4_H);

        const imgs = await Promise.all(slots.map(s => new Promise(r => { const i=new Image(); i.onload=()=>r(i); i.src=s; })));
        let idx = 0;

        const runLayout = (sw, sh, gap, startY, limitY) => {
            const cols = Math.floor((A4_W - SAFE*2) / (sw + gap));
            let currY = startY;
            while(currY + sh < limitY) {
                let startX = (A4_W - (cols * (sw + gap) - gap)) / 2;
                for(let c=0; c<cols; c++) {
                    drawLMark(ctx, startX + c*(sw+gap), currY, sw, sh);
                    ctx.drawImage(imgs[idx%imgs.length], startX + c*(sw+gap), currY, sw, sh);
                    idx++;
                }
                currY += sh + gap;
            }
            return currY;
        };

        if(mode === 'ALL_2') runLayout(413, 531, 35, SAFE, A4_H - SAFE);
        else if(mode === 'ALL_1') runLayout(295, 413, 25, SAFE, A4_H - SAFE);
        else {
            let nextY = runLayout(413, 531, 35, SAFE, A4_H * 0.58);
            runLayout(295, 413, 25, nextY + 40, A4_H - SAFE);
        }

        const a = document.createElement("a");
        a.href = pc.toDataURL("image/png");
        a.download = `EzID_A4_${mode}.png`;
        a.click();
    };

    return (
        <div className="max-w-md mx-auto p-4 pb-20">
            {toast && <div className="toast">{toast}</div>}
            
            <header className="flex justify-between items-end mb-4 px-2">
                <h1 className="font-black text-slate-800 italic text-xl">EzID <span className="text-blue-500 text-xs not-italic">v2.8.0 PRO</span></h1>
                <div className="text-[10px] text-slate-400 font-bold uppercase tracking-tighter text-right">
                    ibon Safe Area Ready<br/>L-Mark Precise Cut
                </div>
            </header>

            <div className="canvas-container mb-6">
                <canvas ref={canvasRef} width="350" height="450" />
                <div className="center-line"></div>
                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div className="inner-guide" style={{width:'71%', height:'71%'}}></div>
                    <div className="outer-guide" style={{width:'80%', height:'80%'}}></div>
                </div>
            </div>

            <section className="space-y-4">
                {/* ğŸ‘” ä¿®æ­£ 2: åŠ å…¥å¥³æ€§èˆ‡ SP æ§åˆ¶å™¨ */}
                <div className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                    <div className="flex justify-between items-center mb-3">
                        <span className="text-[10px] font-bold text-slate-400 uppercase">ğŸ‘” æ•¸ä½æ›è£ (SP Mode)</span>
                        <button onClick={()=>selectSuit(null)} className="text-[10px] text-red-500 font-bold">ç§»é™¤æœè£</button>
                    </div>
                    <div className="space-y-3">
                        <div className="flex gap-2 overflow-x-auto no-scrollbar">
                            {CLOTHES.male.map(s => <button key={s} onClick={()=>selectSuit(s)} className={`suit-btn ${activeSuit===s?'active':''}`}><img src={s} className="w-10"/></button>)}
                        </div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar">
                            {CLOTHES.female.map(s => <button key={s} onClick={()=>selectSuit(s)} className={`suit-btn ${activeSuit===s?'active':''}`}><img src={s} className="w-10"/></button>)}
                        </div>
                    </div>

                    {suitImg && (
                        <div className="mt-4 p-3 bg-blue-50/50 rounded-2xl border border-blue-100 space-y-3">
                            <div className="grid grid-cols-2 gap-x-4">
                                <div><div className="text-[9px] text-blue-500 font-bold mb-1">è¡£æœå¤§å°</div><input type="range" min="0.5" max="2.5" step="0.01" value={sp.s} onChange={e=>setSp({...sp, s:+e.target.value})} /></div>
                                <div><div className="text-[9px] text-blue-500 font-bold mb-1">å‚ç›´ä½ç½®</div><input type="range" min="-100" max="100" value={sp.y} onChange={e=>setSp({...sp, y:+e.target.value})} /></div>
                            </div>
                        </div>
                    )}
                </div>

                <div className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 space-y-4">
                    <div className="text-[10px] font-bold text-slate-400 uppercase">ğŸ‘¤ ç…§ç‰‡èª¿æ•´ (P Mode)</div>
                    <div className="space-y-4">
                        <input type="range" min="0.3" max="1.5" step="0.01" value={p.s} onChange={e=>setP({...p, s:+e.target.value})} />
                        <div className="grid grid-cols-2 gap-4">
                            <input type="range" min="-150" max="150" value={p.y} onChange={e=>setP({...p, y:+e.target.value})} />
                            <input type="range" min="-100" max="100" value={p.x} onChange={e=>setP({...p, x:+e.target.value})} />
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3 mt-4">
                        <label className="bg-slate-800 text-white py-3 rounded-xl text-center font-bold text-xs cursor-pointer shadow-md active:scale-95 transition-all">ğŸ“¸ ä¸Šå‚³ç…§ç‰‡<input type="file" hidden accept="image/*" onChange={handleUpload}/></label>
                        <button onClick={saveToSlot} className="bg-blue-600 text-white py-3 rounded-xl font-bold text-xs shadow-md active:scale-95 transition-all">ğŸ“¥ å­˜å…¥æ§½ä½</button>
                    </div>
                </div>
            </section>

            <div className="mt-8">
                <div className="flex justify-between items-center mb-3 px-1">
                    <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">æ’ç‰ˆæ§½ä½ ({slots.length}/10)</span>
                    <button onClick={()=>setSlots([])} className="text-[10px] text-red-400 font-bold">å…¨éƒ¨æ¸…ç©º</button>
                </div>
                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                    {slots.map((s,i)=>(
                        <div key={i} className="relative flex-shrink-0 group">
                            <img src={s} className="w-16 h-20 rounded-lg border-2 border-white shadow-sm" />
                            <button onClick={()=>setSlots(slots.filter((_,idx)=>idx!==i))} className="absolute -top-1 -right-1 bg-red-500 text-white w-5 h-5 rounded-full text-[10px] shadow-sm">âœ•</button>
                        </div>
                    ))}
                </div>
            </div>

            <div className="mt-8 space-y-3">
                <button onClick={()=>downloadA4('MIX')} className="w-full bg-emerald-700 text-white py-4 rounded-2xl font-black text-sm shadow-xl active:scale-95 transition-all">ğŸª ibon A4ï½œ1+2 å‹ æ··æ’</button>
                <div className="grid grid-cols-2 gap-3">
                    <button onClick={()=>downloadA4('ALL_2')} className="bg-indigo-600 text-white py-3 rounded-xl font-bold text-xs shadow-md">ğŸª A4 å…¨ 2 å‹</button>
                    <button onClick={()=>downloadA4('ALL_1')} className="bg-indigo-600 text-white py-3 rounded-xl font-bold text-xs shadow-md">ğŸª A4 å…¨ 1 å‹</button>
                </div>
            </div>
            
            <p className="mt-6 text-center text-[9px] text-slate-300 font-medium px-6 leading-relaxed">
                * è‹¥ iPhone ä¸Šå‚³ç…§ç‰‡æ–¹å‘ä¸æ­£ç¢ºï¼Œè«‹å…ˆè‡³ç›¸ç°¿æ—‹è½‰ç·¨è¼¯å¾Œå†ä¸Šå‚³ã€‚<br/>
                * è¼¸å‡ºå·²è‡ªå‹•å¥—ç”¨ 12mm å®‰å…¨é‚Šç•Œã€‚
            </p>
        </div>
    );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
