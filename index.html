<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v1.2.9</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { removeBackground } from "https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.4.5/+esm";
        window.imglyRemoveBg = removeBackground;
        // ç™¼é€ä¸€å€‹è‡ªå®šç¾©äº‹ä»¶é€šçŸ¥ React çµ„ä»¶å·²å°±ç·’
        window.dispatchEvent(new Event('bg-engine-ready'));
    </script>

    <style>
        body { background-color: #f8fafc; color: #1e293b; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        canvas { background: white; border-radius: 12px; max-width: 100%; height: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .guide-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -55%); width: 55%; height: 55%; border: 2px dashed rgba(239, 68, 68, 0.4); border-radius: 50%; pointer-events: none; z-index: 10; }
        .app-card { background: #ffffff; border-radius: 20px; border: 1px solid #e2e8f0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type=range] { accent-color: #2563eb; cursor: pointer; }
    </style>
</head>
<body class="p-3 md:p-6 no-scrollbar">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

const EzIDApp = () => {
    const [image, setImage] = useState(null);
    const [isCam, setIsCam] = useState(false);
    const [mode, setMode] = useState('MIXED');
    const [p, setP] = useState({ x: 0, y: 0, s: 0.6 });
    const [suit, setSuit] = useState({ id: null, x: 175, y: 340, s: 0.3 });
    const [isProcessing, setIsProcessing] = useState(false);
    const [progress, setProgress] = useState(0);
    const [isEngineReady, setIsEngineReady] = useState(!!window.imglyRemoveBg);

    const canvasRef = useRef(null);
    const videoRef = useRef(null);
    const suitImg = useRef(new Image());

    // ç›£è½å¼•æ“æ˜¯å¦è¼‰å…¥å®Œæˆ
    useEffect(() => {
        const handleReady = () => setIsEngineReady(true);
        window.addEventListener('bg-engine-ready', handleReady);
        return () => window.removeEventListener('bg-engine-ready', handleReady);
    }, []);

    const getClothesPath = (id) => {
        const url = window.location.href.split('?')[0];
        const baseUrl = url.endsWith('/') ? url : url.substring(0, url.lastIndexOf('/') + 1);
        return `${baseUrl}clothes/suit-${id}.png`;
    };

    const draw = useCallback(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, 350, 450);

        if (image) {
            ctx.save();
            ctx.translate(175 + parseInt(p.x), 225 + parseInt(p.y));
            ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width/2, -image.height/2);
            ctx.restore();
        }

        if (suit.id) {
            const src = getClothesPath(suit.id);
            if (suitImg.current.src !== src) {
                suitImg.current.src = src;
                suitImg.current.onload = draw;
            }
            if (suitImg.current.complete) {
                ctx.save();
                ctx.translate(parseInt(suit.x), parseInt(suit.y));
                ctx.scale(suit.s * 1.5, suit.s * 1.5);
                ctx.drawImage(suitImg.current, -suitImg.current.width/2, -suitImg.current.height/2);
                ctx.restore();
            }
        }
    }, [image, p, suit]);

    useEffect(() => { draw(); }, [draw]);

    const startCam = async () => {
        setIsCam(true);
        try {
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            videoRef.current.srcObject = s;
        } catch (e) { alert("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ"); setIsCam(false); }
    };

    const snap = () => {
        const tc = document.createElement('canvas');
        tc.width = videoRef.current.videoWidth;
        tc.height = videoRef.current.videoHeight;
        const tctx = tc.getContext('2d');
        tctx.translate(tc.width, 0); tctx.scale(-1, 1);
        tctx.drawImage(videoRef.current, 0, 0);
        const img = new Image();
        img.onload = () => { setImage(img); setIsCam(false); };
        img.src = tc.toDataURL();
        videoRef.current.srcObject.getTracks().forEach(t => t.stop());
    };

    const removeBG = async () => {
        if (!image) return alert("è«‹å…ˆæº–å‚™ç…§ç‰‡");
        if (!isEngineReady) return alert("å¼•æ“é‚„åœ¨åŠªåŠ›è¼‰å…¥ä¸­ï¼Œè«‹å†ç­‰å¹¾ç§’...");
        
        setIsProcessing(true);
        setProgress(5);
        
        try {
            const blob = await window.imglyRemoveBg(image.src, {
                progress: (percent) => setProgress(Math.round(percent * 100))
            });
            const url = URL.createObjectURL(blob);
            const newImg = new Image();
            newImg.onload = () => { 
                setImage(newImg); 
                setIsProcessing(false); 
                setProgress(0);
            };
            newImg.src = url;
        } catch (e) { 
            alert("å»èƒŒå¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ–æ›´æ›ç€è¦½å™¨"); 
            setIsProcessing(false); 
        }
    };

    const download = () => {
        const pc = document.createElement('canvas');
        const ctx = pc.getContext('2d');
        pc.width = 1800; pc.height = 1200;
        ctx.fillStyle = "white"; ctx.fillRect(0, 0, 1800, 1200);
        
        if (mode === 'MIXED') {
            for(let i=0; i<4; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 80+i*425, 80, 413, 531);
            for(let i=0; i<5; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 80+i*340, 650, 331, 449);
        } else if (mode === 'TWO') {
            for(let i=0; i<8; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 100+(i%4)*410, 80+(Math.floor(i/4)*540), 413, 531);
        } else {
            for(let i=0; i<10; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 80+(i%5)*340, 100+(Math.floor(i/5)*460), 331, 449);
        }

        const a = document.createElement('a');
        a.download = `ezid_v129_${mode}.png`; a.href = pc.toDataURL(); a.click();
    };

    return (
        <div className="max-w-md mx-auto lg:max-w-6xl flex flex-col lg:flex-row gap-6">
            <div className="w-full lg:w-[400px] flex flex-col items-center shrink-0">
                <div className="relative mb-6 w-full max-w-[350px]">
                    {isCam ? <video ref={videoRef} autoPlay className="w-full aspect-[35/45] object-cover rounded-2xl scale-x-[-1]" /> : <canvas ref={canvasRef} width={350} height={450} className="w-full" />}
                    <div className="guide-overlay"></div>
                    
                    {isProcessing && (
                        <div className="absolute inset-0 bg-white/90 rounded-2xl flex flex-col items-center justify-center p-6 text-center">
                            <div className="text-blue-600 font-black text-xl mb-4">
                                {progress < 100 ? `è™•ç†ä¸­ ${progress}%` : "å„ªåŒ–å½±åƒé‚Šç·£..."}
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-3 mb-2">
                                <div className="bg-blue-600 h-3 rounded-full" style={{ width: `${progress}%`, transition: 'width 0.3s' }}></div>
                            </div>
                        </div>
                    )}
                </div>
                
                <div className="w-full space-y-3 px-2">
                    {isCam ? <button onClick={snap} className="w-full bg-red-500 text-white py-4 rounded-2xl font-black text-lg">ğŸ“¸ æ‹ç…§</button> : (
                        <>
                            <button onClick={download} className="w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-lg shadow-lg active:scale-95 transition">ğŸ’¾ ä¸‹è¼‰æ’ç‰ˆçµæœ</button>
                            
                            {/* æ”¹é€²ï¼šæŒ‰éˆ•æœƒæ ¹æ“šå¼•æ“ç‹€æ…‹æ”¹è®Šé¡è‰² */}
                            <button 
                                onClick={removeBG} 
                                className={`w-full py-3 rounded-xl font-bold shadow-md transition ${isEngineReady ? 'bg-indigo-600 text-white hover:bg-indigo-700' : 'bg-slate-300 text-slate-500 cursor-not-allowed'}`}
                            >
                                {isEngineReady ? 'âœ¨ AI è‡ªå‹•å»èƒŒ' : 'âŒ› å¼•æ“è¼‰å…¥ä¸­...'}
                            </button>

                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={startCam} className="bg-slate-700 text-white py-3 rounded-xl font-bold">ğŸ“· ç›¸æ©Ÿ</button>
                                <label className="bg-slate-200 text-slate-700 py-3 rounded-xl font-bold text-center cursor-pointer">
                                    ğŸ“ ç›¸ç°¿ <input type="file" className="hidden" onChange={e=>{
                                        const r=new FileReader(); r.onload=f=>{const i=new Image(); i.onload=()=>setImage(i); i.src=f.target.result;};
                                        r.readAsDataURL(e.target.files[0]);
                                    }} />
                                </label>
                            </div>
                        </>
                    )}
                </div>
            </div>

            <div className="flex-1 app-card p-6 space-y-8">
                <section>
                    <p className="text-xs font-bold text-slate-400 mb-3 tracking-widest uppercase">1. æ’ç‰ˆæ¨¡å¼ (v1.2.9)</p>
                    <div className="flex gap-2">
                        {[['MIXED','æ··åˆ'],['TWO','å…¨2å‹'],['ONE','å…¨1å‹']].map(([k,v]) => (
                            <button key={k} onClick={()=>setMode(k)} className={`flex-1 py-3 rounded-xl font-bold transition ${mode===k?'bg-blue-600 text-white shadow-md':'bg-slate-100 text-slate-400'}`}>{v}</button>
                        ))}
                    </div>
                </section>

                <section className="space-y-4">
                    <p className="text-xs font-bold text-blue-500 tracking-widest uppercase">2. å¾®èª¿ç…§ç‰‡</p>
                    <div className="flex items-center gap-4 text-xs font-bold text-slate-500"><span>å¤§å°</span><input type="range" min="0.1" max="1.5" step="0.01" value={p.s} onChange={e=>setP({...p, s:parseFloat(e.target.value)})} className="flex-1" /></div>
                    <div className="grid grid-cols-2 gap-4 text-xs font-bold text-slate-500">
                        <div className="flex items-center gap-2"><span>å·¦å³</span><input type="range" min="-200" max="200" value={p.x} onChange={e=>setP({...p, x:parseInt(e.target.value)})} className="flex-1" /></div>
                        <div className="flex items-center gap-2"><span>ä¸Šä¸‹</span><input type="range" min="-200" max="200" value={p.y} onChange={e=>setP({...p, y:parseInt(e.target.value)})} className="flex-1" /></div>
                    </div>
                </section>

                <section className="border-t border-slate-100 pt-6">
                    <p className="text-xs font-bold text-indigo-500 tracking-widest uppercase">3. æ›´æ›è¡£æœ</p>
                    <div className="flex gap-4 overflow-x-auto py-4 no-scrollbar">
                        {['m1','m2','m3','m4','m5'].map(n => (
                            <div key={n} onClick={()=>setSuit({...suit, id:n})} 
                                 className={`p-1 rounded-2xl border-2 shrink-0 bg-white transition ${suit.id===n?'border-blue-500 shadow-md scale-105':'border-slate-100 opacity-50'}`}>
                                <img src={getClothesPath(n)} className="w-16 h-16 object-contain" alt={n} onError={e=>e.target.style.display='none'} />
                            </div>
                        ))}
                        <button onClick={()=>setSuit({...suit, id:null})} className="px-6 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 shrink-0 font-bold text-xs">æ¸…é™¤è¡£æœ</button>
                    </div>
                    {suit.id && (
                        <div className="mt-2 space-y-4">
                            <div className="flex items-center gap-4 text-xs font-bold text-slate-500"><span>è¡£æœç¸®æ”¾</span><input type="range" min="0.1" max="1.0" step="0.01" value={suit.s} onChange={e=>setSuit({...suit, s:parseFloat(e.target.value)})} className="flex-1" /></div>
                            <div className="grid grid-cols-2 gap-4 text-xs font-bold text-slate-500">
                                <div className="flex items-center gap-2"><span>å·¦å³</span><input type="range" min="0" max="350" value={suit.x} onChange={e=>setSuit({...suit, x:parseInt(e.target.value)})} className="flex-1" /></div>
                                <div className="flex items-center gap-2"><span>ä¸Šä¸‹</span><input type="range" min="100" max="500" value={suit.y} onChange={e=>setSuit({...suit, y:parseInt(e.target.value)})} className="flex-1" /></div>
                            </div>
                        </div>
                    )}
                </section>
            </div>
        </div>
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
</script>
</body>
</html>
