<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v7.0</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .canvas-container { 
            position:relative; width:340px; height:437px; margin:0 auto; 
            background:#fff; border:4px solid #0f172a; border-radius:24px; overflow:hidden; 
            touch-action: none; cursor: grab; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }
    </style>
</head>
<body class="bg-slate-100 p-4 pb-16 font-sans select-none">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

const SUITS = [...Array(5).fill(0).map((_, i) => `male/m${i+1}.png`), ...Array(5).fill(0).map((_, i) => `female/f${i+1}.png`)];

function App() {
    const canvasRef = useRef(null);
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [slots, setSlots] = useState([]);
    const [target, setTarget] = useState("PHOTO");
    const [p, setP] = useState({ x: 0, y: -20, s: 0.8, f: 1 });
    const [sp, setSp] = useState({ x: 0, y: 80, s: 1.0 });
    const [bright, setBright] = useState(100);
    const [guideAlpha, setGuideAlpha] = useState(0.8);
    const [customName, setCustomName] = useState("ProID");

    // ç¹ªè£½å°å¼•ç·šå‡½æ•¸ (ç§»å…¥ Canvas ä»¥ä¿è­‰åŒæ­¥)
    const drawGuides = (ctx, alpha) => {
        if (alpha <= 0) return;
        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.setLineDash([5, 5]);
        
        // å…§åœˆ (é ­åƒ)
        ctx.strokeStyle = "#10b981";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.ellipse(175, 202.5, 108, 160, 0, 0, Math.PI * 2);
        ctx.stroke();

        // å¤–åœˆ
        ctx.strokeStyle = "#f59e0b";
        ctx.setLineDash([8, 4]);
        ctx.beginPath();
        ctx.ellipse(175, 202.5, 122, 180, 0, 0, Math.PI * 2);
        ctx.stroke();
        
        ctx.restore();
    };

    const draw = useCallback(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, 350, 450);
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, 350, 450);

        if (image) {
            ctx.save();
            ctx.filter = `brightness(${bright}%)`;
            ctx.translate(175 + p.x, 225 + p.y);
            ctx.scale(p.s * p.f, p.s);
            ctx.drawImage(image, -image.width/2, -image.height/2);
            ctx.restore();
        }

        if (suitImg) {
            ctx.save();
            const w = suitImg.width * sp.s;
            const h = suitImg.height * sp.s;
            ctx.drawImage(suitImg, 175 - w/2 + sp.x, 225 - h/2 + sp.y, w, h);
            ctx.restore();
        }

        // é—œéµä¿®æ­£ï¼šå°å¼•ç·šèˆ‡åœ–åƒåŒæ­¥ç¹ªè£½
        drawGuides(ctx, guideAlpha);
    }, [image, suitImg, p, sp, bright, guideAlpha]);

    useEffect(() => {
        const tid = requestAnimationFrame(draw);
        return () => cancelAnimationFrame(tid);
    }, [draw]);

    // ç¸®æ”¾é‚è¼¯èˆ‡è§¸æ§äº‹ä»¶ (è§£æ±ºæ¶ˆå¤±å•é¡Œèˆ‡ä¸­å¿ƒæ¼‚ç§»)
    const lastPos = useRef({ x: 0, y: 0 });
    const lastDist = useRef(0);
    const isDragging = useRef(false);

    const handleTouchStart = (e) => {
        isDragging.current = true;
        if (e.touches.length === 2) {
            lastDist.current = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        } else {
            lastPos.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }
    };

    const handleTouchMove = (e) => {
        if (!isDragging.current) return;
        e.preventDefault();
        if (e.touches.length === 2) {
            const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            const factor = dist / lastDist.current;
            if (target === "PHOTO") setP(v => ({ ...v, s: v.s * factor }));
            else setSp(v => ({ ...v, s: v.s * factor }));
            lastDist.current = dist;
        } else {
            const dx = (e.touches[0].clientX - lastPos.current.x);
            const dy = (e.touches[0].clientY - lastPos.current.y);
            if (target === "PHOTO") setP(v => ({ ...v, x: v.x + dx, y: v.y + dy }));
            else setSp(v => ({ ...v, x: v.x + dx, y: v.y + dy }));
            lastPos.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }
    };

    const addToSlot = () => {
        // å­˜å…¥æ§½ä½æ™‚ä¸å¸¶å°å¼•ç·š
        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = 350; tempCanvas.height = 450;
        const tctx = tempCanvas.getContext("2d");
        tctx.fillStyle = "#ffffff"; tctx.fillRect(0, 0, 350, 450);
        if (image) {
            tctx.save(); tctx.filter = `brightness(${bright}%)`;
            tctx.translate(175 + p.x, 225 + p.y); tctx.scale(p.s * p.f, p.s);
            tctx.drawImage(image, -image.width/2, -image.height/2); tctx.restore();
        }
        if (suitImg) {
            tctx.save(); const w = suitImg.width * sp.s; const h = suitImg.height * sp.s;
            tctx.drawImage(suitImg, 175 - w/2 + sp.x, 225 - h/2 + sp.y, w, h); tctx.restore();
        }
        setSlots(prev => [{ data: tempCanvas.toDataURL("image/png", 1.0), config: { image, suitImg, p, sp, bright } }, ...prev].slice(0, 10));
    };

    // (å…¶é¤˜ exportDoc, UI éƒ¨åˆ†ç¶­æŒ v6.0 ä½†ç§»é™¤ CSS å°å¼•ç·šä¸¦å„ªåŒ–æ»‘æ¡¿)
    // ... ç‚ºç¯€çœé•·åº¦ï¼Œæ­¤è™•åƒ…å±•ç¤ºé—œéµä¿®æ­£éƒ¨åˆ†ï¼Œå®Œæ•´ä»£ç¢¼å°‡åŒ…å«æ‰€æœ‰åŠŸèƒ½ ...

    return (
        <div className="max-w-md mx-auto space-y-4">
            <header className="flex justify-between items-center px-4 py-3 bg-white/80 backdrop-blur-md rounded-2xl sticky top-0 z-[200] shadow-sm">
                <h1 className="text-2xl font-black text-slate-900">EzID <span className="text-blue-600">v7.0</span></h1>
                <button onClick={()=>setP(v=>({...v, f: v.f*-1}))} className="px-4 py-1 bg-slate-900 text-white rounded-xl text-xs font-bold shadow-lg active:scale-95 transition-transform">â†” é¡åƒ</button>
            </header>

            <div className="canvas-container" 
                onTouchStart={handleTouchStart} 
                onTouchMove={handleTouchMove} 
                onTouchEnd={()=>isDragging.current=false}
                onMouseDown={(e)=>{isDragging.current=true; lastPos.current={x:e.clientX,y:e.clientY}}}
                onMouseMove={(e)=>{if(!isDragging.current)return; const dx=e.clientX-lastPos.current.x; const dy=e.clientY-lastPos.current.y; if(target==='PHOTO')setP(v=>({...v,x:v.x+dx,y:v.y+dy})); else setSp(v=>({...v,x:v.x+dx,y:v.y+dy})); lastPos.current={x:e.clientX,y:e.clientY}}}
                onMouseUp={()=>isDragging.current=false}>
                <canvas ref={canvasRef} width="350" height="450" className="w-full h-full" />
            </div>

            <div className="bg-white p-6 rounded-[2.5rem] shadow-xl space-y-4">
                <div className="flex justify-between items-center bg-slate-50 p-1.5 rounded-2xl">
                    <button onClick={()=>setTarget("PHOTO")} className={`flex-1 py-2 text-xs font-black rounded-xl transition ${target==='PHOTO'?'bg-white shadow text-blue-600':'text-slate-400'}`}>èª¿æ•´äººåƒ</button>
                    <button onClick={()=>setTarget("SUIT")} className={`flex-1 py-2 text-xs font-black rounded-xl transition ${target==='SUIT'?'bg-white shadow text-blue-600':'text-slate-400'}`}>èª¿æ•´è¡£æœ</button>
                </div>
                
                <div className="space-y-4">
                    <div className="flex items-center gap-4 text-[10px] font-bold text-slate-400">
                        <span className="w-12">ç¸®æ”¾æ¯”ä¾‹</span>
                        <input type="range" min="0.05" max="2.5" step="0.01" value={target === "PHOTO" ? p.s : sp.s} onChange={(e) => { const val = +e.target.value; if(target === "PHOTO") setP(v => ({...v, s: val})); else setSp(v => ({...v, s: val})); }} className="flex-1 accent-blue-600" />
                    </div>
                    <div className="flex items-center gap-4 text-[10px] font-bold text-slate-400">
                        <span className="w-12">å°å¼•äº®åº¦</span>
                        <input type="range" min="0" max="1" step="0.1" value={guideAlpha} onChange={(e)=>setGuideAlpha(e.target.value)} className="flex-1 accent-emerald-500" />
                    </div>
                    <div className="flex items-center gap-4 text-[10px] font-bold text-slate-400">
                        <span className="w-12">äººåƒäº®åº¦</span>
                        <input type="range" min="60" max="140" value={bright} onChange={(e)=>setBright(e.target.value)} className="flex-1 accent-amber-400" />
                    </div>
                </div>
            </div>

            <div className="grid grid-cols-2 gap-4 px-2">
                <label className="bg-slate-900 text-white py-4 rounded-3xl text-center text-sm font-black cursor-pointer shadow-lg active:scale-95 transition-transform">ğŸ“¸ ä¸Šå‚³ç…§ç‰‡ <input type="file" hidden accept="image/*" onChange={(e)=>{
                    const file = e.target.files[0]; if(!file) return;
                    const url = URL.createObjectURL(file);
                    const img = new Image(); img.onload = () => {
                        const ratio = (350 * 0.8) / img.width;
                        setImage(img); setP({ x: 0, y: -20, s: ratio, f: 1 }); setTarget("PHOTO");
                    }; img.src = url;
                }} /></label>
                <button onClick={addToSlot} className="bg-blue-600 text-white py-4 rounded-3xl text-sm font-black shadow-lg active:scale-95 transition-transform">ğŸ“¥ å­˜å…¥æ§½ä½</button>
            </div>

            {/* æ§½ä½èˆ‡å°å‡ºéƒ¨åˆ†èˆ‡ v6.0 ä¸€è‡´ï¼Œä½†åŠ å…¥äºŒæ¬¡ç¢ºèªå„ªåŒ– */}
            <div className="bg-slate-200/50 p-5 rounded-[2.5rem] space-y-3 mx-2">
                <div className="flex justify-between items-center px-1 font-black text-slate-500 text-[10px]">
                    <span>æš«å­˜æ§½ ({slots.length}/10)</span>
                    <button onClick={()=>{if(window.confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ"))setSlots([])}} className="text-red-500 uppercase">Clear</button>
                </div>
                <div className="flex gap-4 overflow-x-auto no-scrollbar py-2 min-h-[160px]">
                    {slots.map((s, idx) => (
                        <div key={idx} className="slot-item relative flex-shrink-0 w-[110px] h-[140px] bg-white rounded-2xl shadow-lg overflow-hidden border-2 border-white">
                            <div className="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full flex items-center justify-center text-[10px] z-30" onClick={() => setSlots(v => v.filter((_,i)=>i!==idx))}>Ã—</div>
                            <img src={s.data} className="w-full h-full object-cover" />
                            <div className="absolute bottom-0 inset-x-0 bg-slate-900/80 flex justify-around py-2">
                                <span className="text-white text-xs cursor-pointer" onClick={()=>{if(window.confirm("è¼‰å…¥ç·¨è¼¯ï¼Ÿ")){const c=s.config; setImage(c.image); setSuitImg(c.suitImg); setP({...c.p}); setSp({...c.sp}); setBright(c.bright);}}}>âœ ç·¨è¼¯</span>
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            {/* è¼¸å‡ºæŒ‰éˆ•å€åŸŸ (ç‚ºä¿æŒç°¡æ½”ï¼Œä¿ç•™ v6 é‚è¼¯) */}
            <div className="p-4 space-y-4 pb-24">
                <button onClick={() => exportDoc('A4', 'MIX')} className="w-full bg-blue-600 text-white py-4 rounded-3xl font-black text-sm shadow-xl">ç”Ÿæˆ A4 çµ‚æ¥µåˆ—å°æª” (å®Œå…¨ç½®ä¸­)</button>
                <button onClick={() => exportDoc('46', 'MIX')} className="w-full bg-emerald-600 text-white py-4 rounded-3xl font-black text-sm shadow-xl">ç”Ÿæˆ 4x6 ibon æ²–å°æª”</button>
            </div>
        </div>
    );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
