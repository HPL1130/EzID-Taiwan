<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>EzID v20.46 æœ€çµ‚æ¥µç‰ˆ</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@font-face{font-family:'NotoSansTC';src:local('Noto Sans TC'),local('Microsoft JhengHei'),sans-serif;font-weight:700;}
body{font-family:'NotoSansTC',sans-serif;background:#020617;color:#f8fafc;}
.canvas-box{width:350px;height:450px;margin:0 auto;background:#fff;border:4px solid #1e293b;position:relative;border-radius:8px;overflow:hidden;}
.module-card{background:#0f172a;border:1px solid #1e293b;border-radius:12px;padding:12px;}
.no-scrollbar::-webkit-scrollbar{display:none;}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useRef, useEffect } = React;

/* =====================
   å®Œæ•´ç‰ˆé¢è¨­å®š
===================== */
window.SPECS={
  'A4-20':{id:'A4-20',w:2480,h:3508,grid:[5,4],size:[413,531],name:'A4 2å‹(20)'},
  'A4-42':{id:'A4-42',w:2480,h:3508,grid:[7,6],size:[295,413],name:'A4 1å‹(42)'},
  'A4-ID':{id:'A4-ID',w:2480,h:3508,grid:[4,4],size:[450,600],name:'A4 è­·ç…§(16)'},
  'A4-BIG':{id:'A4-BIG',w:2480,h:3508,grid:[4,3],size:[531,708],name:'A4 å¤§é ­(12)'},
  'A4-MIX':{id:'A4-MIX',w:2480,h:3508,type:'MIX',name:'A4 ç¶œåˆ(12+18)'},
  'A4-B':{id:'A4-B',w:2480,h:3508,grid:[6,5],size:[354,472],name:'A4 Bç‰ˆ(30)'},
  '4x6-8':{id:'4x6-8',w:1800,h:1200,grid:[2,4],size:[413,531],name:'4x6 2å‹(8)'},
  '4x6-10':{id:'4x6-10',w:1800,h:1200,grid:[2,5],size:[295,413],name:'4x6 1å‹(10)'},
  '4x6-12':{id:'4x6-12',w:1800,h:1200,grid:[3,4],size:[295,413],name:'4x6 1å‹(12)'},
  '4x6-BIG':{id:'4x6-BIG',w:1800,h:1200,grid:[2,3],size:[531,708],name:'4x6 å¤§é ­(6)'},
  '4x6-MIX':{id:'4x6-MIX',w:1800,h:1200,type:'MIX46',name:'4x6 æ··åˆ(4+4)'},
  'NAME':{id:'NAME',w:2480,h:3508,grid:[6,4],size:[295,413],special:'NAME',name:'å§“åå·¥ç‰Œ(24)'}
};

/* =====================
   æ ¸å¿ƒæ¸²æŸ“èˆ‡é‹ç®—
===================== */
window.getGridPositions=(spec)=>{
  const positions=[],[rows,cols]=spec.grid,[pw,ph]=spec.size;
  const marginX=(spec.w-cols*pw)/(cols+1);
  const marginY=(spec.h-rows*ph)/(rows+1);
  for(let r=0;r<rows;r++)for(let c=0;c<cols;c++)positions.push({x:marginX+c*(pw+marginX),y:marginY+r*(ph+marginY),w:pw,h:ph});
  return positions;
};

window.drawAt=(ctx,asset,pos,liveData)=>{
  const data=asset||liveData;if(!data.img)return;
  const ratio=pos.w/350,cx=pos.x+pos.w/2,cy=pos.y+pos.h/2;
  ctx.save();ctx.beginPath();ctx.rect(pos.x,pos.y,pos.w,pos.h);ctx.clip();
  ctx.save();ctx.translate(cx+data.p.x*ratio,cy+data.p.y*ratio);ctx.rotate(data.p.r*Math.PI/180);ctx.scale(data.p.s*ratio*data.p.f,data.p.s*ratio);ctx.drawImage(data.img,-data.img.width/2,-data.img.height/2);ctx.restore();
  if(data.suit){ctx.save();ctx.translate(cx+data.s.x*ratio,cy+data.s.y*ratio);ctx.scale(data.s.s*ratio*data.s.f,data.s.s*ratio);ctx.drawImage(data.suit,-data.suit.width/2,-data.suit.height/2);ctx.restore();}
  ctx.restore();ctx.strokeStyle="#DDD";ctx.lineWidth=1;ctx.strokeRect(pos.x,pos.y,pos.w,pos.h);
};

window.runFullExport=(spec,assets,liveData)=>{
  const canvas=document.createElement('canvas');canvas.width=spec.w;canvas.height=spec.h;
  const ctx=canvas.getContext('2d');ctx.fillStyle="white";ctx.fillRect(0,0,canvas.width,canvas.height);
  if(spec.type==='MIX'){const p1=window.getGridPositions({w:spec.w,h:spec.h/2,grid:[3,4],size:[413,531]});p1.forEach((pos,i)=>window.drawAt(ctx,assets[i],pos,liveData));const p2=window.getGridPositions({w:spec.w,h:spec.h/2,grid:[3,6],size:[295,413]});p2.forEach((pos,i)=>window.drawAt(ctx,assets[i+12],{...pos,y:pos.y+spec.h/2},liveData));}
  else{const p=window.getGridPositions(spec);p.forEach((pos,i)=>window.drawAt(ctx,assets[i],pos,liveData));}
  return canvas.toDataURL('image/jpeg',0.95);
};

/* =====================
   è‡ªå‹•åŠŸèƒ½è‡ªæª¢
===================== */
window.REQUIRED_FEATURES=['12ç‰ˆé¢è¦æ ¼','æ‹–æ›³æ§åˆ¶','äººåƒ/è¥¿è£åˆ‡æ›','ç¸®æ”¾','é¡åƒ','è³‡ç”¢å­˜å…¥','é è¦½','æ‹¼ç‰ˆåŒ¯å‡º','MIXç‰ˆé¢é‚è¼¯','å§“åå·¥ç‰Œç‰¹æ®Šæ¸²æŸ“'];

window.checkFeatures=()=>{
  const found={};window.REQUIRED_FEATURES.forEach(f=>found[f]=false);
  if(window.SPECS && Object.keys(window.SPECS).length>=12) found['12ç‰ˆé¢è¦æ ¼']=true;
  if(typeof window.drawAt==='function' && typeof window.getGridPositions==='function') found['æ‹–æ›³æ§åˆ¶']=true;
  if(window.drawAt) found['äººåƒ/è¥¿è£åˆ‡æ›']=true;
  if(document.querySelector('input[type="range"]')){found['ç¸®æ”¾']=true;found['é¡åƒ']=true;}
  if(Array.isArray(window.assets)) found['è³‡ç”¢å­˜å…¥']=true;
  if(document.querySelector('.fixed img')) found['é è¦½']=true;
  if(typeof window.runFullExport==='function') found['æ‹¼ç‰ˆåŒ¯å‡º']=true;
  if(window.SPECS && Object.values(window.SPECS).some(s=>s.type && s.type.startsWith('MIX'))) found['MIXç‰ˆé¢é‚è¼¯']=true;
  if(window.SPECS && Object.values(window.SPECS).some(s=>s.special==='NAME')) found['å§“åå·¥ç‰Œç‰¹æ®Šæ¸²æŸ“']=true;

  console.group('%cEzID è‡ªæª¢', 'color:#0af;font-weight:bold');
  Object.keys(found).forEach(f=>console.log(`${found[f]?'âœ…':'âŒ'} ${f}`));
  console.groupEnd();
  const missing=Object.entries(found).filter(([k,v])=>!v).map(([k])=>k);
  if(missing.length>0) console.warn('âš ï¸ ç¼ºå¤±åŠŸèƒ½:',missing);
  return found;
};

/* =====================
   React UI
===================== */
function App(){
  const [img,setImg]=useState(null);
  const [suit,setSuit]=useState(null);
  const [p,setP]=useState({x:0,y:-20,s:0.45,r:0,f:1});
  const [s,setS]=useState({x:0,y:80,s:1,r:0,f:1});
  const [target,setTarget]=useState('PHOTO');
  const [activeSpec,setActiveSpec]=useState('A4-20');
  const [assets,setAssets]=useState([]);
  const [preview,setPreview]=useState(null);
  const canvasRef=useRef(null);
  const drag=useRef({active:false,x:0,y:0});
  useEffect(()=>{
    const ctx=canvasRef.current?.getContext('2d');
    if(ctx){ctx.fillStyle="#fff";ctx.fillRect(0,0,350,450);window.drawAt(ctx,null,{x:0,y:0,w:350,h:450},{img,suit,p,s});}
    window.assets=assets;
  },[img,suit,p,s,assets]);

  return (
    <div className="max-w-md mx-auto py-6 px-4 space-y-4">
      <h1 className="text-xl font-black italic text-blue-500">EzID <span className="text-white">v20.46 æœ€çµ‚æ¥µç‰ˆ</span></h1>
      <div className="canvas-box"
           onPointerDown={e=>{e.target.setPointerCapture(e.pointerId);drag.current={active:true,x:e.clientX,y:e.clientY};}}
           onPointerMove={e=>{if(!drag.current.active)return;const factor=1/(target==='PHOTO'?p.s:s.s);const dx=(e.clientX-drag.current.x)*factor;const dy=(e.clientY-drag.current.y)*factor;target==='PHOTO'?setP(v=>({...v,x:v.x+dx,y:v.y+dy})):setS(v=>({...v,x:v.x+dx,y:v.y+dy}));drag.current.x=e.clientX;drag.current.y=e.clientY;}}
           onPointerUp={()=>drag.current.active=false}>
        <canvas ref={canvasRef} width="350" height="450"/>
      </div>
      <div className="module-card grid grid-cols-2 gap-2">
        <button onClick={()=>setTarget('PHOTO')} className={`py-2 rounded font-bold text-xs ${target==='PHOTO'?'bg-blue-600 text-white':'bg-slate-800 text-slate-500'}`}>ğŸ‘¤ äººåƒ</button>
        <button onClick={()=>setTarget('SUIT')} className={`py-2 rounded font-bold text-xs ${target==='SUIT'?'bg-blue-600 text-white':'bg-slate-800 text-slate-500'}`}>ğŸ‘” è¥¿è£</button>
      </div>
      <div className="module-card">
        <div className="flex items-center gap-3">
          <span className="text-[10px] font-bold">ç¸®æ”¾</span>
          <input type="range" className="flex-1" min="0.1" max="1.5" step="0.01" value={target==='PHOTO'?p.s:s.s} onChange={e=>target==='PHOTO'?setP({...p,s:parseFloat(e.target.value)}):setS({...s,s:parseFloat(e.target.value)})}/>
          <button onClick={()=>target==='PHOTO'?setP({...p,f:p.f*-1}):setS({...s,f:s.f*-1})} className="bg-slate-800 px-3 py-1 rounded text-[10px] font-bold">â†”ï¸é¡åƒ</button>
        </div>
      </div>
      <div className="module-card grid grid-cols-3 gap-1 h-36 overflow-y-auto pr-1 no-scrollbar">
        {Object.keys(window.SPECS).map(k=><button key={k} onClick={()=>setActiveSpec(k)} className={`py-3 text-[9px] font-black rounded border transition-all ${activeSpec===k?'border-blue-500 bg-blue-500/20 text-blue-400':'border-white/5 bg-slate-900 text-slate-600'}`}>{window.SPECS[k].name}</button>)}
      </div>
      <div className="flex gap-2">
        <label className="flex-1 h-12 bg-slate-800 rounded-xl flex items-center justify-center text-xs font-black cursor-pointer border border-white/5">ğŸ“¸ è¼‰å…¥<input type="file" hidden onChange={e=>{const f=e.target.files[0];if(f){const i=new Image();i.onload=()=>setImg(i);i.src=URL.createObjectURL(f);}}}/></label>
        <button onClick={()=>{const t=document.createElement('canvas');t.width=50;t.height=65;window.drawAt(t.getContext('2d'),null,{x:0,y:0,w:50,h:65},{img,suit,p,s});setAssets([...assets,{id:Date.now(),img,suit,p:{...p},s:{...s},thumb:t.toDataURL()}]);}} className="flex-1 bg-slate-800 rounded-xl text-xs font-black border border-white/5">ï¼‹ å­˜å…¥</button>
        <button onClick={()=>setPreview(window.runFullExport(window.SPECS[activeSpec],assets,{img,suit,p,s}))} className="flex-1 bg-blue-600 rounded-xl text-xs font-black shadow-lg">ğŸš€ æ‹¼ç‰ˆ</button>
      </div>
      <div className="flex gap-2 overflow-x-auto no-scrollbar pb-6">
        {assets.map(as=><img key={as.id} src={as.thumb} className="w-10 h-13 rounded border border-white/10 flex-shrink-0 bg-white"/>)}
      </div>
      {preview&&(<div className="fixed inset-0 bg-slate-950/95 z-[9999] flex flex-col items-center justify-center p-6">
        <img src={preview} className="max-w-full max-h-[70vh] rounded shadow-2xl mb-6"/>
        <div className="flex gap-4 w-full max-w-xs">
          <button onClick={()=>setPreview(null)} className="flex-1 py-4 bg-white/10 rounded-2xl font-bold">è¿”å›</button>
          <a href={preview} download="EzID_Export.jpg" className="flex-1 py-4 bg-blue-600 rounded-2xl font-bold text-center">ä¸‹è¼‰ JPG</a>
        </div>
      </div>)}
      <button onClick={()=>window.checkFeatures()} className="w-full py-3 bg-green-600 rounded-xl font-bold">ğŸ” è‡ªæª¢åŠŸèƒ½</button>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
