<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v2.5.11</title>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { margin:0; font-family:sans-serif; background:#f8fafc; overflow-x:hidden; touch-action: manipulation; }
        
        /* ç•«å¸ƒé è¦½å€ */
        .canvas-container { 
            position: relative; 
            width: 350px; 
            height: 450px; 
            margin: 0 auto; 
            background: #fff; 
            border-radius: 24px; 
            border: 6px solid #fff; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            overflow: hidden;
            z-index: 10;
        }
        canvas { display: block; width: 350px; height: 450px; }

        /* é›™åœˆæ³•è¦ç·šï¼šæ ¹æ“šä¸åŒè¦ç¯„èª¿æ•´å¤§å° */
        .id-guide { 
            position: absolute; 
            inset: 0; 
            display: flex; align-items: center; justify-content: center; 
            pointer-events: none; 
            z-index: 100; 
        }
        
        /* é›™åœˆæ¨£å¼ */
        .inner-guide, .outer-guide {
            position: absolute;
            border-radius: 50% / 46%;
            transform: translateY(-6%);
            transition: all 0.3s ease;
        }
        .inner-guide { border: 2px dotted rgba(16, 185, 129, 0.7); }
        .outer-guide { border: 2px dashed rgba(245, 158, 11, 0.6); }

        /* å›ºå®šæ§åˆ¶é¢æ¿ */
        .fixed-panel {
            width: 100%;
            max-width: 400px;
            margin: 16px auto;
            background: white;
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #f1f5f9;
        }

        .control-group { margin-bottom: 12px; }
        .control-group label { display: block; font-size: 10px; font-weight: 800; color: #94a3b8; margin-bottom: 4px; text-transform: uppercase; }
        input[type=range] { width: 100%; height: 6px; background: #f1f5f9; border-radius: 10px; appearance: none; accent-color: #2563eb; }

        .slot-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 8px; }
        .slot-box { width: 65px; height: 85px; border-radius: 8px; border: 2px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.1); flex-shrink: 0; position: relative; overflow: hidden; }
        
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 10px 24px; background: #0f172a; color: white; border-radius: 50px; font-size: 13px; font-weight: bold; opacity: 0; transition: 0.3s; z-index: 2000; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="toast" class="toast"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

function App() {
    const canvasRef = useRef(null);
    const [image, setImage] = useState(null);
    const [p, setP] = useState({ x: 0, y: -20, s: 0.75 });
    const [slots, setSlots] = useState([]);
    const [preset, setPreset] = useState("id");

    // è£œå›æ©Ÿé—œè¦ç¯„æ•¸æ“š
    const PRESETS = {
        id: { label: "æˆ¶æ”¿è­‰ä»¶ (3.2-3.6cm)", min: 71, max: 80, inner: 71, outer: 80 },
        passport: { label: "å¤–äº¤éƒ¨è­·ç…§ (70-80%)", min: 70, max: 80, inner: 70, outer: 80 },
        resume: { label: "å±¥æ­·/å•†å‹™ (ç„¡è¦ç¯„)", min: 55, max: 70, inner: 55, outer: 70 }
    };

    const showToast = (msg) => {
        const t = document.getElementById("toast");
        t.textContent = msg; t.style.opacity = 1;
        setTimeout(() => { t.style.opacity = 0; }, 2000);
    };

    const ratio = Math.round(p.s * 100);
    const currentMode = PRESETS[preset];

    const draw = useCallback(() => {
        const ctx = canvasRef.current.getContext("2d");
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, 350, 450);
        if (image) {
            ctx.save();
            ctx.translate(175 + p.x, 225 + p.y);
            ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width / 2, -image.height / 2);
            ctx.restore();
        }
    }, [image, p]);

    useEffect(() => { draw(); }, [draw]);

    const saveToSlot = () => {
        if(!image) return showToast("è«‹å…ˆä¸Šå‚³ç…§ç‰‡");
        const url = canvasRef.current.toDataURL("image/jpeg", 0.95);
        setSlots([url, ...slots].slice(0, 8));
        showToast("å·²å­˜å…¥æ’ç‰ˆæ§½ä½");
    };

    const downloadFinal = async () => {
        if (slots.length === 0) return alert("æ§½ä½ç‚ºç©ºï¼");
        const pc = document.createElement("canvas"); pc.width = 1800; pc.height = 1200;
        const ctx = pc.getContext("2d"); ctx.fillStyle = "white"; ctx.fillRect(0, 0, 1800, 1200);
        const imgs = await Promise.all(slots.map(src => new Promise(res => {
            const img = new Image(); img.onload = () => res(img); img.src = src;
        })));
        for (let i = 0; i < 4; i++) ctx.drawImage(imgs[i % imgs.length], 80 + i * 428, 80, 413, 531);
        for (let i = 0; i < 5; i++) ctx.drawImage(imgs[i % imgs.length], 80 + i * 341, 650, 331, 449);
        const link = document.createElement("a"); link.download = "EzID_Final_Print.png"; link.href = pc.toDataURL("image/png"); link.click();
    };

    return (
        <div className="max-w-lg mx-auto p-4">
            <div className="flex justify-between items-center mb-4 px-2">
                <h1 className="text-xl font-black text-slate-800">EzID Taiwan <span className="text-xs font-bold text-slate-300">v2.5.11</span></h1>
                <select value={preset} onChange={e => setPreset(e.target.value)} className="text-xs font-bold bg-white border border-slate-200 rounded-lg px-2 py-1 outline-none">
                    {Object.entries(PRESETS).map(([k,v]) => <option key={k} value={k}>{v.label}</option>)}
                </select>
            </div>

            {/* 1. ç•«å¸ƒé è¦½å€ */}
            <div className="canvas-container">
                <canvas ref={canvasRef} width="350" height="450"></canvas>
                <div className="id-guide">
                    {/* é›™åœˆæ ¹æ“šä¸åŒæ©Ÿé—œè¦ç¯„é€£å‹•èª¿æ•´å¯¬é«˜ */}
                    <div className="inner-guide" style={{ width: `${currentMode.inner * 0.95}%`, height: `${currentMode.inner}%` }}></div>
                    <div className="outer-guide" style={{ width: `${currentMode.outer * 0.95}%`, height: `${currentMode.outer}%` }}></div>
                </div>
            </div>

            {/* 2. å›ºå®šæ§åˆ¶é¢æ¿ */}
            <div className="fixed-panel">
                <div className="flex justify-between items-end mb-6">
                    <div>
                        <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">ç›®å‰è¦ç¯„åˆ¤å®š</p>
                        <p className="text-xs font-black text-slate-600">{currentMode.label}</p>
                    </div>
                    <div className="text-right">
                        <span className={`text-2xl font-black ${ratio >= currentMode.min && ratio <= currentMode.max ? 'text-emerald-500' : 'text-red-400'}`}>{ratio}%</span>
                    </div>
                </div>

                <div className="control-group">
                    <label>ğŸ” äººåƒç¸®æ”¾æ¯”ä¾‹</label>
                    <input type="range" min="0.3" max="1.5" step="0.01" value={p.s} onChange={e => setP({...p, s: +e.target.value})} />
                </div>

                <div className="grid grid-cols-2 gap-4">
                    <div className="control-group">
                        <label>â†• å‚ç›´ä½ç½® (Y)</label>
                        <input type="range" min="-180" max="180" value={p.y} onChange={e => setP({...p, y: +e.target.value})} />
                    </div>
                    <div className="control-group">
                        <label>â†” æ°´å¹³ä½ç½® (X)</label>
                        <input type="range" min="-100" max="100" value={p.x} onChange={e => setP({...p, x: +e.target.value})} />
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-3 mt-4">
                    <label className="bg-slate-800 text-white py-4 rounded-2xl text-center font-bold text-xs cursor-pointer active:scale-95 transition-transform shadow-lg">
                        ğŸ“ ä¸Šå‚³ç…§ç‰‡
                        <input type="file" hidden accept="image/*" onChange={e => {
                            const f = e.target.files[0]; if(f){ const img=new Image(); img.onload=()=>setImage(img); img.src=URL.createObjectURL(f); }
                        }} />
                    </label>
                    <button onClick={saveToSlot} className="bg-blue-600 text-white py-4 rounded-2xl font-bold text-xs shadow-lg shadow-blue-100 active:scale-95 transition-transform">
                        ğŸ“¥ å­˜å…¥æ§½ä½
                    </button>
                </div>
            </div>

            {/* 3. æ’ç‰ˆæ§½ä½ */}
            <div className="px-2 mb-6">
                <div className="flex justify-between items-center mb-3">
                    <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">æ’ç‰ˆæ§½ä½ ({slots.length}/8)</span>
                    {slots.length > 0 && <button onClick={()=>setSlots([])} className="text-[10px] font-bold text-red-400">æ¸…ç©ºå…¨éƒ¨</button>}
                </div>
                <div className="slot-scroll no-scrollbar">
                    {slots.map((s, i) => (
                        <div key={i} className="slot-box group" onClick={() => setSlots(slots.filter((_, idx) => idx !== i))}>
                            <img src={s} className="w-full h-full object-cover" />
                            <div className="absolute inset-0 bg-red-500/90 opacity-0 group-hover:opacity-100 flex items-center justify-center text-[10px] text-white font-bold">ç§»é™¤</div>
                        </div>
                    ))}
                    {slots.length === 0 && <div className="w-full py-6 text-center text-[10px] text-slate-300 border-2 border-dashed border-slate-100 rounded-2xl">å°šç„¡ç…§ç‰‡</div>}
                </div>
            </div>

            <button onClick={downloadFinal} className="w-full bg-slate-900 text-white py-5 rounded-3xl font-black shadow-2xl active:scale-95 transition-transform flex items-center justify-center gap-2">
                ğŸ’¾ ä¸‹è¼‰ 4x6 å‹æ²–å°æ‹¼ç‰ˆ
            </button>
        </div>
    );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
