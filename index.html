<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzID Taiwan Pro - ç›¸æ©Ÿä¿®å¾©å¢å¼·ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.5.3/dist/bundle.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .control-panel { max-height: 85vh; overflow-y: auto; }
        input[type="range"] { accent-color: #4f46e5; height: 8px; width: 100%; }
        canvas { background-color: white; border: 1px solid #e2e8f0; }
        /* ç›¸æ©Ÿå°é ­åœ“æ¡†æ¨£å¼ */
        .camera-guide {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -60%);
            width: 180px; height: 240px;
            border: 3px dashed rgba(255, 255, 255, 0.7);
            border-radius: 50% / 50%;
            pointer-events: none;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const SPECS = {
            TWO_INCH: { id: 'TWO_INCH', label: '2å‹(8å¼µ)', mmW: 35, mmH: 45, max: 8, cols: 4, rows: 2 },
            ONE_INCH: { id: 'ONE_INCH', label: '1å‹(10å¼µ)', mmW: 28, mmH: 35, max: 10, cols: 5, rows: 2 },
            MIXED: { id: 'MIXED', label: 'æ··åˆ(2å‹*4 + 1å‹*5)', isMixed: true, max: 9 }
        };

        const EzIDApp = () => {
            const [image, setImage] = useState(null);
            const [bgRemoved, setBgRemoved] = useState(null);
            const [isRemoving, setIsRemoving] = useState(false);
            const [isCameraActive, setIsCameraActive] = useState(false);
            const [currentSpec, setCurrentSpec] = useState(SPECS.TWO_INCH);
            const [photoList, setPhotoList] = useState([]);
            
            // åº§æ¨™ç‹€æ…‹
            const [p, setP] = useState({ x: 0, y: 0, s: 0.55 });
            const [suit, setSuit] = useState({ id: null, x: 175, y: 350, s: 0.7 });
            
            const canvasRef = useRef(null);
            const videoRef = useRef(null);
            const suitImg = useRef(new Image());

            // ç¹ªåœ–æ ¸å¿ƒ
            useEffect(() => {
                const draw = () => {
                    const canvas = canvasRef.current;
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, 350, 450);
                    
                    // 1. åº•è‰²
                    ctx.fillStyle = "#FFFFFF";
                    ctx.fillRect(0, 0, 350, 450);

                    // 2. äººåƒ
                    const activeImg = bgRemoved || image;
                    if (activeImg) {
                        ctx.save();
                        ctx.translate(175 + parseInt(p.x), 225 + parseInt(p.y));
                        ctx.scale(p.s, p.s);
                        ctx.drawImage(activeImg, -activeImg.width/2, -activeImg.height/2);
                        ctx.restore();
                    }

                    // 3. è¡£æœ
                    if (suit.id) {
                        suitImg.current.src = `./suit-${suit.id}.png`;
                        if (suitImg.current.complete) {
                            ctx.save();
                            ctx.translate(parseInt(suit.x), parseInt(suit.y));
                            ctx.scale(suit.s * 2.2, suit.s * 2.2);
                            ctx.drawImage(suitImg.current, -suitImg.current.width/2, -suitImg.current.height/2);
                            ctx.restore();
                        } else {
                            suitImg.current.onload = draw;
                        }
                    }

                    // 4. å®šä½ç´…æ¡†
                    ctx.strokeStyle = "rgba(255, 0, 0, 0.4)";
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath(); ctx.moveTo(0, 80); ctx.lineTo(350, 80); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(0, 320); ctx.lineTo(350, 320); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(175, 0); ctx.lineTo(175, 450); ctx.stroke();
                    ctx.setLineDash([]);
                };
                draw();
            }, [image, bgRemoved, p, suit]);

            // å»èƒŒåŠŸèƒ½
            const runRemoveBg = async () => {
                if (!image) return;
                setIsRemoving(true);
                try {
                    const imgly = window.imglyBackgroundRemoval;
                    const blob = await imgly.removeBackground(image.src);
                    const img = new Image();
                    img.onload = () => { 
                        setBgRemoved(img); 
                        setIsRemoving(false); 
                    };
                    img.src = URL.createObjectURL(blob);
                } catch (e) {
                    console.error(e);
                    alert("å»èƒŒå¤±æ•—ï¼Œè«‹ç¢ºä¿åœ¨ä¼ºæœå™¨ç’°å¢ƒ(Live Server)åŸ·è¡Œã€‚");
                    setIsRemoving(false); // ä¿®æ­£è®Šæ•¸åéŒ¯èª¤
                }
            };

            // ç›¸æ©Ÿæ§åˆ¶
            const startCamera = async () => {
                setIsCameraActive(true);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                    if (videoRef.current) videoRef.current.srcObject = stream;
                } catch (err) {
                    alert("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿ");
                    setIsCameraActive(false);
                }
            };

            const capturePhoto = () => {
                const video = videoRef.current;
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = video.videoWidth;
                tempCanvas.height = video.videoHeight;
                tempCanvas.getContext('2d').drawImage(video, 0, 0);
                
                const img = new Image();
                img.onload = () => {
                    setImage(img);
                    setIsCameraActive(false);
                    // åœæ­¢ç›¸æ©Ÿä¸²æµ
                    video.srcObject.getTracks().forEach(track => track.stop());
                };
                img.src = tempCanvas.toDataURL('image/png');
            };

            const downloadPrint = () => {
                const link = document.createElement('a');
                link.download = 'EzID_Result.png';
                link.href = canvasRef.current.toDataURL();
                link.click();
            };

            return (
                <div className="flex flex-col lg:flex-row h-screen overflow-hidden p-4 gap-4">
                    {/* å·¦å´ï¼šé è¦½å€ */}
                    <div className="w-full lg:w-[400px] flex flex-col gap-4 bg-white p-4 rounded-3xl shadow-xl shrink-0">
                        <h1 className="font-black text-blue-800 text-xl italic px-2 border-l-4 border-blue-600">EzID Taiwan Pro</h1>
                        
                        <div className="relative">
                            <canvas ref={canvasRef} width={350} height={450} className="w-full h-auto rounded-xl shadow-inner mx-auto" />
                            {isRemoving && (
                                <div className="absolute inset-0 bg-white/80 flex flex-col items-center justify-center rounded-xl">
                                    <div className="animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent mb-2"></div>
                                    <p className="text-indigo-600 font-bold">AI å»èƒŒä¸­...</p>
                                </div>
                            )}
                        </div>
                        
                        <div className="grid grid-cols-2 gap-2">
                            <button onClick={runRemoveBg} className="bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-indigo-700 active:scale-95 transition">ä¸€éµå»èƒŒ</button>
                            <button onClick={() => setPhotoList([...photoList, canvasRef.current.toDataURL()])} className="bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-emerald-700 active:scale-95 transition">åŠ å…¥æ’ç‰ˆ</button>
                        </div>
                        
                        <div className="flex gap-2 overflow-x-auto pb-2 border-t pt-2 h-24">
                            {photoList.map((p, i) => <img key={i} src={p} className="h-full border rounded shadow-sm" />)}
                        </div>
                    </div>

                    {/* å³å´ï¼šæ§åˆ¶é¢æ¿ */}
                    <div className="flex-1 bg-white p-6 rounded-3xl shadow-xl control-panel border border-slate-300">
                        {!image && !isCameraActive ? (
                            <div className="h-full flex flex-col items-center justify-center border-4 border-dashed border-slate-100 rounded-3xl gap-6">
                                <input type="file" id="fileInput" className="hidden" onChange={(e) => {
                                    const reader = new FileReader();
                                    reader.onload = (f) => { const img = new Image(); img.onload = () => setImage(img); img.src = f.target.result; };
                                    reader.readAsDataURL(e.target.files[0]);
                                }} />
                                <label htmlFor="fileInput" className="bg-slate-800 text-white px-8 py-4 rounded-2xl cursor-pointer hover:bg-slate-700 transition">å¾é›»è…¦ä¸Šå‚³ç…§ç‰‡</label>
                                <span className="text-slate-400 font-bold">æˆ–</span>
                                <button onClick={startCamera} className="bg-blue-600 text-white px-8 py-4 rounded-2xl hover:bg-blue-500 transition">é–‹å•Ÿç›¸æ©Ÿæ‹ç…§</button>
                            </div>
                        ) : isCameraActive ? (
                            <div className="relative h-full bg-black rounded-3xl overflow-hidden flex flex-col items-center">
                                <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover" />
                                <div className="camera-guide"></div>
                                <div className="absolute bottom-6 flex gap-4">
                                    <button onClick={capturePhoto} className="bg-red-600 text-white w-16 h-16 rounded-full border-4 border-white shadow-lg"></button>
                                    <button onClick={() => setIsCameraActive(false)} className="bg-white/20 text-white px-4 py-2 rounded-xl backdrop-blur-md">å–æ¶ˆ</button>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-8 pb-10">
                                {/* è¦æ ¼ */}
                                <div className="flex justify-between items-center">
                                    <span className="text-sm font-bold text-slate-500">ç•¶å‰å°ºå¯¸</span>
                                    <div className="flex gap-1">
                                        {Object.values(SPECS).map(s => (
                                            <button key={s.id} onClick={() => setCurrentSpec(s)} className={`px-2 py-1 text-[10px] rounded-full border ${currentSpec.id === s.id ? 'bg-slate-800 text-white' : 'text-slate-400'}`}>{s.label}</button>
                                        ))}
                                    </div>
                                </div>

                                {/* äººåƒæ§åˆ¶ */}
                                <section className="p-4 bg-slate-50 rounded-2xl">
                                    <h3 className="text-xs font-black text-indigo-600 mb-4 tracking-tighter uppercase font-mono">ğŸ‘¤ äººåƒå¾®èª¿ (Slider)</h3>
                                    <div className="space-y-4">
                                        <div><label className="text-[10px] block mb-1">ç¸®æ”¾: {p.s}</label><input type="range" min="0.1" max="1.5" step="0.01" value={p.s} onChange={e => setP({...p, s: parseFloat(e.target.value)})} /></div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="text-[10px] block mb-1">å·¦å³: {p.x}</label><input type="range" min="-300" max="300" value={p.x} onChange={e => setP({...p, x: parseInt(e.target.value)})} /></div>
                                            <div><label className="text-[10px] block mb-1">ä¸Šä¸‹: {p.y}</label><input type="range" min="-300" max="300" value={p.y} onChange={e => setP({...p, y: parseInt(e.target.value)})} /></div>
                                        </div>
                                    </div>
                                </section>

                                {/* è¡£æœæ§åˆ¶ */}
                                <section className="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                                    <h3 className="text-xs font-black text-blue-600 mb-4 tracking-tighter uppercase font-mono">ğŸ‘” è¡£æœä½ç§» (å·²æ“´å¤§ç¯„åœ)</h3>
                                    <div className="space-y-4">
                                        <div><label className="text-[10px] block mb-1">è¡£æœç¸®æ”¾: {suit.s}</label><input type="range" min="0.1" max="1.5" step="0.01" value={suit.s} onChange={e => setSuit({...suit, s: parseFloat(e.target.value)})} /></div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div><label className="text-[10px] block mb-1">è¡£æœå·¦å³: {suit.x}</label><input type="range" min="0" max="350" value={suit.x} onChange={e => setSuit({...suit, x: parseInt(e.target.value)})} /></div>
                                            <div><label className="text-[10px] block mb-1">è¡£æœä¸Šä¸‹: {suit.y}</label><input type="range" min="0" max="800" value={suit.y} onChange={e => setSuit({...suit, y: parseInt(e.target.value)})} /></div>
                                        </div>
                                        <div className="flex gap-2 overflow-x-auto py-2">
                                            <button onClick={() => setSuit({...suit, id: null})} className="w-12 h-12 border border-dashed rounded-lg bg-white text-[8px] flex-shrink-0">ç§»é™¤</button>
                                            {[1,2,3,4,5].map(i => (
                                                <img key={i} src={`./suit-m${i}.png`} 
                                                     onClick={() => setSuit({...suit, id: `m${i}`})} 
                                                     onError={(e) => e.target.style.display = 'none'}
                                                     className={`w-12 h-12 border-2 rounded-lg bg-white cursor-pointer ${suit.id === `m${i}` ? 'border-blue-600 shadow-md' : 'border-transparent'}`} 
                                                />
                                            ))}
                                        </div>
                                    </div>
                                </section>

                                <div className="flex gap-2">
                                    <button onClick={() => {setImage(null); setBgRemoved(null);}} className="flex-1 bg-slate-200 text-slate-700 py-4 rounded-2xl font-bold">é‡æ–°ä¸Šå‚³/æ‹ç…§</button>
                                    {photoList.length > 0 && (
                                        <button onClick={downloadPrint} className="flex-[2] bg-slate-900 text-white py-4 rounded-2xl font-black text-lg shadow-xl active:scale-95 transition">ğŸ’¾ ä¸‹è¼‰æ’ç‰ˆ</button>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
    </script>
</body>
</html>
