<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v2.5.9</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { margin:0; font-family:sans-serif; background:#f1f5f9; overflow-x:hidden; touch-action: manipulation; }
        
        /* ç•«å¸ƒå®¹å™¨ï¼šé–å®š 350x450 æ¯”ä¾‹ */
        .canvas-container { 
            position: relative; 
            width: 350px; 
            height: 450px; 
            margin: 0 auto; 
            background: #fff; 
            border-radius: 32px; 
            border: 8px solid #fff; 
            box-shadow: 0 20px 40px rgba(0,0,0,.15); 
            overflow: hidden; 
        }
        
        canvas { display: block; width: 350px; height: 450px; }

        /* ç²¾æº–æ©¢åœ“ (å°æ‡‰ 3.2-3.6cm) èˆ‡ çœ¼ç›å°é½Šç·š */
        .id-guide { 
            position: absolute; 
            inset: 0; 
            display: flex; align-items: center; justify-content: center; 
            pointer-events: none; 
            z-index: 100; 
        }
        
        /* æ©¢åœ“ä¸»é«”ï¼šç¬¦åˆæ³•è¦é«˜åº¦æ¯”ä¾‹ */
        .id-guide::after { 
            content: ""; 
            width: 73%; /* å¯¬åº¦ 255px */
            height: 77%; /* é«˜åº¦ 346pxï¼Œç´„ç‚ºç•«å¸ƒ 4.5cm ä¸­çš„ 3.46cm */
            border: 3px dashed; 
            border-radius: 50% / 46%; 
            transform: translateY(-5%); 
            transition: border-color 0.3s ease; 
        }

        /* çœ¼ç›æ°´å¹³åƒè€ƒç·šï¼šä½æ–¼é ­éƒ¨é ‚ç«¯ç®—èµ·ç´„ 1/3 è™• */
        .id-guide::before {
            content: "";
            position: absolute;
            top: 40%; 
            width: 85%;
            height: 1px;
            border-top: 1px solid rgba(255,255,255,0.4);
            z-index: 101;
        }

        /* ç‹€æ…‹é¡è‰²åˆ‡æ› */
        .status-ok .id-guide::after { border-color: rgba(16,185,129,0.95); }
        .status-warn .id-guide::after { border-color: rgba(245,158,11,1); }
        .status-bad .id-guide::after { border-color: rgba(239,68,68,1); }

        /* æµ®å‹•å·¥å…·åˆ—ï¼šå„ªåŒ–åŠé€æ˜æ¯›ç»ç’ƒæ•ˆæœ */
        .toolbar { 
            position: absolute; 
            top: 10px; right: 10px; 
            z-index: 110; 
            background: rgba(255,255,255,0.85); 
            backdrop-filter: blur(12px); 
            border-radius: 24px; 
            padding: 14px; 
            display: flex; flex-direction: column; gap: 12px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.12); 
            border: 1px solid rgba(255,255,255,0.5);
        }
        .toolbar input[type=range] { width: 100px; accent-color: #2563eb; cursor: pointer; }

        /* ç…§ç‰‡æ§½ä½ */
        .slot-item { 
            width: 65px; height: 85px; 
            border-radius: 12px; 
            overflow: hidden; 
            border: 2px solid #fff; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
            flex-shrink: 0; 
            position: relative; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .slot-item:active { transform: scale(0.92); }
        
        /* Toast æç¤º */
        .toast { 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); 
            padding: 12px 28px; background: rgba(15,23,42,0.95); 
            color: white; border-radius: 50px; font-size: 14px; font-weight: 600; 
            opacity: 0; pointer-events: none; transition: opacity 0.3s; 
            z-index: 2000; box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
        }

        /* æ’ç‰ˆæ’ç‰ˆå‹•ç•« */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-pop { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div id="root"></div>
    <div id="toast" class="toast"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

function App() {
    const canvasRef = useRef(null);
    const [image, setImage] = useState(null);
    const [p, setP] = useState({ x: 0, y: -20, s: 0.75 });
    const [preset, setPreset] = useState("id");
    const [slots, setSlots] = useState([]);
    const [mode, setMode] = useState("guided");

    const PRESETS = {
        id: { label: "æˆ¶æ”¿è­‰ä»¶ (3.2-3.6cm)", min: 69, max: 81 },
        passport: { label: "è­·ç…§è¦ç¯„ (70-80%)", min: 70, max: 80 },
        resume: { label: "å±¥æ­·å•†å‹™ (ç„¡é™åˆ¶)", min: 55, max: 75 }
    };

    const showToast = (msg) => {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.style.opacity = 1;
        setTimeout(() => { t.style.opacity = 0; }, 2000);
    };

    const ratio = Math.round(p.s * 100);
    const status = ratio < PRESETS[preset].min - 5 || ratio > PRESETS[preset].max + 5 ? "bad" :
                   ratio < PRESETS[preset].min || ratio > PRESETS[preset].max ? "warn" : "ok";

    const draw = useCallback(() => {
        const ctx = canvasRef.current.getContext("2d");
        ctx.fillStyle = "#ffffff"; 
        ctx.fillRect(0, 0, 350, 450);
        if (image) {
            ctx.save();
            ctx.translate(175 + p.x, 225 + p.y);
            ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width / 2, -image.height / 2);
            ctx.restore();
        }
    }, [image, p]);

    useEffect(() => { draw(); }, [draw]);

    const handleSaveSlot = () => {
        const dataUrl = canvasRef.current.toDataURL("image/jpeg", 0.95);
        setSlots([dataUrl, ...slots].slice(0, 8));
        showToast("å·²å­˜å…¥ä¸‹æ–¹æ’ç‰ˆæ§½ä½");
    };

    const downloadSheet = async () => {
        if (slots.length === 0) { alert("æ§½ä½æ˜¯ç©ºçš„ï¼Œè«‹å…ˆå­˜å…¥ç…§ç‰‡ï¼"); return; }
        showToast("æ­£åœ¨æº–å‚™ 4x6 æ‹¼ç‰ˆæª”æ¡ˆ...");
        const pc = document.createElement("canvas"); pc.width = 1800; pc.height = 1200;
        const ctx = pc.getContext("2d"); ctx.fillStyle = "white"; ctx.fillRect(0, 0, 1800, 1200);
        
        const imgs = await Promise.all(slots.map(src => new Promise(res => {
            const img = new Image(); img.onload = () => res(img); img.src = src;
        })));

        // 4x6 æ‹¼ç‰ˆé…ç½®
        for (let i = 0; i < 4; i++) { ctx.drawImage(imgs[i % imgs.length], 80 + i * 428, 80, 413, 531); }
        for (let i = 0; i < 5; i++) { ctx.drawImage(imgs[i % imgs.length], 80 + i * 341, 650, 331, 449); }
        
        const link = document.createElement("a"); 
        link.download = `EzID_Result_${Date.now()}.png`; 
        link.href = pc.toDataURL("image/png"); 
        link.click();
    };

    return (
        <div className={`max-w-6xl mx-auto grid lg:grid-cols-2 gap-10 status-${status}`}>
            {/* å·¦å´ï¼šé è¦½èˆ‡æ§åˆ¶æ ¸å¿ƒ */}
            <div className="flex flex-col items-center">
                <div className="w-full flex justify-between items-center mb-3 px-2">
                    <span className="text-[11px] font-black text-slate-400 tracking-widest">EZID TAIWAN v2.5.9</span>
                    <div className="flex items-center gap-2">
                         <span className="text-[10px] text-slate-400">ç›®å‰è¦æ ¼:</span>
                         <select value={preset} onChange={e => setPreset(e.target.value)} className="text-[11px] font-bold bg-white border border-slate-200 rounded px-2 py-1 outline-none">
                            {Object.entries(PRESETS).map(([k,v]) => <option key={k} value={k}>{v.label}</option>)}
                        </select>
                    </div>
                </div>

                <div className="canvas-container animate-pop">
                    <canvas ref={canvasRef} width="350" height="450"></canvas>
                    {mode === "guided" && <div className="id-guide"></div>}
                    
                    {/* æµ®å‹•å·¥å…·é¢æ¿ */}
                    <div className="toolbar">
                        <div>
                            <p className="text-[9px] font-black text-slate-500 mb-1">ZOOM {ratio}%</p>
                            <input type="range" min="0.3" max="1.5" step="0.01" value={p.s} onChange={e => setP({ ...p, s: +e.target.value })} />
                        </div>
                        <div>
                            <p className="text-[9px] font-black text-slate-500 mb-1">OFFSET Y</p>
                            <input type="range" min="-180" max="180" value={p.y} onChange={e => setP({ ...p, y: +e.target.value })} />
                        </div>
                        <div>
                            <p className="text-[9px] font-black text-slate-500 mb-1">OFFSET X</p>
                            <input type="range" min="-100" max="100" value={p.x} onChange={e => setP({ ...p, x: +e.target.value })} />
                        </div>
                        <button onClick={handleSaveSlot} className="bg-blue-600 text-white rounded-xl text-[11px] font-bold py-2.5 shadow-lg active:scale-90 transition-transform mt-2">ğŸ“¥ å­˜å…¥æ’ç‰ˆæ§½</button>
                        <button onClick={() => setMode(mode === "guided" ? "studio" : "guided")} className="bg-slate-900 text-white rounded-xl text-[11px] font-bold py-2 shadow-md active:scale-95">
                            {mode === "guided" ? "ğŸ¨ å°ˆæ¥­æ¨¡å¼" : "ğŸ§­ å¼•å°æ¨¡å¼"}
                        </button>
                    </div>
                </div>

                {/* ç‹€æ…‹åˆ— */}
                <div className="w-full mt-5 bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100 flex justify-between items-center">
                    <div className="flex flex-col">
                        <span className="text-[10px] text-slate-400 font-bold uppercase tracking-tight">Head Ratio</span>
                        <span className="text-2xl font-black text-slate-800">{ratio}%</span>
                    </div>
                    <div className={`px-5 py-2 rounded-full font-black text-[12px] shadow-sm transition-colors ${
                        status === "ok" ? "bg-emerald-500 text-white" : 
                        status === "warn" ? "bg-amber-400 text-slate-900" : "bg-red-500 text-white"
                    }`}>
                        {status === "ok" ? "âœ“ ç¬¦åˆæ¨™æº–" : status === "warn" ? "âš  æ¯”ä¾‹å¾®å" : "âœ• æ¯”ä¾‹éŒ¯èª¤"}
                    </div>
                </div>
            </div>

            {/* å³å´ï¼šåŠŸèƒ½æ“ä½œå€ */}
            <div className="flex flex-col gap-6">
                <div className="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 space-y-6">
                    <label className="flex flex-col items-center justify-center border-3 border-dashed border-slate-100 rounded-[1.5rem] p-10 hover:border-blue-400 hover:bg-blue-50/50 cursor-pointer transition-all group">
                        <div className="text-4xl mb-3 group-hover:scale-110 transition-transform">ğŸ“¸</div>
                        <span className="text-sm font-bold text-slate-600">ä¸Šå‚³æ‚¨çš„åŸå§‹ç…§ç‰‡</span>
                        <p className="text-[10px] text-slate-400 mt-2">æ”¯æ´ JPG, PNG, HEIC</p>
                        <input type="file" hidden accept="image/*" onChange={e => {
                            const f = e.target.files[0]; if (f) { const img = new Image(); img.onload = () => setImage(img); img.src = URL.createObjectURL(f); showToast("ç…§ç‰‡è¼‰å…¥æˆåŠŸï¼"); }
                        }} />
                    </label>

                    <div>
                        <div className="flex justify-between items-center mb-4">
                            <span className="text-[11px] font-black text-slate-400 uppercase tracking-widest">æ’ç‰ˆæš«å­˜æ§½ ({slots.length}/8)</span>
                            {slots.length > 0 && <button onClick={() => setSlots([])} className="text-[10px] font-bold text-red-400 hover:text-red-600">æ¸…ç©ºå…¨éƒ¨</button>}
                        </div>
                        <div className="flex gap-4 overflow-x-auto pb-4 min-h-[110px] items-center no-scrollbar">
                            {slots.map((src, i) => (
                                <div key={i} className="slot-item group animate-pop">
                                    <img src={src} className="w-full h-full object-cover" />
                                    <div onClick={() => setSlots(slots.filter((_, idx) => idx !== i))} className="absolute inset-0 bg-red-600/90 text-white text-[10px] font-bold opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition-opacity">
                                        ç§»é™¤
                                    </div>
                                </div>
                            ))}
                            {slots.length === 0 && <div className="text-[11px] text-slate-300 w-full text-center py-6 border-2 border-dashed border-slate-50 rounded-2xl italic">å°šç„¡ç…§ç‰‡ï¼Œèª¿æ•´å®Œç•¢å¾Œè«‹é»æ“Šã€Œå­˜å…¥æ’ç‰ˆæ§½ã€</div>}
                        </div>
                    </div>
                </div>

                <div className="space-y-4">
                    <button onClick={downloadSheet} className="w-full bg-slate-900 text-white py-6 rounded-[1.5rem] font-black text-lg shadow-2xl hover:bg-slate-800 active:scale-[0.98] transition-all flex items-center justify-center gap-3">
                        <span>ğŸ’¾ ä¸‹è¼‰ 4x6 å‹æ²–å°æ‹¼ç‰ˆ</span>
                    </button>
                    
                    <div className="bg-slate-800 p-5 rounded-[1.5rem] text-slate-300">
                        <p className="text-[11px] leading-relaxed">
                            <b className="text-white block mb-1">ğŸ’¡ æ“ä½œæŒ‡å—ï¼š</b>
                            1. ç¢ºä¿é ­éƒ¨é ‚ç«¯èˆ‡ä¸‹å·´è½åœ¨<b>æ©¢åœ“è™›ç·š</b>å…§ã€‚<br/>
                            2. å»ºè­°è®“<b>çœ¼ç›ä½ç½®</b>å°æº–ç™½è‰²çš„æ°´å¹³åƒè€ƒç·šã€‚<br/>
                            3. å­˜å…¥è‡³å°‘ä¸€å¼µç…§ç‰‡å¾Œå³å¯ä¸‹è¼‰ 4x6 (10x15cm) æ‹¼ç‰ˆã€‚
                        </p>
                    </div>
                </div>
            </div>
        </div>
    );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>

<script>
// PWA æ›´æ–°åµæ¸¬
if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").then(reg => {
            console.log("Service Worker è¨»å†ŠæˆåŠŸ");
        });
    });
}
</script>
</body>
</html>
