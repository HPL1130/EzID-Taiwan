<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v2.5.4</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { margin:0; font-family:sans-serif; background:#f1f5f9; overflow-x:hidden; touch-action: manipulation; }
        
        /* ç•«å¸ƒå®¹å™¨ï¼šä¿®æ­£æ‰‹æ©Ÿç‰ˆå®šä½æ¶ˆå¤±çš„å•é¡Œ */
        .canvas-container { 
            position: relative; 
            width: 350px; 
            height: 450px; 
            margin: 0 auto; 
            background: #fff; 
            border-radius: 32px; 
            border: 8px solid #fff; 
            box-shadow: 0 20px 40px rgba(0,0,0,.1); 
            overflow: hidden; 
        }
        
        canvas { display: block; width: 350px; height: 450px; }

        /* å¼·åŒ–å¼•å°ç·šï¼šç¢ºä¿ z-index æœ€é«˜ä¸”å¼·åˆ¶å±…ä¸­ */
        .id-guide { 
            position: absolute; 
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center; 
            pointer-events: none; 
            z-index: 100; 
        }
        .id-guide::after { 
            content: ""; 
            width: 220px; height: 220px; 
            border: 3px dashed; 
            border-radius: 50%; 
            transform: translateY(-5%); 
            transition: border-color .3s; 
        }

        .status-ok .id-guide::after { border-color: rgba(16,185,129,.8); }
        .status-warn .id-guide::after { border-color: rgba(245,158,11,.9); }
        .status-bad .id-guide::after { border-color: rgba(239,68,68,1); }

        /* æµ®å‹•å·¥å…·åˆ—ï¼šå„ªåŒ–æ‰‹æ©Ÿè§¸æ§ */
        .toolbar { 
            position: absolute; 
            top: 10px; right: 10px; 
            z-index: 110; 
            background: rgba(255,255,255,.85); 
            backdrop-filter: blur(8px); 
            border-radius: 20px; 
            padding: 12px; 
            display: flex; flex-direction: column; gap: 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,.15); 
            border: 1px solid rgba(255,255,255,0.5);
        }
        .toolbar input[type=range] { width: 100px; accent-color: #2563eb; }

        .slot-item { width: 60px; height: 80px; border-radius: 8px; overflow: hidden; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,.1); flex-shrink: 0; position: relative; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 8px 20px; background: rgba(15,23,42,.9); color: white; border-radius: 50px; font-size: 12px; opacity: 0; pointer-events: none; transition: opacity .3s; z-index: 2000; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="root"></div>
    <div id="toast" class="toast"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

function App() {
    const canvasRef = useRef(null);
    const [image, setImage] = useState(null);
    const [p, setP] = useState({ x: 0, y: -20, s: 0.75 });
    const [preset, setPreset] = useState("id");
    const [slots, setSlots] = useState([]);
    const [mode, setMode] = useState("guided");

    const PRESETS = {
        id: { label: "æˆ¶æ”¿è­‰ä»¶", min: 65, max: 85 },
        passport: { label: "è­·ç…§è¦ç¯„", min: 70, max: 80 },
        resume: { label: "å±¥æ­·/å•†å‹™", min: 60, max: 75 }
    };

    const showToast = (msg) => {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.style.opacity = 1;
        setTimeout(() => { t.style.opacity = 0; }, 1500);
    };

    const ratio = Math.round(p.s * 100);
    const status = ratio < PRESETS[preset].min - 5 || ratio > PRESETS[preset].max + 5 ? "bad" :
                   ratio < PRESETS[preset].min || ratio > PRESETS[preset].max ? "warn" : "ok";

    const draw = useCallback(() => {
        const ctx = canvasRef.current.getContext("2d");
        ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, 350, 450);
        if (image) {
            ctx.save();
            ctx.translate(175 + p.x, 225 + p.y);
            ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width / 2, -image.height / 2);
            ctx.restore();
        }
    }, [image, p]);

    useEffect(() => { draw(); }, [draw]);

    const downloadSheet = async () => {
        if (slots.length === 0) { alert("è«‹å…ˆå­˜å…¥ç…§ç‰‡"); return; }
        const pc = document.createElement("canvas"); pc.width = 1800; pc.height = 1200;
        const ctx = pc.getContext("2d"); ctx.fillStyle = "white"; ctx.fillRect(0, 0, 1800, 1200);
        const imgs = await Promise.all(slots.map(src => new Promise(res => {
            const img = new Image(); img.onload = () => res(img); img.src = src;
        })));
        ctx.strokeStyle = "#eee"; ctx.lineWidth = 1;
        for (let i = 0; i < 4; i++) { ctx.drawImage(imgs[i % imgs.length], 80 + i * 428, 80, 413, 531); ctx.strokeRect(80 + i * 428, 80, 413, 531); }
        for (let i = 0; i < 5; i++) { ctx.drawImage(imgs[i % imgs.length], 80 + i * 341, 650, 331, 449); ctx.strokeRect(80 + i * 341, 650, 331, 449); }
        const link = document.createElement("a"); link.download = "EzID_PrintSheet.png"; link.href = pc.toDataURL("image/png"); link.click();
    };

    return (
        <div className={`max-w-5xl mx-auto grid md:grid-cols-2 gap-8 status-${status}`}>
            <div className="relative">
                <div className="flex justify-between items-center mb-2 px-1">
                    <span className="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">EzID Taiwan v2.5.4</span>
                    <div className="flex gap-2">
                        <select value={preset} onChange={e => setPreset(e.target.value)} className="text-[10px] border rounded px-1 py-0.5 bg-white">
                            {Object.entries(PRESETS).map(([k,v]) => <option key={k} value={k}>{v.label}</option>)}
                        </select>
                    </div>
                </div>

                <div className="canvas-container">
                    <canvas ref={canvasRef} width="350" height="450"></canvas>
                    {mode === "guided" && <div className="id-guide"></div>}
                    
                    {/* Floating Toolbar */}
                    <div className="toolbar">
                        <div className="flex flex-col">
                            <span className="text-[9px] font-black text-slate-400 uppercase">Size</span>
                            <input type="range" min="0.3" max="1.5" step="0.01" value={p.s} onChange={e => setP({ ...p, s: +e.target.value })} />
                        </div>
                        <div className="flex flex-col">
                            <span className="text-[9px] font-black text-slate-400 uppercase">Pos Y</span>
                            <input type="range" min="-150" max="150" value={p.y} onChange={e => setP({ ...p, y: +e.target.value })} />
                        </div>
                        <button onClick={() => { setSlots([canvasRef.current.toDataURL("image/jpeg", 0.9), ...slots].slice(0, 8)); showToast("å·²å­˜å…¥æ’ç‰ˆæ§½"); }} className="bg-blue-600 text-white rounded-lg text-[10px] font-bold py-1.5 active:scale-95 transition-transform">ğŸ“¥ å­˜å…¥</button>
                        <button onClick={() => setMode(mode === "guided" ? "studio" : "guided")} className="bg-slate-900 text-white rounded-lg text-[10px] font-bold py-1.5 active:scale-95 transition-transform">
                            {mode === "guided" ? "ğŸ¨ å°ˆæ¥­" : "ğŸ§­ å»ºè­°"}
                        </button>
                    </div>
                </div>

                <div className="mt-4 bg-white p-4 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-center">
                    <span className="text-xs font-bold text-slate-500 uppercase">é ­éƒ¨æ¯”ä¾‹ <b className="text-lg text-slate-900 ml-1">{ratio}%</b></span>
                    <span className={`text-[10px] font-bold px-3 py-1 rounded-full ${status === "ok" ? "bg-emerald-100 text-emerald-700" : status === "warn" ? "bg-amber-100 text-amber-700" : "bg-red-100 text-red-700"}`}>
                        {status === "ok" ? "ğŸŸ¢ ç¬¦åˆè¦ç¯„" : status === "warn" ? "ğŸŸ¡ æ¥è¿‘é‚Šç•Œ" : "ğŸ”´ æ˜é¡¯åé›¢"}
                    </span>
                </div>
            </div>

            <div className="flex flex-col gap-6">
                <div className="bg-white p-5 rounded-3xl shadow-sm border border-slate-100">
                    <label className="flex flex-col items-center justify-center border-2 border-dashed border-slate-200 rounded-2xl p-6 hover:bg-slate-50 cursor-pointer text-sm font-bold transition-colors">
                        ğŸ“ ä¸Šå‚³ç…§ç‰‡
                        <input type="file" hidden onChange={e => {
                            const f = e.target.files[0]; if (f) { const img = new Image(); img.onload = () => setImage(img); img.src = URL.createObjectURL(f); }
                        }} />
                    </label>

                    <div className="mt-6">
                        <div className="text-[10px] font-black text-slate-400 mb-3 uppercase tracking-widest">æ’ç‰ˆæš«å­˜æ§½ ({slots.length}/8)</div>
                        <div className="flex gap-2 overflow-x-auto pb-2 min-h-[90px] items-center">
                            {slots.map((src, i) => (
                                <div key={i} className="slot-item group">
                                    <img src={src} className="w-full h-full object-cover" />
                                    <button onClick={() => { setSlots(slots.filter((_, idx) => idx !== i)); showToast("å·²ç§»é™¤"); }} className="absolute inset-0 bg-red-500/80 text-white text-[10px] font-bold opacity-0 group-hover:opacity-100 transition-opacity">ç§»é™¤</button>
                                </div>
                            ))}
                            {slots.length === 0 && <div className="text-[10px] text-slate-300 italic ml-1 text-center w-full">å°šæœªå­˜å…¥ä»»ä½•ç…§ç‰‡</div>}
                        </div>
                    </div>
                </div>

                <button onClick={downloadSheet} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-black shadow-xl hover:bg-slate-800 transition-all active:scale-[0.98]">
                    ğŸ’¾ ä¸‹è¼‰ 4x6 å‹æ‹¼ç‰ˆç…§ç‰‡
                </button>
                <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                    <p className="text-[10px] text-slate-400 leading-relaxed text-center italic">
                        â€» æœ¬å·¥å…·åƒ…æä¾›ç·¨è¼¯è¼”åŠ©ï¼Œä¸ä¿è­‰å¯©æ ¸é€šéã€‚<br/>
                        æ‰€æœ‰å½±åƒè™•ç†çš†åœ¨ç€è¦½å™¨ç«¯å®Œæˆï¼Œä¸æœƒä¸Šå‚³è‡³ä¼ºæœå™¨ã€‚
                    </p>
                </div>
            </div>
        </div>
    );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>

<script>
// PWA Service Worker è¨»å†Š
if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js");
    });
}
</script>
</body>
</html>
