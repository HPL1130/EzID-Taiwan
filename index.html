<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EzID Taiwan - 證件照去背 + 排版</title>

<!-- React -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Imgly 去背 UMD (可在瀏覽器直接使用) -->
<script src="https://cdn.jsdelivr.net/npm/@imgly/background-removal/dist/browser.umd.js"></script>

<style>
body { background: #121212; color: white; }
canvas { background: white; border-radius: 12px; }
.guide-overlay {
  position: absolute; top:50%; left:50%;
  width:55%; height:55%;
  transform: translate(-50%, -55%);
  border: 2px dashed rgba(255,68,68,0.6);
  border-radius: 50%;
}
</style>
</head>
<body class="p-4">

<div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect } = React;

const EzIDApp = () => {
  const [img, setImg] = useState(null);
  const [isCam, setIsCam] = useState(false);
  const [mode, setMode] = useState('MIXED');
  const [pos, setPos] = useState({x:0,y:0,s:0.6});
  const [suit, setSuit] = useState({id:null,x:175,y:340,s:0.4});

  const canvasRef = useRef(null);
  const videoRef = useRef(null);
  const suitRef = useRef(new Image());

  useEffect(() => {
    const cv = canvasRef.current;
    if (!cv) return;
    const ctx = cv.getContext('2d');
    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,350,450);

    if (img) {
      ctx.save();
      ctx.translate(175+pos.x,225+pos.y);
      ctx.scale(pos.s,pos.s);
      ctx.drawImage(img,-img.width/2,-img.height/2);
      ctx.restore();
    }

    if (suit.id) {
      suitRef.current.src = `./clothes/suit-${suit.id}.png`;
      if (suitRef.current.complete) {
        ctx.save();
        ctx.translate(suit.x,suit.y);
        ctx.scale(suit.s*1.5,suit.s*1.5);
        ctx.drawImage(suitRef.current,-suitRef.current.width/2,-suitRef.current.height/2);
        ctx.restore();
      }
    }
  },[img,pos,suit]);

  const startCam = async () => {
    setIsCam(true);
    try {
      const st = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
      videoRef.current.srcObject = st;
    } catch {
      alert('無法開啟相機');
      setIsCam(false);
    }
  };

  const snap = () => {
    const tc = document.createElement('canvas');
    tc.width = videoRef.current.videoWidth;
    tc.height = videoRef.current.videoHeight;
    const tctx = tc.getContext('2d');
    tctx.translate(tc.width,0); tctx.scale(-1,1);
    tctx.drawImage(videoRef.current,0,0);
    const im = new Image();
    im.onload = ()=>{ setImg(im); setIsCam(false); };
    im.src = tc.toDataURL();
    videoRef.current.srcObject.getTracks().forEach(t=>t.stop());
  };

  const uploadFile = (e) => {
    const f = e.target.files[0];
    if (!f) return;
    if (!f.type.startsWith('image')) { alert('請選圖片'); return; }
    const r = new FileReader();
    r.onload = (ev) => {
      const im = new Image();
      im.onload = ()=>setImg(im);
      im.src = ev.target.result;
    };
    r.readAsDataURL(f);
  };

  const doRemoveBg = async () => {
    if (!img) return alert("請先上傳或拍照");
    alert("AI 去背中…請稍候 6–12 秒");

    const blob = await fetch(img.src).then(r=>r.blob());
    const file = new File([blob],'photo.png',{type:'image/png'});

    const result = await window.bgRemoval.removeBackground({image:file});
    const out = new Image();
    out.onload = ()=>setImg(out);
    out.src = result;
  };

  const downloadSheet = () => {
    const pc = document.createElement('canvas');
    pc.width=1800; pc.height=1200;
    const ctx = pc.getContext('2d');
    ctx.fillStyle='#fff';ctx.fillRect(0,0,1800,1200);

    if (mode==='MIXED') {
      for(let i=0;i<4;i++) ctx.drawImage(canvasRef.current,0,0,350,450,80+i*425,80,413,531);
      for(let i=0;i<5;i++) ctx.drawImage(canvasRef.current,0,0,350,450,80+i*340,650,331,449);
    } else if(mode==='TWO') {
      for(let i=0;i<8;i++) ctx.drawImage(canvasRef.current,0,0,350,450,100+(i%4)*410,80+540*Math.floor(i/4),413,531);
    } else {
      for(let i=0;i<10;i++) ctx.drawImage(canvasRef.current,0,0,350,450,80+(i%5)*340,100+460*Math.floor(i/5),331,449);
    }

    const a = document.createElement('a');
    a.download='EzID_print.png';
    a.href=pc.toDataURL();
    a.click();
  };

  return (
    <div className="space-y-6">
      <div className="max-w-sm mx-auto">
        {isCam ? (
          <video ref={videoRef} autoPlay className="w-full rounded-2xl scale-x-[-1]"/>
        ) : (
          <canvas ref={canvasRef} width={350} height={450} className="w-full rounded-xl shadow-xl"/>
        )}
      </div>

      {isCam ? (
        <button onClick={snap} className="w-full bg-red-600 text-white py-3 rounded-xl">拍照</button>
      ) : (
        <>
          <div className="grid gap-3">
            <button onClick={startCam} className="bg-blue-600 text-white py-3 rounded-xl">啟動相機</button>
            <label className="bg-gray-600 text-white py-3 rounded-xl text-center cursor-pointer">
              上傳照片
              <input type="file" className="hidden" onChange={uploadFile}/>
            </label>
            <button onClick={doRemoveBg} className="bg-purple-600 text-white py-3 rounded-xl">去背</button>
            <button onClick={downloadSheet} className="bg-green-600 text-white py-3 rounded-xl">下載 4x6</button>
          </div>

          {/* 衣服選擇 */}
          <div className="flex gap-3 overflow-x-auto py-3">
            {['m1','m2','m3','m4','m5'].map(n=>(
              <img key={n} src={`./clothes/suit-${n}.png`} onClick={()=>setSuit({...suit,id:n})}
                className="w-16 h-16 cursor-pointer border"/>
            ))}
            <button onClick={()=>setSuit({...suit,id:null})} className="px-3 py-2 border-dashed border">清除</button>
          </div>
        </>
      )}
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
</script>
</body>
</html>
