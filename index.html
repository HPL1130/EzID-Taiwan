<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.12 å°ç£è­‰ç…§éœ¸ä¸»</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .canvas-shadow { box-shadow: 0 20px 50px -12px rgba(0,0,0,0.3); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .loading-shimmer {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%; animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-[#f0f2f5] min-h-screen pb-20">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback, useTransition } = React;

// âœ… 12ç¨®å°ç£è­‰ç…§å…¨è¦æ ¼
const PRINT_SPECS = {
    // A4è¦æ ¼ (2480x3508px, 300dpi)
    'A4-20': { w: 2480, h: 3508, photos: 20, grid: [5, 4], size: [413, 531], name: 'A4-2å‹(20å¼µ)' },
    'A4-42': { w: 2480, h: 3508, photos: 42, grid: [7, 6], size: [295, 413], name: 'A4-1å‹(42å¼µ)' },
    'A4-MIX': { w: 2480, h: 3508, type: 'MIX', name: 'A4-MIX(12+18å¼µ)' },
    'A4-BIG': { w: 2480, h: 3508, photos: 8, grid: [2, 4], size: [500, 650], name: 'A4-å¤§é ­è²¼(8å¼µ)' },
    
    // 4x6è¦æ ¼ (1800x1200px)
    '4x6-8':  { w: 1800, h: 1200, photos: 8,  grid: [2, 4], size: [413, 531], name: '4x6-2å‹(8å¼µ)' },
    '4x6-10': { w: 1800, h: 1200, photos: 10, grid: [2, 5], size: [295, 413], name: '4x6-1å‹(10å¼µ)' },
    '4x6-MIX': { w: 1800, h: 1200, type: 'MIX', name: '4x6-MIX(4+5å¼µ)' },
    '4x6-MINI': { w: 1800, h: 1200, photos: 16, grid: [4, 4], size: [220, 300], name: '4x6-è¿·ä½ (16å¼µ)' },
    
    // ä¼æ¥­ç‰¹æ®Šè¦æ ¼
    'LOGO': { w: 2480, h: 3508, photos: 16, grid: [4, 4], size: [413, 531], special: 'LOGO', name: 'ä¼æ¥­LOGOç‰ˆ' },
    'NAME': { w: 2480, h: 3508, photos: 24, grid: [6, 4], size: [295, 413], special: 'NAME', name: 'å§“åå·¥ç‰Œç‰ˆ' },
    '3x4': { w: 1240, h: 1754, photos: 12, grid: [3, 4], size: [413, 531], name: '3x4ç›¸ç°¿ç‰ˆ' },
    'CUSTOM': { w: 2480, h: 3508, photos: 20, grid: [5, 4], size: [413, 531], name: 'å®¢è£½è‡ªå‹•ç‰ˆ' }
};

function App() {
    const [isPending, startTransition] = useTransition();
    const [image, setImage] = useState(null);
    const [transform, setTransform] = useState({ x: 0, y: -20, s: 0.45, r: 0 });
    const [slots, setSlots] = useState([]);
    const [progress, setProgress] = useState(0);
    const [preview, setPreview] = useState(null);
    
    const canvasRef = useRef(null);
    const dragRef = useRef({ active: false, x: 0, y: 0 });

    // âœ… ä½ çš„å¤©æ‰é«˜æ¸…å¼•æ“ï¼ˆå‡ç´š12ç¨®è¦æ ¼ï¼‰
    const drawHighResItem = (ctx, img, slotState, x, y, pw, ph) => {
        ctx.save();
        const { x: tx, y: ty, s, r } = slotState;
        const ratio = pw / 350; 
        
        ctx.translate(x + pw / 2, y + ph / 2);
        ctx.rotate(r * Math.PI / 180);
        ctx.scale(s * ratio, s * ratio);
        ctx.drawImage(img, -img.width / 2 + (tx / s), -img.height / 2 + (ty / s));
        ctx.restore();
    };

    // âœ… 12ç¨®è¦æ ¼è¶…å¼·ç”Ÿç”¢å¼•æ“
    const handleExport = (specKey) => {
        if (!image) return alert("è«‹å…ˆä¸Šå‚³ç…§ç‰‡");
        const spec = PRINT_SPECS[specKey];
        
        startTransition(async () => {
            const canvas = document.createElement('canvas');
            canvas.width = spec.w; canvas.height = spec.h;
            const ctx = canvas.getContext('2d', { alpha: false });
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, spec.w, spec.h);

            if (spec.type === 'MIX') {
                // MIXç‰¹æ®Šè™•ç†ï¼šä¸ŠåŠ2å‹(12å¼µ)ï¼Œä¸‹åŠ1å‹(18å¼µ)
                const mix2inch = { size: [413, 531], photos: 12, grid: [3, 4] };
                const mix1inch = { size: [295, 413], photos: 18, grid: [3, 6] };
                
                // ä¸ŠåŠéƒ¨2å‹
                const [r2, c2] = mix2inch.grid; const [pw2, ph2] = mix2inch.size;
                const mx2 = (spec.w - c2 * pw2) / (c2 + 1); const my2 = (spec.h * 0.4 - r2 * ph2) / (r2 + 1);
                for (let i = 0; i < 12; i++) {
                    const row = Math.floor(i / c2); const col = i % c2;
                    const x = mx2 + col * (pw2 + mx2); const y = my2 + row * (ph2 + my2);
                    const state = slots[i]?.state || transform;
                    drawHighResItem(ctx, image, state, x, y, pw2, ph2);
                    ctx.strokeStyle = "#dddddd"; ctx.lineWidth = 2; ctx.strokeRect(x, y, pw2, ph2);
                }
                
                // ä¸‹åŠéƒ¨1å‹
                const [r1, c1] = mix1inch.grid; const [pw1, ph1] = mix1inch.size;
                const mx1 = (spec.w - c1 * pw1) / (c1 + 1); const my1 = (spec.h * 0.6 - r1 * ph1) / (r1 + 1);
                for (let i = 0; i < 18; i++) {
                    const row = Math.floor(i / c1); const col = i % c1;
                    const x = mx1 + col * (pw1 + mx1); const y = spec.h * 0.45 + my1 + row * (ph1 + my1);
                    const state = slots[12 + i]?.state || transform;
                    drawHighResItem(ctx, image, state, x, y, pw1, ph1);
                    ctx.strokeStyle = "#dddddd"; ctx.lineWidth = 2; ctx.strokeRect(x, y, pw1, ph1);
                }
            } else if (spec.special === 'LOGO') {
                // ä¼æ¥­LOGOç‰ˆï¼š16å¼µ+ç½®ä¸­LOGO
                const [rows, cols] = spec.grid; const [pw, ph] = spec.size;
                const marginX = (spec.w - cols * pw) / (cols + 1);
                const marginY = (spec.h * 0.7 - rows * ph) / (rows + 1);
                
                for (let i = 0; i < 16; i++) {
                    const row = Math.floor(i / cols); const col = i % cols;
                    const x = marginX + col * (pw + marginX);
                    const y = marginY + row * (ph + marginY) + 100;
                    const state = slots[i]?.state || transform;
                    drawHighResItem(ctx, image, state, x, y, pw, ph);
                    ctx.strokeStyle = "#dddddd"; ctx.lineWidth = 2; ctx.strokeRect(x, y, pw, ph);
                }
                
                // LOGOå€åŸŸ
                const logoW = spec.w * 0.4; const logoH = spec.h * 0.08;
                const logoX = (spec.w - logoW) / 2; const logoY = 50;
                ctx.fillStyle = "#f8fafc"; ctx.fillRect(logoX, logoY, logoW, logoH);
                ctx.fillStyle = "#1e293b"; ctx.font = `bold 120px system-ui`; ctx.textAlign = 'center';
                ctx.textBaseline = 'middle'; ctx.fillText('å…¬å¸LOGO', spec.w / 2, logoY + logoH / 2);
            } else if (spec.special === 'NAME') {
                // å§“åå·¥ç‰Œç‰ˆï¼š24å¼µ+å§“åæ¢
                const [rows, cols] = spec.grid; const [pw, ph] = spec.size;
                const marginX = (spec.w - cols * pw) / (cols + 1);
                const marginY = (spec.h - rows * ph) / (rows + 1);
                
                for (let i = 0; i < 24; i++) {
                    const row = Math.floor(i / rows); const col = i % cols;
                    const x = marginX + col * (pw + marginX);
                    const y = marginY + row * (ph + marginY);
                    const state = slots[i]?.state || transform;
                    drawHighResItem(ctx, image, state, x, y, pw, ph);
                    
                    // å§“åæ¢
                    ctx.fillStyle = "#f1f5f9"; ctx.fillRect(x, y + ph + 10, pw, 35);
                    ctx.fillStyle = "#1e293b"; ctx.font = `bold 28px system-ui`; ctx.textAlign = 'center';
                    ctx.fillText(`å“¡å·¥${i+1}`, x + pw / 2, y + ph + 28);
                    
                    ctx.strokeStyle = "#dddddd"; ctx.lineWidth = 2; ctx.strokeRect(x, y, pw, ph + 45);
                }
            } else {
                // æ¨™æº–ç¶²æ ¼
                const [rows, cols] = spec.grid || [4, 5];
                const [pw, ph] = spec.size;
                const marginX = (spec.w - cols * pw) / (cols + 1);
                const marginY = (spec.h - rows * ph) / (rows + 1);
                
                for (let i = 0; i < spec.photos; i++) {
                    const row = Math.floor(i / cols); const col = i % cols;
                    const x = marginX + col * (pw + marginX);
                    const y = marginY + row * (ph + marginY);
                    const state = slots[i]?.state || transform;
                    drawHighResItem(ctx, image, state, x, y, pw, ph);
                    ctx.strokeStyle = "#dddddd"; ctx.lineWidth = 2; ctx.strokeRect(x, y, pw, ph);
                    
                    setProgress(Math.round(((i + 1) / spec.photos) * 100));
                    await new Promise(r => requestAnimationFrame(r));
                }
            }
            
            setPreview(canvas.toDataURL('image/png', 0.97));
            setProgress(0);
        });
    };

    // ğŸ¨ å³æ™‚é è¦½ï¼ˆä½ çš„å¤©æ‰é‚è¼¯ï¼‰
    useEffect(() => {
        const ctx = canvasRef.current?.getContext('2d');
        if (!ctx || !image) return;
        ctx.clearRect(0, 0, 350, 450);
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, 350, 450);
        
        ctx.save();
        ctx.translate(175 + transform.x, 225 + transform.y);
        ctx.rotate(transform.r * Math.PI / 180);
        ctx.scale(transform.s, transform.s);
        ctx.drawImage(image, -image.width / 2, -image.height / 2);
        ctx.restore();
    }, [image, transform]);

    return (
        <div className="max-w-md mx-auto p-4 space-y-6">
            <header className="text-center pt-6">
                <h1 className="text-3xl font-black text-slate-800 tracking-tight">EzID <span className="text-blue-600">v20.12</span></h1>
                <p className="text-slate-500 font-medium">å°ç£è­‰ç…§éœ¸ä¸» â€¢ 12ç¨®å…¨è¦æ ¼</p>
            </header>

            {/* ä¸»ç·¨è¼¯å€ï¼ˆä½ çš„å®Œç¾æ‹–æ‹½ï¼‰ */}
            <div className="relative flex justify-center">
                <canvas 
                    ref={canvasRef} width="350" height="450" 
                    className="canvas-shadow rounded-[2rem] bg-white touch-none border-4 border-slate-200/50"
                    onPointerDown={e => {
                        e.target.setPointerCapture(e.pointerId);
                        dragRef.current = { active: true, x: e.clientX, y: e.clientY };
                    }}
                    onPointerMove={e => {
                        if (!dragRef.current.active) return;
                        const dx = e.clientX - dragRef.current.x;
                        const dy = e.clientY - dragRef.current.y;
                        setTransform(t => ({ 
                            ...t, 
                            x: Math.max(-175, Math.min(175, t.x + dx * 0.8)), 
                            y: Math.max(-125, Math.min(225, t.y + dy * 0.8))
                        }));
                        dragRef.current.x = e.clientX;
                        dragRef.current.y = e.clientY;
                    }}
                    onPointerUp={() => dragRef.current.active = false}
                />
            </div>

            {/* æ§åˆ¶å°ï¼ˆä½ çš„ç°¡æ½”å®Œç¾ï¼‰ */}
            <section className="bg-white/90 backdrop-blur-sm rounded-3xl p-6 shadow-sm space-y-4 border">
                <div className="space-y-3">
                    <div className="flex justify-between text-sm font-bold text-slate-600">
                        <span>ğŸ” ç¸®æ”¾</span><span>{transform.s.toFixed(2)}x</span>
                    </div>
                    <input type="range" min="0.2" max="1.2" step="0.01" value={transform.s} 
                        onChange={e => setTransform(t => ({ ...t, s: parseFloat(e.target.value) }))}
                        className="w-full h-2 bg-slate-200 rounded-lg accent-blue-600" />
                </div>
                <div className="flex justify-between text-sm font-bold text-slate-600">
                    <span>â†» æ—‹è½‰</span><span>{transform.r}Â°</span>
                </div>
                <input type="range" min="-30" max="30" step="1" value={transform.r} 
                    onChange={e => setTransform(t => ({ ...t, r: parseInt(e.target.value) }))}
                    className="w-full h-2 bg-slate-200 rounded-lg accent-indigo-600" />
            </section>

            {/* æ ¸å¿ƒæŒ‰éˆ• */}
            <div className="grid grid-cols-2 gap-4">
                <label className="flex items-center justify-center bg-gradient-to-r from-slate-800 to-slate-900 text-white h-20 rounded-3xl font-bold cursor-pointer hover:from-black shadow-xl hover:shadow-2xl transition-all">
                    ğŸ“¸ ä¸Šå‚³åŸåœ–
                    <input type="file" hidden accept="image/*" onChange={e => {
                        const file = e.target.files[0];
                        if (file && file.size < 15e6) {
                            const url = URL.createObjectURL(file);
                            const img = new Image();
                            img.onload = () => { 
                                setImage(img); 
                                URL.revokeObjectURL(url); 
                                setTransform({ x: 0, y: -20, s: 0.45, r: 0 });
                            };
                            img.src = url;
                        }
                    }} />
                </label>
                <button onClick={() => setSlots([{ state: { ...transform } }, ...slots.slice(0, 41)])}
                        disabled={!image} className="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white h-20 rounded-3xl font-bold shadow-xl hover:shadow-2xl disabled:opacity-50 transition-all">
                    ğŸ’¾ å­˜ä½ç½® ({slots.length}/42)
                </button>
            </div>

            {/* 12ç¨®å…¨è¦æ ¼æ’ç‰ˆï¼ˆçµ‚æ¥µæ­¦å™¨ï¼‰ */}
            <section className="bg-white/90 backdrop-blur-sm rounded-3xl p-6 shadow-sm border">
                <h3 className="text-slate-800 font-black mb-6 text-lg flex items-center justify-center">
                    ğŸ–¨ï¸ 12ç¨®å°ç£è­‰ç…§è¦æ ¼
                </h3>
                
                {isPending && (
                    <div className="mb-6 p-4 bg-blue-50 rounded-2xl border">
                        <div className="flex justify-between text-sm font-bold text-blue-700 mb-2">
                            <span>300dpi æ¸²æŸ“ä¸­</span><span>{progress}%</span>
                        </div>
                        <div className="w-full bg-slate-200 h-3 rounded-full overflow-hidden">
                            <div className="bg-gradient-to-r from-blue-500 to-emerald-500 h-full transition-all" style={{ width: `${progress}%` }}></div>
                        </div>
                    </div>
                )}

                <div className="grid grid-cols-2 gap-3">
                    {Object.entries(PRINT_SPECS).map(([key, spec]) => (
                        <button key={key} disabled={isPending || !image}
                                onClick={() => handleExport(key)}
                                className="h-16 px-3 bg-gradient-to-r from-slate-50 to-blue-50 border border-slate-200 rounded-2xl hover:from-blue-50 hover:to-blue-100 hover:border-blue-300 font-bold text-slate-800 text-sm shadow-sm hover:shadow-md transition-all disabled:opacity-40 flex flex-col items-center justify-center">
                            <span>{spec.name}</span>
                            <span className="text-xs text-slate-500">{spec.w}Ã—{spec.h}px</span>
                        </button>
                    ))}
                </div>
            </section>

            {/* é«˜æ¸…é è¦½ */}
            {preview && (
                <div className="fixed inset-0 bg-slate-900/95 z-[100] flex flex-col p-6" onClick={e => e.target === e.currentTarget && setPreview(null)}>
                    <div className="flex-1 flex items-center justify-center overflow-auto p-4">
                        <img src={preview} className="max-w-full max-h-full shadow-2xl rounded-2xl border-8 border-white" />
                    </div>
                    <div className="mt-8 flex gap-4">
                        <button onClick={() => setPreview(null)} 
                                className="flex-1 h-16 bg-slate-700 hover:bg-slate-800 text-white rounded-2xl font-bold shadow-xl">è¿”å›ç·¨è¼¯</button>
                        <a href={preview} download={`è­‰ä»¶ç…§_${Date.now()}.png`} 
                           className="flex-1 h-16 bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white rounded-2xl font-bold shadow-xl flex items-center justify-center">ğŸ’¾ ä¸‹è¼‰åˆ—å°</a>
                    </div>
                </div>
            )}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
