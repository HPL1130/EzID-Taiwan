<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v3.3.1 PRO</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .canvas-container { position:relative; width:350px; height:450px; margin:0 auto; background:#fff; border-radius:32px; border:8px solid #fff; box-shadow:0 20px 40px rgba(0,0,0,.1); overflow:hidden; }
        .inner-guide { border:2px dotted rgba(16,185,129,0.7); position:absolute; border-radius:50%/46%; transform:translateY(-6%); z-index: 100; }
        .outer-guide { border:2px dashed rgba(245,158,11,0.5); position:absolute; border-radius:50%/46%; transform:translateY(-6%); z-index: 99; }
        .toast { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.85); color:white; padding:10px 24px; border-radius:24px; font-size:12px; z-index:999; backdrop-filter:blur(4px); transition: opacity 0.2s; }
        input[type=range] { width:100%; accent-color:#2563eb; height:6px; background:transparent; appearance:none; cursor: pointer; position: relative; z-index: 10; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback, startTransition } = React;

// --- å„ªåŒ– 28: æœè£é™£åˆ—ç”Ÿæˆèªç¾©åŒ– ---
const CLOTHES = [
    ...Array(5).fill(0).map((_, i) => `clothes/male/m${i+1}.png`),
    ...Array(5).fill(0).map((_, i) => `clothes/female/f${i+1}.png`)
];

const DPI = 300;
const mmToPx = (mm) => Math.round(mm * DPI / 25.4);
const SAFE = mmToPx(12); 
const A4_W = 2480, A4_H = 3508;

const CONTROL_RANGES = {
    photo: { s: {min:0.3, max:1.5, step:0.01}, y: {min:-150, max:150}, x: {min:-150, max:150} },
    suit:  { s: {min:0.5, max:4.0, step:0.01}, y: {min:-400, max:400}, x: {min:-250, max:250} }
};

function App() {
    const canvasRef = useRef(null);
    const toastTimer = useRef(null);
    const rafRef = useRef(0);
    const dirtyRef = useRef(true);

    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [activeSuit, setActiveSuit] = useState(null);
    const [slots, setSlots] = useState([]); 
    const [toast, setToast] = useState("");
    const [cutMode, setCutMode] = useState("FRAME_L"); 
    
    const INIT_P = { x: 0, y: -20, s: 0.75 };
    const INIT_SP = { x: 0, y: 0, s: 1.0 };
    const [p, setP] = useState(INIT_P);
    const [sp, setSp] = useState(INIT_SP);

    const markDirty = () => { dirtyRef.current = true; };
    
    // --- å„ªåŒ– 22 & 26: Toast çµ±ä¸€åŒ–èˆ‡åœ–æ¨™èªç¾©åŒ– ---
    const showToast = (msg) => {
        if (toastTimer.current) clearTimeout(toastTimer.current);
        setToast(msg);
        toastTimer.current = setTimeout(() => setToast(""), 2000); // çµ±ä¸€ 2000ms
    };

    // --- å„ªåŒ– 29: Canvas æŠ—é‹¸é½’ ---
    const draw = useCallback(() => {
        const ctx = canvasRef.current.getContext("2d");
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";
        ctx.fillStyle = "#ffffff"; 
        ctx.fillRect(0, 0, 350, 450);
        if(image){
            ctx.save(); ctx.translate(175 + p.x, 225 + p.y); ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width/2, -image.height/2); ctx.restore();
        }
        if(suitImg){
            ctx.save();
            const w = 350 * sp.s; const h = (suitImg.height / suitImg.width) * w;
            ctx.drawImage(suitImg, (350 - w)/2 + sp.x, 450 - h + 15 + sp.y, w, h);
            ctx.restore();
        }
    }, [image, suitImg, p, sp]);

    useEffect(() => {
        const loop = () => { if (dirtyRef.current) { dirtyRef.current = false; draw(); } rafRef.current = requestAnimationFrame(loop); };
        rafRef.current = requestAnimationFrame(loop);
        return () => cancelAnimationFrame(rafRef.current);
    }, [draw]);

    const selectSuit = (url) => {
        if(!url) { setSuitImg(null); setActiveSuit(null); markDirty(); return; }
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => { setSuitImg(img); setActiveSuit(url); markDirty(); };
        img.onerror = () => showToast("âŒ æœè£è¼‰å…¥å¤±æ•—");
        img.src = url;
    };

    const saveToSlot = () => {
        if(!image) return showToast("âš ï¸ è«‹å…ˆä¸Šå‚³ç…§ç‰‡");
        canvasRef.current.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            setSlots(prev => {
                const next = [url, ...prev];
                if (next.length > 10) {
                    const removed = next.pop();
                    URL.revokeObjectURL(removed); 
                }
                return next;
            });
            showToast("âœ… å·²å­˜å…¥æ§½ä½");
        }, "image/png");
    };

    // --- å•é¡Œ 21: ä¿®å¾© clearSlots å‡½æ•¸ç¼ºå¤± ---
    const clearSlots = () => {
        slots.forEach(url => URL.revokeObjectURL(url));
        setSlots([]);
        showToast("ğŸ”„ å·²æ¸…ç©ºæ‰€æœ‰æ§½ä½");
    };

    const removeSlot = (i) => {
        URL.revokeObjectURL(slots[i]);
        setSlots(prev => prev.filter((_, idx) => idx !== i));
        showToast("ğŸ—‘ï¸ å·²ç§»é™¤ç…§ç‰‡");
    };

    // --- Layout Solver ---
    const getCols = (sw, gap) => Math.floor((A4_W - SAFE * 2 + gap) / (sw + gap));
    const getMaxRows = (startY, sh, gap, limitY) => {
        const usable = limitY - startY;
        return (usable < sh) ? 0 : Math.floor((usable + gap) / (sh + gap));
    };

    const drawPhotoWithLMark = (ctx, img, x, y, w, h) => {
        ctx.drawImage(img, x, y, w, h);
        ctx.save();
        ctx.lineJoin = "miter"; ctx.lineCap = "square";
        
        // å„ªåŒ– 32: ç¹ªè£½é‚è¼¯ç°¡åŒ– (å…§éƒ¨å°è£)
        if (cutMode === "LIGHT") {
            ctx.strokeStyle = "#E2E8F0"; ctx.lineWidth = 1;
            ctx.strokeRect(x, y, w, h);
        } else {
            ctx.strokeStyle = "#000"; ctx.lineWidth = 1;
            if (cutMode !== "L_ONLY") ctx.strokeRect(x, y, w, h);
            if (cutMode !== "FRAME") {
                const L = 20;
                ctx.beginPath();
                ctx.moveTo(x+L, y); ctx.lineTo(x, y); ctx.lineTo(x, y+L);
                ctx.moveTo(x+w-L, y); ctx.lineTo(x+w, y); ctx.lineTo(x+w, y+L);
                ctx.moveTo(x+L, y+h); ctx.lineTo(x, y+h); ctx.lineTo(x, y+h-L);
                ctx.moveTo(x+w-L, y+h); ctx.lineTo(x+w, y+h); ctx.lineTo(x+w, y+h-L);
                ctx.stroke();
            }
        }
        ctx.restore();
    };

    const downloadA4 = async (mode) => {
        if(!slots.length) return showToast("âš ï¸ æ§½ä½å…§ç„¡ç…§ç‰‡");
        try {
            const pc = document.createElement("canvas");
            pc.width = A4_W; pc.height = A4_H;
            const ctx = pc.getContext("2d");
            ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, A4_W, A4_H);

            const imgs = await Promise.all(slots.map(s => new Promise((res, rej) => {
                const i = new Image(); i.onload = () => res(i); i.onerror = rej; i.src = s;
            })));

            let imgIdx = 0;
            const renderBlock = (sw, sh, gap, startY, rows, cols) => {
                const rowWidth = cols * sw + (cols - 1) * gap;
                const startX = (A4_W - rowWidth) / 2;
                if (startX < SAFE) throw new Error("è¶Šç•Œ");
                for (let r = 0; r < rows; r++) {
                    const cy = startY + r * (sh + gap);
                    if (cy + sh > A4_H - SAFE) break;
                    for (let c = 0; c < cols; c++) {
                        drawPhotoWithLMark(ctx, imgs[imgIdx % imgs.length], startX + c*(sw+gap), cy, sw, sh);
                        imgIdx++;
                    }
                }
                return startY + rows * (sh + gap);
            };

            if (mode === 'ALL_2') {
                const sw=413, sh=531, g=35;
                renderBlock(sw, sh, g, SAFE, getMaxRows(SAFE, sh, g, A4_H - SAFE), getCols(sw, g));
            } else if (mode === 'ALL_1') {
                const sw=295, sh=413, g=25;
                renderBlock(sw, sh, g, SAFE, getMaxRows(SAFE, sh, g, A4_H - SAFE), getCols(sw, g));
            } else if (mode === 'MIX') {
                const S2 = {w:413, h:531, g:35}, S1 = {w:295, h:413, g:25};
                const c2 = getCols(S2.w, S2.g), c1 = getCols(S1.w, S1.g);
                const maxR2 = getMaxRows(SAFE, S2.h, S2.g, A4_H - SAFE);
                let best = { r2: 0, r1: 0, total: -1 };
                for(let r=0; r<=maxR2; r++){
                    const yN = SAFE + r*(S2.h + S2.g);
                    const r1 = getMaxRows(yN, S1.h, S1.g, A4_H - SAFE);
                    const t = r*c2 + r1*c1;
                    if (t > best.total || (t === best.total && r > best.r2)) best = { r2: r, r1, total: t };
                }
                const nextY = renderBlock(S2.w, S2.h, S2.g, SAFE, best.r2, c2);
                renderBlock(S1.w, S1.h, S1.g, nextY, best.r1, c1);
            }

            const a = document.createElement("a");
            a.href = pc.toDataURL("image/png");
            a.download = `EzID_${mode}_${Date.now()}.png`; a.click();
            showToast(`âœ… ä¸‹è¼‰æˆåŠŸ (${mode})`);
        } catch(e) { 
            // å•é¡Œ 25: å…·é«”åŒ–éŒ¯èª¤è¨Šæ¯
            console.error("A4 è¼¸å‡ºç•°å¸¸:", e);
            showToast(e.message === "è¶Šç•Œ" ? "âŒ æ’ç‰ˆè¶…å‡ºé‚Šç•Œ" : "âŒ ä¸‹è¼‰å¤±æ•—ï¼Œè«‹é‡è©¦");
        }
    };

    return (
        <div className="max-w-md mx-auto p-4 pb-12">
            {toast && <div className="toast shadow-2xl">{toast}</div>}
            
            <header className="flex justify-between items-center mb-6 px-2">
                <h1 className="font-black text-slate-800 italic text-xl leading-none">EzID <span className="text-blue-600 text-[10px] not-italic border border-blue-600 px-1 rounded">v3.3.1 PRO</span></h1>
                <select value={cutMode} onChange={e=>setCutMode(e.target.value)} className="text-[10px] font-bold border rounded-lg px-2 py-1 bg-white outline-none shadow-sm border-slate-200">
                    <option value="FRAME_L">è£åˆ‡ï¼šé»‘æ¡† + Læ¨™</option>
                    <option value="L_ONLY">è£åˆ‡ï¼šåƒ… Læ¨™</option>
                    <option value="FRAME">è£åˆ‡ï¼šåƒ…é»‘æ¡†</option>
                    <option value="LIGHT">è£åˆ‡ï¼šæ·ºè‰²åƒè€ƒç·š</option>
                </select>
            </header>

            <div className="canvas-container mb-6 shadow-2xl shadow-blue-100">
                <canvas ref={canvasRef} width="350" height="450" />
                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div className="inner-guide" style={{width:'71%', height:'71%'}}></div>
                    <div className="outer-guide" style={{width:'80%', height:'80%'}}></div>
                </div>
            </div>

            <section className="space-y-4">
                <div className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                    <div className="flex justify-between mb-4 items-center">
                        <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ğŸ‘” æœè£å¾®èª¿ (Suit)</span>
                        <div className="flex gap-2">
                            <button className="text-[10px] font-bold text-slate-500 bg-slate-50 px-2 py-1 rounded-lg border border-slate-100 active:bg-slate-100" onClick={()=>{setSp(INIT_SP);markDirty();showToast("ğŸ”„ ä½ç½®å·²é‡ç½®")}}>ğŸ‘” RESET</button>
                            <button className="text-[10px] font-bold text-white bg-slate-800 px-2 py-1 rounded-lg active:opacity-80" onClick={()=>{setSp(INIT_SP);setP(INIT_P);selectSuit(null);markDirty();showToast("ğŸ”„ è¨­å®šå·²å…¨éƒ¨é‡ç½®")}}>ğŸ”„ ALL</button>
                        </div>
                    </div>
                    <div className="flex gap-2 overflow-x-auto no-scrollbar mb-6 pb-2">
                        <button onClick={()=>selectSuit(null)} className="flex-shrink-0 w-12 h-12 border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center text-slate-300">âœ•</button>
                        {CLOTHES.map(s => (
                            <button key={s} onClick={()=>selectSuit(s)} className={`flex-shrink-0 w-12 h-12 border-2 rounded-xl p-1 transition-all ${activeSuit===s?'border-blue-500 bg-blue-50':'border-transparent bg-slate-50'}`}><img src={s} className="w-full h-full object-contain"/></button>
                        ))}
                    </div>
                    {suitImg && (
                        <div className="space-y-5">
                            <RangeSlider label="SCALE" val={sp.s} config={CONTROL_RANGES.suit.s} onChange={v=>{startTransition(()=>{setSp(s=>({...s, s:v}));markDirty()})}} unit="%" mul={100} />
                            <RangeSlider label="Y-POS" val={sp.y} config={CONTROL_RANGES.suit.y} onChange={v=>{startTransition(()=>{setSp(s=>({...s, y:v}));markDirty()})}} />
                            <RangeSlider label="X-POS" val={sp.x} config={CONTROL_RANGES.suit.x} onChange={v=>{startTransition(()=>{setSp(s=>({...s, x:v}));markDirty()})}} />
                        </div>
                    )}
                </div>

                <div className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                    <div className="flex justify-between mb-4">
                        <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">ğŸ‘¤ ç…§ç‰‡èª¿æ•´ (Photo)</span>
                        <button className="text-[10px] font-bold text-slate-500 bg-slate-50 px-2 py-1 rounded-lg border border-slate-100" onClick={()=>{setP(INIT_P);markDirty()}}>RESET</button>
                    </div>
                    <div className="space-y-5">
                        <RangeSlider label="SCALE" val={p.s} config={CONTROL_RANGES.photo.s} onChange={v=>{startTransition(()=>{setP(s=>({...s, s:v}));markDirty()})}} unit="%" mul={100} />
                        <div className="grid grid-cols-2 gap-4">
                            <RangeSlider label="Y-POS" val={p.y} config={CONTROL_RANGES.photo.y} onChange={v=>{startTransition(()=>{setP(s=>({...s, y:v}));markDirty()})}} />
                            <RangeSlider label="X-POS" val={p.x} config={CONTROL_RANGES.photo.x} onChange={v=>{startTransition(()=>{setP(s=>({...s, x:v}));markDirty()})}} />
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3 mt-6">
                        <label className="bg-slate-800 text-white py-4 rounded-2xl text-center font-bold text-xs cursor-pointer active:scale-95 transition-all shadow-lg shadow-slate-200">ğŸ“¸ ä¸Šå‚³ç…§ç‰‡<input type="file" hidden accept="image/*" onChange={e=>{
                            const f=e.target.files[0]; if(!f) return;
                            const url=URL.createObjectURL(f); const img=new Image();
                            img.onload=()=>{setImage(img);URL.revokeObjectURL(url);markDirty();showToast("âœ… ç…§ç‰‡å·²è¼‰å…¥")}; img.src=url;
                        }}/></label>
                        <button onClick={saveToSlot} className="bg-blue-600 text-white py-4 rounded-2xl font-bold text-xs active:scale-95 transition-all shadow-lg shadow-blue-200">ğŸ“¥ å­˜å…¥æ§½ä½</button>
                    </div>
                </div>
            </section>

            <div className="mt-8 px-1">
                <div className="flex justify-between items-center mb-4">
                    <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-mono">Storage Slots ({slots.length}/10)</span>
                    <button onClick={clearSlots} className="text-[9px] text-red-500 font-bold border border-red-100 px-3 py-1 rounded-full bg-red-50 active:bg-red-100 transition-colors">CLEAR ALL</button>
                </div>
                <div className="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                    {slots.map((url, i)=>(
                        <div key={url} className="relative flex-shrink-0">
                            {/* å„ªåŒ– 23: æ”¹ç‚º active ç‹€æ…‹ */}
                            <img src={url} className="w-16 h-20 rounded-xl border-2 border-white shadow-md object-cover transition-transform active:scale-90" />
                            <button onClick={()=>removeSlot(i)} className="absolute -top-2 -right-2 bg-white text-red-500 w-6 h-6 rounded-full text-[10px] flex items-center justify-center border shadow-md font-bold active:scale-110">âœ•</button>
                        </div>
                    ))}
                </div>
            </div>

            <div className="mt-10 space-y-3">
                <button onClick={()=>downloadA4('MIX')} className="w-full bg-emerald-700 text-white py-4 rounded-2xl font-black text-sm shadow-xl active:scale-[0.98] transition-all">ğŸª ibon A4ï½œæ··æ’è§£ç®—å™¨</button>
                <div className="grid grid-cols-2 gap-3">
                    <button onClick={()=>downloadA4('ALL_2')} className="bg-indigo-600 text-white py-3.5 rounded-2xl font-bold text-xs shadow-md active:scale-[0.98] transition-all">ğŸª å…¨ 2 å‹</button>
                    <button onClick={()=>downloadA4('ALL_1')} className="bg-indigo-600 text-white py-3.5 rounded-2xl font-bold text-xs shadow-md active:scale-[0.98] transition-all">å…¨ 1 å‹</button>
                </div>
            </div>
        </div>
    );
}

// --- å„ªåŒ– 24: è¦–è¦ºåé¥‹çµ„ä»¶ (h-1.5 å¢å¼·) ---
function RangeSlider({ label, val, config, onChange, unit="", mul=1 }) {
    const { min, max } = config;
    const percentage = ((val - min) / (max - min)) * 100;
    return (
        <div className="space-y-1.5 relative">
            <div className="flex justify-between items-end">
                <span className="text-[9px] font-bold text-slate-400 uppercase">{label}</span>
                <span className="text-[10px] font-mono text-blue-600 font-bold">{Math.round(val * mul)}{unit}</span>
            </div>
            <div className="relative flex items-center h-6">
                <div className="absolute w-full h-1.5 bg-slate-100 rounded-full overflow-hidden">
                    <div className="h-full bg-blue-500 rounded-full transition-all duration-75" style={{ width: `${percentage}%` }} />
                </div>
                <input type="range" {...config} value={val} onInput={e=>onChange(+e.target.value)} />
            </div>
        </div>
    );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
