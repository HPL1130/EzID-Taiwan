<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzID Taiwan - ibon 4x6 æœ€çµ‚æ‹ç…§ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .control-panel { max-height: 85vh; overflow-y: auto; }
        canvas { background-color: white; border: 1px solid #e2e8f0; border-radius: 8px; }
        .guide-overlay {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -55%);
            width: 190px; height: 250px;
            border: 3px dashed rgba(255, 0, 0, 0.4);
            border-radius: 50% / 50%;
            pointer-events: none; z-index: 10;
        }
        .camera-video { transform: scaleX(-1); } /* é¡åƒé¡¯ç¤º */
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const SPECS = {
            TWO_INCH: { id: 'TWO_INCH', label: '2å‹(8å¼µ)', w: 413, h: 531, cols: 4, rows: 2 },
            ONE_INCH: { id: 'ONE_INCH', label: '1å‹(10å¼µ)', w: 331, h: 449, cols: 5, rows: 2 },
            MIXED: { id: 'MIXED', label: 'æ··åˆ(4å¤§5å°)', isMixed: true }
        };

        const EzIDApp = () => {
            const [image, setImage] = useState(null);
            const [isCameraActive, setIsCameraActive] = useState(false);
            const [currentSpec, setCurrentSpec] = useState(SPECS.TWO_INCH);
            const [p, setP] = useState({ x: 0, y: 0, s: 0.6 });
            const [suit, setSuit] = useState({ id: null, x: 175, y: 340, s: 0.7 });
            
            const canvasRef = useRef(null);
            const videoRef = useRef(null);
            const suitImg = useRef(new Image());

            useEffect(() => {
                const draw = () => {
                    const canvas = canvasRef.current;
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, 350, 450);
                    ctx.fillStyle = "#FFFFFF";
                    ctx.fillRect(0, 0, 350, 450);

                    if (image) {
                        ctx.save();
                        ctx.translate(175 + parseInt(p.x), 225 + parseInt(p.y));
                        ctx.scale(p.s, p.s);
                        ctx.drawImage(image, -image.width/2, -image.height/2);
                        ctx.restore();
                    }

                    if (suit.id) {
                        suitImg.current.src = `./suit-${suit.id}.png`; 
                        if (suitImg.current.complete) {
                            ctx.save();
                            ctx.translate(parseInt(suit.x), parseInt(suit.y));
                            ctx.scale(suit.s * 2.2, suit.s * 2.2);
                            ctx.drawImage(suitImg.current, -suitImg.current.width/2, -suitImg.current.height/2);
                            ctx.restore();
                        } else { suitImg.current.onload = draw; }
                    }
                };
                draw();
            }, [image, p, suit]);

            // ç›¸æ©Ÿå•Ÿå‹•
            const startCamera = async () => {
                setIsCameraActive(true);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                    if (videoRef.current) videoRef.current.srcObject = stream;
                } catch (err) {
                    alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™");
                    setIsCameraActive(false);
                }
            };

            // æ‹ç…§æˆªåœ–
            const takePhoto = () => {
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = videoRef.current.videoWidth;
                tempCanvas.height = videoRef.current.videoHeight;
                const ctx = tempCanvas.getContext('2d');
                // è™•ç†é¡åƒ
                ctx.translate(tempCanvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(videoRef.current, 0, 0);
                
                const img = new Image();
                img.onload = () => {
                    setImage(img);
                    setIsCameraActive(false);
                    // é—œé–‰æ”å½±æ©Ÿé¡é ­
                    videoRef.current.srcObject.getTracks().forEach(track => track.stop());
                };
                img.src = tempCanvas.toDataURL('image/png');
            };

            const downloadIbon = () => {
                const pc = document.createElement('canvas');
                const ctx = pc.getContext('2d');
                pc.width = 1800; pc.height = 1200;
                ctx.fillStyle = "white";
                ctx.fillRect(0, 0, 1800, 1200);

                if (currentSpec.isMixed) {
                    // 4å¼µ2å‹ + 5å¼µ1å‹
                    for(let i=0; i<4; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 80+i*425, 80, 413, 531);
                    for(let i=0; i<5; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 80+i*340, 660, 331, 449);
                } else {
                    const { w, h, cols, rows } = currentSpec;
                    for (let r=0; r<rows; r++) {
                        for (let c=0; c<cols; c++) {
                            ctx.drawImage(canvasRef.current, 0,0,350,450, 100+c*(w+30), 80+r*(h+50), w, h);
                        }
                    }
                }
                const link = document.createElement('a');
                link.download = `EzID_ibon_print.png`;
                link.href = pc.toDataURL('image/png');
                link.click();
            };

            return (
                <div className="flex flex-col lg:flex-row h-screen p-4 gap-4 overflow-hidden">
                    <div className="w-full lg:w-[380px] flex flex-col gap-4 bg-white p-4 rounded-3xl shadow-lg shrink-0">
                        <div className="relative aspect-[35/45] bg-slate-100 rounded-xl overflow-hidden border">
                            {isCameraActive ? (
                                <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover camera-video" />
                            ) : (
                                <canvas ref={canvasRef} width={350} height={450} className="w-full h-auto" />
                            )}
                            <div className="guide-overlay"></div>
                        </div>
                        
                        {isCameraActive ? (
                            <button onClick={takePhoto} className="bg-red-600 text-white py-4 rounded-2xl font-black text-lg shadow-lg hover:bg-red-700">æŒ‰ä¸‹æ‹ç…§</button>
                        ) : (
                            <div className="flex flex-col gap-2">
                                <button onClick={downloadIbon} className="bg-emerald-600 text-white py-4 rounded-2xl font-black text-lg shadow-lg hover:bg-emerald-700 transition">ä¸‹è¼‰æ©«å¼æ’ç‰ˆåœ–</button>
                                <div className="grid grid-cols-2 gap-2">
                                    <button onClick={startCamera} className="bg-blue-600 text-white py-2 rounded-xl text-sm font-bold shadow">å•Ÿå‹•ç›¸æ©Ÿ</button>
                                    <input type="file" onChange={(e) => {
                                        const reader = new FileReader();
                                        reader.onload = (f) => { const img = new Image(); img.onload = () => setImage(img); img.src = f.target.result; };
                                        reader.readAsDataURL(e.target.files[0]);
                                    }} className="hidden" id="file-up" />
                                    <label htmlFor="file-up" className="bg-slate-200 text-slate-600 py-2 rounded-xl text-sm font-bold shadow text-center cursor-pointer">ä¸Šå‚³æª”æ¡ˆ</label>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="flex-1 bg-white p-6 rounded-3xl shadow-lg control-panel border border-slate-200">
                        <div className="space-y-6">
                            <div>
                                <label className="block text-xs font-bold text-slate-400 mb-2">æ’ç‰ˆè¦æ ¼</label>
                                <div className="flex gap-2">
                                    {Object.values(SPECS).map(s => (
                                        <button key={s.id} onClick={() => setCurrentSpec(s)} className={`px-4 py-2 rounded-xl border font-bold text-sm transition ${currentSpec.id === s.id ? 'bg-slate-800 text-white border-slate-800' : 'text-slate-500 bg-white'}`}>{s.label}</button>
                                    ))}
                                </div>
                            </div>

                            <div className="p-4 bg-slate-50 rounded-2xl space-y-4">
                                <p className="text-xs font-bold text-slate-500 uppercase italic">ğŸ‘¤ äººåƒèª¿æ•´</p>
                                <div className="flex items-center gap-2"><span className="text-[10px] w-8 text-slate-400">ç¸®æ”¾</span><input type="range" min="0.1" max="1.5" step="0.01" value={p.s} onChange={e => setP({...p, s: e.target.value})} className="flex-1" /></div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="flex items-center gap-2"><span className="text-[10px] text-slate-400">å·¦å³</span><input type="range" min="-200" max="200" value={p.x} onChange={e => setP({...p, x: e.target.value})} /></div>
                                    <div className="flex items-center gap-2"><span className="text-[10px] text-slate-400">ä¸Šä¸‹</span><input type="range" min="-200" max="200" value={p.y} onChange={e => setP({...p, y: e.target.value})} /></div>
                                </div>
                            </div>

                            <div className="p-4 bg-indigo-50 rounded-2xl space-y-4 border border-indigo-100">
                                <p className="text-xs font-bold text-indigo-500 uppercase italic">ğŸ‘” è¡£æœå¾®èª¿</p>
                                <div className="flex gap-2 overflow-x-auto pb-2">
                                    {['m1','m2','m3','m4','m5'].map(id => (
                                        <img key={id} src={`./suit-${id}.png`} onClick={() => setSuit({...suit, id})} className={`w-14 h-14 border-2 rounded-lg bg-white cursor-pointer transition ${suit.id === id ? 'border-indigo-600 scale-105 shadow-md' : 'border-white'}`} 
                                        onError={(e) => { e.target.style.display='none'; }} />
                                    ))}
                                    <button onClick={() => setSuit({...suit, id: null})} className="px-3 border-2 border-dashed rounded-lg text-[10px] text-slate-400">æ¸…é™¤</button>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="flex items-center gap-2"><span className="text-[10px] text-indigo-400">è¡£æœç¸®æ”¾</span><input type="range" min="0.3" max="1.5" step="0.01" value={suit.s} onChange={e => setSuit({...suit, s: e.target.value})} /></div>
                                    <div className="flex items-center gap-2"><span className="text-[10px] text-indigo-400">ä¸Šä¸‹ä½ç½®</span><input type="range" min="100" max="500" value={suit.y} onChange={e => setSuit({...suit, y: e.target.value})} /></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
    </script>
</body>
</html>
