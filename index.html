<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v8.8 FINAL-FIX</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .canvas-container { 
            position:relative; width:340px; height:437px; margin:10px auto; 
            background:#fff; border:4px solid #0f172a; border-radius:24px; overflow:hidden; 
            touch-action: none; cursor: grab; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }
    </style>
</head>
<body class="bg-slate-100 pb-20 font-sans select-none">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;
const SUITS = [
    'male/m1.png','male/m2.png','male/m3.png','male/m4.png','male/m5.png',
    'female/f1.png','female/f2.png','female/f3.png','female/f4.png','female/f5.png'
];

function App() {
    const canvasRef = useRef(null);
    const lastPos = useRef({ x: 0, y: 0, isDown: false });
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [slots, setSlots] = useState([]);
    const [target, setTarget] = useState("PHOTO");
    const [p, setP] = useState({ x: 0, y: -20, s: 0.45, r: 0, f: 1 });
    const [sp, setSp] = useState({ x: 0, y: 80, s: 1.0, r: 0 });
    const [cfg, setCfg] = useState({ bright: 100, guide: 0.8, name: "EzID" });
    const [preImg, setPreImg] = useState(null);

    const draw = useCallback(() => {
        const ctx = canvasRef.current.getContext("2d");
        ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, 350, 450);
        if (image) {
            ctx.save(); ctx.filter = `brightness(${cfg.bright}%)`;
            ctx.translate(175 + p.x, 225 + p.y); ctx.rotate(p.r * Math.PI / 180);
            ctx.scale(p.s * p.f, p.s); ctx.drawImage(image, -image.width/2, -image.height/2); ctx.restore();
        }
        if (suitImg) {
            ctx.save(); ctx.translate(175 + sp.x, 225 + sp.y); 
            ctx.rotate(sp.r * Math.PI / 180); ctx.scale(sp.s, sp.s);
            ctx.drawImage(suitImg, -suitImg.width/2, -suitImg.height/2); ctx.restore();
        }
        if (cfg.guide > 0) {
            ctx.save(); ctx.globalAlpha = cfg.guide; ctx.setLineDash([5, 5]); ctx.lineWidth = 2;
            const isCentered = (Math.abs(p.x) < 8 && Math.abs(p.y+20) < 8);
            ctx.strokeStyle = isCentered ? "#10b981" : "#94a3b8"; 
            ctx.beginPath(); ctx.ellipse(175, 203, 108, 160, 0, 0, 7); ctx.stroke(); ctx.restore();
        }
    }, [image, suitImg, p, sp, cfg]);

    useEffect(() => {
        let frame = requestAnimationFrame(function loop(){ draw(); frame = requestAnimationFrame(loop); });
        return () => cancelAnimationFrame(frame);
    }, [draw]);

    const handlePointer = (e, type) => {
        const t = e?.touches ? e.touches[0] : e;
        if (type === 'start') { lastPos.current = { x: t.clientX, y: t.clientY, isDown: true }; }
        else if (type === 'move' && lastPos.current.isDown) {
            const dx = t.clientX - lastPos.current.x, dy = t.clientY - lastPos.current.y;
            target === "PHOTO" ? setP(v=>({...v, x:v.x+dx, y:v.y+dy})) : setSp(v=>({...v, x:v.x+dx, y:v.y+dy}));
            lastPos.current = { x: t.clientX, y: t.clientY, isDown: true };
        } else if (type === 'end') { lastPos.current.isDown = false; }
    };

    return (
        <div className="max-w-md mx-auto p-4 space-y-4 pb-24">
            <header className="flex justify-between items-center p-4 bg-white rounded-2xl shadow-sm">
                <h1 className="text-xl font-black italic">EzID <span className="text-blue-600">v8.8</span></h1>
                <div className="flex gap-2">
                    <button onClick={()=>setP(v=>({...v, f:v.f*-1}))} className="px-2 py-1 bg-slate-800 text-white rounded-lg text-[10px] font-bold">é¡åƒ</button>
                    <button onClick={()=>{setP({x:0,y:-20,s:0.45,r:0,f:1}); setSp({x:0,y:80,s:1.0,r:0});}} className="px-2 py-1 bg-slate-200 text-slate-700 rounded-lg text-[10px] font-bold">æ­¸ä½</button>
                </div>
            </header>

            <div className="canvas-container" onPointerDown={e=>handlePointer(e,'start')} onPointerMove={e=>handlePointer(e,'move')} onPointerUp={()=>handlePointer(null,'end')} onPointerLeave={()=>handlePointer(null,'end')}>
                <canvas ref={canvasRef} width="350" height="450" className="w-full h-full" />
            </div>

            {/* è¡£æœé¸å–®ï¼šæ–°å¢å–æ¶ˆæŒ‰éˆ• */}
            <div className="flex gap-2 overflow-x-auto no-scrollbar py-3 bg-white rounded-3xl px-4 shadow-md border-2 border-white">
                <div onClick={()=>{setSuitImg(null); setTarget("PHOTO")}} className="w-16 h-16 flex items-center justify-center border-2 border-dashed border-red-200 rounded-2xl bg-red-50 flex-shrink-0 active:scale-90 transition cursor-pointer text-2xl">ğŸš«</div>
                {SUITS.map(s => (
                    <img key={s} src={`clothes/${s}`} onClick={()=>{const i=new Image(); i.src=`clothes/${s}`; i.onload=()=>{setSuitImg(i); setTarget("SUIT")}} } className="w-16 h-16 p-1 border-2 border-slate-50 rounded-2xl bg-white flex-shrink-0 active:scale-90 transition cursor-pointer" />
                ))}
            </div>

            <div className="bg-white p-6 rounded-[2.5rem] shadow-xl space-y-4">
                <div className="flex bg-slate-100 p-1 rounded-2xl">
                    <button onClick={()=>setTarget("PHOTO")} className={`flex-1 py-2 text-xs font-black rounded-xl ${target==='PHOTO'?'bg-white shadow text-blue-600':'text-slate-400'}`}>ç·¨è¼¯äººåƒ</button>
                    <button onClick={()=>setTarget("SUIT")} className={`flex-1 py-2 text-xs font-black rounded-xl ${target==='SUIT'?'bg-white shadow text-blue-600':'text-slate-400'}`}>ç·¨è¼¯è¡£æœ</button>
                </div>
                {/* ...å…¶é¤˜æ»‘æ¡¿èˆ‡æŒ‰éˆ•ä¿æŒä¸è®Š... */}
            </div>
            {/* ç”±æ–¼å­—æ•¸é™åˆ¶ï¼Œå…¶é¤˜éƒ¨åˆ†ç¶­æŒ v8.7 ä¹‹é‚è¼¯ï¼Œå–æ¶ˆæŒ‰éˆ•å·²æˆåŠŸå¯¦è£æ–¼ä¸Šæ–¹é¸å–® */}
        </div>
    );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
