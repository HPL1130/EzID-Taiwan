<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EzID Taiwan v2.6.0</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body{margin:0;background:#f8fafc}
.canvas-container{position:relative;width:350px;height:450px;margin:auto;background:#fff;border-radius:32px;border:8px solid #fff;box-shadow:0 20px 40px rgba(0,0,0,.1)}
canvas{width:350px;height:450px}
.id-guide{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center}
.inner-guide,.outer-guide{position:absolute;border-radius:50%/46%;transform:translateY(-6%)}
.inner-guide{border:2px dotted rgba(16,185,129,.7)}
.outer-guide{border:2px dashed rgba(245,158,11,.6)}
.center-line{position:absolute;left:50%;top:0;bottom:0;width:1.5px;background:rgba(59,130,246,.4)}
.fixed-panel{max-width:400px;margin:16px auto;background:#fff;border-radius:24px;padding:20px;border:1px solid #e5e7eb}
input[type=range]{width:100%}
.suit-scroll{display:flex;gap:8px;overflow-x:auto}
.suit-btn{width:52px;height:52px;border-radius:12px;border:2px solid #e5e7eb;background:#fff}
.suit-btn.active{border-color:#2563eb;background:#eff6ff}
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#0f172a;color:#fff;padding:10px 24px;border-radius:999px;opacity:0;transition:.3s;z-index:9999}
.slot-scroll{display:flex;gap:10px;overflow-x:auto}
.slot-box{width:65px;height:85px;border-radius:8px;overflow:hidden;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.1)}
</style>
</head>

<body>
<div id="root"></div>
<div id="toast" class="toast"></div>

<script type="text/babel">
const {useState,useRef,useEffect,useCallback}=React

function App(){
 const canvasRef=useRef(null)

 const [img,setImg]=useState(null)
 const [suit,setSuit]=useState(null)
 const [activeSuit,setActiveSuit]=useState(null)

 const [p,setP]=useState({x:0,y:-20,s:1})
 const [sp,setSp]=useState({s:1.2,y:0})

 const [slots,setSlots]=useState([])
 const [preset,setPreset]=useState("id")
 const [guide,setGuide]=useState(true)

 const PRESETS={
  id:{label:"æˆ¶æ”¿",target:0.75,inner:71,outer:80},
  passport:{label:"è­·ç…§",target:0.75,inner:70,outer:80},
  resume:{label:"å±¥æ­·",target:0.6,inner:55,outer:70}
 }

 const CLOTHES={
  male:Array.from({length:5},(_,i)=>`clothes/male/m${i+1}.png`),
  female:Array.from({length:5},(_,i)=>`clothes/female/f${i+1}.png`)
 }

 const toast=msg=>{
  const t=document.getElementById("toast")
  t.textContent=msg
  t.style.opacity=1
  setTimeout(()=>t.style.opacity=0,2000)
 }

 /* ===== è‡ªå‹•é ­éƒ¨ç¸®æ”¾ ===== */
 const autoFitHead=useCallback(image=>{
  const ratio=PRESETS[preset].target
  const s=(350*ratio)/image.height
  setP(p=>({...p,s}))
 },[preset])

 /* ===== Canvas ç¹ªè£½ ===== */
 const draw=useCallback(()=>{
  const c=canvasRef.current
  const ctx=c.getContext("2d")
  ctx.fillStyle="#fff"
  ctx.fillRect(0,0,350,450)

  if(img){
   ctx.save()
   ctx.translate(175+p.x,210+p.y)
   ctx.scale(p.s,p.s)
   ctx.drawImage(img,-img.width/2,-img.height/2)
   ctx.restore()
  }

  if(suit){
   ctx.save()
   const w=350*sp.s
   const h=suit.height/suit.width*w
   ctx.drawImage(suit,(350-w)/2,260-h/2+sp.y,w,h)
   ctx.restore()
  }
 },[img,suit,p,sp])

 useEffect(draw,[draw])

 /* ===== æœè£ ===== */
 const loadSuit=path=>{
  const i=new Image()
  i.onload=()=>{
   setSuit(i)
   setActiveSuit(path)
   setSp(s=>({...s,s:Math.max(1.5,s.s)}))
  }
  i.src=path
 }

 /* ===== è¼¸å‡º ===== */
 const saveSlot=()=>{
  if(!img)return toast("è«‹å…ˆä¸Šå‚³ç…§ç‰‡")
  setSlots(s=>[canvasRef.current.toDataURL("image/jpeg",0.95),...s].slice(0,8))
  toast("å·²å­˜å…¥æ§½ä½")
 }

 /* ===== ibon æ··æ’ ===== */
 async function downloadIbon(){
  if(slots.length===0)return
  const A4={w:2480,h:3508},SAFE=100,G=40
  const SIZE2={w:413,h:531},SIZE1={w:295,h:413}
  const c=document.createElement("canvas")
  c.width=A4.w;c.height=A4.h
  const ctx=c.getContext("2d")
  ctx.fillStyle="#fff";ctx.fillRect(0,0,A4.w,A4.h)

  const imgs=await Promise.all(slots.map(s=>new Promise(r=>{
   const i=new Image();i.onload=()=>r(i);i.src=s
  })))

  let y=SAFE,idx=0
  for(let r=0;r<3;r++){
   let x=SAFE
   for(let c2=0;c2<4;c2++){
    drawCell(ctx,imgs[idx%imgs.length],x,y,SIZE2)
    idx++;x+=SIZE2.w+G
   }
   y+=SIZE2.h+G
  }
  y+=20
  for(let r=0;r<4;r++){
   let x=SAFE
   for(let c1=0;c1<6;c1++){
    drawCell(ctx,imgs[idx%imgs.length],x,y,SIZE1)
    idx++;x+=SIZE1.w+G
   }
   y+=SIZE1.h+G
  }

  const a=document.createElement("a")
  a.href=c.toDataURL("image/png")
  a.download="EzID_ibON_A4.png"
  a.click()
 }

 function drawCell(ctx,img,x,y,s){
  ctx.drawImage(img,x,y,s.w,s.h)
  ctx.strokeRect(x,y,s.w,s.h)
  ctx.beginPath()
  ctx.moveTo(x+s.w/2,y)
  ctx.lineTo(x+s.w/2,y+s.h)
  ctx.moveTo(x,y+s.h/2)
  ctx.lineTo(x+s.w,y+s.h/2)
  ctx.stroke()
 }

 return(
 <div className="max-w-lg mx-auto p-4">
  <h1 className="font-black text-xl mb-2">EzID Taiwan v2.6.0</h1>

  <div className="canvas-container">
   <canvas ref={canvasRef} width="350" height="450"/>
   {guide&&<>
    <div className="center-line"/>
    <div className="id-guide">
     <div className="inner-guide" style={{width:"70%",height:"70%"}}/>
     <div className="outer-guide" style={{width:"80%",height:"80%"}}/>
    </div>
   </>}
  </div>

  <div className="fixed-panel">
   <input type="file" accept="image/*" onChange={e=>{
    const f=e.target.files[0]
    const i=new Image()
    i.onload=()=>{setImg(i);autoFitHead(i);toast("ç…§ç‰‡å·²è‡ªå‹•å°é½Š")}
    i.src=URL.createObjectURL(f)
   }}/>

   <div className="my-3">
    <label>ç…§ç‰‡ç¸®æ”¾</label>
    <input type="range" min="0.3" max="2" step="0.01" value={p.s} onChange={e=>setP({...p,s:+e.target.value})}/>
   </div>

   <div className="my-3">
    <label>æœè£ç¸®æ”¾</label>
    <input type="range" min="0.5" max="2.5" step="0.01" value={sp.s} onChange={e=>setSp({...sp,s:+e.target.value})}/>
   </div>

   <div className="suit-scroll">
    {CLOTHES.male.map(p=><button key={p} className={`suit-btn ${activeSuit===p?"active":""}`} onClick={()=>loadSuit(p)}>M</button>)}
    {CLOTHES.female.map(p=><button key={p} className={`suit-btn ${activeSuit===p?"active":""}`} onClick={()=>loadSuit(p)}>F</button>)}
   </div>

   <button onClick={saveSlot} className="mt-3 w-full bg-blue-600 text-white py-2 rounded">å­˜å…¥æ§½ä½</button>
  </div>

  <div className="slot-scroll">
   {slots.map((s,i)=><div key={i} className="slot-box"><img src={s} className="w-full h-full"/></div>)}
  </div>

  <button onClick={downloadIbon} className="mt-4 w-full bg-emerald-600 text-white py-3 rounded-xl">
   ğŸª ibon A4ï¼ˆ1+2 å‹æ··æ’ï¼‰
  </button>
 </div>
 )
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>)
</script>
</body>
</html>
