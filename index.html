<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EzID Taiwan v1.6.4 - AI è‡ªå‹•å°é½Šç‰ˆ</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0/dist/body-pix.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js"></script>
<style>
    body { background-color: #f1f5f9; color: #1e293b; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
    canvas { border-radius: 16px; max-width: 100%; height: auto; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); border: 1px solid #e2e8f0; }
    .guide-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -55%); width: 55%; height: 55%; border: 2px dashed rgba(239, 68, 68, 0.6); border-radius: 50%; pointer-events: none; z-index: 10; transition: all 0.3s; }
    .guide-overlay.active { border-color: #22c55e; border-style: solid; box-shadow: 0 0 15px rgba(34, 197, 94, 0.4); }
    .bg-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid white; box-shadow: 0 0 0 1px #cbd5e1; transition: all 0.2s; }
    .bg-dot.active { transform: scale(1.2); box-shadow: 0 0 0 2px #0f172a; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
</style>
</head>
<body class="p-3 md:p-6 no-scrollbar">
<div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

const EzIDApp = () => {
    const [image, setImage] = useState(null);
    const [isCam, setIsCam] = useState(false);
    const [mode, setMode] = useState('MIXED');
    const [bgColor, setBgColor] = useState('white');
    const [p, setP] = useState({ x: 0, y: 0, s: 0.7 });
    const [suit, setSuit] = useState({ id: null, x: 175, y: 340, s: 0.3 });
    const [autoAlign, setAutoAlign] = useState(true);
    const [isProcessing, setIsProcessing] = useState(false);
    
    // æ¨¡å‹ Refs
    const bodyPixModel = useRef(null);
    const faceModel = useRef(null);
    
    const canvasRef = useRef(null);
    const videoRef = useRef(null);
    const suitImg = useRef(new Image());
    const tempCanvasRef = useRef(document.createElement('canvas'));

    const getClothesPath = (id) => {
        const url = window.location.href.split('?')[0];
        const baseUrl = url.endsWith('/') ? url : url.substring(0, url.lastIndexOf('/') + 1);
        return `${baseUrl}clothes/suit-${id}.png`;
    };

    // 1. è¼‰å…¥ AI æ¨¡å‹
    useEffect(() => {
        const loadModels = async () => {
            setIsProcessing(true);
            bodyPixModel.current = await bodyPix.load({ architecture: 'MobileNetV1', outputStride: 16, multiplier: 0.75 });
            faceModel.current = await blazeface.load();
            setIsProcessing(false);
        };
        loadModels();
    }, []);

    // 2. è‡ªå‹•å°é½Šé‹ç®—
    const performAutoAlign = (predictions, videoWidth, videoHeight) => {
        if (!predictions || predictions.length === 0) return;
        
        const face = predictions[0];
        const start = face.topLeft;
        const end = face.bottomRight;
        const faceWidth = end[0] - start[0];
        const faceHeight = end[1] - start[1];
        const faceCenterY = start[1] + faceHeight / 2;
        const faceCenterX = start[0] + faceWidth / 2;

        // ç›®æ¨™ï¼šå°‡äººè‡‰ä¸­å¿ƒç§»è‡³åœ“å¿ƒï¼Œä¸¦èª¿æ•´å¤§å°
        // ç•«å¸ƒ 350x450ï¼Œåœ“å¿ƒç´„åœ¨ y=200 è™•
        const targetCanvasWidth = 350;
        const targetCanvasHeight = 450;
        
        // è¨ˆç®—ç¸®æ”¾ï¼šå¸Œæœ›äººè‡‰å¯¬åº¦å ç•«å¸ƒå¯¬åº¦çš„ 35%
        const newScale = (targetCanvasWidth * 0.35) / faceWidth;
        
        // è¨ˆç®—ä½ç§»ï¼šé¡åƒæƒ…æ³ä¸‹ï¼Œè‡‰ä¸­å¿ƒä½ç§»è¦åè½‰
        const newX = (videoWidth / 2 - faceCenterX) * newScale;
        const newY = (videoHeight * 0.45 - faceCenterY) * newScale;

        setP(prev => ({
            x: newX,
            y: newY,
            s: Math.min(Math.max(newScale, 0.4), 1.2) // é™åˆ¶ç¸®æ”¾ç¯„åœ
        }));
    };

    // 3. AI è™•ç†å¾ªç’°
    const processFrame = async (source, isVideo) => {
        if (!bodyPixModel.current) return null;

        // A. è‡‰éƒ¨åµæ¸¬ (å¦‚æœæ˜¯è‡ªå‹•æ¨¡å¼)
        if (autoAlign && faceModel.current) {
            const predictions = await faceModel.current.estimateFaces(source, false);
            if (predictions.length > 0) {
                performAutoAlign(predictions, isVideo ? source.videoWidth : source.width, isVideo ? source.videoHeight : source.height);
            }
        }

        // B. å»èƒŒè™•ç†
        const segmentation = await bodyPixModel.current.segmentPerson(source, { internalResolution: 'medium', segmentationThreshold: 0.7 });
        const tempCanvas = tempCanvasRef.current;
        tempCanvas.width = isVideo ? source.videoWidth : source.width;
        tempCanvas.height = isVideo ? source.videoHeight : source.height;
        const tCtx = tempCanvas.getContext('2d');
        
        if (isVideo) {
            tCtx.save(); tCtx.translate(tempCanvas.width, 0); tCtx.scale(-1, 1);
            tCtx.drawImage(source, 0, 0); tCtx.restore();
        } else {
            tCtx.drawImage(source, 0, 0);
        }

        const imgData = tCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        for (let i = 0; i < imgData.data.length; i += 4) {
            const px = i / 4;
            const x = px % tempCanvas.width;
            const y = Math.floor(px / tempCanvas.width);
            const maskX = isVideo ? (tempCanvas.width - 1 - x) : x;
            if (!segmentation.data[y * tempCanvas.width + maskX]) {
                imgData.data[i + 3] = 0;
            } else {
                const isEdge = [1, -1, tempCanvas.width, -tempCanvas.width].some(n => !segmentation.data[y * tempCanvas.width + maskX + n]);
                if (isEdge) imgData.data[i + 3] = 180;
            }
        }
        tCtx.putImageData(imgData, 0, 0);
        return tempCanvas;
    };

    // 4. ç•«å¸ƒæ¸²æŸ“
    const draw = useCallback((aiCanvas = null) => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = bgColor;
        ctx.fillRect(0, 0, 350, 450);

        const activeImage = aiCanvas || image;
        if (activeImage) {
            ctx.save();
            ctx.translate(175 + p.x, 225 + p.y);
            ctx.scale(p.s, p.s);
            ctx.drawImage(activeImage, -activeImage.width / 2, -activeImage.height / 2);
            ctx.restore();
        }

        if (suit.id) {
            const src = getClothesPath(suit.id);
            if (suitImg.current.src !== src) { suitImg.current.src = src; suitImg.current.onload = () => draw(aiCanvas); }
            if (suitImg.current.complete) {
                ctx.save(); ctx.translate(suit.x, suit.y); ctx.scale(suit.s * 1.5, suit.s * 1.5);
                ctx.drawImage(suitImg.current, -suitImg.current.width / 2, -suitImg.current.height / 2); ctx.restore();
            }
        }
    }, [image, p, suit, bgColor]);

    useEffect(() => {
        let raf;
        const loop = async () => {
            if (isCam && videoRef.current && bodyPixModel.current) {
                const aiCanvas = await processFrame(videoRef.current, true);
                draw(aiCanvas);
                raf = requestAnimationFrame(loop);
            }
        };
        if (isCam) raf = requestAnimationFrame(loop);
        else draw();
        return () => cancelAnimationFrame(raf);
    }, [isCam, bgColor, p, suit, autoAlign]);

    // ä¸‹è¼‰èˆ‡å…¶ä»–æŒ‰éˆ•é‚è¼¯ä¿æŒä¸è®Š
    const download = () => {
        const pc = document.createElement('canvas'); const ctx = pc.getContext('2d');
        pc.width = 1800; pc.height = 1200; ctx.fillStyle = "white"; ctx.fillRect(0, 0, 1800, 1200);
        const drawGrid = (cols, rows, w, h, startX, startY, gapX, gapY) => {
            for (let r = 0; r < rows; r++) for (let c = 0; c < cols; c++) ctx.drawImage(canvasRef.current, 0, 0, 350, 450, startX + c * (w + gapX), startY + r * (h + gapY), w, h);
        };
        if (mode === 'MIXED') { drawGrid(4,1,413,531,80,80,15,0); drawGrid(5,1,331,449,80,650,10,0); }
        else if (mode === 'TWO') drawGrid(4,2,413,531,80,80,20,30);
        else drawGrid(5,2,331,449,80,100,15,30);
        const a = document.createElement('a'); a.download = `EzID_Pro_${bgColor}.png`; a.href = pc.toDataURL(); a.click();
    };

    return (
        <div className="max-w-6xl mx-auto flex flex-col lg:flex-row gap-8">
            <div className="w-full lg:w-[450px] flex flex-col items-center">
                <div className="relative w-full aspect-[35/45] bg-white rounded-2xl overflow-hidden shadow-2xl border-4 border-white">
                    {isCam && <video ref={videoRef} autoPlay playsInline className="absolute inset-0 w-full h-full object-cover opacity-0" />}
                    <canvas ref={canvasRef} width={350} height={450} className="w-full h-full" />
                    <div className={`guide-overlay ${autoAlign ? 'active' : ''}`}></div>
                    
                    {!isProcessing && (
                        <div className="absolute top-4 right-4 flex flex-col gap-3 bg-white/40 p-2 rounded-full backdrop-blur-md">
                            <div onClick={()=>setBgColor('white')} className={`bg-dot bg-white ${bgColor==='white'?'active':''}`}></div>
                            <div onClick={()=>setBgColor('#007bff')} className={`bg-dot bg-blue-600 ${bgColor==='#007bff'?'active':''}`}></div>
                            <div onClick={()=>setBgColor('#ff0000')} className={`bg-dot bg-red-600 ${bgColor==='#ff0000'?'active':''}`}></div>
                        </div>
                    )}
                    
                    {isProcessing && <div className="absolute inset-0 bg-slate-900/50 backdrop-blur-md flex flex-col items-center justify-center text-white font-bold">è¼‰å…¥ AI æ¨¡å‹ä¸­...</div>}
                </div>

                <div className="w-full mt-6 space-y-3 px-2">
                    {isCam ? (
                        <button onClick={() => {
                            const tc = document.createElement('canvas');
                            tc.width = 350; tc.height = 450;
                            tc.getContext('2d').drawImage(canvasRef.current, 0, 0);
                            const img = new Image(); img.onload = () => { setImage(img); setIsCam(false); };
                            img.src = tc.toDataURL();
                        }} className="w-full bg-red-500 text-white py-4 rounded-2xl font-black text-xl shadow-lg">ğŸ“¸ æ‹æ”ä¸¦å­˜æª”</button>
                    ) : (
                        <>
                            <button onClick={download} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-xl shadow-lg">ğŸ’¾ ä¸‹è¼‰ 4x6 å‹æ’ç‰ˆ</button>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={() => {
                                    setIsCam(true);
                                    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }).then(s => videoRef.current.srcObject = s);
                                }} className="bg-white border-2 border-slate-900 py-3 rounded-xl font-bold">ğŸ“· é–‹å•Ÿç›¸æ©Ÿ</button>
                                <label className="bg-white border-2 border-slate-900 py-3 rounded-xl font-bold text-center cursor-pointer">
                                    ğŸ“ ä¸Šå‚³ç…§ç‰‡ <input type="file" className="hidden" onChange={async (e)=>{
                                        const file = e.target.files[0]; if(!file) return;
                                        const img = new Image(); img.onload = async () => {
                                            const aiCanvas = await processFrame(img, false);
                                            const finalImg = new Image(); finalImg.onload = () => { setImage(finalImg); };
                                            finalImg.src = aiCanvas.toDataURL();
                                        };
                                        img.src = URL.createObjectURL(file);
                                    }} accept="image/*" />
                                </label>
                            </div>
                        </>
                    )}
                </div>
            </div>

            <div className="flex-1 bg-white p-6 md:p-10 rounded-3xl border border-slate-200 shadow-sm">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-black text-slate-800 tracking-tight">EzID Pro v1.6.4</h2>
                    <label className="flex items-center gap-2 cursor-pointer bg-slate-100 px-4 py-2 rounded-full hover:bg-slate-200 transition">
                        <span className="text-sm font-bold text-slate-600">AI è‡ªå‹•å°é½Š</span>
                        <input type="checkbox" checked={autoAlign} onChange={e=>setAutoAlign(e.target.checked)} className="w-5 h-5 accent-green-500" />
                    </label>
                </div>

                <div className="space-y-8">
                    <section>
                        <p className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">1. æ’ç‰ˆæ¨¡å¼</p>
                        <div className="flex gap-2">
                            {[['MIXED','1/2å‹æ··åˆ'],['TWO','å…¨ 2 å‹'],['ONE','å…¨ 1 å‹']].map(([k,v])=>(
                                <button key={k} onClick={()=>setMode(k)} className={`flex-1 py-3 rounded-xl font-bold transition ${mode===k?'bg-slate-900 text-white':'bg-slate-100 text-slate-400'}`}>{v}</button>
                            ))}
                        </div>
                    </section>

                    <section className={`space-y-4 transition-opacity ${autoAlign ? 'opacity-30 pointer-events-none' : 'opacity-100'}`}>
                        <div className="flex justify-between items-center">
                            <p className="text-xs font-black text-slate-400 uppercase tracking-widest">2. æ‰‹å‹•å¾®èª¿ (è‡ªå‹•æ¨¡å¼å·²é—œé–‰)</p>
                        </div>
                        <div className="space-y-6">
                            <div className="flex items-center gap-4"><span className="w-12 text-xs font-bold">ç¸®æ”¾</span><input type="range" min="0.3" max="1.5" step="0.01" value={p.s} onChange={e=>setP({...p,s:parseFloat(e.target.value)})} className="flex-1 accent-slate-900"/></div>
                            <div className="grid grid-cols-2 gap-10">
                                <div className="flex items-center gap-4"><span className="text-xs font-bold">å·¦å³</span><input type="range" min="-150" max="150" value={p.x} onChange={e=>setP({...p,x:parseInt(e.target.value)})} className="flex-1 accent-slate-900"/></div>
                                <div className="flex items-center gap-4"><span className="text-xs font-bold">ä¸Šä¸‹</span><input type="range" min="-150" max="150" value={p.y} onChange={e=>setP({...p,y:parseInt(e.target.value)})} className="flex-1 accent-slate-900"/></div>
                            </div>
                        </div>
                    </section>

                    <section>
                        <p className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">3. æ•¸ä½æ­£è£</p>
                        <div className="flex gap-4 overflow-x-auto py-2 no-scrollbar">
                            {['m1','m2','m3','m4','m5'].map(n=>(
                                <div key={n} onClick={()=>setSuit({...suit,id:n})} className={`p-1 rounded-xl border-2 shrink-0 transition-all ${suit.id===n?'border-slate-900 bg-slate-50 scale-105 shadow-md':'border-transparent opacity-40 hover:opacity-100'}`}>
                                    <img src={getClothesPath(n)} className="w-16 h-16 object-contain" />
                                </div>
                            ))}
                            <button onClick={()=>setSuit({...suit,id:null})} className="px-6 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 text-xs font-bold">æ¸…é™¤</button>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
</script>
</body>
</html>
