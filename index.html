<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.47.64 - Production Ready</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background: #020617; color: #f8fafc; margin: 0; overflow-x: hidden; }
        #root { width: 100%; max-width: 500px; margin: 0 auto; min-height: 100vh; padding: 15px; }
        .zone-box { background: rgba(30, 41, 59, 0.4); border-radius: 24px; border: 1px solid rgba(255,255,255,0.05); padding: 16px; margin-bottom: 12px; }
        .zone-tag { font-size: 10px; font-weight: 900; color: #3b82f6; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .stage-box { position: relative; width: 100%; aspect-ratio: 350/466; background: #fff; border-radius: 16px; overflow: hidden; touch-action: none; border: 4px solid transparent; }
        .stage-box.unsafe { border-color: #ef4444; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect } = React;

// =======================================================
// üü¢ ZONE 1: SPEC ENGINE (Ë¶èÊ†ºËàáÈÇèËºØÂÖ¨ÁêÜ)
// =======================================================
const LOGICAL_BASE = { w: 600, h: 800 };

const SPECS = {
    'A4-20':   { id: 'A4-20',   w: 2480, h: 3508, grid: [5, 4], size: [413, 531], count: 20, name: 'A4-2Âêã(20Âºµ)', cat: 'A4' },
    'A4-42':   { id: 'A4-42',   w: 2480, h: 3508, grid: [7, 6], size: [295, 413], count: 42, name: 'A4-1Âêã(42Âºµ)', cat: 'A4' },
    'A4-ID':   { id: 'A4-ID',   w: 2480, h: 3508, grid: [4, 4], size: [450, 600], count: 16, name: 'A4-Ë≠∑ÁÖß(16Âºµ)', cat: 'A4' },
    'A4-BIG':  { id: 'A4-BIG',  w: 2480, h: 3508, grid: [4, 3], size: [531, 708], count: 12, name: 'A4-Â§ßÈ†≠(12Âºµ)', cat: 'A4' },
    'A4-MIX':  { id: 'A4-MIX',  w: 2480, h: 3508, name: 'A4-1+2Âêã(30Âºµ)', cat: 'A4', total: 30, sections: [{ y: 0, grid: [3, 4], size: [413, 531], count: 12, w: 2480, h: 1754 }, { y: 1754, grid: [3, 6], size: [295, 413], count: 18, w: 2480, h: 1754 }] },
    'A4-B':    { id: 'A4-B',    w: 2480, h: 3508, grid: [6, 5], size: [354, 472], count: 30, name: 'A4-BÁâà(30Âºµ)', cat: 'A4' },
    '4x6-8':   { id: '4x6-8',   w: 1800, h: 1200, grid: [2, 4], size: [413, 531], count: 8, name: '4x6-2Âêã(8Âºµ)', cat: '4x6' },
    '4x6-10':  { id: '4x6-10',  w: 1800, h: 1200, grid: [2, 5], size: [295, 413], count: 10, name: '4x6-1Âêã(10Âºµ)', cat: '4x6' },
    '4x6-12':  { id: '4x6-12',  w: 1800, h: 1200, grid: [3, 4], size: [295, 413], count: 12, name: '4x6-1Âêã(12Âºµ)', cat: '4x6' },
    '4x6-BIG': { id: '4x6-BIG', w: 1800, h: 1200, grid: [2, 3], size: [531, 708], count: 6, name: '4x6-Â§ßÈ†≠(6Âºµ)', cat: '4x6' },
    '4x6-MIX': { id: '4x6-MIX', w: 1800, h: 1200, name: '4x6-1+2Âêã(8Âºµ)', cat: '4x6', total: 8, sections: [{ x: 0, grid: [2, 2], size: [450, 600], count: 4, w: 900, h: 1200 }, { x: 900, grid: [2, 2], size: [413, 531], count: 4, w: 900, h: 1200 }] },
    'NAME':    { id: 'NAME',    w: 2480, h: 3508, grid: [6, 4], size: [295, 413], count: 24, name: 'Â∑•ÁâåÂêçÁ®±(24Âºµ)', cat: 'A4' }
};

const SpecEngine = {
    generateSlots(spec) {
        const gen = (sec) => {
            const arr = [];
            const gx = ((sec.w || spec.w) - sec.grid[1] * sec.size[0]) / (sec.grid[1] + 1);
            const gy = ((sec.h || spec.h) - sec.grid[0] * sec.size[1]) / (sec.grid[0] + 1);
            for(let r=0; r<sec.grid[0]; r++) for(let c=0; c<sec.grid[1]; c++) {
                if(arr.length < (sec.count || 999)) {
                    arr.push({ x: (sec.x || 0) + gx + c * (sec.size[0] + gx), y: (sec.y || 0) + gy + r * (sec.size[1] + gy), w: sec.size[0], h: sec.size[1] });
                }
            }
            return arr;
        };
        return spec.sections ? spec.sections.flatMap(gen) : gen(spec);
    }
};

// =======================================================
// üîµ ZONE 2: ASSET & CACHE (Ë≥áÊ∫êÁÆ°ÁêÜ)
// =======================================================
const AssetManager = {
    cache: new Map(),
    async fetch(url) {
        if (this.cache.has(url)) return this.cache.get(url);
        return new Promise(res => {
            const img = new Image(); img.crossOrigin="anonymous";
            img.onload=() => { this.cache.set(url, img); res(img); }; img.src=url;
        });
    }
};

// =======================================================
// üü° ZONE 3: STATE & SAFETY (Â§ßËÖ¶ËàáÂÆâÂÖ®È†êÊ™¢)
// =======================================================
const SafetyEngine = {
    validate(photoLayer) {
        if (!photoLayer || !photoLayer.img) return true;
        const w = photoLayer.img.width * photoLayer.s, h = photoLayer.img.height * photoLayer.s;
        const cx = 300 + photoLayer.x, cy = 400 + photoLayer.y;
        return (cx - w/2 <= 0) && (cx + w/2 >= 600) && (cy - h/2 <= 0) && (cy + h/2 >= 800);
    }
};

// =======================================================
// üü† ZONE 4: RENDER ENGINE (Áπ™ÂúñÂÖ¨ÁêÜ)
// =======================================================
const RenderEngine = {
    paint(ctx, layers, rect) {
        ctx.save();
        ctx.fillStyle = "#fff"; ctx.fillRect(rect.x, rect.y, rect.w, rect.h);
        ctx.beginPath(); ctx.rect(rect.x, rect.y, rect.w, rect.h); ctx.clip();
        const scale = rect.w / 600;
        layers.forEach(l => {
            if (!l.img || !l.visible) return;
            ctx.save();
            ctx.translate(rect.x + rect.w/2 + l.x * scale, rect.y + rect.h/2 + l.y * scale);
            ctx.scale(l.s * scale * l.f, l.s * scale);
            ctx.drawImage(l.img, -l.img.width/2, -l.img.height/2);
            ctx.restore();
        });
        ctx.restore();
    }
};

// =======================================================
// üî¥ ZONE 5: INTERACTION (‰∫§‰∫íÊâãÂã¢)
// =======================================================
const GestureHandler = {
    handle(e, startPos, scaleRatio) {
        const pts = e.targetTouches || [{ clientX: e.clientX, clientY: e.clientY }];
        return {
            dx: (pts[0].clientX - startPos.x) * scaleRatio,
            dy: (pts[0].clientY - startPos.y) * scaleRatio,
            newX: pts[0].clientX,
            newY: pts[0].clientY
        };
    }
};

function App() {
    // Á≥ªÁµ±ÁãÄÊÖã
    const [scene, setScene] = useState({
        layers: [
            { id: 'photo', x: 0, y: 0, s: 1, f: 1, img: null, visible: true },
            { id: 'suit', x: 0, y: 150, s: 1, f: 1, img: null, visible: true }
        ],
        activeId: 'photo',
        isSafe: true
    });
    const [ui, setUi] = useState({ cat: '4x6', spec: '4x6-8', results: null, error: null });
    const cvsRef = useRef(null);
    const mouse = useRef({ isDown: false, x: 0, y: 0 });

    // =======================================================
    // üü£ ZONE 6: EXPORT & PRE-FLIGHT (ÂÆàÈñÄÂì°)
    // =======================================================
    const doBatchExport = async (targetId = null) => {
        if (!scene.isSafe) { setUi(u => ({...u, error: "‚ö†Ô∏è ÈÇäÁïåÂÆâÂÖ®Ê™¢Êü•Êú™ÈÄöÈÅé"})); return; }
        const list = targetId ? [targetId] : Object.keys(SPECS);
        const outputs = [];
        const mCvs = document.createElement('canvas'); mCvs.width = 600; mCvs.height = 800;

        for (const sid of list) {
            const spec = SPECS[sid];
            const slots = SpecEngine.generateSlots(spec);
            const canvas = document.createElement('canvas'); canvas.width = spec.w; canvas.height = spec.h;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,spec.w,spec.h);

            slots.forEach(slot => {
                RenderEngine.paint(mCvs.getContext('2d'), scene.layers, {x:0,y:0,w:600,h:800});
                ctx.drawImage(mCvs, 0, 0, 600, 800, slot.x, slot.y, slot.w, slot.h);
            });
            outputs.push({ url: canvas.toDataURL('image/jpeg', 0.8), name: spec.name });
            await new Promise(r => setTimeout(r, 0));
        }
        setUi(u => ({...u, results: outputs}));
    };

    useEffect(() => {
        const render = () => {
            if (cvsRef.current) RenderEngine.paint(cvsRef.current.getContext('2d'), scene.layers, {x:0, y:0, w:350, h:466});
            requestAnimationFrame(render);
        };
        const f = requestAnimationFrame(render);
        return () => cancelAnimationFrame(f);
    }, [scene]);

    return (
        <div className="flex flex-col gap-3">
            <header className="flex justify-between items-center px-1">
                <h1 className="text-2xl font-black italic text-blue-500">EzID</h1>
                <span className="text-[10px] font-bold text-slate-500">ZONE-BASED V20.47.64</span>
            </header>

            {/* Zone 3 & 5: Editor Visuals */}
            <div className="zone-box">
                <div className="zone-tag">Zone 3/5: Editor {!scene.isSafe && '‚ùå UNSAFE'}</div>
                <div className={`stage-box mb-3 ${!scene.isSafe ? 'unsafe' : ''}`}
                    onPointerDown={e => { mouse.current = { isDown: true, x: e.clientX, y: e.clientY }; }}
                    onPointerMove={e => {
                        if (!mouse.current.isDown) return;
                        const res = GestureHandler.handle(e, {x: mouse.current.x, y: mouse.current.y}, 600/350);
                        mouse.current.x = res.newX; mouse.current.y = res.newY;
                        setScene(s => {
                            const nextLayers = s.layers.map(l => l.id === s.activeId ? { ...l, x: l.x + res.dx, y: l.y + res.dy } : l);
                            return { ...s, layers: nextLayers, isSafe: SafetyEngine.validate(nextLayers.find(n => n.id === 'photo')) };
                        });
                    }}
                    onPointerUp={() => mouse.current.isDown = false}>
                    <canvas ref={cvsRef} width="350" height="466" className="w-full h-full" />
                </div>
                <label className="block w-full py-4 bg-white text-black text-center rounded-xl font-black text-xs cursor-pointer">
                    Zone 2: ËºâÂÖ•ÁÖßÁâá<input type="file" hidden onChange={async e => {
                        const img = await AssetManager.fetch(URL.createObjectURL(e.target.files[0]));
                        setScene(s => ({...s, layers: s.layers.map(l => l.id === 'photo' ? {...l, img, s: Math.max(600/img.width, 800/img.height)*1.1} : l), isSafe: true}));
                    }}/>
                </label>
            </div>

            {/* Zone 1: Spec Selection */}
            <div className="zone-box">
                <div className="zone-tag">Zone 1: Specs (12 Total)</div>
                <div className="flex gap-1 overflow-x-auto no-scrollbar pb-2">
                    {['4x6', 'A4'].map(c => (
                        <button key={c} onClick={()=>setUi(u=>({...u, cat:c}))} className={`px-4 py-2 rounded-lg text-xs font-bold ${ui.cat===c?'bg-white text-black':'bg-slate-800'}`}>{c}</button>
                    ))}
                </div>
                <div className="grid grid-cols-3 gap-1">
                    {Object.values(SPECS).filter(s => s.cat === (ui.cat || '4x6')).map(s => (
                        <button key={s.id} onClick={()=>setUi(u=>({...u, spec:s.id}))} className={`px-2 py-2 rounded-lg text-[9px] font-bold ${ui.spec===s.id?'bg-blue-600':'bg-slate-800'}`}>{s.name}</button>
                    ))}
                </div>
            </div>

            {/* Zone 6: Production Export */}
            <div className="grid grid-cols-2 gap-2 mb-10">
                <button onClick={()=>doBatchExport(ui.spec)} className="py-5 bg-blue-600 rounded-2xl font-black text-xs">Zone 6: Â∞éÂá∫ÂñÆÂºµ</button>
                <button onClick={()=>doBatchExport()} className="py-5 bg-orange-600 rounded-2xl font-black text-xs">Zone 6: ÂÖ®Ë¶èÊ†ºÊâπÊ¨°</button>
            </div>

            {ui.results && (
                <div className="fixed inset-0 bg-slate-950 z-[999] overflow-y-auto p-4">
                    {ui.results.map((r,i)=>(<div key={i} className="mb-4"><img src={r.url} className="w-full rounded-xl"/><p className="text-center text-[10px] mt-2">{r.name}</p></div>))}
                    <button onClick={()=>setUi(u=>({...u, results:null}))} className="fixed bottom-6 left-1/2 -translate-x-1/2 px-10 py-4 bg-white text-black rounded-full font-black">ËøîÂõû</button>
                </div>
            )}
        </div>
    );
}
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
