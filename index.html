<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v3.1.0</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .canvas-container { position:relative; width:350px; height:450px; margin:0 auto; background:#fff; border-radius:32px; border:8px solid #fff; box-shadow:0 20px 40px rgba(0,0,0,.1); overflow:hidden; }
        .inner-guide { border:2px dotted rgba(16,185,129,0.7); position:absolute; border-radius:50%/46%; transform:translateY(-6%); z-index: 100; }
        .outer-guide { border:2px dashed rgba(245,158,11,0.5); position:absolute; border-radius:50%/46%; transform:translateY(-6%); z-index: 99; }
        .toast { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.85); color:white; padding:10px 24px; border-radius:24px; font-size:12px; z-index:999; backdrop-filter:blur(4px); transition: opacity 0.3s; }
        input[type=range] { width:100%; accent-color:#2563eb; height:6px; background:#e2e8f0; border-radius:3px; appearance:none; }
        .btn-reset { font-size: 9px; padding: 2px 6px; border-radius: 4px; background: #f1f5f9; color: #64748b; font-weight: bold; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

const DPI = 300;
const mmToPx = (mm) => Math.round(mm * DPI / 25.4);
const SAFE = mmToPx(12); 
const A4_W = 2480, A4_H = 3508;

function App() {
    const canvasRef = useRef(null);
    const toastTimer = useRef(null);
    const rafRef = useRef(0);
    const dirtyRef = useRef(true);

    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [activeSuit, setActiveSuit] = useState(null);
    const [slots, setSlots] = useState([]); // å­˜å„² Blob URLs
    const [toast, setToast] = useState("");
    const [cutMode, setCutMode] = useState("FRAME_L"); // FRAME, L_ONLY, FRAME_L, LIGHT
    
    // åˆå§‹åŒ–ç‹€æ…‹
    const INIT_P = { x: 0, y: -20, s: 0.75 };
    const INIT_SP = { x: 0, y: 0, s: 1.0 };
    const [p, setP] = useState(INIT_P);
    const [sp, setSp] = useState(INIT_SP);

    const CLOTHES = {
        male: Array.from({length:5}, (_,i)=> `clothes/male/m${i+1}.png`),
        female: Array.from({length:5}, (_,i)=> `clothes/female/f${i+1}.png`)
    };

    const markDirty = () => { dirtyRef.current = true; };
    const showToast = (msg) => {
        if (toastTimer.current) clearTimeout(toastTimer.current);
        setToast(msg);
        toastTimer.current = setTimeout(() => setToast(""), 2000);
    };

    // S1: æ¸²æŸ“å„ªåŒ– - Dirty Loop
    const draw = useCallback(() => {
        const ctx = canvasRef.current.getContext("2d");
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, 350, 450);
        if(image){
            ctx.save(); ctx.translate(175 + p.x, 225 + p.y); ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width/2, -image.height/2); ctx.restore();
        }
        if(suitImg){
            ctx.save();
            const w = 350 * sp.s; const h = (suitImg.height / suitImg.width) * w;
            ctx.drawImage(suitImg, (350 - w)/2 + sp.x, 450 - h + 15 + sp.y, w, h);
            ctx.restore();
        }
    }, [image, suitImg, p, sp]);

    useEffect(() => {
        const loop = () => { if (dirtyRef.current) { dirtyRef.current = false; draw(); } rafRef.current = requestAnimationFrame(loop); };
        rafRef.current = requestAnimationFrame(loop);
        return () => { cancelAnimationFrame(rafRef.current); if(toastTimer.current) clearTimeout(toastTimer.current); };
    }, [draw]);

    // S1: è§£æ±º Slots è¨˜æ†¶é«”èˆ‡å“è³ªå•é¡Œ (Blob URL)
    const saveToSlot = () => {
        if(!image) return alert("è«‹å…ˆä¸Šå‚³ç…§ç‰‡");
        canvasRef.current.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            setSlots(prev => [url, ...prev].slice(0, 10));
            showToast("å·²å­˜å…¥æ§½ä½");
        }, "image/png");
    };

    const removeSlot = (i) => {
        setSlots(prev => {
            URL.revokeObjectURL(prev[i]);
            return prev.filter((_, idx) => idx !== i);
        });
    };

    const clearSlots = () => {
        slots.forEach(url => URL.revokeObjectURL(url));
        setSlots([]);
        showToast("å·²æ¸…ç©ºæ‰€æœ‰æ§½ä½");
    };

    const handleUpload = (e) => {
        const f = e.target.files[0]; if(!f) return;
        const url = URL.createObjectURL(f);
        const img = new Image();
        img.onload = () => { setImage(img); URL.revokeObjectURL(url); markDirty(); showToast("è¼‰å…¥æˆåŠŸ"); };
        img.src = url;
    };

    const selectSuit = (url) => {
        if(!url) { setSuitImg(null); setActiveSuit(null); markDirty(); return; }
        const img = new Image();
        img.crossOrigin = "anonymous"; // S1: è™•ç†æ½›åœ¨ CORS
        img.onload = () => { setSuitImg(img); setActiveSuit(url); markDirty(); };
        img.onerror = () => showToast("æœè£è¼‰å…¥å¤±æ•—");
        img.src = url;
    };

    // S0-1: SSOT Layout Solver
    const getCols = (sw, gap) => Math.max(1, Math.floor((A4_W - SAFE * 2 + gap) / (sw + gap)));
    const getMaxRows = (startY, sh, gap) => Math.max(0, Math.floor((A4_H - SAFE - startY + gap) / (sh + gap)));

    const drawPhotoWithLMark = (ctx, img, x, y, w, h) => {
        ctx.drawImage(img, x, y, w, h);
        ctx.save();
        ctx.lineJoin = "miter"; ctx.lineCap = "square";
        
        // S0: è£åˆ‡ç·šæ¨¡å¼åˆ‡æ›
        if (cutMode === "LIGHT") {
            ctx.strokeStyle = "#E2E8F0"; ctx.lineWidth = 1;
            ctx.strokeRect(x, y, w, h);
        } else {
            ctx.strokeStyle = "#000"; ctx.lineWidth = 1;
            if (cutMode !== "L_ONLY") ctx.strokeRect(x, y, w, h);
            if (cutMode !== "FRAME") {
                const L = 20;
                ctx.beginPath();
                ctx.moveTo(x+L, y); ctx.lineTo(x, y); ctx.lineTo(x, y+L);
                ctx.moveTo(x+w-L, y); ctx.lineTo(x+w, y); ctx.lineTo(x+w, y+L);
                ctx.moveTo(x+L, y+h); ctx.lineTo(x, y+h); ctx.lineTo(x, y+h-L);
                ctx.moveTo(x+w-L, y+h); ctx.lineTo(x+w, y+h); ctx.lineTo(x+w, y+h-L);
                ctx.stroke();
            }
        }
        ctx.restore();
    };

    const downloadA4 = async (mode) => {
        if(!slots.length) return;
        try {
            const pc = document.createElement("canvas");
            pc.width = A4_W; pc.height = A4_H;
            const ctx = pc.getContext("2d");
            ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, A4_W, A4_H);

            const imgs = await Promise.all(slots.map(s => new Promise((resolve, reject) => { 
                const i = new Image(); 
                i.onload = () => resolve(i); 
                i.onerror = reject;
                i.src = s; 
            })));

            let imgIdx = 0;
            const renderBlock = (sw, sh, gap, startY, rows, cols) => {
                let currY = startY;
                const rowWidth = cols * sw + (cols - 1) * gap;
                const startX = (A4_W - rowWidth) / 2;
                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        drawPhotoWithLMark(ctx, imgs[imgIdx % imgs.length], startX + c*(sw+gap), currY, sw, sh);
                        imgIdx++;
                    }
                    currY += sh + gap;
                }
                return currY;
            };

            if (mode === 'ALL_2') {
                const sw=413, sh=531, g=35;
                renderBlock(sw, sh, g, SAFE, getMaxRows(SAFE, sh, g), getCols(sw, g));
            } else if (mode === 'ALL_1') {
                const sw=295, sh=413, g=25;
                renderBlock(sw, sh, g, SAFE, getMaxRows(SAFE, sh, g), getCols(sw, g));
            } else {
                // MIX Solver
                const S2 = {w:413, h:531, g:35}, S1 = {w:295, h:413, g:25};
                const c2 = getCols(S2.w, S2.g), c1 = getCols(S1.w, S1.g);
                const maxR2 = getMaxRows(SAFE, S2.h, S2.g);
                let best = { r2: 0, r1: 0, total: 0 };
                for(let r=0; r<=maxR2; r++){
                    const yNext = SAFE + r*(S2.h + S2.g);
                    const r1 = getMaxRows(yNext, S1.h, S1.g);
                    if((r*c2 + r1*c1) >= best.total) best = { r2: r, r1, yNext };
                }
                const nextY = renderBlock(S2.w, S2.h, S2.g, SAFE, best.r2, c2);
                renderBlock(S1.w, S1.h, S1.g, nextY, best.r1, c1);
            }

            const a = document.createElement("a");
            a.href = pc.toDataURL("image/png");
            a.download = `EzID_${mode}_${Date.now()}.png`;
            a.click();
        } catch(e) { showToast("è¼¸å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§½ä½å…§å®¹"); }
    };

    return (
        <div className="max-w-md mx-auto p-4 pb-12">
            {toast && <div className="toast shadow-2xl">{toast}</div>}
            
            <header className="flex justify-between items-end mb-4 px-2">
                <h1 className="font-black text-slate-800 italic text-xl">EzID <span className="text-blue-600 text-[10px] not-italic border border-blue-600 px-1 rounded">v3.1.0</span></h1>
                <div className="flex flex-col items-end gap-1">
                    <select value={cutMode} onChange={e=>setCutMode(e.target.value)} className="text-[9px] font-bold border rounded px-1 text-slate-500 bg-transparent">
                        <option value="FRAME_L">è£åˆ‡ï¼šé»‘æ¡† + Læ¨™</option>
                        <option value="L_ONLY">è£åˆ‡ï¼šåƒ… Læ¨™</option>
                        <option value="FRAME">è£åˆ‡ï¼šåƒ…é»‘æ¡†</option>
                        <option value="LIGHT">è£åˆ‡ï¼šæ·ºè‰²åƒè€ƒç·š</option>
                    </select>
                </div>
            </header>

            <div className="canvas-container mb-6 shadow-2xl shadow-blue-100">
                <canvas ref={canvasRef} width="350" height="450" />
                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div className="inner-guide" style={{width:'71%', height:'71%'}}></div>
                    <div className="outer-guide" style={{width:'80%', height:'80%'}}></div>
                </div>
            </div>

            <section className="space-y-4">
                <div className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                    <div className="flex justify-between mb-3">
                        <span className="text-[10px] font-bold text-slate-400 uppercase">ğŸ‘” æ›è£æ§åˆ¶ (SP)</span>
                        <button className="btn-reset" onClick={()=>{setSp(INIT_SP);markDirty()}}>RESET</button>
                    </div>
                    <div className="flex gap-2 overflow-x-auto no-scrollbar mb-4 pb-1">
                        <button onClick={()=>selectSuit(null)} className="suit-btn flex-shrink-0 w-[52px] h-[52px] text-red-500 border rounded-xl text-xs font-bold bg-white">âœ•</button>
                        {[...CLOTHES.male, ...CLOTHES.female].map(s => (
                            <button key={s} onClick={()=>selectSuit(s)} className={`flex-shrink-0 w-[52px] h-[52px] border rounded-xl p-1 bg-white ${activeSuit===s?'border-blue-500 bg-blue-50':''}`}><img src={s} className="w-full h-full object-contain"/></button>
                        ))}
                    </div>
                    {suitImg && (
                        <div className="space-y-4 p-4 bg-slate-50 rounded-2xl border border-slate-100">
                            <div className="flex items-center gap-4"><span className="text-[9px] font-bold text-slate-400 w-12">SIZE {Math.round(sp.s*100)}%</span><input type="range" min="0.5" max="3.5" step="0.01" value={sp.s} onInput={e=>{setSp({...sp, s:+e.target.value});markDirty()}} /></div>
                            <div className="flex items-center gap-4"><span className="text-[9px] font-bold text-slate-400 w-12">Y-POS {sp.y}</span><input type="range" min="-150" max="150" value={sp.y} onInput={e=>{setSp({...sp, y:+e.target.value});markDirty()}} /></div>
                            <div className="flex items-center gap-4"><span className="text-[9px] font-bold text-slate-400 w-12">X-POS {sp.x}</span><input type="range" min="-150" max="150" value={sp.x} onInput={e=>{setSp({...sp, x:+e.target.value});markDirty()}} /></div>
                        </div>
                    )}
                </div>

                <div className="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 space-y-5">
                    <div className="flex justify-between">
                        <span className="text-[10px] font-bold text-slate-400 uppercase">ğŸ‘¤ ç…§ç‰‡èª¿æ•´ (P)</span>
                        <button className="btn-reset" onClick={()=>{setP(INIT_P);markDirty()}}>RESET</button>
                    </div>
                    <div className="space-y-4 px-1">
                        <div><div className="flex justify-between mb-1"><span className="text-[9px] font-bold text-slate-400">SCALE</span><span className="text-[9px] font-mono">{Math.round(p.s*100)}%</span></div>
                        <input type="range" min="0.3" max="1.5" step="0.01" value={p.s} onInput={e=>{setP({...p, s:+e.target.value});markDirty()}} /></div>
                        <div className="grid grid-cols-2 gap-4">
                            {/* S0: ä¿®æ­£ P.Y ç¯„åœé€€åŒ–å•é¡Œ */}
                            <div><span className="text-[9px] font-bold text-slate-400">Y-AXIS ({p.y})</span><input type="range" min="-150" max="150" value={p.y} onInput={e=>{setP({...p, y:+e.target.value});markDirty()}} /></div>
                            <div><span className="text-[9px] font-bold text-slate-400">X-AXIS ({p.x})</span><input type="range" min="-150" max="150" value={p.x} onInput={e=>{setP({...p, x:+e.target.value});markDirty()}} /></div>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3 mt-4">
                        <label className="bg-slate-800 text-white py-3.5 rounded-2xl text-center font-bold text-xs cursor-pointer active:scale-95 transition-all">ğŸ“¸ ä¸Šå‚³ç…§ç‰‡<input type="file" hidden accept="image/*" onChange={handleUpload}/></label>
                        <button onClick={saveToSlot} className="bg-blue-600 text-white py-3.5 rounded-2xl font-bold text-xs active:scale-95 transition-all shadow-lg shadow-blue-100">ğŸ“¥ å­˜å…¥æ§½ä½</button>
                    </div>
                </div>
            </section>

            <div className="mt-8 px-1">
                <div className="flex justify-between items-center mb-3">
                    <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest font-mono">Slots {slots.length}/10</span>
                    <button onClick={clearSlots} className="text-[9px] text-red-400 font-bold border border-red-100 px-2 py-1 rounded-lg">CLEAR</button>
                </div>
                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                    {slots.map((url, i)=>(
                        <div key={url} className="relative flex-shrink-0">
                            <img src={url} className="w-16 h-20 rounded-xl border-2 border-white shadow-sm object-cover" />
                            <button onClick={()=>removeSlot(i)} className="absolute -top-1.5 -right-1.5 bg-red-500 text-white w-5 h-5 rounded-full text-[10px] flex items-center justify-center border-2 border-white shadow-sm">âœ•</button>
                        </div>
                    ))}
                </div>
            </div>

            <div className="mt-8 space-y-3">
                <button onClick={()=>downloadA4('MIX')} className="w-full bg-emerald-700 text-white py-4 rounded-2xl font-black text-sm shadow-xl active:scale-95 transition-all">ğŸª ibon A4ï½œæ··æ’è§£ç®—å™¨ (DPI 300)</button>
                <div className="grid grid-cols-2 gap-3">
                    <button onClick={()=>downloadA4('ALL_2')} className="bg-indigo-600 text-white py-3.5 rounded-2xl font-bold text-xs shadow-md">ğŸª å…¨ 2 å‹</button>
                    <button onClick={()=>downloadA4('ALL_1')} className="bg-indigo-600 text-white py-3.5 rounded-2xl font-bold text-xs shadow-md">å…¨ 1 å‹</button>
                </div>
            </div>
            
            <p className="mt-6 text-center text-[9px] text-slate-300 font-medium leading-relaxed">
                SAFE: 12mm / DPI: 300 / BLOB_SLOTS: ENABLED / RENDER: DIRTY_LOOP
            </p>
        </div>
    );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
