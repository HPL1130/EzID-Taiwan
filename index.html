<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v4.5.0</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .canvas-container { 
            position:relative; width:340px; height:437px; margin:0 auto; 
            background:#fff; border:2px solid #1e293b; border-radius:12px; overflow:hidden; 
            touch-action: none; cursor: grab; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .inner-guide { position:absolute; left:50%; top:45%; width:62%; height:71.1%; border:2px dotted #10b981; border-radius:50%/44%; transform:translate(-50%,-50%); z-index:100; pointer-events:none; }
        .outer-guide { position:absolute; left:50%; top:45%; width:70%; height:80%; border:2px dashed #f59e0b; border-radius:50%/44%; transform:translate(-50%,-50%); z-index:99; pointer-events:none; }
        .slot-item { position: relative; flex-shrink: 0; width: 70px; height: 90px; border: 2px solid #e2e8f0; border-radius: 6px; overflow: hidden; }
        .slot-remove { position: absolute; top: 1px; right: 1px; background: #ef4444; color: white; width: 16px; height: 16px; border-radius: 50%; display: flex; items-center; justify-center; font-size: 10px; cursor: pointer; z-index: 10; }
    </style>
</head>
<body class="bg-slate-100 p-3 pb-10">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

const SUITS = [
    ...Array(5).fill(0).map((_, i) => `male/m${i+1}.png`),
    ...Array(5).fill(0).map((_, i) => `female/f${i+1}.png`)
];

function App() {
    const canvasRef = useRef(null);
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [slots, setSlots] = useState([]);
    const [target, setTarget] = useState("PHOTO");
    const [p, setP] = useState({ x: 0, y: -20, s: 0.8 });
    const [sp, setSp] = useState({ x: 0, y: 80, s: 1.0 });

    const isDragging = useRef(false);
    const lastPos = useRef({ x: 0, y: 0 });

    const draw = useCallback(() => {
        const ctx = canvasRef.current.getContext("2d");
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, 350, 450);
        if (image) {
            ctx.save(); ctx.translate(175 + p.x, 225 + p.y); ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width/2, -image.height/2); ctx.restore();
        }
        if (suitImg) {
            ctx.save();
            const w = suitImg.width * sp.s; const h = suitImg.height * sp.s;
            ctx.drawImage(suitImg, 175 - w/2 + sp.x, 225 - h/2 + sp.y, w, h);
            ctx.restore();
        }
    }, [image, suitImg, p, sp]);

    useEffect(() => { draw(); }, [draw]);

    const handleStart = (e) => {
        isDragging.current = true;
        const pos = e.touches ? e.touches[0] : e;
        lastPos.current = { x: pos.clientX, y: pos.clientY };
    };
    const handleMove = (e) => {
        if (!isDragging.current) return;
        const pos = e.touches ? e.touches[0] : e;
        const dx = (pos.clientX - lastPos.current.x) * 1.2;
        const dy = (pos.clientY - lastPos.current.y) * 1.2;
        if (target === "PHOTO") setP(v => ({ ...v, x: v.x + dx, y: v.y + dy }));
        else setSp(v => ({ ...v, x: v.x + dx, y: v.y + dy }));
        lastPos.current = { x: pos.clientX, y: pos.clientY };
    };

    const exportDoc = async (type, mode) => {
        if (!slots.length) return alert("è«‹å…ˆå­˜å…¥æ§½ä½");
        const is46 = type === '46';
        const canvasW = is46 ? 1800 : 2480;
        const canvasH = is46 ? 1200 : 3508;

        const pc = document.createElement("canvas");
        pc.width = canvasW; pc.height = canvasH;
        const ctx = pc.getContext("2d");
        ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvasW, canvasH);

        const imgs = await Promise.all(slots.map(src => new Promise(res => {
            const i = new Image(); i.onload = () => res(i); i.src = src;
        })));

        const putImg = (img, x, y, sw, sh) => {
            ctx.drawImage(img, x, y, sw, sh);
            ctx.strokeStyle = "#ccc"; ctx.lineWidth = 1; ctx.strokeRect(x, y, sw, sh);
        };

        if (is46) {
            // 4x6 çµ‚æ¥µå®‰å…¨é‚Šç•Œï¼šå…§ç¸® 120px ä»¥é˜² ibon å‡ºè¡€åˆ‡é™¤
            const safePad = 120;
            const gap = 40;
            if (mode === 'MIX') {
                // 2å‹ x 3 å¼µ (ä¿®æ­£æ•¸é‡ä»¥æ›å–å®‰å…¨ç©ºé–“)
                for(let i=0; i<3; i++) putImg(imgs[i%imgs.length], safePad + i*(413+gap), safePad, 413, 531);
                // 1å‹ x 4 å¼µ
                for(let i=0; i<4; i++) putImg(imgs[i%imgs.length], safePad + i*(295+gap), safePad+531+gap, 295, 413);
            } else if (mode === '2IN') {
                for(let i=0; i<6; i++) putImg(imgs[i%imgs.length], safePad+(i%3)*(413+gap), safePad+Math.floor(i/3)*(531+gap), 413, 531);
            } else {
                for(let i=0; i<8; i++) putImg(imgs[i%imgs.length], safePad+(i%4)*(295+gap), safePad+Math.floor(i/4)*(413+gap), 295, 413);
            }
        } else {
            // A4 çµ‚æ¥µå®‰å…¨é‚Šç•Œï¼šå…§ç¸® 200px
            const padX = 220, padY = 220, g = 60;
            if (mode === 'MIX') {
                for(let i=0; i<8; i++) putImg(imgs[i%imgs.length], padX+(i%4)*(413+g), padY+Math.floor(i/4)*(531+g), 413, 531);
                for(let i=0; i<10; i++) putImg(imgs[i%imgs.length], padX+(i%5)*(295+g), 1600+Math.floor(i/5)*(413+g), 295, 413);
            } else if (mode === '2IN') {
                for(let i=0; i<16; i++) putImg(imgs[i%imgs.length], padX+(i%4)*(413+g), padY+Math.floor(i/4)*(531+g), 413, 531);
            } else {
                for(let i=0; i<30; i++) putImg(imgs[i%imgs.length], padX+(i%5)*(295+60), padY+Math.floor(i/5)*(413+60), 295, 413);
            }
        }

        const now = new Date();
        const ts = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;
        const a = document.createElement("a"); a.href = pc.toDataURL("image/png"); a.download = `${ts}.png`; a.click();
    };

    return (
        <div className="max-w-md mx-auto space-y-4">
            <header className="flex justify-between items-center p-2">
                <h1 className="text-xl font-black italic">EzID <span className="text-blue-600">v4.5</span></h1>
                <span className="text-[10px] bg-red-600 text-white px-2 py-0.5 rounded font-black animate-pulse">ZERO-CUT VERSION</span>
            </header>

            <div className="canvas-container" onMouseDown={handleStart} onMouseMove={handleMove} onMouseUp={()=>isDragging.current=false} onTouchStart={handleStart} onTouchMove={handleMove} onTouchEnd={()=>isDragging.current=false}>
                <canvas ref={canvasRef} width="350" height="450" />
                <div className="inner-guide"></div><div className="outer-guide"></div>
            </div>

            <div className="bg-white p-4 rounded-3xl shadow-sm border border-slate-200 space-y-3">
                <div className="flex justify-between items-center">
                    <span className="text-[11px] font-black text-slate-400 uppercase tracking-widest">{target} SCALE</span>
                    <div className="flex bg-slate-100 p-1 rounded-xl gap-1">
                        <button onClick={()=>setTarget("PHOTO")} className={`px-4 py-1 text-[11px] font-bold rounded-lg transition ${target==='PHOTO'?'bg-white shadow text-blue-600':'text-slate-400'}`}>äººåƒ</button>
                        <button onClick={()=>setTarget("SUIT")} className={`px-4 py-1 text-[11px] font-bold rounded-lg transition ${target==='SUIT'?'bg-white shadow text-blue-600':'text-slate-400'}`}>è¡£æœ</button>
                    </div>
                </div>
                <input type="range" min="0.1" max="2.5" step="0.01" value={target === "PHOTO" ? p.s : sp.s} onChange={(e) => {
                    const val = +e.target.value;
                    if(target === "PHOTO") setP(v => ({...v, s: val})); else setSp(v => ({...v, s: val}));
                }} />
            </div>

            <div className="bg-white p-2 rounded-2xl border border-slate-200 overflow-hidden">
                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                    <button onClick={()=>setSuitImg(null)} className="flex-shrink-0 w-12 h-12 bg-slate-50 border-2 border-dashed rounded-xl text-slate-300 font-bold">âœ•</button>
                    {SUITS.map(id => (
                        <button key={id} onClick={()=>{
                            const img = new Image(); img.onload = () => { setSuitImg(img); setTarget("SUIT"); };
                            img.src = `clothes/${id}`;
                        }} className="flex-shrink-0 w-12 h-12 border rounded-xl overflow-hidden active:scale-90 transition">
                            <img src={`clothes/${id}`} className="w-full h-full object-contain" />
                        </button>
                    ))}
                </div>
            </div>

            <div className="grid grid-cols-2 gap-3">
                <label className="bg-slate-900 text-white py-4 rounded-2xl text-center text-sm font-black cursor-pointer shadow-lg active:scale-95 transition">ğŸ“¸ ä¸Šå‚³ç…§ç‰‡ <input type="file" hidden accept="image/*" onChange={e => {
                    const img = new Image(); img.onload = () => { setImage(img); setTarget("PHOTO"); }; img.src = URL.createObjectURL(e.target.files[0]);
                }} /></label>
                <button onClick={()=>setSlots(p => [canvasRef.current.toDataURL(), ...p].slice(0,10))} className="bg-blue-600 text-white py-4 rounded-2xl text-sm font-black shadow-lg active:scale-95 transition">ğŸ“¥ å­˜å…¥æ§½ä½</button>
            </div>

            <div className="bg-slate-200/60 p-3 rounded-3xl space-y-2">
                <div className="flex justify-between items-center px-1">
                    <span className="text-[10px] font-black text-slate-500 uppercase">Saved Slots ({slots.length}/10)</span>
                    <button onClick={()=>setSlots([])} className="text-[10px] text-red-500 font-bold underline">æ¸…é™¤å…¨éƒ¨</button>
                </div>
                <div className="flex gap-2 overflow-x-auto no-scrollbar min-h-[90px]">
                    {slots.map((src, idx) => (
                        <div key={idx} className="slot-item shadow-md bg-white">
                            <div className="slot-remove" onClick={() => setSlots(s => s.filter((_,i)=>i!==idx))}>Ã—</div>
                            <img src={src} className="w-full h-full object-cover" />
                        </div>
                    ))}
                </div>
            </div>

            <div className="space-y-3">
                <div className="p-4 bg-white rounded-3xl border-2 border-emerald-100 shadow-sm space-y-3">
                    <h3 className="text-[11px] font-black text-emerald-700 italic">ğŸª ibon 4x6 (é˜²åˆ‡å®‰å…¨é‚Šç•Œç‰ˆ)</h3>
                    <div className="grid grid-cols-3 gap-2">
                        <button onClick={()=>exportDoc('46','MIX')} className="bg-emerald-600 text-white py-3 rounded-xl text-[10px] font-black">æ··æ’ (7å¼µ)</button>
                        <button onClick={()=>exportDoc('46','2IN')} className="bg-slate-700 text-white py-3 rounded-xl text-[10px] font-black">2å‹ (6å¼µ)</button>
                        <button onClick={()=>exportDoc('46','1IN')} className="bg-slate-700 text-white py-3 rounded-xl text-[10px] font-black">1å‹ (8å¼µ)</button>
                    </div>
                </div>
                <div className="p-4 bg-white rounded-3xl border-2 border-blue-100 shadow-sm space-y-3">
                    <h3 className="text-[11px] font-black text-blue-700 italic">ğŸ“„ A4 Paper (å®¶ç”¨å¤§é‚Šè·ç‰ˆ)</h3>
                    <div className="grid grid-cols-3 gap-2">
                        <button onClick={()=>exportDoc('A4','MIX')} className="bg-blue-600 text-white py-3 rounded-xl text-[10px] font-black">æ··æ’ (18å¼µ)</button>
                        <button onClick={()=>exportDoc('A4','2IN')} className="bg-slate-500 text-white py-3 rounded-xl text-[10px] font-black">2å‹ (16å¼µ)</button>
                        <button onClick={()=>exportDoc('A4','1IN')} className="bg-slate-500 text-white py-3 rounded-xl text-[10px] font-black">1å‹ (30å¼µ)</button>
                    </div>
                </div>
            </div>
        </div>
    );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
