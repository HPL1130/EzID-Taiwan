<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>EzID v20.46.10 Iron Contract</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face { font-family: 'NotoSansTC'; src: local('Microsoft JhengHei'); font-weight: 700; }
        body { font-family: 'NotoSansTC', sans-serif; background: #020617; color: #f8fafc; margin: 0; }
        .editor-view { width: 100%; aspect-ratio: 350/450; background: #fff; border-radius: 20px; border: 4px solid #1e293b; overflow: hidden; position: relative; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback, useMemo } = React;

        /* ============================================================
           1ï¸âƒ£ æ ¸å¿ƒå¥‘ç´„ï¼šSPECS æ•¸æ“šåº« (ä¸å¯ä¾µçŠ¯)
           ============================================================ */
        const SPECS = {
            'A4-20':   { id: 'A4-20',   w: 2480, h: 3508, grid: [5, 4], size: [413, 531], name: 'A4 2å‹(20)' },
            'A4-42':   { id: 'A4-42',   w: 2480, h: 3508, grid: [7, 6], size: [295, 413], name: 'A4 1å‹(42)' },
            'A4-ID':   { id: 'A4-ID',   w: 2480, h: 3508, grid: [4, 4], size: [450, 600], name: 'A4 è­·ç…§(16)' },
            'A4-BIG':  { id: 'A4-BIG',  w: 2480, h: 3508, grid: [4, 3], size: [531, 708], name: 'A4 å¤§é ­(12)' },
            'A4-B':    { id: 'A4-B',    w: 2480, h: 3508, grid: [6, 5], size: [354, 472], name: 'A4 Bç‰ˆ(30)' },
            'NAME':    { id: 'NAME',    w: 2480, h: 3508, grid: [6, 4], size: [295, 413], name: 'å·¥ç‰Œ(24)' },
            '4x6-8':   { id: '4x6-8',   w: 1800, h: 1200, grid: [2, 4], size: [413, 531], name: '4x6 2å‹(8)' },
            '4x6-10':  { id: '4x6-10',  w: 1800, h: 1200, grid: [2, 5], size: [295, 413], name: '4x6 1å‹(10)' },
            '4x6-12':  { id: '4x6-12',  w: 1800, h: 1200, grid: [3, 4], size: [295, 413], name: '4x6 1å‹(12)' },
            '4x6-BIG': { id: '4x6-BIG', w: 1800, h: 1200, grid: [2, 3], size: [531, 708], name: '4x6 å¤§é ­(6)' },
            'A4-MIX':  { 
                id: 'A4-MIX', w: 2480, h: 3508, name: 'A4 ç¶œåˆ',
                sections: [
                    { y: 0,    grid: [3, 4], size: [413, 531], count: 12 },
                    { y: 1754, grid: [3, 6], size: [295, 413], count: 18 }
                ]
            },
            '4x6-MIX': { 
                id: '4x6-MIX', w: 1800, h: 1200, name: '4x6 æ··åˆ',
                sections: [
                    { x: 0,   grid: [2, 2], size: [450, 600], count: 4 },
                    { x: 900, grid: [2, 2], size: [413, 531], count: 4 }
                ]
            }
        };

        /* ============================================================
           2ï¸âƒ£ é–€ç¥žè‡ªæª¢ (Gatekeeper)
           ============================================================ */
        const Gatekeeper = {
            check: () => {
                const results = {
                    len: Object.keys(SPECS).length === 12,
                    mix: SPECS['A4-MIX'].sections && SPECS['4x6-MIX'].sections,
                    logic: typeof SPECS['NAME'].grid[0] === 'number'
                };
                if (!Object.values(results).every(v => v)) {
                    console.error("Critical: Contract Violation!", results);
                    throw new Error("EZID_CONTRACT_VIOLATION");
                }
                return true;
            }
        };

        /* ============================================================
           3ï¸âƒ£ æŠ½è±¡æ¸²æŸ“å¼•æ“Ž (å®Œå…¨åˆ†é›¢ State)
           ============================================================ */
        const Renderer = {
            getLayout: (spec) => {
                const gen = (w, h, grid, size, ox=0, oy=0) => {
                    const [rs, cs] = grid, [pw, ph] = size;
                    const mx = (w-cs*pw)/(cs+1), my = (h-rs*ph)/(rs+1);
                    return Array.from({length:rs*cs}, (_,i)=>({
                        x: ox+mx+(i%cs)*(pw+mx), y: oy+my+Math.floor(i/cs)*(ph+my), w: pw, h: ph
                    }));
                };
                if (spec.sections) return spec.sections.flatMap(s => 
                    gen(s.x!==undefined?spec.w/2:spec.w, s.y!==undefined?spec.h/2:spec.h, s.grid, s.size, s.x||0, s.y||0).slice(0, s.count));
                return gen(spec.w, spec.h, spec.grid, spec.size);
            },
            draw: (ctx, data, rect, isExp = false) => {
                if (!data?.img) return;
                const ratio = rect.w / 350, cx = rect.x + rect.w/2, cy = rect.y + rect.h/2;
                ctx.save();
                ctx.beginPath(); ctx.rect(rect.x, rect.y, rect.w, rect.h); ctx.clip();
                const renderLayer = (t, i) => {
                    if(!i) return;
                    ctx.save();
                    ctx.translate(cx + t.x*ratio, cy + t.y*ratio);
                    ctx.rotate(t.r*Math.PI/180);
                    ctx.scale(t.s*ratio*(t.f||1), t.s*ratio);
                    ctx.drawImage(i, -i.width/2, -i.height/2);
                    ctx.restore();
                };
                renderLayer(data.photoT, data.img);
                if(data.suit) renderLayer(data.suitT, data.suit);
                ctx.restore();
                ctx.strokeStyle = "#cbd5e1"; ctx.lineWidth = isExp?2:1; ctx.strokeRect(rect.x, rect.y, rect.w, rect.h);
            }
        };

        /* ============================================================
           4ï¸âƒ£ React æ‡‰ç”¨ (UI èˆ‡æŽ§åˆ¶)
           ============================================================ */
        function App() {
            const [img, setImg] = useState(null);
            const [suit, setSuit] = useState(null);
            const [photoT, setPhotoT] = useState({ x: 0, y: -20, s: 0.45, r: 0, f: 1 });
            const [suitT, setSuitT] = useState({ x: 0, y: 80, s: 1.0, r: 0, f: 1 });
            const [target, setTarget] = useState('PHOTO');
            const [activeSpec, setActive] = useState('A4-20');
            const [assets, setAssets] = useState([]);
            const [results, setResults] = useState(null);
            
            const canvasRef = useRef(null);
            const drag = useRef({ active: false, x: 0, y: 0 });

            // å³æ™‚é è¦½ï¼šæŠ½é›¢æˆç´”ç²¹çš„ Data ç‰©ä»¶
            useEffect(() => {
                const ctx = canvasRef.current?.getContext('2d');
                if (ctx) {
                    ctx.fillStyle = "#fff"; ctx.fillRect(0,0,350,450);
                    Renderer.draw(ctx, {img, suit, photoT, suitT}, {x:0, y:0, w:350, h:450});
                }
            }, [img, suit, photoT, suitT]);

            // æ‰¹æ¬¡å°Žå‡ºé‚è¼¯ï¼šé‹¼éµå¥‘ç´„æ ¸å¿ƒ
            const runProduction = (mode = 'SINGLE') => {
                Gatekeeper.check(); // é•åå¥‘ç´„å‰‡å´©æ½°
                const targets = mode === 'ALL' ? Object.keys(SPECS) : [activeSpec];
                const pool = assets.length > 0 ? assets : [{img, suit, photoT:{...photoT}, suitT:{...suitT}}];
                
                const outputs = targets.map(id => {
                    const spec = SPECS[id];
                    const cvs = document.createElement('canvas');
                    cvs.width = spec.w; cvs.height = spec.h;
                    const ctx = cvs.getContext('2d');
                    ctx.fillStyle = "white"; ctx.fillRect(0,0,spec.w,spec.h);
                    
                    const layout = Renderer.getLayout(spec);
                    layout.forEach((pos, i) => Renderer.draw(ctx, pool[i % pool.length], pos, true));
                    return { name: spec.name, url: cvs.toDataURL('image/jpeg', 0.9) };
                });
                setResults(outputs);
            };

            return (
                <div className="max-w-md mx-auto p-6 flex flex-col gap-6 pb-24">
                    <header className="flex justify-between items-end border-b border-white/5 pb-4">
                        <h1 className="text-2xl font-black text-blue-500 italic">EzID PRO <span className="text-white not-italic text-sm ml-2">v20.46.10</span></h1>
                        <span className="text-[10px] text-emerald-500 font-bold tracking-widest">CONTRACT SECURED</span>
                    </header>

                    <div className="editor-view"
                        onPointerDown={e => { drag.current = { active:true, x:e.clientX, y:e.clientY }; e.target.setPointerCapture(e.pointerId); }}
                        onPointerMove={e => {
                            if(!drag.current.active) return;
                            const t = target==='PHOTO'?photoT:suitT, setT = target==='PHOTO'?setPhotoT:setSuitT;
                            setT(prev => ({...prev, x:prev.x+(e.clientX-drag.current.x)/t.s, y:prev.y+(e.clientY-drag.current.y)/t.s}));
                            drag.current.x = e.clientX; drag.current.y = e.clientY;
                        }}
                        onPointerUp={() => drag.current.active=false}>
                        <canvas ref={canvasRef} width="350" height="450" />
                    </div>

                    <div className="flex gap-2 p-1 bg-slate-900 rounded-2xl">
                        {['PHOTO', 'SUIT'].map(l => (
                            <button key={l} onClick={()=>setTarget(l)} className={`flex-1 py-3 rounded-xl text-xs font-black transition-all ${target===l?'bg-blue-600 text-white shadow-lg':'text-slate-500'}`}>{l} LAYER</button>
                        ))}
                    </div>

                    <div className="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto no-scrollbar py-2">
                        {Object.keys(SPECS).map(k => (
                            <button key={k} onClick={()=>setActive(k)} className={`p-3 text-[10px] font-bold rounded-xl border-2 transition-all ${activeSpec===k?'border-blue-500 text-blue-400':'border-transparent bg-slate-900/50 text-slate-600'}`}>{SPECS[k].name}</button>
                        ))}
                    </div>

                    <div className="flex flex-col gap-4">
                        <div className="flex gap-3">
                            <label className="flex-1 py-4 bg-slate-800 rounded-2xl text-center text-xs font-black cursor-pointer">ðŸ“¸ LOAD<input type="file" hidden onChange={e=>{
                                const f=e.target.files[0]; if(f){const i=new Image(); i.onload=()=>setImg(i); i.src=URL.createObjectURL(f);}
                            }} /></label>
                            <button onClick={()=>{
                                const t=document.createElement('canvas'); t.width=100; t.height=130;
                                Renderer.draw(t.getContext('2d'), {img, suit, photoT, suitT}, {x:0, y:0, w:100, h:130});
                                setAssets([...assets, { id:Date.now(), img, suit, photoT:{...photoT}, suitT:{...suitT}, thumb:t.toDataURL() }]);
                            }} className="flex-1 py-4 bg-slate-800 rounded-2xl text-xs font-black">ï¼‹ SAVE ASSET</button>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={()=>runProduction('SINGLE')} className="flex-[2] py-4 bg-blue-600 rounded-2xl text-xs font-black shadow-xl shadow-blue-900/40">ðŸš€ EXPORT CURRENT</button>
                            <button onClick={()=>runProduction('ALL')} className="flex-1 py-4 bg-emerald-600 rounded-2xl text-xs font-black shadow-xl shadow-emerald-900/40">ðŸ”¥ BATCH (12)</button>
                        </div>
                    </div>

                    <div className="flex gap-3 overflow-x-auto no-scrollbar py-2">
                        {assets.map(as => <img key={as.id} src={as.thumb} className="w-12 h-16 rounded-lg border-2 border-white/10 flex-shrink-0 bg-white" />)}
                    </div>

                    {results && (
                        <div className="fixed inset-0 bg-slate-950 z-[9999] overflow-y-auto p-6 flex flex-col items-center gap-8 backdrop-blur-xl">
                            <div className="text-center space-y-2">
                                <h2 className="text-xl font-black">PRODUCTION READY</h2>
                                <p className="text-[10px] text-slate-500 uppercase tracking-widest">Total: {results.length} Layouts Generated</p>
                            </div>
                            <div className="grid grid-cols-1 gap-6 w-full max-w-sm">
                                {results.map((res, idx) => (
                                    <div key={idx} className="bg-slate-900 p-4 rounded-3xl border border-white/5 space-y-4">
                                        <div className="flex justify-between items-center">
                                            <span className="text-[10px] font-black text-blue-400">{res.name}</span>
                                            <span className="text-[9px] text-slate-600 italic">300 DPI EQUIV.</span>
                                        </div>
                                        <img src={res.url} className="w-full rounded-lg shadow-2xl" />
                                        <a href={res.url} download={`${res.name}.jpg`} className="block w-full py-4 bg-blue-600/20 hover:bg-blue-600 text-blue-400 hover:text-white rounded-xl text-center text-xs font-black transition-all">DOWNLOAD JPG</a>
                                    </div>
                                ))}
                            </div>
                            <button onClick={()=>setResults(null)} className="sticky bottom-4 px-12 py-4 bg-white text-black rounded-full font-black text-sm shadow-2xl active:scale-95 transition-all">CLOSE PRODUCTION</button>
                        </div>
                    )}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
</body>
</html>
