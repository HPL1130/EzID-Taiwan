<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v2.1.5 - ç½®é ‚è§€æ™¯çª—ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f1f5f9; overflow-x: hidden; }
        
        /* æ‰‹æ©Ÿç‰ˆç½®é ‚é‚è¼¯ */
        .sticky-canvas {
            position: sticky;
            top: 10px;
            z-index: 50;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: top center;
        }

        /* ç•¶é é¢æ²å‹•æ™‚ï¼Œç¸®å°ç•«å¸ƒé è¦½ */
        @media (max-width: 768px) {
            .is-scrolled .sticky-canvas {
                transform: scale(0.65) translateY(-10px);
                filter: drop-shadow(0 20px 13px rgb(0 0 0 / 0.1));
            }
        }

        .canvas-container { 
            position: relative; 
            touch-action: none !important; 
            background: #e2e8f0; 
            border-radius: 36px; 
            overflow: hidden; 
            border: 8px solid #fff; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
            cursor: move;
        }
        canvas { width: 100%; height: auto; display: block; pointer-events: none; }
        .id-guide { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -55%); width: 62%; height: 62%; border: 2px dashed rgba(239, 68, 68, 0.35); border-radius: 50%; pointer-events: none; z-index: 10; }
        .slot-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 10px 4px; scrollbar-width: none; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        const EzIDApp = () => {
            const [image, setImage] = useState(null);
            const [isCam, setIsCam] = useState(false);
            const [bgColor, setBgColor] = useState('#ffffff');
            const [p, setP] = useState({ x: 0, y: 0, s: 0.75 });
            const [suit, setSuit] = useState({ gender: 'male', id: null, x: 175, y: 340, s: 0.35 });
            const [slots, setSlots] = useState([]);
            const [scrolled, setScrolled] = useState(false);

            const canvasRef = useRef(null);
            const containerRef = useRef(null);
            const videoRef = useRef(null);
            const suitImg = useRef(new Image());
            const state = useRef({ isDragging: false, lastX: 0, lastY: 0, lastDist: 0 });

            // ç›£è½æ²å‹•ï¼Œè§¸ç™¼ç•«å¸ƒç¸®å°æ‡¸æµ®
            useEffect(() => {
                const handleScroll = () => setScrolled(window.scrollY > 100);
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            const handleZoom = (factor) => {
                if (!suit.id) return;
                setSuit(v => ({ ...v, s: Math.min(Math.max(v.s * factor, 0.05), 2.0) }));
            };

            // æ‰‹æ©Ÿé›™æŒ‡èˆ‡æ‹–æ›³é‚è¼¯
            useEffect(() => {
                const el = containerRef.current;
                if (!el) return;
                const onTS = (e) => {
                    if (e.touches.length === 1) {
                        state.current.isDragging = true;
                        state.current.lastX = e.touches[0].clientX;
                        state.current.lastY = e.touches[0].clientY;
                    } else if (e.touches.length === 2) {
                        state.current.lastDist = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
                    }
                };
                const onTM = (e) => {
                    if (e.cancelable) e.preventDefault();
                    if (!suit.id) return;
                    if (e.touches.length === 1 && state.current.isDragging) {
                        const dx = e.touches[0].clientX - state.current.lastX;
                        const dy = e.touches[0].clientY - state.current.lastY;
                        const rect = el.getBoundingClientRect();
                        setSuit(v => ({ ...v, x: v.x + dx * (350/rect.width), y: v.y + dy * (450/rect.height) }));
                        state.current.lastX = e.touches[0].clientX;
                        state.current.lastY = e.touches[0].clientY;
                    } else if (e.touches.length === 2) {
                        const dist = Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
                        if (state.current.lastDist > 0) handleZoom(dist / state.current.lastDist);
                        state.current.lastDist = dist;
                    }
                };
                const onTE = () => { state.current.isDragging = false; state.current.lastDist = 0; };
                el.addEventListener('touchstart', onTS, { passive: false });
                el.addEventListener('touchmove', onTM, { passive: false });
                el.addEventListener('touchend', onTE);
                return () => {
                    el.removeEventListener('touchstart', onTS);
                    el.removeEventListener('touchmove', onTM);
                    el.removeEventListener('touchend', onTE);
                };
            }, [suit.id]);

            const draw = useCallback(() => {
                const ctx = canvasRef.current?.getContext('2d'); if (!ctx) return;
                ctx.fillStyle = bgColor; ctx.fillRect(0, 0, 350, 450);
                if (image) {
                    ctx.save(); ctx.translate(175 + p.x, 225 + p.y); ctx.scale(p.s, p.s);
                    ctx.drawImage(image, -image.width/2, -image.height/2); ctx.restore();
                }
                if (suit.id) {
                    suitImg.current.src = `clothes/${suit.gender}/${suit.id}.png`;
                    if (suitImg.current.complete) {
                        ctx.save(); ctx.translate(suit.x, suit.y); ctx.scale(suit.s * 1.5, suit.s * 1.5);
                        ctx.drawImage(suitImg.current, -suitImg.current.width/2, -suitImg.current.height/2); ctx.restore();
                    }
                }
            }, [image, p, suit, bgColor]);

            useEffect(() => {
                let raf = requestAnimationFrame(function loop() { draw(); raf = requestAnimationFrame(loop); });
                return () => cancelAnimationFrame(raf);
            }, [draw]);

            return (
                <div className={`max-w-6xl mx-auto flex flex-col lg:flex-row gap-8 ${scrolled ? 'is-scrolled' : ''}`}>
                    {/* å·¦å´ï¼šç½®é ‚ç•«å¸ƒå€ */}
                    <div className="w-full lg:w-[400px] sticky-canvas">
                        <div 
                            ref={containerRef} 
                            className="canvas-container w-full max-w-[350px] mx-auto aspect-[35/45]"
                            onWheel={(e) => { e.preventDefault(); handleZoom(e.deltaY > 0 ? 0.95 : 1.05); }}
                        >
                            {isCam && <video ref={videoRef} autoPlay playsInline className="absolute inset-0 w-full h-full object-cover z-20 scale-x-[-1]" />}
                            <canvas ref={canvasRef} width={350} height={450} />
                            <div className="id-guide"></div>
                        </div>
                        
                        {/* æ‹ç…§/ä¸Šå‚³æŒ‰éˆ•åˆ—ï¼šæ²å‹•æ™‚æœƒéš±è—ä»¥ç¯€çœç©ºé–“ */}
                        {!scrolled && (
                            <div className="grid grid-cols-2 gap-3 mt-4 animate-in fade-in duration-500">
                                <button onClick={async () => {
                                    if (isCam) {
                                        const c = document.createElement('canvas'); c.width = videoRef.current.videoWidth; c.height = videoRef.current.videoHeight;
                                        const ctx = c.getContext('2d'); ctx.translate(c.width,0); ctx.scale(-1,1); ctx.drawImage(videoRef.current,0,0);
                                        const s = new Image(); s.onload = () => setImage(s); s.src = c.toDataURL();
                                        setIsCam(false); videoRef.current.srcObject.getTracks().forEach(t => t.stop());
                                    } else {
                                        setIsCam(true); const m = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } }); videoRef.current.srcObject = m;
                                    }
                                }} className="bg-slate-900 text-white py-3 rounded-2xl font-bold text-sm">ç›¸æ©Ÿ</button>
                                <label className="bg-white border-2 border-slate-900 py-3 rounded-2xl font-bold text-center cursor-pointer text-sm">ä¸Šå‚³ç…§ç‰‡<input type="file" className="hidden" onChange={e => { const f = e.target.files[0]; if (f) { const t = new Image(); t.onload = () => setImage(t); t.src = URL.createObjectURL(f); } }} /></label>
                            </div>
                        )}
                    </div>

                    {/* å³å´ï¼šæ“ä½œé¢æ¿ */}
                    <div className="flex-1 space-y-6">
                        <div className="bg-white p-6 md:p-8 rounded-[40px] shadow-sm border border-slate-100">
                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-6">èª¿æ•´å·¥å…·ç®±</h3>
                            
                            <div className="space-y-8">
                                {/* è¡£æœé¸æ“‡ */}
                                <div className="space-y-4">
                                    <div className="flex p-1 bg-slate-100 rounded-xl">
                                        <button onClick={() => setSuit({ ...suit, gender: 'male' })} className={`flex-1 py-2 text-xs font-bold rounded-lg ${suit.gender === 'male' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400'}`}>ç”·ä»•</button>
                                        <button onClick={() => setSuit({ ...suit, gender: 'female' })} className={`flex-1 py-2 text-xs font-bold rounded-lg ${suit.gender === 'female' ? 'bg-white shadow-sm text-pink-600' : 'text-slate-400'}`}>å¥³ä»•</button>
                                    </div>
                                    <div className="grid grid-cols-5 gap-2">
                                        {['m1','m2','m3','m4','m5'].map(n => {
                                            const id = suit.gender === 'male' ? n : n.replace('m','f');
                                            return (
                                                <div key={id} onClick={() => setSuit({ ...suit, id })} className={`p-1 rounded-lg border-2 cursor-pointer ${suit.id === id ? 'border-blue-500 bg-blue-50' : 'border-slate-50'}`}>
                                                    <img src={`clothes/${suit.gender}/${id}.png`} className="w-full h-8 object-contain" />
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* å³æ™‚æ‹‰æ¢å€ */}
                                <div className="space-y-6 border-t pt-6">
                                    <div className="group">
                                        <div className="flex justify-between mb-2">
                                            <label className="text-[10px] font-black text-slate-400 uppercase">äººåƒå¤§å°å¾®èª¿</label>
                                            <span className="text-[10px] font-bold text-blue-600">{(p.s * 100).toFixed(0)}%</span>
                                        </div>
                                        <input type="range" min="0.2" max="2.0" step="0.01" value={p.s} onChange={e => setP({ ...p, s: parseFloat(e.target.value) })} className="w-full h-2 bg-slate-100 rounded-lg appearance-none accent-blue-600 cursor-pointer" />
                                    </div>

                                    <div className="group">
                                        <div className="flex justify-between mb-2">
                                            <label className="text-[10px] font-black text-slate-400 uppercase">ä¸Šä¸‹ä½ç½®</label>
                                            <span className="text-[10px] font-bold text-blue-600">{p.y} px</span>
                                        </div>
                                        <input type="range" min="-200" max="200" value={p.y} onChange={e => setP({ ...p, y: parseInt(e.target.value) })} className="w-full h-2 bg-slate-100 rounded-lg appearance-none accent-blue-600 cursor-pointer" />
                                    </div>

                                    <div className="group">
                                        <div className="flex justify-between mb-2">
                                            <label className="text-[10px] font-black text-slate-400 uppercase">å·¦å³ä½ç½®</label>
                                            <span className="text-[10px] font-bold text-blue-600">{p.x} px</span>
                                        </div>
                                        <input type="range" min="-200" max="200" value={p.x} onChange={e => setP({ ...p, x: parseInt(e.target.value) })} className="w-full h-2 bg-slate-100 rounded-lg appearance-none accent-blue-600 cursor-pointer" />
                                    </div>
                                </div>

                                <button onClick={() => setSlots([...slots, canvasRef.current.toDataURL()])} className="w-full bg-blue-600 text-white py-4 rounded-[24px] font-black text-lg shadow-xl active:scale-95 transition-all">ğŸ“¥ å­˜å…¥æ’ç‰ˆæ§½</button>
                            </div>
                        </div>
                        
                        {/* ä¸‹è¼‰å€åŸŸ */}
                        <div className="bg-slate-900 p-8 rounded-[40px] text-white">
                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">æœ€å¾Œæ­¥é©Ÿ</h3>
                            <button onClick={() => {
                                if(slots.length === 0) return alert('è«‹å…ˆå­˜å…¥ç…§ç‰‡');
                                const pc = document.createElement('canvas'); pc.width = 1800; pc.height = 1200;
                                const ctx = pc.getContext('2d'); ctx.fillStyle = "white"; ctx.fillRect(0,0,1800,1200);
                                const drawRow = async () => {
                                    const imgs = await Promise.all(slots.map(src => new Promise(res => {const img = new Image(); img.onload=()=>res(img); img.src=src;})));
                                    for(let i=0; i<4; i++) ctx.drawImage(imgs[i%imgs.length], 80 + i*428, 80, 413, 531);
                                    for(let i=0; i<5; i++) ctx.drawImage(imgs[i%imgs.length], 80 + i*341, 650, 331, 449);
                                    const a = document.createElement('a'); a.download = `EzID_Layout.png`; a.href = pc.toDataURL(); a.click();
                                };
                                drawRow();
                            }} className="w-full bg-white text-slate-900 py-4 rounded-[20px] font-black text-lg active:scale-95 transition-all">ğŸ’¾ ä¸‹è¼‰ 4x6 æ‹¼ç‰ˆç…§ç‰‡</button>
                            <p className="text-[10px] text-slate-500 mt-4 text-center italic">æç¤ºï¼šå·²åŠ å…¥ç½®é ‚è§€æ™¯çª—ï¼Œæ‹‰å‹•æ»‘æ¡¿æ™‚å¯å³æ™‚æŸ¥çœ‹ä¸Šæ–¹ç…§ç‰‡è®ŠåŒ–ã€‚</p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
    </script>
</body>
</html>
