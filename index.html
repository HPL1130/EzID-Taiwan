<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.48.26 FINAL</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background: #020617; color: #f8fafc; margin: 0; }
        #root { width: 100%; max-width: 500px; margin: 0 auto; min-height: 100vh; padding: 15px; }
        .zone-box { background: rgba(30, 41, 59, 0.4); border-radius: 24px; border: 1px solid rgba(255,255,255,0.05); padding: 16px; margin-bottom: 12px; }
        .zone-tag { font-size: 10px; font-weight: 900; color: #3b82f6; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .stage-box { position: relative; width: 100%; aspect-ratio: 600/800; background: #fff; border-radius: 16px; overflow: hidden; touch-action: none; margin: 0 auto; }
        .canvas-wrapper { padding: 10px 45px; }
        .audit-fail { border: 4px solid #ef4444 !important; }
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect } = React;

// 1ï¸âƒ£ [MODULE] EZ_SPEC_ENGINE (æ ¸å¿ƒè¦æ ¼å®šç¾© - é–å®š 6 ç¨®ï¼Œä¿ç•™ MIX sections çµæ§‹)
const SPECS = {
    'A4-20':   { id: 'A4-20',   w: 2480, h: 3508, grid: [5, 4], size: [413, 531], count: 20, name: 'A4-2å‹(20å¼µ)', cat: 'A4' },
    'A4-42':   { id: 'A4-42',   w: 2480, h: 3508, grid: [7, 6], size: [295, 413], count: 42, name: 'A4-1å‹(42å¼µ)', cat: 'A4' },
    'A4-MIX':  { id: 'A4-MIX',  w: 2480, h: 3508, name: 'A4-1+2å‹(30å¼µ)', cat: 'A4', sections: [{ y: 0, grid: [3, 4], size: [413, 531], count: 12 }, { y: 1754, grid: [3, 6], size: [295, 413], count: 18 }] },
    '4x6-8':   { id: '4x6-8',   w: 1800, h: 1200, grid: [2, 4], size: [413, 531], count: 8, name: '4x6-2å‹(8å¼µ)', cat: '4x6' },
    '4x6-10':  { id: '4x6-10',  w: 1800, h: 1200, grid: [2, 5], size: [295, 413], count: 10, name: '4x6-1å‹(10å¼µ)', cat: '4x6' },
    '4x6-MIX': { id: '4x6-MIX', w: 1800, h: 1200, name: '4x6-2å‹(4)+1å‹(5)', cat: '4x6', sections: [{ y: 0, grid: [1, 4], size: [413, 531], count: 4 }, { y: 650, grid: [1, 5], size: [295, 413], count: 5 }] }
};

// 2ï¸âƒ£ [MODULE] EZ_ASSET_LOADER (ç·©å­˜é–å®š)
const AssetLoader = {
    cache: new Map(),
    async load(url) {
        if (this.cache.get(url)) return this.cache.get(url);
        return new Promise(res => {
            const img = new Image(); img.crossOrigin = "anonymous";
            img.onload = () => { this.cache.set(url, img); res(img); }; img.src = url;
        });
    }
};

// 3ï¸âƒ£ [MODULE] EZ_SAFETY_GUARD (è¼¸å‡ºæª¢æ ¸é‚è¼¯)
const SafetyGuard = {
    validate(l, type) {
        if (!l || !l.img) return false;
        const s = l.scenes[type];
        const h = l.img.height * s.s;
        const ratio = h / 800; 
        return ratio >= 0.52 && ratio <= 0.88;
    }
};

// 4ï¸âƒ£ [MODULE] EZ_CORE_RENDERER (Master 600x800 åº§æ¨™æ¸²æŸ“)
const CoreRenderer = {
    draw(ctx, img, sceneData, rect, hideGuides = false) {
        if (!ctx || !img) return;
        ctx.save();
        ctx.fillStyle = "#fff"; ctx.fillRect(rect.x, rect.y, rect.w, rect.h);
        const sc = rect.w / 600; 
        ctx.beginPath(); ctx.rect(rect.x, rect.y, rect.w, rect.h); ctx.clip();
        ctx.translate(rect.x + rect.w/2 + sceneData.x * sc, rect.y + rect.h/2 + sceneData.y * sc);
        ctx.scale(sceneData.s * sc, sceneData.s * sc);
        ctx.drawImage(img, -img.width/2, -img.height/2);
        ctx.restore();
        if (!hideGuides) {
            ctx.strokeStyle = "rgba(59, 130, 246, 0.4)"; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.ellipse(rect.x + rect.w/2, rect.y + rect.h * 0.42, rect.w * 0.28, rect.h * 0.32, 0, 0, Math.PI * 2); ctx.stroke();
        }
    }
};

// 5ï¸âƒ£ [MODULE] EZ_UI_STATE (é›™å ´æ™¯èˆ‡æ¨¡å¼é‚è¼¯)
function App() {
    const [ui, setUi] = useState({ spec: 'A4-MIX', results: null, mode: 'single', editType: '2inch' });
    const [scene, setScene] = useState({ 
        layers: [{ id: 1, scenes: { '1inch': {x:0,y:0,s:1}, '2inch': {x:0,y:0,s:1} }, img: null }], 
        activeId: 1 
    });
    const canvasRef = useRef(null);
    const pointer = useRef({ x: 0, y: 0, dist: 0 });

    const activeLayer = scene.layers.find(l => l.id === scene.activeId);
    const isMix = !!SPECS[ui.spec].sections;

    useEffect(() => {
        if (activeLayer?.img && canvasRef.current) {
            CoreRenderer.draw(canvasRef.current.getContext('2d'), activeLayer.img, activeLayer.scenes[ui.editType], {x:0, y:0, w:350, h:466});
        }
    }, [scene, ui.editType, ui.spec]);

    const handleFile = async (e) => {
        const f = e.target.files[0]; if(!f) return;
        const img = await AssetLoader.load(URL.createObjectURL(f));
        const sc = Math.max(600/img.width, 800/img.height) * 1.05;
        const newLayer = { id: Date.now(), img, scenes: { '1inch': {x:0,y:0,s:sc}, '2inch': {x:0,y:0,s:sc} } };
        if (ui.mode === 'single') setScene({ layers: [newLayer], activeId: newLayer.id });
        else setScene(s => ({ ...s, layers: [...s.layers.filter(l=>l.img), newLayer], activeId: newLayer.id }));
    };

    // 6ï¸âƒ£ [MODULE] EZ_EXPORT_MANAGER (è¨ˆæ•¸èˆ‡å°ºå¯¸éš”é›¢)
    const handleExport = async (isAll) => {
        const targets = isAll ? Object.keys(SPECS) : [ui.spec];
        const resList = [];
        const validLayers = scene.layers.filter(l => l.img);
        if (validLayers.length === 0) return alert("è«‹å…ˆä¸Šå‚³ç…§ç‰‡");
        const buf = document.createElement('canvas'); buf.width = 600; buf.height = 800;

        for (const sid of targets) {
            const s = SPECS[sid];
            const out = document.createElement('canvas'); out.width = s.w; out.height = s.h;
            const ctx = out.getContext('2d'); ctx.fillStyle = "#fff"; ctx.fillRect(0,0,s.w,s.h);
            
            let layerIdx = 0;
            let isValid = true;
            const sections = s.sections || [{ y:0, grid:s.grid, size:s.size, count:s.count }];
            
            sections.forEach(sec => {
                const type = (sec.size[0] < 350) ? '1inch' : '2inch';
                const rowH = (s.sections ? s.h/sections.length : s.h) / sec.grid[0];
                const colW = s.w / sec.grid[1];
                let printed = 0;
                for(let r=0; r<sec.grid[0]; r++) for(let c=0; c<sec.grid[1]; c++) {
                    if (printed >= sec.count) break;
                    const l = validLayers[layerIdx % validLayers.length];
                    if (!SafetyGuard.validate(l, type)) isValid = false;
                    CoreRenderer.draw(buf.getContext('2d'), l.img, l.scenes[type], {x:0, y:0, w:600, h:800}, true);
                    ctx.drawImage(buf, 0, 0, 600, 800, c * colW + (colW - sec.size[0])/2, (sec.y || 0) + r * rowH + (rowH - sec.size[1])/2, sec.size[0], sec.size[1]);
                    layerIdx++; printed++;
                }
            });
            resList.push({ url: out.toDataURL('image/jpeg', 0.95), name: s.name, valid: isValid });
        }
        setUi(u => ({...u, results: resList}));
    };

    return (
        <div className="flex flex-col gap-3 pb-24">
            <header className="flex justify-between items-center px-1">
                <h1 className="text-2xl font-black italic text-blue-500">EzID</h1>
                <div className="flex bg-slate-800 rounded-lg p-1">
                    <button onClick={()=>setUi(u=>({...u, mode:'single'}))} className={`px-4 py-1 text-[10px] rounded-md ${ui.mode==='single'?'bg-blue-600 text-white':'text-slate-400'}`}>å–®äºº</button>
                    <button onClick={()=>setUi(u=>({...u, mode:'multi'}))} className={`px-4 py-1 text-[10px] rounded-md ${ui.mode==='multi'?'bg-blue-600 text-white':'text-slate-400'}`}>å¤šäºº</button>
                </div>
            </header>

            <div className="zone-box">
                <div className="zone-tag">â¶ é¸æ“‡è¦æ ¼ (é–å®š 6 ç¨®)</div>
                <div className="grid grid-cols-2 gap-1">
                    {Object.values(SPECS).map(s=>(
                        <button key={s.id} onClick={()=>setUi(u=>({...u, spec:s.id, editType: s.id.includes('42') || s.id.includes('10') ? '1inch' : '2inch'}))} className={`px-2 py-3 rounded-lg text-[10px] text-left pl-3 ${ui.spec===s.id?'bg-blue-600 text-white shadow-lg':'bg-slate-800 text-slate-400'}`}>{s.name}</button>
                    ))}
                </div>
                {isMix && (
                    <div className="flex gap-2 mt-3 p-1 bg-black/20 rounded-xl">
                        <button onClick={()=>setUi(u=>({...u, editType:'2inch'}))} className={`flex-1 py-2 text-[10px] rounded-lg ${ui.editType==='2inch'?'bg-blue-500 text-white':'text-slate-500'}`}>ç·¨è¼¯ 2å‹</button>
                        <button onClick={()=>setUi(u=>({...u, editType:'1inch'}))} className={`flex-1 py-2 text-[10px] rounded-lg ${ui.editType==='1inch'?'bg-blue-500 text-white':'text-slate-500'}`}>ç·¨è¼¯ 1å‹</button>
                    </div>
                )}
            </div>

            <div className="canvas-wrapper">
                {activeLayer?.img ? (
                    <div className="stage-box" 
                        onTouchStart={e => { const t = e.touches; if(t.length===2) pointer.current.dist = Math.hypot(t[0].clientX-t[1].clientX, t[0].clientY-t[1].clientY); else { pointer.current.x = t[0].clientX; pointer.current.y = t[0].clientY; }}}
                        onTouchMove={e => {
                            const t = e.touches;
                            if(t.length===2) {
                                const d = Math.hypot(t[0].clientX-t[1].clientX, t[0].clientY-t[1].clientY);
                                const r = d / (pointer.current.dist || d); pointer.current.dist = d;
                                setScene(s => ({...s, layers: s.layers.map(l => l.id === s.activeId ? {...l, scenes: {...l.scenes, [ui.editType]: {...l.scenes[ui.editType], s: l.scenes[ui.editType].s * r}}} : l)}));
                            } else {
                                const dx = (t[0].clientX - pointer.current.x) * (600/350);
                                const dy = (t[0].clientY - pointer.current.y) * (800/466);
                                pointer.current.x = t[0].clientX; pointer.current.y = t[0].clientY;
                                setScene(s => ({...s, layers: s.layers.map(l => l.id === s.activeId ? {...l, scenes: {...l.scenes, [ui.editType]: {...l.scenes[ui.editType], x: l.scenes[ui.editType].x + dx, y: l.scenes[ui.editType].y + dy}}} : l)}));
                            }
                        }}>
                        <canvas ref={canvasRef} width="350" height="466" className="w-full h-full" />
                    </div>
                ) : (
                    <label className="stage-box flex flex-col items-center justify-center border-dashed border-2 border-slate-700 bg-slate-900/50 cursor-pointer">
                        <span className="text-4xl mb-2">ğŸ“¸</span>
                        <span className="text-[10px] text-slate-400 font-bold">é»æ“Šä¸Šå‚³ç…§ç‰‡</span>
                        <input type="file" hidden onChange={handleFile}/>
                    </label>
                )}
            </div>

            {ui.mode === 'multi' && (
                <div className="zone-box">
                    <div className="zone-tag">â· åœ–å±¤ç®¡ç†</div>
                    <div className="flex gap-2 overflow-x-auto pb-1">
                        {scene.layers.map(l => (
                            <button key={l.id} onClick={()=>setScene(s=>({...s, activeId:l.id}))} className={`w-14 h-14 rounded-xl border-2 shrink-0 ${scene.activeId===l.id?'border-blue-500 bg-blue-900/20':'border-slate-700'}`}>
                                {l.img ? <img src={l.img.src} className="w-full h-full object-cover rounded-lg"/> : <div className="flex items-center justify-center h-full text-[10px]">å¾…å‚³</div>}
                            </button>
                        ))}
                        <label className="w-14 h-14 bg-slate-800 rounded-xl flex items-center justify-center text-2xl shrink-0 cursor-pointer border-dashed border border-slate-600">+<input type="file" hidden onChange={handleFile}/></label>
                    </div>
                </div>
            )}
            
            <div className="grid grid-cols-2 gap-2 mt-4">
                <button onClick={()=>handleExport(false)} className="py-5 bg-blue-600 rounded-2xl font-black text-xs text-white shadow-lg">å–®è¦æ ¼è¼¸å‡º</button>
                <button onClick={()=>handleExport(true)} className="py-5 bg-orange-600 rounded-2xl font-black text-xs text-white shadow-lg">å…¨è¦æ ¼æ‰¹æ¬¡</button>
            </div>

            {ui.results && (
                <div className="fixed inset-0 bg-slate-950 z-[999] overflow-y-auto p-4">
                    {ui.results.map((r,i)=>(<div key={i} className={`mb-8 p-2 rounded-xl bg-slate-900 ${!r.valid ? 'audit-fail' : ''}`}><div className="text-[10px] mb-2 flex justify-between"><span>{r.name}</span>{!r.valid && <span className="text-red-500 font-bold">âš ï¸ æ¯”ä¾‹ä¸åˆæ ¼</span>}</div><img src={r.url} className="w-full rounded-lg shadow-2xl mb-2"/><a href={r.url} download={`${r.name}.jpg`} className="block text-center py-2 text-blue-400 text-sm underline font-bold">ä¸‹è¼‰æª”æ¡ˆ</a></div>))}
                    <button onClick={()=>setUi(u=>({...u, results:null}))} className="w-full py-4 bg-white text-black rounded-full font-black mt-4 mb-20">è¿”å›ç·¨è¼¯</button>
                </div>
            )}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
