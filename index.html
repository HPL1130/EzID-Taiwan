<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.47.53</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background: #020617; color: #f8fafc; margin: 0; overflow-x: hidden; touch-action: pan-y; }
        #root { width: 100%; max-width: 500px; margin: 0 auto; min-height: 100vh; padding: 15px; }
        .zone-box { background: rgba(30, 41, 59, 0.4); border-radius: 24px; border: 1px solid rgba(255,255,255,0.05); padding: 16px; margin-bottom: 12px; }
        .zone-tag { font-size: 10px; font-weight: 900; color: #3b82f6; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
        .stage-box { position: relative; width: 100%; aspect-ratio: 350/450; background: #fff; border-radius: 16px; overflow: hidden; touch-action: none; cursor: move; }
        .guide-circle { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 65%; border: 2px dashed rgba(59, 130, 246, 0.4); border-radius: 50%; pointer-events: none; z-index: 10; }
        .num-badge { position: absolute; top: -4px; left: -4px; background: #3b82f6; color: white; width: 18px; height: 18px; border-radius: 6px; font-size: 10px; font-weight: 900; display: flex; align-items: center; justify-content: center; border: 2px solid #020617; z-index: 20; }
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

// [Zone 1: è³‡æ–™å±¤] - 12ç¨®è¦æ ¼èˆ‡è¡£æœ (Cache é™é¡ 20)
const SPECS = {
    '4x6-8':   { id: '4x6-8',   w: 1800, h: 1200, grid: [2, 4], size: [413, 531], name: '2å‹(8å¼µ)', cat: '4x6' },
    '4x6-10':  { id: '4x6-10',  w: 1800, h: 1200, grid: [2, 5], size: [295, 413], name: '1å‹(10å¼µ)', cat: '4x6' },
    '4x6-12':  { id: '4x6-12',  w: 1800, h: 1200, grid: [3, 4], size: [295, 413], name: '1å‹(12å¼µ)', cat: '4x6' },
    '4x6-BIG': { id: '4x6-BIG', w: 1800, h: 1200, grid: [2, 3], size: [531, 708], name: 'å¤§é ­ç…§(6å¼µ)', cat: '4x6' },
    '4x6-MIX': { id: '4x6-MIX', w: 1800, h: 1200, name: '1+2å‹(8å¼µ)', cat: '4x6', sections: [{ x: 0, grid: [2, 2], size: [450, 600], count: 4, w: 900, h: 1200 }, { x: 900, grid: [2, 2], size: [413, 531], count: 4, w: 900, h: 1200 }] },
    '4x6-B':   { id: '4x6-B',   w: 1800, h: 1200, grid: [2, 4], size: [354, 472], name: 'Bç‰ˆ(8å¼µ)', cat: '4x6' },
    'A4-20':   { id: 'A4-20',   w: 2480, h: 3508, grid: [5, 4], size: [413, 531], name: 'A4-2å‹(20å¼µ)', cat: 'A4' },
    'A4-42':   { id: 'A4-42',   w: 2480, h: 3508, grid: [7, 6], size: [295, 413], name: 'A4-1å‹(42å¼µ)', cat: 'A4' },
    'A4-ID':   { id: 'A4-ID',   w: 2480, h: 3508, grid: [4, 4], size: [450, 600], name: 'A4-è­·ç…§(16å¼µ)', cat: 'A4' },
    'A4-BIG':  { id: 'A4-BIG',  w: 2480, h: 3508, grid: [4, 3], size: [531, 708], name: 'A4-å¤§é ­(12å¼µ)', cat: 'A4' },
    'A4-B':    { id: 'A4-B',    w: 2480, h: 3508, grid: [6, 5], size: [354, 472], name: 'A4-Bç‰ˆ(30å¼µ)', cat: 'A4' },
    'NAME':    { id: 'NAME',    w: 2480, h: 3508, grid: [6, 4], size: [295, 413], name: 'å·¥ç‰Œ(24å¼µ)', cat: 'A4' },
    'A4-MIX':  { id: 'A4-MIX',  w: 2480, h: 3508, name: 'A4-1+2å‹(30å¼µ)', cat: 'A4', sections: [{ y: 0, grid: [3, 4], size: [413, 531], count: 12, w: 2480, h: 1754 }, { y: 1754, grid: [3, 6], size: [295, 413], count: 18, w: 2480, h: 1754 }] }
};

const IMAGE_CACHE = new Map();
const SUITS = {
    female: Array.from({length: 5}, (_, i) => `https://raw.githubusercontent.com/HPL1130/EzID-Taiwan/main/clothes/female/f${i+1}.png`),
    male: Array.from({length: 5}, (_, i) => `https://raw.githubusercontent.com/HPL1130/EzID-Taiwan/main/clothes/male/m${i+1}.png`)
};

function App() {
    const cvsRef = useRef(null);
    // [æ•ˆèƒ½å„ªåŒ– 2.1]ï¼šé«˜é »ç‰©ç†ç‹€æ…‹å®Œå…¨è„«é›¢ React Stateï¼Œä½¿ç”¨ Ref é€²è¡Œå¹€åŒæ­¥
    const physics = useRef({
        photo: {x:0, y:0, s:0.5, f:1},
        suit: {x:0, y:80, s:0.8, f:1},
        active: 'photo'
    });
    const gest = useRef({ isDown: false, x: 0, y: 0, dist: 0, startS: 1 });
    const frameId = useRef(0);

    // [Zone 2: ç‹€æ…‹ç®¡ç†å±¤] - åªç•™ä½é » UI ç‹€æ…‹
    const [assets, setAssets] = useState({ img: null, suit: null });
    const [history, setHistory] = useState([]);
    const [ui, setUi] = useState({ cat: '4x6', spec: '4x6-8', mode: 'single', gender: 'female', results: null, target: 'photo' });

    // [Zone 3: ç¹ªåœ–å±¤] - Master æ¸²æŸ“é‚è¼¯
    const drawContent = (ctx, p, imgs, rect, baseW=350) => {
        const r = rect.w / baseW;
        ctx.save();
        ctx.beginPath(); ctx.rect(rect.x, rect.y, rect.w, rect.h); ctx.clip();
        // ç•«äººç‰©
        if(imgs.img) {
            const pp = p.photo;
            ctx.save();
            ctx.translate(rect.x + rect.w/2 + pp.x*r, rect.y + rect.h/2 + pp.y*r);
            ctx.scale(pp.s * r * pp.f, pp.s * r);
            ctx.drawImage(imgs.img, -imgs.img.width/2, -imgs.img.height/2);
            ctx.restore();
        }
        // ç•«è¡£æœ
        if(imgs.suit) {
            const sp = p.suit;
            ctx.save();
            ctx.translate(rect.x + rect.w/2 + sp.x*r, rect.y + rect.h/2 + sp.y*r);
            ctx.scale(sp.s * r, sp.s * r);
            ctx.drawImage(imgs.suit, -imgs.suit.width/2, -imgs.suit.height/2);
            ctx.restore();
        }
        ctx.restore();
    };

    const loop = useCallback(() => {
        if(!cvsRef.current) return;
        const ctx = cvsRef.current.getContext('2d', { alpha: false });
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, 350, 450);
        drawContent(ctx, physics.current, assets, {x:0, y:0, w:350, h:450});
        frameId.current = requestAnimationFrame(loop);
    }, [assets]);

    useEffect(() => {
        frameId.current = requestAnimationFrame(loop);
        return () => cancelAnimationFrame(frameId.current);
    }, [loop]);

    // [æ•ˆèƒ½å„ªåŒ– 2.2]ï¼šæ‰‹å‹¢ç§»å‹•å®Œå…¨ä¸è§¸ç™¼ setState
    const handleTouch = (e, type) => {
        if (e.cancelable) e.preventDefault();
        const pts = e.targetTouches;
        const tar = physics.current.active;
        if (type === 'start') {
            gest.current.isDown = true;
            if (pts.length >= 2) {
                gest.current.dist = Math.hypot(pts[0].clientX - pts[1].clientX, pts[0].clientY - pts[1].clientY);
                gest.current.startS = physics.current[tar].s;
            } else {
                gest.current.x = pts[0].clientX; gest.current.y = pts[0].clientY;
            }
        } else if (type === 'move' && gest.current.isDown) {
            if (pts.length >= 2) {
                const d = Math.hypot(pts[0].clientX - pts[1].clientX, pts[0].clientY - pts[1].clientY);
                physics.current[tar].s = Math.max(0.1, Math.min(3, gest.current.startS * (d / gest.current.dist)));
            } else {
                physics.current[tar].x += (pts[0].clientX - gest.current.x) / physics.current[tar].s;
                physics.current[tar].y += (pts[0].clientY - gest.current.y) / physics.current[tar].s;
                gest.current.x = pts[0].clientX; gest.current.y = pts[0].clientY;
            }
        } else { gest.current.isDown = false; }
    };

    // [Zone 4: è³‡æºç®¡ç†]
    const loadSafeImg = (url, cb) => {
        if (IMAGE_CACHE.has(url)) return cb(IMAGE_CACHE.get(url));
        if (IMAGE_CACHE.size > 20) IMAGE_CACHE.clear(); // [æ•ˆèƒ½å„ªåŒ– 3]ï¼šLRU-ish æ¸…ç†
        const i = new Image(); i.crossOrigin = "anonymous";
        i.onload = () => { IMAGE_CACHE.set(url, i); cb(i); };
        i.src = url;
    };

    const handleFile = (e) => {
        const f = e.target.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = (ev) => {
            const i = new Image(); i.onload = () => {
                setAssets(p => ({...p, img: i}));
                physics.current.photo = {x:0, y:0, s:0.5, f:1};
            }; i.src = ev.target.result;
        }; r.readAsDataURL(f);
    };

    const saveCache = () => {
        if(!assets.img) return;
        const snap = cvsRef.current.toDataURL('image/jpeg', 0.1);
        setHistory(prev => [...prev.slice(-11), { thumb: snap, assets: {...assets}, physics: JSON.parse(JSON.stringify(physics.current)), id: Date.now() }]);
    };

    // [Zone 5: è¼¸å‡ºå±¤] - [æ•ˆèƒ½å„ªåŒ– 5]ï¼šMaster-Slave è£åˆ‡æ¸²æŸ“
    const doExport = async (all) => {
        const list = all ? Object.keys(SPECS) : [ui.spec];
        const resList = [];
        
        // å»ºç«‹ä¸­é–“ Master Canvas æå‡è¤‡ç”¨ç‡
        const master = document.createElement('canvas');
        master.width = 600; master.height = 800;
        const mCtx = master.getContext('2d');

        for (const id of list) {
            await new Promise(r => setTimeout(r, 16));
            const s = SPECS[id];
            const c = document.createElement('canvas'); c.width = s.w; c.height = s.h;
            const ctx = c.getContext('2d'); ctx.fillStyle="white"; ctx.fillRect(0,0,s.w,s.h);
            
            const slots = s.sections ? s.sections.flatMap(sec => {
                const arr = [];
                const gx = ((sec.w||s.w)-sec.grid[1]*sec.size[0])/(sec.grid[1]+1), gy = ((sec.h||s.h)-sec.grid[0]*sec.size[1])/(sec.grid[0]+1);
                for(let r=0; r<sec.grid[0]; r++) for(let c=0; c<sec.grid[1]; c++) if(arr.length<sec.count) arr.push({x:(sec.x||0)+gx+c*(sec.size[0]+gx), y:(sec.y||0)+gy+r*(sec.size[1]+gy), w:sec.size[0], h:sec.size[1]});
                return arr;
            }) : (() => {
                const arr = [];
                const gx=(s.w-s.grid[1]*s.size[0])/(s.grid[1]+1), gy=(s.h-s.grid[0]*s.size[1])/(s.grid[0]+1);
                for(let r=0; r<s.grid[0]; r++) for(let c=0; c<s.grid[1]; c++) arr.push({x:gx+c*(s.size[0]+gx), y:gy+r*(s.size[1]+gy), w:s.size[0], h:s.size[1]});
                return arr;
            })();

            slots.forEach((rect, idx) => {
                const data = (ui.mode === 'multi' && history[idx]) ? history[idx] : { assets, physics: physics.current };
                // åˆ©ç”¨ Master ç·©å­˜ç¹ªè£½çµæœï¼Œé¿å…æ¯å€‹ slot éƒ½é‡ç®— transform
                mCtx.fillStyle="white"; mCtx.fillRect(0,0,600,800);
                drawContent(mCtx, data.physics, data.assets, {x:0, y:0, w:600, h:800}, 600);
                ctx.drawImage(master, 0, 0, 600, 800, rect.x, rect.y, rect.w, rect.h);
            });
            resList.push({ url: c.toDataURL('image/jpeg', 0.8), name: s.name, id });
        }
        setUi(u => ({...u, results: resList}));
    };

    // [Zone 6: ä»‹é¢]
    return (
        <div className="flex flex-col gap-3">
            <header className="flex justify-between items-center px-1">
                <h1 className="text-2xl font-black italic text-blue-500">EzID</h1>
                <span className="text-[10px] font-bold text-slate-500 bg-slate-800 px-2 py-1 rounded text-white">V20.47.53</span>
            </header>

            <div className="zone-box">
                <div className="zone-tag">ğŸ‘¥ æ¨¡å¼èˆ‡è¦æ ¼</div>
                <div className="flex gap-2 mb-3">
                    <button onClick={() => setUi(u => ({...u, mode: 'single'}))} className={`flex-1 py-3 rounded-2xl text-xs font-black ${ui.mode === 'single' ? 'bg-blue-600' : 'bg-slate-800 text-slate-500'}`}>å–®äººå¡«å……</button>
                    <button onClick={() => setUi(u => ({...u, mode: 'multi'}))} className={`flex-1 py-3 rounded-2xl text-xs font-black ${ui.mode === 'multi' ? 'bg-purple-600' : 'bg-slate-800 text-slate-500'}`}>å¤šäººæ‹¼è²¼</button>
                </div>
                <div className="flex gap-2 mb-3 border-t border-slate-700/50 pt-3">
                    {['4x6', 'A4'].map(c => (
                        <button key={c} onClick={() => setUi(u => ({...u, cat: c}))} className={`flex-1 py-2 rounded-xl text-xs font-black ${ui.cat === c ? 'bg-white text-black' : 'bg-slate-800 text-slate-500'}`}>{c}</button>
                    ))}
                </div>
                <div className="flex flex-wrap gap-1">
                    {Object.values(SPECS).filter(s => s.cat === ui.cat).map(s => (
                        <button key={s.id} onClick={() => setUi(u => ({...u, spec: s.id}))} className={`px-2 py-2.5 rounded-lg text-[10px] font-bold flex-1 min-w-[85px] ${ui.spec === s.id ? 'bg-blue-600' : 'bg-slate-800 text-slate-500'}`}>{s.name}</button>
                    ))}
                </div>
            </div>

            <div className="zone-box">
                <div className="zone-tag">ğŸ“¸ å½±åƒè¼‰å…¥èˆ‡æš«å­˜</div>
                <label className="block w-full py-4 bg-white text-black text-center rounded-2xl font-black text-xs cursor-pointer mb-3">é¸æ“‡ç›¸ç‰‡æª”æ¡ˆ<input type="file" hidden accept="image/*" onChange={handleFile}/></label>
                {ui.mode === 'multi' && (
                    <div className="space-y-3 pt-3 border-t border-slate-700/50">
                        <button onClick={saveCache} className="w-full py-4 bg-purple-600 rounded-2xl font-black text-xs">åŠ å…¥æš«å­˜æ§½</button>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar py-1">
                            {history.map((h, idx) => (
                                <div key={h.id} className="relative flex-shrink-0">
                                    <div className="num-badge">{idx + 1}</div>
                                    <img src={h.thumb} onClick={() => { setAssets(h.assets); physics.current = JSON.parse(JSON.stringify(h.physics)); }} className={`w-12 h-12 rounded-lg border-2 ${assets.img === h.assets.img ? 'border-blue-500' : 'border-slate-800'}`} />
                                </div>
                            ))}
                        </div>
                    </div>
                )}
            </div>

            <div className="zone-box">
                <div className="zone-tag">ğŸ•¹ï¸ ç•«é¢å¾®èª¿ (è„«é‰¤æ¸²æŸ“ç‰ˆ)</div>
                <div className="stage-box mb-4" 
                    onTouchStart={e => handleTouch(e, 'start')} onTouchMove={e => handleTouch(e, 'move')} onTouchEnd={e => handleTouch(e, 'end')}>
                    <canvas ref={cvsRef} width="350" height="450" className="w-full h-full" />
                    <div className="guide-circle"></div>
                </div>
                <div className="flex gap-2 mb-3">
                    <button onClick={() => { physics.current.active='photo'; setUi(u=>({...u, target:'photo'})); }} className={`flex-1 py-3 rounded-xl text-[10px] font-black ${ui.target === 'photo' ? 'bg-blue-600' : 'bg-slate-800 text-slate-500'}`}>æ§åˆ¶äººç‰©</button>
                    <button onClick={() => { physics.current.active='suit'; setUi(u=>({...u, target:'suit'})); }} className={`flex-1 py-3 rounded-xl text-[10px] font-black ${ui.target === 'suit' ? 'bg-blue-600' : 'bg-slate-800 text-slate-500'}`}>æ§åˆ¶è¡£æœ</button>
                </div>
                <div className="flex gap-2 mb-3">
                    <button onClick={() => setUi(u => ({...u, gender: 'female'}))} className={`flex-1 py-2 rounded-lg text-[10px] font-bold ${ui.gender === 'female' ? 'bg-indigo-600' : 'bg-slate-800 text-slate-500'}`}>å¥³è£</button>
                    <button onClick={() => setUi(u => ({...u, gender: 'male'}))} className={`flex-1 py-2 rounded-lg text-[10px] font-bold ${ui.gender === 'male' ? 'bg-indigo-600' : 'bg-slate-800 text-slate-500'}`}>ç”·è£</button>
                </div>
                <div className="flex gap-2 overflow-x-auto no-scrollbar">
                    <button onClick={() => setAssets(a => ({...a, suit: null}))} className="px-3 bg-red-900/20 text-red-500 rounded-lg flex-shrink-0 text-[10px] font-bold">ç§»é™¤è¡£æœ</button>
                    {SUITS[ui.gender].map(url => (
                        <img key={url} src={url} onClick={() => loadSafeImg(url, (img) => setAssets(p => ({...p, suit: img})))} className="w-10 h-10 bg-white rounded-lg p-1 flex-shrink-0 border border-slate-700" />
                    ))}
                </div>
            </div>

            <div className="grid grid-cols-2 gap-2 mb-10">
                <button onClick={() => doExport(false)} className="py-5 bg-blue-600 rounded-2xl font-black text-xs">å°å‡ºç›®å‰å°ºå¯¸</button>
                <button onClick={() => doExport(true)} className="py-5 bg-orange-600 rounded-2xl font-black text-xs">12ç¨®å…¨å°å‡º</button>
            </div>

            {ui.results && (
                <div className="fixed inset-0 bg-slate-950 z-[999] overflow-y-auto p-4 pb-24">
                    {ui.results.map((r, i) => (
                        <div key={i} className="mb-6 bg-slate-900 p-4 rounded-3xl border border-slate-800">
                            <p className="text-[10px] text-slate-500 font-bold mb-2 ml-1">{r.name}</p>
                            <img src={r.url} className="w-full rounded-xl mb-3 shadow-2xl" />
                            <a href={r.url} download={`EzID_${r.id}.jpg`} className="block w-full py-4 bg-blue-600 text-center rounded-2xl text-xs font-black shadow-lg">ä¸‹è¼‰å„²å­˜</a>
                        </div>
                    ))}
                    <button onClick={() => setUi(u => ({...u, results: null}))} className="fixed bottom-6 left-1/2 -translate-x-1/2 w-48 py-4 bg-white text-black rounded-full font-black shadow-2xl">è¿”å›ç·¨è¼¯</button>
                </div>
            )}
        </div>
    );
}
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
