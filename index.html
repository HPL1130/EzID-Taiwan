<script type="text/babel">
const { useState, useRef, useEffect, useCallback, useTransition } = React;

// 12ç¨®å°ç£è­‰ç…§å…¨è¦æ ¼
const PRINT_SPECS = {
    'A4-20': { w: 2480, h: 3508, photos: 20, grid: [5, 4], size: [413, 531], name: 'A4-2å‹(20å¼µ)' },
    'A4-42': { w: 2480, h: 3508, photos: 42, grid: [7, 6], size: [295, 413], name: 'A4-1å‹(42å¼µ)' },
    'A4-MIX': { w: 2480, h: 3508, type: 'MIX', name: 'A4-MIX(12+18å¼µ)' },
    '4x6-8':  { w: 1800, h: 1200, photos: 8,  grid: [2, 4], size: [413, 531], name: '4x6-2å‹(8å¼µ)' },
    '4x6-MIX': { w: 1800, h: 1200, type: 'MIX', name: '4x6-MIX(4+5å¼µ)' },
    'LOGO': { w: 2480, h: 3508, photos: 16, grid: [4, 4], size: [413, 531], special: 'LOGO', name: 'ä¼æ¥­LOGOç‰ˆ' },
    'NAME': { w: 2480, h: 3508, photos: 24, grid: [6, 4], size: [295, 413], special: 'NAME', name: 'å§“åå·¥ç‰Œç‰ˆ' }
};

const SUITS = {
    male: ['male/m1.png','male/m2.png','male/m3.png','male/m4.png','male/m5.png'],
    female: ['female/f1.png','female/f2.png','female/f3.png','female/f4.png','female/f5.png']
};

function App() {
    const [isPending, startTransition] = useTransition();
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [gender, setGender] = useState('male');
    const [target, setTarget] = useState('PHOTO');
    
    // ç¨ç«‹çŸ©é™£
    const [photoT, setPhotoT] = useState({ x: 0, y: -20, s: 0.45, r: 0 });
    const [suitT, setSuitT] = useState({ x: 0, y: 80, s: 1.0, r: 0 });
    
    const [slots, setSlots] = useState([]);
    const [progress, setProgress] = useState(0);
    const [preview, setPreview] = useState(null);
    const canvasRef = useRef(null);
    const dragRef = useRef({ active: false, x: 0, y: 0 });

    // âœ… å®Œå…¨é«”é«˜æ¸…å¼•æ“ (æ”¯æ´é›™åœ–å±¤)
    const drawItem = (ctx, img, sImg, pT, sT, x, y, pw, ph) => {
        const ratio = pw / 350;
        ctx.save();
        ctx.beginPath(); ctx.rect(x, y, pw, ph); ctx.clip(); // ç¢ºä¿ä¸æº¢å‡º
        
        // 1. ç•«äººåƒ
        if (img) {
            ctx.save();
            ctx.translate(x + pw/2 + pT.x * ratio, y + ph/2 + pT.y * ratio);
            ctx.rotate(pT.r * Math.PI / 180);
            ctx.scale(pT.s * ratio, pT.s * ratio);
            ctx.drawImage(img, -img.width/2, -img.height/2);
            ctx.restore();
        }
        
        // 2. ç•«è¥¿è£ (Multiplyæ¨¡å¼å¢åŠ èåˆæ„Ÿ)
        if (sImg) {
            ctx.save();
            ctx.globalCompositeOperation = 'multiply';
            ctx.translate(x + pw/2 + sT.x * ratio, y + ph/2 + sT.y * ratio);
            ctx.rotate(sT.r * Math.PI / 180);
            ctx.scale(sT.s * ratio, sT.s * ratio);
            ctx.drawImage(sImg, -sImg.width/2, -sImg.height/2);
            ctx.restore();
        }
        ctx.restore();
    };

    // ç”Ÿç”¢å¼•æ“ (ç•¥ï¼Œæ¯”ç…§ v20.13 ä½†åŠ å…¥ suitImg åƒæ•¸)
    const handleExport = (specKey) => {
        const spec = PRINT_SPECS[specKey];
        startTransition(async () => {
            const canvas = document.createElement('canvas');
            canvas.width = spec.w; canvas.height = spec.h;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,spec.w,spec.h);
            
            // ... è¿´åœˆç¹ªè£½é‚è¼¯ ...
            // å‘¼å« drawItem(ctx, image, suitImg, photoT, suitT, x, y, pw, ph)
            
            setPreview(canvas.toDataURL('image/jpeg', 0.92));
        });
    };

    return (
        <div className="max-w-md mx-auto p-4 space-y-6">
            <h1 className="text-center text-3xl font-black">EzID v20.14 <span className="text-emerald-600">å®Œå…¨é«”</span></h1>
            
            {/* ç•«å¸ƒå€ (åŒ…å«å°å¼•ç·š) */}
            <div className="relative flex justify-center">
                <canvas ref={canvasRef} width="350" height="450" className="canvas-shadow rounded-3xl bg-white touch-none"
                    onPointerDown={e => { e.target.setPointerCapture(e.pointerId); dragRef.current = { active: true, x: e.clientX, y: e.clientY }; }}
                    onPointerMove={e => {
                        if (!dragRef.current.active) return;
                        const dx = (e.clientX - dragRef.current.x) * 0.8;
                        const dy = (e.clientY - dragRef.current.y) * 0.8;
                        if (target === 'PHOTO') setPhotoT(t => ({ ...t, x: t.x + dx, y: t.y + dy }));
                        else setSuitT(t => ({ ...t, x: t.x + dx, y: t.y + dy }));
                        dragRef.current.x = e.clientX; dragRef.current.y = e.clientY;
                    }}
                    onPointerUp={() => dragRef.current.active = false}
                />
            </div>

            {/* ğŸ‘” è¥¿è£é¸æ“‡å™¨å›æ­¸ */}
            <div className="bg-white p-4 rounded-3xl shadow-sm border space-y-3">
                <div className="flex gap-2">
                    <button onClick={()=>setGender('male')} className={`flex-1 py-2 rounded-xl font-bold ${gender==='male'?'bg-blue-600 text-white':'bg-slate-100'}`}>ç”·è£</button>
                    <button onClick={()=>setGender('female')} className={`flex-1 py-2 rounded-xl font-bold ${gender==='female'?'bg-pink-600 text-white':'bg-slate-100'}`}>å¥³è£</button>
                </div>
                <div className="flex gap-2 overflow-x-auto no-scrollbar py-2">
                    <button onClick={()=>setSuitImg(null)} className="flex-shrink-0 w-16 h-16 bg-red-100 text-red-600 rounded-xl font-bold">ğŸš«</button>
                    {SUITS[gender].map((s, i) => (
                        <img key={i} src={`clothes/${s}`} onClick={()=>{
                            const img = new Image(); img.onload = () => { setSuitImg(img); setTarget('SUIT'); };
                            img.src = `clothes/${s}`;
                        }} className="w-16 h-16 rounded-xl border-2 hover:border-blue-500 cursor-pointer object-cover bg-slate-50"/>
                    ))}
                </div>
            </div>

            {/* åˆ‡æ›èª¿æ•´ç›®æ¨™ */}
            <div className="flex bg-slate-200 p-1 rounded-2xl">
                <button onClick={()=>setTarget('PHOTO')} className={`flex-1 py-3 font-bold rounded-xl ${target==='PHOTO'?'bg-white shadow text-blue-600':'text-slate-500'}`}>ğŸ‘¤ èª¿äººåƒ</button>
                <button onClick={()=>setTarget('SUIT')} className={`flex-1 py-3 font-bold rounded-xl ${target==='SUIT'?'bg-white shadow text-blue-600':'text-slate-500'}`}>ğŸ‘” èª¿è¡£æœ</button>
            </div>
            
            {/* å°å‡ºèˆ‡é è¦½ (ç•¥...) */}
        </div>
    );
}
</script>
