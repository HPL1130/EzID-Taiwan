<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.47.5</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face { font-family: 'NotoSansTC'; src: local('Microsoft JhengHei'); font-weight: 700; }
        body { 
            font-family: 'NotoSansTC', sans-serif; 
            background: #1a1c1e; /* æ”¹ç‚ºæº«å’Œçš„æ·±é‹ç°è‰² */
            color: #e2e8f0; 
            margin: 0; 
            display: flex;
            justify-content: center;
        }
        #root { width: 100%; max-width: 500px; }
        .editor-stage { 
            position: relative; 
            width: 100%; 
            aspect-ratio: 350/450; 
            background: #ffffff; 
            border-radius: 16px; 
            overflow: hidden; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            touch-action: none; 
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* å¢åŠ æŒ‰éˆ•é»æ“Šæ„Ÿ */
        button:active { transform: scale(0.96); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        const SPECS = {
            'A4-20':   { id: 'A4-20',   w: 2480, h: 3508, grid: [5, 4], size: [413, 531], name: 'A4 2å‹(20)' },
            'A4-42':   { id: 'A4-42',   w: 2480, h: 3508, grid: [7, 6], size: [295, 413], name: 'A4 1å‹(42)' },
            'A4-ID':   { id: 'A4-ID',   w: 2480, h: 3508, grid: [4, 4], size: [450, 600], name: 'A4 è­·ç…§(16)' },
            'A4-BIG':  { id: 'A4-BIG',  w: 2480, h: 3508, grid: [4, 3], size: [531, 708], name: 'A4 å¤§é ­(12)' },
            'A4-B':    { id: 'A4-B',    w: 2480, h: 3508, grid: [6, 5], size: [354, 472], name: 'A4 Bç‰ˆ(30)' },
            'NAME':    { id: 'NAME',    w: 2480, h: 3508, grid: [6, 4], size: [295, 413], name: 'å·¥ç‰Œ(24)' },
            '4x6-8':   { id: '4x6-8',   w: 1800, h: 1200, grid: [2, 4], size: [413, 531], name: '4x6 2å‹(8)' },
            '4x6-10':  { id: '4x6-10',  w: 1800, h: 1200, grid: [2, 5], size: [295, 413], name: '4x6 1å‹(10)' },
            '4x6-12':  { id: '4x6-12',  w: 1800, h: 1200, grid: [3, 4], size: [295, 413], name: '4x6 1å‹(12)' },
            '4x6-BIG': { id: '4x6-BIG', w: 1800, h: 1200, grid: [2, 3], size: [531, 708], name: '4x6 å¤§é ­(6)' },
            'A4-MIX':  { 
                id: 'A4-MIX', w: 2480, h: 3508, name: 'A4 ç¶œåˆ',
                sections: [
                    { x: 0, y: 0,    w: 2480, h: 1754, grid: [3, 4], size: [413, 531], count: 12 },
                    { x: 0, y: 1754, w: 2480, h: 1754, grid: [3, 6], size: [295, 413], count: 18 }
                ]
            },
            '4x6-MIX': { 
                id: '4x6-MIX', w: 1800, h: 1200, name: '4x6 ç¶œåˆ',
                sections: [
                    { x: 0,   y: 0, w: 900, h: 1200, grid: [2, 2], size: [450, 600], count: 4 },
                    { x: 900, y: 0, w: 900, h: 1200, grid: [2, 2], size: [413, 531], count: 4 }
                ]
            }
        };

        const Renderer = {
            calculateLayout: (spec) => {
                const getGrid = (w, h, grid, size, ox, oy) => {
                    const [rows, cols] = grid, [pw, ph] = size;
                    const mx = (w - cols * pw) / (cols + 1), my = (h - rows * ph) / (rows + 1);
                    return Array.from({ length: rows * cols }, (_, i) => ({
                        x: ox + mx + (i % cols) * (pw + mx),
                        y: oy + my + Math.floor(i / cols) * (ph + my),
                        w: pw, h: ph
                    }));
                };
                return spec.sections 
                    ? spec.sections.flatMap(s => getGrid(s.w, s.h, s.grid, s.size, s.x, s.y).slice(0, s.count))
                    : getGrid(spec.w, spec.h, spec.grid, spec.size, 0, 0);
            },
            drawLayer: (ctx, img, transform, rect, baseWidth = 350) => {
                if (!img) return;
                const ratio = rect.w / baseWidth;
                const { x, y, s, r, f } = transform;
                ctx.save();
                ctx.translate(rect.x + rect.w / 2 + x * ratio, rect.y + rect.h / 2 + y * ratio);
                ctx.rotate((r * Math.PI) / 180);
                ctx.scale(s * ratio * (f === 0 ? 1 : f), s * ratio);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);
                ctx.restore();
            }
        };

        function App() {
            const [params, setParams] = useState({
                photo: { x: 0, y: 0, s: 0.5, r: 0, f: 1 },
                suit: { x: 0, y: 50, s: 1, r: 0, f: 1 }
            });
            const [assets, setAssets] = useState({ img: null, suit: null });
            const [history, setHistory] = useState([]);
            const [ui, setUi] = useState({ target: 'photo', activeSpec: 'A4-20', loading: false, results: null });

            const canvasRef = useRef(null);
            const dragRef = useRef({ isDragging: false, lastX: 0, lastY: 0 });
            const requestRef = useRef();

            const renderPreview = useCallback(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = "#fff";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                const rect = { x: 0, y: 0, w: 350, h: 450 };
                Renderer.drawLayer(ctx, assets.img, params.photo, rect);
                Renderer.drawLayer(ctx, assets.suit, params.suit, rect);
                requestRef.current = requestAnimationFrame(renderPreview);
            }, [assets, params]);

            useEffect(() => {
                requestRef.current = requestAnimationFrame(renderPreview);
                return () => cancelAnimationFrame(requestRef.current);
            }, [renderPreview]);

            const runExport = async (all = false) => {
                if (!assets.img) return;
                setUi(p => ({ ...p, loading: true }));
                const targetSpecs = all ? Object.keys(SPECS) : [ui.activeSpec];
                const pool = history.length > 0 ? history : [{ assets, params }];
                const outputs = [];
                for (const specId of targetSpecs) {
                    const spec = SPECS[specId];
                    const outCanvas = document.createElement('canvas');
                    outCanvas.width = spec.w; outCanvas.height = spec.h;
                    const outCtx = outCanvas.getContext('2d');
                    outCtx.fillStyle = "white"; outCtx.fillRect(0, 0, spec.w, spec.h);
                    Renderer.calculateLayout(spec).forEach((rect, i) => {
                        const item = pool[i % pool.length];
                        Renderer.drawLayer(outCtx, item.assets.img, item.params.photo, rect);
                        Renderer.drawLayer(outCtx, item.assets.suit, item.params.suit, rect);
                    });
                    outputs.push({ id: specId, name: spec.name, url: outCanvas.toDataURL('image/jpeg', 0.85) });
                    await new Promise(r => setTimeout(r, 16));
                }
                setUi(p => ({ ...p, results: outputs, loading: false }));
            };

            return (
                <div className="w-full flex flex-col p-4 gap-4 pb-20">
                    <header className="flex justify-between items-center py-2">
                        <h1 className="text-xl font-black text-blue-400 italic">EzID <span className="text-slate-500 text-xs not-italic font-mono">v20.47.5</span></h1>
                        <div className="px-2 py-1 bg-slate-800 rounded text-[10px] text-slate-400 font-mono">MOBILE OPTIMIZED</div>
                    </header>

                    <div className="editor-stage"
                         onPointerDown={e => {
                             dragRef.current = { isDragging: true, lastX: e.clientX, lastY: e.clientY };
                             e.target.setPointerCapture(e.pointerId);
                         }}
                         onPointerMove={e => {
                             if (!dragRef.current.isDragging) return;
                             const dx = (e.clientX - dragRef.current.lastX) / params[ui.target].s;
                             const dy = (e.clientY - dragRef.current.lastY) / params[ui.target].s;
                             setParams(p => ({ ...p, [ui.target]: { ...p[ui.target], x: p[ui.target].x + dx, y: p[ui.target].y + dy } }));
                             dragRef.current.lastX = e.clientX; dragRef.current.lastY = e.clientY;
                         }}
                         onPointerUp={e => { dragRef.current.isDragging = false; e.target.releasePointerCapture(e.pointerId); }}>
                        <canvas ref={canvasRef} width="350" height="450" className="w-full h-full" />
                        {ui.loading && <div className="absolute inset-0 bg-black/60 flex items-center justify-center backdrop-blur-sm z-10"><div className="w-6 h-6 border-2 border-blue-400 border-t-transparent rounded-full animate-spin"></div></div>}
                    </div>

                    <div className="flex gap-2 p-1 bg-slate-800/50 rounded-xl">
                        {['photo', 'suit'].map(t => (
                            <button key={t} onClick={() => setUi(p => ({ ...p, target: t }))}
                                className={`flex-1 py-3 rounded-lg text-xs font-bold transition-all ${ui.target === t ? 'bg-blue-500 text-white' : 'text-slate-500'}`}>
                                {t === 'photo' ? 'ç…§ç‰‡å±¤' : 'æ­£è£å±¤'}
                            </button>
                        ))}
                    </div>

                    <div className="bg-slate-800/30 p-4 rounded-2xl border border-white/5 space-y-4">
                        <input type="range" className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none accent-blue-500" 
                               min="0.01" max="3" step="0.01" value={params[ui.target].s}
                               onChange={e => setParams(p => ({ ...p, [ui.target]: { ...p[ui.target], s: parseFloat(e.target.value) } }))} />
                        <div className="flex gap-2">
                            <button onClick={() => setParams(p => ({ ...p, [ui.target]: { ...p[ui.target], r: p[ui.target].r + 90 } }))} className="flex-1 py-3 bg-slate-800 rounded-xl text-[10px] font-bold">æ—‹è½‰ 90Â°</button>
                            <button onClick={() => setParams(p => ({ ...p, [ui.target]: { ...p[ui.target], f: p[ui.target].f * -1 } }))} className="flex-1 py-3 bg-slate-800 rounded-xl text-[10px] font-bold">é¡åƒç¿»è½‰</button>
                        </div>
                    </div>

                    <div className="grid grid-cols-3 gap-2 overflow-x-auto no-scrollbar py-1">
                        {Object.keys(SPECS).map(id => (
                            <button key={id} onClick={() => setUi(p => ({ ...p, activeSpec: id }))}
                                className={`py-2 px-1 text-[9px] font-bold rounded-lg border whitespace-nowrap transition-all ${ui.activeSpec === id ? 'border-blue-500 text-blue-400 bg-blue-500/10' : 'border-transparent bg-slate-800 text-slate-500'}`}>
                                {SPECS[id].name}
                            </button>
                        ))}
                    </div>

                    <div className="flex flex-col gap-2">
                        <div className="flex gap-2">
                            <label className="flex-1 py-4 bg-slate-700/50 rounded-xl text-center text-[11px] font-bold cursor-pointer">ğŸ“¸ è¼‰å…¥ç…§ç‰‡<input type="file" hidden onChange={e => {
                                const f = e.target.files[0]; if (f) { const i = new Image(); i.onload = () => setAssets(p => ({ ...p, img: i })); i.src = URL.createObjectURL(f); }
                            }} /></label>
                            <button onClick={() => { if (assets.img) setHistory(p => [...p, { assets: { ...assets }, params: { ...params } }]); }} 
                                className="flex-1 py-4 bg-slate-700/50 rounded-xl text-[11px] font-bold">ğŸ’¾ å¿«ç…§ ({history.length})</button>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => runExport(false)} className="flex-[2] py-4 bg-blue-600 rounded-xl text-[11px] font-bold">å°å‡ºç•¶å‰è¦æ ¼</button>
                            <button onClick={() => runExport(true)} className="flex-1 py-4 bg-emerald-600 rounded-xl text-[11px] font-bold">ğŸ”¥ æ‰¹æ¬¡</button>
                        </div>
                    </div>

                    {ui.results && (
                        <div className="fixed inset-0 bg-slate-900/fb z-50 overflow-y-auto p-4 backdrop-blur-md">
                            <div className="flex flex-col gap-6 py-8">
                                <h2 className="text-lg font-black text-center text-blue-400">ç”Ÿæˆå®Œç•¢</h2>
                                {ui.results.map((res, i) => (
                                    <div key={i} className="bg-slate-800 p-4 rounded-2xl border border-white/5 space-y-3">
                                        <div className="flex justify-between text-[10px] font-mono text-slate-500 uppercase"><span>{res.id}</span><span>{res.name}</span></div>
                                        <img src={res.url} className="w-full rounded-lg shadow-xl" />
                                        <a href={res.url} download={`${res.id}.jpg`} className="block w-full py-3 bg-blue-500 rounded-lg text-center text-xs font-bold">ä¸‹è¼‰ JPEG</a>
                                    </div>
                                ))}
                                <button onClick={() => setUi(p => ({ ...p, results: null }))} className="w-full py-4 bg-white text-black rounded-xl font-bold">è¿”å›ç·¨è¼¯</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
