<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.47.27</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background: #020617; color: #f8fafc; margin: 0; }
        #root { width: 100%; max-width: 500px; margin: 0 auto; min-height: 100vh; padding: 20px; }
        .stage-box { position: relative; width: 100%; aspect-ratio: 350/450; background: #fff; border-radius: 24px; overflow: hidden; touch-action: none; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .cache-card { position: relative; flex: 0 0 90px; height: 120px; border-radius: 12px; border: 2px solid #1e293b; background: #1e293b; transition: 0.2s; overflow: hidden; }
        .cache-card.active { border-color: #3b82f6; transform: translateY(-5px); }
        .del-x { position: absolute; top: 4px; right: 4px; width: 20px; height: 20px; background: #ef4444; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 900; z-index: 20; cursor: pointer; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useMemo } = React;

const SPECS = {
    '4x6-8':   { id: '4x6-8',   w: 1800, h: 1200, grid: [2, 4], size: [413, 531], name: '2å‹(8)', cat: '4x6' },
    '4x6-10':  { id: '4x6-10',  w: 1800, h: 1200, grid: [2, 5], size: [295, 413], name: '1å‹(10)', cat: '4x6' },
    '4x6-12':  { id: '4x6-12',  w: 1800, h: 1200, grid: [3, 4], size: [295, 413], name: '1å‹(12)', cat: '4x6' },
    '4x6-BIG': { id: '4x6-BIG', w: 1800, h: 1200, grid: [2, 3], size: [531, 708], name: 'å¤§é ­(6)', cat: '4x6' },
    '4x6-MIX': { id: '4x6-MIX', w: 1800, h: 1200, name: 'ç¶œåˆ(8)', cat: '4x6', sections: [{ x: 0, grid: [2, 2], size: [450, 600], count: 4, w: 900, h: 1200 }, { x: 900, grid: [2, 2], size: [413, 531], count: 4, w: 900, h: 1200 }] },
    'A4-20':   { id: 'A4-20',   w: 2480, h: 3508, grid: [5, 4], size: [413, 531], name: '2å‹(20)', cat: 'A4' },
    'A4-42':   { id: 'A4-42',   w: 2480, h: 3508, grid: [7, 6], size: [295, 413], name: '1å‹(42)', cat: 'A4' },
    'A4-ID':   { id: 'A4-ID',   w: 2480, h: 3508, grid: [4, 4], size: [450, 600], name: 'è­·ç…§(16)', cat: 'A4' },
    'A4-BIG':  { id: 'A4-BIG',  w: 2480, h: 3508, grid: [4, 3], size: [531, 708], name: 'å¤§é ­(12)', cat: 'A4' },
    'A4-B':    { id: 'A4-B',    w: 2480, h: 3508, grid: [6, 5], size: [354, 472], name: 'Bç‰ˆ(30)', cat: 'A4' },
    'NAME':    { id: 'NAME',    w: 2480, h: 3508, grid: [6, 4], size: [295, 413], name: 'å·¥ç‰Œ(24)', cat: 'A4' },
    'A4-MIX':  { id: 'A4-MIX',  w: 2480, h: 3508, name: 'ç¶œåˆ(30)', cat: 'A4', sections: [{ y: 0, grid: [3, 4], size: [413, 531], count: 12, w: 2480, h: 1754 }, { y: 1754, grid: [3, 6], size: [295, 413], count: 18, w: 2480, h: 1754 }] }
};

const SUITS = {
    female: Array.from({length: 5}, (_, i) => `https://raw.githubusercontent.com/HPL1130/EzID-Taiwan/main/clothes/female/f${i+1}.png`),
    male: Array.from({length: 5}, (_, i) => `https://raw.githubusercontent.com/HPL1130/EzID-Taiwan/main/clothes/male/m${i+1}.png`)
};

const Renderer = {
    draw: (ctx, img, t, rect, baseW = 350) => {
        if (!img) return;
        const r = rect.w / baseW;
        ctx.save();
        ctx.beginPath(); ctx.rect(rect.x, rect.y, rect.w, rect.h); ctx.clip();
        ctx.translate(rect.x + rect.w/2 + t.x * r, rect.y + rect.h/2 + t.y * r);
        ctx.rotate(t.r * Math.PI / 180);
        ctx.scale(t.s * r * (t.f || 1), t.s * r);
        ctx.drawImage(img, -img.width/2, -img.height/2);
        ctx.restore();
    },
    getLayout: (s) => {
        const grid = (w, h, g, sz, ox=0, oy=0, lim=99) => {
            const slots = [];
            const gapX = (w - g[1]*sz[0])/(g[1]+1), gapY = (h - g[0]*sz[1])/(g[0]+1);
            for(let r=0; r<g[0]; r++) for(let c=0; c<g[1]; c++) {
                if(slots.length < lim) slots.push({x: ox+gapX+c*(sz[0]+gapX), y: oy+gapY+r*(sz[1]+gapY), w: sz[0], h: sz[1]});
            }
            return slots;
        };
        return s.sections ? s.sections.flatMap(sec => grid(sec.w||s.w, sec.h||s.h, sec.grid, sec.size, sec.x||0, sec.y||0, sec.count)) : grid(s.w, s.h, s.grid, s.size);
    }
};

function App() {
    const cvsRef = useRef(null);
    const [history, setHistory] = useState([]); // å­˜å„²æˆå“èˆ‡ç‹€æ…‹
    const [assets, setAssets] = useState({ img: null, suit: null });
    const [params, setParams] = useState({ photo: { x: 0, y: 0, s: 0.5, r: 0, f: 1 }, suit: { x: 0, y: 80, s: 0.8, r: 0, f: 1 } });
    const [ui, setUi] = useState({ target: 'photo', spec: '4x6-8', gender: 'female', activeSuit: null, results: null });
    const drag = useRef({ active: false, x: 0, y: 0 });

    /* è‡ªæª¢é˜²ç¦¦ */
    useEffect(() => {
        if (Object.keys(SPECS).length !== 12) console.error("å¥‘ç´„å¤±æ•ˆ: è¦æ ¼ç¼ºå¤±");
    }, []);

    useEffect(() => {
        const render = () => {
            if(!cvsRef.current) return;
            const ctx = cvsRef.current.getContext('2d', {alpha: false});
            ctx.fillStyle = "white"; ctx.fillRect(0,0,350,450);
            Renderer.draw(ctx, assets.img, params.photo, {x:0, y:0, w:350, h:450});
            Renderer.draw(ctx, assets.suit, params.suit, {x:0, y:0, w:350, h:450});
            requestAnimationFrame(render);
        };
        const id = requestAnimationFrame(render);
        return () => cancelAnimationFrame(id);
    }, [assets, params]);

    const handleFile = (e) => {
        const f = e.target.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            const i = new Image();
            i.onload = () => {
                setAssets(prev => ({...prev, img: i}));
                // è¼‰å…¥æ–°åœ–æ™‚ï¼Œå…ˆæ¸…ç©ºèˆŠçš„èª¿æ•´ä½ç½®
                setParams(p => ({...p, photo: { x: 0, y: 0, s: 0.5, r: 0, f: 1 }}));
            };
            i.src = ev.target.result;
        };
        reader.readAsDataURL(f);
    };

    const addToHistory = () => {
        if(!cvsRef.current || !assets.img) return;
        const snapshot = cvsRef.current.toDataURL('image/jpeg', 0.5);
        const newItem = {
            thumb: snapshot,
            assets: { ...assets },
            params: { ...params },
            id: Date.now()
        };
        setHistory(prev => [newItem, ...prev].slice(0, 10));
    };

    const handleExport = async (all=false) => {
        if(!assets.img) return alert("è«‹å…ˆè¼‰å…¥ç…§ç‰‡");
        addToHistory(); // å°å‡ºæ™‚è‡ªå‹•åŠ å…¥æš«å­˜
        const list = all ? Object.keys(SPECS) : [ui.spec];
        const out = [];
        for(let id of list) {
            const s = SPECS[id];
            const c = document.createElement('canvas'); c.width = s.w; c.height = s.h;
            const ctx = c.getContext('2d'); ctx.fillStyle="white"; ctx.fillRect(0,0,s.w,s.h);
            Renderer.getLayout(s).forEach(rect => {
                Renderer.draw(ctx, assets.img, params.photo, rect);
                Renderer.draw(ctx, assets.suit, params.suit, rect);
            });
            out.push({ name: s.name, url: c.toDataURL('image/jpeg', 0.8), id });
        }
        setUi(u => ({...u, results: out}));
    };

    return (
        <div className="flex flex-col gap-6">
            <header className="flex justify-between items-center">
                <h1 className="text-3xl font-black italic text-blue-500 italic">EzID</h1>
                <div className="text-right text-[10px] text-slate-500 font-bold">V20.47.27<br/><span className="text-blue-400">WYSIWYG_CACHE</span></div>
            </header>

            <div className="stage-box"
                onPointerDown={e => { drag.current = { active: true, x: e.clientX, y: e.clientY }; e.target.setPointerCapture(e.pointerId); }}
                onPointerMove={e => {
                    if(!drag.current.active) return;
                    const dx = (e.clientX - drag.current.x)/params[ui.target].s;
                    const dy = (e.clientY - drag.current.y)/params[ui.target].s;
                    setParams(p => ({...p, [ui.target]: {...p[ui.target], x: p[ui.target].x+dx, y: p[ui.target].y+dy}}));
                    drag.current.x = e.clientX; drag.current.y = e.clientY;
                }}
                onPointerUp={() => drag.current.active = false}>
                <canvas ref={cvsRef} width="350" height="450" className="w-full h-full" />
                <div className="absolute inset-0 pointer-events-none border-[16px] border-slate-900/10"></div>
            </div>

            {/* ğŸ“¸ å‡ç´šç‰ˆæš«å­˜å€ï¼šé¡¯ç¤ºæˆå“ç¸®åœ– */}
            {history.length > 0 && (
                <div className="space-y-2">
                    <p className="text-[10px] font-black text-slate-500 px-1 uppercase tracking-tighter">æˆå“æš«å­˜åº« (é¡¯ç¤ºæœ€çµ‚æ•ˆæœ)</p>
                    <div className="flex gap-3 overflow-x-auto no-scrollbar py-2">
                        {history.map((item) => (
                            <div key={item.id} className={`cache-card flex-shrink-0 ${assets.img === item.assets.img ? 'active' : ''}`} 
                                onClick={() => { setAssets(item.assets); setParams(item.params); }}>
                                <img src={item.thumb} className="w-full h-full object-cover" />
                                <div className="del-x" onClick={(e) => { e.stopPropagation(); setHistory(h => h.filter(i => i.id !== item.id)); }}>âœ•</div>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            <div className="bg-slate-900/40 p-4 rounded-3xl space-y-4">
                <div className="flex gap-2">
                    {['female', 'male'].map(g => (
                        <button key={g} onClick={() => setUi(u => ({...u, gender: g}))} className={`flex-1 py-2 rounded-xl text-[10px] font-black uppercase ${ui.gender === g ? 'bg-blue-600' : 'bg-slate-800 text-slate-500'}`}>{g}</button>
                    ))}
                </div>
                <div className="flex gap-3 overflow-x-auto no-scrollbar">
                    <button onClick={() => { setAssets(a=>({...a, suit:null})); setUi(u=>({...u, activeSuit:null})) }} className="flex-shrink-0 w-[70px] h-[70px] rounded-xl bg-red-500/10 border-2 border-red-500/20 text-red-500 font-black text-xs">å–æ¶ˆ</button>
                    {SUITS[ui.gender].map(url => (
                        <div key={url} onClick={() => {
                            const i = new Image(); i.crossOrigin="anonymous"; i.onload = () => { setAssets(a=>({...a, suit: i})); setUi(u=>({...u, activeSuit: url})); }; i.src = url;
                        }} className={`flex-shrink-0 w-[70px] h-[70px] rounded-xl border-2 overflow-hidden ${ui.activeSuit === url ? 'border-blue-500' : 'border-slate-800'}`}>
                            <img src={url} className="w-full h-full object-contain bg-white p-1" />
                        </div>
                    ))}
                </div>
            </div>

            <div className="grid grid-cols-2 gap-3">
                {['photo', 'suit'].map(t => (
                    <button key={t} onClick={() => setUi(u => ({...u, target: t}))} className={`py-4 rounded-2xl font-black text-xs ${ui.target === t ? 'bg-blue-600 shadow-lg' : 'bg-slate-800 text-slate-500'}`}>{t==='photo'?'èª¿æ•´ç…§ç‰‡':'èª¿æ•´è¡£æœ'}</button>
                ))}
            </div>

            <div className="bg-slate-900/60 p-6 rounded-3xl space-y-4 shadow-inner">
                <input type="range" min="0.1" max="2" step="0.01" value={params[ui.target].s} onChange={e => setParams(p => ({...p, [ui.target]: {...p[ui.target], s: parseFloat(e.target.value)}}))} className="w-full h-1.5 bg-slate-700 rounded-lg appearance-none accent-blue-500" />
                <div className="grid grid-cols-2 gap-3">
                    <button onClick={() => setParams(p => ({...p, [ui.target]: {...p[ui.target], r: p[ui.target].r+90}}))} className="py-3 bg-slate-800 rounded-xl text-[10px] font-bold">æ—‹è½‰</button>
                    <button onClick={() => setParams(p => ({...p, [ui.target]: {...p[ui.target], f: p[ui.target].f*-1}}))} className="py-3 bg-slate-800 rounded-xl text-[10px] font-bold">é¡åƒ</button>
                </div>
            </div>

            <div className="space-y-4">
                <div className="flex flex-wrap gap-2">
                    {Object.values(SPECS).map(s => (
                        <button key={s.id} onClick={() => setUi(u => ({...u, spec: s.id}))} className={`px-3 py-3 rounded-xl text-[10px] font-bold flex-1 min-w-[85px] ${ui.spec === s.id ? 'bg-blue-600 text-white' : 'bg-slate-800 text-slate-400'}`}>{s.name}</button>
                    ))}
                </div>
            </div>

            <div className="flex flex-col gap-3">
                <label className="w-full py-5 bg-white text-black rounded-3xl text-center text-sm font-black cursor-pointer shadow-xl">ğŸ“¸ è¼‰å…¥ç…§ç‰‡<input type="file" hidden accept="image/*" onChange={handleFile}/></label>
                <div className="grid grid-cols-2 gap-3">
                    <button onClick={() => handleExport(false)} className="py-6 bg-blue-600 rounded-3xl font-black shadow-lg">å°å‡ºä¸¦å­˜å…¥æš«å­˜</button>
                    <button onClick={() => handleExport(true)} className="py-6 bg-orange-600 rounded-3xl font-black shadow-lg">å…¨è¦æ ¼å°å‡º</button>
                </div>
            </div>

            {ui.results && (
                <div className="fixed inset-0 bg-slate-950 z-[999] overflow-y-auto p-6">
                    <div className="max-w-sm mx-auto space-y-8 pb-20">
                        <div className="text-center py-4"><h2 className="text-blue-500 font-black tracking-widest">EXPORT READY</h2><p className="text-[10px] text-slate-500 font-bold">å·²åŒæ­¥å­˜å…¥ä¸‹æ–¹æš«å­˜åº«</p></div>
                        {ui.results.map((r, i) => (
                            <div key={i} className="bg-slate-900 p-4 rounded-3xl space-y-4 border border-white/5">
                                <p className="text-[10px] font-black text-blue-400">{r.name}</p>
                                <img src={r.url} className="w-full rounded-2xl" />
                                <a href={r.url} download={`EzID_${r.id}.jpg`} className="block w-full py-4 bg-blue-600 rounded-2xl text-center font-black text-xs">ä¸‹è¼‰åœ–ç‰‡</a>
                            </div>
                        ))}
                        <button onClick={() => setUi(u => ({...u, results: null}))} className="fixed bottom-6 left-1/2 -translate-x-1/2 w-64 py-5 bg-white text-black rounded-full font-black">è¿”å›ç·¨è¼¯</button>
                    </div>
                </div>
            )}
        </div>
    );
}
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
