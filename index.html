<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>EzID v20.38 å°ˆæ¥­ç”Ÿç”¢åŠ›æ——è‰¦ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face { font-family: 'NotoSansTC'; src: local('Noto Sans TC'), local('Microsoft JhengHei'), sans-serif; font-weight: 700; }
        body { font-family: 'NotoSansTC', sans-serif; background: #0f172a; color: #f1f5f9; }
        .canvas-box { position: relative; width: 350px; height: 450px; margin: 0 auto; border-radius: 16px; overflow: hidden; background: #1e293b; box-shadow: 0 0 0 4px #334155; touch-action: none; }
        .slot-card { border-left: 4px solid #475569; background: #1e293b; transition: all 0.2s; }
        .slot-card.active { border-left-color: #3b82f6; background: #2d3748; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="py-6 px-4 pb-24">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useTransition } = React;

/* ============================================================
   SECTION 1: æ ¸å¿ƒæ¥­å‹™è¦æ ¼ (The 12 Holy Specs)
   ============================================================ */
const SPECS = {
    'A4-20':  { id: 'A4-20', w: 2480, h: 3508, photos: 20, grid: [5, 4], size: [413, 531], name: 'A4 2å‹æ¨™æº–' },
    'A4-42':  { id: 'A4-42', w: 2480, h: 3508, photos: 42, grid: [7, 6], size: [295, 413], name: 'A4 1å‹æ¨™æº–' },
    'A4-ID':  { id: 'A4-ID', w: 2480, h: 3508, photos: 16, grid: [4, 4], size: [450, 600], name: 'A4 è­·ç…§è­‰ä»¶' },
    'A4-BIG': { id: 'A4-BIG', w: 2480, h: 3508, photos: 12, grid: [4, 3], size: [531, 708], name: 'A4 å¤§é ­ (12)' },
    'A4-MIX': { id: 'A4-MIX', w: 2480, h: 3508, type: 'MIX', name: 'A4 ç¶œåˆ(12+18)' },
    'A4-B':   { id: 'A4-B',   w: 2480, h: 3508, photos: 30, grid: [6, 5], size: [354, 472], name: 'A4 æ··åˆBç‰ˆ' },
    '4x6-8':  { id: '4x6-8',  w: 1800, h: 1200, photos: 8,  grid: [2, 4], size: [413, 531], name: '4x6 2å‹ (8)' },
    '4x6-10': { id: '4x6-10', w: 1800, h: 1200, photos: 10, grid: [2, 5], size: [295, 413], name: '4x6 1å‹ (10)' },
    '4x6-BIG':{ id: '4x6-BIG',w: 1800, h: 1200, photos: 6,  grid: [2, 3], size: [531, 708], name: '4x6 å¤§é ­ (6)' },
    '4x6-MIX':{ id: '4x6-MIX',w: 1800, h: 1200, type: 'MIX46', name: '4x6 æ··åˆ(4+4)' },
    '4x6-12': { id: '4x6-12', w: 1800, h: 1200, photos: 12, grid: [3, 4], size: [295, 413], name: '4x6 1å‹ (12)' },
    'NAME':   { id: 'NAME',   w: 2480, h: 3508, photos: 24, grid: [6, 4], size: [295, 413], special: 'NAME', name: 'å§“åå·¥ç‰Œç‰ˆ' }
};

/* ============================================================
   SECTION 2: åŸå­æ¸²æŸ“å¼•æ“ (Decoupled Renderer)
   ============================================================ */
const AtomicRenderer = {
    drawLayer: (ctx, img, st, ratio, cx, cy) => {
        if (!img) return;
        ctx.save();
        ctx.translate(cx + st.x * ratio, cy + st.y * ratio);
        ctx.rotate(st.r * Math.PI / 180);
        ctx.scale(st.s * ratio * st.f, st.s * ratio);
        ctx.drawImage(img, -img.width / 2, -img.height / 2);
        ctx.restore();
    },
    drawGuide: (ctx, w, h) => {
        ctx.beginPath();
        ctx.ellipse(w/2, h*0.46, w*0.32, h*0.38, 0, 0, Math.PI * 2);
        ctx.strokeStyle = "rgba(59, 130, 246, 0.4)";
        ctx.setLineDash([5, 5]); ctx.stroke();
    }
};

/* ============================================================
   SECTION 3: æ ¸å¿ƒæ‡‰ç”¨ä¸»é«” (Orchestration)
   ============================================================ */
function App() {
    const [isPending, startTransition] = useTransition();
    
    // Editor States
    const [img, setImg] = useState(null);
    const [suit, setSuit] = useState(null);
    const [p, setP] = useState({ x: 0, y: -20, s: 0.45, r: 0, f: 1 });
    const [s, setS] = useState({ x: 0, y: 80, s: 1.0, r: 0, f: 1 });
    const [target, setTarget] = useState('PHOTO');
    const [gender, setGender] = useState('male');
    const [activeSpec, setActiveSpec] = useState('A4-20');
    
    // Asset Management
    const [slots, setSlots] = useState([]);
    const [editingId, setEditingId] = useState(null);
    const [preview, setPreview] = useState(null);
    
    const canvasRef = useRef(null);
    const drag = useRef({ active: false, x: 0, y: 0 });

    // ğŸŸ¢ æ¸²æŸ“å¾ªç’°
    useEffect(() => {
        const ctx = canvasRef.current?.getContext('2d');
        if (!ctx) return;
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, 350, 450);
        AtomicRenderer.drawLayer(ctx, img, p, 1, 175, 225);
        AtomicRenderer.drawLayer(ctx, suit, s, 1, 175, 225);
        AtomicRenderer.drawGuide(ctx, 350, 450);
    }, [img, suit, p, s]);

    // ğŸŸ¢ äº¤äº’èˆ‡è£œå„Ÿ
    const handleMove = (e) => {
        if (!drag.current.active) return;
        const activeObj = target === 'PHOTO' ? p : s;
        const factor = 1 / activeObj.s;
        const dx = (e.clientX - drag.current.x) * factor;
        const dy = (e.clientY - drag.current.y) * factor;
        const update = target === 'PHOTO' ? setP : setS;
        update(v => ({ ...v, x: v.x + dx, y: v.y + dy }));
        drag.current.x = e.clientX; drag.current.y = e.clientY;
    };

    // ğŸŸ¢ è³‡ç”¢æ¬Šè²¬æ“ä½œ
    const commitAsset = (isUpdate = false) => {
        if (!img) return;
        const thumb = document.createElement('canvas'); thumb.width = 100; thumb.height = 130;
        const ctx = thumb.getContext('2d'); ctx.fillStyle="white"; ctx.fillRect(0,0,100,130);
        AtomicRenderer.drawLayer(ctx, img, p, 100/350, 50, 65);
        AtomicRenderer.drawLayer(ctx, suit, s, 100/350, 50, 65);

        const asset = {
            id: isUpdate ? editingId : Date.now(),
            name: isUpdate ? slots.find(x=>x.id===editingId).name : `äººå“¡ ${slots.length + 1}`,
            img, suit, p: {...p}, s: {...s},
            refSpec: activeSpec,
            updatedAt: new Date().toLocaleTimeString(),
            thumb: thumb.toDataURL()
        };

        setSlots(isUpdate ? slots.map(x => x.id === editingId ? asset : x) : [...slots, asset]);
        setEditingId(null);
    };

    const recall = (as) => {
        setEditingId(as.id);
        setImg(as.img); setSuit(as.suit); setP(as.p); setS(as.s); setActiveSpec(as.refSpec);
    };

    return (
        <div className="max-w-md mx-auto space-y-6">
            <header className="flex justify-between items-center px-2">
                <div>
                    <h1 className="text-2xl font-black tracking-tighter italic text-white">EzID <span className="text-blue-500">v20.38</span></h1>
                    <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Professional Production Suite</p>
                </div>
                {editingId && <span className="bg-red-500 text-white text-[10px] px-2 py-1 rounded font-black animate-pulse">ç·¨è¼¯æ¨¡å¼</span>}
            </header>

            {/* æ ¸å¿ƒç·¨è¼¯ç•«å¸ƒ */}
            <div className="canvas-box" 
                 onPointerDown={e => { e.target.setPointerCapture(e.pointerId); drag.current = { active: true, x: e.clientX, y: e.clientY }; }}
                 onPointerMove={handleMove}
                 onPointerUp={() => drag.current.active = false}>
                <canvas ref={canvasRef} width="350" height="450" />
            </div>

            {/* æ§åˆ¶é¢æ¿ï¼šæ ¡æº–èˆ‡è¥¿è£ (åŸåŠŸèƒ½æ­¸ä½) */}
            <div className="glass p-5 rounded-3xl space-y-4">
                <div className="flex bg-slate-800 p-1 rounded-xl">
                    <button onClick={()=>setTarget('PHOTO')} className={`flex-1 py-2 rounded-lg font-bold text-xs ${target==='PHOTO'?'bg-blue-600 text-white':'text-slate-500'}`}>äººåƒæ ¡æº–</button>
                    <button onClick={()=>setTarget('SUIT')} className={`flex-1 py-2 rounded-lg font-bold text-xs ${target==='SUIT'?'bg-blue-600 text-white':'text-slate-500'}`}>è¥¿è£é©é…</button>
                </div>

                {/* è¥¿è£é¸æ“‡å€ (æ‰¾å›ä¾†äº†) */}
                {target === 'SUIT' && (
                    <div className="space-y-3">
                        <div className="flex gap-2">
                            <button onClick={()=>setGender('male')} className={`flex-1 py-1 rounded-md text-[10px] font-bold ${gender==='male'?'bg-slate-700 text-white':'text-slate-600'}`}>ç”·è£ MALE</button>
                            <button onClick={()=>setGender('female')} className={`flex-1 py-1 rounded-md text-[10px] font-bold ${gender==='female'?'bg-slate-700 text-white':'text-slate-600'}`}>å¥³è£ FEMALE</button>
                        </div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                            {[1,2,3,4,5].map(n => (
                                <img key={n} src={`clothes/${gender}/${gender[0]}${n}.png`} 
                                     onClick={()=>{const i=new Image(); i.onload=()=>setSuit(i); i.src=`clothes/${gender}/${gender[0]}${n}.png`;}}
                                     className="w-12 h-12 rounded border border-white/10 bg-white/5 cursor-pointer hover:border-blue-500 transition-all" />
                            ))}
                        </div>
                    </div>
                )}

                {/* æ»‘æ¡¿å€ */}
                <div className="space-y-3">
                    <input type="range" className="w-full accent-blue-500" min="0.1" max="1.5" step="0.01" value={target==='PHOTO'?p.s:s.s} onChange={e=>{
                        const v = parseFloat(e.target.value); target==='PHOTO'?setP({...p,s:v}):setS({...s,s:v});
                    }} />
                    <div className="flex justify-between text-[10px] font-bold text-slate-500 italic">
                        <span>SCALE: {(target==='PHOTO'?p.s:s.s).toFixed(2)}x</span>
                        <button onClick={()=>target==='PHOTO'?setP({...p,f:p.f*-1}):setS({...s,f:s.f*-1})}>â†”ï¸ é¡åƒåˆ‡æ›</button>
                    </div>
                </div>
            </div>

            {/* è¦æ ¼åŸºæº–å€ (12ç¨®è¦æ ¼å…¥å£) */}
            <div className="glass p-4 rounded-3xl">
                <p className="text-[9px] font-black text-blue-400 mb-3 uppercase tracking-tighter italic">Calibration Reference Spec (æ ¡æº–åŸºæº–è¦æ ¼)</p>
                <div className="grid grid-cols-3 gap-2">
                    {Object.keys(SPECS).map(k => (
                        <button key={k} onClick={()=>setActiveSpec(k)} className={`py-2 rounded-lg text-[9px] font-bold transition-all border ${activeSpec===k?'bg-blue-600 border-blue-600 text-white':'bg-slate-800 border-white/5 text-slate-500'}`}>
                            {SPECS[k].name}
                        </button>
                    ))}
                </div>
            </div>

            {/* è³‡ç”¢åå–®ç®¡ç† (æ ¸å¿ƒè³‡ç”¢å€) */}
            <div className="glass p-5 rounded-3xl space-y-4">
                <div className="flex justify-between items-center">
                    <h2 className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Asset Manager ({slots.length})</h2>
                    {editingId ? (
                        <button onClick={()=>commitAsset(true)} className="bg-emerald-500 text-white text-[10px] font-black px-4 py-2 rounded-lg shadow-lg">ç¢ºèªæ›´æ–°</button>
                    ) : (
                        <button onClick={()=>commitAsset(false)} className="bg-blue-600 text-white text-[10px] font-black px-4 py-2 rounded-lg shadow-lg">å­˜å…¥å®šç¨¿è³‡ç”¢</button>
                    )}
                </div>
                <div className="space-y-2 max-h-64 overflow-y-auto pr-1 no-scrollbar">
                    {slots.map(as => (
                        <div key={as.id} className={`slot-card p-3 rounded-xl flex items-center gap-3 border border-white/5 ${editingId===as.id?'active':''}`}>
                            <img src={as.thumb} className="w-10 h-12 rounded bg-white shadow-inner" />
                            <div className="flex-1 min-w-0">
                                <input value={as.name} onChange={e=>{const n=[...slots]; n.find(x=>x.id===as.id).name=e.target.value; setSlots(n);}} className="w-full bg-transparent font-bold text-xs outline-none text-white focus:text-blue-400" />
                                <div className="flex gap-3 text-[8px] font-black text-slate-500 uppercase mt-1">
                                    <span className="text-blue-500/80">Ref: {as.refSpec}</span>
                                    <span>T: {as.updatedAt}</span>
                                </div>
                            </div>
                            <button onClick={()=>recall(as)} className="text-[10px] font-bold text-slate-400 hover:text-white px-2">RECALL</button>
                        </div>
                    ))}
                </div>
            </div>

            {/* ç³»çµ±æ“ä½œèˆ‡åŒ¯å‡º */}
            <div className="grid grid-cols-2 gap-3">
                <label className="flex items-center justify-center h-14 bg-white text-slate-900 rounded-2xl font-black cursor-pointer active:scale-95 transition-all">
                    ğŸ“¸ è¼‰å…¥åŸå§‹ç…§ç‰‡
                    <input type="file" hidden accept="image/*" onChange={e=>{
                        const f = e.target.files[0]; if(f){ const i=new Image(); i.onload=()=>setImg(i); i.src=URL.createObjectURL(f); }
                    }} />
                </label>
                <button onClick={()=>startTransition(async ()=>{
                    // åŸ·è¡Œ Export Engine (ç¨ç«‹å¼•æ“é‚è¼¯)
                    const spec = SPECS[activeSpec];
                    const canvas = document.createElement('canvas'); canvas.width = spec.w; canvas.height = spec.h;
                    const ctx = canvas.getContext('2d'); ctx.fillStyle="white"; ctx.fillRect(0,0,spec.w,spec.h);
                    
                    const fill = (num, grid, size) => {
                        const [pw, ph] = size;
                        const mx = (spec.w - grid[1]*pw)/(grid[1]+1), my = (spec.h - grid[0]*ph)/(grid[0]+1);
                        for (let i=0; i<num; i++) {
                            const r = Math.floor(i/grid[1]), c = i%grid[1];
                            const target = slots[i] || { img, suit, p, s };
                            const ratio = pw/350;
                            const x = mx+c*(pw+mx), y = my+r*(ph+my);
                            ctx.save(); ctx.beginPath(); ctx.rect(x,y,pw,ph); ctx.clip();
                            AtomicRenderer.drawLayer(ctx, target.img, target.p, ratio, x+pw/2, y+ph/2);
                            AtomicRenderer.drawLayer(ctx, target.suit, target.s, ratio, x+pw/2, y+ph/2);
                            ctx.restore();
                            ctx.strokeStyle="#eee"; ctx.strokeRect(x,y,pw,ph);
                        }
                    };
                    if(spec.type==='MIX') fill(12, [3,4], [413,531]); else fill(spec.photos, spec.grid, spec.size);
                    setPreview(canvas.toDataURL('image/jpeg', 0.9));
                })} className="bg-blue-600 text-white rounded-2xl font-black shadow-xl shadow-blue-900/20">ğŸš€ åŸ·è¡Œæ‰¹æ¬¡åŒ¯å‡º</button>
            </div>

            {preview && (
                <div className="fixed inset-0 bg-slate-950/98 z-[9999] flex flex-col items-center justify-center p-8 backdrop-blur-xl">
                    <img src={preview} className="max-w-full max-h-[75vh] border-2 border-white/10 shadow-2xl rounded mb-8" />
                    <div className="flex gap-4 w-full max-w-sm">
                        <button onClick={()=>setPreview(null)} className="flex-1 h-14 bg-white/10 text-white rounded-2xl font-bold">è¿”å›å·¥ä½œç«™</button>
                        <a href={preview} download="EzID_Pro_Export.jpg" className="flex-1 h-14 bg-blue-600 text-white rounded-2xl font-black flex items-center justify-center">ğŸ’¾ ä¸‹è¼‰çµæœ</a>
                    </div>
                </div>
            )}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
