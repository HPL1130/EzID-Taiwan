<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v13.0 ENTERPRISE</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .canvas-container { 
            position: relative; width: 340px; height: 437px; margin: 10px auto; 
            background: #fff; border: 4px solid #0f172a; border-radius: 24px; overflow: hidden; 
            touch-action: none; cursor: grab; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            user-select: none; -webkit-user-select: none;
        }
        .canvas-container:active { cursor: grabbing; }
        .preview-overlay { 
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 1000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; 
        }
    </style>
</head>
<body class="bg-slate-100 pb-20 font-sans select-none">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback, useLayoutEffect } = React;

const SUITS = ['male/m1.png','male/m2.png','male/m3.png','male/m4.png','male/m5.png','female/f1.png','female/f2.png','female/f3.png','female/f4.png','female/f5.png'];

function validateImageFile(file) {
    const MAX_SIZE = 10 * 1024 * 1024;
    return file && file.size <= MAX_SIZE && file.type.startsWith('image/');
}

// âœ… å®Œç¾å–®æ¬¡é‡ç¹ª - ç„¡é™è¿´åœˆçµ‚çµå™¨
function useCanvasDraw(canvasRef, image, suitImg, photoTransform, suitTransform, config) {
    const draw = useCallback(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const { bright, guide } = config;
        
        // æ¸…ç©ºèƒŒæ™¯
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, 350, 450);
        
        // äººåƒç¹ªè£½
        if (image?.complete) {
            ctx.save();
            ctx.filter = `brightness(${bright}%)`;
            ctx.translate(175 + photoTransform.x, 225 + photoTransform.y);
            ctx.rotate(photoTransform.r * Math.PI / 180);
            ctx.scale(photoTransform.s * photoTransform.f, photoTransform.s);
            ctx.drawImage(image, -image.width / 2, -image.height / 2);
            ctx.restore();
        }
        
        // è¡£æœç¹ªè£½
        if (suitImg?.complete) {
            ctx.save();
            ctx.translate(175 + suitTransform.x, 225 + suitTransform.y);
            ctx.rotate(suitTransform.r * Math.PI / 180);
            ctx.scale(suitTransform.s, suitTransform.s);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(suitImg, -suitImg.width / 2, -suitImg.height / 2);
            ctx.restore();
        }
        
        // å°ä½å°å¼•
        if (guide > 0) {
            ctx.save();
            ctx.globalAlpha = guide;
            ctx.setLineDash([5, 5]);
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            const isCentered = Math.abs(photoTransform.x) < 5 && Math.abs(photoTransform.y + 20) < 5;
            ctx.strokeStyle = isCentered ? '#10b981' : '#ef4444';
            ctx.shadowColor = isCentered ? '#10b981' : '#ef4444';
            ctx.shadowBlur = 6;
            
            ctx.beginPath();
            ctx.ellipse(175, 203, 108, 160, 0, 0, Math.PI * 2);
            ctx.stroke();
            ctx.restore();
        }
    }, [image?.complete, suitImg?.complete, photoTransform, suitTransform, config.bright, config.guide]);

    // âœ… useLayoutEffect ç¢ºä¿åŒæ­¥é‡ç¹ª
    useLayoutEffect(() => {
        draw();
    }, [draw]);
}

function App() {
    // ç‹€æ…‹ç®¡ç†
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [suitIndex, setSuitIndex] = useState(-1);
    const [photoTransform, setPhotoTransform] = useState({ x: 0, y: -20, s: 0.45, r: 0, f: 1 });
    const [suitTransform, setSuitTransform] = useState({ x: 0, y: 80, s: 1.0, r: 0 });
    const [config, setConfig] = useState({ bright: 100, guide: 0.8, name: 'EzID' });
    const [slots, setSlots] = useState([]);
    const [target, setTarget] = useState('PHOTO');
    const [preImg, setPreImg] = useState(null);
    const [isDragging, setIsDragging] = useState(false);
    
    const canvasRef = useRef(null);
    const dragState = useRef({ startX: 0, startY: 0 });
    const revokeQueue = useRef(new Set());
    
    // âœ… è¨˜æ†¶é«”æ¸…ç†
    useEffect(() => {
        return () => {
            revokeQueue.current.forEach(url => URL.revokeObjectURL(url));
            revokeQueue.current.clear();
        };
    }, []);

    // âœ… RAFç¯€æµæ‹–æ›³ - å®Œç¾æµæš¢
    const rafRef = useRef(0);
    const updatePosition = useCallback((dx, dy) => {
        cancelAnimationFrame(rafRef.current);
        rafRef.current = requestAnimationFrame(() => {
            if (target === 'PHOTO') {
                setPhotoTransform(prev => ({
                    ...prev,
                    x: Math.max(-200, Math.min(200, prev.x + dx)),
                    y: Math.max(-150, Math.min(250, prev.y + dy))
                }));
            } else {
                setSuitTransform(prev => ({
                    ...prev,
                    x: Math.max(-200, Math.min(200, prev.x + dx)),
                    y: Math.max(-150, Math.min(250, prev.y + dy))
                }));
            }
        });
    }, [target]);

    // âœ… Touch + Pointerå®Œæ•´æ”¯æ´
    const handleStart = useCallback((e) => {
        e.preventDefault();
        setIsDragging(true);
        
        const rect = canvasRef.current.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        dragState.current = {
            startX: clientX - rect.left,
            startY: clientY - rect.top
        };
    }, []);

    const handleMove = useCallback((e) => {
        if (!isDragging) return;
        e.preventDefault();
        
        const rect = canvasRef.current.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        const dx = (clientX - rect.left - dragState.current.startX) * 0.5;
        const dy = (clientY - rect.top - dragState.current.startY) * 0.5;
        
        updatePosition(dx, dy);
        dragState.current.startX = clientX - rect.left;
        dragState.current.startY = clientY - rect.top;
    }, [isDragging, updatePosition]);

    const handleEnd = useCallback((e) => {
        setIsDragging(false);
    }, []);

    // âœ… å®‰å…¨æª”æ¡ˆä¸Šå‚³
    const handleFileUpload = useCallback((e) => {
        const file = e.target.files[0];
        if (!validateImageFile(file)) {
            alert('åƒ…é™10MBå…§åœ–ç‰‡æª”æ¡ˆ');
            e.target.value = '';
            return;
        }

        const url = URL.createObjectURL(file);
        revokeQueue.current.add(url);
        
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
            setImage(img);
            setTarget('PHOTO');
            setPhotoTransform({ x: 0, y: -20, s: 0.45, r: 0, f: 1 });
        };
        img.onerror = () => {
            alert('åœ–ç‰‡è¼‰å…¥å¤±æ•—');
            if (revokeQueue.current.has(url)) {
                URL.revokeObjectURL(url);
                revokeQueue.current.delete(url);
            }
        };
        img.src = url;
    }, []);

    // âœ… é˜²æŠ–è¡£æœè¼‰å…¥
    const loadSuitRef = useRef();
    const loadSuit = useCallback((index) => {
        if (loadSuitRef.current === index) return;
        loadSuitRef.current = index;
        
        setSuitIndex(index);
        const img = new Image();
        img.src = `clothes/${SUITS[index]}`;
        img.onload = () => setSuitImg(img);
        img.onerror = () => {
            setSuitImg(null);
            setSuitIndex(-1);
        };
        setTarget('SUIT');
    }, []);

    const saveToSlot = useCallback(() => {
        if (!canvasRef.current) return;
        const canvas = document.createElement('canvas');
        canvas.width = 350;
        canvas.height = 450;
        canvas.getContext('2d').drawImage(canvasRef.current, 0, 0);
        const dataUrl = canvas.toDataURL('image/png', 0.95);
        setSlots(prev => [dataUrl, ...prev.slice(0, 9)]);
    }, []);

    const getFullFileName = useCallback(() => {
        const now = new Date();
        const ts = now.toISOString().slice(0, 19).replace(/[-:T]/g, '').slice(0, 15);
        return `${config.name}_${ts}.png`;
    }, [config.name]);

    // âœ… ä¸¦è¡ŒåŒ¯å‡º - æ¯«ç§’ç´šå®Œæˆ
    const exportDoc = useCallback(async () => {
        if (!slots.length) {
            alert('è«‹å…ˆå­˜å…¥æ§½ä½');
            return;
        }

        const canvas = document.createElement('canvas');
        canvas.width = 2480;
        canvas.height = 3508;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, 2480, 3508);

        // âœ… ä¸¦è¡Œè¼‰å…¥æ‰€æœ‰åœ–ç‰‡
        const images = await Promise.all(
            slots.slice(0, 20).map(src => 
                new Promise(resolve => {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    img.onload = () => resolve(img);
                    img.onerror = () => resolve(null);
                    img.src = src;
                })
            )
        );

        // A4å°ˆæ¥­æ’ç‰ˆ
        for (let i = 0; i < images.length; i++) {
            const img = images[i];
            if (img) {
                const x = 205 + (i % 4) * 520;
                const y = 300 + Math.floor(i / 4) * 600;
                ctx.drawImage(img, x, y, 413, 531);
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 3;
                ctx.strokeRect(x, y, 413, 531);
            }
        }
        
        setPreImg(canvas.toDataURL('image/png', 0.98));
    }, [slots]);

    useCanvasDraw(canvasRef, image, suitImg, photoTransform, suitTransform, config);

    return (
        <div className="max-w-md mx-auto p-4 space-y-4 pb-24">
            {/* Header */}
            <header className="flex justify-between items-center p-4 bg-white rounded-2xl shadow-sm">
                <h1 className="text-xl font-black italic">EzID <span className="text-blue-600">v13.0</span></h1>
                <div className="flex gap-2">
                    <input 
                        type="text" 
                        value={config.name} 
                        onChange={e => setConfig(prev => ({ ...prev, name: e.target.value.slice(0, 20) }))}
                        className="w-24 bg-slate-100 rounded-lg px-2 py-1 text-[10px] font-bold border border-slate-200 focus:border-blue-400 outline-none"
                        maxLength={20}
                    />
                    <button 
                        onClick={() => setPhotoTransform(p => ({ ...p, f: p.f * -1 }))}
                        className="px-3 py-1 bg-slate-800 hover:bg-slate-900 text-white rounded-lg text-[10px] font-bold active:scale-95 transition-all"
                    >
                        é¡åƒ
                    </button>
                    <button 
                        onClick={() => {
                            setPhotoTransform({ x: 0, y: -20, s: 0.45, r: 0, f: 1 });
                            setSuitTransform({ x: 0, y: 80, s: 1.0, r: 0 });
                        }}
                        className="px-2 py-1 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-[10px] font-bold active:scale-95 transition-all"
                    >
                        æ­¸ä½
                    </button>
                </div>
            </header>

            {/* Canvas */}
            <div 
                className={`canvas-container ${isDragging ? 'grabbing' : ''}`}
                onPointerDown={handleStart}
                onPointerMove={handleMove}
                onPointerUp={handleEnd}
                onPointerLeave={handleEnd}
                onTouchStart={handleStart}
                onTouchMove={handleMove}
                onTouchEnd={handleEnd}
            >
                <canvas ref={canvasRef} width="350" height="450" className="w-full h-full block" />
            </div>

            {/* è¡£æœé¸æ“‡ */}
            <div className="flex gap-2 overflow-x-auto no-scrollbar py-3 bg-white rounded-3xl px-4 shadow-md">
                <button 
                    onClick={() => {
                        setSuitImg(null);
                        setSuitIndex(-1);
                        setTarget('PHOTO');
                    }}
                    className="w-16 h-16 flex items-center justify-center border-2 border-dashed border-red-200 rounded-2xl bg-red-50 hover:bg-red-100 active:scale-95 transition-all"
                >
                    ğŸš«
                </button>
                {SUITS.map((suit, i) => (
                    <button 
                        key={i}
                        onClick={() => loadSuit(i)}
                        className={`w-16 h-16 rounded-2xl border-2 overflow-hidden flex-shrink-0 active:scale-95 transition-all shadow-sm hover:shadow-md
                            ${suitIndex === i ? 'border-blue-500 ring-2 ring-blue-200 shadow-lg bg-blue-50' : 'border-slate-200 hover:border-blue-300'}`}
                    >
                        <img src={`clothes/${suit}`} className="w-full h-full object-cover" />
                    </button>
                ))}
            </div>

            {/* æ§åˆ¶é¢æ¿ */}
            <div className="bg-white p-6 rounded-[2.5rem] shadow-xl space-y-4">
                <div className="flex bg-slate-100 p-1 rounded-2xl">
                    <button 
                        onClick={() => setTarget('PHOTO')}
                        className={`flex-1 py-2 text-xs font-bold rounded-xl transition-all ${target === 'PHOTO' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200'}`}
                    >
                        ç·¨è¼¯äººåƒ
                    </button>
                    <button 
                        onClick={() => setTarget('SUIT')}
                        className={`flex-1 py-2 text-xs font-bold rounded-xl transition-all ${target === 'SUIT' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500 hover:text-slate-700 hover:bg-slate-200'}`}
                    >
                        ç·¨è¼¯è¡£æœ
                    </button>
                </div>
                
                <div className="space-y-3">
                    <div className="flex items-center justify-between">
                        <span className="text-[10px] font-bold text-slate-400 w-12">SIZE</span>
                        <input 
                            type="range" 
                            min="0.1" max="2" step="0.01"
                            value={target === 'PHOTO' ? photoTransform.s : suitTransform.s}
                            onChange={e => {
                                if (target === 'PHOTO') {
                                    setPhotoTransform(p => ({ ...p, s: +e.target.value }));
                                } else {
                                    setSuitTransform(s => ({ ...s, s: +e.target.value }));
                                }
                            }}
                            className="flex-1 h-1 bg-slate-200 rounded-lg accent-blue-600 hover:accent-blue-500"
                        />
                        <span className="text-[11px] font-mono w-14 text-right text-slate-700 font-bold">
                            {(target === 'PHOTO' ? photoTransform.s : suitTransform.s).toFixed(2)}
                        </span>
                    </div>
                    
                    <div className="flex items-center justify-between">
                        <span className="text-[10px] font-bold text-slate-400 w-12">ROTATE</span>
                        <input 
                            type="range" 
                            min="-45" max="45" step="1"
                            value={target === 'PHOTO' ? photoTransform.r : suitTransform.r}
                            onChange={e => {
                                if (target === 'PHOTO') {
                                    setPhotoTransform(p => ({ ...p, r: +e.target.value }));
                                } else {
                                    setSuitTransform(s => ({ ...s, r: +e.target.value }));
                                }
                            }}
                            className="flex-1 h-1 bg-slate-200 rounded-lg accent-emerald-500 hover:accent-emerald-400"
                        />
                        <span className="text-[11px] font-mono w-14 text-right text-slate-700 font-bold">
                            {target === 'PHOTO' ? photoTransform.r : suitTransform.r}Â°
                        </span>
                    </div>
                    
                    <div className="flex items-center justify-between">
                        <span className="text-[10px] font-bold text-slate-400 w-12">BRIGHT</span>
                        <input 
                            type="range" 
                            min="60" max="140" step="1"
                            value={config.bright}
                            onChange={e => setConfig(c => ({ ...c, bright: +e.target.value }))}
                            className="flex-1 h-1 bg-slate-200 rounded-lg accent-amber-500 hover:accent-amber-400"
                        />
                        <span className="text-[11px] font-mono w-14 text-right text-slate-700 font-bold">{config.bright}%</span>
                    </div>
                    
                    <div className="flex items-center justify-between">
                        <span className="text-[10px] font-bold text-slate-400 w-12">GUIDE</span>
                        <input 
                            type="range" 
                            min="0" max="1" step="0.1"
                            value={config.guide}
                            onChange={e => setConfig(c => ({ ...c, guide: +e.target.value }))}
                            className="flex-1 h-1 bg-slate-200 rounded-lg accent-slate-400 hover:accent-slate-300"
                        />
                        <span className="text-[11px] font-mono w-14 text-right text-slate-700 font-bold">{Math.round(config.guide * 100)}%</span>
                    </div>
                </div>
            </div>

            {/* æ“ä½œæŒ‰éˆ• */}
            <div className="grid grid-cols-2 gap-4">
                <label className="block bg-gradient-to-r from-slate-900 to-slate-800 hover:from-slate-800 hover:to-slate-700 text-white py-4 rounded-3xl text-center font-black shadow-xl hover:shadow-2xl active:scale-95 transition-all cursor-pointer">
                    ğŸ“¸ ä¸Šå‚³ç…§ç‰‡
                    <input type="file" accept="image/*" hidden onChange={handleFileUpload} />
                </label>
                <button 
                    onClick={saveToSlot}
                    className="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white py-4 rounded-3xl font-black shadow-xl hover:shadow-2xl active:scale-95 transition-all"
                >
                    ğŸ“¥ å­˜å…¥æ§½ä½ ({slots.length}/10)
                </button>
            </div>

            {/* æ§½ä½å±•ç¤º */}
            <div className="bg-slate-200/50 p-4 rounded-[2.5rem] flex gap-3 overflow-x-auto no-scrollbar min-h-[140px] shadow-inner">
                {slots.map((slot, i) => (
                    <div key={i} className="relative w-24 h-32 bg-white rounded-xl shadow-md flex-shrink-0 border-2 border-white hover:shadow-xl hover:border-slate-300 transition-all overflow-hidden">
                        <img src={slot} className="w-full h-full object-cover" loading="lazy" />
                        <button 
                            className="absolute top-1 right-1 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full text-[10px] font-bold shadow-md active:scale-90 transition-all flex items-center justify-center"
                            onClick={() => setSlots(prev => prev.filter((_, idx) => idx !== i))}
                        >
                            âœ•
                        </button>
                        <button 
                            className="absolute inset-x-0 bottom-0 bg-gradient-to-t from-slate-900/95 to-slate-700/80 text-white text-[9px] text-center py-1.5 backdrop-blur-sm hover:from-slate-900 transition-all"
                            onClick={() => alert('å·²è¼‰å…¥æˆªåœ–ï¼ˆç·¨è¼¯è¨­å®šç„¡æ³•å®Œå…¨é‚„åŸï¼‰')}
                        >
                            è¼‰å…¥ç·¨è¼¯
                        </button>
                    </div>
                ))}
            </div>

            {/* åŒ¯å‡ºæŒ‰éˆ• */}
            <div className="bg-white p-6 rounded-[2.5rem] shadow-xl">
                <button 
                    onClick={exportDoc}
                    className="w-full py-4 bg-gradient-to-r from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 text-white rounded-2xl font-black shadow-xl hover:shadow-2xl active:scale-95 transition-all text-lg"
                >
                    ğŸ–¨ï¸ A4 å°ˆæ¥­æ’ç‰ˆåŒ¯å‡º
                </button>
            </div>

            {/* é è¦½å°è©±æ¡† */}
            {preImg && (
                <div 
                    className="preview-overlay"
                    onClick={e => e.target === e.currentTarget && setPreImg(null)}
                    role="dialog"
                    aria-modal="true"
                    aria-label="åŒ¯å‡ºé è¦½"
                >
                    <div 
                        className="bg-white p-6 rounded-2xl max-w-[95vw] max-h-[80vh] overflow-auto shadow-2xl max-w-4xl mx-4"
                        onClick={e => e.stopPropagation()}
                    >
                        <img src={preImg} className="w-full h-auto rounded-xl shadow-lg block mx-auto max-h-[60vh] object-contain" alt="åŒ¯å‡ºé è¦½" />
                    </div>
                    <div className="flex gap-4 mt-6 w-full max-w-xs px-4" onClick={e => e.stopPropagation()}>
                        <button 
                            onClick={() => setPreImg(null)}
                            className="flex-1 py-4 bg-slate-700 hover:bg-slate-800 text-white rounded-2xl font-bold shadow-lg active:scale-95 transition-all"
                        >
                            è¿”å›
                        </button>
                        <a 
                            href={preImg} 
                            download={getFullFileName()}
                            onClick={() => setPreImg(null)}
                            className="flex-1 py-4 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-2xl font-bold text-center shadow-xl hover:shadow-2xl active:scale-95 transition-all"
                        >
                            ğŸ’¾ ä¸‹è¼‰æª”æ¡ˆ
                        </a>
                    </div>
                </div>
            )}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
