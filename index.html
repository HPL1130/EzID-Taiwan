<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EzID Taiwan v1.7.3 - å°ˆæ¥­ç©©å®šç‰ˆ</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0/dist/body-pix.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js"></script>
<style>
    body { background-color: #f1f5f9; color: #1e293b; font-family: system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
    .canvas-container { position: relative; touch-action: none; } /* é—œéµï¼šé˜»æ­¢é è¨­æ»¾å‹• */
    canvas { border-radius: 24px; max-width: 100%; height: auto; background: white; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.1); border: 4px solid #fff; }
    
    .id-guide { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -55%); width: 62%; height: 62%; border: 2px dashed rgba(239, 68, 68, 0.4); border-radius: 50%; pointer-events: none; z-index: 10; }
    
    /* å¼·åŒ– Slider è¦–è¦ºèˆ‡æ“ä½œæ„Ÿ */
    input[type=range] { -webkit-appearance: none; width: 100%; height: 12px; background: #e2e8f0; border-radius: 6px; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #0f172a; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    
    .bg-dot { width: 34px; height: 34px; border-radius: 50%; cursor: pointer; border: 3px solid white; box-shadow: 0 0 0 1px #cbd5e1; transition: 0.2s; }
    .bg-dot.active { transform: scale(1.1); box-shadow: 0 0 0 3px #3b82f6; }
</style>
</head>
<body class="p-3 md:p-8">
<div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

const EzIDApp = () => {
    const [image, setImage] = useState(null);
    const [isCam, setIsCam] = useState(false);
    const [mode, setMode] = useState('MIXED');
    const [bgColor, setBgColor] = useState('white');
    const [p, setP] = useState({ x: 0, y: 0, s: 0.7 });
    const [suit, setSuit] = useState({ id: null, x: 175, y: 340, s: 0.35 });
    const [autoAlign, setAutoAlign] = useState(false); // é è¨­é—œé–‰ï¼Œç”±ä½¿ç”¨è€…æ±ºå®š
    const [isProcessing, setIsProcessing] = useState(false);
    
    const canvasRef = useRef(null);
    const videoRef = useRef(null);
    const suitImg = useRef(new Image());
    const isDragging = useRef(false);
    const lastPos = useRef({ x: 0, y: 0 });
    const lastDist = useRef(0);

    const getClothesPath = (id) => id ? `${window.location.href.split('?')[0].replace(/\/[^\/]*$/, '')}/clothes/suit-${id}.png` : "";

    // æ‰‹å‹•è§¸ç™¼å»èƒŒåŠŸèƒ½
    const handleAIBgRemove = async () => {
        if (!image) return;
        setIsProcessing(true);
        const aiCanvas = await processFrame(image, false);
        if (aiCanvas) {
            const final = new Image();
            final.onload = () => { setImage(final); setIsProcessing(false); };
            final.src = aiCanvas.toDataURL();
        } else {
            setIsProcessing(false);
        }
    };

    // è§¸æ§è™•ç†
    const handleTouchStart = (e) => {
        if (!suit.id) return;
        if (e.touches.length === 2) {
            lastDist.current = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
        } else if (e.touches.length === 1) {
            isDragging.current = true;
            lastPos.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }
    };

    const handleTouchMove = (e) => {
        if (!suit.id) return;
        if (e.cancelable) e.preventDefault(); // é–å®šè¢å¹•æ»¾å‹•
        if (e.touches.length === 2) {
            const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            if (lastDist.current > 0) {
                const ratio = dist / lastDist.current;
                setSuit(prev => ({ ...prev, s: Math.min(Math.max(prev.s * ratio, 0.1), 0.9) }));
            }
            lastDist.current = dist;
        } else if (e.touches.length === 1 && isDragging.current) {
            const dx = e.touches[0].clientX - lastPos.current.x;
            const dy = e.touches[0].clientY - lastPos.current.y;
            const rect = canvasRef.current.getBoundingClientRect();
            setSuit(prev => ({ ...prev, x: prev.x + dx * (350/rect.width), y: prev.y + dy * (450/rect.height) }));
            lastPos.current = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }
    };

    // æ¨¡å‹è™•ç†
    useEffect(() => {
        const init = async () => {
            try {
                window.bodyPixModel = await bodyPix.load({ architecture: 'MobileNetV1', outputStride: 16, multiplier: 0.75 });
                window.faceModel = await blazeface.load();
            } catch(e) {}
        };
        init();
    }, []);

    const processFrame = async (source, isVideo) => {
        if (!window.bodyPixModel) return null;
        const seg = await window.bodyPixModel.segmentPerson(source, { internalResolution: 'medium', segmentationThreshold: 0.7 });
        const tc = document.createElement('canvas'); 
        tc.width = isVideo ? source.videoWidth : source.width; 
        tc.height = isVideo ? source.videoHeight : source.height;
        const ctx = tc.getContext('2d');
        if (isVideo) { ctx.save(); ctx.translate(tc.width, 0); ctx.scale(-1, 1); ctx.drawImage(source, 0, 0); ctx.restore(); }
        else ctx.drawImage(source, 0, 0);
        const imgData = ctx.getImageData(0, 0, tc.width, tc.height);
        for (let i = 0; i < imgData.data.length; i += 4) {
            const px = i / 4; const x = px % tc.width; const y = Math.floor(px / tc.width);
            const mX = isVideo ? (tc.width - 1 - x) : x;
            if (!seg.data[y * tc.width + mX]) imgData.data[i + 3] = 0;
        }
        ctx.putImageData(imgData, 0, 0);
        return tc;
    };

    const draw = useCallback(() => {
        const canvas = canvasRef.current; if (!canvas) return;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = bgColor; ctx.fillRect(0, 0, 350, 450);
        if (image) {
            ctx.save(); ctx.translate(175 + p.x, 225 + p.y); ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width / 2, -image.height / 2); ctx.restore();
        }
        if (suit.id) {
            const src = getClothesPath(suit.id);
            if (suitImg.current.src !== src) suitImg.current.src = src;
            if (suitImg.current.complete) {
                ctx.save(); ctx.translate(suit.x, suit.y); ctx.scale(suit.s * 1.5, suit.s * 1.5);
                ctx.drawImage(suitImg.current, -suitImg.current.width / 2, -suitImg.current.height / 2); ctx.restore();
            }
        }
    }, [image, p, suit, bgColor]);

    useEffect(() => { draw(); }, [draw]);

    const download = () => {
        const pc = document.createElement('canvas'); const ctx = pc.getContext('2d');
        pc.width = 1800; pc.height = 1200; ctx.fillStyle = "white"; ctx.fillRect(0, 0, 1800, 1200);
        
        const drawGrid = (cols, rows, w, h, sX, sY, gX, gY) => {
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    const x = sX + c * (w + gX);
                    const y = sY + r * (h + gY);
                    // ç¹ªè£½ç…§ç‰‡
                    ctx.drawImage(canvasRef.current, 0, 0, 350, 450, x, y, w, h);
                    // é—œéµï¼šè£œå›å‰ªè£ç°ç·š
                    ctx.strokeStyle = "#e2e8f0"; ctx.lineWidth = 1;
                    ctx.strokeRect(x, y, w, h);
                }
            }
        };
        if (mode === 'MIXED') { drawGrid(4,1,413,531,80,80,15,0); drawGrid(5,1,331,449,80,650,10,0); }
        else if (mode === 'TWO') drawGrid(4,2,413,531,80,80,20,30);
        else drawGrid(5,2,331,449,80,100,15,30);
        const a = document.createElement('a'); a.download = `EzID_Print_Layout.png`; a.href = pc.toDataURL(); a.click();
    };

    return (
        <div className="max-w-6xl mx-auto flex flex-col lg:flex-row gap-8 pb-32">
            <div className="w-full lg:w-[450px] flex flex-col items-center">
                <div 
                    className="canvas-container w-full aspect-[35/45] bg-white rounded-[40px] shadow-2xl overflow-hidden border-[10px] border-white select-none"
                    onTouchStart={handleTouchStart} onTouchMove={handleTouchMove} onTouchEnd={()=>{isDragging.current=false; lastDist.current=0;}}
                    onMouseDown={(e)=>{if(suit.id){isDragging.current=true; lastPos.current={x:e.clientX,y:e.clientY};}}}
                    onMouseMove={(e)=>{if(isDragging.current && suit.id){
                        const dx=e.clientX-lastPos.current.x; const dy=e.clientY-lastPos.current.y;
                        const rect=canvasRef.current.getBoundingClientRect();
                        setSuit(prev=>({...prev,x:prev.x+dx*(350/rect.width),y:prev.y+dy*(450/rect.height)}));
                        lastPos.current={x:e.clientX,y:e.clientY};
                    }}}
                    onMouseUp={()=>isDragging.current=false}
                >
                    <canvas ref={canvasRef} width={350} height={450} className="w-full h-full" />
                    <div className="id-guide"></div>
                    <div className="absolute top-5 right-5 flex flex-col gap-4 bg-white/50 p-2 rounded-full backdrop-blur-md">
                        {['white','#007bff','#ff0000'].map(c => (
                            <div key={c} onClick={()=>setBgColor(c)} className={`bg-dot ${bgColor===c?'active':''}`} style={{backgroundColor:c}}></div>
                        ))}
                    </div>
                    {isProcessing && <div className="absolute inset-0 bg-white/80 flex items-center justify-center font-black text-blue-600 animate-pulse">AI å»èƒŒä¸­...</div>}
                </div>

                <div className="w-full mt-8 grid grid-cols-2 gap-4">
                    <button onClick={() => { setIsCam(true); alert("è«‹ä½¿ç”¨ç›¸æ©Ÿå°æº–ä¸¦æ‹æ”"); }} className="bg-slate-900 text-white py-5 rounded-3xl font-black shadow-lg">ğŸ“· ç›¸æ©Ÿæ‹æ”</button>
                    <label className="bg-white border-2 border-slate-900 py-5 rounded-3xl font-black text-center cursor-pointer shadow-lg">ğŸ“ ä¸Šå‚³æª”æ¡ˆ <input type="file" className="hidden" onChange={(e)=>{
                        const file = e.target.files[0]; if(!file) return;
                        const img = new Image(); img.onload = () => setImage(img); img.src = URL.createObjectURL(file);
                    }} accept="image/*" /></label>
                    <button onClick={handleAIBgRemove} className="col-span-2 bg-blue-600 text-white py-4 rounded-2xl font-bold text-sm shadow-md">âœ¨ åŸ·è¡Œ AI è‡ªå‹•å»èƒŒ (è‹¥ä¸Šå‚³åŸåœ–æ™‚ä½¿ç”¨)</button>
                </div>
            </div>

            <div className="flex-1 space-y-8">
                <div className="bg-white p-6 md:p-10 rounded-[40px] shadow-sm border border-slate-200 space-y-10">
                    <div className="flex justify-between items-center border-b pb-6">
                        <h1 className="text-3xl font-black tracking-tighter italic">EzID <span className="text-blue-600">PRO</span></h1>
                        <span className="text-[10px] font-bold bg-slate-100 px-3 py-1 rounded-full text-slate-500 uppercase">Taiwan Standard</span>
                    </div>

                    <div className="space-y-12">
                        {/* äººç‰©èª¿æ•´ï¼šåŠ å¤§é–“è·é˜²èª¤è§¸ */}
                        <section className="space-y-6">
                            <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest">1. äººåƒä½ç½®èª¿æ•´</h3>
                            <div className="space-y-8 px-2">
                                <div className="space-y-3">
                                    <div className="flex justify-between text-xs font-bold"><span>äººç‰©ç¸®æ”¾</span><span className="text-blue-600">{(p.s*100).toFixed(0)}%</span></div>
                                    <input type="range" min="0.3" max="1.5" step="0.01" value={p.s} onChange={e=>setP({...p,s:parseFloat(e.target.value)})} />
                                </div>
                                <div className="space-y-3">
                                    <div className="flex justify-between text-xs font-bold"><span>å‚ç›´ç§»å‹•</span><span className="text-blue-600">{p.y}px</span></div>
                                    <input type="range" min="-150" max="150" value={p.y} onChange={e=>setP({...p,y:parseInt(e.target.value)})} />
                                </div>
                            </div>
                        </section>

                        {/* è¡£æœé¸æ“‡èˆ‡èª¿æ•´ */}
                        <section className="space-y-6">
                            <h3 className="text-xs font-black text-blue-500 uppercase tracking-widest">2. æ­£è£æ›¿æ›èˆ‡ç¸®æ”¾</h3>
                            <div className="space-y-8">
                                <div className="flex gap-4 overflow-x-auto pb-4 no-scrollbar">
                                    {['m1','m2','m3','m4','m5'].map(n=>(
                                        <div key={n} onClick={()=>setSuit({...suit, id:n})} className={`p-2 rounded-2xl border-2 shrink-0 cursor-pointer transition-all ${suit.id===n?'border-blue-600 bg-blue-50 scale-105 shadow-md':'border-slate-100 opacity-60'}`}>
                                            <img src={getClothesPath(n)} className="w-16 h-16 object-contain" />
                                        </div>
                                    ))}
                                    <button onClick={()=>setSuit({...suit, id:null})} className="px-6 border-2 border-dashed border-red-200 text-red-500 font-bold text-xs rounded-2xl shrink-0 bg-red-50/30">æ¸…é™¤è¡£æœ</button>
                                </div>
                                <div className="space-y-3 px-2">
                                    <div className="flex justify-between text-xs font-bold text-blue-600"><span>è¡£æœç¸®æ”¾</span><span>{(suit.s*100).toFixed(0)}%</span></div>
                                    <input type="range" min="0.1" max="0.8" step="0.01" value={suit.s} onChange={e=>setSuit({...suit,s:parseFloat(e.target.value)})} className="accent-blue-600"/>
                                </div>
                            </div>
                        </section>
                    </div>
                    
                    <div className="pt-10 border-t border-slate-100 flex flex-col md:flex-row gap-6 items-center">
                        <div className="flex-1 w-full flex gap-2 p-2 bg-slate-100 rounded-3xl">
                            {[['MIXED','æ··åˆ'],['TWO','ç´” 2 å‹'],['ONE','ç´” 1 å‹']].map(([k,v])=>(
                                <button key={k} onClick={()=>setMode(k)} className={`flex-1 py-4 rounded-2xl font-black text-xs transition ${mode===k?'bg-white text-slate-900 shadow-md':'text-slate-500'}`}>{v}</button>
                            ))}
                        </div>
                        <button onClick={download} className="w-full md:w-auto px-16 bg-blue-600 text-white py-6 rounded-[32px] font-black text-xl shadow-2xl active:scale-95 transition-all">ğŸ’¾ ä¸‹è¼‰ 4x6 å‹æª”æ¡ˆ</button>
                    </div>
                </div>
            </div>
        </div>
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
</script>
</body>
</html>
