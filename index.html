<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.47.6</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face { font-family: 'NotoSansTC'; src: local('Microsoft JhengHei'); font-weight: 700; }
        body { font-family: 'NotoSansTC', sans-serif; background: #2d3436; color: #f1f2f6; margin: 0; display: flex; justify-content: center; }
        #root { width: 100%; max-width: 480px; min-height: 100vh; }
        .editor-stage { position: relative; width: 100%; aspect-ratio: 350/450; background: #fff; border-radius: 12px; overflow: hidden; touch-action: none; }
        /* 人物定位圈樣式 */
        .guide-circle { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 60%; border: 2px dashed rgba(59, 130, 246, 0.4); border-radius: 50%; pointer-events: none; z-index: 5; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        /* ============================================================
           [區塊 B] 規格定義區 (SPECS) - 嚴格執行 12 種版面契約
           ============================================================ */
        const SPECS = {
            'A4-20':   { id: 'A4-20',   w: 2480, h: 3508, grid: [5, 4], size: [413, 531], name: 'A4 2吋(20)' },
            'A4-42':   { id: 'A4-42',   w: 2480, h: 3508, grid: [7, 6], size: [295, 413], name: 'A4 1吋(42)' },
            'A4-ID':   { id: 'A4-ID',   w: 2480, h: 3508, grid: [4, 4], size: [450, 600], name: 'A4 護照(16)' },
            'A4-BIG':  { id: 'A4-BIG',  w: 2480, h: 3508, grid: [4, 3], size: [531, 708], name: 'A4 大頭(12)' },
            'A4-B':    { id: 'A4-B',    w: 2480, h: 3508, grid: [6, 5], size: [354, 472], name: 'A4 B版(30)' },
            'NAME':    { id: 'NAME',    w: 2480, h: 3508, grid: [6, 4], size: [295, 413], name: '工牌(24)' },
            '4x6-8':   { id: '4x6-8',   w: 1800, h: 1200, grid: [2, 4], size: [413, 531], name: '4x6 2吋(8)' },
            '4x6-10':  { id: '4x6-10',  w: 1800, h: 1200, grid: [2, 5], size: [295, 413], name: '4x6 1吋(10)' },
            '4x6-12':  { id: '4x6-12',  w: 1800, h: 1200, grid: [3, 4], size: [295, 413], name: '4x6 1吋(12)' },
            '4x6-BIG': { id: '4x6-BIG', w: 1800, h: 1200, grid: [2, 3], size: [531, 708], name: '4x6 大頭(6)' },
            'A4-MIX':  { 
                id: 'A4-MIX', w: 2480, h: 3508, name: 'A4 綜合',
                sections: [
                    { x: 0, y: 0,    w: 2480, h: 1754, grid: [3, 4], size: [413, 531], count: 12 },
                    { x: 0, y: 1754, w: 2480, h: 1754, grid: [3, 6], size: [295, 413], count: 18 }
                ]
            },
            '4x6-MIX': { 
                id: '4x6-MIX', w: 1800, h: 1200, name: '4x6 綜合',
                sections: [
                    { x: 0,   y: 0, w: 900, h: 1200, grid: [2, 2], size: [450, 600], count: 4 },
                    { x: 900, y: 0, w: 900, h: 1200, grid: [2, 2], size: [413, 531], count: 4 }
                ]
            }
        };

        /* ============================================================
           [區塊 C] 繪圖引擎區 (RENDERER) - 負責座標運算與 Canvas 渲染
           ============================================================ */
        const Renderer = {
            calculateLayout: (spec) => { /* 略，同前版邏輯 */ },
            drawLayer: (ctx, img, transform, rect, baseWidth = 350) => {
                if (!img) return;
                const ratio = rect.w / baseWidth;
                const { x, y, s, r, f } = transform;
                ctx.save();
                ctx.translate(rect.x + rect.w / 2 + x * ratio, rect.y + rect.h / 2 + y * ratio);
                ctx.rotate((r * Math.PI) / 180);
                ctx.scale(s * ratio * (f || 1), s * ratio);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);
                ctx.restore();
            }
        };

        /* ============================================================
           [區塊 D] 主應用行為區 (APP COMPONENT)
           ============================================================ */
        function App() {
            // 1. State 管理：編輯參數、資產、快照、UI 狀態
            const [params, setParams] = useState({ photo: { x: 0, y: 0, s: 0.5, r: 0, f: 1 }, suit: { x: 0, y: 80, s: 0.8, r: 0, f: 1 } });
            const [assets, setAssets] = useState({ img: null, suit: null });
            const [history, setHistory] = useState([]);
            const [ui, setUi] = useState({ target: 'photo', activeSpec: 'A4-20', loading: false, results: null });

            // 2. 預覽渲染循環 (RAF)
            const renderPreview = useCallback(() => { /* 略 */ }, [assets, params]);
            useEffect(() => { /* RAF 控制器 */ }, [renderPreview]);

            // 3. 導出與批次處理邏輯 (滿足功能契約 4)
            const runExport = async (all = false) => { /* 略 */ };

            return (
                <div className="w-full flex flex-col p-5 gap-6">
                    {/* [區塊 E] UI 組件：標題、編輯器畫布、控制項、規格切換、導出按鈕 */}
                    <div className="editor-stage">
                        <canvas ref={canvasRef} width="350" height="450" className="w-full h-full" />
                        <div className="guide-circle"></div> {/* 人物圈引導 */}
                    </div>
                    {/* ... (其餘 UI 程式碼) */}
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
