<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID v20.47.9 - å€å¡ŠåŒ–å®Œæ•´ç‰ˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @font-face { font-family: 'NotoSansTC'; src: local('Microsoft JhengHei'); font-weight: 700; }
        body { font-family: 'NotoSansTC', sans-serif; background: #1e293b; color: #f8fafc; margin: 0; display: flex; justify-content: center; overflow-x: hidden; }
        #root { width: 100%; max-width: 500px; min-height: 100vh; padding: 20px 0; }
        .editor-stage { position: relative; width: 100%; aspect-ratio: 350/450; background: #ffffff; border-radius: 20px; overflow: hidden; touch-action: none; box-shadow: 0 25px 60px rgba(0,0,0,0.4); }
        .guide-circle { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 65%; border: 3px dashed rgba(59, 130, 246, 0.6); border-radius: 50%; pointer-events: none; z-index: 10; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type="range"] { accent-color: #3b82f6; }
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback, useTransition } = React;

/* ============================================================
   [å€å¡Š 2: æ ¸å¿ƒæ•¸æ“šè¦æ ¼] 
   å®šç¾© 12 ç¨®ç‰ˆé¢èˆ‡ MIX sections
   ============================================================ */
const SPECS = {
    'A4-20':   { id: 'A4-20',   w: 2480, h: 3508, grid: [5, 4], size: [413, 531], name: 'A4 2å‹(20)' },
    'A4-42':   { id: 'A4-42',   w: 2480, h: 3508, grid: [7, 6], size: [295, 413], name: 'A4 1å‹(42)' },
    'A4-ID':   { id: 'A4-ID',   w: 2480, h: 3508, grid: [4, 4], size: [450, 600], name: 'A4 è­·ç…§(16)' },
    'A4-BIG':  { id: 'A4-BIG',  w: 2480, h: 3508, grid: [4, 3], size: [531, 708], name: 'A4 å¤§é ­(12)' },
    'A4-B':    { id: 'A4-B',    w: 2480, h: 3508, grid: [6, 5], size: [354, 472], name: 'A4 Bç‰ˆ(30)' },
    'NAME':    { id: 'NAME',    w: 2480, h: 3508, grid: [6, 4], size: [295, 413], name: 'å·¥ç‰Œ(24)', special: true },
    '4x6-8':   { id: '4x6-8',   w: 1800, h: 1200, grid: [2, 4], size: [413, 531], name: '4x6 2å‹(8)' },
    '4x6-10':  { id: '4x6-10',  w: 1800, h: 1200, grid: [2, 5], size: [295, 413], name: '4x6 1å‹(10)' },
    '4x6-12':  { id: '4x6-12',  w: 1800, h: 1200, grid: [3, 4], size: [295, 413], name: '4x6 1å‹(12)' },
    '4x6-BIG': { id: '4x6-BIG', w: 1800, h: 1200, grid: [2, 3], size: [531, 708], name: '4x6 å¤§é ­(6)' },
    'A4-MIX':  { 
        id: 'A4-MIX', w: 2480, h: 3508, name: 'A4 ç¶œåˆ', mix: true,
        sections: [
            { x: 0, y: 0, w: 2480, h: 1754, grid: [3, 4], size: [413, 531], count: 12 },
            { x: 0, y: 1754, w: 2480, h: 1754, grid: [3, 6], size: [295, 413], count: 18 }
        ]
    },
    '4x6-MIX': { 
        id: '4x6-MIX', w: 1800, h: 1200, name: '4x6 ç¶œåˆ', mix: true,
        sections: [
            { x: 0, y: 0, w: 900, h: 1200, grid: [2, 2], size: [450, 600], count: 4 },
            { x: 900, y: 0, w: 900, h: 1200, grid: [2, 2], size: [413, 531], count: 4 }
        ]
    }
};

/* ============================================================
   [å€å¡Š 3: æ¸²æŸ“å¼•æ“] 
   è™•ç†ä½ˆå±€è¨ˆç®—èˆ‡ç•«å¸ƒç¹ªè£½é‚è¼¯
   ============================================================ */
const Renderer = {
    calculateLayout: (spec) => {
        const getGrid = (w, h, grid, size, ox = 0, oy = 0, maxCount = Infinity) => {
            const [rows, cols] = grid, [pw, ph] = size;
            const mx = (w - cols * pw) / (cols + 1);
            const my = (h - rows * ph) / (rows + 1);
            const coords = [];
            for (let r = 0; r < rows && coords.length < maxCount; r++) {
                for (let c = 0; c < cols && coords.length < maxCount; c++) {
                    coords.push({ x: ox + mx + c * (pw + mx), y: oy + my + r * (ph + my), w: pw, h: ph });
                }
            }
            return coords;
        };
        if (spec.sections) return spec.sections.flatMap(s => getGrid(s.w, s.h, s.grid, s.size, s.x, s.y, s.count));
        return getGrid(spec.w, spec.h, spec.grid, spec.size);
    },

    drawLayer: (ctx, img, transform, rect, baseWidth = 350) => {
        if (!img) return;
        const ratio = rect.w / baseWidth;
        const { x, y, s, r, f = 1 } = transform;
        ctx.save();
        ctx.translate(rect.x + rect.w / 2 + x * ratio, rect.y + rect.h / 2 + y * ratio);
        ctx.rotate((r * Math.PI) / 180);
        ctx.scale(s * ratio * f, s * ratio * f);
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, -img.width / 2, -img.height / 2);
        ctx.restore();
    },

    renderPreview: (ctx, assets, params) => {
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, 350, 450);
        const rect = { x: 0, y: 0, w: 350, h: 450 };
        Renderer.drawLayer(ctx, assets.img, params.photo, rect);
        Renderer.drawLayer(ctx, assets.suit, params.suit, rect);
        // å¼•å°åœˆç·šæ¢è™•ç†
        ctx.strokeStyle = 'rgba(59, 130, 246, 0.6)';
        ctx.lineWidth = 4;
        ctx.setLineDash([12, 8]);
        ctx.beginPath();
        ctx.ellipse(175, 225, 120, 170, 0, 0, Math.PI * 2);
        ctx.stroke();
    }
};

/* ============================================================
   [å€å¡Š 4: æ‡‰ç”¨ç¨‹å¼ä¸»é‚è¼¯] 
   åŒ…å«ç‹€æ…‹ç®¡ç†ã€æ‹–æ‹½æ§åˆ¶èˆ‡å°å‡ºæµç¨‹
   ============================================================ */
function App() {
    const canvasRef = useRef(null);
    const dragRef = useRef({ isDragging: false, startX: 0, startY: 0 });
    
    const [params, setParams] = useState({ 
        photo: { x: 0, y: -20, s: 0.5, r: 0, f: 1 }, 
        suit: { x: 0, y: 70, s: 0.82, r: 0, f: 1 } 
    });
    const [assets, setAssets] = useState({ img: null, suit: null });
    const [history, setHistory] = useState([]);
    const [ui, setUi] = useState({ target: 'photo', activeSpec: 'A4-20', loading: false, results: null });

    // å³æ™‚é è¦½å¾ªç’°
    useEffect(() => {
        const raf = () => {
            if (!canvasRef.current) return;
            Renderer.renderPreview(canvasRef.current.getContext('2d'), assets, params);
            requestAnimationFrame(raf);
        };
        const id = requestAnimationFrame(raf);
        return () => cancelAnimationFrame(id);
    }, [assets, params]);

    // æ‹–æ‹½æ§åˆ¶é‚è¼¯
    const handlePointerDown = (e) => {
        e.currentTarget.setPointerCapture(e.pointerId);
        dragRef.current = { isDragging: true, startX: e.clientX, startY: e.clientY };
    };

    const handlePointerMove = (e) => {
        if (!dragRef.current.isDragging) return;
        const dx = (e.clientX - dragRef.current.startX);
        const dy = (e.clientY - dragRef.current.startY);
        setParams(p => ({
            ...p,
            [ui.target]: {
                ...p[ui.target],
                x: p[ui.target].x + dx / p[ui.target].s,
                y: p[ui.target].y + dy / p[ui.target].s
            }
        }));
        dragRef.current.startX = e.clientX;
        dragRef.current.startY = e.clientY;
    };

    const handlePointerUp = () => dragRef.current.isDragging = false;

    // æ‰¹æ¬¡å°å‡ºå¼•æ“
    const runExport = async (batch = false) => {
        if (!assets.img) return alert('âš ï¸ è«‹å…ˆè¼‰å…¥ç…§ç‰‡ï¼');
        setUi(u => ({ ...u, loading: true }));
        try {
            const specs = batch ? Object.values(SPECS) : [SPECS[ui.activeSpec]];
            const results = [];
            for (const spec of specs) {
                const canvas = document.createElement('canvas');
                canvas.width = spec.w; canvas.height = spec.h;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, spec.w, spec.h);
                const layout = Renderer.calculateLayout(spec);
                layout.forEach((rect, i) => {
                    const snap = history[i % history.length] || { assets, params };
                    Renderer.drawLayer(ctx, snap.assets.img, snap.params.photo, rect);
                    Renderer.drawLayer(ctx, snap.assets.suit, snap.params.suit, rect);
                    if (spec.special && spec.id === 'NAME') {
                        ctx.fillStyle = '#f8fafc'; ctx.fillRect(rect.x, rect.y + rect.h - 70, rect.w, 70);
                        ctx.fillStyle = '#1e293b'; ctx.font = "bold 42px sans-serif"; ctx.textAlign = "center";
                        ctx.fillText(`å“¡${i+1}`, rect.x + rect.w/2, rect.y + rect.h - 25);
                    }
                    ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 2; ctx.strokeRect(rect.x, rect.y, rect.w, rect.h);
                });
                results.push({ id: spec.id, name: spec.name, url: canvas.toDataURL('image/jpeg', 0.95) });
                await new Promise(r => setTimeout(r, 50));
            }
            setUi(u => ({ ...u, results, loading: false }));
        } catch (e) { setUi(u => ({ ...u, loading: false })); }
    };

    /* ============================================================
       [å€å¡Š 5: ä½¿ç”¨è€…ä»‹é¢] 
       Tailwind ä½ˆå±€èˆ‡å…ƒä»¶
       ============================================================ */
    return (
        <div className="w-full flex flex-col p-6 gap-6">
            <header className="pb-4 border-b border-slate-700/50">
                <h1 className="text-3xl font-black text-blue-500 italic">EzID <span className="text-xs font-mono text-slate-500">v20.47.9</span></h1>
            </header>

            <div className="editor-stage" onPointerDown={handlePointerDown} onPointerMove={handlePointerMove} onPointerUp={handlePointerUp}>
                <canvas ref={canvasRef} width="350" height="450" className="w-full h-full" />
                <div className="guide-circle"></div>
                {ui.loading && <div className="absolute inset-0 bg-slate-900/90 z-50 flex items-center justify-center font-black text-blue-400">æ¸²æŸ“ä¸­...</div>}
            </div>

            <div className="grid grid-cols-2 gap-4">
                {['photo', 'suit'].map(t => (
                    <button key={t} onClick={() => setUi(u => ({ ...u, target: t }))}
                        className={`py-4 rounded-2xl font-black transition-all ${ui.target === t ? 'bg-blue-600 shadow-lg scale-105' : 'bg-slate-800 text-slate-500'}`}>
                        {t === 'photo' ? 'ğŸ‘¤ ç…§ç‰‡å±¤' : 'ğŸ‘” æ­£è£å±¤'}
                    </button>
                ))}
            </div>

            <div className="bg-slate-800/40 p-6 rounded-3xl space-y-4">
                <div className="flex justify-between text-xs font-bold text-slate-400"><span>ç¸®æ”¾èª¿æ•´</span><span>{params[ui.target].s.toFixed(2)}x</span></div>
                <input type="range" min="0.1" max="2.5" step="0.01" value={params[ui.target].s}
                    onChange={e => setParams(p => ({ ...p, [ui.target]: { ...p[ui.target], s: parseFloat(e.target.value) } }))} className="w-full" />
                <div className="grid grid-cols-2 gap-2">
                    <button onClick={() => setParams(p => ({ ...p, [ui.target]: { ...p[ui.target], r: (p[ui.target].r + 90) % 360 } }))} className="py-3 bg-slate-700 rounded-xl text-xs font-bold">ğŸ”„ æ—‹è½‰</button>
                    <button onClick={() => setParams(p => ({ ...p, [ui.target]: { ...p[ui.target], f: p[ui.target].f * -1 } }))} className="py-3 bg-slate-700 rounded-xl text-xs font-bold">â†” é¡åƒ</button>
                </div>
            </div>

            <div className="flex gap-2 overflow-x-auto no-scrollbar py-2">
                {Object.values(SPECS).map(spec => (
                    <button key={spec.id} onClick={() => setUi(u => ({ ...u, activeSpec: spec.id }))}
                        className={`flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${ui.activeSpec === spec.id ? 'bg-blue-600' : 'bg-slate-800 text-slate-500'}`}>{spec.name}</button>
                ))}
            </div>

            <div className="flex flex-col gap-3">
                <div className="flex gap-3">
                    <label className="flex-1 py-5 bg-slate-700 rounded-3xl text-center text-sm font-black cursor-pointer">ğŸ“¸ è¼‰å…¥ç…§ç‰‡<input type="file" hidden onChange={e => {
                        const f = e.target.files[0]; if(f){ const i = new Image(); i.onload = () => setAssets(a => ({...a, img: i})); i.src = URL.createObjectURL(f); }
                    }}/></label>
                    <button onClick={() => { if(assets.img) setHistory(h => [...h, {assets: {...assets}, params: JSON.parse(JSON.stringify(params))}]); }}
                        className="flex-1 py-5 bg-emerald-600 rounded-3xl text-sm font-black">ğŸ’¾ å¿«ç…§ ({history.length})</button>
                </div>
                <div className="flex gap-3">
                    <button onClick={() => runExport(false)} className="flex-[2] py-6 bg-blue-600 rounded-3xl font-black">ğŸ¯ å°å‡ºç•¶å‰</button>
                    <button onClick={() => runExport(true)} className="flex-1 py-6 bg-orange-600 rounded-3xl font-black">ğŸ”¥ å…¨æ‰¹æ¬¡</button>
                </div>
            </div>

            {ui.results && (
                <div className="fixed inset-0 bg-slate-950 z-[999] overflow-y-auto p-8">
                    <div className="flex flex-col gap-8 max-w-sm mx-auto">
                        <h2 className="text-3xl font-black text-blue-400 text-center">ç”¢ç”Ÿæˆåƒ</h2>
                        {ui.results.map((res, i) => (
                            <div key={i} className="bg-slate-900 p-4 rounded-3xl border border-white/10 space-y-4">
                                <p className="text-xs font-bold text-slate-400">{res.name}</p>
                                <img src={res.url} className="w-full rounded-xl" />
                                <a href={res.url} download={`${res.id}.jpg`} className="block w-full py-4 bg-blue-600 rounded-2xl text-center font-black">ä¸‹è¼‰</a>
                            </div>
                        ))}
                        <button onClick={() => setUi(u => ({ ...u, results: null }))} className="py-4 bg-white text-black rounded-full font-black">è¿”å›ç·¨è¼¯</button>
                    </div>
                </div>
            )}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
