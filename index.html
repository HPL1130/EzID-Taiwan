<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v16.0 FINAL</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .canvas-container { 
            position:relative; width:340px; height:437px; margin:10px auto; 
            background:#fff; border:4px solid #0f172a; border-radius:24px; overflow:hidden; 
            touch-action: none; cursor: grab; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }
        .canvas-container:active { cursor: grabbing; }
        .preview-overlay {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .btn-active { transform: scale(0.95); opacity: 0.8; }
    </style>
</head>
<body class="bg-slate-100 pb-20 font-sans select-none">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;
const SUITS = {
    male: ['male/m1.png','male/m2.png','male/m3.png','male/m4.png','male/m5.png'],
    female: ['female/f1.png','female/f2.png','female/f3.png','female/f4.png','female/f5.png']
};

function App() {
    const canvasRef = useRef(null);
    const dragPos = useRef({ x: 0, y: 0, isDown: false });
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [gender, setGender] = useState('male');
    const [target, setTarget] = useState("PHOTO");
    const [p, setP] = useState({ x: 0, y: -20, s: 0.45, r: 0, f: 1 });
    const [sp, setSp] = useState({ x: 0, y: 80, s: 1.0, r: 0 });
    const [cfg, setCfg] = useState({ bright: 100, guide: 0.8, name: "EzID" });
    const [slots, setSlots] = useState([]);
    const [preImg, setPreImg] = useState(null);

    // ğŸ¨ é«˜æ•ˆèƒ½ç•«å¸ƒæ¸²æŸ“ (ä¿®æ­£ ellipse èˆ‡ filter)
    const draw = useCallback(() => {
        const ctx = canvasRef.current.getContext("2d");
        ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, 350, 450);
        if (image) {
            ctx.save(); ctx.filter = `brightness(${cfg.bright}%)`;
            ctx.translate(175 + p.x, 225 + p.y); ctx.rotate(p.r * Math.PI / 180);
            ctx.scale(p.s * p.f, p.s); ctx.drawImage(image, -image.width/2, -image.height/2); ctx.restore();
        }
        if (suitImg) {
            ctx.save(); ctx.translate(175 + sp.x, 225 + sp.y); ctx.rotate(sp.r * Math.PI / 180);
            ctx.scale(sp.s, sp.s); ctx.drawImage(suitImg, -suitImg.width/2, -suitImg.height/2); ctx.restore();
        }
        if (cfg.guide > 0) {
            ctx.save(); ctx.globalAlpha = cfg.guide; ctx.setLineDash([5, 5]); ctx.lineWidth = 2;
            const isCentered = (Math.abs(p.x) < 5 && Math.abs(p.y+20) < 5);
            ctx.strokeStyle = isCentered ? "#10b981" : "#ef4444"; 
            ctx.beginPath(); ctx.ellipse(175, 203, 108, 160, 0, 0, Math.PI * 2); ctx.stroke(); ctx.restore();
        }
    }, [image, suitImg, p, sp, cfg]);

    useEffect(() => {
        let frame = requestAnimationFrame(function loop(){ draw(); frame = requestAnimationFrame(loop); });
        return () => cancelAnimationFrame(frame);
    }, [draw]);

    // ğŸ¯ åº§æ¨™é™åˆ¶æ‹–æ›³ (Clamping)
    const handlePointer = (e, type) => {
        if (type === 'start') {
            dragPos.current = { x: e.clientX, y: e.clientY, isDown: true };
        } else if (type === 'move' && dragPos.current.isDown) {
            const dx = (e.clientX - dragPos.current.x) * 0.8;
            const dy = (e.clientY - dragPos.current.y) * 0.8;
            if (target === "PHOTO") {
                setP(v => ({ x: Math.max(-180, Math.min(180, v.x + dx)), y: Math.max(-140, Math.min(240, v.y + dy)), s: v.s, r: v.r, f: v.f }));
            } else {
                setSp(v => ({ x: Math.max(-180, Math.min(180, v.x + dx)), y: Math.max(-140, Math.min(240, v.y + dy)), s: v.s, r: v.r }));
            }
            dragPos.current = { x: e.clientX, y: e.clientY, isDown: true };
        } else if (type === 'end') { dragPos.current.isDown = false; }
    };

    // ğŸ’¾ æ§½ä½å­˜æª” (åŒ…å«æˆªåœ–èˆ‡åƒæ•¸)
    const saveToSlot = () => {
        const temp = document.createElement("canvas"); temp.width = 350; temp.height = 450;
        const tctx = temp.getContext("2d"); tctx.drawImage(canvasRef.current, 0, 0);
        const newSlot = {
            snap: temp.toDataURL("image/png"),
            data: { image, suitImg, p: {...p}, sp: {...sp}, cfg: {...cfg} }
        };
        setSlots([newSlot, ...slots].slice(0, 10));
    };

    // ğŸ–¨ï¸ å®Œæ•´æ’ç‰ˆå¼•æ“ (è£œé½Š 4x6, 1å‹, MIX)
    const exportDoc = async (type, mode) => {
        if (!slots.length) return alert("è«‹å…ˆå­˜å…¥æ§½ä½");
        const isA4 = type === 'A4';
        const W = isA4 ? 2480 : 1800, H = isA4 ? 3508 : 1200;
        const pc = document.createElement("canvas"); pc.width = W; pc.height = H;
        const ctx = pc.getContext("2d"); ctx.fillStyle = "white"; ctx.fillRect(0, 0, W, H);
        
        const imgs = await Promise.all(slots.map(s => new Promise(res => {
            const i = new Image(); i.onload = () => res(i); i.src = s.snap;
        })));

        const put = (img, x, y, sw, sh) => {
            ctx.drawImage(img, x, y, sw, sh);
            ctx.strokeStyle = "#e0e0e0"; ctx.lineWidth = 2; ctx.strokeRect(x, y, sw, sh);
        };

        if (isA4) {
            if (mode === '2IN') for(let i=0; i<20; i++) put(imgs[i%imgs.length], 205+(i%4)*520, 300+Math.floor(i/4)*600, 413, 531);
            else if (mode === '1IN') for(let i=0; i<42; i++) put(imgs[i%imgs.length], 215+(i%6)*350, 250+Math.floor(i/6)*480, 295, 413);
            else { // MIX
                for(let i=0; i<12; i++) put(imgs[i%imgs.length], 205+(i%4)*520, 300+Math.floor(i/4)*600, 413, 531);
                for(let i=0; i<18; i++) put(imgs[i%imgs.length], 215+(i%6)*350, 2200+Math.floor(i/6)*480, 295, 413);
            }
        } else { // 4x6
            if (mode === 'MIX') {
                for(let i=0; i<4; i++) put(imgs[i%imgs.length], 90+i*410, 80, 413, 531);
                for(let i=0; i<5; i++) put(imgs[i%imgs.length], 90+i*325, 660, 295, 413);
            } else if (mode === '2IN') for(let i=0; i<8; i++) put(imgs[i%imgs.length], 90+(i%4)*410, 70+Math.floor(i/4)*540, 413, 531);
            else for(let i=0; i<10; i++) put(imgs[i%imgs.length], 150+(i%5)*310, 160+Math.floor(i/5)*460, 295, 413);
        }
        setPreImg(pc.toDataURL("image/png"));
    };

    return (
        <div className="max-w-md mx-auto p-4 space-y-4">
            <header className="flex justify-between items-center p-4 bg-white rounded-2xl shadow-sm border border-slate-200">
                <h1 className="text-xl font-black italic">EzID <span className="text-blue-600">v16.0</span></h1>
                <div className="flex gap-2">
                    <button onClick={()=>setP(v=>({...v, f:v.f*-1}))} className="px-3 py-1 bg-slate-800 text-white rounded-lg text-[10px] font-bold">é¡åƒ</button>
                    <button onClick={()=>{setP({x:0,y:-20,s:0.45,r:0,f:1}); setSp({x:0,y:80,s:1.0,r:0});}} className="px-3 py-1 bg-emerald-500 text-white rounded-lg text-[10px] font-bold">æ­¸ä½</button>
                </div>
            </header>

            <div className="canvas-container" onPointerDown={e=>handlePointer(e,'start')} onPointerMove={e=>handlePointer(e,'move')} onPointerUp={()=>handlePointer(null,'end')}>
                <canvas ref={canvasRef} width="350" height="450" className="w-full h-full" />
            </div>

            {/* æ€§åˆ¥åˆ†é¸èˆ‡è¡£æœæ¸…å–® */}
            <div className="bg-white p-4 rounded-3xl shadow-xl space-y-3 border border-slate-200">
                <div className="flex bg-slate-100 p-1 rounded-2xl">
                    <button onClick={()=>setGender('male')} className={`flex-1 py-2 text-xs font-bold rounded-xl ${gender==='male'?'bg-white shadow text-blue-600':'text-slate-400'}`}>ğŸ‘¨ ç”·è£</button>
                    <button onClick={()=>setGender('female')} className={`flex-1 py-2 text-xs font-bold rounded-xl ${gender==='female'?'bg-white shadow text-pink-600':'text-slate-400'}`}>ğŸ‘© å¥³è£</button>
                </div>
                <div className="flex gap-2 overflow-x-auto no-scrollbar py-1">
                    <button onClick={()=>{setSuitImg(null); setTarget("PHOTO")}} className="w-14 h-14 flex-shrink-0 bg-red-50 border-2 border-dashed border-red-200 rounded-xl text-xl">ğŸš«</button>
                    {SUITS[gender].map((s, idx) => (
                        <img key={idx} src={`clothes/${s}`} onClick={()=>{const i=new Image(); i.src=`clothes/${s}`; i.onload=()=>{setSuitImg(i); setTarget("SUIT")}} } className="w-14 h-14 flex-shrink-0 p-1 border-2 border-slate-100 rounded-xl bg-slate-50 active:scale-90 cursor-pointer" />
                    ))}
                </div>
            </div>

            {/* æ§åˆ¶å€ */}
            <div className="bg-white p-5 rounded-[2.5rem] shadow-xl space-y-4 border border-slate-200">
                <nav className="flex bg-slate-100 p-1 rounded-2xl">
                    <button onClick={()=>setTarget("PHOTO")} className={`flex-1 py-2 text-xs font-black rounded-xl ${target==='PHOTO'?'bg-white shadow text-blue-600':'text-slate-400'}`}>ç·¨è¼¯äººåƒ</button>
                    <button onClick={()=>setTarget("SUIT")} className={`flex-1 py-2 text-xs font-black rounded-xl ${target==='SUIT'?'bg-white shadow text-blue-600':'text-slate-400'}`}>ç·¨è¼¯è¡£æœ</button>
                </nav>
                <div className="space-y-3">
                    <div className="flex items-center gap-4 text-[10px] font-bold text-slate-400">
                        <span className="w-12">SIZE</span>
                        <input type="range" min="0.1" max="2" step="0.01" value={target==="PHOTO"?p.s:sp.s} onChange={e=>target==="PHOTO"?setP({...p,s:+e.target.value}):setSp({...sp,s:+e.target.value})} className="flex-1 accent-blue-600" />
                    </div>
                    <div className="flex items-center gap-4 text-[10px] font-bold text-slate-400">
                        <span className="w-12">ROTATE</span>
                        <input type="range" min="-45" max="45" value={target==="PHOTO"?p.r:sp.r} onChange={e=>target==="PHOTO"?setP({...p,r:+e.target.value}):setSp({...sp,r:+e.target.value})} className="flex-1 accent-emerald-500" />
                    </div>
                </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
                <label className="bg-slate-900 text-white py-4 rounded-3xl text-center font-black cursor-pointer shadow-lg active:btn-active">ğŸ“¸ ä¸Šå‚³ <input type="file" hidden onChange={e=>{const f=e.target.files[0]; if(f){const i=new Image(); i.src=URL.createObjectURL(f); i.onload=()=>{setImage(i); setTarget("PHOTO")}} }} /></label>
                <button onClick={saveToSlot} className="bg-blue-600 text-white py-4 rounded-3xl font-black shadow-lg active:btn-active">ğŸ“¥ å­˜å…¥æ§½ä½</button>
            </div>

            {/* æ§½ä½é‚„åŸå€ */}
            <div className="flex gap-3 overflow-x-auto no-scrollbar p-1">
                {slots.map((s, i) => (
                    <div key={i} className="relative w-20 h-28 bg-white rounded-xl shadow-md flex-shrink-0 overflow-hidden group">
                        <img src={s.snap} className="w-full h-full object-cover" />
                        <button onClick={()=>setSlots(slots.filter((_,idx)=>idx!==i))} className="absolute top-0 right-0 bg-red-500 text-white w-5 h-5 text-[10px]">âœ•</button>
                        <div onClick={()=>{const d=s.data; setImage(d.image); setSuitImg(d.suitImg); setP(d.p); setSp(d.sp); setCfg(d.cfg)}} className="absolute bottom-0 inset-x-0 bg-black/60 text-white text-[8px] py-1 text-center cursor-pointer">è¼‰å…¥</div>
                    </div>
                ))}
            </div>

            {/* æœ€çµ‚è£œé½Šçš„æ’ç‰ˆæŒ‰éˆ• */}
            <div className="bg-white p-5 rounded-3xl shadow-xl border border-slate-200">
                <div className="grid grid-cols-3 gap-2 mb-3">
                    {['MIX','2IN','1IN'].map(m => <button key={m} onClick={()=>exportDoc('A4',m)} className="bg-slate-800 text-white py-3 rounded-xl text-[9px] font-black">A4 {m}</button>)}
                </div>
                <div className="grid grid-cols-3 gap-2">
                    {['MIX','2IN','1IN'].map(m => <button key={m} onClick={()=>exportDoc('46',m)} className="bg-emerald-600 text-white py-3 rounded-xl text-[9px] font-black">4x6 {m}</button>)}
                </div>
            </div>

            {preImg && (
                <div className="preview-overlay" onClick={()=>setPreImg(null)}>
                    <img src={preImg} className="max-w-[90vw] max-h-[70vh] rounded-lg shadow-2xl mb-6" />
                    <div className="flex gap-4 w-full max-w-xs">
                        <button onClick={()=>setPreImg(null)} className="flex-1 py-4 bg-slate-700 text-white rounded-2xl font-bold">è¿”å›</button>
                        <a href={preImg} download={`${cfg.name}_export.png`} className="flex-1 py-4 bg-blue-500 text-white rounded-2xl font-bold text-center">ä¸‹è¼‰</a>
                    </div>
                </div>
            )}
        </div>
    );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
