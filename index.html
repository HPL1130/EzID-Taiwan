<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EzID Taiwan v3.8.0 - Manual Control</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display:none; }
        .canvas-container { 
            position:relative; width:350px; height:450px; margin:0 auto; 
            background:#fff; border:2px solid #334155; border-radius:12px; overflow:hidden; 
            touch-action: none; cursor: grab;
        }
        .inner-guide { position:absolute; left:50%; top:45%; width:62%; height:71.1%; border:2px dotted #10b981; border-radius:50%/44%; transform:translate(-50%,-50%); z-index:100; pointer-events:none; }
        .outer-guide { position:absolute; left:50%; top:45%; width:70%; height:80%; border:2px dashed #f59e0b; border-radius:50%/44%; transform:translate(-50%,-50%); z-index:99; pointer-events:none; }
        input[type=range] { width: 100%; accent-color: #2563eb; }
    </style>
</head>
<body class="bg-slate-100 p-4">
    <div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

const SUITS = [
    ...Array(5).fill(0).map((_, i) => `male/m${i+1}.png`),
    ...Array(5).fill(0).map((_, i) => `female/f${i+1}.png`)
];

function App() {
    const canvasRef = useRef(null);
    const [image, setImage] = useState(null);
    const [suitImg, setSuitImg] = useState(null);
    const [slots, setSlots] = useState([]);
    const [target, setTarget] = useState("PHOTO"); // PHOTO æˆ– SUIT
    
    // åº§æ¨™èˆ‡ç¸®æ”¾ (å®Œå…¨æ‰‹å‹•ï¼Œä¸å†è‡ªå‹•è¦†è“‹)
    const [p, setP] = useState({ x: 0, y: -20, s: 0.8 });
    const [sp, setSp] = useState({ x: 0, y: 80, s: 1.0 });

    const isDragging = useRef(false);
    const lastPos = useRef({ x: 0, y: 0 });

    const draw = useCallback(() => {
        const ctx = canvasRef.current.getContext("2d");
        ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, 350, 450);

        if (image) {
            ctx.save();
            ctx.translate(175 + p.x, 225 + p.y);
            ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width/2, -image.height/2);
            ctx.restore();
        }

        if (suitImg) {
            ctx.save();
            const w = suitImg.width * sp.s;
            const h = suitImg.height * sp.s;
            ctx.drawImage(suitImg, 175 - w/2 + sp.x, 225 - h/2 + sp.y, w, h);
            ctx.restore();
        }
    }, [image, suitImg, p, sp]);

    useEffect(() => { draw(); }, [draw]);

    // æ‹–æ›³æ§åˆ¶
    const handleStart = (e) => {
        isDragging.current = true;
        const pos = e.touches ? e.touches[0] : e;
        lastPos.current = { x: pos.clientX, y: pos.clientY };
    };
    const handleMove = (e) => {
        if (!isDragging.current) return;
        const pos = e.touches ? e.touches[0] : e;
        const dx = pos.clientX - lastPos.current.x;
        const dy = pos.clientY - lastPos.current.y;
        if (target === "PHOTO") setP(v => ({ ...v, x: v.x + dx, y: v.y + dy }));
        else setSp(v => ({ ...v, x: v.x + dx, y: v.y + dy }));
        lastPos.current = { x: pos.clientX, y: pos.clientY };
    };

    // çœŸæ­£çš„è¼¸å‡º Solver (æ”¯æ´ 4x6 & A4)
    const exportDoc = async (type, mode) => {
        if (!slots.length) return alert("æ§½ä½ç©ºç©ºå¦‚ä¹Ÿï¼");
        const W = type === '46' ? 1200 : 2480;
        const H = type === '46' ? 1800 : 3508;
        const pc = document.createElement("canvas");
        pc.width = W; pc.height = H;
        const ctx = pc.getContext("2d");
        ctx.fillStyle = "white"; ctx.fillRect(0, 0, W, H);

        const imgs = await Promise.all(slots.map(src => new Promise(res => {
            const i = new Image(); i.onload = () => res(i); i.src = src;
        })));

        let curY = type === '46' ? 50 : 100;
        const drawGrid = (sw, sh, gap, count) => {
            const cols = Math.floor((W - 100) / (sw + gap));
            const startX = (W - (cols * sw + (cols - 1) * gap)) / 2;
            for(let i=0; i<count; i++){
                const x = startX + (i % cols) * (sw + gap);
                const y = curY + Math.floor(i / cols) * (sh + gap);
                if (y + sh > H - 50) break;
                ctx.drawImage(imgs[i % imgs.length], x, y, sw, sh);
                ctx.strokeStyle = "#eee"; ctx.strokeRect(x, y, sw, sh);
            }
            curY += Math.ceil(count / cols) * (sh + gap) + gap;
        };

        if(mode === 'MIX') { 
            drawGrid(413, 531, 40, type === '46' ? 2 : 8); 
            drawGrid(295, 413, 30, type === '46' ? 4 : 12);
        } else if(mode === '2IN') { drawGrid(413, 531, 40, type === '46' ? 8 : 20); }
        else { drawGrid(295, 413, 30, type === '46' ? 12 : 35); }

        const a = document.createElement("a");
        a.href = pc.toDataURL("image/png");
        a.download = `EzID_${type}_${mode}.png`; a.click();
    };

    return (
        <div className="max-w-md mx-auto space-y-4 pb-10">
            <div className="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm">
                <h1 className="font-black italic text-xl">EzID v3.8.0</h1>
                <div className="flex gap-1 bg-slate-100 p-1 rounded-lg">
                    {["PHOTO", "SUIT"].map(t => (
                        <button key={t} onClick={()=>setTarget(t)} className={`px-4 py-1 text-xs font-bold rounded-md ${target===t?'bg-white shadow text-blue-600':'text-slate-400'}`}>
                            {t === "PHOTO" ? "äººåƒ" : "è¡£æœ"}
                        </button>
                    ))}
                </div>
            </div>

            <div className="canvas-container shadow-2xl"
                 onMouseDown={handleStart} onMouseMove={handleMove} onMouseUp={()=>isDragging.current=false}
                 onTouchStart={handleStart} onTouchMove={handleMove} onTouchEnd={()=>isDragging.current=false}>
                <canvas ref={canvasRef} width="350" height="450" />
                <div className="inner-guide"></div><div className="outer-guide"></div>
            </div>

            {/* æ‰‹å‹•èª¿æ•´å€åŸŸï¼šSlider å›æ­¸ */}
            <div className="bg-white p-4 rounded-2xl shadow-sm space-y-3">
                <div className="flex justify-between text-[10px] font-bold text-slate-400 uppercase">
                    <span>{target} SIZE CONTROL</span>
                    <span>{Math.round((target==="PHOTO"?p.s:sp.s)*100)}%</span>
                </div>
                <input type="range" min="0.1" max="2.5" step="0.01" 
                       value={target === "PHOTO" ? p.s : sp.s} 
                       onChange={(e) => {
                           const val = +e.target.value;
                           if(target === "PHOTO") setP(v => ({...v, s: val}));
                           else setSp(v => ({...v, s: val}));
                       }} />
            </div>

            <div className="bg-white p-4 rounded-2xl shadow-sm overflow-hidden">
                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                    <button onClick={()=>setSuitImg(null)} className="flex-shrink-0 w-12 h-12 bg-slate-50 border-2 border-dashed rounded-xl">âœ•</button>
                    {SUITS.map(id => (
                        <button key={id} onClick={()=>{
                            const img = new Image(); img.onload = () => { setSuitImg(img); setTarget("SUIT"); };
                            img.src = `clothes/${id}`;
                        }} className="flex-shrink-0 w-12 h-12 border rounded-xl overflow-hidden bg-slate-50">
                            <img src={`clothes/${id}`} className="w-full h-full object-contain" />
                        </button>
                    ))}
                </div>
            </div>

            <div className="grid grid-cols-2 gap-3">
                <label className="bg-slate-800 text-white py-4 rounded-2xl text-center text-sm font-bold cursor-pointer">
                    ğŸ“¸ ä¸Šå‚³ç…§ç‰‡ <input type="file" hidden accept="image/*" onChange={e => {
                        const img = new Image(); img.onload = () => { setImage(img); setTarget("PHOTO"); };
                        img.src = URL.createObjectURL(e.target.files[0]);
                    }} />
                </label>
                <button onClick={() => setSlots([canvasRef.current.toDataURL(), ...slots].slice(0,10))} 
                        className="bg-blue-600 text-white py-4 rounded-2xl text-sm font-bold shadow-lg">å­˜å…¥æ§½ä½ ({slots.length})</button>
            </div>

            <div className="space-y-3">
                <div className="grid grid-cols-3 gap-2">
                    <button onClick={()=>exportDoc('46','MIX')} className="bg-emerald-600 text-white py-3 rounded-xl text-[10px] font-bold">4x6 æ··æ’</button>
                    <button onClick={()=>exportDoc('46','2IN')} className="bg-slate-700 text-white py-3 rounded-xl text-[10px] font-bold">4x6 2å‹</button>
                    <button onClick={()=>exportDoc('46','1IN')} className="bg-slate-700 text-white py-3 rounded-xl text-[10px] font-bold">4x6 1å‹</button>
                </div>
                <div className="grid grid-cols-3 gap-2">
                    <button onClick={()=>exportDoc('A4','MIX')} className="bg-blue-600 text-white py-3 rounded-xl text-[10px] font-bold">A4 æ··æ’</button>
                    <button onClick={()=>exportDoc('A4','2IN')} className="bg-slate-500 text-white py-3 rounded-xl text-[10px] font-bold">A4 2å‹</button>
                    <button onClick={()=>exportDoc('A4','1IN')} className="bg-slate-500 text-white py-3 rounded-xl text-[10px] font-bold">A4 1å‹</button>
                </div>
            </div>
        </div>
    );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
