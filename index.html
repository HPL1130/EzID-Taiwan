<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>EzID Taiwan v2.5.0</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body{background:#f1f5f9;overflow-x:hidden;font-family:sans-serif}
        .canvas-box{background:#e5e7eb;border-radius:32px;border:8px solid #fff;box-shadow:0 20px 40px rgba(0,0,0,.1)}
        .id-guide{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
        /* è¼”åŠ©ç·šæœƒéš¨ç‹€æ…‹è®Šè‰² */
        .id-guide::after{
            content:"";width:62%;height:62%;border:2px dashed;border-radius:50%;
            transition: border-color 0.3s;
        }
        .status-ok .id-guide::after{border-color: rgba(16, 185, 129, 0.5)}
        .status-warn .id-guide::after{border-color: rgba(245, 158, 11, 0.6)}
        .status-bad .id-guide::after{border-color: rgba(239, 68, 68, 0.8)}
        
        .slot-item{width:60px;height:80px;border-radius:8px;overflow:hidden;border:2px solid #fff;box-shadow:0 2px 5px rgba(0,0,0,0.1);flex-shrink:0;position:relative}
    </style>
</head>
<body class="p-4 md:p-8">
<div id="root"></div>

<script type="text/babel">
const {useState, useRef, useEffect, useCallback} = React;

function App(){
    const canvasRef = useRef(null);
    const [mode, setMode] = useState("guided");
    const [image, setImage] = useState(null);
    const [p, setP] = useState({x:0, y:-20, s:0.75});
    const [preset, setPreset] = useState("id");
    const [slots, setSlots] = useState([]);

    const PRESETS = {
        id: {label:"æˆ¶æ”¿è­‰ä»¶", min:65, max:85},
        passport: {label:"è­·ç…§è¦ç¯„", min:70, max:80},
        resume: {label:"å±¥æ­· / å•†å‹™", min:60, max:75}
    };

    const ratio = Math.round(p.s * 100);
    const status = 
        ratio < PRESETS[preset].min - 5 || ratio > PRESETS[preset].max + 5 ? "bad" :
        ratio < PRESETS[preset].min || ratio > PRESETS[preset].max ? "warn" : "ok";

    // ç¹ªè£½ç•«å¸ƒ
    const draw = useCallback(() => {
        const ctx = canvasRef.current.getContext("2d");
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, 350, 450);
        if(image){
            ctx.save();
            ctx.translate(175 + p.x, 225 + p.y);
            ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width/2, -image.height/2);
            ctx.restore();
        }
    }, [image, p]);

    useEffect(() => {
        draw();
    }, [draw]);

    // æ‹¼ç‰ˆä¸‹è¼‰é‚è¼¯
    const downloadSheet = async () => {
        if(slots.length === 0) return alert("è«‹å…ˆå­˜å…¥è‡³å°‘ä¸€å¼µç…§ç‰‡");
        const pc = document.createElement("canvas");
        pc.width = 1800; pc.height = 1200;
        const pctx = pc.getContext("2d");
        pctx.fillStyle = "white";
        pctx.fillRect(0, 0, 1800, 1200);

        const imgs = await Promise.all(slots.map(src => new Promise(res => {
            const img = new Image(); img.onload = () => res(img); img.src = src;
        })));

        pctx.strokeStyle = "#ccc"; pctx.lineWidth = 1;
        // 4å¼µ 2å‹
        for(let i=0; i<4; i++) {
            pctx.drawImage(imgs[i % imgs.length], 80 + i*428, 80, 413, 531);
            pctx.strokeRect(80 + i*428, 80, 413, 531);
        }
        // 5å¼µ 1å‹
        for(let i=0; i<5; i++) {
            pctx.drawImage(imgs[i % imgs.length], 80 + i*341, 650, 331, 449);
            pctx.strokeRect(80 + i*341, 650, 331, 449);
        }

        const link = document.createElement("a");
        link.download = `EzID_PrintSheet.png`;
        link.href = pc.toDataURL("image/png");
        link.click();
    };

    return(
    <div className="max-w-5xl mx-auto grid md:grid-cols-2 gap-10">
        {/* å·¦å´é è¦½èˆ‡è¨ºæ–· */}
        <div className={`status-${status}`}>
            <div className="flex justify-between items-center mb-4">
                <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">EzID Taiwan v2.5.0</span>
                <button
                    onClick={() => setMode(mode === "guided" ? "studio" : "guided")}
                    className="px-4 py-1.5 rounded-full text-[10px] font-black text-white transition-all shadow-md"
                    style={{background: mode === "guided" ? "#10b981" : "#0f172a"}}
                >
                    {mode === "guided" ? "ğŸ§­ å»ºè­°æ¨¡å¼" : "ğŸ¨ å°ˆæ¥­ç·¨è¼¯"}
                </button>
            </div>

            <div className="relative canvas-box w-full max-w-[350px] mx-auto aspect-[35/45]">
                <canvas ref={canvasRef} width="350" height="450" className="w-full h-full rounded-[24px]"></canvas>
                {mode === "guided" && <div className="id-guide"></div>}
            </div>

            <div className="mt-6 bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                <div className="flex items-center justify-between mb-2">
                    <span className="text-xs font-bold text-slate-500">é ­éƒ¨æ¯”ä¾‹ï¼š<b className="text-lg text-slate-900">{ratio}%</b></span>
                    <span className={`text-[10px] font-bold px-2 py-1 rounded-full ${
                        status === "ok" ? "bg-emerald-100 text-emerald-700" :
                        status === "warn" ? "bg-amber-100 text-amber-700" : "bg-red-100 text-red-700"
                    }`}>
                        {status === "ok" ? "ğŸŸ¢ ç¬¦åˆå»ºè­°" : status === "warn" ? "ğŸŸ¡ æ¥è¿‘é‚Šç•Œ" : "ğŸ”´ æ˜é¡¯åé›¢"}
                    </span>
                </div>
                {mode === "guided" && (
                    <div className="flex items-center gap-2">
                        <select value={preset} onChange={e => setPreset(e.target.value)} className="text-xs border rounded-lg px-2 py-1 bg-slate-50">
                            {Object.entries(PRESETS).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}
                        </select>
                        <span className="text-[10px] text-slate-400">å»ºè­°ç¯„åœï¼š{PRESETS[preset].min}% â€“ {PRESETS[preset].max}%</span>
                    </div>
                )}
            </div>
        </div>

        {/* å³å´æ§åˆ¶é¢æ¿ */}
        <div className="flex flex-col gap-6">
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                <div className="grid grid-cols-2 gap-3 mb-6">
                    <label className="flex flex-col items-center justify-center border-2 border-dashed border-slate-200 rounded-2xl p-4 hover:bg-slate-50 cursor-pointer transition-all">
                        <span className="text-sm font-bold text-slate-700">ğŸ“ ä¸Šå‚³ç…§ç‰‡</span>
                        <input type="file" hidden onChange={e => {
                            const f = e.target.files[0];
                            if(f){
                                const img = new Image();
                                img.onload = () => setImage(img);
                                img.src = URL.createObjectURL(f);
                            }
                        }}/>
                    </label>
                    <button onClick={() => {
                        const data = canvasRef.current.toDataURL("image/jpeg", 0.9);
                        setSlots([data, ...slots].slice(0, 8));
                    }} className="bg-blue-600 text-white rounded-2xl font-bold text-sm shadow-lg shadow-blue-100 active:scale-95 transition-all">
                        ğŸ“¥ å­˜å…¥æ’ç‰ˆæ§½
                    </button>
                </div>

                <div className="space-y-5">
                    <div>
                        <div className="flex justify-between text-[10px] font-black text-slate-400 mb-2 uppercase"><span>äººåƒç¸®æ”¾</span><span>{ratio}%</span></div>
                        <input type="range" min="0.3" max="1.5" step="0.01" value={p.s} onChange={e => setP({...p, s: +e.target.value})} className="w-full h-1.5 bg-slate-100 rounded-lg appearance-none accent-blue-600 cursor-pointer"/>
                    </div>
                    <div>
                        <div className="flex justify-between text-[10px] font-black text-slate-400 mb-2 uppercase"><span>å‚ç›´ä½ç§»</span><span>{p.y}px</span></div>
                        <input type="range" min="-150" max="150" value={p.y} onChange={e => setP({...p, y: +e.target.value})} className="w-full h-1.5 bg-slate-100 rounded-lg appearance-none accent-blue-600 cursor-pointer"/>
                    </div>
                </div>
            </div>

            {/* æ’ç‰ˆæ§½é è¦½ */}
            <div className="bg-white p-4 rounded-3xl border border-slate-100">
                <div className="text-[10px] font-black text-slate-400 mb-3 uppercase tracking-wider">æ’ç‰ˆæš«å­˜æ§½ ({slots.length}/8)</div>
                <div className="flex gap-2 overflow-x-auto pb-2">
                    {slots.map((src, i) => (
                        <div key={i} className="slot-item group">
                            <img src={src} className="w-full h-full object-cover"/>
                            <button onClick={() => setSlots(slots.filter((_, idx) => idx !== i))} className="absolute inset-0 bg-red-500/80 text-white text-[10px] font-bold opacity-0 group-hover:opacity-100 transition-opacity">ç§»é™¤</button>
                        </div>
                    ))}
                    {slots.length === 0 && <div className="h-20 flex-1 flex items-center justify-center border-2 border-dashed border-slate-100 rounded-lg text-[10px] text-slate-300 italic">å°šæœªå­˜å…¥ç…§ç‰‡</div>}
                </div>
            </div>

            <button onClick={downloadSheet} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-black shadow-xl hover:bg-slate-800 transition-all active:scale-[0.98]">
                ğŸ’¾ ä¸‹è¼‰ 4x6 å‹æ‹¼ç‰ˆç…§ç‰‡
            </button>

            <div className="text-[9px] text-slate-400 leading-relaxed text-center bg-slate-50 p-3 rounded-xl border border-slate-100">
                â€» æœ¬å·¥å…·åƒ…æä¾›æ’ç‰ˆèˆ‡å»ºè­°åŠŸèƒ½ã€‚ç…§ç‰‡æ¯”ä¾‹èˆ‡è‰²å½©æ˜¯å¦ç¬¦åˆå„æ©Ÿé—œæœ€æ–°è¦ç¯„ï¼Œè«‹ä½¿ç”¨è€…ä¸‹è¼‰å‰è‡ªè¡Œç¢ºèªã€‚ EzID Taiwan ä¸æ‰¿æ“”å› ç…§ç‰‡ä¸åˆè¦å°è‡´ä¹‹æå¤±ã€‚
            </div>
        </div>
    </div>
    );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
