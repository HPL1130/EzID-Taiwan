<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EzID Taiwan v1.6.1 - AI æœ¬åœ°å»èƒŒç‰ˆ</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0/dist/body-pix.min.js"></script>
<style>
body { background-color: #f8fafc; color: #1e293b; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
canvas { border-radius: 12px; max-width: 100%; height: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #cbd5e1; background-color: white; }
.guide-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -55%); width: 55%; height: 55%; border: 2px dashed rgba(239, 68, 68, 0.4); border-radius: 50%; pointer-events: none; z-index: 10; }
.app-card { background: #ffffff; border-radius: 20px; border: 1px solid #cbd5e1; }
.no-scrollbar::-webkit-scrollbar { display: none; }
.gray-line { border-top: 1.5px solid #94a3b8; margin: 24px 0; width: 100%; }
input[type=range] { accent-color: #0f172a; }
.bg-dot { width: 26px; height: 26px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 0 0 1px #cbd5e1; transition: transform 0.2s; }
.bg-dot:hover { transform: scale(1.1); }
.bg-dot.active { box-shadow: 0 0 0 2px #0f172a; transform: scale(1.1); }
</style>
</head>
<body class="p-3 md:p-6 no-scrollbar">
<div id="root"></div>

<script type="text/babel">
const { useState, useRef, useEffect, useCallback } = React;

const EzIDApp = () => {
    const [image, setImage] = useState(null);
    const [uploadedBlob, setUploadedBlob] = useState(null);
    const [isCam, setIsCam] = useState(false);
    const [mode, setMode] = useState('MIXED');
    const [bgColor, setBgColor] = useState('white');
    const [p, setP] = useState({ x: 0, y: 0, s: 0.6 });
    const [suit, setSuit] = useState({ id: null, x: 175, y: 340, s: 0.3 });
    const [isProcessing, setIsProcessing] = useState(false);
    const [bodyPixModel, setBodyPixModel] = useState(null);

    const canvasRef = useRef(null);
    const videoRef = useRef(null);
    const suitImg = useRef(new Image());

    const getClothesPath = (id) => {
        const url = window.location.href.split('?')[0];
        const baseUrl = url.endsWith('/') ? url : url.substring(0, url.lastIndexOf('/') + 1);
        return `${baseUrl}clothes/suit-${id}.png`;
    };

    // 1. åˆå§‹åŒ–è¼‰å…¥ BodyPix æ¨¡å‹
    useEffect(() => {
        bodyPix.load({
            architecture: 'MobileNetV1',
            outputStride: 16,
            multiplier: 0.75
        }).then(m => {
            setBodyPixModel(m);
            console.log("AI Model Loaded");
        });
    }, []);

    // 2. AI å»èƒŒæ ¸å¿ƒå‡½æ•¸
    const removeBackgroundBodyPix = async (imgObj) => {
        if (!bodyPixModel) return imgObj;
        const segmentation = await bodyPixModel.segmentPerson(imgObj, {
            internalResolution: 'medium',
            segmentationThreshold: 0.7
        });
        
        const c = document.createElement('canvas');
        c.width = imgObj.width; c.height = imgObj.height;
        const ctx = c.getContext('2d');
        ctx.drawImage(imgObj, 0, 0);
        
        const imgData = ctx.getImageData(0, 0, c.width, c.height);
        for (let i = 0; i < imgData.data.length; i += 4) {
            const px = i / 4;
            const x = px % c.width, y = Math.floor(px / c.width);
            // å¦‚æœ AI åˆ¤æ–·è©²åƒç´ ä¸æ˜¯äººé«”ï¼Œå‰‡è¨­ç‚ºé€æ˜
            if (!segmentation.data[y * c.width + x]) {
                imgData.data[i + 3] = 0;
            }
        }
        ctx.putImageData(imgData, 0, 0);
        
        const resultImg = new Image();
        return new Promise((resolve) => {
            resultImg.onload = () => resolve(resultImg);
            resultImg.src = c.toDataURL();
        });
    };

    // 3. ç•«å¸ƒæ¸²æŸ“é‚è¼¯
    const draw = useCallback(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        
        // å¡«èƒŒæ™¯è‰²
        ctx.fillStyle = bgColor;
        ctx.fillRect(0, 0, 350, 450);
        
        // ç•«äººåƒ
        if (image) {
            ctx.save();
            ctx.translate(175 + p.x, 225 + p.y);
            ctx.scale(p.s, p.s);
            ctx.drawImage(image, -image.width / 2, -image.height / 2);
            ctx.restore();
        }
        
        // ç•«è¡£æœ
        if (suit.id) {
            const src = getClothesPath(suit.id);
            if (suitImg.current.src !== src) { 
                suitImg.current.src = src; 
                suitImg.current.onload = draw; 
            }
            if (suitImg.current.complete) {
                ctx.save();
                ctx.translate(suit.x, suit.y);
                ctx.scale(suit.s * 1.5, suit.s * 1.5);
                ctx.drawImage(suitImg.current, -suitImg.current.width / 2, -suitImg.current.height / 2);
                ctx.restore();
            }
        }
    }, [image, p, suit, bgColor]);

    useEffect(() => { draw(); }, [draw]);

    // 4. æŒ‰éˆ•è§¸ç™¼å»èƒŒ
    const handleRemoveBG = async () => {
        if (!uploadedBlob) return alert("è«‹å…ˆé¸å–ç…§ç‰‡æˆ–æ‹ç…§");
        if (!bodyPixModel) return alert("AI æ¨¡å‹é‚„åœ¨åŠªåŠ›è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™å¹¾ç§’");
        
        setIsProcessing(true);
        const img = new Image();
        img.onload = async () => {
            const result = await removeBackgroundBodyPix(img);
            setImage(result);
            setIsProcessing(false);
        };
        img.src = URL.createObjectURL(uploadedBlob);
    };

    const snap = () => {
        const tc = document.createElement('canvas');
        tc.width = videoRef.current.videoWidth; tc.height = videoRef.current.videoHeight;
        const tctx = tc.getContext('2d');
        tctx.translate(tc.width, 0); tctx.scale(-1, 1);
        tctx.drawImage(videoRef.current, 0, 0);
        tc.toBlob(blob => {
            setUploadedBlob(blob);
            const img = new Image();
            img.onload = () => { setImage(img); setIsCam(false); };
            img.src = URL.createObjectURL(blob);
        }, 'image/jpeg', 0.85);
    };

    const download = () => {
        const pc = document.createElement('canvas'); const ctx = pc.getContext('2d');
        pc.width = 1800; pc.height = 1200; ctx.fillStyle = "white"; ctx.fillRect(0, 0, 1800, 1200);
        if (mode === 'MIXED') {
            for(let i=0; i<4; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 80+i*425, 80, 413, 531);
            for(let i=0; i<5; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 80+i*340, 650, 331, 449);
        } else if (mode === 'TWO') {
            for(let i=0; i<8; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 100+(i%4)*410, 80+Math.floor(i/4)*540, 413, 531);
        } else {
            for(let i=0; i<10; i++) ctx.drawImage(canvasRef.current, 0,0,350,450, 80+(i%5)*340, 100+Math.floor(i/5)*460, 331, 449);
        }
        const a = document.createElement('a'); a.download=`ezid_${mode}.png`; a.href=pc.toDataURL(); a.click();
    };

    return (
        <div className="max-w-md mx-auto lg:max-w-6xl flex flex-col lg:flex-row gap-6">
            <div className="w-full lg:w-[400px] flex flex-col items-center">
                <div className="relative mb-6 w-full max-w-[350px]">
                    {isCam ? <video ref={videoRef} autoPlay className="w-full rounded-2xl scale-x-[-1]"/> : <canvas ref={canvasRef} width={350} height={450} className="w-full"/>}
                    <div className="guide-overlay"></div>
                    
                    {!isCam && image && (
                        <div className="absolute top-4 right-4 flex flex-col gap-3 bg-white/60 p-2 rounded-full backdrop-blur-md border border-white/50 shadow-lg">
                            <div title="ç™½åº•" onClick={()=>setBgColor('white')} className={`bg-dot bg-white ${bgColor==='white'?'active':''}`}></div>
                            <div title="è—åº•" onClick={()=>setBgColor('#007bff')} className={`bg-dot bg-blue-600 ${bgColor==='#007bff'?'active':''}`}></div>
                            <div title="ç´…åº•" onClick={()=>setBgColor('#ff0000')} className={`bg-dot bg-red-600 ${bgColor==='#ff0000'?'active':''}`}></div>
                        </div>
                    )}

                    {isProcessing && (
                        <div className="absolute inset-0 bg-white/80 rounded-2xl flex flex-col items-center justify-center z-50">
                            <div className="w-10 h-10 border-4 border-slate-900 border-t-transparent rounded-full animate-spin"></div>
                            <p className="mt-4 font-bold text-slate-900 tracking-widest">AI æ™ºæ…§å»èƒŒä¸­...</p>
                        </div>
                    )}
                </div>

                <div className="w-full space-y-3 px-2">
                    {isCam ? <button onClick={snap} className="w-full bg-red-600 text-white py-4 rounded-xl font-bold shadow-lg">ğŸ“¸ ç«‹å³æ‹æ”</button> : (
                        <>
                            <button onClick={download} className="w-full bg-blue-700 text-white py-4 rounded-xl font-black text-lg shadow-lg hover:bg-blue-800 transition">ğŸ’¾ ä¸‹è¼‰æ’ç‰ˆçµæœ</button>
                            <button onClick={handleRemoveBG} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-black transition shadow-md">âœ¨ AI ä¸€éµå»èƒŒ</button>
                            <div className="grid grid-cols-2 gap-3">
                                <button onClick={()=>{
                                    setIsCam(true);
                                    navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}}).then(s=>videoRef.current.srcObject=s);
                                }} className="bg-slate-700 text-white py-3 rounded-xl font-bold">ğŸ“· é–‹å•Ÿç›¸æ©Ÿ</button>
                                <label className="bg-white text-slate-900 border-2 border-slate-900 py-3 rounded-xl font-bold text-center cursor-pointer hover:bg-slate-50 transition">
                                    ğŸ“ ä¸Šå‚³ç›¸ç‰‡ <input type="file" className="hidden" onChange={e=>{
                                        const file=e.target.files[0]; if(!file) return;
                                        setUploadedBlob(file);
                                        const r=new FileReader(); r.onload=f=>{const i=new Image(); i.onload=()=>setImage(i); i.src=f.target.result;}; r.readAsDataURL(file);
                                    }}/>
                                </label>
                            </div>
                        </>
                    )}
                </div>
            </div>

            <div className="flex-1 app-card p-6 md:p-8">
                <p className="text-xs font-bold text-slate-400 mb-6 tracking-widest uppercase">è¨­å®šé¢æ¿ v1.6.1</p>
                <section>
                    <p className="text-xs font-bold text-slate-500 mb-3">1. é¸æ“‡åˆ—å°è¦æ ¼</p>
                    <div className="flex gap-2">
                        {[['MIXED','1/2å‹æ··åˆ'],['TWO','å…¨ 2 å‹'],['ONE','å…¨ 1 å‹']].map(([k,v])=>(
                            <button key={k} onClick={()=>setMode(k)} className={`flex-1 py-3 rounded-xl font-bold transition ${mode===k?'bg-slate-900 text-white shadow-md':'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}>{v}</button>
                        ))}
                    </div>
                </section>
                
                <div className="gray-line"></div>
                
                <section className="space-y-6 text-xs font-bold text-slate-500">
                    <p className="text-xs font-bold text-slate-400 tracking-widest uppercase">2. ç…§ç‰‡ä½ç½®å¾®èª¿</p>
                    <div className="flex items-center gap-4"><span>ç¸®æ”¾æ¯”ä¾‹</span><input type="range" min="0.1" max="1.5" step="0.01" value={p.s} onChange={e=>setP({...p,s:parseFloat(e.target.value)})} className="flex-1"/></div>
                    <div className="grid grid-cols-2 gap-8">
                        <div className="flex items-center gap-2"><span>å·¦å³</span><input type="range" min="-200" max="200" value={p.x} onChange={e=>setP({...p,x:parseInt(e.target.value)})} className="flex-1"/></div>
                        <div className="flex items-center gap-2"><span>ä¸Šä¸‹</span><input type="range" min="-200" max="200" value={p.y} onChange={e=>setP({...p,y:parseInt(e.target.value)})} className="flex-1"/></div>
                    </div>
                </section>
                
                <div className="gray-line"></div>
                
                <section>
                    <p className="text-xs font-bold text-slate-400 mb-4 tracking-widest uppercase">3. æ•¸ä½æ­£è£æ›´æ›</p>
                    <div className="flex gap-4 overflow-x-auto py-4 no-scrollbar">
                        {['m1','m2','m3','m4','m5'].map(n=>(
                            <div key={n} onClick={()=>setSuit({...suit,id:n})} className={`p-1 rounded-2xl border-2 shrink-0 bg-white cursor-pointer transition-all ${suit.id===n?'border-slate-900 scale-105 shadow-md':'border-slate-100 opacity-40 hover:opacity-100'}`}>
                                <img src={getClothesPath(n)} className="w-16 h-16 object-contain" alt={n}/>
                            </div>
                        ))}
                        <button onClick={()=>setSuit({...suit,id:null})} className="px-6 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 shrink-0 font-bold text-xs hover:bg-slate-50 transition">æ¸…é™¤è¡£æœ</button>
                    </div>
                </section>
            </div>
        </div>
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<EzIDApp />);
</script>
</body>
</html>
